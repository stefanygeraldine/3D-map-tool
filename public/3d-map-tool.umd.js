(function(Xm){typeof define=="function"&&define.amd?define(Xm):Xm()})(function(){"use strict";class Xm{constructor(p){this.token=p,this.isValidToken=!1}validateToken(){this.token?this.isValidToken=!0:this.isValidToken=!1}setMapWrapperStyle(p){const f=document.querySelector(`#${p}`);f&&(f.style.position="absolute",f.style.width="100%",f.style.bottom="0",f.style.top="0")}showUnauthorizedMessage(p){const f=document.createTextNode("Invalid token"),C=document.getElementById(p);C==null||C.appendChild(f)}}var _f=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function h_(te){return te&&te.__esModule&&Object.prototype.hasOwnProperty.call(te,"default")?te.default:te}var uM=Array.isArray,e0=uM,dM=typeof _f=="object"&&_f&&_f.Object===Object&&_f,pM=dM,fM=pM,mM=typeof self=="object"&&self&&self.Object===Object&&self,gM=fM||mM||Function("return this")(),t0=gM,_M=t0,yM=_M.Symbol,i0=yM,Ux=i0,Vx=Object.prototype,xM=Vx.hasOwnProperty,vM=Vx.toString,$m=Ux?Ux.toStringTag:void 0;function bM(te){var p=xM.call(te,$m),f=te[$m];try{te[$m]=void 0;var C=!0}catch{}var D=vM.call(te);return C&&(p?te[$m]=f:delete te[$m]),D}var wM=bM,MM=Object.prototype,TM=MM.toString;function SM(te){return TM.call(te)}var EM=SM,Gx=i0,AM=wM,CM=EM,LM="[object Null]",IM="[object Undefined]",Hx=Gx?Gx.toStringTag:void 0;function PM(te){return te==null?te===void 0?IM:LM:Hx&&Hx in Object(te)?AM(te):CM(te)}var jx=PM;function RM(te){return te!=null&&typeof te=="object"}var DM=RM,zM=jx,OM=DM,FM="[object Symbol]";function kM(te){return typeof te=="symbol"||OM(te)&&zM(te)==FM}var n0=kM,BM=e0,NM=n0,UM=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,VM=/^\w*$/;function GM(te,p){if(BM(te))return!1;var f=typeof te;return f=="number"||f=="symbol"||f=="boolean"||te==null||NM(te)?!0:VM.test(te)||!UM.test(te)||p!=null&&te in Object(p)}var HM=GM;function jM(te){var p=typeof te;return te!=null&&(p=="object"||p=="function")}var Wx=jM,WM=jx,qM=Wx,ZM="[object AsyncFunction]",XM="[object Function]",$M="[object GeneratorFunction]",YM="[object Proxy]";function JM(te){if(!qM(te))return!1;var p=WM(te);return p==XM||p==$M||p==ZM||p==YM}var KM=JM,QM=t0,eT=QM["__core-js_shared__"],tT=eT,r0=tT,qx=function(){var te=/[^.]+$/.exec(r0&&r0.keys&&r0.keys.IE_PROTO||"");return te?"Symbol(src)_1."+te:""}();function iT(te){return!!qx&&qx in te}var nT=iT,rT=Function.prototype,sT=rT.toString;function oT(te){if(te!=null){try{return sT.call(te)}catch{}try{return te+""}catch{}}return""}var aT=oT,lT=KM,cT=nT,hT=Wx,uT=aT,dT=/[\\^$.*+?()[\]{}|]/g,pT=/^\[object .+?Constructor\]$/,fT=Function.prototype,mT=Object.prototype,gT=fT.toString,_T=mT.hasOwnProperty,yT=RegExp("^"+gT.call(_T).replace(dT,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function xT(te){if(!hT(te)||cT(te))return!1;var p=lT(te)?yT:pT;return p.test(uT(te))}var vT=xT;function bT(te,p){return te==null?void 0:te[p]}var wT=bT,MT=vT,TT=wT;function ST(te,p){var f=TT(te,p);return MT(f)?f:void 0}var Zx=ST,ET=Zx,AT=ET(Object,"create"),u_=AT,Xx=u_;function CT(){this.__data__=Xx?Xx(null):{},this.size=0}var LT=CT;function IT(te){var p=this.has(te)&&delete this.__data__[te];return this.size-=p?1:0,p}var PT=IT,RT=u_,DT="__lodash_hash_undefined__",zT=Object.prototype,OT=zT.hasOwnProperty;function FT(te){var p=this.__data__;if(RT){var f=p[te];return f===DT?void 0:f}return OT.call(p,te)?p[te]:void 0}var kT=FT,BT=u_,NT=Object.prototype,UT=NT.hasOwnProperty;function VT(te){var p=this.__data__;return BT?p[te]!==void 0:UT.call(p,te)}var GT=VT,HT=u_,jT="__lodash_hash_undefined__";function WT(te,p){var f=this.__data__;return this.size+=this.has(te)?0:1,f[te]=HT&&p===void 0?jT:p,this}var qT=WT,ZT=LT,XT=PT,$T=kT,YT=GT,JT=qT;function yf(te){var p=-1,f=te==null?0:te.length;for(this.clear();++p<f;){var C=te[p];this.set(C[0],C[1])}}yf.prototype.clear=ZT,yf.prototype.delete=XT,yf.prototype.get=$T,yf.prototype.has=YT,yf.prototype.set=JT;var KT=yf;function QT(){this.__data__=[],this.size=0}var eS=QT;function tS(te,p){return te===p||te!==te&&p!==p}var iS=tS,nS=iS;function rS(te,p){for(var f=te.length;f--;)if(nS(te[f][0],p))return f;return-1}var d_=rS,sS=d_,oS=Array.prototype,aS=oS.splice;function lS(te){var p=this.__data__,f=sS(p,te);if(f<0)return!1;var C=p.length-1;return f==C?p.pop():aS.call(p,f,1),--this.size,!0}var cS=lS,hS=d_;function uS(te){var p=this.__data__,f=hS(p,te);return f<0?void 0:p[f][1]}var dS=uS,pS=d_;function fS(te){return pS(this.__data__,te)>-1}var mS=fS,gS=d_;function _S(te,p){var f=this.__data__,C=gS(f,te);return C<0?(++this.size,f.push([te,p])):f[C][1]=p,this}var yS=_S,xS=eS,vS=cS,bS=dS,wS=mS,MS=yS;function xf(te){var p=-1,f=te==null?0:te.length;for(this.clear();++p<f;){var C=te[p];this.set(C[0],C[1])}}xf.prototype.clear=xS,xf.prototype.delete=vS,xf.prototype.get=bS,xf.prototype.has=wS,xf.prototype.set=MS;var TS=xf,SS=Zx,ES=t0,AS=SS(ES,"Map"),CS=AS,$x=KT,LS=TS,IS=CS;function PS(){this.size=0,this.__data__={hash:new $x,map:new(IS||LS),string:new $x}}var RS=PS;function DS(te){var p=typeof te;return p=="string"||p=="number"||p=="symbol"||p=="boolean"?te!=="__proto__":te===null}var zS=DS,OS=zS;function FS(te,p){var f=te.__data__;return OS(p)?f[typeof p=="string"?"string":"hash"]:f.map}var p_=FS,kS=p_;function BS(te){var p=kS(this,te).delete(te);return this.size-=p?1:0,p}var NS=BS,US=p_;function VS(te){return US(this,te).get(te)}var GS=VS,HS=p_;function jS(te){return HS(this,te).has(te)}var WS=jS,qS=p_;function ZS(te,p){var f=qS(this,te),C=f.size;return f.set(te,p),this.size+=f.size==C?0:1,this}var XS=ZS,$S=RS,YS=NS,JS=GS,KS=WS,QS=XS;function vf(te){var p=-1,f=te==null?0:te.length;for(this.clear();++p<f;){var C=te[p];this.set(C[0],C[1])}}vf.prototype.clear=$S,vf.prototype.delete=YS,vf.prototype.get=JS,vf.prototype.has=KS,vf.prototype.set=QS;var e2=vf,Yx=e2,t2="Expected a function";function s0(te,p){if(typeof te!="function"||p!=null&&typeof p!="function")throw new TypeError(t2);var f=function(){var C=arguments,D=p?p.apply(this,C):C[0],U=f.cache;if(U.has(D))return U.get(D);var B=te.apply(this,C);return f.cache=U.set(D,B)||U,B};return f.cache=new(s0.Cache||Yx),f}s0.Cache=Yx;var i2=s0,n2=i2,r2=500;function s2(te){var p=n2(te,function(C){return f.size===r2&&f.clear(),C}),f=p.cache;return p}var o2=s2,a2=o2,l2=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,c2=/\\(\\)?/g,h2=a2(function(te){var p=[];return te.charCodeAt(0)===46&&p.push(""),te.replace(l2,function(f,C,D,U){p.push(D?U.replace(c2,"$1"):C||f)}),p}),u2=h2;function d2(te,p){for(var f=-1,C=te==null?0:te.length,D=Array(C);++f<C;)D[f]=p(te[f],f,te);return D}var p2=d2,Jx=i0,f2=p2,m2=e0,g2=n0,_2=1/0,Kx=Jx?Jx.prototype:void 0,Qx=Kx?Kx.toString:void 0;function ev(te){if(typeof te=="string")return te;if(m2(te))return f2(te,ev)+"";if(g2(te))return Qx?Qx.call(te):"";var p=te+"";return p=="0"&&1/te==-_2?"-0":p}var y2=ev,x2=y2;function v2(te){return te==null?"":x2(te)}var b2=v2,w2=e0,M2=HM,T2=u2,S2=b2;function E2(te,p){return w2(te)?te:M2(te,p)?[te]:T2(S2(te))}var A2=E2,C2=n0,L2=1/0;function I2(te){if(typeof te=="string"||C2(te))return te;var p=te+"";return p=="0"&&1/te==-L2?"-0":p}var P2=I2,R2=A2,D2=P2;function z2(te,p){p=R2(p,te);for(var f=0,C=p.length;te!=null&&f<C;)te=te[D2(p[f++])];return f&&f==C?te:void 0}var O2=z2,F2=O2;function k2(te,p,f){var C=te==null?void 0:F2(te,p);return C===void 0?f:C}var B2=k2;const f_=h_(B2);var tv={exports:{}};(function(te,p){(function(f,C){te.exports=C()})(_f,function(){var f,C,D;function U(s,Z){if(!f)f=Z;else if(!C)C=Z;else{var j="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+f+")(sharedChunk); ("+C+")(sharedChunk); self.onerror = null;",Q={};f(Q),D=Z(Q),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(D.workerUrl=window.URL.createObjectURL(new Blob([j],{type:"text/javascript"})))}}U(["exports"],function(s){var Z="3.5.2";let j;const Q={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(j==null){const t=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{j=process.env.API_URL_REGEX!=null?new RegExp(process.env.API_URL_REGEX):t}catch{j=t}}return j},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!Q.API_URL)return null;try{const t=new URL(Q.API_URL);return t.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":t.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function oe(t){return Q.API_URL_REGEX.test(t)}function ve(t){return t.indexOf("mapbox:")===0}function Ee(t){return Q.API_CDN_URL_REGEX.test(t)}function We(t){return Q.API_SPRITE_REGEX.test(t)}function Re(t){return Q.API_STYLE_REGEX.test(t)&&!We(t)}const He={create:"create",load:"load",fullLoad:"fullLoad"},Mt={mark(t){performance.mark(t)},measure(t,e,n){performance.measure(t,e,n)}};function Lt(t){const e=t.name.split("?")[0];return Ee(e)&&e.includes("mapbox-gl.js")?"javascript":Ee(e)&&e.includes("mapbox-gl.css")?"css":function(n){return Q.API_FONTS_REGEX.test(n)}(e)?"fontRange":We(e)?"sprite":Re(e)?"style":function(n){return Q.API_TILEJSON_REGEX.test(n)}(e)?"tilejson":"other"}function Ut(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Wt={},lt={};Object.defineProperty(lt,"__esModule",{value:!0}),lt.setMatrixArrayType=function(t){lt.ARRAY_TYPE=qt=t},lt.toRadian=function(t){return t*Ni},lt.equals=function(t,e){return Math.abs(t-e)<=Ct*Math.max(1,Math.abs(t),Math.abs(e))},lt.RANDOM=lt.ARRAY_TYPE=lt.EPSILON=void 0;var Ct=1e-6;lt.EPSILON=Ct;var qt=typeof Float32Array<"u"?Float32Array:Array;lt.ARRAY_TYPE=qt;var Ai=Math.random;lt.RANDOM=Ai;var Ni=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var Qe={};function st(t){return st=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},st(t)}Object.defineProperty(Qe,"__esModule",{value:!0}),Qe.create=function(){var t=new Ht.ARRAY_TYPE(4);return Ht.ARRAY_TYPE!=Float32Array&&(t[1]=0,t[2]=0),t[0]=1,t[3]=1,t},Qe.clone=function(t){var e=new Ht.ARRAY_TYPE(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},Qe.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},Qe.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t},Qe.fromValues=function(t,e,n,a){var l=new Ht.ARRAY_TYPE(4);return l[0]=t,l[1]=e,l[2]=n,l[3]=a,l},Qe.set=function(t,e,n,a,l){return t[0]=e,t[1]=n,t[2]=a,t[3]=l,t},Qe.transpose=function(t,e){if(t===e){var n=e[1];t[1]=e[2],t[2]=n}else t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3];return t},Qe.invert=function(t,e){var n=e[0],a=e[1],l=e[2],u=e[3],d=n*u-l*a;return d?(t[0]=u*(d=1/d),t[1]=-a*d,t[2]=-l*d,t[3]=n*d,t):null},Qe.adjoint=function(t,e){var n=e[0];return t[0]=e[3],t[1]=-e[1],t[2]=-e[2],t[3]=n,t},Qe.determinant=function(t){return t[0]*t[3]-t[2]*t[1]},Qe.multiply=ci,Qe.rotate=function(t,e,n){var a=e[0],l=e[1],u=e[2],d=e[3],x=Math.sin(n),v=Math.cos(n);return t[0]=a*v+u*x,t[1]=l*v+d*x,t[2]=a*-x+u*v,t[3]=l*-x+d*v,t},Qe.scale=function(t,e,n){var a=e[1],l=e[2],u=e[3],d=n[0],x=n[1];return t[0]=e[0]*d,t[1]=a*d,t[2]=l*x,t[3]=u*x,t},Qe.fromRotation=function(t,e){var n=Math.sin(e),a=Math.cos(e);return t[0]=a,t[1]=n,t[2]=-n,t[3]=a,t},Qe.fromScaling=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t},Qe.str=function(t){return"mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},Qe.frob=function(t){return Math.hypot(t[0],t[1],t[2],t[3])},Qe.LDU=function(t,e,n,a){return t[2]=a[2]/a[0],n[0]=a[0],n[1]=a[1],n[3]=a[3]-t[2]*n[1],[t,e,n]},Qe.add=function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t},Qe.subtract=ae,Qe.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]},Qe.equals=function(t,e){var n=t[0],a=t[1],l=t[2],u=t[3],d=e[0],x=e[1],v=e[2],S=e[3];return Math.abs(n-d)<=Ht.EPSILON*Math.max(1,Math.abs(n),Math.abs(d))&&Math.abs(a-x)<=Ht.EPSILON*Math.max(1,Math.abs(a),Math.abs(x))&&Math.abs(l-v)<=Ht.EPSILON*Math.max(1,Math.abs(l),Math.abs(v))&&Math.abs(u-S)<=Ht.EPSILON*Math.max(1,Math.abs(u),Math.abs(S))},Qe.multiplyScalar=function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t},Qe.multiplyScalarAndAdd=function(t,e,n,a){return t[0]=e[0]+n[0]*a,t[1]=e[1]+n[1]*a,t[2]=e[2]+n[2]*a,t[3]=e[3]+n[3]*a,t},Qe.sub=Qe.mul=void 0;var Ht=function(t,e){if(t&&t.__esModule)return t;if(t===null||st(t)!=="object"&&typeof t!="function")return{default:t};var n=en(void 0);if(n&&n.has(t))return n.get(t);var a={},l=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in t)if(u!=="default"&&Object.prototype.hasOwnProperty.call(t,u)){var d=l?Object.getOwnPropertyDescriptor(t,u):null;d&&(d.get||d.set)?Object.defineProperty(a,u,d):a[u]=t[u]}return a.default=t,n&&n.set(t,a),a}(lt);function en(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,n=new WeakMap;return(en=function(a){return a?n:e})(t)}function ci(t,e,n){var a=e[0],l=e[1],u=e[2],d=e[3],x=n[0],v=n[1],S=n[2],L=n[3];return t[0]=a*x+u*v,t[1]=l*x+d*v,t[2]=a*S+u*L,t[3]=l*S+d*L,t}function ae(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t}Qe.mul=ci,Qe.sub=ae;var ye={};function Se(t){return Se=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Se(t)}Object.defineProperty(ye,"__esModule",{value:!0}),ye.create=function(){var t=new Pe.ARRAY_TYPE(6);return Pe.ARRAY_TYPE!=Float32Array&&(t[1]=0,t[2]=0,t[4]=0,t[5]=0),t[0]=1,t[3]=1,t},ye.clone=function(t){var e=new Pe.ARRAY_TYPE(6);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},ye.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},ye.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t},ye.fromValues=function(t,e,n,a,l,u){var d=new Pe.ARRAY_TYPE(6);return d[0]=t,d[1]=e,d[2]=n,d[3]=a,d[4]=l,d[5]=u,d},ye.set=function(t,e,n,a,l,u,d){return t[0]=e,t[1]=n,t[2]=a,t[3]=l,t[4]=u,t[5]=d,t},ye.invert=function(t,e){var n=e[0],a=e[1],l=e[2],u=e[3],d=e[4],x=e[5],v=n*u-a*l;return v?(t[0]=u*(v=1/v),t[1]=-a*v,t[2]=-l*v,t[3]=n*v,t[4]=(l*x-u*d)*v,t[5]=(a*d-n*x)*v,t):null},ye.determinant=function(t){return t[0]*t[3]-t[1]*t[2]},ye.multiply=Et,ye.rotate=function(t,e,n){var a=e[0],l=e[1],u=e[2],d=e[3],x=e[4],v=e[5],S=Math.sin(n),L=Math.cos(n);return t[0]=a*L+u*S,t[1]=l*L+d*S,t[2]=a*-S+u*L,t[3]=l*-S+d*L,t[4]=x,t[5]=v,t},ye.scale=function(t,e,n){var a=e[1],l=e[2],u=e[3],d=e[4],x=e[5],v=n[0],S=n[1];return t[0]=e[0]*v,t[1]=a*v,t[2]=l*S,t[3]=u*S,t[4]=d,t[5]=x,t},ye.translate=function(t,e,n){var a=e[0],l=e[1],u=e[2],d=e[3],x=e[4],v=e[5],S=n[0],L=n[1];return t[0]=a,t[1]=l,t[2]=u,t[3]=d,t[4]=a*S+u*L+x,t[5]=l*S+d*L+v,t},ye.fromRotation=function(t,e){var n=Math.sin(e),a=Math.cos(e);return t[0]=a,t[1]=n,t[2]=-n,t[3]=a,t[4]=0,t[5]=0,t},ye.fromScaling=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t[4]=0,t[5]=0,t},ye.fromTranslation=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=e[0],t[5]=e[1],t},ye.str=function(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"},ye.frob=function(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],1)},ye.add=function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t},ye.subtract=_t,ye.multiplyScalar=function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t},ye.multiplyScalarAndAdd=function(t,e,n,a){return t[0]=e[0]+n[0]*a,t[1]=e[1]+n[1]*a,t[2]=e[2]+n[2]*a,t[3]=e[3]+n[3]*a,t[4]=e[4]+n[4]*a,t[5]=e[5]+n[5]*a,t},ye.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]},ye.equals=function(t,e){var n=t[0],a=t[1],l=t[2],u=t[3],d=t[4],x=t[5],v=e[0],S=e[1],L=e[2],P=e[3],O=e[4],V=e[5];return Math.abs(n-v)<=Pe.EPSILON*Math.max(1,Math.abs(n),Math.abs(v))&&Math.abs(a-S)<=Pe.EPSILON*Math.max(1,Math.abs(a),Math.abs(S))&&Math.abs(l-L)<=Pe.EPSILON*Math.max(1,Math.abs(l),Math.abs(L))&&Math.abs(u-P)<=Pe.EPSILON*Math.max(1,Math.abs(u),Math.abs(P))&&Math.abs(d-O)<=Pe.EPSILON*Math.max(1,Math.abs(d),Math.abs(O))&&Math.abs(x-V)<=Pe.EPSILON*Math.max(1,Math.abs(x),Math.abs(V))},ye.sub=ye.mul=void 0;var Pe=function(t,e){if(t&&t.__esModule)return t;if(t===null||Se(t)!=="object"&&typeof t!="function")return{default:t};var n=je(void 0);if(n&&n.has(t))return n.get(t);var a={},l=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in t)if(u!=="default"&&Object.prototype.hasOwnProperty.call(t,u)){var d=l?Object.getOwnPropertyDescriptor(t,u):null;d&&(d.get||d.set)?Object.defineProperty(a,u,d):a[u]=t[u]}return a.default=t,n&&n.set(t,a),a}(lt);function je(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,n=new WeakMap;return(je=function(a){return a?n:e})(t)}function Et(t,e,n){var a=e[0],l=e[1],u=e[2],d=e[3],x=e[4],v=e[5],S=n[0],L=n[1],P=n[2],O=n[3],V=n[4],G=n[5];return t[0]=a*S+u*L,t[1]=l*S+d*L,t[2]=a*P+u*O,t[3]=l*P+d*O,t[4]=a*V+u*G+x,t[5]=l*V+d*G+v,t}function _t(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t[4]=e[4]-n[4],t[5]=e[5]-n[5],t}ye.mul=Et,ye.sub=_t;var ft={};function ii(t){return ii=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ii(t)}Object.defineProperty(ft,"__esModule",{value:!0}),ft.create=function(){var t=new St.ARRAY_TYPE(9);return St.ARRAY_TYPE!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t},ft.fromMat4=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},ft.clone=function(t){var e=new St.ARRAY_TYPE(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},ft.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},ft.fromValues=function(t,e,n,a,l,u,d,x,v){var S=new St.ARRAY_TYPE(9);return S[0]=t,S[1]=e,S[2]=n,S[3]=a,S[4]=l,S[5]=u,S[6]=d,S[7]=x,S[8]=v,S},ft.set=function(t,e,n,a,l,u,d,x,v,S){return t[0]=e,t[1]=n,t[2]=a,t[3]=l,t[4]=u,t[5]=d,t[6]=x,t[7]=v,t[8]=S,t},ft.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},ft.transpose=function(t,e){if(t===e){var n=e[1],a=e[2],l=e[5];t[1]=e[3],t[2]=e[6],t[3]=n,t[5]=e[7],t[6]=a,t[7]=l}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},ft.invert=function(t,e){var n=e[0],a=e[1],l=e[2],u=e[3],d=e[4],x=e[5],v=e[6],S=e[7],L=e[8],P=L*d-x*S,O=-L*u+x*v,V=S*u-d*v,G=n*P+a*O+l*V;return G?(t[0]=P*(G=1/G),t[1]=(-L*a+l*S)*G,t[2]=(x*a-l*d)*G,t[3]=O*G,t[4]=(L*n-l*v)*G,t[5]=(-x*n+l*u)*G,t[6]=V*G,t[7]=(-S*n+a*v)*G,t[8]=(d*n-a*u)*G,t):null},ft.adjoint=function(t,e){var n=e[0],a=e[1],l=e[2],u=e[3],d=e[4],x=e[5],v=e[6],S=e[7],L=e[8];return t[0]=d*L-x*S,t[1]=l*S-a*L,t[2]=a*x-l*d,t[3]=x*v-u*L,t[4]=n*L-l*v,t[5]=l*u-n*x,t[6]=u*S-d*v,t[7]=a*v-n*S,t[8]=n*d-a*u,t},ft.determinant=function(t){var e=t[3],n=t[4],a=t[5],l=t[6],u=t[7],d=t[8];return t[0]*(d*n-a*u)+t[1]*(-d*e+a*l)+t[2]*(u*e-n*l)},ft.multiply=sn,ft.translate=function(t,e,n){var a=e[0],l=e[1],u=e[2],d=e[3],x=e[4],v=e[5],S=e[6],L=e[7],P=e[8],O=n[0],V=n[1];return t[0]=a,t[1]=l,t[2]=u,t[3]=d,t[4]=x,t[5]=v,t[6]=O*a+V*d+S,t[7]=O*l+V*x+L,t[8]=O*u+V*v+P,t},ft.rotate=function(t,e,n){var a=e[0],l=e[1],u=e[2],d=e[3],x=e[4],v=e[5],S=e[6],L=e[7],P=e[8],O=Math.sin(n),V=Math.cos(n);return t[0]=V*a+O*d,t[1]=V*l+O*x,t[2]=V*u+O*v,t[3]=V*d-O*a,t[4]=V*x-O*l,t[5]=V*v-O*u,t[6]=S,t[7]=L,t[8]=P,t},ft.scale=function(t,e,n){var a=n[0],l=n[1];return t[0]=a*e[0],t[1]=a*e[1],t[2]=a*e[2],t[3]=l*e[3],t[4]=l*e[4],t[5]=l*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},ft.fromTranslation=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=e[0],t[7]=e[1],t[8]=1,t},ft.fromRotation=function(t,e){var n=Math.sin(e),a=Math.cos(e);return t[0]=a,t[1]=n,t[2]=0,t[3]=-n,t[4]=a,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},ft.fromScaling=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=e[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},ft.fromMat2d=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t},ft.fromQuat=function(t,e){var n=e[0],a=e[1],l=e[2],u=e[3],d=n+n,x=a+a,v=l+l,S=n*d,L=a*d,P=a*x,O=l*d,V=l*x,G=l*v,$=u*d,Y=u*x,ne=u*v;return t[0]=1-P-G,t[3]=L-ne,t[6]=O+Y,t[1]=L+ne,t[4]=1-S-G,t[7]=V-$,t[2]=O-Y,t[5]=V+$,t[8]=1-S-P,t},ft.normalFromMat4=function(t,e){var n=e[0],a=e[1],l=e[2],u=e[3],d=e[4],x=e[5],v=e[6],S=e[7],L=e[8],P=e[9],O=e[10],V=e[11],G=e[12],$=e[13],Y=e[14],ne=e[15],Te=n*x-a*d,Ae=n*v-l*d,Ce=n*S-u*d,qe=a*v-l*x,Ge=a*S-u*x,ot=l*S-u*v,dt=L*$-P*G,Rt=L*Y-O*G,$t=L*ne-V*G,Vt=P*Y-O*$,ai=P*ne-V*$,Ci=O*ne-V*Y,ti=Te*Ci-Ae*ai+Ce*Vt+qe*$t-Ge*Rt+ot*dt;return ti?(t[0]=(x*Ci-v*ai+S*Vt)*(ti=1/ti),t[1]=(v*$t-d*Ci-S*Rt)*ti,t[2]=(d*ai-x*$t+S*dt)*ti,t[3]=(l*ai-a*Ci-u*Vt)*ti,t[4]=(n*Ci-l*$t+u*Rt)*ti,t[5]=(a*$t-n*ai-u*dt)*ti,t[6]=($*ot-Y*Ge+ne*qe)*ti,t[7]=(Y*Ce-G*ot-ne*Ae)*ti,t[8]=(G*Ge-$*Ce+ne*Te)*ti,t):null},ft.projection=function(t,e,n){return t[0]=2/e,t[1]=0,t[2]=0,t[3]=0,t[4]=-2/n,t[5]=0,t[6]=-1,t[7]=1,t[8]=1,t},ft.str=function(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"},ft.frob=function(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])},ft.add=function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t[6]=e[6]+n[6],t[7]=e[7]+n[7],t[8]=e[8]+n[8],t},ft.subtract=Ki,ft.multiplyScalar=function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t[8]=e[8]*n,t},ft.multiplyScalarAndAdd=function(t,e,n,a){return t[0]=e[0]+n[0]*a,t[1]=e[1]+n[1]*a,t[2]=e[2]+n[2]*a,t[3]=e[3]+n[3]*a,t[4]=e[4]+n[4]*a,t[5]=e[5]+n[5]*a,t[6]=e[6]+n[6]*a,t[7]=e[7]+n[7]*a,t[8]=e[8]+n[8]*a,t},ft.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]},ft.equals=function(t,e){var n=t[0],a=t[1],l=t[2],u=t[3],d=t[4],x=t[5],v=t[6],S=t[7],L=t[8],P=e[0],O=e[1],V=e[2],G=e[3],$=e[4],Y=e[5],ne=e[6],Te=e[7],Ae=e[8];return Math.abs(n-P)<=St.EPSILON*Math.max(1,Math.abs(n),Math.abs(P))&&Math.abs(a-O)<=St.EPSILON*Math.max(1,Math.abs(a),Math.abs(O))&&Math.abs(l-V)<=St.EPSILON*Math.max(1,Math.abs(l),Math.abs(V))&&Math.abs(u-G)<=St.EPSILON*Math.max(1,Math.abs(u),Math.abs(G))&&Math.abs(d-$)<=St.EPSILON*Math.max(1,Math.abs(d),Math.abs($))&&Math.abs(x-Y)<=St.EPSILON*Math.max(1,Math.abs(x),Math.abs(Y))&&Math.abs(v-ne)<=St.EPSILON*Math.max(1,Math.abs(v),Math.abs(ne))&&Math.abs(S-Te)<=St.EPSILON*Math.max(1,Math.abs(S),Math.abs(Te))&&Math.abs(L-Ae)<=St.EPSILON*Math.max(1,Math.abs(L),Math.abs(Ae))},ft.sub=ft.mul=void 0;var St=function(t,e){if(t&&t.__esModule)return t;if(t===null||ii(t)!=="object"&&typeof t!="function")return{default:t};var n=Jt(void 0);if(n&&n.has(t))return n.get(t);var a={},l=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in t)if(u!=="default"&&Object.prototype.hasOwnProperty.call(t,u)){var d=l?Object.getOwnPropertyDescriptor(t,u):null;d&&(d.get||d.set)?Object.defineProperty(a,u,d):a[u]=t[u]}return a.default=t,n&&n.set(t,a),a}(lt);function Jt(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,n=new WeakMap;return(Jt=function(a){return a?n:e})(t)}function sn(t,e,n){var a=e[0],l=e[1],u=e[2],d=e[3],x=e[4],v=e[5],S=e[6],L=e[7],P=e[8],O=n[0],V=n[1],G=n[2],$=n[3],Y=n[4],ne=n[5],Te=n[6],Ae=n[7],Ce=n[8];return t[0]=O*a+V*d+G*S,t[1]=O*l+V*x+G*L,t[2]=O*u+V*v+G*P,t[3]=$*a+Y*d+ne*S,t[4]=$*l+Y*x+ne*L,t[5]=$*u+Y*v+ne*P,t[6]=Te*a+Ae*d+Ce*S,t[7]=Te*l+Ae*x+Ce*L,t[8]=Te*u+Ae*v+Ce*P,t}function Ki(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t[4]=e[4]-n[4],t[5]=e[5]-n[5],t[6]=e[6]-n[6],t[7]=e[7]-n[7],t[8]=e[8]-n[8],t}ft.mul=sn,ft.sub=Ki;var fi={};function pr(t){return pr=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},pr(t)}Object.defineProperty(fi,"__esModule",{value:!0}),fi.create=function(){var t=new Xn.ARRAY_TYPE(16);return Xn.ARRAY_TYPE!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t},fi.clone=function(t){var e=new Xn.ARRAY_TYPE(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},fi.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},fi.fromValues=function(t,e,n,a,l,u,d,x,v,S,L,P,O,V,G,$){var Y=new Xn.ARRAY_TYPE(16);return Y[0]=t,Y[1]=e,Y[2]=n,Y[3]=a,Y[4]=l,Y[5]=u,Y[6]=d,Y[7]=x,Y[8]=v,Y[9]=S,Y[10]=L,Y[11]=P,Y[12]=O,Y[13]=V,Y[14]=G,Y[15]=$,Y},fi.set=function(t,e,n,a,l,u,d,x,v,S,L,P,O,V,G,$,Y){return t[0]=e,t[1]=n,t[2]=a,t[3]=l,t[4]=u,t[5]=d,t[6]=x,t[7]=v,t[8]=S,t[9]=L,t[10]=P,t[11]=O,t[12]=V,t[13]=G,t[14]=$,t[15]=Y,t},fi.identity=dn,fi.transpose=function(t,e){if(t===e){var n=e[1],a=e[2],l=e[3],u=e[6],d=e[7],x=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=n,t[6]=e[9],t[7]=e[13],t[8]=a,t[9]=u,t[11]=e[14],t[12]=l,t[13]=d,t[14]=x}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t},fi.invert=function(t,e){var n=e[0],a=e[1],l=e[2],u=e[3],d=e[4],x=e[5],v=e[6],S=e[7],L=e[8],P=e[9],O=e[10],V=e[11],G=e[12],$=e[13],Y=e[14],ne=e[15],Te=n*x-a*d,Ae=n*v-l*d,Ce=n*S-u*d,qe=a*v-l*x,Ge=a*S-u*x,ot=l*S-u*v,dt=L*$-P*G,Rt=L*Y-O*G,$t=L*ne-V*G,Vt=P*Y-O*$,ai=P*ne-V*$,Ci=O*ne-V*Y,ti=Te*Ci-Ae*ai+Ce*Vt+qe*$t-Ge*Rt+ot*dt;return ti?(t[0]=(x*Ci-v*ai+S*Vt)*(ti=1/ti),t[1]=(l*ai-a*Ci-u*Vt)*ti,t[2]=($*ot-Y*Ge+ne*qe)*ti,t[3]=(O*Ge-P*ot-V*qe)*ti,t[4]=(v*$t-d*Ci-S*Rt)*ti,t[5]=(n*Ci-l*$t+u*Rt)*ti,t[6]=(Y*Ce-G*ot-ne*Ae)*ti,t[7]=(L*ot-O*Ce+V*Ae)*ti,t[8]=(d*ai-x*$t+S*dt)*ti,t[9]=(a*$t-n*ai-u*dt)*ti,t[10]=(G*Ge-$*Ce+ne*Te)*ti,t[11]=(P*Ce-L*Ge-V*Te)*ti,t[12]=(x*Rt-d*Vt-v*dt)*ti,t[13]=(n*Vt-a*Rt+l*dt)*ti,t[14]=($*Ae-G*qe-Y*Te)*ti,t[15]=(L*qe-P*Ae+O*Te)*ti,t):null},fi.adjoint=function(t,e){var n=e[0],a=e[1],l=e[2],u=e[3],d=e[4],x=e[5],v=e[6],S=e[7],L=e[8],P=e[9],O=e[10],V=e[11],G=e[12],$=e[13],Y=e[14],ne=e[15];return t[0]=x*(O*ne-V*Y)-P*(v*ne-S*Y)+$*(v*V-S*O),t[1]=-(a*(O*ne-V*Y)-P*(l*ne-u*Y)+$*(l*V-u*O)),t[2]=a*(v*ne-S*Y)-x*(l*ne-u*Y)+$*(l*S-u*v),t[3]=-(a*(v*V-S*O)-x*(l*V-u*O)+P*(l*S-u*v)),t[4]=-(d*(O*ne-V*Y)-L*(v*ne-S*Y)+G*(v*V-S*O)),t[5]=n*(O*ne-V*Y)-L*(l*ne-u*Y)+G*(l*V-u*O),t[6]=-(n*(v*ne-S*Y)-d*(l*ne-u*Y)+G*(l*S-u*v)),t[7]=n*(v*V-S*O)-d*(l*V-u*O)+L*(l*S-u*v),t[8]=d*(P*ne-V*$)-L*(x*ne-S*$)+G*(x*V-S*P),t[9]=-(n*(P*ne-V*$)-L*(a*ne-u*$)+G*(a*V-u*P)),t[10]=n*(x*ne-S*$)-d*(a*ne-u*$)+G*(a*S-u*x),t[11]=-(n*(x*V-S*P)-d*(a*V-u*P)+L*(a*S-u*x)),t[12]=-(d*(P*Y-O*$)-L*(x*Y-v*$)+G*(x*O-v*P)),t[13]=n*(P*Y-O*$)-L*(a*Y-l*$)+G*(a*O-l*P),t[14]=-(n*(x*Y-v*$)-d*(a*Y-l*$)+G*(a*v-l*x)),t[15]=n*(x*O-v*P)-d*(a*O-l*P)+L*(a*v-l*x),t},fi.determinant=function(t){var e=t[0],n=t[1],a=t[2],l=t[3],u=t[4],d=t[5],x=t[6],v=t[7],S=t[8],L=t[9],P=t[10],O=t[11],V=t[12],G=t[13],$=t[14],Y=t[15];return(e*d-n*u)*(P*Y-O*$)-(e*x-a*u)*(L*Y-O*G)+(e*v-l*u)*(L*$-P*G)+(n*x-a*d)*(S*Y-O*V)-(n*v-l*d)*(S*$-P*V)+(a*v-l*x)*(S*G-L*V)},fi.multiply=ln,fi.translate=function(t,e,n){var a,l,u,d,x,v,S,L,P,O,V,G,$=n[0],Y=n[1],ne=n[2];return e===t?(t[12]=e[0]*$+e[4]*Y+e[8]*ne+e[12],t[13]=e[1]*$+e[5]*Y+e[9]*ne+e[13],t[14]=e[2]*$+e[6]*Y+e[10]*ne+e[14],t[15]=e[3]*$+e[7]*Y+e[11]*ne+e[15]):(l=e[1],u=e[2],d=e[3],x=e[4],v=e[5],S=e[6],L=e[7],P=e[8],O=e[9],V=e[10],G=e[11],t[0]=a=e[0],t[1]=l,t[2]=u,t[3]=d,t[4]=x,t[5]=v,t[6]=S,t[7]=L,t[8]=P,t[9]=O,t[10]=V,t[11]=G,t[12]=a*$+x*Y+P*ne+e[12],t[13]=l*$+v*Y+O*ne+e[13],t[14]=u*$+S*Y+V*ne+e[14],t[15]=d*$+L*Y+G*ne+e[15]),t},fi.scale=function(t,e,n){var a=n[0],l=n[1],u=n[2];return t[0]=e[0]*a,t[1]=e[1]*a,t[2]=e[2]*a,t[3]=e[3]*a,t[4]=e[4]*l,t[5]=e[5]*l,t[6]=e[6]*l,t[7]=e[7]*l,t[8]=e[8]*u,t[9]=e[9]*u,t[10]=e[10]*u,t[11]=e[11]*u,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},fi.rotate=function(t,e,n,a){var l,u,d,x,v,S,L,P,O,V,G,$,Y,ne,Te,Ae,Ce,qe,Ge,ot,dt,Rt,$t,Vt,ai=a[0],Ci=a[1],ti=a[2],bi=Math.hypot(ai,Ci,ti);return bi<Xn.EPSILON?null:(ai*=bi=1/bi,Ci*=bi,ti*=bi,l=Math.sin(n),u=Math.cos(n),v=e[1],S=e[2],L=e[3],O=e[5],V=e[6],G=e[7],Y=e[9],ne=e[10],Te=e[11],Ae=ai*ai*(d=1-u)+u,Ge=ai*Ci*d-ti*l,ot=Ci*Ci*d+u,dt=ti*Ci*d+ai*l,Rt=ai*ti*d+Ci*l,$t=Ci*ti*d-ai*l,Vt=ti*ti*d+u,t[0]=(x=e[0])*Ae+(P=e[4])*(Ce=Ci*ai*d+ti*l)+($=e[8])*(qe=ti*ai*d-Ci*l),t[1]=v*Ae+O*Ce+Y*qe,t[2]=S*Ae+V*Ce+ne*qe,t[3]=L*Ae+G*Ce+Te*qe,t[4]=x*Ge+P*ot+$*dt,t[5]=v*Ge+O*ot+Y*dt,t[6]=S*Ge+V*ot+ne*dt,t[7]=L*Ge+G*ot+Te*dt,t[8]=x*Rt+P*$t+$*Vt,t[9]=v*Rt+O*$t+Y*Vt,t[10]=S*Rt+V*$t+ne*Vt,t[11]=L*Rt+G*$t+Te*Vt,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)},fi.rotateX=function(t,e,n){var a=Math.sin(n),l=Math.cos(n),u=e[4],d=e[5],x=e[6],v=e[7],S=e[8],L=e[9],P=e[10],O=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=u*l+S*a,t[5]=d*l+L*a,t[6]=x*l+P*a,t[7]=v*l+O*a,t[8]=S*l-u*a,t[9]=L*l-d*a,t[10]=P*l-x*a,t[11]=O*l-v*a,t},fi.rotateY=function(t,e,n){var a=Math.sin(n),l=Math.cos(n),u=e[0],d=e[1],x=e[2],v=e[3],S=e[8],L=e[9],P=e[10],O=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=u*l-S*a,t[1]=d*l-L*a,t[2]=x*l-P*a,t[3]=v*l-O*a,t[8]=u*a+S*l,t[9]=d*a+L*l,t[10]=x*a+P*l,t[11]=v*a+O*l,t},fi.rotateZ=function(t,e,n){var a=Math.sin(n),l=Math.cos(n),u=e[0],d=e[1],x=e[2],v=e[3],S=e[4],L=e[5],P=e[6],O=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=u*l+S*a,t[1]=d*l+L*a,t[2]=x*l+P*a,t[3]=v*l+O*a,t[4]=S*l-u*a,t[5]=L*l-d*a,t[6]=P*l-x*a,t[7]=O*l-v*a,t},fi.fromTranslation=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t},fi.fromScaling=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fi.fromRotation=function(t,e,n){var a,l,u,d=n[0],x=n[1],v=n[2],S=Math.hypot(d,x,v);return S<Xn.EPSILON?null:(d*=S=1/S,x*=S,v*=S,a=Math.sin(e),l=Math.cos(e),t[0]=d*d*(u=1-l)+l,t[1]=x*d*u+v*a,t[2]=v*d*u-x*a,t[3]=0,t[4]=d*x*u-v*a,t[5]=x*x*u+l,t[6]=v*x*u+d*a,t[7]=0,t[8]=d*v*u+x*a,t[9]=x*v*u-d*a,t[10]=v*v*u+l,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)},fi.fromXRotation=function(t,e){var n=Math.sin(e),a=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=n,t[7]=0,t[8]=0,t[9]=-n,t[10]=a,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fi.fromYRotation=function(t,e){var n=Math.sin(e),a=Math.cos(e);return t[0]=a,t[1]=0,t[2]=-n,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=n,t[9]=0,t[10]=a,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fi.fromZRotation=function(t,e){var n=Math.sin(e),a=Math.cos(e);return t[0]=a,t[1]=n,t[2]=0,t[3]=0,t[4]=-n,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fi.fromRotationTranslation=_n,fi.fromQuat2=function(t,e){var n=new Xn.ARRAY_TYPE(3),a=-e[0],l=-e[1],u=-e[2],d=e[3],x=e[4],v=e[5],S=e[6],L=e[7],P=a*a+l*l+u*u+d*d;return P>0?(n[0]=2*(x*d+L*a+v*u-S*l)/P,n[1]=2*(v*d+L*l+S*a-x*u)/P,n[2]=2*(S*d+L*u+x*l-v*a)/P):(n[0]=2*(x*d+L*a+v*u-S*l),n[1]=2*(v*d+L*l+S*a-x*u),n[2]=2*(S*d+L*u+x*l-v*a)),_n(t,e,n),t},fi.getTranslation=function(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t},fi.getScaling=li,fi.getRotation=function(t,e){var n=new Xn.ARRAY_TYPE(3);li(n,e);var a=1/n[0],l=1/n[1],u=1/n[2],d=e[0]*a,x=e[1]*l,v=e[2]*u,S=e[4]*a,L=e[5]*l,P=e[6]*u,O=e[8]*a,V=e[9]*l,G=e[10]*u,$=d+L+G,Y=0;return $>0?(Y=2*Math.sqrt($+1),t[3]=.25*Y,t[0]=(P-V)/Y,t[1]=(O-v)/Y,t[2]=(x-S)/Y):d>L&&d>G?(Y=2*Math.sqrt(1+d-L-G),t[3]=(P-V)/Y,t[0]=.25*Y,t[1]=(x+S)/Y,t[2]=(O+v)/Y):L>G?(Y=2*Math.sqrt(1+L-d-G),t[3]=(O-v)/Y,t[0]=(x+S)/Y,t[1]=.25*Y,t[2]=(P+V)/Y):(Y=2*Math.sqrt(1+G-d-L),t[3]=(x-S)/Y,t[0]=(O+v)/Y,t[1]=(P+V)/Y,t[2]=.25*Y),t},fi.fromRotationTranslationScale=function(t,e,n,a){var l=e[0],u=e[1],d=e[2],x=e[3],v=l+l,S=u+u,L=d+d,P=l*v,O=l*S,V=l*L,G=u*S,$=u*L,Y=d*L,ne=x*v,Te=x*S,Ae=x*L,Ce=a[0],qe=a[1],Ge=a[2];return t[0]=(1-(G+Y))*Ce,t[1]=(O+Ae)*Ce,t[2]=(V-Te)*Ce,t[3]=0,t[4]=(O-Ae)*qe,t[5]=(1-(P+Y))*qe,t[6]=($+ne)*qe,t[7]=0,t[8]=(V+Te)*Ge,t[9]=($-ne)*Ge,t[10]=(1-(P+G))*Ge,t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t},fi.fromRotationTranslationScaleOrigin=function(t,e,n,a,l){var u=e[0],d=e[1],x=e[2],v=e[3],S=u+u,L=d+d,P=x+x,O=u*S,V=u*L,G=u*P,$=d*L,Y=d*P,ne=x*P,Te=v*S,Ae=v*L,Ce=v*P,qe=a[0],Ge=a[1],ot=a[2],dt=l[0],Rt=l[1],$t=l[2],Vt=(1-($+ne))*qe,ai=(V+Ce)*qe,Ci=(G-Ae)*qe,ti=(V-Ce)*Ge,bi=(1-(O+ne))*Ge,Yt=(Y+Te)*Ge,wi=(G+Ae)*ot,zi=(Y-Te)*ot,Si=(1-(O+$))*ot;return t[0]=Vt,t[1]=ai,t[2]=Ci,t[3]=0,t[4]=ti,t[5]=bi,t[6]=Yt,t[7]=0,t[8]=wi,t[9]=zi,t[10]=Si,t[11]=0,t[12]=n[0]+dt-(Vt*dt+ti*Rt+wi*$t),t[13]=n[1]+Rt-(ai*dt+bi*Rt+zi*$t),t[14]=n[2]+$t-(Ci*dt+Yt*Rt+Si*$t),t[15]=1,t},fi.fromQuat=function(t,e){var n=e[0],a=e[1],l=e[2],u=e[3],d=n+n,x=a+a,v=l+l,S=n*d,L=a*d,P=a*x,O=l*d,V=l*x,G=l*v,$=u*d,Y=u*x,ne=u*v;return t[0]=1-P-G,t[1]=L+ne,t[2]=O-Y,t[3]=0,t[4]=L-ne,t[5]=1-S-G,t[6]=V+$,t[7]=0,t[8]=O+Y,t[9]=V-$,t[10]=1-S-P,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fi.frustum=function(t,e,n,a,l,u,d){var x=1/(n-e),v=1/(l-a),S=1/(u-d);return t[0]=2*u*x,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*u*v,t[6]=0,t[7]=0,t[8]=(n+e)*x,t[9]=(l+a)*v,t[10]=(d+u)*S,t[11]=-1,t[12]=0,t[13]=0,t[14]=d*u*2*S,t[15]=0,t},fi.perspectiveNO=Ie,fi.perspectiveZO=function(t,e,n,a,l){var u,d=1/Math.tan(e/2);return t[0]=d/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=d,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,l!=null&&l!==1/0?(t[10]=l*(u=1/(a-l)),t[14]=l*a*u):(t[10]=-1,t[14]=-a),t},fi.perspectiveFromFieldOfView=function(t,e,n,a){var l=Math.tan(e.upDegrees*Math.PI/180),u=Math.tan(e.downDegrees*Math.PI/180),d=Math.tan(e.leftDegrees*Math.PI/180),x=Math.tan(e.rightDegrees*Math.PI/180),v=2/(d+x),S=2/(l+u);return t[0]=v,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=S,t[6]=0,t[7]=0,t[8]=-(d-x)*v*.5,t[9]=(l-u)*S*.5,t[10]=a/(n-a),t[11]=-1,t[12]=0,t[13]=0,t[14]=a*n/(n-a),t[15]=0,t},fi.orthoNO=ke,fi.orthoZO=function(t,e,n,a,l,u,d){var x=1/(e-n),v=1/(a-l),S=1/(u-d);return t[0]=-2*x,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*v,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=S,t[11]=0,t[12]=(e+n)*x,t[13]=(l+a)*v,t[14]=u*S,t[15]=1,t},fi.lookAt=function(t,e,n,a){var l,u,d,x,v,S,L,P,O,V,G=e[0],$=e[1],Y=e[2],ne=a[0],Te=a[1],Ae=a[2],Ce=n[0],qe=n[1],Ge=n[2];return Math.abs(G-Ce)<Xn.EPSILON&&Math.abs($-qe)<Xn.EPSILON&&Math.abs(Y-Ge)<Xn.EPSILON?dn(t):(L=G-Ce,P=$-qe,O=Y-Ge,l=Te*(O*=V=1/Math.hypot(L,P,O))-Ae*(P*=V),u=Ae*(L*=V)-ne*O,d=ne*P-Te*L,(V=Math.hypot(l,u,d))?(l*=V=1/V,u*=V,d*=V):(l=0,u=0,d=0),x=P*d-O*u,v=O*l-L*d,S=L*u-P*l,(V=Math.hypot(x,v,S))?(x*=V=1/V,v*=V,S*=V):(x=0,v=0,S=0),t[0]=l,t[1]=x,t[2]=L,t[3]=0,t[4]=u,t[5]=v,t[6]=P,t[7]=0,t[8]=d,t[9]=S,t[10]=O,t[11]=0,t[12]=-(l*G+u*$+d*Y),t[13]=-(x*G+v*$+S*Y),t[14]=-(L*G+P*$+O*Y),t[15]=1,t)},fi.targetTo=function(t,e,n,a){var l=e[0],u=e[1],d=e[2],x=a[0],v=a[1],S=a[2],L=l-n[0],P=u-n[1],O=d-n[2],V=L*L+P*P+O*O;V>0&&(L*=V=1/Math.sqrt(V),P*=V,O*=V);var G=v*O-S*P,$=S*L-x*O,Y=x*P-v*L;return(V=G*G+$*$+Y*Y)>0&&(G*=V=1/Math.sqrt(V),$*=V,Y*=V),t[0]=G,t[1]=$,t[2]=Y,t[3]=0,t[4]=P*Y-O*$,t[5]=O*G-L*Y,t[6]=L*$-P*G,t[7]=0,t[8]=L,t[9]=P,t[10]=O,t[11]=0,t[12]=l,t[13]=u,t[14]=d,t[15]=1,t},fi.str=function(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"},fi.frob=function(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])},fi.add=function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t[6]=e[6]+n[6],t[7]=e[7]+n[7],t[8]=e[8]+n[8],t[9]=e[9]+n[9],t[10]=e[10]+n[10],t[11]=e[11]+n[11],t[12]=e[12]+n[12],t[13]=e[13]+n[13],t[14]=e[14]+n[14],t[15]=e[15]+n[15],t},fi.subtract=ht,fi.multiplyScalar=function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12]*n,t[13]=e[13]*n,t[14]=e[14]*n,t[15]=e[15]*n,t},fi.multiplyScalarAndAdd=function(t,e,n,a){return t[0]=e[0]+n[0]*a,t[1]=e[1]+n[1]*a,t[2]=e[2]+n[2]*a,t[3]=e[3]+n[3]*a,t[4]=e[4]+n[4]*a,t[5]=e[5]+n[5]*a,t[6]=e[6]+n[6]*a,t[7]=e[7]+n[7]*a,t[8]=e[8]+n[8]*a,t[9]=e[9]+n[9]*a,t[10]=e[10]+n[10]*a,t[11]=e[11]+n[11]*a,t[12]=e[12]+n[12]*a,t[13]=e[13]+n[13]*a,t[14]=e[14]+n[14]*a,t[15]=e[15]+n[15]*a,t},fi.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]},fi.equals=function(t,e){var n=t[0],a=t[1],l=t[2],u=t[3],d=t[4],x=t[5],v=t[6],S=t[7],L=t[8],P=t[9],O=t[10],V=t[11],G=t[12],$=t[13],Y=t[14],ne=t[15],Te=e[0],Ae=e[1],Ce=e[2],qe=e[3],Ge=e[4],ot=e[5],dt=e[6],Rt=e[7],$t=e[8],Vt=e[9],ai=e[10],Ci=e[11],ti=e[12],bi=e[13],Yt=e[14],wi=e[15];return Math.abs(n-Te)<=Xn.EPSILON*Math.max(1,Math.abs(n),Math.abs(Te))&&Math.abs(a-Ae)<=Xn.EPSILON*Math.max(1,Math.abs(a),Math.abs(Ae))&&Math.abs(l-Ce)<=Xn.EPSILON*Math.max(1,Math.abs(l),Math.abs(Ce))&&Math.abs(u-qe)<=Xn.EPSILON*Math.max(1,Math.abs(u),Math.abs(qe))&&Math.abs(d-Ge)<=Xn.EPSILON*Math.max(1,Math.abs(d),Math.abs(Ge))&&Math.abs(x-ot)<=Xn.EPSILON*Math.max(1,Math.abs(x),Math.abs(ot))&&Math.abs(v-dt)<=Xn.EPSILON*Math.max(1,Math.abs(v),Math.abs(dt))&&Math.abs(S-Rt)<=Xn.EPSILON*Math.max(1,Math.abs(S),Math.abs(Rt))&&Math.abs(L-$t)<=Xn.EPSILON*Math.max(1,Math.abs(L),Math.abs($t))&&Math.abs(P-Vt)<=Xn.EPSILON*Math.max(1,Math.abs(P),Math.abs(Vt))&&Math.abs(O-ai)<=Xn.EPSILON*Math.max(1,Math.abs(O),Math.abs(ai))&&Math.abs(V-Ci)<=Xn.EPSILON*Math.max(1,Math.abs(V),Math.abs(Ci))&&Math.abs(G-ti)<=Xn.EPSILON*Math.max(1,Math.abs(G),Math.abs(ti))&&Math.abs($-bi)<=Xn.EPSILON*Math.max(1,Math.abs($),Math.abs(bi))&&Math.abs(Y-Yt)<=Xn.EPSILON*Math.max(1,Math.abs(Y),Math.abs(Yt))&&Math.abs(ne-wi)<=Xn.EPSILON*Math.max(1,Math.abs(ne),Math.abs(wi))},fi.sub=fi.mul=fi.ortho=fi.perspective=void 0;var Xn=function(t,e){if(t&&t.__esModule)return t;if(t===null||pr(t)!=="object"&&typeof t!="function")return{default:t};var n=wr(void 0);if(n&&n.has(t))return n.get(t);var a={},l=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in t)if(u!=="default"&&Object.prototype.hasOwnProperty.call(t,u)){var d=l?Object.getOwnPropertyDescriptor(t,u):null;d&&(d.get||d.set)?Object.defineProperty(a,u,d):a[u]=t[u]}return a.default=t,n&&n.set(t,a),a}(lt);function wr(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,n=new WeakMap;return(wr=function(a){return a?n:e})(t)}function dn(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function ln(t,e,n){var a=e[0],l=e[1],u=e[2],d=e[3],x=e[4],v=e[5],S=e[6],L=e[7],P=e[8],O=e[9],V=e[10],G=e[11],$=e[12],Y=e[13],ne=e[14],Te=e[15],Ae=n[0],Ce=n[1],qe=n[2],Ge=n[3];return t[0]=Ae*a+Ce*x+qe*P+Ge*$,t[1]=Ae*l+Ce*v+qe*O+Ge*Y,t[2]=Ae*u+Ce*S+qe*V+Ge*ne,t[3]=Ae*d+Ce*L+qe*G+Ge*Te,t[4]=(Ae=n[4])*a+(Ce=n[5])*x+(qe=n[6])*P+(Ge=n[7])*$,t[5]=Ae*l+Ce*v+qe*O+Ge*Y,t[6]=Ae*u+Ce*S+qe*V+Ge*ne,t[7]=Ae*d+Ce*L+qe*G+Ge*Te,t[8]=(Ae=n[8])*a+(Ce=n[9])*x+(qe=n[10])*P+(Ge=n[11])*$,t[9]=Ae*l+Ce*v+qe*O+Ge*Y,t[10]=Ae*u+Ce*S+qe*V+Ge*ne,t[11]=Ae*d+Ce*L+qe*G+Ge*Te,t[12]=(Ae=n[12])*a+(Ce=n[13])*x+(qe=n[14])*P+(Ge=n[15])*$,t[13]=Ae*l+Ce*v+qe*O+Ge*Y,t[14]=Ae*u+Ce*S+qe*V+Ge*ne,t[15]=Ae*d+Ce*L+qe*G+Ge*Te,t}function _n(t,e,n){var a=e[0],l=e[1],u=e[2],d=e[3],x=a+a,v=l+l,S=u+u,L=a*x,P=a*v,O=a*S,V=l*v,G=l*S,$=u*S,Y=d*x,ne=d*v,Te=d*S;return t[0]=1-(V+$),t[1]=P+Te,t[2]=O-ne,t[3]=0,t[4]=P-Te,t[5]=1-(L+$),t[6]=G+Y,t[7]=0,t[8]=O+ne,t[9]=G-Y,t[10]=1-(L+V),t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t}function li(t,e){var n=e[4],a=e[5],l=e[6],u=e[8],d=e[9],x=e[10];return t[0]=Math.hypot(e[0],e[1],e[2]),t[1]=Math.hypot(n,a,l),t[2]=Math.hypot(u,d,x),t}function Ie(t,e,n,a,l){var u,d=1/Math.tan(e/2);return t[0]=d/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=d,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,l!=null&&l!==1/0?(t[10]=(l+a)*(u=1/(a-l)),t[14]=2*l*a*u):(t[10]=-1,t[14]=-2*a),t}function ke(t,e,n,a,l,u,d){var x=1/(e-n),v=1/(a-l),S=1/(u-d);return t[0]=-2*x,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*v,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*S,t[11]=0,t[12]=(e+n)*x,t[13]=(l+a)*v,t[14]=(d+u)*S,t[15]=1,t}function ht(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t[4]=e[4]-n[4],t[5]=e[5]-n[5],t[6]=e[6]-n[6],t[7]=e[7]-n[7],t[8]=e[8]-n[8],t[9]=e[9]-n[9],t[10]=e[10]-n[10],t[11]=e[11]-n[11],t[12]=e[12]-n[12],t[13]=e[13]-n[13],t[14]=e[14]-n[14],t[15]=e[15]-n[15],t}fi.perspective=Ie,fi.ortho=ke,fi.mul=ln,fi.sub=ht;var Ue={},Ye={};function xt(t){return xt=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},xt(t)}Object.defineProperty(Ye,"__esModule",{value:!0}),Ye.create=si,Ye.clone=function(t){var e=new zt.ARRAY_TYPE(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},Ye.length=Qi,Ye.fromValues=function(t,e,n){var a=new zt.ARRAY_TYPE(3);return a[0]=t,a[1]=e,a[2]=n,a},Ye.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},Ye.set=function(t,e,n,a){return t[0]=e,t[1]=n,t[2]=a,t},Ye.add=function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t},Ye.subtract=tn,Ye.multiply=kn,Ye.divide=Gn,Ye.ceil=function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t},Ye.floor=function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t},Ye.min=function(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t[2]=Math.min(e[2],n[2]),t},Ye.max=function(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t[2]=Math.max(e[2],n[2]),t},Ye.round=function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t},Ye.scale=function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t},Ye.scaleAndAdd=function(t,e,n,a){return t[0]=e[0]+n[0]*a,t[1]=e[1]+n[1]*a,t[2]=e[2]+n[2]*a,t},Ye.distance=Yn,Ye.squaredDistance=Jn,Ye.squaredLength=Dn,Ye.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},Ye.inverse=function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t},Ye.normalize=function(t,e){var n=e[0],a=e[1],l=e[2],u=n*n+a*a+l*l;return u>0&&(u=1/Math.sqrt(u)),t[0]=e[0]*u,t[1]=e[1]*u,t[2]=e[2]*u,t},Ye.dot=ar,Ye.cross=function(t,e,n){var a=e[0],l=e[1],u=e[2],d=n[0],x=n[1],v=n[2];return t[0]=l*v-u*x,t[1]=u*d-a*v,t[2]=a*x-l*d,t},Ye.lerp=function(t,e,n,a){var l=e[0],u=e[1],d=e[2];return t[0]=l+a*(n[0]-l),t[1]=u+a*(n[1]-u),t[2]=d+a*(n[2]-d),t},Ye.hermite=function(t,e,n,a,l,u){var d=u*u,x=d*(2*u-3)+1,v=d*(u-2)+u,S=d*(u-1),L=d*(3-2*u);return t[0]=e[0]*x+n[0]*v+a[0]*S+l[0]*L,t[1]=e[1]*x+n[1]*v+a[1]*S+l[1]*L,t[2]=e[2]*x+n[2]*v+a[2]*S+l[2]*L,t},Ye.bezier=function(t,e,n,a,l,u){var d=1-u,x=d*d,v=u*u,S=x*d,L=3*u*x,P=3*v*d,O=v*u;return t[0]=e[0]*S+n[0]*L+a[0]*P+l[0]*O,t[1]=e[1]*S+n[1]*L+a[1]*P+l[1]*O,t[2]=e[2]*S+n[2]*L+a[2]*P+l[2]*O,t},Ye.random=function(t,e){e=e||1;var n=2*zt.RANDOM()*Math.PI,a=2*zt.RANDOM()-1,l=Math.sqrt(1-a*a)*e;return t[0]=Math.cos(n)*l,t[1]=Math.sin(n)*l,t[2]=a*e,t},Ye.transformMat4=function(t,e,n){var a=e[0],l=e[1],u=e[2],d=n[3]*a+n[7]*l+n[11]*u+n[15];return t[0]=(n[0]*a+n[4]*l+n[8]*u+n[12])/(d=d||1),t[1]=(n[1]*a+n[5]*l+n[9]*u+n[13])/d,t[2]=(n[2]*a+n[6]*l+n[10]*u+n[14])/d,t},Ye.transformMat3=function(t,e,n){var a=e[0],l=e[1],u=e[2];return t[0]=a*n[0]+l*n[3]+u*n[6],t[1]=a*n[1]+l*n[4]+u*n[7],t[2]=a*n[2]+l*n[5]+u*n[8],t},Ye.transformQuat=function(t,e,n){var a=n[0],l=n[1],u=n[2],d=e[0],x=e[1],v=e[2],S=l*v-u*x,L=u*d-a*v,P=a*x-l*d,O=l*P-u*L,V=u*S-a*P,G=a*L-l*S,$=2*n[3];return L*=$,P*=$,V*=2,G*=2,t[0]=d+(S*=$)+(O*=2),t[1]=x+L+V,t[2]=v+P+G,t},Ye.rotateX=function(t,e,n,a){var l=[],u=[];return l[0]=e[0]-n[0],l[1]=e[1]-n[1],l[2]=e[2]-n[2],u[0]=l[0],u[1]=l[1]*Math.cos(a)-l[2]*Math.sin(a),u[2]=l[1]*Math.sin(a)+l[2]*Math.cos(a),t[0]=u[0]+n[0],t[1]=u[1]+n[1],t[2]=u[2]+n[2],t},Ye.rotateY=function(t,e,n,a){var l=[],u=[];return l[0]=e[0]-n[0],l[1]=e[1]-n[1],l[2]=e[2]-n[2],u[0]=l[2]*Math.sin(a)+l[0]*Math.cos(a),u[1]=l[1],u[2]=l[2]*Math.cos(a)-l[0]*Math.sin(a),t[0]=u[0]+n[0],t[1]=u[1]+n[1],t[2]=u[2]+n[2],t},Ye.rotateZ=function(t,e,n,a){var l=[],u=[];return l[0]=e[0]-n[0],l[1]=e[1]-n[1],l[2]=e[2]-n[2],u[0]=l[0]*Math.cos(a)-l[1]*Math.sin(a),u[1]=l[0]*Math.sin(a)+l[1]*Math.cos(a),u[2]=l[2],t[0]=u[0]+n[0],t[1]=u[1]+n[1],t[2]=u[2]+n[2],t},Ye.angle=function(t,e){var n=t[0],a=t[1],l=t[2],u=e[0],d=e[1],x=e[2],v=Math.sqrt(n*n+a*a+l*l)*Math.sqrt(u*u+d*d+x*x),S=v&&ar(t,e)/v;return Math.acos(Math.min(Math.max(S,-1),1))},Ye.zero=function(t){return t[0]=0,t[1]=0,t[2]=0,t},Ye.str=function(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"},Ye.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]},Ye.equals=function(t,e){var n=t[0],a=t[1],l=t[2],u=e[0],d=e[1],x=e[2];return Math.abs(n-u)<=zt.EPSILON*Math.max(1,Math.abs(n),Math.abs(u))&&Math.abs(a-d)<=zt.EPSILON*Math.max(1,Math.abs(a),Math.abs(d))&&Math.abs(l-x)<=zt.EPSILON*Math.max(1,Math.abs(l),Math.abs(x))},Ye.forEach=Ye.sqrLen=Ye.len=Ye.sqrDist=Ye.dist=Ye.div=Ye.mul=Ye.sub=void 0;var zt=function(t,e){if(t&&t.__esModule)return t;if(t===null||xt(t)!=="object"&&typeof t!="function")return{default:t};var n=It(void 0);if(n&&n.has(t))return n.get(t);var a={},l=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in t)if(u!=="default"&&Object.prototype.hasOwnProperty.call(t,u)){var d=l?Object.getOwnPropertyDescriptor(t,u):null;d&&(d.get||d.set)?Object.defineProperty(a,u,d):a[u]=t[u]}return a.default=t,n&&n.set(t,a),a}(lt);function It(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,n=new WeakMap;return(It=function(a){return a?n:e})(t)}function si(){var t=new zt.ARRAY_TYPE(3);return zt.ARRAY_TYPE!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function Qi(t){return Math.hypot(t[0],t[1],t[2])}function tn(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function kn(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t}function Gn(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t[2]=e[2]/n[2],t}function Yn(t,e){return Math.hypot(e[0]-t[0],e[1]-t[1],e[2]-t[2])}function Jn(t,e){var n=e[0]-t[0],a=e[1]-t[1],l=e[2]-t[2];return n*n+a*a+l*l}function Dn(t){var e=t[0],n=t[1],a=t[2];return e*e+n*n+a*a}function ar(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}Ye.sub=tn,Ye.mul=kn,Ye.div=Gn,Ye.dist=Yn,Ye.sqrDist=Jn,Ye.len=Qi,Ye.sqrLen=Dn;var rs,ms=(rs=si(),function(t,e,n,a,l,u){var d,x;for(e||(e=3),n||(n=0),x=a?Math.min(a*e+n,t.length):t.length,d=n;d<x;d+=e)rs[0]=t[d],rs[1]=t[d+1],rs[2]=t[d+2],l(rs,rs,u),t[d]=rs[0],t[d+1]=rs[1],t[d+2]=rs[2];return t});Ye.forEach=ms;var Un={};function ho(t){return ho=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ho(t)}Object.defineProperty(Un,"__esModule",{value:!0}),Un.create=Ms,Un.clone=function(t){var e=new Ri.ARRAY_TYPE(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},Un.fromValues=function(t,e,n,a){var l=new Ri.ARRAY_TYPE(4);return l[0]=t,l[1]=e,l[2]=n,l[3]=a,l},Un.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},Un.set=function(t,e,n,a,l){return t[0]=e,t[1]=n,t[2]=a,t[3]=l,t},Un.add=function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t},Un.subtract=Fs,Un.multiply=Po,Un.divide=ds,Un.ceil=function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t[3]=Math.ceil(e[3]),t},Un.floor=function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t[3]=Math.floor(e[3]),t},Un.min=function(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t[2]=Math.min(e[2],n[2]),t[3]=Math.min(e[3],n[3]),t},Un.max=function(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t[2]=Math.max(e[2],n[2]),t[3]=Math.max(e[3],n[3]),t},Un.round=function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t[3]=Math.round(e[3]),t},Un.scale=function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t},Un.scaleAndAdd=function(t,e,n,a){return t[0]=e[0]+n[0]*a,t[1]=e[1]+n[1]*a,t[2]=e[2]+n[2]*a,t[3]=e[3]+n[3]*a,t},Un.distance=ys,Un.squaredDistance=Mr,Un.length=Bs,Un.squaredLength=js,Un.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},Un.inverse=function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t},Un.normalize=function(t,e){var n=e[0],a=e[1],l=e[2],u=e[3],d=n*n+a*a+l*l+u*u;return d>0&&(d=1/Math.sqrt(d)),t[0]=n*d,t[1]=a*d,t[2]=l*d,t[3]=u*d,t},Un.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},Un.cross=function(t,e,n,a){var l=n[0]*a[1]-n[1]*a[0],u=n[0]*a[2]-n[2]*a[0],d=n[0]*a[3]-n[3]*a[0],x=n[1]*a[2]-n[2]*a[1],v=n[1]*a[3]-n[3]*a[1],S=n[2]*a[3]-n[3]*a[2],L=e[0],P=e[1],O=e[2],V=e[3];return t[0]=P*S-O*v+V*x,t[1]=-L*S+O*d-V*u,t[2]=L*v-P*d+V*l,t[3]=-L*x+P*u-O*l,t},Un.lerp=function(t,e,n,a){var l=e[0],u=e[1],d=e[2],x=e[3];return t[0]=l+a*(n[0]-l),t[1]=u+a*(n[1]-u),t[2]=d+a*(n[2]-d),t[3]=x+a*(n[3]-x),t},Un.random=function(t,e){var n,a,l,u,d,x;e=e||1;do d=(n=2*Ri.RANDOM()-1)*n+(a=2*Ri.RANDOM()-1)*a;while(d>=1);do x=(l=2*Ri.RANDOM()-1)*l+(u=2*Ri.RANDOM()-1)*u;while(x>=1);var v=Math.sqrt((1-d)/x);return t[0]=e*n,t[1]=e*a,t[2]=e*l*v,t[3]=e*u*v,t},Un.transformMat4=function(t,e,n){var a=e[0],l=e[1],u=e[2],d=e[3];return t[0]=n[0]*a+n[4]*l+n[8]*u+n[12]*d,t[1]=n[1]*a+n[5]*l+n[9]*u+n[13]*d,t[2]=n[2]*a+n[6]*l+n[10]*u+n[14]*d,t[3]=n[3]*a+n[7]*l+n[11]*u+n[15]*d,t},Un.transformQuat=function(t,e,n){var a=e[0],l=e[1],u=e[2],d=n[0],x=n[1],v=n[2],S=n[3],L=S*a+x*u-v*l,P=S*l+v*a-d*u,O=S*u+d*l-x*a,V=-d*a-x*l-v*u;return t[0]=L*S+V*-d+P*-v-O*-x,t[1]=P*S+V*-x+O*-d-L*-v,t[2]=O*S+V*-v+L*-x-P*-d,t[3]=e[3],t},Un.zero=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t},Un.str=function(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},Un.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]},Un.equals=function(t,e){var n=t[0],a=t[1],l=t[2],u=t[3],d=e[0],x=e[1],v=e[2],S=e[3];return Math.abs(n-d)<=Ri.EPSILON*Math.max(1,Math.abs(n),Math.abs(d))&&Math.abs(a-x)<=Ri.EPSILON*Math.max(1,Math.abs(a),Math.abs(x))&&Math.abs(l-v)<=Ri.EPSILON*Math.max(1,Math.abs(l),Math.abs(v))&&Math.abs(u-S)<=Ri.EPSILON*Math.max(1,Math.abs(u),Math.abs(S))},Un.forEach=Un.sqrLen=Un.len=Un.sqrDist=Un.dist=Un.div=Un.mul=Un.sub=void 0;var Ri=function(t,e){if(t&&t.__esModule)return t;if(t===null||ho(t)!=="object"&&typeof t!="function")return{default:t};var n=jr(void 0);if(n&&n.has(t))return n.get(t);var a={},l=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in t)if(u!=="default"&&Object.prototype.hasOwnProperty.call(t,u)){var d=l?Object.getOwnPropertyDescriptor(t,u):null;d&&(d.get||d.set)?Object.defineProperty(a,u,d):a[u]=t[u]}return a.default=t,n&&n.set(t,a),a}(lt);function jr(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,n=new WeakMap;return(jr=function(a){return a?n:e})(t)}function Ms(){var t=new Ri.ARRAY_TYPE(4);return Ri.ARRAY_TYPE!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function Fs(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t}function Po(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t[3]=e[3]*n[3],t}function ds(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t[2]=e[2]/n[2],t[3]=e[3]/n[3],t}function ys(t,e){return Math.hypot(e[0]-t[0],e[1]-t[1],e[2]-t[2],e[3]-t[3])}function Mr(t,e){var n=e[0]-t[0],a=e[1]-t[1],l=e[2]-t[2],u=e[3]-t[3];return n*n+a*a+l*l+u*u}function Bs(t){return Math.hypot(t[0],t[1],t[2],t[3])}function js(t){var e=t[0],n=t[1],a=t[2],l=t[3];return e*e+n*n+a*a+l*l}Un.sub=Fs,Un.mul=Po,Un.div=ds,Un.dist=ys,Un.sqrDist=Mr,Un.len=Bs,Un.sqrLen=js;var Wo=function(){var t=Ms();return function(e,n,a,l,u,d){var x,v;for(n||(n=4),a||(a=0),v=l?Math.min(l*n+a,e.length):e.length,x=a;x<v;x+=n)t[0]=e[x],t[1]=e[x+1],t[2]=e[x+2],t[3]=e[x+3],u(t,t,d),e[x]=t[0],e[x+1]=t[1],e[x+2]=t[2],e[x+3]=t[3];return e}}();function Rs(t){return Rs=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Rs(t)}Un.forEach=Wo,Object.defineProperty(Ue,"__esModule",{value:!0}),Ue.create=ca,Ue.identity=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t},Ue.setAxisAngle=ha,Ue.getAxisAngle=function(t,e){var n=2*Math.acos(e[3]),a=Math.sin(n/2);return a>et.EPSILON?(t[0]=e[0]/a,t[1]=e[1]/a,t[2]=e[2]/a):(t[0]=1,t[1]=0,t[2]=0),n},Ue.getAngle=function(t,e){var n=tt(t,e);return Math.acos(2*n*n-1)},Ue.multiply=ta,Ue.rotateX=function(t,e,n){n*=.5;var a=e[0],l=e[1],u=e[2],d=e[3],x=Math.sin(n),v=Math.cos(n);return t[0]=a*v+d*x,t[1]=l*v+u*x,t[2]=u*v-l*x,t[3]=d*v-a*x,t},Ue.rotateY=function(t,e,n){n*=.5;var a=e[0],l=e[1],u=e[2],d=e[3],x=Math.sin(n),v=Math.cos(n);return t[0]=a*v-u*x,t[1]=l*v+d*x,t[2]=u*v+a*x,t[3]=d*v-l*x,t},Ue.rotateZ=function(t,e,n){n*=.5;var a=e[0],l=e[1],u=e[2],d=e[3],x=Math.sin(n),v=Math.cos(n);return t[0]=a*v+l*x,t[1]=l*v-a*x,t[2]=u*v+d*x,t[3]=d*v-u*x,t},Ue.calculateW=function(t,e){var n=e[0],a=e[1],l=e[2];return t[0]=n,t[1]=a,t[2]=l,t[3]=Math.sqrt(Math.abs(1-n*n-a*a-l*l)),t},Ue.exp=at,Ue.ln=se,Ue.pow=function(t,e,n){return se(t,e),Ke(t,t,n),at(t,t),t},Ue.slerp=me,Ue.random=function(t){var e=et.RANDOM(),n=et.RANDOM(),a=et.RANDOM(),l=Math.sqrt(1-e),u=Math.sqrt(e);return t[0]=l*Math.sin(2*Math.PI*n),t[1]=l*Math.cos(2*Math.PI*n),t[2]=u*Math.sin(2*Math.PI*a),t[3]=u*Math.cos(2*Math.PI*a),t},Ue.invert=function(t,e){var n=e[0],a=e[1],l=e[2],u=e[3],d=n*n+a*a+l*l+u*u,x=d?1/d:0;return t[0]=-n*x,t[1]=-a*x,t[2]=-l*x,t[3]=u*x,t},Ue.conjugate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t},Ue.fromMat3=Oe,Ue.fromEuler=function(t,e,n,a){var l=.5*Math.PI/180;e*=l,n*=l,a*=l;var u=Math.sin(e),d=Math.cos(e),x=Math.sin(n),v=Math.cos(n),S=Math.sin(a),L=Math.cos(a);return t[0]=u*v*L-d*x*S,t[1]=d*x*L+u*v*S,t[2]=d*v*S-u*x*L,t[3]=d*v*L+u*x*S,t},Ue.str=function(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},Ue.setAxes=Ue.sqlerp=Ue.rotationTo=Ue.equals=Ue.exactEquals=Ue.normalize=Ue.sqrLen=Ue.squaredLength=Ue.len=Ue.length=Ue.lerp=Ue.dot=Ue.scale=Ue.mul=Ue.add=Ue.set=Ue.copy=Ue.fromValues=Ue.clone=void 0;var et=Ro(lt),Bo=Ro(ft),As=Ro(Ye),ps=Ro(Un);function No(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,n=new WeakMap;return(No=function(a){return a?n:e})(t)}function Ro(t,e){if(t&&t.__esModule)return t;if(t===null||Rs(t)!=="object"&&typeof t!="function")return{default:t};var n=No(e);if(n&&n.has(t))return n.get(t);var a={},l=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in t)if(u!=="default"&&Object.prototype.hasOwnProperty.call(t,u)){var d=l?Object.getOwnPropertyDescriptor(t,u):null;d&&(d.get||d.set)?Object.defineProperty(a,u,d):a[u]=t[u]}return a.default=t,n&&n.set(t,a),a}function ca(){var t=new et.ARRAY_TYPE(4);return et.ARRAY_TYPE!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function ha(t,e,n){n*=.5;var a=Math.sin(n);return t[0]=a*e[0],t[1]=a*e[1],t[2]=a*e[2],t[3]=Math.cos(n),t}function ta(t,e,n){var a=e[0],l=e[1],u=e[2],d=e[3],x=n[0],v=n[1],S=n[2],L=n[3];return t[0]=a*L+d*x+l*S-u*v,t[1]=l*L+d*v+u*x-a*S,t[2]=u*L+d*S+a*v-l*x,t[3]=d*L-a*x-l*v-u*S,t}function at(t,e){var n=e[0],a=e[1],l=e[2],u=e[3],d=Math.sqrt(n*n+a*a+l*l),x=Math.exp(u),v=d>0?x*Math.sin(d)/d:0;return t[0]=n*v,t[1]=a*v,t[2]=l*v,t[3]=x*Math.cos(d),t}function se(t,e){var n=e[0],a=e[1],l=e[2],u=e[3],d=Math.sqrt(n*n+a*a+l*l),x=d>0?Math.atan2(d,u)/d:0;return t[0]=n*x,t[1]=a*x,t[2]=l*x,t[3]=.5*Math.log(n*n+a*a+l*l+u*u),t}function me(t,e,n,a){var l,u,d,x,v,S=e[0],L=e[1],P=e[2],O=e[3],V=n[0],G=n[1],$=n[2],Y=n[3];return(u=S*V+L*G+P*$+O*Y)<0&&(u=-u,V=-V,G=-G,$=-$,Y=-Y),1-u>et.EPSILON?(l=Math.acos(u),d=Math.sin(l),x=Math.sin((1-a)*l)/d,v=Math.sin(a*l)/d):(x=1-a,v=a),t[0]=x*S+v*V,t[1]=x*L+v*G,t[2]=x*P+v*$,t[3]=x*O+v*Y,t}function Oe(t,e){var n,a=e[0]+e[4]+e[8];if(a>0)n=Math.sqrt(a+1),t[3]=.5*n,t[0]=(e[5]-e[7])*(n=.5/n),t[1]=(e[6]-e[2])*n,t[2]=(e[1]-e[3])*n;else{var l=0;e[4]>e[0]&&(l=1),e[8]>e[3*l+l]&&(l=2);var u=(l+1)%3,d=(l+2)%3;n=Math.sqrt(e[3*l+l]-e[3*u+u]-e[3*d+d]+1),t[l]=.5*n,t[3]=(e[3*u+d]-e[3*d+u])*(n=.5/n),t[u]=(e[3*u+l]+e[3*l+u])*n,t[d]=(e[3*d+l]+e[3*l+d])*n}return t}Ue.clone=ps.clone,Ue.fromValues=ps.fromValues,Ue.copy=ps.copy,Ue.set=ps.set,Ue.add=ps.add,Ue.mul=ta;var Ke=ps.scale;Ue.scale=Ke;var tt=ps.dot;Ue.dot=tt,Ue.lerp=ps.lerp;var At=ps.length;Ue.length=At,Ue.len=At;var Ft=ps.squaredLength;Ue.squaredLength=Ft,Ue.sqrLen=Ft;var yt=ps.normalize;Ue.normalize=yt,Ue.exactEquals=ps.exactEquals,Ue.equals=ps.equals;var jt,Oi,Mi,wn=(jt=As.create(),Oi=As.fromValues(1,0,0),Mi=As.fromValues(0,1,0),function(t,e,n){var a=As.dot(e,n);return a<-.999999?(As.cross(jt,Oi,e),As.len(jt)<1e-6&&As.cross(jt,Mi,e),As.normalize(jt,jt),ha(t,jt,Math.PI),t):a>.999999?(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t):(As.cross(jt,e,n),t[0]=jt[0],t[1]=jt[1],t[2]=jt[2],t[3]=1+a,yt(t,t))});Ue.rotationTo=wn;var Bn,Vn,lr=(Bn=ca(),Vn=ca(),function(t,e,n,a,l,u){return me(Bn,e,l,u),me(Vn,n,a,u),me(t,Bn,Vn,2*u*(1-u)),t});Ue.sqlerp=lr;var jn,fr=(jn=Bo.create(),function(t,e,n,a){return jn[0]=n[0],jn[3]=n[1],jn[6]=n[2],jn[1]=a[0],jn[4]=a[1],jn[7]=a[2],jn[2]=-e[0],jn[5]=-e[1],jn[8]=-e[2],yt(t,Oe(t,jn))});Ue.setAxes=fr;var bn={};function as(t){return as=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},as(t)}Object.defineProperty(bn,"__esModule",{value:!0}),bn.create=function(){var t=new Vr.ARRAY_TYPE(8);return Vr.ARRAY_TYPE!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0),t[3]=1,t},bn.clone=function(t){var e=new Vr.ARRAY_TYPE(8);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e},bn.fromValues=function(t,e,n,a,l,u,d,x){var v=new Vr.ARRAY_TYPE(8);return v[0]=t,v[1]=e,v[2]=n,v[3]=a,v[4]=l,v[5]=u,v[6]=d,v[7]=x,v},bn.fromRotationTranslationValues=function(t,e,n,a,l,u,d){var x=new Vr.ARRAY_TYPE(8);x[0]=t,x[1]=e,x[2]=n,x[3]=a;var v=.5*l,S=.5*u,L=.5*d;return x[4]=v*a+S*n-L*e,x[5]=S*a+L*t-v*n,x[6]=L*a+v*e-S*t,x[7]=-v*t-S*e-L*n,x},bn.fromRotationTranslation=Cs,bn.fromTranslation=function(t,e){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=.5*e[0],t[5]=.5*e[1],t[6]=.5*e[2],t[7]=0,t},bn.fromRotation=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=0,t[5]=0,t[6]=0,t[7]=0,t},bn.fromMat4=function(t,e){var n=br.create();Mn.getRotation(n,e);var a=new Vr.ARRAY_TYPE(3);return Mn.getTranslation(a,e),Cs(t,n,a),t},bn.copy=uo,bn.identity=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t},bn.set=function(t,e,n,a,l,u,d,x,v){return t[0]=e,t[1]=n,t[2]=a,t[3]=l,t[4]=u,t[5]=d,t[6]=x,t[7]=v,t},bn.getDual=function(t,e){return t[0]=e[4],t[1]=e[5],t[2]=e[6],t[3]=e[7],t},bn.setDual=function(t,e){return t[4]=e[0],t[5]=e[1],t[6]=e[2],t[7]=e[3],t},bn.getTranslation=function(t,e){var n=e[4],a=e[5],l=e[6],u=e[7],d=-e[0],x=-e[1],v=-e[2],S=e[3];return t[0]=2*(n*S+u*d+a*v-l*x),t[1]=2*(a*S+u*x+l*d-n*v),t[2]=2*(l*S+u*v+n*x-a*d),t},bn.translate=function(t,e,n){var a=e[0],l=e[1],u=e[2],d=e[3],x=.5*n[0],v=.5*n[1],S=.5*n[2],L=e[4],P=e[5],O=e[6],V=e[7];return t[0]=a,t[1]=l,t[2]=u,t[3]=d,t[4]=d*x+l*S-u*v+L,t[5]=d*v+u*x-a*S+P,t[6]=d*S+a*v-l*x+O,t[7]=-a*x-l*v-u*S+V,t},bn.rotateX=function(t,e,n){var a=-e[0],l=-e[1],u=-e[2],d=e[3],x=e[4],v=e[5],S=e[6],L=e[7],P=x*d+L*a+v*u-S*l,O=v*d+L*l+S*a-x*u,V=S*d+L*u+x*l-v*a,G=L*d-x*a-v*l-S*u;return br.rotateX(t,e,n),t[4]=P*(d=t[3])+G*(a=t[0])+O*(u=t[2])-V*(l=t[1]),t[5]=O*d+G*l+V*a-P*u,t[6]=V*d+G*u+P*l-O*a,t[7]=G*d-P*a-O*l-V*u,t},bn.rotateY=function(t,e,n){var a=-e[0],l=-e[1],u=-e[2],d=e[3],x=e[4],v=e[5],S=e[6],L=e[7],P=x*d+L*a+v*u-S*l,O=v*d+L*l+S*a-x*u,V=S*d+L*u+x*l-v*a,G=L*d-x*a-v*l-S*u;return br.rotateY(t,e,n),t[4]=P*(d=t[3])+G*(a=t[0])+O*(u=t[2])-V*(l=t[1]),t[5]=O*d+G*l+V*a-P*u,t[6]=V*d+G*u+P*l-O*a,t[7]=G*d-P*a-O*l-V*u,t},bn.rotateZ=function(t,e,n){var a=-e[0],l=-e[1],u=-e[2],d=e[3],x=e[4],v=e[5],S=e[6],L=e[7],P=x*d+L*a+v*u-S*l,O=v*d+L*l+S*a-x*u,V=S*d+L*u+x*l-v*a,G=L*d-x*a-v*l-S*u;return br.rotateZ(t,e,n),t[4]=P*(d=t[3])+G*(a=t[0])+O*(u=t[2])-V*(l=t[1]),t[5]=O*d+G*l+V*a-P*u,t[6]=V*d+G*u+P*l-O*a,t[7]=G*d-P*a-O*l-V*u,t},bn.rotateByQuatAppend=function(t,e,n){var a=n[0],l=n[1],u=n[2],d=n[3],x=e[0],v=e[1],S=e[2],L=e[3];return t[0]=x*d+L*a+v*u-S*l,t[1]=v*d+L*l+S*a-x*u,t[2]=S*d+L*u+x*l-v*a,t[3]=L*d-x*a-v*l-S*u,t[4]=(x=e[4])*d+(L=e[7])*a+(v=e[5])*u-(S=e[6])*l,t[5]=v*d+L*l+S*a-x*u,t[6]=S*d+L*u+x*l-v*a,t[7]=L*d-x*a-v*l-S*u,t},bn.rotateByQuatPrepend=function(t,e,n){var a=e[0],l=e[1],u=e[2],d=e[3],x=n[0],v=n[1],S=n[2],L=n[3];return t[0]=a*L+d*x+l*S-u*v,t[1]=l*L+d*v+u*x-a*S,t[2]=u*L+d*S+a*v-l*x,t[3]=d*L-a*x-l*v-u*S,t[4]=a*(L=n[7])+d*(x=n[4])+l*(S=n[6])-u*(v=n[5]),t[5]=l*L+d*v+u*x-a*S,t[6]=u*L+d*S+a*v-l*x,t[7]=d*L-a*x-l*v-u*S,t},bn.rotateAroundAxis=function(t,e,n,a){if(Math.abs(a)<Vr.EPSILON)return uo(t,e);var l=Math.hypot(n[0],n[1],n[2]);a*=.5;var u=Math.sin(a),d=u*n[0]/l,x=u*n[1]/l,v=u*n[2]/l,S=Math.cos(a),L=e[0],P=e[1],O=e[2],V=e[3];t[0]=L*S+V*d+P*v-O*x,t[1]=P*S+V*x+O*d-L*v,t[2]=O*S+V*v+L*x-P*d,t[3]=V*S-L*d-P*x-O*v;var G=e[4],$=e[5],Y=e[6],ne=e[7];return t[4]=G*S+ne*d+$*v-Y*x,t[5]=$*S+ne*x+Y*d-G*v,t[6]=Y*S+ne*v+G*x-$*d,t[7]=ne*S-G*d-$*x-Y*v,t},bn.add=function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t[6]=e[6]+n[6],t[7]=e[7]+n[7],t},bn.multiply=bo,bn.scale=function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t},bn.lerp=function(t,e,n,a){var l=1-a;return wl(e,n)<0&&(a=-a),t[0]=e[0]*l+n[0]*a,t[1]=e[1]*l+n[1]*a,t[2]=e[2]*l+n[2]*a,t[3]=e[3]*l+n[3]*a,t[4]=e[4]*l+n[4]*a,t[5]=e[5]*l+n[5]*a,t[6]=e[6]*l+n[6]*a,t[7]=e[7]*l+n[7]*a,t},bn.invert=function(t,e){var n=Ml(e);return t[0]=-e[0]/n,t[1]=-e[1]/n,t[2]=-e[2]/n,t[3]=e[3]/n,t[4]=-e[4]/n,t[5]=-e[5]/n,t[6]=-e[6]/n,t[7]=e[7]/n,t},bn.conjugate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=e[7],t},bn.normalize=function(t,e){var n=Ml(e);if(n>0){n=Math.sqrt(n);var a=e[0]/n,l=e[1]/n,u=e[2]/n,d=e[3]/n,x=e[4],v=e[5],S=e[6],L=e[7],P=a*x+l*v+u*S+d*L;t[0]=a,t[1]=l,t[2]=u,t[3]=d,t[4]=(x-a*P)/n,t[5]=(v-l*P)/n,t[6]=(S-u*P)/n,t[7]=(L-d*P)/n}return t},bn.str=function(t){return"quat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+")"},bn.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]},bn.equals=function(t,e){var n=t[0],a=t[1],l=t[2],u=t[3],d=t[4],x=t[5],v=t[6],S=t[7],L=e[0],P=e[1],O=e[2],V=e[3],G=e[4],$=e[5],Y=e[6],ne=e[7];return Math.abs(n-L)<=Vr.EPSILON*Math.max(1,Math.abs(n),Math.abs(L))&&Math.abs(a-P)<=Vr.EPSILON*Math.max(1,Math.abs(a),Math.abs(P))&&Math.abs(l-O)<=Vr.EPSILON*Math.max(1,Math.abs(l),Math.abs(O))&&Math.abs(u-V)<=Vr.EPSILON*Math.max(1,Math.abs(u),Math.abs(V))&&Math.abs(d-G)<=Vr.EPSILON*Math.max(1,Math.abs(d),Math.abs(G))&&Math.abs(x-$)<=Vr.EPSILON*Math.max(1,Math.abs(x),Math.abs($))&&Math.abs(v-Y)<=Vr.EPSILON*Math.max(1,Math.abs(v),Math.abs(Y))&&Math.abs(S-ne)<=Vr.EPSILON*Math.max(1,Math.abs(S),Math.abs(ne))},bn.sqrLen=bn.squaredLength=bn.len=bn.length=bn.dot=bn.mul=bn.setReal=bn.getReal=void 0;var Vr=ss(lt),br=ss(Ue),Mn=ss(fi);function Wr(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,n=new WeakMap;return(Wr=function(a){return a?n:e})(t)}function ss(t,e){if(t&&t.__esModule)return t;if(t===null||as(t)!=="object"&&typeof t!="function")return{default:t};var n=Wr(e);if(n&&n.has(t))return n.get(t);var a={},l=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in t)if(u!=="default"&&Object.prototype.hasOwnProperty.call(t,u)){var d=l?Object.getOwnPropertyDescriptor(t,u):null;d&&(d.get||d.set)?Object.defineProperty(a,u,d):a[u]=t[u]}return a.default=t,n&&n.set(t,a),a}function Cs(t,e,n){var a=.5*n[0],l=.5*n[1],u=.5*n[2],d=e[0],x=e[1],v=e[2],S=e[3];return t[0]=d,t[1]=x,t[2]=v,t[3]=S,t[4]=a*S+l*v-u*x,t[5]=l*S+u*d-a*v,t[6]=u*S+a*x-l*d,t[7]=-a*d-l*x-u*v,t}function uo(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t}function bo(t,e,n){var a=e[0],l=e[1],u=e[2],d=e[3],x=n[4],v=n[5],S=n[6],L=n[7],P=e[4],O=e[5],V=e[6],G=e[7],$=n[0],Y=n[1],ne=n[2],Te=n[3];return t[0]=a*Te+d*$+l*ne-u*Y,t[1]=l*Te+d*Y+u*$-a*ne,t[2]=u*Te+d*ne+a*Y-l*$,t[3]=d*Te-a*$-l*Y-u*ne,t[4]=a*L+d*x+l*S-u*v+P*Te+G*$+O*ne-V*Y,t[5]=l*L+d*v+u*x-a*S+O*Te+G*Y+V*$-P*ne,t[6]=u*L+d*S+a*v-l*x+V*Te+G*ne+P*Y-O*$,t[7]=d*L-a*x-l*v-u*S+G*Te-P*$-O*Y-V*ne,t}bn.getReal=br.copy,bn.setReal=br.copy,bn.mul=bo;var wl=br.dot;bn.dot=wl;var wo=br.length;bn.length=wo,bn.len=wo;var Ml=br.squaredLength;bn.squaredLength=Ml,bn.sqrLen=Ml;var ur={};function ba(t){return ba=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ba(t)}Object.defineProperty(ur,"__esModule",{value:!0}),ur.create=Tl,ur.clone=function(t){var e=new ia.ARRAY_TYPE(2);return e[0]=t[0],e[1]=t[1],e},ur.fromValues=function(t,e){var n=new ia.ARRAY_TYPE(2);return n[0]=t,n[1]=e,n},ur.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t},ur.set=function(t,e,n){return t[0]=e,t[1]=n,t},ur.add=function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t},ur.subtract=Ba,ur.multiply=be,ur.divide=ge,ur.ceil=function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t},ur.floor=function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t},ur.min=function(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t},ur.max=function(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t},ur.round=function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t},ur.scale=function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t},ur.scaleAndAdd=function(t,e,n,a){return t[0]=e[0]+n[0]*a,t[1]=e[1]+n[1]*a,t},ur.distance=De,ur.squaredDistance=ut,ur.length=ui,ur.squaredLength=Ei,ur.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t},ur.inverse=function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t},ur.normalize=function(t,e){var n=e[0],a=e[1],l=n*n+a*a;return l>0&&(l=1/Math.sqrt(l)),t[0]=e[0]*l,t[1]=e[1]*l,t},ur.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]},ur.cross=function(t,e,n){var a=e[0]*n[1]-e[1]*n[0];return t[0]=t[1]=0,t[2]=a,t},ur.lerp=function(t,e,n,a){var l=e[0],u=e[1];return t[0]=l+a*(n[0]-l),t[1]=u+a*(n[1]-u),t},ur.random=function(t,e){e=e||1;var n=2*ia.RANDOM()*Math.PI;return t[0]=Math.cos(n)*e,t[1]=Math.sin(n)*e,t},ur.transformMat2=function(t,e,n){var a=e[0],l=e[1];return t[0]=n[0]*a+n[2]*l,t[1]=n[1]*a+n[3]*l,t},ur.transformMat2d=function(t,e,n){var a=e[0],l=e[1];return t[0]=n[0]*a+n[2]*l+n[4],t[1]=n[1]*a+n[3]*l+n[5],t},ur.transformMat3=function(t,e,n){var a=e[0],l=e[1];return t[0]=n[0]*a+n[3]*l+n[6],t[1]=n[1]*a+n[4]*l+n[7],t},ur.transformMat4=function(t,e,n){var a=e[0],l=e[1];return t[0]=n[0]*a+n[4]*l+n[12],t[1]=n[1]*a+n[5]*l+n[13],t},ur.rotate=function(t,e,n,a){var l=e[0]-n[0],u=e[1]-n[1],d=Math.sin(a),x=Math.cos(a);return t[0]=l*x-u*d+n[0],t[1]=l*d+u*x+n[1],t},ur.angle=function(t,e){var n=t[0],a=t[1],l=e[0],u=e[1],d=Math.sqrt(n*n+a*a)*Math.sqrt(l*l+u*u);return Math.acos(Math.min(Math.max(d&&(n*l+a*u)/d,-1),1))},ur.zero=function(t){return t[0]=0,t[1]=0,t},ur.str=function(t){return"vec2("+t[0]+", "+t[1]+")"},ur.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]},ur.equals=function(t,e){var n=t[0],a=t[1],l=e[0],u=e[1];return Math.abs(n-l)<=ia.EPSILON*Math.max(1,Math.abs(n),Math.abs(l))&&Math.abs(a-u)<=ia.EPSILON*Math.max(1,Math.abs(a),Math.abs(u))},ur.forEach=ur.sqrLen=ur.sqrDist=ur.dist=ur.div=ur.mul=ur.sub=ur.len=void 0;var ia=function(t,e){if(t&&t.__esModule)return t;if(t===null||ba(t)!=="object"&&typeof t!="function")return{default:t};var n=Ws(void 0);if(n&&n.has(t))return n.get(t);var a={},l=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in t)if(u!=="default"&&Object.prototype.hasOwnProperty.call(t,u)){var d=l?Object.getOwnPropertyDescriptor(t,u):null;d&&(d.get||d.set)?Object.defineProperty(a,u,d):a[u]=t[u]}return a.default=t,n&&n.set(t,a),a}(lt);function Ws(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,n=new WeakMap;return(Ws=function(a){return a?n:e})(t)}function Tl(){var t=new ia.ARRAY_TYPE(2);return ia.ARRAY_TYPE!=Float32Array&&(t[0]=0,t[1]=0),t}function Ba(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t}function be(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t}function ge(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t}function De(t,e){return Math.hypot(e[0]-t[0],e[1]-t[1])}function ut(t,e){var n=e[0]-t[0],a=e[1]-t[1];return n*n+a*a}function ui(t){return Math.hypot(t[0],t[1])}function Ei(t){var e=t[0],n=t[1];return e*e+n*n}ur.len=ui,ur.sub=Ba,ur.mul=be,ur.div=ge,ur.dist=De,ur.sqrDist=ut,ur.sqrLen=Ei;var ni=function(){var t=Tl();return function(e,n,a,l,u,d){var x,v;for(n||(n=2),a||(a=0),v=l?Math.min(l*n+a,e.length):e.length,x=a;x<v;x+=n)t[0]=e[x],t[1]=e[x+1],u(t,t,d),e[x]=t[0],e[x+1]=t[1];return e}}();function ki(t){return ki=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ki(t)}ur.forEach=ni,Object.defineProperty(Wt,"__esModule",{value:!0}),s.aA=Wt.vec4=s._=Wt.vec3=Wt.vec2=Wt.quat2=s.av=Wt.quat=s.ad=Wt.mat4=s.bC=Wt.mat3=Wt.mat2d=s.aC=Wt.mat2=Wt.glMatrix=void 0;var he=yi(lt);Wt.glMatrix=he;var le=yi(Qe);s.aC=Wt.mat2=le;var we=yi(ye);Wt.mat2d=we;var Ve=yi(ft);s.bC=Wt.mat3=Ve;var ze=yi(fi);s.ad=Wt.mat4=ze;var Bt=yi(Ue);s.av=Wt.quat=Bt;var kt=yi(bn);Wt.quat2=kt;var Di=yi(ur);Wt.vec2=Di;var cn=yi(Ye);s._=Wt.vec3=cn;var Sn=yi(Un);function Hi(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,n=new WeakMap;return(Hi=function(a){return a?n:e})(t)}function yi(t,e){if(t&&t.__esModule)return t;if(t===null||ki(t)!=="object"&&typeof t!="function")return{default:t};var n=Hi(e);if(n&&n.has(t))return n.get(t);var a={},l=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in t)if(u!=="default"&&Object.prototype.hasOwnProperty.call(t,u)){var d=l?Object.getOwnPropertyDescriptor(t,u):null;d&&(d.get||d.set)?Object.defineProperty(a,u,d):a[u]=t[u]}return a.default=t,n&&n.set(t,a),a}s.aA=Wt.vec4=Sn;var zn=Zi;function Zi(t,e,n,a){this.cx=3*t,this.bx=3*(n-t)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*e,this.by=3*(a-e)-this.cy,this.ay=1-this.cy-this.by,this.p1x=t,this.p1y=e,this.p2x=n,this.p2y=a}Zi.prototype={sampleCurveX:function(t){return((this.ax*t+this.bx)*t+this.cx)*t},sampleCurveY:function(t){return((this.ay*t+this.by)*t+this.cy)*t},sampleCurveDerivativeX:function(t){return(3*this.ax*t+2*this.bx)*t+this.cx},solveCurveX:function(t,e){if(e===void 0&&(e=1e-6),t<0)return 0;if(t>1)return 1;for(var n=t,a=0;a<8;a++){var l=this.sampleCurveX(n)-t;if(Math.abs(l)<e)return n;var u=this.sampleCurveDerivativeX(n);if(Math.abs(u)<1e-6)break;n-=l/u}var d=0,x=1;for(n=t,a=0;a<20&&(l=this.sampleCurveX(n),!(Math.abs(l-t)<e));a++)t>l?d=n:x=n,n=.5*(x-d)+d;return n},solve:function(t,e){return this.sampleCurveY(this.solveCurveX(t,e))}};var Ln=Ut(zn),Bi=Nn;function Nn(t,e){this.x=t,this.y=e}Nn.prototype={clone:function(){return new Nn(this.x,this.y)},add:function(t){return this.clone()._add(t)},sub:function(t){return this.clone()._sub(t)},multByPoint:function(t){return this.clone()._multByPoint(t)},divByPoint:function(t){return this.clone()._divByPoint(t)},mult:function(t){return this.clone()._mult(t)},div:function(t){return this.clone()._div(t)},rotate:function(t){return this.clone()._rotate(t)},rotateAround:function(t,e){return this.clone()._rotateAround(t,e)},matMult:function(t){return this.clone()._matMult(t)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(t){return this.x===t.x&&this.y===t.y},dist:function(t){return Math.sqrt(this.distSqr(t))},distSqr:function(t){var e=t.x-this.x,n=t.y-this.y;return e*e+n*n},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(t){return Math.atan2(this.y-t.y,this.x-t.x)},angleWith:function(t){return this.angleWithSep(t.x,t.y)},angleWithSep:function(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},_matMult:function(t){var e=t[2]*this.x+t[3]*this.y;return this.x=t[0]*this.x+t[1]*this.y,this.y=e,this},_add:function(t){return this.x+=t.x,this.y+=t.y,this},_sub:function(t){return this.x-=t.x,this.y-=t.y,this},_mult:function(t){return this.x*=t,this.y*=t,this},_div:function(t){return this.x/=t,this.y/=t,this},_multByPoint:function(t){return this.x*=t.x,this.y*=t.y,this},_divByPoint:function(t){return this.x/=t.x,this.y/=t.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var t=this.y;return this.y=this.x,this.x=-t,this},_rotate:function(t){var e=Math.cos(t),n=Math.sin(t),a=n*this.x+e*this.y;return this.x=e*this.x-n*this.y,this.y=a,this},_rotateAround:function(t,e){var n=Math.cos(t),a=Math.sin(t),l=e.y+a*(this.x-e.x)+n*(this.y-e.y);return this.x=e.x+n*(this.x-e.x)-a*(this.y-e.y),this.y=l,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},Nn.convert=function(t){return t instanceof Nn?t:Array.isArray(t)?new Nn(t[0],t[1]):t};var Kt=Ut(Bi);const xr=Math.PI/180,gr=180/Math.PI;function Pn(t){return t*xr}function _r(t){return t*gr}const un=[[0,0],[1,0],[1,1],[0,1]];function fs(t){if(t<=0)return 0;if(t>=1)return 1;const e=t*t,n=e*t;return 4*(t<.5?n:3*(t-e)+n-.75)}function yr(t,e,n,a){const l=new Ln(t,e,n,a);return function(u){return l.solve(u)}}const Ks=yr(.25,.1,.25,1);function pn(t,e,n){return Math.min(n,Math.max(e,t))}function Mo(t,e,n){return(n=pn((n-t)/(e-t),0,1))*n*(3-2*n)}function To(t,e,n){const a=n-e,l=((t-e)%a+a)%a+e;return l===e?n:l}function Ds(t,e,n){if(!t.length)return n(null,[]);let a=t.length;const l=new Array(t.length);let u=null;t.forEach((d,x)=>{e(d,(v,S)=>{v&&(u=v),l[x]=S,--a==0&&n(u,l)})})}function ua(t){const e=[];for(const n in t)e.push(t[n]);return e}function Ls(t,...e){for(const n of e)for(const a in n)t[a]=n[a];return t}let Do=1;function Xs(){return Do++}function Sl(){return function t(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,t)}()}function Kn(t){return t<=1?1:Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))}function Ja(t){return!!t&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(t)}function vc(t,e){t.forEach(n=>{e[n]&&(e[n]=e[n].bind(e))})}function El(t,e){return t.indexOf(e,t.length-e.length)!==-1}function qo(t,e,n){const a={};for(const l in t)a[l]=e.call(this,t[l],l,t);return a}function nh(t,e,n){const a={};for(const l in t)e.call(this,t[l],l,t)&&(a[l]=t[l]);return a}function po(t){return Array.isArray(t)?t.map(po):typeof t=="object"&&t?qo(t,po):t}const Eu={};function Is(t){Eu[t]||(typeof console<"u"&&console.warn(t),Eu[t]=!0)}function gs(t,e,n){return(n.y-t.y)*(e.x-t.x)>(e.y-t.y)*(n.x-t.x)}function Ka(t){let e=0;for(let n,a,l=0,u=t.length,d=u-1;l<u;d=l++)n=t[l],a=t[d],e+=(a.x-n.x)*(n.y+a.y);return e}function ws([t,e,n]){const a=Pn(e+90),l=Pn(n);return{x:t*Math.cos(a)*Math.sin(l),y:t*Math.sin(a)*Math.sin(l),z:t*Math.cos(l),azimuthal:e,polar:n}}function Er(){return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope}function Td(t){const e={};if(t.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(n,a,l,u)=>{const d=l||u;return e[a]=!d||d.toLowerCase(),""}),e["max-age"]){const n=parseInt(e["max-age"],10);isNaN(n)?delete e["max-age"]:e["max-age"]=n}return e}let bc,Jl,Qa,wa,da,wc,Al=null;function Au(t){try{const e=self[t];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch{return!1}}function Mc(t,e){return[t[4*e],t[4*e+1],t[4*e+2],t[4*e+3]]}function Cu(t,e,n,a){for(;e<n;){const l=e+n>>1;t[l]<a?e=l+1:n=l}return e}function rh(t,e,n,a){for(;e<n;){const l=e+n>>1;t[l]<=a?e=l+1:n=l}return e}function sh(t){return t>0?1/(1.001-t):1+t}function Kl(t){return t>0?1-1/(1.001-t):-t}function oh(){return bc==null&&(bc=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),bc}const mo={now:()=>wa!==void 0?wa:performance.now(),setNow(t){wa=t},restoreNow(){wa=void 0},frame(t){const e=requestAnimationFrame(t);return{cancel:()=>cancelAnimationFrame(e)}},getImageData(t,e=0){const{width:n,height:a}=t;da||(da=document.createElement("canvas"));const l=da.getContext("2d",{willReadFrequently:!0});if(!l)throw new Error("failed to create canvas 2d context");return(n>da.width||a>da.height)&&(da.width=n,da.height=a),l.clearRect(-e,-e,n+2*e,a+2*e),l.drawImage(t,0,0,n,a),l.getImageData(-e,-e,n+2*e,a+2*e)},resolveURL:t=>(Jl||(Jl=document.createElement("a")),Jl.href=t,Jl.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(Qa==null&&(Qa=window.matchMedia("(prefers-reduced-motion: reduce)")),Qa.matches)},hasCanvasFingerprintNoise(){if(wc!==void 0)return wc;if(!oh())return wc=!1,!1;const t=new OffscreenCanvas(85,1),e=t.getContext("2d",{willReadFrequently:!0});let n=0;for(let l=0;l<t.width;++l)e.fillStyle=`rgba(${n++},${n++},${n++}, 255)`,e.fillRect(l,0,1,1);const a=e.getImageData(0,0,t.width,t.height);n=0;for(let l=0;l<a.data.length;++l)if(l%4!=3&&n++!==a.data[l])return wc=!0,!0;return wc=!1,!1}};function Lu(t,e){const n=t.indexOf("?");if(n<0)return`${t}?${new URLSearchParams(e).toString()}`;const a=new URLSearchParams(t.slice(n));for(const l in e)a.set(l,e[l]);return`${t.slice(0,n)}?${a.toString()}`}function oo(t,e={persistentParams:[]}){const n=t.indexOf("?");if(n<0)return t;const a=new URLSearchParams,l=new URLSearchParams(t.slice(n));for(const d of e.persistentParams){const x=l.get(d);x&&a.set(d,x)}const u=a.toString();return`${t.slice(0,n)}${u.length>0?`?${u}`:""}`}const Vh="mapbox-tiles";let el=500,ah=50,$s,Iu;function tl(){try{return caches}catch{}}function Ql(){const t=tl();t&&!$s&&($s=t.open(Vh))}let go=1/0;const Cl={supported:!1,testSupport:function(t){!lh&&il&&(Pu?jf(t):Tc=t)}};let Tc,il,lh=!1,Pu=!1;const Hf=typeof self<"u"?self:{};function jf(t){const e=t.createTexture();t.bindTexture(t.TEXTURE_2D,e);try{if(t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,il),t.isContextLost())return;Cl.supported=!0}catch{}t.deleteTexture(e),lh=!0}Hf.document&&(il=Hf.document.createElement("img"),il.onload=function(){Tc&&jf(Tc),Tc=null,Pu=!0},il.onerror=function(){lh=!0,Tc=null},il.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const Ma={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(Ma);class ec extends Error{constructor(e,n,a){n===401&&oe(a)&&(e+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(e),this.status=n,this.url=a}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const Gh=Er()?()=>self.worker&&self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,tc=function(t,e){if(!(/^file:/.test(n=t.url)||/^file:/.test(Gh())&&!/^\w+:/.test(n))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(a,l){const u=new AbortController,d=new Request(a.url,{method:a.method||"GET",body:a.body,credentials:a.credentials,headers:a.headers,referrer:Gh(),referrerPolicy:a.referrerPolicy,signal:u.signal});let x=!1,v=!1;const S=(L=d.url).indexOf("sku=")>0&&oe(L);var L;a.type==="json"&&d.headers.set("Accept","application/json");const P=(V,G,$)=>{if(v)return;if(V&&V.message!=="SecurityError"&&Is(V.toString()),G&&$)return O(G);const Y=Date.now();fetch(d).then(ne=>{if(ne.ok){const Te=S?ne.clone():null;return O(ne,Te,Y)}return l(new ec(ne.statusText,ne.status,a.url))}).catch(ne=>{ne.name!=="AbortError"&&l(new Error(`${ne.message} ${a.url}`))})},O=(V,G,$)=>{(a.type==="arrayBuffer"?V.arrayBuffer():a.type==="json"?V.json():V.text()).then(Y=>{v||(G&&$&&function(ne,Te,Ae){if(Ql(),!$s)return;const Ce=Td(Te.headers.get("Cache-Control")||"");if(Ce["no-store"])return;const qe={status:Te.status,statusText:Te.statusText,headers:new Headers};Te.headers.forEach((dt,Rt)=>qe.headers.set(Rt,dt)),Ce["max-age"]&&qe.headers.set("Expires",new Date(Ae+1e3*Ce["max-age"]).toUTCString());const Ge=qe.headers.get("Expires");if(!Ge||new Date(Ge).getTime()-Ae<42e4)return;let ot=oo(ne.url,{persistentParams:["language","worldview"]});if(Te.status===206){const dt=ne.headers.get("Range");if(!dt)return;qe.status=200,ot=Lu(ot,{range:dt})}(function(dt,Rt){if(Iu===void 0)try{new Response(new ReadableStream),Iu=!0}catch{Iu=!1}Iu?Rt(dt.body):dt.blob().then(Rt)})(Te,dt=>{const Rt=new Response(($t=Te.status)!==200&&$t!==404&&[101,103,204,205,304].includes($t)?null:dt,qe);var $t;Ql(),$s&&$s.then(Vt=>Vt.put(ot,Rt)).catch(Vt=>Is(Vt.message))})}(d,G,$),x=!0,l(null,Y,V.headers.get("Cache-Control"),V.headers.get("Expires")))}).catch(Y=>{v||l(new Error(Y.message))})};return S?function(V,G){if(Ql(),!$s)return G(null);$s.then($=>{let Y=oo(V.url,{persistentParams:["language","worldview"]});const ne=V.headers.get("Range");ne&&(Y=Lu(Y,{range:ne})),$.match(Y).then(Te=>{const Ae=function(Ce){if(!Ce)return!1;const qe=new Date(Ce.headers.get("Expires")||0),Ge=Td(Ce.headers.get("Cache-Control")||"");return qe>Date.now()&&!Ge["no-cache"]}(Te);$.delete(Y),Ae&&$.put(Y,Te.clone()),G(null,Te,Ae)}).catch(G)}).catch(G)}(d,P):P(null,null),{cancel:()=>{v=!0,x||u.abort()}}}(t,e);if(Er()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",t,e,void 0,!0)}var n;return function(a,l){const u=new XMLHttpRequest;u.open(a.method||"GET",a.url,!0),a.type==="arrayBuffer"&&(u.responseType="arraybuffer");for(const d in a.headers)u.setRequestHeader(d,a.headers[d]);return a.type==="json"&&(u.responseType="text",u.setRequestHeader("Accept","application/json")),u.withCredentials=a.credentials==="include",u.onerror=()=>{l(new Error(u.statusText))},u.onload=()=>{if((u.status>=200&&u.status<300||u.status===0)&&u.response!==null){let d=u.response;if(a.type==="json")try{d=JSON.parse(u.response)}catch(x){return l(x)}l(null,d,u.getResponseHeader("Cache-Control"),u.getResponseHeader("Expires"))}else l(new ec(u.statusText,u.status,a.url))},u.send(a.body),{cancel:()=>u.abort()}}(t,e)},ic=function(t,e){return tc(Ls(t,{type:"arrayBuffer"}),e)};function Wf(t){const e=document.createElement("a");return e.href=t,e.protocol===location.protocol&&e.host===location.host}const nc="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let es,On;es=[],On=0;const Ta=function(t,e){if(Cl.supported&&(t.headers||(t.headers={}),t.headers.accept="image/webp,*/*"),On>=Q.MAX_PARALLEL_IMAGE_REQUESTS){const u={requestParameters:t,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return es.push(u),u}On++;let n=!1;const a=()=>{if(!n)for(n=!0,On--;es.length&&On<Q.MAX_PARALLEL_IMAGE_REQUESTS;){const u=es.shift(),{requestParameters:d,callback:x,cancelled:v}=u;v||(u.cancel=Ta(d,x).cancel)}},l=ic(t,(u,d,x,v)=>{a(),u?e(u):d&&(self.createImageBitmap?function(S,L){const P=new Blob([new Uint8Array(S)],{type:"image/png"});createImageBitmap(P).then(O=>{L(null,O)}).catch(O=>{L(new Error(`Could not load image because of ${O.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(d,(S,L)=>e(S,L,x,v)):function(S,L){const P=new Image;P.onload=()=>{L(null,P),URL.revokeObjectURL(P.src),P.onload=null,requestAnimationFrame(()=>{P.src=nc})},P.onerror=()=>L(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const O=new Blob([new Uint8Array(S)],{type:"image/png"});P.src=S.byteLength?URL.createObjectURL(O):nc}(d,(S,L)=>e(S,L,x,v)))});return{cancel:()=>{l.cancel(),a()}}},wp="01",Mp="NO_ACCESS_TOKEN",qf=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function nl(t){const e=t.match(qf);if(!e)throw new Error("Unable to parse URL object");return{protocol:e[1],authority:e[2],path:e[3]||"/",params:e[4]?e[4].split("&"):[]}}function ch(t){const e=t.params.length?`?${t.params.join("&")}`:"";return`${t.protocol}://${t.authority}${t.path}${e}`}const Zf="mapbox.eventData";function Hh(t){if(!t)return null;const e=t.split(".");if(!e||e.length!==3)return null;try{return JSON.parse(decodeURIComponent(atob(e[1]).split("").map(n=>"%"+("00"+n.charCodeAt(0).toString(16)).slice(-2)).join("")))}catch{return null}}class Ll{constructor(e){this.type=e,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(e){const n=Hh(Q.ACCESS_TOKEN);let a="";return a=n&&n.u?btoa(encodeURIComponent(n.u).replace(/%([0-9A-F]{2})/g,(l,u)=>String.fromCharCode(+("0x"+u)))):Q.ACCESS_TOKEN||"",e?`${Zf}.${e}:${a}`:`${Zf}:${a}`}fetchEventData(){const e=Au("localStorage"),n=this.getStorageKey(),a=this.getStorageKey("uuid");if(e)try{const l=localStorage.getItem(n);l&&(this.eventData=JSON.parse(l));const u=localStorage.getItem(a);u&&(this.anonId=u)}catch{Is("Unable to read from LocalStorage")}}saveEventData(){const e=Au("localStorage"),n=this.getStorageKey(),a=this.getStorageKey("uuid"),l=this.anonId;if(e&&l)try{localStorage.setItem(a,l),Object.keys(this.eventData).length>=1&&localStorage.setItem(n,JSON.stringify(this.eventData))}catch{Is("Unable to write to LocalStorage")}}processRequests(e){}postEvent(e,n,a,l){if(!Q.EVENTS_URL)return;const u=nl(Q.EVENTS_URL);u.params.push(`access_token=${l||Q.ACCESS_TOKEN||""}`);const d={event:this.type,created:new Date(e).toISOString()},x=n?Ls(d,n):d,v={url:ch(u),headers:{"Content-Type":"text/plain"},body:JSON.stringify([x])};this.pendingRequest=function(S,L){return tc(Ls(S,{method:"POST"}),L)}(v,S=>{this.pendingRequest=null,a(S),this.saveEventData(),this.processRequests(l)})}queueRequest(e,n){this.queue.push(e),this.processRequests(n)}}const Sa=new class extends Ll{constructor(t){super("appUserTurnstile"),this._customAccessToken=t}postTurnstileEvent(t,e){Q.EVENTS_URL&&Q.ACCESS_TOKEN&&Array.isArray(t)&&t.some(n=>ve(n)||oe(n))&&this.queueRequest(Date.now(),e)}processRequests(t){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const e=Hh(Q.ACCESS_TOKEN),n=e?e.u:Q.ACCESS_TOKEN;let a=n!==this.eventData.tokenU;Ja(this.anonId)||(this.anonId=Sl(),a=!0);const l=this.queue.shift();if(this.eventData.lastSuccess){const u=new Date(this.eventData.lastSuccess),d=new Date(l),x=(l-this.eventData.lastSuccess)/864e5;a=a||x>=1||x<-1||u.getDate()!==d.getDate()}else a=!0;a?this.postEvent(l,{sdkIdentifier:"mapbox-gl-js",sdkVersion:Z,skuId:wp,"enabled.telemetry":!1,userId:this.anonId},u=>{u||(this.eventData.lastSuccess=l,this.eventData.tokenU=n)},t):this.processRequests()}},Sd=Sa.postTurnstileEvent.bind(Sa),Ru=new class extends Ll{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(t,e,n,a){this.skuToken=e,this.errorCb=a,Q.EVENTS_URL&&(n||Q.ACCESS_TOKEN?this.queueRequest({id:t,timestamp:Date.now()},n):this.errorCb(new Error(Mp)))}processRequests(t){if(this.pendingRequest||this.queue.length===0)return;const{id:e,timestamp:n}=this.queue.shift();e&&this.success[e]||(this.anonId||this.fetchEventData(),Ja(this.anonId)||(this.anonId=Sl()),this.postEvent(n,{sdkIdentifier:"mapbox-gl-js",sdkVersion:Z,skuId:wp,skuToken:this.skuToken,userId:this.anonId},a=>{a?this.errorCb(a):e&&(this.success[e]=!0)},t))}remove(){this.errorCb=null}},Ed=Ru.postMapLoadEvent.bind(Ru),rl=new class extends Ll{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(t){let e=this.mapInstanceIdMap.get(t);return e||(e=Sl(),this.mapInstanceIdMap.set(t,e)),e}getEventId(t){const e=this.eventIdPerMapInstanceMap.get(t)||0;return this.eventIdPerMapInstanceMap.set(t,e+1),e}postStyleLoadEvent(t,e){const{map:n,style:a,importedStyles:l}=e;if(!Q.EVENTS_URL||!t&&!Q.ACCESS_TOKEN)return;const u=this.getMapInstanceId(n),d={mapInstanceId:u,eventId:this.getEventId(u),style:a};l.length&&(d.importedStyles=l),this.queueRequest({timestamp:Date.now(),payload:d},t)}processRequests(t){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:e,payload:n}=this.queue.shift();this.postEvent(e,n,()=>{},t)}},Du=rl.postStyleLoadEvent.bind(rl),jh=new class extends Ll{constructor(){super("gljs.performance")}postPerformanceEvent(t,e){Q.EVENTS_URL&&(t||Q.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:e},t)}processRequests(t){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:e,performanceData:n}=this.queue.shift(),a=function(l){const u=performance.getEntriesByType("resource"),d=performance.getEntriesByType("mark"),x=function(V){const G={};if(V){for(const $ in V)if($!=="other")for(const Y of V[$]){const ne=`${$}ResolveRangeMin`,Te=`${$}ResolveRangeMax`,Ae=`${$}RequestCount`,Ce=`${$}RequestCachedCount`;G[ne]=Math.min(G[ne]||1/0,Y.startTime),G[Te]=Math.max(G[Te]||-1/0,Y.responseEnd);const qe=Ge=>{G[Ge]===void 0&&(G[Ge]=0),++G[Ge]};Y.transferSize!==void 0&&Y.transferSize===0&&qe(Ce),qe(Ae)}}return G}(function(V,G){const $={};if(V)for(const Y of V){const ne=G(Y);$[ne]===void 0&&($[ne]=[]),$[ne].push(Y)}return $}(u,Lt)),v=window.devicePixelRatio,S=navigator.connection||navigator.mozConnection||navigator.webkitConnection,L=S?S.effectiveType:void 0,P={counters:[],metadata:[],attributes:[]},O=(V,G,$)=>{$!=null&&V.push({name:G,value:$.toString()})};for(const V in x)O(P.counters,V,x[V]);if(l.interactionRange[0]!==1/0&&l.interactionRange[1]!==-1/0&&(O(P.counters,"interactionRangeMin",l.interactionRange[0]),O(P.counters,"interactionRangeMax",l.interactionRange[1])),d)for(const V of Object.keys(He)){const G=He[V],$=d.find(Y=>Y.name===G);$&&O(P.counters,G,$.startTime)}return O(P.counters,"visibilityHidden",l.visibilityHidden),O(P.attributes,"style",function(V){if(V)for(const G of V){const $=G.name.split("?")[0];if(Re($)){const Y=$.split("/").slice(-2);if(Y.length===2)return`mapbox://styles/${Y[0]}/${Y[1]}`}}}(u)),O(P.attributes,"terrainEnabled",l.terrainEnabled?"true":"false"),O(P.attributes,"fogEnabled",l.fogEnabled?"true":"false"),O(P.attributes,"projection",l.projection),O(P.attributes,"zoom",l.zoom),O(P.metadata,"devicePixelRatio",v),O(P.metadata,"connectionEffectiveType",L),O(P.metadata,"navigatorUserAgent",navigator.userAgent),O(P.metadata,"screenWidth",window.screen.width),O(P.metadata,"screenHeight",window.screen.height),O(P.metadata,"windowWidth",window.innerWidth),O(P.metadata,"windowHeight",window.innerHeight),O(P.metadata,"mapWidth",l.width/v),O(P.metadata,"mapHeight",l.height/v),O(P.metadata,"webglRenderer",l.renderer),O(P.metadata,"webglVendor",l.vendor),O(P.metadata,"sdkVersion",Z),O(P.metadata,"sdkIdentifier","mapbox-gl-js"),P}(n);for(const l of a.metadata);for(const l of a.counters);for(const l of a.attributes);this.postEvent(e,a,()=>{},t)}},zu=jh.postPerformanceEvent.bind(jh),rc=new class extends Ll{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(t,e,n,a){if(!Q.API_URL||!Q.SESSION_PATH)return;const l=nl(Q.API_URL+Q.SESSION_PATH);l.params.push(`sku=${e||""}`),l.params.push(`access_token=${a||Q.ACCESS_TOKEN||""}`);const u={url:ch(l),headers:{"Content-Type":"text/plain"}};this.pendingRequest=function(d,x){return tc(Ls(d,{method:"GET"}),x)}(u,d=>{this.pendingRequest=null,n(d),this.saveEventData(),this.processRequests(a)})}getSessionAPI(t,e,n,a){this.skuToken=e,this.errorCb=a,Q.SESSION_PATH&&Q.API_URL&&(n||Q.ACCESS_TOKEN?this.queueRequest({id:t,timestamp:Date.now()},n):this.errorCb(new Error(Mp)))}processRequests(t){if(this.pendingRequest||this.queue.length===0)return;const{id:e,timestamp:n}=this.queue.shift();e&&this.success[e]||this.getSession(n,this.skuToken,a=>{a?this.errorCb(a):e&&(this.success[e]=!0)},t)}remove(){this.errorCb=null}},Tp=rc.getSessionAPI.bind(rc),sc=new Set;var sl={exports:{}},Wh={exports:function(t,e){var n,a,l,u,d,x,v,S;for(a=t.length-(n=3&t.length),l=e,d=3432918353,x=461845907,S=0;S<a;)v=255&t.charCodeAt(S)|(255&t.charCodeAt(++S))<<8|(255&t.charCodeAt(++S))<<16|(255&t.charCodeAt(++S))<<24,++S,l=27492+(65535&(u=5*(65535&(l=(l^=v=(65535&(v=(v=(65535&v)*d+(((v>>>16)*d&65535)<<16)&4294967295)<<15|v>>>17))*x+(((v>>>16)*x&65535)<<16)&4294967295)<<13|l>>>19))+((5*(l>>>16)&65535)<<16)&4294967295))+((58964+(u>>>16)&65535)<<16);switch(v=0,n){case 3:v^=(255&t.charCodeAt(S+2))<<16;case 2:v^=(255&t.charCodeAt(S+1))<<8;case 1:l^=v=(65535&(v=(v=(65535&(v^=255&t.charCodeAt(S)))*d+(((v>>>16)*d&65535)<<16)&4294967295)<<15|v>>>17))*x+(((v>>>16)*x&65535)<<16)&4294967295}return l^=t.length,l=2246822507*(65535&(l^=l>>>16))+((2246822507*(l>>>16)&65535)<<16)&4294967295,l=3266489909*(65535&(l^=l>>>13))+((3266489909*(l>>>16)&65535)<<16)&4294967295,(l^=l>>>16)>>>0}},Xf={exports:function(t,e){for(var n,a=t.length,l=e^a,u=0;a>=4;)n=1540483477*(65535&(n=255&t.charCodeAt(u)|(255&t.charCodeAt(++u))<<8|(255&t.charCodeAt(++u))<<16|(255&t.charCodeAt(++u))<<24))+((1540483477*(n>>>16)&65535)<<16),l=1540483477*(65535&l)+((1540483477*(l>>>16)&65535)<<16)^(n=1540483477*(65535&(n^=n>>>24))+((1540483477*(n>>>16)&65535)<<16)),a-=4,++u;switch(a){case 3:l^=(255&t.charCodeAt(u+2))<<16;case 2:l^=(255&t.charCodeAt(u+1))<<8;case 1:l=1540483477*(65535&(l^=255&t.charCodeAt(u)))+((1540483477*(l>>>16)&65535)<<16)}return l=1540483477*(65535&(l^=l>>>13))+((1540483477*(l>>>16)&65535)<<16),(l^=l>>>15)>>>0}},Ou=Wh.exports,Sp=Xf.exports;sl.exports=Ou,sl.exports.murmur3=Ou,sl.exports.murmur2=Sp;var Fu=Ut(sl.exports);class pa{constructor(e,...n){Ls(this,n[0]||{}),this.type=e}}class Na extends pa{constructor(e,n={}){super("error",Ls({error:e},n))}}function Ep(t,e,n){n[t]&&n[t].indexOf(e)!==-1||(n[t]=n[t]||[],n[t].push(e))}function Ad(t,e,n){if(n&&n[t]){const a=n[t].indexOf(e);a!==-1&&n[t].splice(a,1)}}class oc{on(e,n){return this._listeners=this._listeners||{},Ep(e,n,this._listeners),this}off(e,n){return Ad(e,n,this._listeners),Ad(e,n,this._oneTimeListeners),this}once(e,n){return n?(this._oneTimeListeners=this._oneTimeListeners||{},Ep(e,n,this._oneTimeListeners),this):new Promise(a=>this.once(e,a))}fire(e,n){const a=typeof e=="string"?new pa(e,n):e,l=a.type;if(this.listens(l)){a.target=this;const u=this._listeners&&this._listeners[l]?this._listeners[l].slice():[];for(const v of u)v.call(this,a);const d=this._oneTimeListeners&&this._oneTimeListeners[l]?this._oneTimeListeners[l].slice():[];for(const v of d)Ad(l,v,this._oneTimeListeners),v.call(this,a);const x=this._eventedParent;x&&(Ls(a,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),x.fire(a))}else a instanceof Na&&console.error(a.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,n){return this._eventedParent=e,this._eventedParentData=n,this}}s.F=void 0;var Cd={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function Ld(t){return(t=Math.round(t))<0?0:t>255?255:t}function Id(t){return Ld(t[t.length-1]==="%"?parseFloat(t)/100*255:parseInt(t))}function qh(t){return(e=t[t.length-1]==="%"?parseFloat(t)/100:parseFloat(t))<0?0:e>1?1:e;var e}function Ap(t,e,n){return n<0?n+=1:n>1&&(n-=1),6*n<1?t+(e-t)*n*6:2*n<1?e:3*n<2?t+(e-t)*(2/3-n)*6:t}try{s.F={}.parseCSSColor=function(t){var e,n=t.replace(/ /g,"").toLowerCase();if(n in Cd)return Cd[n].slice();if(n[0]==="#")return n.length===4?(e=parseInt(n.substr(1),16))>=0&&e<=4095?[(3840&e)>>4|(3840&e)>>8,240&e|(240&e)>>4,15&e|(15&e)<<4,1]:null:n.length===7&&(e=parseInt(n.substr(1),16))>=0&&e<=16777215?[(16711680&e)>>16,(65280&e)>>8,255&e,1]:null;var a=n.indexOf("("),l=n.indexOf(")");if(a!==-1&&l+1===n.length){var u=n.substr(0,a),d=n.substr(a+1,l-(a+1)).split(","),x=1;switch(u){case"rgba":if(d.length!==4)return null;x=qh(d.pop());case"rgb":return d.length!==3?null:[Id(d[0]),Id(d[1]),Id(d[2]),x];case"hsla":if(d.length!==4)return null;x=qh(d.pop());case"hsl":if(d.length!==3)return null;var v=(parseFloat(d[0])%360+360)%360/360,S=qh(d[1]),L=qh(d[2]),P=L<=.5?L*(S+1):L+S-L*S,O=2*L-P;return[Ld(255*Ap(O,P,v+1/3)),Ld(255*Ap(O,P,v)),Ld(255*Ap(O,P,v-1/3)),x];default:return null}}return null}}catch{}class Yr{constructor(e,n,a,l=1){this.r=e,this.g=n,this.b=a,this.a=l}static parse(e){if(!e)return;if(e instanceof Yr)return e;if(typeof e!="string")return;const n=s.F(e);return n?new Yr(n[0]/255*n[3],n[1]/255*n[3],n[2]/255*n[3],n[3]):void 0}toString(){const[e,n,a,l]=this.a===0?[0,0,0,0]:[255*this.r/this.a,255*this.g/this.a,255*this.b/this.a,this.a];return`rgba(${Math.round(e)},${Math.round(n)},${Math.round(a)},${l})`}toRenderColor(e){const{r:n,g:a,b:l,a:u}=this;return new dg(e,n,a,l,u)}}class dg{constructor(e,n,a,l,u){if(e){const d=e.image.height,x=d*d;n=u===0?0:n/u*(d-1),a=u===0?0:a/u*(d-1),l=u===0?0:l/u*(d-1);const v=Math.floor(n),S=Math.floor(a),L=Math.floor(l),P=Math.ceil(n),O=Math.ceil(a),V=Math.ceil(l),G=n-v,$=a-S,Y=l-L,ne=e.image.data,Te=4*(v+S*x+L*d),Ae=4*(v+S*x+V*d),Ce=4*(v+O*x+L*d),qe=4*(v+O*x+V*d),Ge=4*(P+S*x+L*d),ot=4*(P+S*x+V*d),dt=4*(P+O*x+L*d),Rt=4*(P+O*x+V*d);if(Te<0||Rt>=ne.length)throw new Error("out of range");this.r=Qn(Qn(Qn(ne[Te],ne[Ae],Y),Qn(ne[Ce],ne[qe],Y),$),Qn(Qn(ne[Ge],ne[ot],Y),Qn(ne[dt],ne[Rt],Y),$),G)/255*u,this.g=Qn(Qn(Qn(ne[Te+1],ne[Ae+1],Y),Qn(ne[Ce+1],ne[qe+1],Y),$),Qn(Qn(ne[Ge+1],ne[ot+1],Y),Qn(ne[dt+1],ne[Rt+1],Y),$),G)/255*u,this.b=Qn(Qn(Qn(ne[Te+2],ne[Ae+2],Y),Qn(ne[Ce+2],ne[qe+2],Y),$),Qn(Qn(ne[Ge+2],ne[ot+2],Y),Qn(ne[dt+2],ne[Rt+2],Y),$),G)/255*u,this.a=u}else this.r=n,this.g=a,this.b=l,this.a=u}toArray(){const{r:e,g:n,b:a,a:l}=this;return l===0?[0,0,0,0]:[255*e/l,255*n/l,255*a/l,l]}toArray01(){const{r:e,g:n,b:a,a:l}=this;return l===0?[0,0,0,0]:[e/l,n/l,a/l,l]}toArray01Scaled(e){const{r:n,g:a,b:l,a:u}=this;return u===0?[0,0,0]:[n/u*e,a/u*e,l/u*e]}toArray01PremultipliedAlpha(){const{r:e,g:n,b:a,a:l}=this;return[e,n,a,l]}toArray01Linear(){const{r:e,g:n,b:a,a:l}=this;return l===0?[0,0,0,0]:[Math.pow(e/l,2.2),Math.pow(n/l,2.2),Math.pow(a/l,2.2),l]}}function Qn(t,e,n){return t*(1-n)+e*n}function $f(t,e,n){return t.map((a,l)=>Qn(a,e[l],n))}Yr.black=new Yr(0,0,0,1),Yr.white=new Yr(1,1,1,1),Yr.transparent=new Yr(0,0,0,0),Yr.red=new Yr(1,0,0,1),Yr.blue=new Yr(0,0,1,1);var Pd=Object.freeze({__proto__:null,array:$f,color:function(t,e,n){return new Yr(Qn(t.r,e.r,n),Qn(t.g,e.g,n),Qn(t.b,e.b,n),Qn(t.a,e.a,n))},number:Qn});function ku(t,...e){for(const n of e)for(const a in n)t[a]=n[a];return t}class Ua extends Error{constructor(e,n){super(n),this.message=n,this.key=e}}class Rd{constructor(e,n=[]){this.parent=e,this.bindings={};for(const[a,l]of n)this.bindings[a]=l}concat(e){return new Rd(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const ol={kind:"null"},yn={kind:"number"},qr={kind:"string"},Nr={kind:"boolean"},Ea={kind:"color"},hh={kind:"object"},Dr={kind:"value"},Zh={kind:"collator"},na={kind:"formatted"},So={kind:"resolvedImage"};function zs(t,e){return{kind:"array",itemType:t,N:e}}function qs(t){if(t.kind==="array"){const e=qs(t.itemType);return typeof t.N=="number"?`array<${e}, ${t.N}>`:t.itemType.kind==="value"?"array":`array<${e}>`}return t.kind}const pg=[ol,yn,qr,Nr,Ea,na,hh,zs(Dr),So];function Bu(t,e){if(e.kind==="error")return null;if(t.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!Bu(t.itemType,e.itemType))&&(typeof t.N!="number"||t.N===e.N))return null}else{if(t.kind===e.kind)return null;if(t.kind==="value"){for(const n of pg)if(!Bu(n,e))return null}}return`Expected ${qs(t)} but found ${qs(e)} instead.`}function Dd(t,e){return e.some(n=>n.kind===t.kind)}function uh(t,e){return e.some(n=>n==="null"?t===null:n==="array"?Array.isArray(t):n==="object"?t&&!Array.isArray(t)&&typeof t=="object":n===typeof t)}class Xh{constructor(e,n,a){this.sensitivity=e?n?"variant":"case":n?"accent":"base",this.locale=a,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,n){return this.collator.compare(e,n)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Nu{constructor(e,n,a,l,u){this.text=e.normalize?e.normalize():e,this.image=n,this.scale=a,this.fontStack=l,this.textColor=u}}class zo{constructor(e){this.sections=e}static fromString(e){return new zo([new Nu(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(e=>e.text.length!==0||e.image&&e.image.namePrimary.length!==0)}static factory(e){return e instanceof zo?e:zo.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}serialize(){const e=["format"];for(const n of this.sections){if(n.image){e.push(["image",n.image.namePrimary]);continue}e.push(n.text);const a={};n.fontStack&&(a["text-font"]=["literal",n.fontStack.split(",")]),n.scale&&(a["font-scale"]=n.scale),n.textColor&&(a["text-color"]=["rgba"].concat(n.textColor.toRenderColor(null).toArray())),e.push(a)}return e}}class Aa{constructor(e){this.namePrimary=e.namePrimary,e.nameSecondary&&(this.nameSecondary=e.nameSecondary),this.available=e.available}toString(){return this.nameSecondary?`[${this.namePrimary},${this.nameSecondary}]`:this.namePrimary}static fromString(e,n){return e?new Aa({namePrimary:e,nameSecondary:n,available:!1}):null}serialize(){return this.nameSecondary?["image",this.namePrimary,this.nameSecondary]:["image",this.namePrimary]}}function al(t,e,n,a){return typeof t=="number"&&t>=0&&t<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof n=="number"&&n>=0&&n<=255?a===void 0||typeof a=="number"&&a>=0&&a<=1?null:`Invalid rgba value [${[t,e,n,a].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof a=="number"?[t,e,n,a]:[t,e,n]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function $h(t){if(t===null||typeof t=="string"||typeof t=="boolean"||typeof t=="number"||t instanceof Yr||t instanceof Xh||t instanceof zo||t instanceof Aa)return!0;if(Array.isArray(t)){for(const e of t)if(!$h(e))return!1;return!0}if(typeof t=="object"){for(const e in t)if(!$h(t[e]))return!1;return!0}return!1}function Qs(t){if(t===null)return ol;if(typeof t=="string")return qr;if(typeof t=="boolean")return Nr;if(typeof t=="number")return yn;if(t instanceof Yr)return Ea;if(t instanceof Xh)return Zh;if(t instanceof zo)return na;if(t instanceof Aa)return So;if(Array.isArray(t)){const e=t.length;let n;for(const a of t){const l=Qs(a);if(n){if(n===l)continue;n=Dr;break}n=l}return zs(n||Dr,e)}return hh}function ll(t){const e=typeof t;return t===null?"":e==="string"||e==="number"||e==="boolean"?String(t):t instanceof Yr||t instanceof zo||t instanceof Aa?t.toString():JSON.stringify(t)}class ac{constructor(e,n){this.type=e,this.value=n}static parse(e,n){if(e.length!==2)return n.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!$h(e[1]))return n.error("invalid value");const a=e[1];let l=Qs(a);const u=n.expectedType;return l.kind!=="array"||l.N!==0||!u||u.kind!=="array"||typeof u.N=="number"&&u.N!==0||(l=u),new ac(l,a)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Yr?["rgba"].concat(this.value.toRenderColor(null).toArray()):this.value instanceof zo?this.value.serialize():this.value}}class _o{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const Cp={string:qr,number:yn,boolean:Nr,object:hh};class cl{constructor(e,n){this.type=e,this.args=n}static parse(e,n){if(e.length<2)return n.error("Expected at least one argument.");let a,l=1;const u=e[0];if(u==="array"){let x,v;if(e.length>2){const S=e[1];if(typeof S!="string"||!(S in Cp)||S==="object")return n.error('The item type argument of "array" must be one of string, number, boolean',1);x=Cp[S],l++}else x=Dr;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return n.error('The length argument to "array" must be a positive integer literal',2);v=e[2],l++}a=zs(x,v)}else a=Cp[u];const d=[];for(;l<e.length;l++){const x=n.parse(e[l],l,Dr);if(!x)return null;d.push(x)}return new cl(a,d)}evaluate(e){for(let n=0;n<this.args.length;n++){const a=this.args[n].evaluate(e);if(!Bu(this.type,Qs(a)))return a;if(n===this.args.length-1)throw new _o(`Expected value to be of type ${qs(this.type)}, but found ${qs(Qs(a))} instead.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=this.type,n=[e.kind];if(e.kind==="array"){const a=e.itemType;if(a.kind==="string"||a.kind==="number"||a.kind==="boolean"){n.push(a.kind);const l=e.N;(typeof l=="number"||this.args.length>1)&&n.push(l)}}return n.concat(this.args.map(a=>a.serialize()))}}class Uu{constructor(e){this.type=na,this.sections=e}static parse(e,n){if(e.length<2)return n.error("Expected at least one argument.");const a=e[1];if(!Array.isArray(a)&&typeof a=="object")return n.error("First argument must be an image or text section.");const l=[];let u=!1;for(let d=1;d<=e.length-1;++d){const x=e[d];if(u&&typeof x=="object"&&!Array.isArray(x)){u=!1;let v=null;if(x["font-scale"]&&(v=n.parse(x["font-scale"],1,yn),!v))return null;let S=null;if(x["text-font"]&&(S=n.parse(x["text-font"],1,zs(qr)),!S))return null;let L=null;if(x["text-color"]&&(L=n.parse(x["text-color"],1,Ea),!L))return null;const P=l[l.length-1];P.scale=v,P.font=S,P.textColor=L}else{const v=n.parse(e[d],1,Dr);if(!v)return null;const S=v.type.kind;if(S!=="string"&&S!=="value"&&S!=="null"&&S!=="resolvedImage")return n.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");u=!0,l.push({content:v,scale:null,font:null,textColor:null})}}return new Uu(l)}evaluate(e){return new zo(this.sections.map(n=>{const a=n.content.evaluate(e);return Qs(a)===So?new Nu("",a,null,null,null):new Nu(ll(a),null,n.scale?n.scale.evaluate(e):null,n.font?n.font.evaluate(e).join(","):null,n.textColor?n.textColor.evaluate(e):null)}))}eachChild(e){for(const n of this.sections)e(n.content),n.scale&&e(n.scale),n.font&&e(n.font),n.textColor&&e(n.textColor)}outputDefined(){return!1}serialize(){const e=["format"];for(const n of this.sections){e.push(n.content.serialize());const a={};n.scale&&(a["font-scale"]=n.scale.serialize()),n.font&&(a["text-font"]=n.font.serialize()),n.textColor&&(a["text-color"]=n.textColor.serialize()),e.push(a)}return e}}class Vu{constructor(e,n){this.type=So,this.inputPrimary=e,this.inputSecondary=n}static parse(e,n){if(e.length<2)return n.error("Expected two or more arguments.");const a=n.parse(e[1],1,qr);if(!a)return n.error("No image name provided.");if(e.length===2)return new Vu(a);const l=n.parse(e[2],1,qr);return l?new Vu(a,l):n.error("Secondary image variant is not a string.")}evaluate(e){const n=Aa.fromString(this.inputPrimary.evaluate(e),this.inputSecondary?this.inputSecondary.evaluate(e):void 0);return n&&e.availableImages&&(n.available=e.availableImages.indexOf(n.namePrimary)>-1,n.nameSecondary&&n.available&&e.availableImages&&(n.available=e.availableImages.indexOf(n.nameSecondary)>-1)),n}eachChild(e){e(this.inputPrimary),this.inputSecondary&&e(this.inputSecondary)}outputDefined(){return!1}serialize(){return this.inputSecondary?["image",this.inputPrimary.serialize(),this.inputSecondary.serialize()]:["image",this.inputPrimary.serialize()]}}function dh(t){return t instanceof Number?"number":t instanceof String?"string":t instanceof Boolean?"boolean":Array.isArray(t)?"array":t===null?"null":typeof t}const Lp={"to-boolean":Nr,"to-color":Ea,"to-number":yn,"to-string":qr};class Il{constructor(e,n){this.type=e,this.args=n}static parse(e,n){if(e.length<2)return n.error("Expected at least one argument.");const a=e[0],l=[];let u=ol;if(a==="to-array"){if(!Array.isArray(e[1]))return null;const d=e[1].length;if(n.expectedType){if(n.expectedType.kind!=="array")return n.error(`Expected ${n.expectedType.kind} but found array.`);u=zs(n.expectedType.itemType,d)}else{if(!(d>0&&$h(e[1][0])))return null;u=zs(Qs(e[1][0]),d)}for(let x=0;x<d;x++){const v=e[1][x];let S;if(dh(v)==="array")S=n.parse(v,void 0,u.itemType);else{const L=dh(v);if(L!==u.itemType.kind)return n.error(`Expected ${u.itemType.kind} but found ${L}.`);S=n.registry.literal.parse(["literal",v===void 0?null:v],n)}if(!S)return null;l.push(S)}}else{if((a==="to-boolean"||a==="to-string")&&e.length!==2)return n.error("Expected one argument.");u=Lp[a];for(let d=1;d<e.length;d++){const x=n.parse(e[d],d,Dr);if(!x)return null;l.push(x)}}return new Il(u,l)}evaluate(e){if(this.type.kind==="boolean")return!!this.args[0].evaluate(e);if(this.type.kind==="color"){let n,a;for(const l of this.args){if(n=l.evaluate(e),a=null,n instanceof Yr)return n;if(typeof n=="string"){const u=e.parseColor(n);if(u)return u}else if(Array.isArray(n)&&(a=n.length<3||n.length>4?`Invalid rbga value ${JSON.stringify(n)}: expected an array containing either three or four numeric values.`:al(n[0],n[1],n[2],n[3]),!a))return new Yr(n[0]/255,n[1]/255,n[2]/255,n[3])}throw new _o(a||`Could not parse color from value '${typeof n=="string"?n:String(JSON.stringify(n))}'`)}if(this.type.kind==="number"){let n=null;for(const a of this.args){if(n=a.evaluate(e),n===null)return 0;const l=Number(n);if(!isNaN(l))return l}throw new _o(`Could not convert ${JSON.stringify(n)} to number.`)}return this.type.kind==="formatted"?zo.fromString(ll(this.args[0].evaluate(e))):this.type.kind==="resolvedImage"?Aa.fromString(ll(this.args[0].evaluate(e))):this.type.kind==="array"?this.args.map(n=>n.evaluate(e)):ll(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){if(this.type.kind==="formatted")return new Uu([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new Vu(this.args[0]).serialize();const e=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild(n=>{e.push(n.serialize())}),e}}const fg=["Unknown","Point","LineString","Polygon"];class zd{constructor(e,n){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=e,this.options=n}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?fg[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,n=this.featureDistanceData.scale,{x:a,y:l}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(a*n-e[0])+this.featureDistanceData.bearing[1]*(l*n-e[1])}return 0}parseColor(e){let n=this._parseColorCache[e];return n||(n=this._parseColorCache[e]=Yr.parse(e)),n}getConfig(e){return this.options?this.options.get(e):null}}class Zo{constructor(e,n,a,l,u){this.name=e,this.type=n,this._evaluate=a,this.args=l,this._overloadIndex=u}evaluate(e){if(!this._evaluate){const n=Zo.definitions[this.name];this._evaluate=Array.isArray(n)?n[2]:n.overloads[this._overloadIndex][1]}return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(e=>e.serialize()))}static parse(e,n){const a=e[0],l=Zo.definitions[a];if(!l)return n.error(`Unknown expression "${a}". If you wanted a literal array, use ["literal", [...]].`,0);const u=Array.isArray(l)?l[0]:l.type,d=Array.isArray(l)?[[l[1],l[2]]]:l.overloads,x=[];let v=null,S=-1;for(const[L,P]of d){if(Array.isArray(L)&&L.length!==e.length-1)continue;x.push(L),S++,v=new Pc(n.registry,n.path,null,n.scope,void 0,n._scope,n.options);const O=[];let V=!1;for(let G=1;G<e.length;G++){const $=e[G],Y=Array.isArray(L)?L[G-1]:L.type,ne=v.parse($,1+O.length,Y);if(!ne){V=!0;break}O.push(ne)}if(!V)if(Array.isArray(L)&&L.length!==O.length)v.error(`Expected ${L.length} arguments, but found ${O.length} instead.`);else{for(let G=0;G<O.length;G++){const $=Array.isArray(L)?L[G]:L.type,Y=O[G];v.concat(G+1).checkSubtype($,Y.type)}if(v.errors.length===0)return new Zo(a,u,P,O,S)}}if(x.length===1)n.errors.push(...v.errors);else{const L=(x.length?x:d.map(([O])=>O)).map(Gu).join(" | "),P=[];for(let O=1;O<e.length;O++){const V=n.parse(e[O],1+P.length);if(!V)return null;P.push(qs(V.type))}n.error(`Expected arguments of type ${L}, but found (${P.join(", ")}) instead.`)}return null}static register(e,n){Zo.definitions=n;for(const a in n)e[a]=Zo}}function Gu(t){return Array.isArray(t)?`(${t.map(qs).join(", ")})`:`(${qs(t.type)}...)`}class Hu{constructor(e,n,a){this.type=Zh,this.locale=a,this.caseSensitive=e,this.diacriticSensitive=n}static parse(e,n){if(e.length!==2)return n.error("Expected one argument.");const a=e[1];if(typeof a!="object"||Array.isArray(a))return n.error("Collator options argument must be an object.");const l=n.parse(a["case-sensitive"]!==void 0&&a["case-sensitive"],1,Nr);if(!l)return null;const u=n.parse(a["diacritic-sensitive"]!==void 0&&a["diacritic-sensitive"],1,Nr);if(!u)return null;let d=null;return a.locale&&(d=n.parse(a.locale,1,qr),!d)?null:new Hu(l,u,d)}evaluate(e){return new Xh(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){const e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}function Yf(t,e,n=0,a=t.length-1,l=mg){for(;a>n;){if(a-n>600){const v=a-n+1,S=e-n+1,L=Math.log(v),P=.5*Math.exp(2*L/3),O=.5*Math.sqrt(L*P*(v-P)/v)*(S-v/2<0?-1:1);Yf(t,e,Math.max(n,Math.floor(e-S*P/v+O)),Math.min(a,Math.floor(e+(v-S)*P/v+O)),l)}const u=t[e];let d=n,x=a;for(ju(t,n,e),l(t[a],u)>0&&ju(t,n,a);d<x;){for(ju(t,d,x),d++,x--;l(t[d],u)<0;)d++;for(;l(t[x],u)>0;)x--}l(t[n],u)===0?ju(t,n,x):(x++,ju(t,x,a)),x<=e&&(n=x+1),e<=x&&(a=x-1)}}function ju(t,e,n){const a=t[e];t[e]=t[n],t[n]=a}function mg(t,e){return t<e?-1:t>e?1:0}function Jf(t){let e=0;for(let n,a,l=0,u=t.length,d=u-1;l<u;d=l++)n=t[l],a=t[d],e+=(a.x-n.x)*(n.y+a.y);return e}function Wu(t,e){t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.max(t[2],e[0]),t[3]=Math.max(t[3],e[1])}function qu(t,e){return!(t[0]<=e[0]||t[2]>=e[2]||t[1]<=e[1]||t[3]>=e[3])}function Kf(t,e,n){const a=t[0]-e[0],l=t[1]-e[1],u=t[0]-n[0],d=t[1]-n[1];return a*d-u*l==0&&a*u<=0&&l*d<=0}function kr(t,e,n=!1){let a=!1;for(let x=0,v=e.length;x<v;x++){const S=e[x];for(let L=0,P=S.length,O=P-1;L<P;O=L++){const V=S[O],G=S[L];if(Kf(t,V,G))return n;(u=V)[1]>(l=t)[1]!=(d=G)[1]>l[1]&&l[0]<(d[0]-u[0])*(l[1]-u[1])/(d[1]-u[1])+u[0]&&(a=!a)}}var l,u,d;return a}function Ip(t,e,n,a){const l=a[0]-n[0],u=a[1]-n[1],d=(t[0]-n[0])*u-l*(t[1]-n[1]),x=(e[0]-n[0])*u-l*(e[1]-n[1]);return d>0&&x<0||d<0&&x>0}function Zu(t,e,n,a){return(l=[a[0]-n[0],a[1]-n[1]])[0]*(u=[e[0]-t[0],e[1]-t[1]])[1]-l[1]*u[0]!=0&&!(!Ip(t,e,n,a)||!Ip(n,a,t,e));var l,u}const Sc=8192;function Qf(t,e){const n=(180+t[0])/360,a=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+t[1]*Math.PI/360)))/360,l=Math.pow(2,e.z);return[Math.round(n*l*Sc),Math.round(a*l*Sc)]}function Xu(t,e){for(let n=0;n<e.length;n++)if(kr(t,e[n]))return!0;return!1}function Yh(t,e,n){for(const a of n)for(let l=0,u=a.length,d=u-1;l<u;d=l++)if(Zu(t,e,a[d],a[l]))return!0;return!1}function Jh(t,e){for(let n=0;n<t.length;++n)if(!kr(t[n],e))return!1;for(let n=0;n<t.length-1;++n)if(Yh(t[n],t[n+1],e))return!1;return!0}function gg(t,e){for(let n=0;n<e.length;n++)if(Jh(t,e[n]))return!0;return!1}function hl(t,e,n){const a=[];for(let l=0;l<t.length;l++){const u=[];for(let d=0;d<t[l].length;d++){const x=Qf(t[l][d],n);Wu(e,x),u.push(x)}a.push(u)}return a}function Va(t,e,n){const a=[];for(let l=0;l<t.length;l++){const u=hl(t[l],e,n);a.push(u)}return a}function em(t,e,n,a){if(t[0]<n[0]||t[0]>n[2]){const l=.5*a;let u=t[0]-n[0]>l?-a:n[0]-t[0]>l?a:0;u===0&&(u=t[0]-n[2]>l?-a:n[2]-t[0]>l?a:0),t[0]+=u}Wu(e,t)}function Od(t,e,n,a){const l=Math.pow(2,a.z)*Sc,u=[a.x*Sc,a.y*Sc],d=[];if(!t)return d;for(const x of t)for(const v of x){const S=[v.x+u[0],v.y+u[1]];em(S,e,n,l),d.push(S)}return d}function ph(t,e,n,a){const l=Math.pow(2,a.z)*Sc,u=[a.x*Sc,a.y*Sc],d=[];if(!t)return d;for(const v of t){const S=[];for(const L of v){const P=[L.x+u[0],L.y+u[1]];Wu(e,P),S.push(P)}d.push(S)}if(e[2]-e[0]<=l/2){(x=e)[0]=x[1]=1/0,x[2]=x[3]=-1/0;for(const v of d)for(const S of v)em(S,e,n,l)}var x;return d}class fa{constructor(e,n){this.type=Nr,this.geojson=e,this.geometries=n}static parse(e,n){if(e.length!==2)return n.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if($h(e[1])){const a=e[1];if(a.type==="FeatureCollection")for(let l=0;l<a.features.length;++l){const u=a.features[l].geometry.type;if(u==="Polygon"||u==="MultiPolygon")return new fa(a,a.features[l].geometry)}else if(a.type==="Feature"){const l=a.geometry.type;if(l==="Polygon"||l==="MultiPolygon")return new fa(a,a.geometry)}else if(a.type==="Polygon"||a.type==="MultiPolygon")return new fa(a,a)}return n.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return function(n,a){const l=[1/0,1/0,-1/0,-1/0],u=[1/0,1/0,-1/0,-1/0],d=n.canonicalID();if(!d)return!1;if(a.type==="Polygon"){const x=hl(a.coordinates,u,d),v=Od(n.geometry(),l,u,d);if(!qu(l,u))return!1;for(const S of v)if(!kr(S,x))return!1}if(a.type==="MultiPolygon"){const x=Va(a.coordinates,u,d),v=Od(n.geometry(),l,u,d);if(!qu(l,u))return!1;for(const S of v)if(!Xu(S,x))return!1}return!0}(e,this.geometries);if(e.geometryType()==="LineString")return function(n,a){const l=[1/0,1/0,-1/0,-1/0],u=[1/0,1/0,-1/0,-1/0],d=n.canonicalID();if(!d)return!1;if(a.type==="Polygon"){const x=hl(a.coordinates,u,d),v=ph(n.geometry(),l,u,d);if(!qu(l,u))return!1;for(const S of v)if(!Jh(S,x))return!1}if(a.type==="MultiPolygon"){const x=Va(a.coordinates,u,d),v=ph(n.geometry(),l,u,d);if(!qu(l,u))return!1;for(const S of v)if(!gg(S,x))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const Fd={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},tm=1/298.257223563,Kh=tm*(2-tm),fh=Math.PI/180;class Ec{static fromTile(e,n,a){const l=Math.PI*(1-2*(e+.5)/Math.pow(2,n)),u=Math.atan(.5*(Math.exp(l)-Math.exp(-l)))/fh;return new Ec(u,a)}static get units(){return Fd}constructor(e,n){if(e===void 0)throw new Error("No latitude given.");if(n&&!Fd[n])throw new Error(`Unknown unit ${n}. Use one of: ${Object.keys(Fd).join(", ")}`);const a=6378.137*fh*(n?Fd[n]:1),l=Math.cos(e*fh),u=1/(1-Kh*(1-l*l)),d=Math.sqrt(u);this.kx=a*d*l,this.ky=a*d*u*(1-Kh)}distance(e,n){const a=Ga(e[0]-n[0])*this.kx,l=(e[1]-n[1])*this.ky;return Math.sqrt(a*a+l*l)}bearing(e,n){const a=Ga(n[0]-e[0])*this.kx;return Math.atan2(a,(n[1]-e[1])*this.ky)/fh}destination(e,n,a){const l=a*fh;return this.offset(e,Math.sin(l)*n,Math.cos(l)*n)}offset(e,n,a){return[e[0]+n/this.kx,e[1]+a/this.ky]}lineDistance(e){let n=0;for(let a=0;a<e.length-1;a++)n+=this.distance(e[a],e[a+1]);return n}area(e){let n=0;for(let a=0;a<e.length;a++){const l=e[a];for(let u=0,d=l.length,x=d-1;u<d;x=u++)n+=Ga(l[u][0]-l[x][0])*(l[u][1]+l[x][1])*(a?-1:1)}return Math.abs(n)/2*this.kx*this.ky}along(e,n){let a=0;if(n<=0)return e[0];for(let l=0;l<e.length-1;l++){const u=e[l],d=e[l+1],x=this.distance(u,d);if(a+=x,a>n)return Ac(u,d,(n-(a-x))/x)}return e[e.length-1]}pointToSegmentDistance(e,n,a){let[l,u]=n,d=Ga(a[0]-l)*this.kx,x=(a[1]-u)*this.ky;if(d!==0||x!==0){const v=(Ga(e[0]-l)*this.kx*d+(e[1]-u)*this.ky*x)/(d*d+x*x);v>1?(l=a[0],u=a[1]):v>0&&(l+=d/this.kx*v,u+=x/this.ky*v)}return d=Ga(e[0]-l)*this.kx,x=(e[1]-u)*this.ky,Math.sqrt(d*d+x*x)}pointOnLine(e,n){let a=1/0,l=e[0][0],u=e[0][1],d=0,x=0;for(let v=0;v<e.length-1;v++){let S=e[v][0],L=e[v][1],P=Ga(e[v+1][0]-S)*this.kx,O=(e[v+1][1]-L)*this.ky,V=0;P===0&&O===0||(V=(Ga(n[0]-S)*this.kx*P+(n[1]-L)*this.ky*O)/(P*P+O*O),V>1?(S=e[v+1][0],L=e[v+1][1]):V>0&&(S+=P/this.kx*V,L+=O/this.ky*V)),P=Ga(n[0]-S)*this.kx,O=(n[1]-L)*this.ky;const G=P*P+O*O;G<a&&(a=G,l=S,u=L,d=v,x=V)}return{point:[l,u],index:d,t:Math.max(0,Math.min(1,x))}}lineSlice(e,n,a){let l=this.pointOnLine(a,e),u=this.pointOnLine(a,n);if(l.index>u.index||l.index===u.index&&l.t>u.t){const S=l;l=u,u=S}const d=[l.point],x=l.index+1,v=u.index;!im(a[x],d[0])&&x<=v&&d.push(a[x]);for(let S=x+1;S<=v;S++)d.push(a[S]);return im(a[v],u.point)||d.push(u.point),d}lineSliceAlong(e,n,a){let l=0;const u=[];for(let d=0;d<a.length-1;d++){const x=a[d],v=a[d+1],S=this.distance(x,v);if(l+=S,l>e&&u.length===0&&u.push(Ac(x,v,(e-(l-S))/S)),l>=n)return u.push(Ac(x,v,(n-(l-S))/S)),u;l>e&&u.push(v)}return u}bufferPoint(e,n){const a=n/this.ky,l=n/this.kx;return[e[0]-l,e[1]-a,e[0]+l,e[1]+a]}bufferBBox(e,n){const a=n/this.ky,l=n/this.kx;return[e[0]-l,e[1]-a,e[2]+l,e[3]+a]}insideBBox(e,n){return Ga(e[0]-n[0])>=0&&Ga(e[0]-n[2])<=0&&e[1]>=n[1]&&e[1]<=n[3]}}function im(t,e){return t[0]===e[0]&&t[1]===e[1]}function Ac(t,e,n){const a=Ga(e[0]-t[0]);return[t[0]+a*n,t[1]+(e[1]-t[1])*n]}function Ga(t){for(;t<-180;)t+=360;for(;t>180;)t-=360;return t}class Pp{constructor(e=[],n=(a,l)=>a<l?-1:a>l?1:0){if(this.data=e,this.length=this.data.length,this.compare=n,this.length>0)for(let a=(this.length>>1)-1;a>=0;a--)this._down(a)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(this.length===0)return;const e=this.data[0],n=this.data.pop();return--this.length>0&&(this.data[0]=n,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:n,compare:a}=this,l=n[e];for(;e>0;){const u=e-1>>1,d=n[u];if(a(l,d)>=0)break;n[e]=d,e=u}n[e]=l}_down(e){const{data:n,compare:a}=this,l=this.length>>1,u=n[e];for(;e<l;){let d=1+(e<<1);const x=d+1;if(x<this.length&&a(n[x],n[d])<0&&(d=x),a(n[d],u)>=0)break;n[e]=n[d],e=d}n[e]=u}}var ji=8192;function Rp(t,e){return e.dist-t.dist}const Dp=100,kd=50;function zp(t){const e=[1/0,1/0,-1/0,-1/0];if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}function $u(t){return t[1]-t[0]+1}function ma(t,e){const n=t[1]>=t[0]&&t[1]<e;return n||console.warn("Distance Expression: Index is out of range"),n}function Op(t,e){if(t[0]>t[1])return[null,null];const n=$u(t);if(e){if(n===2)return[t,null];const a=Math.floor(n/2);return[[t[0],t[0]+a],[t[0]+a,t[1]]]}{if(n===1)return[t,null];const a=Math.floor(n/2)-1;return[[t[0],t[0]+a],[t[0]+a+1,t[1]]]}}function mh(t,e){const n=[1/0,1/0,-1/0,-1/0];if(!ma(e,t.length))return n;for(let a=e[0];a<=e[1];++a)Wu(n,t[a]);return n}function gh(t){const e=[1/0,1/0,-1/0,-1/0];for(let n=0;n<t.length;++n)for(let a=0;a<t[n].length;++a)Wu(e,t[n][a]);return e}function _h(t,e,n){if(zp(t)||zp(e))return NaN;let a=0,l=0;return t[2]<e[0]&&(a=e[0]-t[2]),t[0]>e[2]&&(a=t[0]-e[2]),t[1]>e[3]&&(l=t[1]-e[3]),t[3]<e[1]&&(l=e[1]-t[3]),n.distance([0,0],[a,l])}function _g(t){return 360*t-180}function yg(t){return 360/Math.PI*Math.atan(Math.exp((180-360*t)*Math.PI/180))-90}function Fp(t,e){const n=Math.pow(2,e.z),a=(t.y/ji+e.y)/n;return[_g((t.x/ji+e.x)/n),yg(a)]}function xg(t,e){const n=[];for(let a=0;a<t.length;++a)n.push(Fp(t[a],e));return n}function Cc(t,e,n){const a=n.pointOnLine(e,t).point;return n.distance(t,a)}function kp(t,e,n,a,l){const u=n.slice(a[0],a[1]+1);let d=1/0;for(let x=e[0];x<=e[1];++x)if((d=Math.min(d,Cc(t[x],u,l)))===0)return 0;return d}function Bp(t,e,n,a,l){const u=Math.min(l.pointToSegmentDistance(t,n,a),l.pointToSegmentDistance(e,n,a)),d=Math.min(l.pointToSegmentDistance(n,t,e),l.pointToSegmentDistance(a,t,e));return Math.min(u,d)}function Yu(t,e,n,a,l){if(!ma(e,t.length)||!ma(a,n.length))return NaN;let u=1/0;for(let d=e[0];d<e[1];++d)for(let x=a[0];x<a[1];++x){if(Zu(t[d],t[d+1],n[x],n[x+1]))return 0;u=Math.min(u,Bp(t[d],t[d+1],n[x],n[x+1],l))}return u}function Ju(t,e,n,a,l){if(!ma(e,t.length)||!ma(a,n.length))return NaN;let u=1/0;for(let d=e[0];d<=e[1];++d)for(let x=a[0];x<=a[1];++x)if((u=Math.min(u,l.distance(t[d],n[x])))===0)return u;return u}function Ha(t,e,n){if(kr(t,e,!0))return 0;let a=1/0;for(const l of e){const u=l.length;if(u<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(l[0]!==l[u-1]&&(a=Math.min(a,n.pointToSegmentDistance(t,l[u-1],l[0])))===0||(a=Math.min(a,Cc(t,l,n)))===0)return a}return a}function nm(t,e,n,a){if(!ma(e,t.length))return NaN;for(let u=e[0];u<=e[1];++u)if(kr(t[u],n,!0))return 0;let l=1/0;for(let u=e[0];u<e[1];++u)for(const d of n)for(let x=0,v=d.length,S=v-1;x<v;S=x++){if(Zu(t[u],t[u+1],d[S],d[x]))return 0;l=Math.min(l,Bp(t[u],t[u+1],d[S],d[x],a))}return l}function rm(t,e){for(const n of t)for(let a=0;a<=n.length-1;++a)if(kr(n[a],e,!0))return!0;return!1}function Np(t,e,n,a=1/0){const l=gh(t),u=gh(e);if(a!==1/0&&_h(l,u,n)>=a)return a;if(qu(l,u)){if(rm(t,e))return 0}else if(rm(e,t))return 0;let d=a;for(const x of t)for(let v=0,S=x.length,L=S-1;v<S;L=v++)for(const P of e)for(let O=0,V=P.length,G=V-1;O<V;G=O++){if(Zu(x[L],x[v],P[G],P[O]))return 0;d=Math.min(d,Bp(x[L],x[v],P[G],P[O],n))}return d}function lc(t,e,n,a,l,u,d){if(u===null||d===null)return;const x=_h(mh(a,u),mh(l,d),n);x<e&&t.push({dist:x,range1:u,range2:d})}function yh(t,e,n,a,l=1/0){let u=Math.min(a.distance(t[0],n[0][0]),l);if(u===0)return u;const d=new Pp([{dist:0,range1:[0,t.length-1],range2:[0,0]}],Rp),x=e?kd:Dp,v=gh(n);for(;d.length;){const S=d.pop();if(S.dist>=u)continue;const L=S.range1;if($u(L)<=x){if(!ma(L,t.length))return NaN;if(e){const P=nm(t,L,n,a);if((u=Math.min(u,P))===0)return u}else for(let P=L[0];P<=L[1];++P){const O=Ha(t[P],n,a);if((u=Math.min(u,O))===0)return u}}else{const P=Op(L,e);if(P[0]!==null){const O=_h(mh(t,P[0]),v,a);O<u&&d.push({dist:O,range1:P[0],range2:[0,0]})}if(P[1]!==null){const O=_h(mh(t,P[1]),v,a);O<u&&d.push({dist:O,range1:P[1],range2:[0,0]})}}}return u}function sm(t,e,n,a,l,u=1/0){let d=Math.min(u,l.distance(t[0],n[0]));if(d===0)return d;const x=new Pp([{dist:0,range1:[0,t.length-1],range2:[0,n.length-1]}],Rp),v=e?kd:Dp,S=a?kd:Dp;for(;x.length;){const L=x.pop();if(L.dist>=d)continue;const P=L.range1,O=L.range2;if($u(P)<=v&&$u(O)<=S){if(!ma(P,t.length)||!ma(O,n.length))return NaN;if(e&&a?d=Math.min(d,Yu(t,P,n,O,l)):e||a?e&&!a?d=Math.min(d,kp(n,O,t,P,l)):!e&&a&&(d=Math.min(d,kp(t,P,n,O,l))):d=Math.min(d,Ju(t,P,n,O,l)),d===0)return d}else{const V=Op(P,e),G=Op(O,a);lc(x,d,l,t,n,V[0],G[0]),lc(x,d,l,t,n,V[0],G[1]),lc(x,d,l,t,n,V[1],G[0]),lc(x,d,l,t,n,V[1],G[1])}}return d}function Ku(t,e,n,a,l=1/0){let u=l;const d=mh(t,[0,t.length-1]);for(const x of n)if(!(u!==1/0&&_h(d,mh(x,[0,x.length-1]),a)>=u)&&(u=Math.min(u,sm(t,e,x,!0,a,u)),u===0))return u;return u}function Bd(t,e,n,a,l=1/0){let u=l;const d=mh(t,[0,t.length-1]);for(const x of n){if(u!==1/0&&_h(d,gh(x),a)>=u)continue;const v=yh(t,e,x,a,u);if(isNaN(v))return v;if((u=Math.min(u,v))===0)return u}return u}function Up(t){return t==="Point"||t==="MultiPoint"||t==="LineString"||t==="MultiLineString"||t==="Polygon"||t==="MultiPolygon"}class cs{constructor(e,n){this.type=yn,this.geojson=e,this.geometries=n}static parse(e,n){if(e.length!==2)return n.error(`'distance' expression requires either one argument, but found ' ${e.length-1} instead.`);if($h(e[1])){const a=e[1];if(a.type==="FeatureCollection"){for(let l=0;l<a.features.length;++l)if(Up(a.features[l].geometry.type))return new cs(a,a.features[l].geometry)}else if(a.type==="Feature"){if(Up(a.geometry.type))return new cs(a,a.geometry)}else if(Up(a.type))return new cs(a,a)}return n.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(e){const n=e.geometry(),a=e.canonicalID();if(n!=null&&a!=null){if(e.geometryType()==="Point")return function(l,u,d){const x=[];for(const S of l)for(const L of S)x.push(Fp(L,u));const v=new Ec(x[0][1],"meters");return d.type==="Point"||d.type==="MultiPoint"||d.type==="LineString"?sm(x,!1,d.type==="Point"?[d.coordinates]:d.coordinates,d.type==="LineString",v):d.type==="MultiLineString"?Ku(x,!1,d.coordinates,v):d.type==="Polygon"||d.type==="MultiPolygon"?Bd(x,!1,d.type==="Polygon"?[d.coordinates]:d.coordinates,v):null}(n,a,this.geometries);if(e.geometryType()==="LineString")return function(l,u,d){const x=[];for(const S of l){const L=[];for(const P of S)L.push(Fp(P,u));x.push(L)}const v=new Ec(x[0][0][1],"meters");if(d.type==="Point"||d.type==="MultiPoint"||d.type==="LineString")return Ku(d.type==="Point"?[d.coordinates]:d.coordinates,d.type==="LineString",x,v);if(d.type==="MultiLineString"){let S=1/0;for(let L=0;L<d.coordinates.length;L++){const P=Ku(d.coordinates[L],!0,x,v,S);if(isNaN(P))return P;if((S=Math.min(S,P))===0)return S}return S}if(d.type==="Polygon"||d.type==="MultiPolygon"){let S=1/0;for(let L=0;L<x.length;L++){const P=Bd(x[L],!0,d.type==="Polygon"?[d.coordinates]:d.coordinates,v,S);if(isNaN(P))return P;if((S=Math.min(S,P))===0)return S}return S}return null}(n,a,this.geometries);if(e.geometryType()==="Polygon")return function(l,u,d){const x=[];for(const S of function(L,P){const O=L.length;if(O<=1)return[L];const V=[];let G,$;for(let Y=0;Y<O;Y++){const ne=Jf(L[Y]);ne!==0&&(L[Y].area=Math.abs(ne),$===void 0&&($=ne<0),$===ne<0?(G&&V.push(G),G=[L[Y]]):G.push(L[Y]))}return G&&V.push(G),V}(l)){const L=[];for(let P=0;P<S.length;++P)L.push(xg(S[P],u));x.push(L)}const v=new Ec(x[0][0][0][1],"meters");if(d.type==="Point"||d.type==="MultiPoint"||d.type==="LineString")return Bd(d.type==="Point"?[d.coordinates]:d.coordinates,d.type==="LineString",x,v);if(d.type==="MultiLineString"){let S=1/0;for(let L=0;L<d.coordinates.length;L++){const P=Bd(d.coordinates[L],!0,x,v,S);if(isNaN(P))return P;if((S=Math.min(S,P))===0)return S}return S}return d.type==="Polygon"||d.type==="MultiPolygon"?function(S,L,P){let O=1/0;for(const V of S)for(const G of L){const $=Np(V,G,P,O);if(isNaN($))return $;if((O=Math.min(O,$))===0)return O}return O}(d.type==="Polygon"?[d.coordinates]:d.coordinates,x,v):null}(n,a,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function xh(t,e){switch(t){case"string":return ll(e);case"number":return+e;case"boolean":return!!e;case"color":return Yr.parse(e);case"formatted":return zo.fromString(ll(e));case"resolvedImage":return Aa.fromString(ll(e))}return e}function Oo(t,e,n,a){return a!==void 0&&(t=a*Math.round(t/a)),e!==void 0&&t<e&&(t=e),n!==void 0&&t>n&&(t=n),t}class Ca{constructor(e,n,a){this.type=e,this.key=n,this.scope=a}static parse(e,n){let a=n.expectedType;if(a==null&&(a=Dr),e.length<2||e.length>3)return n.error("Invalid number of arguments for 'config' expression.");const l=n.parse(e[1],1);if(!(l instanceof ac))return n.error("Key name of 'config' expression must be a string literal.");if(e.length>=3){const u=n.parse(e[2],2);return u instanceof ac?new Ca(a,ll(l.value),ll(u.value)):n.error("Scope of 'config' expression must be a string literal.")}return new Ca(a,ll(l.value))}evaluate(e){const n=[this.key,this.scope,e.scope].filter(Boolean).join(""),a=e.getConfig(n);if(!a)return null;const{type:l,value:u,values:d,minValue:x,maxValue:v,stepValue:S}=a,L=a.default.evaluate(e);let P=L;if(u){const O=e.scope;e.scope=(O||"").split("").slice(1).join(""),P=u.evaluate(e),e.scope=O}return l&&(P=xh(l,P)),P===void 0||x===void 0&&v===void 0&&S===void 0||(typeof P=="number"?P=Oo(P,x,v,S):Array.isArray(P)&&(P=P.map(O=>typeof O=="number"?Oo(O,x,v,S):O))),u!==void 0&&P!==void 0&&d&&!d.includes(P)&&(P=L,l&&(P=xh(l,P))),(l&&l!==this.type||P!==void 0&&Qs(P)!==this.type)&&(P=xh(this.type.kind,P)),P}eachChild(){}outputDefined(){return!1}serialize(){const e=["config",this.key];return this.scope&&e.concat(this.key),e}}function Lc(t){if(t instanceof Zo&&(t.name==="get"&&t.args.length===1||t.name==="feature-state"||t.name==="has"&&t.args.length===1||t.name==="properties"||t.name==="geometry-type"||t.name==="id"||/^filter-/.test(t.name))||t instanceof fa||t instanceof cs)return!1;let e=!0;return t.eachChild(n=>{e&&!Lc(n)&&(e=!1)}),e}function Pl(t){if(t instanceof Zo&&t.name==="feature-state")return!1;let e=!0;return t.eachChild(n=>{e&&!Pl(n)&&(e=!1)}),e}function eo(t){if(t instanceof Ca)return!1;let e=!0;return t.eachChild(n=>{e&&!eo(n)&&(e=!1)}),e}function ja(t,e){if(t instanceof Zo&&e.indexOf(t.name)>=0)return!1;let n=!0;return t.eachChild(a=>{n&&!ja(a,e)&&(n=!1)}),n}class cc{constructor(e,n){this.type=n.type,this.name=e,this.boundExpression=n}static parse(e,n){if(e.length!==2||typeof e[1]!="string")return n.error("'var' expression requires exactly one string literal argument.");const a=e[1];return n.scope.has(a)?new cc(a,n.scope.get(a)):n.error(`Unknown variable "${a}". Make sure "${a}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Ic{constructor(e,n=[],a,l=new Rd,u=[],d,x){this.registry=e,this.path=n,this.key=n.map(v=>`[${v}]`).join(""),this.scope=l,this.errors=u,this.expectedType=a,this._scope=d,this.options=x}parse(e,n,a,l,u={}){return n||a?this.concat(n,a,l)._parse(e,u):this._parse(e,u)}_parse(e,n){function a(l,u,d){return d==="assert"?new cl(u,[l]):d==="coerce"?new Il(u,[l]):l}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const l=typeof e[0]=="string"?this.registry[e[0]]:void 0;if(l){let u=l.parse(e,this);if(!u)return null;if(this.expectedType){const d=this.expectedType,x=u.type;if(d.kind!=="string"&&d.kind!=="number"&&d.kind!=="boolean"&&d.kind!=="object"&&d.kind!=="array"||x.kind!=="value")if(d.kind!=="color"&&d.kind!=="formatted"&&d.kind!=="resolvedImage"||x.kind!=="value"&&x.kind!=="string"){if(this.checkSubtype(d,x))return null}else u=a(u,d,n.typeAnnotation||"coerce");else u=a(u,d,n.typeAnnotation||"assert")}if(!(u instanceof ac)&&u.type.kind!=="resolvedImage"&&Rc(u)){const d=new zd(this._scope,this.options);try{u=new ac(u.type,u.evaluate(d))}catch(x){return this.error(x.message),null}}return u}return Il.parse(["to-array",e],this)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,n,a){const l=typeof e=="number"?this.path.concat(e):this.path,u=a?this.scope.concat(a):this.scope;return new Ic(this.registry,l,n||null,u,this.errors,this._scope,this.options)}error(e,...n){const a=`${this.key}${n.map(l=>`[${l}]`).join("")}`;this.errors.push(new Ua(a,e))}checkSubtype(e,n){const a=Bu(e,n);return a&&this.error(a),a}}var Pc=Ic;function Rc(t){if(t instanceof cc)return Rc(t.boundExpression);if(t instanceof Zo&&t.name==="error"||t instanceof Hu||t instanceof fa||t instanceof cs||t instanceof Ca)return!1;const e=t instanceof Il||t instanceof cl;let n=!0;return t.eachChild(a=>{n=e?n&&Rc(a):n&&a instanceof ac}),!!n&&Lc(t)&&ja(t,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function hc(t,e){const n=t.length-1;let a,l,u=0,d=n,x=0;for(;u<=d;)if(x=Math.floor((u+d)/2),a=t[x],l=t[x+1],a<=e){if(x===n||e<l)return x;u=x+1}else{if(!(a>e))throw new _o("Input is not a number.");d=x-1}return 0}class Wa{constructor(e,n,a){this.type=e,this.input=n,this.labels=[],this.outputs=[];for(const[l,u]of a)this.labels.push(l),this.outputs.push(u)}static parse(e,n){if(e.length-1<4)return n.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return n.error("Expected an even number of arguments.");const a=n.parse(e[1],1,yn);if(!a)return null;const l=[];let u=null;n.expectedType&&n.expectedType.kind!=="value"&&(u=n.expectedType);for(let d=1;d<e.length;d+=2){const x=d===1?-1/0:e[d],v=e[d+1],S=d,L=d+1;if(typeof x!="number")return n.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',S);if(l.length&&l[l.length-1][0]>=x)return n.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',S);const P=n.parse(v,L,u);if(!P)return null;u=u||P.type,l.push([x,P])}return new Wa(u,a,l)}evaluate(e){const n=this.labels,a=this.outputs;if(n.length===1)return a[0].evaluate(e);const l=this.input.evaluate(e);if(l<=n[0])return a[0].evaluate(e);const u=n.length;return l>=n[u-1]?a[u-1].evaluate(e):a[hc(n,l)].evaluate(e)}eachChild(e){e(this.input);for(const n of this.outputs)e(n)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){const e=["step",this.input.serialize()];for(let n=0;n<this.labels.length;n++)n>0&&e.push(this.labels[n]),e.push(this.outputs[n].serialize());return e}}const Qh=.95047,Nd=1.08883,eu=4/29,Rl=6/29,vh=3*Rl*Rl,Qu=Rl*Rl*Rl,Ud=Math.PI/180,om=180/Math.PI;function bh(t){return t>Qu?Math.pow(t,1/3):t/vh+eu}function tu(t){return t>Rl?t*t*t:vh*(t-eu)}function Dc(t){return 255*(t<=.0031308?12.92*t:1.055*Math.pow(t,1/2.4)-.055)}function Vd(t){return(t/=255)<=.04045?t/12.92:Math.pow((t+.055)/1.055,2.4)}function Vp(t){const e=Vd(t.r),n=Vd(t.g),a=Vd(t.b),l=bh((.4124564*e+.3575761*n+.1804375*a)/Qh),u=bh((.2126729*e+.7151522*n+.072175*a)/1);return{l:116*u-16,a:500*(l-u),b:200*(u-bh((.0193339*e+.119192*n+.9503041*a)/Nd)),alpha:t.a}}function Gp(t){let e=(t.l+16)/116,n=isNaN(t.a)?e:e+t.a/500,a=isNaN(t.b)?e:e-t.b/200;return e=1*tu(e),n=Qh*tu(n),a=Nd*tu(a),new Yr(Dc(3.2404542*n-1.5371385*e-.4985314*a),Dc(-.969266*n+1.8760108*e+.041556*a),Dc(.0556434*n-.2040259*e+1.0572252*a),t.alpha)}function am(t,e,n){const a=e-t;return t+n*(a>180||a<-180?a-360*Math.round(a/360):a)}const wh={forward:Vp,reverse:Gp,interpolate:function(t,e,n){return{l:Qn(t.l,e.l,n),a:Qn(t.a,e.a,n),b:Qn(t.b,e.b,n),alpha:Qn(t.alpha,e.alpha,n)}}},ed={forward:function(t){const{l:e,a:n,b:a}=Vp(t),l=Math.atan2(a,n)*om;return{h:l<0?l+360:l,c:Math.sqrt(n*n+a*a),l:e,alpha:t.a}},reverse:function(t){const e=t.h*Ud,n=t.c;return Gp({l:t.l,a:Math.cos(e)*n,b:Math.sin(e)*n,alpha:t.alpha})},interpolate:function(t,e,n){return{h:am(t.h,e.h,n),c:Qn(t.c,e.c,n),l:Qn(t.l,e.l,n),alpha:Qn(t.alpha,e.alpha,n)}}};var Hp=Object.freeze({__proto__:null,hcl:ed,lab:wh});class Xo{constructor(e,n,a,l,u){this.type=e,this.operator=n,this.interpolation=a,this.input=l,this.labels=[],this.outputs=[];for(const[d,x]of u)this.labels.push(d),this.outputs.push(x)}static interpolationFactor(e,n,a,l){let u=0;if(e.name==="exponential")u=iu(n,e.base,a,l);else if(e.name==="linear")u=iu(n,1,a,l);else if(e.name==="cubic-bezier"){const d=e.controlPoints;u=new Ln(d[0],d[1],d[2],d[3]).solve(iu(n,1,a,l))}return u}static parse(e,n){let[a,l,u,...d]=e;if(!Array.isArray(l)||l.length===0)return n.error("Expected an interpolation type expression.",1);if(l[0]==="linear")l={name:"linear"};else if(l[0]==="exponential"){const S=l[1];if(typeof S!="number")return n.error("Exponential interpolation requires a numeric base.",1,1);l={name:"exponential",base:S}}else{if(l[0]!=="cubic-bezier")return n.error(`Unknown interpolation type ${String(l[0])}`,1,0);{const S=l.slice(1);if(S.length!==4||S.some(L=>typeof L!="number"||L<0||L>1))return n.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);l={name:"cubic-bezier",controlPoints:S}}}if(e.length-1<4)return n.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return n.error("Expected an even number of arguments.");if(u=n.parse(u,2,yn),!u)return null;const x=[];let v=null;a==="interpolate-hcl"||a==="interpolate-lab"?v=Ea:n.expectedType&&n.expectedType.kind!=="value"&&(v=n.expectedType);for(let S=0;S<d.length;S+=2){const L=d[S],P=d[S+1],O=S+3,V=S+4;if(typeof L!="number")return n.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',O);if(x.length&&x[x.length-1][0]>=L)return n.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',O);const G=n.parse(P,V,v);if(!G)return null;v=v||G.type,x.push([L,G])}return v.kind==="number"||v.kind==="color"||v.kind==="array"&&v.itemType.kind==="number"&&typeof v.N=="number"?new Xo(v,a,l,u,x):n.error(`Type ${qs(v)} is not interpolatable.`)}evaluate(e){const n=this.labels,a=this.outputs;if(n.length===1)return a[0].evaluate(e);const l=this.input.evaluate(e);if(l<=n[0])return a[0].evaluate(e);const u=n.length;if(l>=n[u-1])return a[u-1].evaluate(e);const d=hc(n,l),x=Xo.interpolationFactor(this.interpolation,l,n[d],n[d+1]),v=a[d].evaluate(e),S=a[d+1].evaluate(e);return this.operator==="interpolate"?Pd[this.type.kind.toLowerCase()](v,S,x):this.operator==="interpolate-hcl"?ed.reverse(ed.interpolate(ed.forward(v),ed.forward(S),x)):wh.reverse(wh.interpolate(wh.forward(v),wh.forward(S),x))}eachChild(e){e(this.input);for(const n of this.outputs)e(n)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e;e=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const n=[this.operator,e,this.input.serialize()];for(let a=0;a<this.labels.length;a++)n.push(this.labels[a],this.outputs[a].serialize());return n}}function iu(t,e,n,a){const l=a-n,u=t-n;return l===0?0:e===1?u/l:(Math.pow(e,u)-1)/(Math.pow(e,l)-1)}class Dl{constructor(e,n){this.type=e,this.args=n}static parse(e,n){if(e.length<2)return n.error("Expectected at least one argument.");let a=null;const l=n.expectedType;l&&l.kind!=="value"&&(a=l);const u=[];for(const x of e.slice(1)){const v=n.parse(x,1+u.length,a,void 0,{typeAnnotation:"omit"});if(!v)return null;a=a||v.type,u.push(v)}const d=l&&u.some(x=>Bu(l,x.type));return new Dl(d?Dr:a,u)}evaluate(e){let n,a=null,l=0;for(const u of this.args){if(l++,a=u.evaluate(e),a&&a instanceof Aa&&!a.available&&(n||(n=a),a=null,l===this.args.length))return n;if(a!==null)break}return a}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=["coalesce"];return this.eachChild(n=>{e.push(n.serialize())}),e}}class td{constructor(e,n){this.type=n.type,this.bindings=[].concat(e),this.result=n}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const n of this.bindings)e(n[1]);e(this.result)}static parse(e,n){if(e.length<4)return n.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const a=[];for(let u=1;u<e.length-1;u+=2){const d=e[u];if(typeof d!="string")return n.error(`Expected string, but found ${typeof d} instead.`,u);if(/[^a-zA-Z0-9_]/.test(d))return n.error("Variable names must contain only alphanumeric characters or '_'.",u);const x=n.parse(e[u+1],u+1);if(!x)return null;a.push([d,x])}const l=n.parse(e[e.length-1],e.length-1,n.expectedType,a);return l?new td(a,l):null}outputDefined(){return this.result.outputDefined()}serialize(){const e=["let"];for(const[n,a]of this.bindings)e.push(n,a.serialize());return e.push(this.result.serialize()),e}}class jp{constructor(e,n,a){this.type=e,this.index=n,this.input=a}static parse(e,n){if(e.length!==3)return n.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const a=n.parse(e[1],1,yn),l=n.parse(e[2],2,zs(n.expectedType||Dr));return a&&l?new jp(l.type.itemType,a,l):null}evaluate(e){const n=this.index.evaluate(e),a=this.input.evaluate(e);if(n<0)throw new _o(`Array index out of bounds: ${n} < 0.`);if(n>=a.length)throw new _o(`Array index out of bounds: ${n} > ${a.length-1}.`);if(n!==Math.floor(n))throw new _o(`Array index must be an integer, but found ${n} instead.`);return a[n]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class nu{constructor(e,n){this.type=Nr,this.needle=e,this.haystack=n}static parse(e,n){if(e.length!==3)return n.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const a=n.parse(e[1],1,Dr),l=n.parse(e[2],2,Dr);return a&&l?Dd(a.type,[Nr,qr,yn,ol,Dr])?new nu(a,l):n.error(`Expected first argument to be of type boolean, string, number or null, but found ${qs(a.type)} instead`):null}evaluate(e){const n=this.needle.evaluate(e),a=this.haystack.evaluate(e);if(a==null)return!1;if(!uh(n,["boolean","string","number","null"]))throw new _o(`Expected first argument to be of type boolean, string, number or null, but found ${qs(Qs(n))} instead.`);if(!uh(a,["string","array"]))throw new _o(`Expected second argument to be of type array or string, but found ${qs(Qs(a))} instead.`);return a.indexOf(n)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class La{constructor(e,n,a){this.type=yn,this.needle=e,this.haystack=n,this.fromIndex=a}static parse(e,n){if(e.length<=2||e.length>=5)return n.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const a=n.parse(e[1],1,Dr),l=n.parse(e[2],2,Dr);if(!a||!l)return null;if(!Dd(a.type,[Nr,qr,yn,ol,Dr]))return n.error(`Expected first argument to be of type boolean, string, number or null, but found ${qs(a.type)} instead`);if(e.length===4){const u=n.parse(e[3],3,yn);return u?new La(a,l,u):null}return new La(a,l)}evaluate(e){const n=this.needle.evaluate(e),a=this.haystack.evaluate(e);if(!uh(n,["boolean","string","number","null"]))throw new _o(`Expected first argument to be of type boolean, string, number or null, but found ${qs(Qs(n))} instead.`);if(!uh(a,["string","array"]))throw new _o(`Expected second argument to be of type array or string, but found ${qs(Qs(a))} instead.`);if(this.fromIndex){const l=this.fromIndex.evaluate(e);return a.indexOf(n,l)}return a.indexOf(n)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class Gd{constructor(e,n,a,l,u,d){this.inputType=e,this.type=n,this.input=a,this.cases=l,this.outputs=u,this.otherwise=d}static parse(e,n){if(e.length<5)return n.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return n.error("Expected an even number of arguments.");let a,l;n.expectedType&&n.expectedType.kind!=="value"&&(l=n.expectedType);const u={},d=[];for(let S=2;S<e.length-1;S+=2){let L=e[S];const P=e[S+1];Array.isArray(L)||(L=[L]);const O=n.concat(S);if(L.length===0)return O.error("Expected at least one branch label.");for(const G of L){if(typeof G!="number"&&typeof G!="string")return O.error("Branch labels must be numbers or strings.");if(typeof G=="number"&&Math.abs(G)>Number.MAX_SAFE_INTEGER)return O.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof G=="number"&&Math.floor(G)!==G)return O.error("Numeric branch labels must be integer values.");if(a){if(O.checkSubtype(a,Qs(G)))return null}else a=Qs(G);if(u[String(G)]!==void 0)return O.error("Branch labels must be unique.");u[String(G)]=d.length}const V=n.parse(P,S,l);if(!V)return null;l=l||V.type,d.push(V)}const x=n.parse(e[1],1,Dr);if(!x)return null;const v=n.parse(e[e.length-1],e.length-1,l);return v?x.type.kind!=="value"&&n.concat(1).checkSubtype(a,x.type)?null:new Gd(a,l,x,u,d,v):null}evaluate(e){const n=this.input.evaluate(e);return(Qs(n)===this.inputType&&this.outputs[this.cases[n]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["match",this.input.serialize()],n=Object.keys(this.cases).sort(),a=[],l={};for(const d of n){const x=l[this.cases[d]];x===void 0?(l[this.cases[d]]=a.length,a.push([this.cases[d],[d]])):a[x][1].push(d)}const u=d=>this.inputType.kind==="number"?Number(d):d;for(const[d,x]of a)e.push(x.length===1?u(x[0]):x.map(u)),e.push(this.outputs[d].serialize());return e.push(this.otherwise.serialize()),e}}class Hd{constructor(e,n,a){this.type=e,this.branches=n,this.otherwise=a}static parse(e,n){if(e.length<4)return n.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return n.error("Expected an odd number of arguments.");let a;n.expectedType&&n.expectedType.kind!=="value"&&(a=n.expectedType);const l=[];for(let d=1;d<e.length-1;d+=2){const x=n.parse(e[d],d,Nr);if(!x)return null;const v=n.parse(e[d+1],d+1,a);if(!v)return null;l.push([x,v]),a=a||v.type}const u=n.parse(e[e.length-1],e.length-1,a);return u?new Hd(a,l,u):null}evaluate(e){for(const[n,a]of this.branches)if(n.evaluate(e))return a.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[n,a]of this.branches)e(n),e(a);e(this.otherwise)}outputDefined(){return this.branches.every(([e,n])=>n.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["case"];return this.eachChild(n=>{e.push(n.serialize())}),e}}class zl{constructor(e,n,a,l){this.type=e,this.input=n,this.beginIndex=a,this.endIndex=l}static parse(e,n){if(e.length<=2||e.length>=5)return n.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const a=n.parse(e[1],1,Dr),l=n.parse(e[2],2,yn);if(!a||!l)return null;if(!Dd(a.type,[zs(Dr),qr,Dr]))return n.error(`Expected first argument to be of type array or string, but found ${qs(a.type)} instead`);if(e.length===4){const u=n.parse(e[3],3,yn);return u?new zl(a.type,a,l,u):null}return new zl(a.type,a,l)}evaluate(e){const n=this.input.evaluate(e),a=this.beginIndex.evaluate(e);if(!uh(n,["string","array"]))throw new _o(`Expected first argument to be of type array or string, but found ${qs(Qs(n))} instead.`);if(this.endIndex){const l=this.endIndex.evaluate(e);return n.slice(a,l)}return n.slice(a)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}function ru(t,e){return t==="=="||t==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function id(t,e,n,a){return a.compare(e,n)===0}function to(t,e,n){const a=t!=="=="&&t!=="!=";return class hM{constructor(u,d,x){this.type=Nr,this.lhs=u,this.rhs=d,this.collator=x,this.hasUntypedArgument=u.type.kind==="value"||d.type.kind==="value"}static parse(u,d){if(u.length!==3&&u.length!==4)return d.error("Expected two or three arguments.");const x=u[0];let v=d.parse(u[1],1,Dr);if(!v)return null;if(!ru(x,v.type))return d.concat(1).error(`"${x}" comparisons are not supported for type '${qs(v.type)}'.`);let S=d.parse(u[2],2,Dr);if(!S)return null;if(!ru(x,S.type))return d.concat(2).error(`"${x}" comparisons are not supported for type '${qs(S.type)}'.`);if(v.type.kind!==S.type.kind&&v.type.kind!=="value"&&S.type.kind!=="value")return d.error(`Cannot compare types '${qs(v.type)}' and '${qs(S.type)}'.`);a&&(v.type.kind==="value"&&S.type.kind!=="value"?v=new cl(S.type,[v]):v.type.kind!=="value"&&S.type.kind==="value"&&(S=new cl(v.type,[S])));let L=null;if(u.length===4){if(v.type.kind!=="string"&&S.type.kind!=="string"&&v.type.kind!=="value"&&S.type.kind!=="value")return d.error("Cannot use collator to compare non-string types.");if(L=d.parse(u[3],3,Zh),!L)return null}return new hM(v,S,L)}evaluate(u){const d=this.lhs.evaluate(u),x=this.rhs.evaluate(u);if(a&&this.hasUntypedArgument){const v=Qs(d),S=Qs(x);if(v.kind!==S.kind||v.kind!=="string"&&v.kind!=="number")throw new _o(`Expected arguments for "${t}" to be (string, string) or (number, number), but found (${v.kind}, ${S.kind}) instead.`)}if(this.collator&&!a&&this.hasUntypedArgument){const v=Qs(d),S=Qs(x);if(v.kind!=="string"||S.kind!=="string")return e(u,d,x)}return this.collator?n(u,d,x,this.collator.evaluate(u)):e(u,d,x)}eachChild(u){u(this.lhs),u(this.rhs),this.collator&&u(this.collator)}outputDefined(){return!0}serialize(){const u=[t];return this.eachChild(d=>{u.push(d.serialize())}),u}}}const Wp=to("==",function(t,e,n){return e===n},id),qp=to("!=",function(t,e,n){return e!==n},function(t,e,n,a){return!id(0,e,n,a)}),Zp=to("<",function(t,e,n){return e<n},function(t,e,n,a){return a.compare(e,n)<0}),jd=to(">",function(t,e,n){return e>n},function(t,e,n,a){return a.compare(e,n)>0}),su=to("<=",function(t,e,n){return e<=n},function(t,e,n,a){return a.compare(e,n)<=0}),ul=to(">=",function(t,e,n){return e>=n},function(t,e,n,a){return a.compare(e,n)>=0});class Wd{constructor(e,n,a,l,u,d){this.type=qr,this.number=e,this.locale=n,this.currency=a,this.unit=l,this.minFractionDigits=u,this.maxFractionDigits=d}static parse(e,n){if(e.length!==3)return n.error("Expected two arguments.");const a=n.parse(e[1],1,yn);if(!a)return null;const l=e[2];if(typeof l!="object"||Array.isArray(l))return n.error("NumberFormat options argument must be an object.");let u=null;if(l.locale&&(u=n.parse(l.locale,1,qr),!u))return null;let d=null;if(l.currency&&(d=n.parse(l.currency,1,qr),!d))return null;let x=null;if(l.unit&&(x=n.parse(l.unit,1,qr),!x))return null;let v=null;if(l["min-fraction-digits"]&&(v=n.parse(l["min-fraction-digits"],1,yn),!v))return null;let S=null;return l["max-fraction-digits"]&&(S=n.parse(l["max-fraction-digits"],1,yn),!S)?null:new Wd(a,u,d,x,v,S)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class qd{constructor(e){this.type=yn,this.input=e}static parse(e,n){if(e.length!==2)return n.error(`Expected 1 argument, but found ${e.length-1} instead.`);const a=n.parse(e[1],1);return a?a.type.kind!=="array"&&a.type.kind!=="string"&&a.type.kind!=="value"?n.error(`Expected argument of type string or array, but found ${qs(a.type)} instead.`):new qd(a):null}evaluate(e){const n=this.input.evaluate(e);if(typeof n=="string"||Array.isArray(n))return n.length;throw new _o(`Expected value to be of type string or array, but found ${qs(Qs(n))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){const e=["length"];return this.eachChild(n=>{e.push(n.serialize())}),e}}function $o(t){return function(){t=1831565813+(t|=0)|0;let e=Math.imul(t^t>>>15,1|t);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}const zc={"==":Wp,"!=":qp,">":jd,"<":Zp,">=":ul,"<=":su,array:cl,at:jp,boolean:cl,case:Hd,coalesce:Dl,collator:Hu,format:Uu,image:Vu,in:nu,"index-of":La,interpolate:Xo,"interpolate-hcl":Xo,"interpolate-lab":Xo,length:qd,let:td,literal:ac,match:Gd,number:cl,"number-format":Wd,object:cl,slice:zl,step:Wa,string:cl,"to-boolean":Il,"to-color":Il,"to-number":Il,"to-string":Il,var:cc,within:fa,distance:cs,config:Ca};function Oc(t,[e,n,a,l]){e=e.evaluate(t),n=n.evaluate(t),a=a.evaluate(t);const u=l?l.evaluate(t):1,d=al(e,n,a,u);if(d)throw new _o(d);return new Yr(e/255*u,n/255*u,a/255*u,u)}function Xp(t,[e,n,a,l]){e=e.evaluate(t),n=n.evaluate(t),a=a.evaluate(t);const u=l?l.evaluate(t):1,d=function(S,L,P,O){return typeof S=="number"&&S>=0&&S<=360?typeof L=="number"&&L>=0&&L<=100&&typeof P=="number"&&P>=0&&P<=100?O===void 0||typeof O=="number"&&O>=0&&O<=1?null:`Invalid hsla value [${[S,L,P,O].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof O=="number"?[S,L,P,O]:[S,L,P]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof O=="number"?[S,L,P,O]:[S,L,P]).join(", ")}]: 'h' must be between 0 and 360.`}(e,n,a,u);if(d)throw new _o(d);const x=`hsla(${e}, ${n}%, ${a}%, ${u})`,v=Yr.parse(x);if(!v)throw new _o(`Failed to parse HSLA color: ${x}`);return v}function Zd(t,e){return t in e}function ou(t,e){const n=e[t];return n===void 0?null:n}function Ol(t){return{type:t}}function au(t){return{result:"success",value:t}}function Fc(t){return{result:"error",value:t}}function $p(t,e){return!!t&&!!t.parameters&&t.parameters.indexOf(e)>-1}function nd(t){return t["property-type"]==="data-driven"}function m(t){return $p(t.expression,"measure-light")}function r(t){return $p(t.expression,"zoom")}function h(t){return!!t.expression&&t.expression.interpolated}function y(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}function b(t){return t}function T(t,e){const n=e.type==="color",a=t.stops&&typeof t.stops[0][0]=="object",l=a||!(a||t.property!==void 0),u=t.type||(h(e)?"exponential":"interval");if(n&&((t=ku({},t)).stops&&(t.stops=t.stops.map(S=>[S[0],Yr.parse(S[1])])),t.default=Yr.parse(t.default?t.default:e.default)),t.colorSpace&&t.colorSpace!=="rgb"&&!Hp[t.colorSpace])throw new Error(`Unknown color space: ${t.colorSpace}`);let d,x,v;if(u==="exponential")d=N;else if(u==="interval")d=k;else if(u==="categorical"){d=I,x=Object.create(null);for(const S of t.stops)x[S[0]]=S[1];v=typeof t.stops[0][0]}else{if(u!=="identity")throw new Error(`Unknown function type "${u}"`);d=H}if(a){const S={},L=[];for(let V=0;V<t.stops.length;V++){const G=t.stops[V],$=G[0].zoom;S[$]===void 0&&(S[$]={zoom:$,type:t.type,property:t.property,default:t.default,stops:[]},L.push($)),S[$].stops.push([G[0].value,G[1]])}const P=[];for(const V of L)P.push([S[V].zoom,T(S[V],e)]);const O={name:"linear"};return{kind:"composite",interpolationType:O,interpolationFactor:Xo.interpolationFactor.bind(void 0,O),zoomStops:P.map(V=>V[0]),evaluate:({zoom:V},G)=>N({stops:P,base:t.base},e,V).evaluate(V,G)}}if(l){const S=u==="exponential"?{name:"exponential",base:t.base!==void 0?t.base:1}:null;return{kind:"camera",interpolationType:S,interpolationFactor:Xo.interpolationFactor.bind(void 0,S),zoomStops:t.stops.map(L=>L[0]),evaluate:({zoom:L})=>d(t,e,L,x,v)}}return{kind:"source",evaluate(S,L){const P=L&&L.properties?L.properties[t.property]:void 0;return P===void 0?E(t.default,e.default):d(t,e,P,x,v)}}}function E(t,e,n){return t!==void 0?t:e!==void 0?e:n!==void 0?n:void 0}function I(t,e,n,a,l){return E(typeof n===l?a[n]:void 0,t.default,e.default)}function k(t,e,n){if(dh(n)!=="number")return E(t.default,e.default);const a=t.stops.length;if(a===1||n<=t.stops[0][0])return t.stops[0][1];if(n>=t.stops[a-1][0])return t.stops[a-1][1];const l=hc(t.stops.map(u=>u[0]),n);return t.stops[l][1]}function N(t,e,n){const a=t.base!==void 0?t.base:1;if(dh(n)!=="number")return E(t.default,e.default);const l=t.stops.length;if(l===1||n<=t.stops[0][0])return t.stops[0][1];if(n>=t.stops[l-1][0])return t.stops[l-1][1];const u=hc(t.stops.map(L=>L[0]),n),d=function(L,P,O,V){const G=V-O,$=L-O;return G===0?0:P===1?$/G:(Math.pow(P,$)-1)/(Math.pow(P,G)-1)}(n,a,t.stops[u][0],t.stops[u+1][0]),x=t.stops[u][1],v=t.stops[u+1][1];let S=Pd[e.type]||b;if(t.colorSpace&&t.colorSpace!=="rgb"){const L=Hp[t.colorSpace];S=(P,O)=>L.reverse(L.interpolate(L.forward(P),L.forward(O),d))}return typeof x.evaluate=="function"?{evaluate(...L){const P=x.evaluate.apply(void 0,L),O=v.evaluate.apply(void 0,L);if(P!==void 0&&O!==void 0)return S(P,O,d)}}:S(x,v,d)}function H(t,e,n){return e.type==="color"?n=Yr.parse(n):e.type==="formatted"?n=zo.fromString(n.toString()):e.type==="resolvedImage"?n=Aa.fromString(n.toString()):dh(n)===e.type||e.type==="enum"&&e.values[n]||(n=void 0),E(n,t.default,e.default)}Zo.register(zc,{error:[{kind:"error"},[qr],(t,[e])=>{throw new _o(e.evaluate(t))}],typeof:[qr,[Dr],(t,[e])=>qs(Qs(e.evaluate(t)))],"to-rgba":[zs(yn,4),[Ea],(t,[e])=>e.evaluate(t).toRenderColor(null).toArray()],rgb:[Ea,[yn,yn,yn],Oc],rgba:[Ea,[yn,yn,yn,yn],Oc],hsl:[Ea,[yn,yn,yn],Xp],hsla:[Ea,[yn,yn,yn,yn],Xp],has:{type:Nr,overloads:[[[qr],(t,[e])=>Zd(e.evaluate(t),t.properties())],[[qr,hh],(t,[e,n])=>Zd(e.evaluate(t),n.evaluate(t))]]},get:{type:Dr,overloads:[[[qr],(t,[e])=>ou(e.evaluate(t),t.properties())],[[qr,hh],(t,[e,n])=>ou(e.evaluate(t),n.evaluate(t))]]},"feature-state":[Dr,[qr],(t,[e])=>ou(e.evaluate(t),t.featureState||{})],properties:[hh,[],t=>t.properties()],"geometry-type":[qr,[],t=>t.geometryType()],id:[Dr,[],t=>t.id()],zoom:[yn,[],t=>t.globals.zoom],pitch:[yn,[],t=>t.globals.pitch||0],"distance-from-center":[yn,[],t=>t.distanceFromCenter()],"measure-light":[yn,[qr],(t,[e])=>t.measureLight(e.evaluate(t))],"heatmap-density":[yn,[],t=>t.globals.heatmapDensity||0],"line-progress":[yn,[],t=>t.globals.lineProgress||0],"raster-value":[yn,[],t=>t.globals.rasterValue||0],"raster-particle-speed":[yn,[],t=>t.globals.rasterParticleSpeed||0],"sky-radial-progress":[yn,[],t=>t.globals.skyRadialProgress||0],accumulated:[Dr,[],t=>t.globals.accumulated===void 0?null:t.globals.accumulated],"+":[yn,Ol(yn),(t,e)=>{let n=0;for(const a of e)n+=a.evaluate(t);return n}],"*":[yn,Ol(yn),(t,e)=>{let n=1;for(const a of e)n*=a.evaluate(t);return n}],"-":{type:yn,overloads:[[[yn,yn],(t,[e,n])=>e.evaluate(t)-n.evaluate(t)],[[yn],(t,[e])=>-e.evaluate(t)]]},"/":[yn,[yn,yn],(t,[e,n])=>e.evaluate(t)/n.evaluate(t)],"%":[yn,[yn,yn],(t,[e,n])=>e.evaluate(t)%n.evaluate(t)],ln2:[yn,[],()=>Math.LN2],pi:[yn,[],()=>Math.PI],e:[yn,[],()=>Math.E],"^":[yn,[yn,yn],(t,[e,n])=>Math.pow(e.evaluate(t),n.evaluate(t))],sqrt:[yn,[yn],(t,[e])=>Math.sqrt(e.evaluate(t))],log10:[yn,[yn],(t,[e])=>Math.log(e.evaluate(t))/Math.LN10],ln:[yn,[yn],(t,[e])=>Math.log(e.evaluate(t))],log2:[yn,[yn],(t,[e])=>Math.log(e.evaluate(t))/Math.LN2],sin:[yn,[yn],(t,[e])=>Math.sin(e.evaluate(t))],cos:[yn,[yn],(t,[e])=>Math.cos(e.evaluate(t))],tan:[yn,[yn],(t,[e])=>Math.tan(e.evaluate(t))],asin:[yn,[yn],(t,[e])=>Math.asin(e.evaluate(t))],acos:[yn,[yn],(t,[e])=>Math.acos(e.evaluate(t))],atan:[yn,[yn],(t,[e])=>Math.atan(e.evaluate(t))],min:[yn,Ol(yn),(t,e)=>Math.min(...e.map(n=>n.evaluate(t)))],max:[yn,Ol(yn),(t,e)=>Math.max(...e.map(n=>n.evaluate(t)))],abs:[yn,[yn],(t,[e])=>Math.abs(e.evaluate(t))],round:[yn,[yn],(t,[e])=>{const n=e.evaluate(t);return n<0?-Math.round(-n):Math.round(n)}],floor:[yn,[yn],(t,[e])=>Math.floor(e.evaluate(t))],ceil:[yn,[yn],(t,[e])=>Math.ceil(e.evaluate(t))],"filter-==":[Nr,[qr,Dr],(t,[e,n])=>t.properties()[e.value]===n.value],"filter-id-==":[Nr,[Dr],(t,[e])=>t.id()===e.value],"filter-type-==":[Nr,[qr],(t,[e])=>t.geometryType()===e.value],"filter-<":[Nr,[qr,Dr],(t,[e,n])=>{const a=t.properties()[e.value],l=n.value;return typeof a==typeof l&&a<l}],"filter-id-<":[Nr,[Dr],(t,[e])=>{const n=t.id(),a=e.value;return typeof n==typeof a&&n<a}],"filter->":[Nr,[qr,Dr],(t,[e,n])=>{const a=t.properties()[e.value],l=n.value;return typeof a==typeof l&&a>l}],"filter-id->":[Nr,[Dr],(t,[e])=>{const n=t.id(),a=e.value;return typeof n==typeof a&&n>a}],"filter-<=":[Nr,[qr,Dr],(t,[e,n])=>{const a=t.properties()[e.value],l=n.value;return typeof a==typeof l&&a<=l}],"filter-id-<=":[Nr,[Dr],(t,[e])=>{const n=t.id(),a=e.value;return typeof n==typeof a&&n<=a}],"filter->=":[Nr,[qr,Dr],(t,[e,n])=>{const a=t.properties()[e.value],l=n.value;return typeof a==typeof l&&a>=l}],"filter-id->=":[Nr,[Dr],(t,[e])=>{const n=t.id(),a=e.value;return typeof n==typeof a&&n>=a}],"filter-has":[Nr,[Dr],(t,[e])=>e.value in t.properties()],"filter-has-id":[Nr,[],t=>t.id()!==null&&t.id()!==void 0],"filter-type-in":[Nr,[zs(qr)],(t,[e])=>e.value.indexOf(t.geometryType())>=0],"filter-id-in":[Nr,[zs(Dr)],(t,[e])=>e.value.indexOf(t.id())>=0],"filter-in-small":[Nr,[qr,zs(Dr)],(t,[e,n])=>n.value.indexOf(t.properties()[e.value])>=0],"filter-in-large":[Nr,[qr,zs(Dr)],(t,[e,n])=>function(a,l,u,d){for(;u<=d;){const x=u+d>>1;if(l[x]===a)return!0;l[x]>a?d=x-1:u=x+1}return!1}(t.properties()[e.value],n.value,0,n.value.length-1)],all:{type:Nr,overloads:[[[Nr,Nr],(t,[e,n])=>e.evaluate(t)&&n.evaluate(t)],[Ol(Nr),(t,e)=>{for(const n of e)if(!n.evaluate(t))return!1;return!0}]]},any:{type:Nr,overloads:[[[Nr,Nr],(t,[e,n])=>e.evaluate(t)||n.evaluate(t)],[Ol(Nr),(t,e)=>{for(const n of e)if(n.evaluate(t))return!0;return!1}]]},"!":[Nr,[Nr],(t,[e])=>!e.evaluate(t)],"is-supported-script":[Nr,[qr],(t,[e])=>{const n=t.globals&&t.globals.isSupportedScript;return!n||n(e.evaluate(t))}],upcase:[qr,[qr],(t,[e])=>e.evaluate(t).toUpperCase()],downcase:[qr,[qr],(t,[e])=>e.evaluate(t).toLowerCase()],concat:[qr,Ol(Dr),(t,e)=>e.map(n=>ll(n.evaluate(t))).join("")],"resolved-locale":[qr,[Zh],(t,[e])=>e.evaluate(t).resolvedLocale()],random:[yn,[yn,yn,Dr],(t,e)=>{const[n,a,l]=e.map(d=>d.evaluate(t));if(n>a||n===a)return n;let u;if(typeof l=="string")u=function(d){let x=0;if(d.length===0)return x;for(let v=0;v<d.length;v++)x=(x<<5)-x+d.charCodeAt(v),x|=0;return x}(l);else{if(typeof l!="number")throw new _o(`Invalid seed input: ${l}`);u=l}return n+$o(u)()*(a-n)}]});class X{constructor(e,n,a,l){this.expression=e,this._warningHistory={},this._evaluator=new zd(a,l),this._defaultValue=n?function(u){return u.type==="color"&&(y(u.default)||Array.isArray(u.default))?new Yr(0,0,0,0):u.type==="color"?Yr.parse(u.default)||null:u.default===void 0?null:u.default}(n):null,this._enumValues=n&&n.type==="enum"?n.values:null}evaluateWithoutErrorHandling(e,n,a,l,u,d,x,v){return this._evaluator.globals=e,this._evaluator.feature=n,this._evaluator.featureState=a,this._evaluator.canonical=l||null,this._evaluator.availableImages=u||null,this._evaluator.formattedSection=d,this._evaluator.featureTileCoord=x||null,this._evaluator.featureDistanceData=v||null,this.expression.evaluate(this._evaluator)}evaluate(e,n,a,l,u,d,x,v){this._evaluator.globals=e,this._evaluator.feature=n||null,this._evaluator.featureState=a||null,this._evaluator.canonical=l||null,this._evaluator.availableImages=u||null,this._evaluator.formattedSection=d||null,this._evaluator.featureTileCoord=x||null,this._evaluator.featureDistanceData=v||null;try{const S=this.expression.evaluate(this._evaluator);if(S==null||typeof S=="number"&&S!=S)return this._defaultValue;if(this._enumValues&&!(S in this._enumValues))throw new _o(`Expected value to be one of ${Object.keys(this._enumValues).map(L=>JSON.stringify(L)).join(", ")}, but found ${JSON.stringify(S)} instead.`);return S}catch(S){return this._warningHistory[S.message]||(this._warningHistory[S.message]=!0,typeof console<"u"&&console.warn(S.message)),this._defaultValue}}}function ee(t){return Array.isArray(t)&&t.length>0&&typeof t[0]=="string"&&t[0]in zc}function ie(t,e,n,a){const l=new Pc(zc,[],e?function(d){const x={color:Ea,string:qr,number:yn,enum:qr,boolean:Nr,formatted:na,resolvedImage:So};return d.type==="array"?zs(x[d.value]||Dr,d.length):x[d.type]}(e):void 0,void 0,void 0,n,a),u=l.parse(t,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return u?au(new X(u,e,n,a)):Fc(l.errors)}class ue{constructor(e,n,a){this.kind=e,this._styleExpression=n,this.isLightConstant=a,this.isStateDependent=e!=="constant"&&!Pl(n.expression),this.isConfigDependent=!eo(n.expression)}evaluateWithoutErrorHandling(e,n,a,l,u,d){return this._styleExpression.evaluateWithoutErrorHandling(e,n,a,l,u,d)}evaluate(e,n,a,l,u,d){return this._styleExpression.evaluate(e,n,a,l,u,d)}}class pe{constructor(e,n,a,l,u){this.kind=e,this.zoomStops=a,this._styleExpression=n,this.isStateDependent=e!=="camera"&&!Pl(n.expression),this.isLightConstant=u,this.isConfigDependent=!eo(n.expression),this.interpolationType=l}evaluateWithoutErrorHandling(e,n,a,l,u,d){return this._styleExpression.evaluateWithoutErrorHandling(e,n,a,l,u,d)}evaluate(e,n,a,l,u,d){return this._styleExpression.evaluate(e,n,a,l,u,d)}interpolationFactor(e,n,a){return this.interpolationType?Xo.interpolationFactor(this.interpolationType,e,n,a):0}}function fe(t,e,n,a){if((t=ie(t,e,n,a)).result==="error")return t;const l=t.value.expression,u=Lc(l);if(!u&&!nd(e))return Fc([new Ua("","data expressions not supported")]);const d=ja(l,["zoom","pitch","distance-from-center"]);if(!d&&!r(e))return Fc([new Ua("","zoom expressions not supported")]);const x=ja(l,["measure-light"]);if(!x&&!m(e))return Fc([new Ua("","measure-light expression not supported")]);const v=e.expression&&e.expression.relaxZoomRestriction,S=Le(l);return S||d||v?S instanceof Ua?Fc([S]):S instanceof Xo&&!h(e)?Fc([new Ua("",'"interpolate" expressions cannot be used with this property')]):au(S?new pe(u?"camera":"composite",t.value,S.labels,S instanceof Xo?S.interpolation:void 0,x):new ue(u?"constant":"source",t.value,x)):Fc([new Ua("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class _e{constructor(e,n){this._parameters=e,this._specification=n,ku(this,T(this._parameters,this._specification))}static deserialize(e){return new _e(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function Le(t){let e=null;if(t instanceof td)e=Le(t.result);else if(t instanceof Dl){for(const n of t.args)if(e=Le(n),e)break}else(t instanceof Wa||t instanceof Xo)&&t.input instanceof Zo&&t.input.name==="zoom"&&(e=t);return e instanceof Ua||t.eachChild(n=>{const a=Le(n);a instanceof Ua?e=a:e&&a&&e!==a&&(e=new Ua("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}var Fe=$e,Be=3;function $e(t,e,n){var a=this.cells=[];if(t instanceof ArrayBuffer){this.arrayBuffer=t;var l=new Int32Array(this.arrayBuffer);t=l[0],this.d=(e=l[1])+2*(n=l[2]);for(var u=0;u<this.d*this.d;u++){var d=l[Be+u],x=l[Be+u+1];a.push(d===x?null:l.subarray(d,x))}var v=l[Be+a.length+1];this.keys=l.subarray(l[Be+a.length],v),this.bboxes=l.subarray(v),this.insert=this._insertReadonly}else{this.d=e+2*n;for(var S=0;S<this.d*this.d;S++)a.push([]);this.keys=[],this.bboxes=[]}this.n=e,this.extent=t,this.padding=n,this.scale=e/t,this.uid=0;var L=n/e*t;this.min=-L,this.max=t+L}$e.prototype.insert=function(t,e,n,a,l){this._forEachCell(e,n,a,l,this._insertCell,this.uid++),this.keys.push(t),this.bboxes.push(e),this.bboxes.push(n),this.bboxes.push(a),this.bboxes.push(l)},$e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},$e.prototype._insertCell=function(t,e,n,a,l,u){this.cells[l].push(u)},$e.prototype.query=function(t,e,n,a,l){var u=this.min,d=this.max;if(t<=u&&e<=u&&d<=n&&d<=a&&!l)return Array.prototype.slice.call(this.keys);var x=[];return this._forEachCell(t,e,n,a,this._queryCell,x,{},l),x},$e.prototype._queryCell=function(t,e,n,a,l,u,d,x){var v=this.cells[l];if(v!==null)for(var S=this.keys,L=this.bboxes,P=0;P<v.length;P++){var O=v[P];if(d[O]===void 0){var V=4*O;(x?x(L[V+0],L[V+1],L[V+2],L[V+3]):t<=L[V+2]&&e<=L[V+3]&&n>=L[V+0]&&a>=L[V+1])?(d[O]=!0,u.push(S[O])):d[O]=!1}}},$e.prototype._forEachCell=function(t,e,n,a,l,u,d,x){for(var v=this._convertToCellCoord(t),S=this._convertToCellCoord(e),L=this._convertToCellCoord(n),P=this._convertToCellCoord(a),O=v;O<=L;O++)for(var V=S;V<=P;V++){var G=this.d*V+O;if((!x||x(this._convertFromCellCoord(O),this._convertFromCellCoord(V),this._convertFromCellCoord(O+1),this._convertFromCellCoord(V+1)))&&l.call(this,t,e,n,a,G,u,d,x))return}},$e.prototype._convertFromCellCoord=function(t){return(t-this.padding)/this.scale},$e.prototype._convertToCellCoord=function(t){return Math.max(0,Math.min(this.d-1,Math.floor(t*this.scale)+this.padding))},$e.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var t=this.cells,e=Be+this.cells.length+1+1,n=0,a=0;a<this.cells.length;a++)n+=this.cells[a].length;var l=new Int32Array(e+n+this.keys.length+this.bboxes.length);l[0]=this.extent,l[1]=this.n,l[2]=this.padding;for(var u=e,d=0;d<t.length;d++){var x=t[d];l[Be+d]=u,l.set(x,u),u+=x.length}return l[Be+t.length]=u,l.set(this.keys,u),l[Be+t.length+1]=u+=this.keys.length,l.set(this.bboxes,u),u+=this.bboxes.length,l.buffer};var Ze=Ut(Fe);const rt={};function xe(t,e,n={}){Object.defineProperty(t,"_classRegistryKey",{value:e,writable:!1}),rt[e]={klass:t,omit:n.omit||[]}}xe(Object,"Object"),Ze.serialize=function(t,e){const n=t.toArrayBuffer();return e&&e.add(n),{buffer:n}},Ze.deserialize=function(t){return new Ze(t.buffer)},Object.defineProperty(Ze,"name",{value:"Grid"}),xe(Ze,"Grid"),xe(Yr,"Color"),xe(Error,"Error"),xe(zo,"Formatted"),xe(Nu,"FormattedSection"),xe(ec,"AJAXError"),xe(Aa,"ResolvedImage"),xe(_e,"StylePropertyFunction"),xe(X,"StyleExpression",{omit:["_evaluator"]}),xe(pe,"ZoomDependentExpression"),xe(ue,"ZoomConstantExpression"),xe(Zo,"CompoundExpression",{omit:["_evaluate"]});for(const t in zc)rt[zc[t]._classRegistryKey]||xe(zc[t],`Expression${t}`);function Ne(t){return t&&typeof ArrayBuffer<"u"&&(t instanceof ArrayBuffer||t.constructor&&t.constructor.name==="ArrayBuffer")}function ct(t){return self.ImageBitmap&&t instanceof ImageBitmap}function Ot(t,e){if(t==null||typeof t=="boolean"||typeof t=="number"||typeof t=="string"||t instanceof Boolean||t instanceof Number||t instanceof String||t instanceof Date||t instanceof RegExp)return t;if(Ne(t)||ct(t))return e&&e.add(t),t;if(ArrayBuffer.isView(t)){const n=t;return e&&e.add(n.buffer),n}if(t instanceof ImageData)return e&&e.add(t.data.buffer),t;if(Array.isArray(t)){const n=[];for(const a of t)n.push(Ot(a,e));return n}if(t instanceof Map){const n={$name:"Map"};for(const[a,l]of t.entries())n[a]=Ot(l);return n}if(typeof t=="object"){const n=t.constructor,a=n._classRegistryKey;if(!a)throw new Error(`can't serialize object of unregistered class ${a}`);const l=n.serialize?n.serialize(t,e):{};if(!n.serialize){for(const u in t)t.hasOwnProperty(u)&&(rt[a].omit.indexOf(u)>=0||(l[u]=Ot(t[u],e)));t instanceof Error&&(l.message=t.message)}if(l.$name)throw new Error("$name property is reserved for worker serialization logic.");return a!=="Object"&&(l.$name=a),l}throw new Error("can't serialize object of type "+typeof t)}function mt(t){if(t==null||typeof t=="boolean"||typeof t=="number"||typeof t=="string"||t instanceof Boolean||t instanceof Number||t instanceof String||t instanceof Date||t instanceof RegExp||Ne(t)||ct(t)||ArrayBuffer.isView(t)||t instanceof ImageData)return t;if(Array.isArray(t))return t.map(mt);if(typeof t=="object"){const e=t.$name||"Object";if(e==="Map"){const l=new Map;for(const u of Object.keys(t))u!=="$name"&&l.set(u,mt(t[u]));return l}const{klass:n}=rt[e];if(!n)throw new Error(`can't deserialize unregistered class ${e}`);if(n.deserialize)return n.deserialize(t);const a=Object.create(n.prototype);for(const l of Object.keys(t))l!=="$name"&&(a[l]=mt(t[l]));return a}throw new Error("can't deserialize object of type "+typeof t)}const it={"Latin-1 Supplement":t=>t>=128&&t<=255,Arabic:t=>t>=1536&&t<=1791,"Arabic Supplement":t=>t>=1872&&t<=1919,"Arabic Extended-A":t=>t>=2208&&t<=2303,"Hangul Jamo":t=>t>=4352&&t<=4607,"Unified Canadian Aboriginal Syllabics":t=>t>=5120&&t<=5759,Khmer:t=>t>=6016&&t<=6143,"Unified Canadian Aboriginal Syllabics Extended":t=>t>=6320&&t<=6399,"General Punctuation":t=>t>=8192&&t<=8303,"Letterlike Symbols":t=>t>=8448&&t<=8527,"Number Forms":t=>t>=8528&&t<=8591,"Miscellaneous Technical":t=>t>=8960&&t<=9215,"Control Pictures":t=>t>=9216&&t<=9279,"Optical Character Recognition":t=>t>=9280&&t<=9311,"Enclosed Alphanumerics":t=>t>=9312&&t<=9471,"Geometric Shapes":t=>t>=9632&&t<=9727,"Miscellaneous Symbols":t=>t>=9728&&t<=9983,"Miscellaneous Symbols and Arrows":t=>t>=11008&&t<=11263,"CJK Radicals Supplement":t=>t>=11904&&t<=12031,"Kangxi Radicals":t=>t>=12032&&t<=12255,"Ideographic Description Characters":t=>t>=12272&&t<=12287,"CJK Symbols and Punctuation":t=>t>=12288&&t<=12351,Hiragana:t=>t>=12352&&t<=12447,Katakana:t=>t>=12448&&t<=12543,Bopomofo:t=>t>=12544&&t<=12591,"Hangul Compatibility Jamo":t=>t>=12592&&t<=12687,Kanbun:t=>t>=12688&&t<=12703,"Bopomofo Extended":t=>t>=12704&&t<=12735,"CJK Strokes":t=>t>=12736&&t<=12783,"Katakana Phonetic Extensions":t=>t>=12784&&t<=12799,"Enclosed CJK Letters and Months":t=>t>=12800&&t<=13055,"CJK Compatibility":t=>t>=13056&&t<=13311,"CJK Unified Ideographs Extension A":t=>t>=13312&&t<=19903,"Yijing Hexagram Symbols":t=>t>=19904&&t<=19967,"CJK Unified Ideographs":t=>t>=19968&&t<=40959,"Yi Syllables":t=>t>=40960&&t<=42127,"Yi Radicals":t=>t>=42128&&t<=42191,"Hangul Jamo Extended-A":t=>t>=43360&&t<=43391,"Hangul Syllables":t=>t>=44032&&t<=55215,"Hangul Jamo Extended-B":t=>t>=55216&&t<=55295,"Private Use Area":t=>t>=57344&&t<=63743,"CJK Compatibility Ideographs":t=>t>=63744&&t<=64255,"Arabic Presentation Forms-A":t=>t>=64336&&t<=65023,"Vertical Forms":t=>t>=65040&&t<=65055,"CJK Compatibility Forms":t=>t>=65072&&t<=65103,"Small Form Variants":t=>t>=65104&&t<=65135,"Arabic Presentation Forms-B":t=>t>=65136&&t<=65279,"Halfwidth and Fullwidth Forms":t=>t>=65280&&t<=65519,"CJK Unified Ideographs Extension B":t=>t>=131072&&t<=173791};function Nt(t){for(const e of t)if(hi(e.charCodeAt(0)))return!0;return!1}function mi(t){for(const e of t)if(!_i(e.charCodeAt(0)))return!1;return!0}function _i(t){return!(it.Arabic(t)||it["Arabic Supplement"](t)||it["Arabic Extended-A"](t)||it["Arabic Presentation Forms-A"](t)||it["Arabic Presentation Forms-B"](t))}function hi(t){return!(t!==746&&t!==747&&(t<4352||!(it["Bopomofo Extended"](t)||it.Bopomofo(t)||it["CJK Compatibility Forms"](t)&&!(t>=65097&&t<=65103)||it["CJK Compatibility Ideographs"](t)||it["CJK Compatibility"](t)||it["CJK Radicals Supplement"](t)||it["CJK Strokes"](t)||!(!it["CJK Symbols and Punctuation"](t)||t>=12296&&t<=12305||t>=12308&&t<=12319||t===12336)||it["CJK Unified Ideographs Extension A"](t)||it["CJK Unified Ideographs"](t)||it["Enclosed CJK Letters and Months"](t)||it["Hangul Compatibility Jamo"](t)||it["Hangul Jamo Extended-A"](t)||it["Hangul Jamo Extended-B"](t)||it["Hangul Jamo"](t)||it["Hangul Syllables"](t)||it.Hiragana(t)||it["Ideographic Description Characters"](t)||it.Kanbun(t)||it["Kangxi Radicals"](t)||it["Katakana Phonetic Extensions"](t)||it.Katakana(t)&&t!==12540||!(!it["Halfwidth and Fullwidth Forms"](t)||t===65288||t===65289||t===65293||t>=65306&&t<=65310||t===65339||t===65341||t===65343||t>=65371&&t<=65503||t===65507||t>=65512&&t<=65519)||!(!it["Small Form Variants"](t)||t>=65112&&t<=65118||t>=65123&&t<=65126)||it["Unified Canadian Aboriginal Syllabics"](t)||it["Unified Canadian Aboriginal Syllabics Extended"](t)||it["Vertical Forms"](t)||it["Yijing Hexagram Symbols"](t)||it["Yi Syllables"](t)||it["Yi Radicals"](t))))}function vt(t){return!(hi(t)||function(e){return!!(it["Latin-1 Supplement"](e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||it["General Punctuation"](e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||it["Letterlike Symbols"](e)||it["Number Forms"](e)||it["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||it["Control Pictures"](e)&&e!==9251||it["Optical Character Recognition"](e)||it["Enclosed Alphanumerics"](e)||it["Geometric Shapes"](e)||it["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||it["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||it["CJK Symbols and Punctuation"](e)||it.Katakana(e)||it["Private Use Area"](e)||it["CJK Compatibility Forms"](e)||it["Small Form Variants"](e)||it["Halfwidth and Fullwidth Forms"](e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)}(t))}function Gt(t){return t>=1424&&t<=2303||it["Arabic Presentation Forms-A"](t)||it["Arabic Presentation Forms-B"](t)}function ri(t,e){return!(!e&&Gt(t)||t>=2304&&t<=3583||t>=3840&&t<=4255||it.Khmer(t))}function $i(t){for(const e of t)if(Gt(e.charCodeAt(0)))return!0;return!1}const Yi="deferred",hn="loading",Ji="loaded";let Gi=null,Qt="unavailable",xn=null;const Tr=function(t){t&&typeof t=="string"&&t.indexOf("NetworkError")>-1&&(Qt="error"),Gi&&Gi(t)};function Wn(){cr.fire(new pa("pluginStateChange",{pluginStatus:Qt,pluginURL:xn}))}const cr=new oc,er=function(){return Qt},xs=function(){if(Qt!==Yi||!xn)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");Qt=hn,Wn(),xn&&ic({url:xn},t=>{t?Tr(t):(Qt=Ji,Wn())})},zr={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>Qt===Ji||zr.applyArabicShaping!=null,isLoading:()=>Qt===hn,setState(t){Qt=t.pluginStatus,xn=t.pluginURL},isParsed:()=>zr.applyArabicShaping!=null&&zr.processBidirectionalText!=null&&zr.processStyledBidirectionalText!=null,getPluginURL:()=>xn};class ir{constructor(e,n){this.zoom=e,n?(this.now=n.now,this.fadeDuration=n.fadeDuration,this.transition=n.transition,this.pitch=n.pitch,this.brightness=n.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(e){return function(n,a){for(const l of n)if(!ri(l.charCodeAt(0),a))return!1;return!0}(e,zr.isLoaded())}}class ls{constructor(e,n,a,l){this.property=e,this.value=n,this.expression=function(u,d,x,v){if(y(u))return new _e(u,d);if(ee(u)||Array.isArray(u)&&u.length>0){const S=fe(u,d,x,v);if(S.result==="error")throw new Error(S.value.map(L=>`${L.key}: ${L.message}`).join(", "));return S.value}{let S=u;return typeof u=="string"&&d.type==="color"&&(S=Yr.parse(u)),{kind:"constant",isConfigDependent:!1,evaluate:()=>S}}}(n===void 0?e.specification.default:n,e.specification,a,l)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,n,a){return this.property.possiblyEvaluate(this,e,n,a)}}class Zr{constructor(e,n,a){this.property=e,this.value=new ls(e,void 0,n,a)}transitioned(e,n){return new dr(this.property,this.value,n,Ls({},e.transition,this.transition),e.now)}untransitioned(){return new dr(this.property,this.value,null,{},0)}}class Or{constructor(e,n,a){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._scope=n,this._options=a,this.isConfigDependent=!1}getValue(e){return po(this._values[e].value.value)}setValue(e,n){this._values.hasOwnProperty(e)||(this._values[e]=new Zr(this._values[e].property,this._scope,this._options)),this._values[e].value=new ls(this._values[e].property,n===null?void 0:po(n),this._scope,this._options),this.isConfigDependent=this.isConfigDependent||this._values[e].value.expression.isConfigDependent}setTransitionOrValue(e,n){n&&(this._options=n);const a=this._properties.properties;if(e)for(const l in e){const u=e[l];if(El(l,"-transition")){const d=l.slice(0,-11);a[d]&&this.setTransition(d,u)}else a.hasOwnProperty(l)&&this.setValue(l,u)}}getTransition(e){return po(this._values[e].transition)}setTransition(e,n){this._values.hasOwnProperty(e)||(this._values[e]=new Zr(this._values[e].property)),this._values[e].transition=po(n)||void 0}serialize(){const e={};for(const n of Object.keys(this._values)){const a=this.getValue(n);a!==void 0&&(e[n]=a);const l=this.getTransition(n);l!==void 0&&(e[`${n}-transition`]=l)}return e}transitioned(e,n){const a=new hs(this._properties);for(const l of Object.keys(this._values))a._values[l]=this._values[l].transitioned(e,n._values[l]);return a}untransitioned(){const e=new hs(this._properties);for(const n of Object.keys(this._values))e._values[n]=this._values[n].untransitioned();return e}}class dr{constructor(e,n,a,l,u){const d=l.delay||0,x=l.duration||0;u=u||0,this.property=e,this.value=n,this.begin=u+d,this.end=this.begin+x,e.specification.transition&&(l.delay||l.duration)&&(this.prior=a)}possiblyEvaluate(e,n,a){const l=e.now||0,u=this.value.possiblyEvaluate(e,n,a),d=this.prior;if(d){if(l>this.end)return this.prior=null,u;if(this.value.isDataDriven())return this.prior=null,u;if(l<this.begin)return d.possiblyEvaluate(e,n,a);{const x=(l-this.begin)/(this.end-this.begin);return this.property.interpolate(d.possiblyEvaluate(e,n,a),u,fs(x))}}return u}}class hs{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,n,a){const l=new vs(this._properties);for(const u of Object.keys(this._values))l._values[u]=this._values[u].possiblyEvaluate(e,n,a);return l}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class ks{constructor(e,n,a){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._scope=n,this._options=a,this.isConfigDependent=!1}getValue(e){return po(this._values[e].value)}setValue(e,n){this._values[e]=new ls(this._values[e].property,n===null?void 0:po(n),this._scope,this._options),this.isConfigDependent=this.isConfigDependent||this._values[e].expression.isConfigDependent}serialize(){const e={};for(const n of Object.keys(this._values)){const a=this.getValue(n);a!==void 0&&(e[n]=a)}return e}possiblyEvaluate(e,n,a){const l=new vs(this._properties);for(const u of Object.keys(this._values))l._values[u]=this._values[u].possiblyEvaluate(e,n,a);return l}}class Ur{constructor(e,n,a){this.property=e,this.value=n,this.parameters=a}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,n,a,l){return this.property.evaluate(this.value,this.parameters,e,n,a,l)}}class vs{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class oi{constructor(e){this.specification=e}possiblyEvaluate(e,n){return e.expression.evaluate(n)}interpolate(e,n,a){const l=Pd[this.specification.type];return l?l(e,n,a):e}}class on{constructor(e,n){this.specification=e,this.overrides=n}possiblyEvaluate(e,n,a,l){return new Ur(this,e.expression.kind==="constant"||e.expression.kind==="camera"?{kind:"constant",value:e.expression.evaluate(n,null,{},a,l)}:e.expression,n)}interpolate(e,n,a){if(e.value.kind!=="constant"||n.value.kind!=="constant")return e;if(e.value.value===void 0||n.value.value===void 0)return new Ur(this,{kind:"constant",value:void 0},e.parameters);const l=Pd[this.specification.type];return l?new Ur(this,{kind:"constant",value:l(e.value.value,n.value.value,a)},e.parameters):e}evaluate(e,n,a,l,u,d){return e.kind==="constant"?e.value:e.evaluate(n,a,l,u,d)}}class Eo{constructor(e){this.specification=e}possiblyEvaluate(e,n,a,l){return!!e.expression.evaluate(n,null,{},a,l)}interpolate(){return!1}}class Br{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const n=new ir(0,{});for(const a in e){const l=e[a];l.specification.overridable&&this.overridableProperties.push(a);const u=this.defaultPropertyValues[a]=new ls(l,void 0),d=this.defaultTransitionablePropertyValues[a]=new Zr(l);this.defaultTransitioningPropertyValues[a]=d.untransitioned(),this.defaultPossiblyEvaluatedValues[a]=u.possiblyEvaluate(n)}}}xe(on,"DataDrivenProperty"),xe(oi,"DataConstantProperty"),xe(Eo,"ColorRampProperty");var Pt=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"required":false,"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"imports":{"type":"array","value":"import"},"schema":{"type":"schema"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"},"models":{"type":"models"}},"model":{"type":"string","required":true},"import":{"id":{"type":"string","required":true},"url":{"type":"string","required":true},"config":{"type":"config"},"data":{"type":"$root"}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","property-type":"data-constant","expression":{},"required":true},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string","required":true},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false,"expression":{},"property-type":"data-constant"},"shadow-intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"experimental":true,"type":{"required":true,"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":1}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":1}},"url":{"required":false,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"required":true,"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"raster-particle":{"experimental":true},"hillshade":{},"model":{"experimental":true},"background":{},"sky":{},"slot":{},"clip":{"experimental":true}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{},"property-type":"data-constant","experimental":true}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","experimental":true,"private":true,"default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","experimental":true,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective","property-type":"data-constant"}},"colorTheme":{"data":{"type":"string","property-type":"data-constant","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","private":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"property-type":"data-constant","type":"color","experimental":true,"default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"property-type":"data-constant","type":"number","experimental":true,"default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"property-type":"data-constant","type":"number","experimental":true,"default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"property-type":"data-constant","type":"boolean","default":true,"experimental":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"property-type":"constant"},"line-trim-fade-range":{"type":"array","value":"number","experimental":true,"length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-trim-color":{"type":"color","experimental":true,"default":"transparent","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-border-width":{"type":"number","private":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","private":true,"default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true,"property-type":"data-constant"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-image-cross-fade":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-value"]},"property-type":"color-ramp"},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"raster-array-band":{"type":"string","required":false,"experimental":true,"property-type":"data-constant"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string","required":false,"property-type":"data-constant"},"raster-particle-count":{"type":"number","default":512,"minimum":1,"property-type":"data-constant"},"raster-particle-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-particle-speed"]},"property-type":"color-ramp"},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1,"property-type":"data-constant"},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1,"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_background":{"background-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d","property-type":"data-constant"},"model-cast-shadows":{"type":"boolean","default":true,"expression":{},"property-type":"data-constant"},"model-receive-shadows":{"type":"boolean","default":true,"expression":{},"property-type":"data-constant"},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant","transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"model-front-cutoff":{"type":"array","private":true,"value":"number","property-type":"data-constant","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');function ao(t){return t instanceof Number||t instanceof String||t instanceof Boolean?t.valueOf():t}function yo(t){if(Array.isArray(t))return t.map(yo);if(t instanceof Object&&!(t instanceof Number||t instanceof String||t instanceof Boolean)){const e={};for(const n in t)e[n]=yo(t[n]);return e}return ao(t)}function Ys(t){if(t===!0||t===!1)return!0;if(!Array.isArray(t)||t.length===0)return!1;switch(t[0]){case"has":return t.length>=2&&t[1]!=="$id"&&t[1]!=="$type";case"in":return t.length>=3&&(typeof t[1]!="string"||Array.isArray(t[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return t.length!==3||Array.isArray(t[1])||Array.isArray(t[2]);case"any":case"all":for(const e of t.slice(1))if(!Ys(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}function io(t,e="fill"){if(t==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Ys(t)||(t=qa(t));const n=t;let a=!0;try{a=function(S){if(!Yo(S))return S;let L=yo(S);return ga(L),L=Uo(L),L}(n)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(n,null,2)}
        `)}const l=Pt[`filter_${e}`],u=ie(a,l);let d=null;if(u.result==="error")throw new Error(u.value.map(S=>`${S.key}: ${S.message}`).join(", "));d=(S,L,P)=>u.value.evaluate(S,L,{},P);let x=null,v=null;if(a!==n){const S=ie(n,l);if(S.result==="error")throw new Error(S.value.map(L=>`${L.key}: ${L.message}`).join(", "));x=(L,P,O,V,G)=>S.value.evaluate(L,P,{},O,void 0,void 0,V,G),v=!Lc(S.value.expression)}return{filter:d,dynamicFilter:x||void 0,needGeometry:Ra(a),needFeature:!!v}}function Uo(t){if(!Array.isArray(t))return t;const e=function(n){if(Ia.has(n[0])){for(let a=1;a<n.length;a++)if(Yo(n[a]))return!0}return n}(t);return e===!0?e:e.map(n=>Uo(n))}function ga(t){let e=!1;const n=[];if(t[0]==="case"){for(let a=1;a<t.length-1;a+=2)e=e||Yo(t[a]),n.push(t[a+1]);n.push(t[t.length-1])}else if(t[0]==="match"){e=e||Yo(t[1]);for(let a=2;a<t.length-1;a+=2)n.push(t[a+1]);n.push(t[t.length-1])}else if(t[0]==="step"){e=e||Yo(t[1]);for(let a=1;a<t.length-1;a+=2)n.push(t[a+1])}e&&(t.length=0,t.push("any",...n));for(let a=1;a<t.length;a++)ga(t[a])}function Yo(t){if(!Array.isArray(t))return!1;if((e=t[0])==="pitch"||e==="distance-from-center")return!0;var e;for(let n=1;n<t.length;n++)if(Yo(t[n]))return!0;return!1}const Ia=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function Pa(t,e){return t<e?-1:t>e?1:0}function Ra(t){if(!Array.isArray(t))return!1;if(t[0]==="within"||t[0]==="distance")return!0;for(let e=1;e<t.length;e++)if(Ra(t[e]))return!0;return!1}function qa(t){if(!t)return!0;const e=t[0];return t.length<=1?e!=="any":e==="=="?kc(t[1],t[2],"=="):e==="!="?uc(kc(t[1],t[2],"==")):e==="<"||e===">"||e==="<="||e===">="?kc(t[1],t[2],e):e==="any"?(n=t.slice(1),["any"].concat(n.map(qa))):e==="all"?["all"].concat(t.slice(1).map(qa)):e==="none"?["all"].concat(t.slice(1).map(qa).map(uc)):e==="in"?Mh(t[1],t.slice(2)):e==="!in"?uc(Mh(t[1],t.slice(2))):e==="has"?Th(t[1]):e!=="!has"||uc(Th(t[1]));var n}function kc(t,e,n){switch(t){case"$type":return[`filter-type-${n}`,e];case"$id":return[`filter-id-${n}`,e];default:return[`filter-${n}`,t,e]}}function Mh(t,e){if(e.length===0)return!1;switch(t){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(n=>typeof n!=typeof e[0])?["filter-in-large",t,["literal",e.sort(Pa)]]:["filter-in-small",t,["literal",e]]}}function Th(t){switch(t){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",t]}}function uc(t){return["!",t]}const Bc="";function lu(t,e){return e?`${t}${Bc}${e}`:t}const cu="-transition",dc=new Set(["fill","line","background","hillshade","raster"]);class Ao extends oc{constructor(e,n,a,l,u){if(super(),this.id=e.id,this.fqid=lu(this.id,a),this.type=e.type,this.scope=a,this.lut=l,this.options=u,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.isConfigDependent=!1,e.type!=="custom"&&(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type!=="background"&&e.type!=="sky"&&e.type!=="slot"&&(this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter),e.slot&&(this.slot=e.slot),n.layout&&(this._unevaluatedLayout=new ks(n.layout,this.scope,u),this.isConfigDependent=this.isConfigDependent||this._unevaluatedLayout.isConfigDependent),n.paint)){this._transitionablePaint=new Or(n.paint,this.scope,u);for(const d in e.paint)this.setPaintProperty(d,e.paint[d]);for(const d in e.layout)this.setLayoutProperty(d,e.layout[d]);this.isConfigDependent=this.isConfigDependent||this._transitionablePaint.isConfigDependent,this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new vs(n.paint)}}onAdd(e){}onRemove(e){}isDraped(e){return dc.has(this.type)}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,n){if(this.type==="custom"&&e==="visibility")return void(this.visibility=n);const a=this._unevaluatedLayout;a._properties.properties[e]&&(a.setValue(e,n),this.isConfigDependent=this.isConfigDependent||a.isConfigDependent,e==="visibility"&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0})}getPaintProperty(e){return El(e,cu)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}setPaintProperty(e,n){const a=this._transitionablePaint,l=a._properties.properties;if(El(e,cu)){const P=e.slice(0,-11);return l[P]&&a.setTransition(P,n||void 0),!1}if(!l[e])return!1;const u=a._values[e],d=u.value.isDataDriven(),x=u.value;a.setValue(e,n),this.isConfigDependent=this.isConfigDependent||a.isConfigDependent,this._handleSpecialPaintPropertyUpdate(e);const v=a._values[e].value,S=v.isDataDriven(),L=El(e,"pattern")||e==="line-dasharray";return S||d||L||this._handleOverridablePaintPropertyUpdate(e,x,v)}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getDefaultProgramParams(e,n,a){return null}_handleOverridablePaintPropertyUpdate(e,n,a){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,n){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,n)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,n)}serialize(){return nh({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(e,n)=>!(e===void 0||n==="layout"&&!Object.keys(e).length||n==="paint"&&!Object.keys(e).length))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}isStateDependent(){for(const e in this.paint._values){const n=this.paint.get(e);if(n instanceof Ur&&nd(n.property.specification)&&(n.value.kind==="source"||n.value.kind==="composite")&&n.value.isStateDependent)return!0}return!1}compileFilter(){this._filterCompiled||(this._featureFilter=io(this.filter),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(e){this._stats&&(e.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(e){}queryIntersectsFeature(e,n,a,l,u,d,x,v,S){}queryIntersectsMatchingFeature(e,n,a,l){}}const rd={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Xd{constructor(e,n){this._structArray=e,this._pos1=n*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class Os{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(e,n){return e._trim(),n&&(e.isTransferred=!0,n.add(e.arrayBuffer)),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const n=Object.create(this.prototype);return n.arrayBuffer=e.arrayBuffer,n.length=e.length,n.capacity=e.arrayBuffer.byteLength/n.bytesPerElement,n._refreshViews(),n}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const n=this.uint8;this._refreshViews(),n&&this.uint8.set(n)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...e){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...e){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function rr(t,e=1){let n=0,a=0;return{members:t.map(l=>{const u=rd[l.type].BYTES_PER_ELEMENT,d=n=Nc(n,Math.max(e,u)),x=l.components||1;return a=Math.max(a,u),n+=u*x,{name:l.name,type:l.type,components:x,offset:d}}),size:Nc(n,Math.max(a,e)),alignment:e}}function Nc(t,e){return Math.ceil(t/e)*e}class Fl extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n){const a=this.length;return this.resize(a+1),this.emplace(a,e,n)}emplace(e,n,a){const l=2*e;return this.int16[l+0]=n,this.int16[l+1]=a,e}}Fl.prototype.bytesPerElement=4,xe(Fl,"StructArrayLayout2i4");class $d extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,a){const l=this.length;return this.resize(l+1),this.emplace(l,e,n,a)}emplace(e,n,a,l){const u=3*e;return this.int16[u+0]=n,this.int16[u+1]=a,this.int16[u+2]=l,e}}$d.prototype.bytesPerElement=6,xe($d,"StructArrayLayout3i6");class Sh extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,a,l){const u=this.length;return this.resize(u+1),this.emplace(u,e,n,a,l)}emplace(e,n,a,l,u){const d=4*e;return this.int16[d+0]=n,this.int16[d+1]=a,this.int16[d+2]=l,this.int16[d+3]=u,e}}Sh.prototype.bytesPerElement=8,xe(Sh,"StructArrayLayout4i8");class dl extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,a,l,u){const d=this.length;return this.resize(d+1),this.emplace(d,e,n,a,l,u)}emplace(e,n,a,l,u,d){const x=5*e;return this.int16[x+0]=n,this.int16[x+1]=a,this.int16[x+2]=l,this.int16[x+3]=u,this.int16[x+4]=d,e}}dl.prototype.bytesPerElement=10,xe(dl,"StructArrayLayout5i10");class Eh extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,a,l,u,d,x){const v=this.length;return this.resize(v+1),this.emplace(v,e,n,a,l,u,d,x)}emplace(e,n,a,l,u,d,x,v){const S=6*e,L=12*e,P=3*e;return this.int16[S+0]=n,this.int16[S+1]=a,this.uint8[L+4]=l,this.uint8[L+5]=u,this.uint8[L+6]=d,this.uint8[L+7]=x,this.float32[P+2]=v,e}}Eh.prototype.bytesPerElement=12,xe(Eh,"StructArrayLayout2i4ub1f12");class Uc extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,a,l){const u=this.length;return this.resize(u+1),this.emplace(u,e,n,a,l)}emplace(e,n,a,l,u){const d=4*e;return this.float32[d+0]=n,this.float32[d+1]=a,this.float32[d+2]=l,this.float32[d+3]=u,e}}Uc.prototype.bytesPerElement=16,xe(Uc,"StructArrayLayout4f16");class kl extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,a){const l=this.length;return this.resize(l+1),this.emplace(l,e,n,a)}emplace(e,n,a,l){const u=3*e;return this.float32[u+0]=n,this.float32[u+1]=a,this.float32[u+2]=l,e}}kl.prototype.bytesPerElement=12,xe(kl,"StructArrayLayout3f12");class Ah extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,a,l,u){const d=this.length;return this.resize(d+1),this.emplace(d,e,n,a,l,u)}emplace(e,n,a,l,u,d){const x=6*e,v=3*e;return this.uint16[x+0]=n,this.uint16[x+1]=a,this.uint16[x+2]=l,this.uint16[x+3]=u,this.float32[v+2]=d,e}}Ah.prototype.bytesPerElement=12,xe(Ah,"StructArrayLayout4ui1f12");class Ch extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,a,l){const u=this.length;return this.resize(u+1),this.emplace(u,e,n,a,l)}emplace(e,n,a,l,u){const d=4*e;return this.uint16[d+0]=n,this.uint16[d+1]=a,this.uint16[d+2]=l,this.uint16[d+3]=u,e}}Ch.prototype.bytesPerElement=8,xe(Ch,"StructArrayLayout4ui8");class Vc extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,a,l,u,d){const x=this.length;return this.resize(x+1),this.emplace(x,e,n,a,l,u,d)}emplace(e,n,a,l,u,d,x){const v=6*e;return this.int16[v+0]=n,this.int16[v+1]=a,this.int16[v+2]=l,this.int16[v+3]=u,this.int16[v+4]=d,this.int16[v+5]=x,e}}Vc.prototype.bytesPerElement=12,xe(Vc,"StructArrayLayout6i12");class sd extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,a,l,u,d,x,v,S,L,P,O){const V=this.length;return this.resize(V+1),this.emplace(V,e,n,a,l,u,d,x,v,S,L,P,O)}emplace(e,n,a,l,u,d,x,v,S,L,P,O,V){const G=12*e;return this.int16[G+0]=n,this.int16[G+1]=a,this.int16[G+2]=l,this.int16[G+3]=u,this.uint16[G+4]=d,this.uint16[G+5]=x,this.uint16[G+6]=v,this.uint16[G+7]=S,this.int16[G+8]=L,this.int16[G+9]=P,this.int16[G+10]=O,this.int16[G+11]=V,e}}sd.prototype.bytesPerElement=24,xe(sd,"StructArrayLayout4i4ui4i24");class od extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,a,l,u,d){const x=this.length;return this.resize(x+1),this.emplace(x,e,n,a,l,u,d)}emplace(e,n,a,l,u,d,x){const v=10*e,S=5*e;return this.int16[v+0]=n,this.int16[v+1]=a,this.int16[v+2]=l,this.float32[S+2]=u,this.float32[S+3]=d,this.float32[S+4]=x,e}}od.prototype.bytesPerElement=20,xe(od,"StructArrayLayout3i3f20");class vg extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.uint32[1*e+0]=n,e}}vg.prototype.bytesPerElement=4,xe(vg,"StructArrayLayout1ul4");class pl extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.float32[1*e+0]=n,e}}pl.prototype.bytesPerElement=4,xe(pl,"StructArrayLayout1f4");class Gc extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n){const a=this.length;return this.resize(a+1),this.emplace(a,e,n)}emplace(e,n,a){const l=2*e;return this.uint16[l+0]=n,this.uint16[l+1]=a,e}}Gc.prototype.bytesPerElement=4,xe(Gc,"StructArrayLayout2ui4");class lm extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,a,l,u,d,x,v,S,L,P,O,V){const G=this.length;return this.resize(G+1),this.emplace(G,e,n,a,l,u,d,x,v,S,L,P,O,V)}emplace(e,n,a,l,u,d,x,v,S,L,P,O,V,G){const $=20*e,Y=10*e;return this.int16[$+0]=n,this.int16[$+1]=a,this.int16[$+2]=l,this.int16[$+3]=u,this.int16[$+4]=d,this.float32[Y+3]=x,this.float32[Y+4]=v,this.float32[Y+5]=S,this.float32[Y+6]=L,this.int16[$+14]=P,this.uint32[Y+8]=O,this.uint16[$+18]=V,this.uint16[$+19]=G,e}}lm.prototype.bytesPerElement=40,xe(lm,"StructArrayLayout5i4f1i1ul2ui40");class Vo extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,a,l,u,d,x){const v=this.length;return this.resize(v+1),this.emplace(v,e,n,a,l,u,d,x)}emplace(e,n,a,l,u,d,x,v){const S=8*e;return this.int16[S+0]=n,this.int16[S+1]=a,this.int16[S+2]=l,this.int16[S+4]=u,this.int16[S+5]=d,this.int16[S+6]=x,this.int16[S+7]=v,e}}Vo.prototype.bytesPerElement=16,xe(Vo,"StructArrayLayout3i2i2i16");class fl extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,a,l,u){const d=this.length;return this.resize(d+1),this.emplace(d,e,n,a,l,u)}emplace(e,n,a,l,u,d){const x=4*e,v=8*e;return this.float32[x+0]=n,this.float32[x+1]=a,this.float32[x+2]=l,this.int16[v+6]=u,this.int16[v+7]=d,e}}fl.prototype.bytesPerElement=16,xe(fl,"StructArrayLayout2f1f2i16");class ml extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,a,l){const u=this.length;return this.resize(u+1),this.emplace(u,e,n,a,l)}emplace(e,n,a,l,u){const d=12*e,x=3*e;return this.uint8[d+0]=n,this.uint8[d+1]=a,this.float32[x+1]=l,this.float32[x+2]=u,e}}ml.prototype.bytesPerElement=12,xe(ml,"StructArrayLayout2ub2f12");class no extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,a){const l=this.length;return this.resize(l+1),this.emplace(l,e,n,a)}emplace(e,n,a,l){const u=3*e;return this.uint16[u+0]=n,this.uint16[u+1]=a,this.uint16[u+2]=l,e}}no.prototype.bytesPerElement=6,xe(no,"StructArrayLayout3ui6");class cm extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,n,a,l,u,d,x,v,S,L,P,O,V,G,$,Y,ne,Te,Ae,Ce,qe){const Ge=this.length;return this.resize(Ge+1),this.emplace(Ge,e,n,a,l,u,d,x,v,S,L,P,O,V,G,$,Y,ne,Te,Ae,Ce,qe)}emplace(e,n,a,l,u,d,x,v,S,L,P,O,V,G,$,Y,ne,Te,Ae,Ce,qe,Ge){const ot=30*e,dt=15*e,Rt=60*e;return this.int16[ot+0]=n,this.int16[ot+1]=a,this.int16[ot+2]=l,this.float32[dt+2]=u,this.float32[dt+3]=d,this.uint16[ot+8]=x,this.uint16[ot+9]=v,this.uint32[dt+5]=S,this.uint32[dt+6]=L,this.uint32[dt+7]=P,this.uint16[ot+16]=O,this.uint16[ot+17]=V,this.uint16[ot+18]=G,this.float32[dt+10]=$,this.float32[dt+11]=Y,this.uint8[Rt+48]=ne,this.uint8[Rt+49]=Te,this.uint8[Rt+50]=Ae,this.uint32[dt+13]=Ce,this.int16[ot+28]=qe,this.uint8[Rt+58]=Ge,e}}cm.prototype.bytesPerElement=60,xe(cm,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class hm extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,n,a,l,u,d,x,v,S,L,P,O,V,G,$,Y,ne,Te,Ae,Ce,qe,Ge,ot,dt,Rt,$t,Vt,ai,Ci,ti,bi,Yt,wi,zi){const Si=this.length;return this.resize(Si+1),this.emplace(Si,e,n,a,l,u,d,x,v,S,L,P,O,V,G,$,Y,ne,Te,Ae,Ce,qe,Ge,ot,dt,Rt,$t,Vt,ai,Ci,ti,bi,Yt,wi,zi)}emplace(e,n,a,l,u,d,x,v,S,L,P,O,V,G,$,Y,ne,Te,Ae,Ce,qe,Ge,ot,dt,Rt,$t,Vt,ai,Ci,ti,bi,Yt,wi,zi,Si){const fn=22*e,Ii=44*e,Ui=88*e;return this.float32[fn+0]=n,this.float32[fn+1]=a,this.int16[Ii+4]=l,this.int16[Ii+5]=u,this.int16[Ii+6]=d,this.int16[Ii+7]=x,this.int16[Ii+8]=v,this.int16[Ii+9]=S,this.int16[Ii+10]=L,this.int16[Ii+11]=P,this.int16[Ii+12]=O,this.uint16[Ii+13]=V,this.uint16[Ii+14]=G,this.uint16[Ii+15]=$,this.uint16[Ii+16]=Y,this.uint16[Ii+17]=ne,this.uint16[Ii+18]=Te,this.uint16[Ii+19]=Ae,this.uint16[Ii+20]=Ce,this.uint16[Ii+21]=qe,this.uint16[Ii+22]=Ge,this.uint16[Ii+23]=ot,this.uint16[Ii+24]=dt,this.uint16[Ii+25]=Rt,this.uint16[Ii+26]=$t,this.uint16[Ii+27]=Vt,this.uint32[fn+14]=ai,this.float32[fn+15]=Ci,this.float32[fn+16]=ti,this.float32[fn+17]=bi,this.float32[fn+18]=Yt,this.float32[fn+19]=wi,this.float32[fn+20]=zi,this.uint8[Ui+84]=Si,e}}hm.prototype.bytesPerElement=88,xe(hm,"StructArrayLayout2f9i15ui1ul6f1ub88");class hu extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,a,l,u){const d=this.length;return this.resize(d+1),this.emplace(d,e,n,a,l,u)}emplace(e,n,a,l,u,d){const x=5*e;return this.float32[x+0]=n,this.float32[x+1]=a,this.float32[x+2]=l,this.float32[x+3]=u,this.float32[x+4]=d,e}}hu.prototype.bytesPerElement=20,xe(hu,"StructArrayLayout5f20");class um extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,a,l,u,d,x){const v=this.length;return this.resize(v+1),this.emplace(v,e,n,a,l,u,d,x)}emplace(e,n,a,l,u,d,x,v){const S=7*e;return this.float32[S+0]=n,this.float32[S+1]=a,this.float32[S+2]=l,this.float32[S+3]=u,this.float32[S+4]=d,this.float32[S+5]=x,this.float32[S+6]=v,e}}um.prototype.bytesPerElement=28,xe(um,"StructArrayLayout7f28");class Hc extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n){const a=this.length;return this.resize(a+1),this.emplace(a,e,n)}emplace(e,n,a){const l=2*e;return this.float32[l+0]=n,this.float32[l+1]=a,e}}Hc.prototype.bytesPerElement=8,xe(Hc,"StructArrayLayout2f8");class jc extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,a,l){const u=this.length;return this.resize(u+1),this.emplace(u,e,n,a,l)}emplace(e,n,a,l,u){const d=6*e;return this.uint32[3*e+0]=n,this.uint16[d+2]=a,this.uint16[d+3]=l,this.uint16[d+4]=u,e}}jc.prototype.bytesPerElement=12,xe(jc,"StructArrayLayout1ul3ui12");class Da extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.uint16[1*e+0]=n,e}}Da.prototype.bytesPerElement=2,xe(Da,"StructArrayLayout1ui2");class Yp extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,a,l,u,d,x,v,S,L,P,O,V,G,$,Y){const ne=this.length;return this.resize(ne+1),this.emplace(ne,e,n,a,l,u,d,x,v,S,L,P,O,V,G,$,Y)}emplace(e,n,a,l,u,d,x,v,S,L,P,O,V,G,$,Y,ne){const Te=16*e;return this.float32[Te+0]=n,this.float32[Te+1]=a,this.float32[Te+2]=l,this.float32[Te+3]=u,this.float32[Te+4]=d,this.float32[Te+5]=x,this.float32[Te+6]=v,this.float32[Te+7]=S,this.float32[Te+8]=L,this.float32[Te+9]=P,this.float32[Te+10]=O,this.float32[Te+11]=V,this.float32[Te+12]=G,this.float32[Te+13]=$,this.float32[Te+14]=Y,this.float32[Te+15]=ne,e}}Yp.prototype.bytesPerElement=64,xe(Yp,"StructArrayLayout16f64");class Jp extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,a,l,u,d,x){const v=this.length;return this.resize(v+1),this.emplace(v,e,n,a,l,u,d,x)}emplace(e,n,a,l,u,d,x,v){const S=10*e,L=5*e;return this.uint16[S+0]=n,this.uint16[S+1]=a,this.uint16[S+2]=l,this.uint16[S+3]=u,this.float32[L+2]=d,this.float32[L+3]=x,this.float32[L+4]=v,e}}Jp.prototype.bytesPerElement=20,xe(Jp,"StructArrayLayout4ui3f20");class dm extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e){const n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.int16[1*e+0]=n,e}}dm.prototype.bytesPerElement=2,xe(dm,"StructArrayLayout1i2");class pm extends Os{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(e){const n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.uint8[1*e+0]=n,e}}pm.prototype.bytesPerElement=1,xe(pm,"StructArrayLayout1ub1");class fm extends Xd{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}fm.prototype.size=40;class mm extends lm{get(e){return new fm(this,e)}}xe(mm,"CollisionBoxArray");class gm extends Xd{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}gm.prototype.size=60;class bg extends cm{get(e){return new gm(this,e)}}xe(bg,"PlacedSymbolArray");class Yd extends Xd{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(e){this._structArray.uint32[this._pos4+14]=e}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(e){this._structArray.float32[this._pos4+18]=e}get occlusionState(){return this._structArray.float32[this._pos4+19]}set occlusionState(e){this._structArray.float32[this._pos4+19]=e}get occlusionOpacity(){return this._structArray.float32[this._pos4+20]}set occlusionOpacity(e){this._structArray.float32[this._pos4+20]=e}get hasIconTextFit(){return this._structArray.uint8[this._pos1+84]}}Yd.prototype.size=88;class _m extends hm{get(e){return new Yd(this,e)}}xe(_m,"SymbolInstanceArray");class wg extends pl{getoffsetX(e){return this.float32[1*e+0]}}xe(wg,"GlyphOffsetArray");class ym extends Fl{getx(e){return this.int16[2*e+0]}gety(e){return this.int16[2*e+1]}}xe(ym,"SymbolLineVertexArray");class Mg extends Xd{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}Mg.prototype.size=12;class xm extends jc{get(e){return new Mg(this,e)}}xe(xm,"FeatureIndexArray");class vm extends Gc{geta_centroid_pos0(e){return this.uint16[2*e+0]}geta_centroid_pos1(e){return this.uint16[2*e+1]}}xe(vm,"FillExtrusionCentroidArray");const Tg=rr([{name:"a_pos",components:2,type:"Int16"}],4),Sg=rr([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class Ts{constructor(e=[]){this.segments=e}_prepareSegment(e,n,a,l){let u=this.segments[this.segments.length-1];return e>Ts.MAX_VERTEX_ARRAY_LENGTH&&Is(`Max vertices per segment is ${Ts.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!u||u.vertexLength+e>Ts.MAX_VERTEX_ARRAY_LENGTH||u.sortKey!==l)&&(u={vertexOffset:n,primitiveOffset:a,vertexLength:0,primitiveLength:0},l!==void 0&&(u.sortKey=l),this.segments.push(u)),u}prepareSegment(e,n,a,l){return this._prepareSegment(e,n.length,a.length,l)}get(){return this.segments}destroy(){for(const e of this.segments)for(const n in e.vaos)e.vaos[n].destroy()}static simpleSegment(e,n,a,l){return new Ts([{vertexOffset:e,primitiveOffset:n,vertexLength:a,primitiveLength:l,vaos:{},sortKey:0}])}}function Eg(t,e){return 256*(t=pn(Math.floor(t),0,255))+pn(Math.floor(e),0,255)}Ts.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,xe(Ts,"SegmentVector");const bm=rr([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),Ag=rr([{name:"a_dash",components:4,type:"Uint16"}]);class Jd{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(e,n,a,l){this.ids.push($_(e)),this.positions.push(n,a,l)}eachPosition(e,n){const a=$_(e);let l=0,u=this.ids.length-1;for(;l<u;){const d=l+u>>1;this.ids[d]>=a?u=d:l=d+1}for(;this.ids[l]===a;)n(this.positions[3*l],this.positions[3*l+1],this.positions[3*l+2]),l++}static serialize(e,n){const a=new Float64Array(e.ids),l=new Uint32Array(e.positions);return wm(a,l,0,a.length-1),n&&(n.add(a.buffer),n.add(l.buffer)),{ids:a,positions:l}}static deserialize(e){const n=new Jd;let a;n.ids=e.ids,n.positions=e.positions;for(const l of n.ids)l!==a&&n.uniqueIds.push(l),a=l;return n.indexed=!0,n}}function $_(t){const e=+t;return!isNaN(e)&&Number.MIN_SAFE_INTEGER<=e&&e<=Number.MAX_SAFE_INTEGER?e:Fu(String(t))}function wm(t,e,n,a){for(;n<a;){const l=t[n+a>>1];let u=n-1,d=a+1;for(;;){do u++;while(t[u]<l);do d--;while(t[d]>l);if(u>=d)break;Kp(t,u,d),Kp(e,3*u,3*d),Kp(e,3*u+1,3*d+1),Kp(e,3*u+2,3*d+2)}d-n<a-d?(wm(t,e,n,d),n=d+1):(wm(t,e,d+1,a),a=d)}}function Kp(t,e,n){const a=t[e];t[e]=t[n],t[n]=a}xe(Jd,"FeaturePositionMap");class Wc{constructor(e){this.gl=e.gl,this.initialized=!1}fetchUniformLocation(e,n){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(e,n),this.initialized=!0),!!this.location}set(e,n,a){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class Qp extends Wc{constructor(e){super(e),this.current=0}set(e,n,a){this.fetchUniformLocation(e,n)&&this.current!==a&&(this.current=a,this.gl.uniform1i(this.location,a))}}class Jo extends Wc{constructor(e){super(e),this.current=0}set(e,n,a){this.fetchUniformLocation(e,n)&&this.current!==a&&(this.current=a,this.gl.uniform1f(this.location,a))}}class Lh extends Wc{constructor(e){super(e),this.current=[0,0]}set(e,n,a){this.fetchUniformLocation(e,n)&&(a[0]===this.current[0]&&a[1]===this.current[1]||(this.current=a,this.gl.uniform2f(this.location,a[0],a[1])))}}class Kd extends Wc{constructor(e){super(e),this.current=[0,0,0]}set(e,n,a){this.fetchUniformLocation(e,n)&&(a[0]===this.current[0]&&a[1]===this.current[1]&&a[2]===this.current[2]||(this.current=a,this.gl.uniform3f(this.location,a[0],a[1],a[2])))}}class ef extends Wc{constructor(e){super(e),this.current=[0,0,0,0]}set(e,n,a){this.fetchUniformLocation(e,n)&&(a[0]===this.current[0]&&a[1]===this.current[1]&&a[2]===this.current[2]&&a[3]===this.current[3]||(this.current=a,this.gl.uniform4f(this.location,a[0],a[1],a[2],a[3])))}}class Cg extends Wc{constructor(e){super(e),this.current=Yr.transparent.toRenderColor(null)}set(e,n,a){this.fetchUniformLocation(e,n)&&(a.r===this.current.r&&a.g===this.current.g&&a.b===this.current.b&&a.a===this.current.a||(this.current=a,this.gl.uniform4f(this.location,a.r,a.g,a.b,a.a)))}}const Y_=new Float32Array(16);class Qd extends Wc{constructor(e){super(e),this.current=Y_}set(e,n,a){if(this.fetchUniformLocation(e,n)){if(a[12]!==this.current[12]||a[0]!==this.current[0])return this.current=a,void this.gl.uniformMatrix4fv(this.location,!1,a);for(let l=1;l<16;l++)if(a[l]!==this.current[l]){this.current=a,this.gl.uniformMatrix4fv(this.location,!1,a);break}}}}const J_=new Float32Array(9),K_=new Float32Array(4);class Mm extends Wc{constructor(e){super(e),this.current=K_}set(e,n,a){if(this.fetchUniformLocation(e,n)){for(let l=0;l<4;l++)if(a[l]!==this.current[l]){this.current=a,this.gl.uniformMatrix2fv(this.location,!1,a);break}}}}function Tm(t){return[Eg(255*t.r,255*t.g),Eg(255*t.b,255*t.a)]}class pc{constructor(e,n,a,l){this.value=e,this.uniformNames=n.map(u=>`u_${u}`),this.type=a,this.context=l}setUniform(e,n,a,l,u){const d=l.constantOr(this.value);n.set(e,u,d instanceof Yr?d.toRenderColor(this.context.lut):d)}getBinding(e,n){return this.type==="color"?new Cg(e):new Jo(e)}}class ad{constructor(e,n){this.uniformNames=n.map(a=>`u_${a}`),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(e){this.pixelRatio=e.pixelRatio||1,this.pattern=e.tl.concat(e.br)}setUniform(e,n,a,l,u){const d=u==="u_pattern"||u==="u_dash"?this.pattern:u==="u_pixel_ratio"?this.pixelRatio:null;d&&n.set(e,u,d)}getBinding(e,n){return n==="u_pattern"||n==="u_dash"?new ef(e):new Jo(e)}}class Ih{constructor(e,n,a,l){this.expression=e,this.type=a,this.maxValue=0,this.paintVertexAttributes=n.map(u=>({name:`a_${u}`,type:"Float32",components:a==="color"?2:1,offset:0})),this.paintVertexArray=new l}populatePaintArray(e,n,a,l,u,d,x){const v=this.paintVertexArray.length,S=this.expression.evaluate(new ir(0,{brightness:d}),n,{},u,l,x);this.paintVertexArray.resize(e),this._setPaintValue(v,e,S,this.context)}updatePaintArray(e,n,a,l,u,d,x){const v=this.expression.evaluate({zoom:0,brightness:x},a,l,void 0,u);this._setPaintValue(e,n,v,this.context)}_setPaintValue(e,n,a,l){if(this.type==="color"){const u=Tm(a.toRenderColor(l.lut));for(let d=e;d<n;d++)this.paintVertexArray.emplace(d,u[0],u[1])}else{for(let u=e;u<n;u++)this.paintVertexArray.emplace(u,a);this.maxValue=Math.max(this.maxValue,Math.abs(a))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class ra{constructor(e,n,a,l,u,d){this.expression=e,this.uniformNames=n.map(x=>`u_${x}_t`),this.type=a,this.useIntegerZoom=l,this.context=u,this.maxValue=0,this.paintVertexAttributes=n.map(x=>({name:`a_${x}`,type:"Float32",components:a==="color"?4:2,offset:0})),this.paintVertexArray=new d}populatePaintArray(e,n,a,l,u,d,x){const v=this.expression.evaluate(new ir(this.context.zoom,{brightness:d}),n,{},u,l,x),S=this.expression.evaluate(new ir(this.context.zoom+1,{brightness:d}),n,{},u,l,x),L=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(L,e,v,S,this.context)}updatePaintArray(e,n,a,l,u,d,x){const v=this.expression.evaluate({zoom:this.context.zoom,brightness:x},a,l,void 0,u),S=this.expression.evaluate({zoom:this.context.zoom+1,brightness:x},a,l,void 0,u);this._setPaintValue(e,n,v,S,this.context)}_setPaintValue(e,n,a,l,u){if(this.type==="color"){const d=Tm(a.toRenderColor(u.lut)),x=Tm(a.toRenderColor(u.lut));for(let v=e;v<n;v++)this.paintVertexArray.emplace(v,d[0],d[1],x[0],x[1])}else{for(let d=e;d<n;d++)this.paintVertexArray.emplace(d,a,l);this.maxValue=Math.max(this.maxValue,Math.abs(a),Math.abs(l))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,n,a,l,u){const d=this.useIntegerZoom?Math.floor(a.zoom):a.zoom,x=pn(this.expression.interpolationFactor(d,this.context.zoom,this.context.zoom+1),0,1);n.set(e,u,x)}getBinding(e,n){return new Jo(e)}}class qc{constructor(e,n,a,l,u){this.expression=e,this.layerId=u,this.paintVertexAttributes=(a==="array"?Ag:bm).members;for(let d=0;d<n.length;++d);this.paintVertexArray=new l}populatePaintArray(e,n,a,l){const u=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValues(u,e,n.patterns&&n.patterns[this.layerId],a)}updatePaintArray(e,n,a,l,u,d,x){this._setPaintValues(e,n,a.patterns&&a.patterns[this.layerId],d)}_setPaintValues(e,n,a,l){if(!l||!a)return;const u=l[a];if(!u)return;const{tl:d,br:x,pixelRatio:v}=u;for(let S=e;S<n;S++)this.paintVertexArray.emplace(S,d[0],d[1],x[0],x[1],v)}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class gl{constructor(e,n,a=()=>!0){this.binders={},this._buffers=[],this.context=n;const l=[];for(const u in e.paint._values){const d=e.paint.get(u);if(!a(u)||!(d instanceof Ur&&nd(d.property.specification)))continue;const x=ld(u,e.type),v=d.value,S=d.property.specification.type,L=!!d.property.useIntegerZoom,P=u==="line-dasharray"||u.endsWith("pattern"),O=u==="line-dasharray"&&e.layout.get("line-cap").value.kind!=="constant";if(v.kind!=="constant"||O)if(v.kind==="source"||O||P){const V=ty(u,S,"source");this.binders[u]=P?new qc(v,x,S,V,e.id):new Ih(v,x,S,V),l.push(`/a_${u}`)}else{const V=ty(u,S,"composite");this.binders[u]=new ra(v,x,S,L,n,V),l.push(`/z_${u}`)}else this.binders[u]=P?new ad(v.value,x):new pc(v.value,x,S,n),l.push(`/u_${u}`)}this.cacheKey=l.sort().join("")}getMaxValue(e){const n=this.binders[e];return n instanceof Ih||n instanceof ra?n.maxValue:0}populatePaintArrays(e,n,a,l,u,d,x){for(const v in this.binders){const S=this.binders[v];S.context=this.context,(S instanceof Ih||S instanceof ra||S instanceof qc)&&S.populatePaintArray(e,n,a,l,u,d,x)}}setConstantPatternPositions(e){for(const n in this.binders){const a=this.binders[n];a instanceof ad&&a.setConstantPatternPositions(e)}}updatePaintArrays(e,n,a,l,u,d,x,v){let S=!1;const L=Object.keys(e),P=L.length!==0,O=P?L:n.uniqueIds;this.context.lut=u.lut;for(const V in this.binders){const G=this.binders[V];if(G.context=this.context,(G instanceof Ih||G instanceof ra||G instanceof qc)&&(G.expression.isStateDependent===!0||G.expression.isLightConstant===!1)){const $=u.paint.get(V);G.expression=$.value;for(const Y of O){const ne=e[Y.toString()];n.eachPosition(Y,(Te,Ae,Ce)=>{const qe=l.feature(Te);G.updatePaintArray(Ae,Ce,qe,ne,d,x,v)})}if(!P)for(const Y of a.uniqueIds){const ne=e[Y.toString()];a.eachPosition(Y,(Te,Ae,Ce)=>{const qe=l.feature(Te);G.updatePaintArray(Ae,Ce,qe,ne,d,x,v)})}S=!0}}return S}defines(){const e=[];for(const n in this.binders){const a=this.binders[n];(a instanceof pc||a instanceof ad)&&e.push(...a.uniformNames.map(l=>`#define HAS_UNIFORM_${l}`))}return e}getBinderAttributes(){const e=[];for(const n in this.binders){const a=this.binders[n];if(a instanceof Ih||a instanceof ra||a instanceof qc)for(let l=0;l<a.paintVertexAttributes.length;l++)e.push(a.paintVertexAttributes[l].name)}return e}getBinderUniforms(){const e=[];for(const n in this.binders){const a=this.binders[n];if(a instanceof pc||a instanceof ad||a instanceof ra)for(const l of a.uniformNames)e.push(l)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e){const n=[];for(const a in this.binders){const l=this.binders[a];if(l instanceof pc||l instanceof ad||l instanceof ra)for(const u of l.uniformNames)n.push({name:u,property:a,binding:l.getBinding(e,u)})}return n}setUniforms(e,n,a,l,u){for(const{name:d,property:x,binding:v}of a)this.binders[x].setUniform(e,v,u,l.get(x),d)}updatePaintBuffers(){this._buffers=[];for(const e in this.binders){const n=this.binders[e];(n instanceof Ih||n instanceof ra||n instanceof qc)&&n.paintVertexBuffer&&this._buffers.push(n.paintVertexBuffer)}}upload(e){for(const n in this.binders){const a=this.binders[n];(a instanceof Ih||a instanceof ra||a instanceof qc)&&a.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const n=this.binders[e];(n instanceof Ih||n instanceof ra||n instanceof qc)&&n.destroy()}}}class Ph{constructor(e,n,a=()=>!0){this.programConfigurations={};for(const l of e)this.programConfigurations[l.id]=new gl(l,n,a);this.needsUpload=!1,this._featureMap=new Jd,this._featureMapWithoutIds=new Jd,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(e,n,a,l,u,d,x,v){for(const S in this.programConfigurations)this.programConfigurations[S].populatePaintArrays(e,n,l,u,d,x,v);n.id!==void 0?this._featureMap.add(n.id,a,this._bufferOffset,e):(this._featureMapWithoutIds.add(this._idlessCounter,a,this._bufferOffset,e),this._idlessCounter+=1),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,n,a,l,u,d){for(const x of a)this.needsUpload=this.programConfigurations[x.id].updatePaintArrays(e,this._featureMap,this._featureMapWithoutIds,n,x,l,u,d||0)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const n in this.programConfigurations)this.programConfigurations[n].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}const W0={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]};function ld(t,e){return W0[t]||[t.replace(`${e}-`,"").replace(/-/g,"_")]}const Q_={"line-pattern":{source:Ah,composite:Ah},"fill-pattern":{source:Ah,composite:Ah},"fill-extrusion-pattern":{source:Ah,composite:Ah},"line-dasharray":{source:Ch,composite:Ch}},ey={color:{source:Hc,composite:Uc},number:{source:pl,composite:Hc}};function ty(t,e,n){const a=Q_[t];return a&&a[n]||ey[e][n]}xe(pc,"ConstantBinder"),xe(ad,"PatternConstantBinder"),xe(Ih,"SourceExpressionBinder"),xe(qc,"PatternCompositeBinder"),xe(ra,"CompositeExpressionBinder"),xe(gl,"ProgramConfiguration",{omit:["_buffers"]}),xe(Ph,"ProgramConfigurationSet");const _a=ji/Math.PI/2,tf=5,iy=6,q0=16383,ep=64,Lg=[ep,32,16],Bl=-_a,Nl=_a;function tp(t,e,n,a=_a){return n=Pn(n),[t*Math.sin(n)*a,-e*a,t*Math.cos(n)*a]}function us(t,e,n){return tp(Math.cos(Pn(t)),Math.sin(Pn(t)),e,n)}const cd=63710088e-1,Ig=2*Math.PI*cd;class Gr{constructor(e,n){if(isNaN(e)||isNaN(n))throw new Error(`Invalid LngLat object: (${e}, ${n})`);if(this.lng=+e,this.lat=+n,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Gr(To(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){const n=Math.PI/180,a=this.lat*n,l=e.lat*n,u=Math.sin(a)*Math.sin(l)+Math.cos(a)*Math.cos(l)*Math.cos((e.lng-this.lng)*n);return cd*Math.acos(Math.min(u,1))}toBounds(e=0){const n=360*e/40075017,a=n/Math.cos(Math.PI/180*this.lat);return new fc({lng:this.lng-a,lat:this.lat-n},{lng:this.lng+a,lat:this.lat+n})}toEcef(e){return us(this.lat,this.lng,_a+e*_a/cd)}static convert(e){if(e instanceof Gr)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new Gr(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new Gr(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class fc{constructor(e,n){if(e)if(n)this.setSouthWest(e).setNorthEast(n);else if(e.length===4){const a=e;this.setSouthWest([a[0],a[1]]).setNorthEast([a[2],a[3]])}else{const a=e;this.setSouthWest(a[0]).setNorthEast(a[1])}}setNorthEast(e){return this._ne=e instanceof Gr?new Gr(e.lng,e.lat):Gr.convert(e),this}setSouthWest(e){return this._sw=e instanceof Gr?new Gr(e.lng,e.lat):Gr.convert(e),this}extend(e){const n=this._sw,a=this._ne;let l,u;if(e instanceof Gr)l=e,u=e;else{if(!(e instanceof fc))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(fc.convert(e)):this.extend(Gr.convert(e)):typeof e=="object"&&e!==null&&e.hasOwnProperty("lat")&&(e.hasOwnProperty("lon")||e.hasOwnProperty("lng"))?this.extend(Gr.convert(e)):this;if(l=e._sw,u=e._ne,!l||!u)return this}return n||a?(n.lng=Math.min(l.lng,n.lng),n.lat=Math.min(l.lat,n.lat),a.lng=Math.max(u.lng,a.lng),a.lat=Math.max(u.lat,a.lat)):(this._sw=new Gr(l.lng,l.lat),this._ne=new Gr(u.lng,u.lat)),this}getCenter(){return new Gr((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new Gr(this.getWest(),this.getNorth())}getSouthEast(){return new Gr(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:n,lat:a}=Gr.convert(e);let l=this._sw.lng<=n&&n<=this._ne.lng;return this._sw.lng>this._ne.lng&&(l=this._sw.lng>=n&&n>=this._ne.lng),this._sw.lat<=a&&a<=this._ne.lat&&l}static convert(e){return!e||e instanceof fc?e:new fc(e)}}var Pg={};(function(t,e){(function(n){function a(u,d,x){var v=l(256*u,256*(d=Math.pow(2,x)-d-1),x),S=l(256*(u+1),256*(d+1),x);return v[0]+","+v[1]+","+S[0]+","+S[1]}function l(u,d,x){var v=2*Math.PI*6378137/256/Math.pow(2,x);return[u*v-2*Math.PI*6378137/2,d*v-2*Math.PI*6378137/2]}n.getURL=function(u,d,x,v,S,L){return L=L||{},u+"?"+["bbox="+a(x,v,S),"format="+(L.format||"image/png"),"service="+(L.service||"WMS"),"version="+(L.version||"1.1.1"),"request="+(L.request||"GetMap"),"srs="+(L.srs||"EPSG:3857"),"width="+(L.width||256),"height="+(L.height||256),"layers="+d].join("&")},n.getTileBBox=a,n.getMercCoords=l,Object.defineProperty(n,"__esModule",{value:!0})})(e)})(0,Pg);var ny=Pg;class uu{constructor(e,n,a){this.z=e,this.x=n,this.y=a,this.key=Zc(0,e,e,n,a)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}url(e,n){const a=ny.getTileBBox(this.x,this.y,this.z),l=function(u,d,x){let v,S="";for(let L=u;L>0;L--)v=1<<L-1,S+=(d&v?1:0)+(x&v?2:0);return S}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(n==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",l).replace("{bbox-epsg-3857}",a)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Sm{constructor(e,n){this.wrap=e,this.canonical=n,this.key=Zc(e,n.z,n.z,n.x,n.y)}}class lo{constructor(e,n,a,l,u){this.overscaledZ=e,this.wrap=n,this.canonical=new uu(a,+l,+u),this.key=n===0&&e===a?this.canonical.key:Zc(n,e,a,l,u)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){const n=this.canonical.z-e;return e>this.canonical.z?new lo(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new lo(e,this.wrap,e,this.canonical.x>>n,this.canonical.y>>n)}calculateScaledKey(e,n=!0){if(this.overscaledZ===e&&n)return this.key;if(e>this.canonical.z)return Zc(this.wrap*+n,e,this.canonical.z,this.canonical.x,this.canonical.y);{const a=this.canonical.z-e;return Zc(this.wrap*+n,e,e,this.canonical.x>>a,this.canonical.y>>a)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;const n=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.z<this.canonical.z&&e.canonical.x===this.canonical.x>>n&&e.canonical.y===this.canonical.y>>n}children(e){if(this.overscaledZ>=e)return[new lo(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const n=this.canonical.z+1,a=2*this.canonical.x,l=2*this.canonical.y;return[new lo(n,this.wrap,n,a,l),new lo(n,this.wrap,n,a+1,l),new lo(n,this.wrap,n,a,l+1),new lo(n,this.wrap,n,a+1,l+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new lo(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new lo(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Sm(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function Zc(t,e,n,a,l){const u=1<<Math.min(n,22);let d=u*(l%u)+a%u;return t&&n<22&&(d+=u*u*((t<0?-2*t-1:2*t)%(1<<2*(22-n)))),16*(32*d+n)+(e-n)}const ry=[t=>{let e=t.canonical.x-1,n=t.wrap;return e<0&&(e=(1<<t.canonical.z)-1,n--),new lo(t.overscaledZ,n,t.canonical.z,e,t.canonical.y)},t=>{let e=t.canonical.x+1,n=t.wrap;return e===1<<t.canonical.z&&(e=0,n++),new lo(t.overscaledZ,n,t.canonical.z,e,t.canonical.y)},t=>new lo(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,(t.canonical.y===0?1<<t.canonical.z:t.canonical.y)-1),t=>new lo(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y===(1<<t.canonical.z)-1?0:t.canonical.y+1)];xe(uu,"CanonicalTileID"),xe(lo,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const Em=0,sy=25.5;function Am(t){return Ig*Math.cos(t*Math.PI/180)}function mc(t){return(180+t)/360}function sa(t){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+t*Math.PI/360)))/360}function Go(t,e){return t/Am(e)}function oa(t){return 360*t-180}function Co(t){return 360/Math.PI*Math.atan(Math.exp((180-360*t)*Math.PI/180))-90}function Rg(t,e){return t*Am(Co(e))}const Js=85.051129;function Dg(t){return Math.cos(Pn(pn(t,-Js,Js)))}function du(t,e){const n=pn(e,Em,sy),a=Math.pow(2,n);return Dg(t)*Ig/(512*a)}function zg(t){return 1/Math.cos(t*Math.PI/180)}function nf(t,e=0){const n=Math.exp(Math.PI*(1-(t.y+e/ji)/(1<<t.z)*2));return 80150034*n/(n*n+1)/ji/(1<<t.z)}class Lo{constructor(e,n,a=0){this.x=+e,this.y=+n,this.z=+a}static fromLngLat(e,n=0){const a=Gr.convert(e);return new Lo(mc(a.lng),sa(a.lat),Go(n,a.lat))}toLngLat(){return new Gr(oa(this.x),Co(this.y))}toAltitude(){return Rg(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/Ig*zg(Co(this.y))}}function Cm(t,e,n,a,l,u,d,x,v){const S=(e+a)/2,L=(n+l)/2,P=new Kt(S,L);x(P),function(O,V,G,$,Y,ne){const Te=G-Y,Ae=$-ne;return Math.abs(($-V)*Te-(G-O)*Ae)/Math.hypot(Te,Ae)}(P.x,P.y,u.x,u.y,d.x,d.y)>=v?(Cm(t,e,n,S,L,u,P,x,v),Cm(t,S,L,a,l,P,d,x,v)):t.push(d)}function rf(t,e,n){let a=t[0],l=a.x,u=a.y;e(a);const d=[a];for(let x=1;x<t.length;x++){const v=t[x],{x:S,y:L}=v;e(v),Cm(d,l,u,S,L,a,v,e,n),l=S,u=L,a=v}return d}function co(t,e,n,a){if(a(e,n)){const l=e.add(n)._mult(.5);co(t,e,l,a),co(t,l,n,a)}else t.push(n)}function Io(t,e){let n=t[0];const a=[n];for(let l=1;l<t.length;l++){const u=t[l];co(a,n,u,e),n=u}return a}const ip=Math.pow(2,14)-1,Og=-ip-1;function oy(t,e){const n=Math.round(t.x*e),a=Math.round(t.y*e);return t.x=pn(n,Og,ip),t.y=pn(a,Og,ip),(n<t.x||n>t.x+1||a<t.y||a>t.y+1)&&Is("Geometry exceeds allowed extent, reduce your vector tile buffer size"),t}function Za(t,e,n){const a=t.loadGeometry(),l=t.extent,u=ji/l;if(e&&n&&n.projection.isReprojectedInTileSpace){const d=1<<e.z,{scale:x,x:v,y:S,projection:L}=n,P=O=>{const V=oa((e.x+O.x/l)/d),G=Co((e.y+O.y/l)/d),$=L.project(V,G);O.x=($.x*x-v)*l,O.y=($.y*x-S)*l};for(let O=0;O<a.length;O++)if(t.type!==1)a[O]=rf(a[O],P,1);else{const V=[];for(const G of a[O])G.x<0||G.x>=l||G.y<0||G.y>=l||(P(G),V.push(G));a[O]=V}}for(const d of a)for(const x of d)oy(x,u);return a}function gc(t,e){return{type:t.type,id:t.id,properties:t.properties,geometry:e?Za(t):[]}}function sf(t,e,n,a,l){t.emplaceBack(2*e+(a+1)/2,2*n+(l+1)/2)}function of(t,e,n){t.emplaceBack(e.x,e.y,e.z,n[0]*16384,n[1]*16384,n[2]*16384)}class Fg{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new Fl,this.indexArray=new no,this.segments=new Ts,this.programConfigurations=new Ph(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id)}updateFootprints(e,n){}populate(e,n,a,l){const u=this.layers[0],d=[];let x=null;u.type==="circle"&&(x=u.layout.get("circle-sort-key"));for(const{feature:S,id:L,index:P,sourceLayerIndex:O}of e){const V=this.layers[0]._featureFilter.needGeometry,G=gc(S,V);if(!this.layers[0]._featureFilter.filter(new ir(this.zoom),G,a))continue;const $=x?x.evaluate(G,{},a):void 0,Y={id:L,properties:S.properties,type:S.type,sourceLayerIndex:O,index:P,geometry:V?G.geometry:Za(S,a,l),patterns:{},sortKey:$};d.push(Y)}x&&d.sort((S,L)=>S.sortKey-L.sortKey);let v=null;l.projection.name==="globe"&&(this.globeExtVertexArray=new Vc,v=l.projection);for(const S of d){const{geometry:L,index:P,sourceLayerIndex:O}=S,V=e[P].feature;this.addFeature(S,L,P,n.availableImages,a,v,n.brightness),n.featureIndex.insert(V,L,P,O,this.index)}}update(e,n,a,l,u){const d=Object.keys(e).length!==0;d&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(e,n,d?this.stateDependentLayers:this.layers,a,l,u)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Tg.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,Sg.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(e,n,a,l,u,d,x){for(const v of n)for(const S of v){const L=S.x,P=S.y;if(L<0||L>=ji||P<0||P>=ji)continue;if(d){const G=d.projectTilePoint(L,P,u),$=d.upVector(u,L,P),Y=this.globeExtVertexArray;of(Y,G,$),of(Y,G,$),of(Y,G,$),of(Y,G,$)}const O=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),V=O.vertexLength;sf(this.layoutVertexArray,L,P,-1,-1),sf(this.layoutVertexArray,L,P,1,-1),sf(this.layoutVertexArray,L,P,1,1),sf(this.layoutVertexArray,L,P,-1,1),this.indexArray.emplaceBack(V,V+1,V+2),this.indexArray.emplaceBack(V,V+2,V+3),O.vertexLength+=4,O.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,a,{},l,u,x)}}function kg(t,e){for(let n=0;n<t.length;n++)if(z(e,t[n]))return!0;for(let n=0;n<e.length;n++)if(z(t,e[n]))return!0;return!!g(t,e)}function M(t,e,n){return!!z(t,e)||!!w(e,t,n)}function i(t,e){if(t.length===1)return R(e,t[0]);for(let n=0;n<e.length;n++){const a=e[n];for(let l=0;l<a.length;l++)if(z(t,a[l]))return!0}for(let n=0;n<t.length;n++)if(R(e,t[n]))return!0;for(let n=0;n<e.length;n++)if(g(t,e[n]))return!0;return!1}function c(t,e,n){if(t.length>1){if(g(t,e))return!0;for(let a=0;a<e.length;a++)if(w(e[a],t,n))return!0}for(let a=0;a<t.length;a++)if(w(t[a],e,n))return!0;return!1}function g(t,e){if(t.length===0||e.length===0)return!1;for(let n=0;n<t.length-1;n++){const a=t[n],l=t[n+1];for(let u=0;u<e.length-1;u++)if(_(a,l,e[u],e[u+1]))return!0}return!1}function _(t,e,n,a){return gs(t,n,a)!==gs(e,n,a)&&gs(t,e,n)!==gs(t,e,a)}function w(t,e,n){const a=n*n;if(e.length===1)return t.distSqr(e[0])<a;for(let l=1;l<e.length;l++)if(A(t,e[l-1],e[l])<a)return!0;return!1}function A(t,e,n){const a=e.distSqr(n);if(a===0)return t.distSqr(e);const l=((t.x-e.x)*(n.x-e.x)+(t.y-e.y)*(n.y-e.y))/a;return t.distSqr(l<0?e:l>1?n:n.sub(e)._mult(l)._add(e))}function R(t,e){let n,a,l,u=!1;for(let d=0;d<t.length;d++){n=t[d];for(let x=0,v=n.length-1;x<n.length;v=x++)a=n[x],l=n[v],a.y>e.y!=l.y>e.y&&e.x<(l.x-a.x)*(e.y-a.y)/(l.y-a.y)+a.x&&(u=!u)}return u}function z(t,e){let n=!1;for(let a=0,l=t.length-1;a<t.length;l=a++){const u=t[a],d=t[l];u.y>e.y!=d.y>e.y&&e.x<(d.x-u.x)*(e.y-u.y)/(d.y-u.y)+u.x&&(n=!n)}return n}function F(t,e,n,a,l){for(const d of t)if(e<=d.x&&n<=d.y&&a>=d.x&&l>=d.y)return!0;const u=[new Kt(e,n),new Kt(e,l),new Kt(a,l),new Kt(a,n)];if(t.length>2){for(const d of u)if(z(t,d))return!0}for(let d=0;d<t.length-1;d++)if(W(t[d],t[d+1],u))return!0;return!1}function W(t,e,n){const a=n[0],l=n[2];if(t.x<a.x&&e.x<a.x||t.x>l.x&&e.x>l.x||t.y<a.y&&e.y<a.y||t.y>l.y&&e.y>l.y)return!1;const u=gs(t,e,n[0]);return u!==gs(t,e,n[1])||u!==gs(t,e,n[2])||u!==gs(t,e,n[3])}function q(t,e,n,a,l,u){let d=e.y-t.y,x=t.x-e.x;if(u=u||0){const v=d*d+x*x;if(v===0)return!0;const S=Math.sqrt(v);d/=S,x/=S}return!((n.x-t.x)*d+(n.y-t.y)*x-u<0||(a.x-t.x)*d+(a.y-t.y)*x-u<0||(l.x-t.x)*d+(l.y-t.y)*x-u<0)}function J(t,e,n,a,l,u,d){return!(q(t,e,a,l,u,d)||q(e,n,a,l,u,d)||q(n,t,a,l,u,d)||q(a,l,t,e,n,d)||q(l,u,t,e,n,d)||q(u,a,t,e,n,d))}function K(t,e,n){const a=e.paint.get(t).value;return a.kind==="constant"?a.value:n.programConfigurations.get(e.id).getMaxValue(t)}function re(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])}function ce(t,e,n,a,l){if(!e[0]&&!e[1])return t;const u=Kt.convert(e)._mult(l);n==="viewport"&&u._rotate(-a);const d=[];for(let x=0;x<t.length;x++)d.push(t[x].sub(u));return d}function Me(t,e,n,a){const l=Kt.convert(t)._mult(a);return e==="viewport"&&l._rotate(-n),l}xe(Fg,"CircleBucket",{omit:["layers"]});const de=new Br({"circle-sort-key":new on(Pt.layout_circle["circle-sort-key"]),visibility:new oi(Pt.layout_circle.visibility)});var Xe={paint:new Br({"circle-radius":new on(Pt.paint_circle["circle-radius"]),"circle-color":new on(Pt.paint_circle["circle-color"]),"circle-blur":new on(Pt.paint_circle["circle-blur"]),"circle-opacity":new on(Pt.paint_circle["circle-opacity"]),"circle-translate":new oi(Pt.paint_circle["circle-translate"]),"circle-translate-anchor":new oi(Pt.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new oi(Pt.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new oi(Pt.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new on(Pt.paint_circle["circle-stroke-width"]),"circle-stroke-color":new on(Pt.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new on(Pt.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new oi(Pt.paint_circle["circle-emissive-strength"])}),layout:de};class nt{constructor(e,n){this.pos=e,this.dir=n}intersectsPlane(e,n,a){const l=s._.dot(n,this.dir);if(Math.abs(l)<1e-6)return!1;const u=((e[0]-this.pos[0])*n[0]+(e[1]-this.pos[1])*n[1]+(e[2]-this.pos[2])*n[2])/l;return a[0]=this.pos[0]+this.dir[0]*u,a[1]=this.pos[1]+this.dir[1]*u,a[2]=this.pos[2]+this.dir[2]*u,!0}closestPointOnSphere(e,n,a){if(s._.equals(this.pos,e)||n===0)return a[0]=a[1]=a[2]=0,!1;const[l,u,d]=this.dir,x=this.pos[0]-e[0],v=this.pos[1]-e[1],S=this.pos[2]-e[2],L=l*l+u*u+d*d,P=2*(x*l+v*u+S*d),O=P*P-4*L*(x*x+v*v+S*S-n*n);if(O<0){const V=Math.max(-P/2,0),G=x+l*V,$=v+u*V,Y=S+d*V,ne=Math.hypot(G,$,Y);return a[0]=G*n/ne,a[1]=$*n/ne,a[2]=Y*n/ne,!1}{const V=(-P-Math.sqrt(O))/(2*L);if(V<0){const G=Math.hypot(x,v,S);return a[0]=x*n/G,a[1]=v*n/G,a[2]=S*n/G,!1}return a[0]=x+l*V,a[1]=v+u*V,a[2]=S+d*V,!0}}}class Je{constructor(e,n,a,l,u){this.TL=e,this.TR=n,this.BR=a,this.BL=l,this.horizon=u}static fromInvProjectionMatrix(e,n,a){const l=[-1,1,1],u=[1,1,1],d=[1,-1,1],x=[-1,-1,1],v=s._.transformMat4(l,l,e),S=s._.transformMat4(u,u,e),L=s._.transformMat4(d,d,e),P=s._.transformMat4(x,x,e);return new Je(v,S,L,P,n/a)}}function gt(t,e,n){let a=1/0,l=-1/0;const u=[];for(const d of t){s._.sub(u,d,e);const x=s._.dot(u,n);a=Math.min(a,x),l=Math.max(l,x)}return[a,l]}function Tt(t,e){let n=!0;for(let a=0;a<t.planes.length;a++){const l=t.planes[a];let u=0;for(let d=0;d<e.length;d++)u+=s._.dot(l,e[d])+l[3]>=0;if(u===0)return 0;u!==e.length&&(n=!1)}return n?2:1}function Zt(t,e){for(const n of t.projections){const a=gt(e,t.points[0],n.axis);if(n.projection[1]<a[0]||n.projection[0]>a[1])return 0}return 1}function ei(t,e){let n=0;const a=[0,0,0,0];for(let l=0;l<t.length;l++)a[0]=t[l][0],a[1]=t[l][1],a[2]=t[l][2],a[3]=1,s.aA.dot(a,e)>=0&&n++;return n}class vi{constructor(e,n){this.points=e||new Array(8).fill([0,0,0]),this.planes=n||new Array(6).fill([0,0,0,0]),this.bounds=Xt.fromPoints(this.points),this.projections=[],this.frustumEdges=[s._.sub([],this.points[2],this.points[3]),s._.sub([],this.points[0],this.points[3]),s._.sub([],this.points[4],this.points[0]),s._.sub([],this.points[5],this.points[1]),s._.sub([],this.points[6],this.points[2]),s._.sub([],this.points[7],this.points[3])];for(const a of this.frustumEdges){const l=[0,-a[2],a[1]],u=[a[2],0,-a[0]];this.projections.push({axis:l,projection:gt(this.points,this.points[0],l)}),this.projections.push({axis:u,projection:gt(this.points,this.points[0],u)})}}static fromInvProjectionMatrix(e,n,a,l){const u=Math.pow(2,a),d=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(S=>{const L=s.aA.transformMat4([],S,e),P=1/L[3]/n*u;return s.aA.mul(L,L,[P,P,l?1/L[3]:P,P])}),x=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(S=>{const L=s._.sub([],d[S[0]],d[S[1]]),P=s._.sub([],d[S[2]],d[S[1]]),O=s._.normalize([],s._.cross([],L,P)),V=-s._.dot(O,d[S[1]]);return O.concat(V)}),v=[];for(let S=0;S<d.length;S++)v.push([d[S][0],d[S][1],d[S][2]]);return new vi(v,x)}intersectsPrecise(e,n,a){for(let l=0;l<n.length;l++)if(!ei(e,n[l]))return 0;for(let l=0;l<this.planes.length;l++)if(!ei(e,this.planes[l]))return 0;for(const l of a)for(const u of this.frustumEdges){const d=s._.cross([],l,u),x=s._.length(d);if(x===0)continue;s._.scale(d,d,1/x);const v=gt(this.points,this.points[0],d),S=gt(e,this.points[0],d);if(v[0]>S[1]||S[0]>v[1])return 0}return 1}}class Xt{static fromPoints(e){const n=[1/0,1/0,1/0],a=[-1/0,-1/0,-1/0];for(const l of e)s._.min(n,n,l),s._.max(a,a,l);return new Xt(n,a)}static fromTileIdAndHeight(e,n,a){const l=1<<e.canonical.z,u=e.canonical.x,d=e.canonical.y;return new Xt([u/l,d/l,n],[(u+1)/l,(d+1)/l,a])}static applyTransform(e,n){const a=e.getCorners();for(let l=0;l<a.length;++l)s._.transformMat4(a[l],a[l],n);return Xt.fromPoints(a)}static applyTransformFast(e,n){const a=[n[12],n[13],n[14]],l=[...a];for(let u=0;u<3;u++)for(let d=0;d<3;d++){const x=n[4*d+u],v=x*e.min[d],S=x*e.max[d];a[u]+=Math.min(v,S),l[u]+=Math.max(v,S)}return new Xt(a,l)}static projectAabbCorners(e,n){const a=e.getCorners();for(let l=0;l<a.length;++l)s._.transformMat4(a[l],a[l],n);return a}constructor(e,n){this.min=e,this.max=n,this.center=s._.scale([],s._.add([],this.min,this.max),.5)}quadrant(e){const n=[e%2==0,e<2],a=s._.clone(this.min),l=s._.clone(this.max);for(let u=0;u<n.length;u++)a[u]=n[u]?this.min[u]:this.center[u],l[u]=n[u]?this.center[u]:this.max[u];return l[2]=this.max[2],new Xt(a,l)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){const e=this.min,n=this.max;return[[e[0],e[1],e[2]],[n[0],e[1],e[2]],[n[0],n[1],e[2]],[e[0],n[1],e[2]],[e[0],e[1],n[2]],[n[0],e[1],n[2]],[n[0],n[1],n[2]],[e[0],n[1],n[2]]]}intersects(e){return this.intersectsAabb(e.bounds)?Tt(e,this.getCorners()):0}intersectsFlat(e){return this.intersectsAabb(e.bounds)?Tt(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(e,n){return n||this.intersects(e)?Zt(e,this.getCorners()):0}intersectsPreciseFlat(e,n){return n||this.intersectsFlat(e)?Zt(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(e){for(let n=0;n<3;++n)if(this.min[n]>e.max[n]||e.min[n]>this.max[n])return!1;return!0}intersectsAabbXY(e){return!(this.min[0]>e.max[0]||e.min[0]>this.max[0]||this.min[1]>e.max[1]||e.min[1]>this.max[1])}encapsulate(e){for(let n=0;n<3;n++)this.min[n]=Math.min(this.min[n],e.min[n]),this.max[n]=Math.max(this.max[n],e.max[n])}encapsulatePoint(e){for(let n=0;n<3;n++)this.min[n]=Math.min(this.min[n],e[n]),this.max[n]=Math.max(this.max[n],e[n])}closestPoint(e){return[Math.max(Math.min(this.max[0],e[0]),this.min[0]),Math.max(Math.min(this.max[1],e[1]),this.min[1]),Math.max(Math.min(this.max[2],e[2]),this.min[2])]}}xe(Xt,"Aabb");const xi=rr([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:In}=xi,gn=rr([{name:"a_pos_3",components:3,type:"Int16"}]);var Vi=rr([{name:"a_pos",type:"Int16",components:2}]);function vn(t){return t*_a/cd}const $n=[new Xt([Bl,Bl,Bl],[Nl,Nl,Nl]),new Xt([Bl,Bl,Bl],[0,0,Nl]),new Xt([0,Bl,Bl],[Nl,0,Nl]),new Xt([Bl,0,Bl],[0,Nl,Nl]),new Xt([0,0,Bl],[Nl,Nl,Nl])];function tr(t,e,n,a=!0){const l=s._.scale([],t._camera.position,t.worldSize),u=[e,n,1,1];s.aA.transformMat4(u,u,t.pixelMatrixInverse),s.aA.scale(u,u,1/u[3]);const d=s._.sub([],u,l),x=s._.normalize([],d),v=t.globeMatrix,S=[v[12],v[13],v[14]],L=s._.sub([],S,l),P=s._.length(L),O=s._.normalize([],L),V=t.worldSize/(2*Math.PI),G=s._.dot(O,x),$=Math.asin(V/P);if($<Math.acos(G)){if(!a)return null;const Vt=[],ai=[];s._.scale(Vt,x,P/G),s._.normalize(ai,s._.sub(ai,Vt,L)),s._.normalize(x,s._.add(x,L,s._.scale(x,ai,Math.tan($)*P)))}const Y=[];new nt(l,x).closestPointOnSphere(S,V,Y);const ne=s._.normalize([],Mc(v,0)),Te=s._.normalize([],Mc(v,1)),Ae=s._.normalize([],Mc(v,2)),Ce=s._.dot(ne,Y),qe=s._.dot(Te,Y),Ge=s._.dot(Ae,Y),ot=_r(Math.asin(-qe/V));let dt=_r(Math.atan2(Ce,Ge));dt=t.center.lng+function(Vt,ai){const Ci=(ai-Vt+180)%360-180;return Ci<-180?Ci+360:Ci}(t.center.lng,dt);const Rt=mc(dt),$t=pn(sa(ot),0,1);return new Lo(Rt,$t)}class mr{constructor(e,n,a){this.a=s._.sub([],e,a),this.b=s._.sub([],n,a),this.center=a;const l=s._.normalize([],this.a),u=s._.normalize([],this.b);this.angle=Math.acos(s._.dot(l,u))}}function Ar(t,e){if(t.angle===0)return null;let n;return n=t.a[e]===0?1/t.angle*.5*Math.PI:1/t.angle*Math.atan(t.b[e]/t.a[e]/Math.sin(t.angle)-1/Math.tan(t.angle)),n<0||n>1?null:function(a,l,u,d){const x=Math.sin(u);return a*(Math.sin((1-d)*u)/x)+l*(Math.sin(d*u)/x)}(t.a[e],t.b[e],t.angle,pn(n,0,1))+t.center[e]}function hr(t){if(t.z<=1)return $n[t.z+2*t.y+t.x];const e=gi(Li(t));return Xt.fromPoints(e)}function mn(t,e,n){return s._.scale(t,t,1-n),s._.scaleAndAdd(t,t,e,n)}function wt(t,e){const n=Hn(e.zoom);if(n===0)return hr(t);const a=Li(t),l=gi(a),u=mc(a.getWest())*e.worldSize,d=mc(a.getEast())*e.worldSize,x=sa(a.getNorth())*e.worldSize,v=sa(a.getSouth())*e.worldSize,S=[u,x,0],L=[d,x,0],P=[u,v,0],O=[d,v,0],V=s.ad.invert([],e.globeMatrix);return s._.transformMat4(S,S,V),s._.transformMat4(L,L,V),s._.transformMat4(P,P,V),s._.transformMat4(O,O,V),l[0]=mn(l[0],P,n),l[1]=mn(l[1],O,n),l[2]=mn(l[2],L,n),l[3]=mn(l[3],S,n),Xt.fromPoints(l)}function Dt(t,e,n){for(const a of t)s._.transformMat4(a,a,e),s._.scale(a,a,n)}function Xi(t,e,n,a){const l=e/t.worldSize,u=t.globeMatrix;if(n.z<=1){const Rt=hr(n).getCorners();return Dt(Rt,u,l),Xt.fromPoints(Rt)}const d=Li(n,a),x=gi(d,_a+vn(t._tileCoverLift));Dt(x,u,l);const v=Number.MAX_VALUE,S=[-v,-v,-v],L=[v,v,v];if(d.contains(t.center)){for(const Vt of x)s._.min(L,L,Vt),s._.max(S,S,Vt);S[2]=0;const Rt=t.point,$t=[Rt.x*l,Rt.y*l,0];return s._.min(L,L,$t),s._.max(S,S,$t),new Xt(L,S)}if(t._tileCoverLift>0){for(const Rt of x)s._.min(L,L,Rt),s._.max(S,S,Rt);return new Xt(L,S)}const P=[u[12]*l,u[13]*l,u[14]*l],O=d.getCenter(),V=pn(t.center.lat,-Js,Js),G=pn(O.lat,-Js,Js),$=mc(t.center.lng),Y=sa(V);let ne=$-mc(O.lng);const Te=Y-sa(G);ne>.5?ne-=1:ne<-.5&&(ne+=1);let Ae=0;if(Math.abs(ne)>Math.abs(Te))Ae=ne>=0?1:3;else{Ae=Te>=0?0:2;const Rt=[u[4]*l,u[5]*l,u[6]*l],$t=-Math.sin(Pn(Te>=0?d.getSouth():d.getNorth()))*_a;s._.scaleAndAdd(P,P,Rt,$t)}const Ce=x[Ae],qe=x[(Ae+1)%4],Ge=new mr(Ce,qe,P),ot=[Ar(Ge,0)||Ce[0],Ar(Ge,1)||Ce[1],Ar(Ge,2)||Ce[2]],dt=Hn(t.zoom);if(dt>0){const Rt=function({x:Vt,y:ai,z:Ci},ti,bi,Yt,wi){const zi=1/(1<<Ci);let Si=Vt*zi,fn=Si+zi,Ii=ai*zi,Ui=Ii+zi,qn=0;const Fn=(Si+fn)/2-Yt;return Fn>.5?qn=-1:Fn<-.5&&(qn=1),Si=((Si+qn)*ti-(Yt*=ti))*bi+Yt,fn=((fn+qn)*ti-Yt)*bi+Yt,Ii=(Ii*ti-(wi*=ti))*bi+wi,Ui=(Ui*ti-wi)*bi+wi,[[Si,Ui,0],[fn,Ui,0],[fn,Ii,0],[Si,Ii,0]]}(n,e,t._pixelsPerMercatorPixel,$,Y);for(let Vt=0;Vt<x.length;Vt++)mn(x[Vt],Rt[Vt],dt);const $t=s._.add([],Rt[Ae],Rt[(Ae+1)%4]);s._.scale($t,$t,.5),mn(ot,$t,dt)}for(const Rt of x)s._.min(L,L,Rt),s._.max(S,S,Rt);return L[2]=Math.min(Ce[2],qe[2]),s._.min(L,L,ot),s._.max(S,S,ot),new Xt(L,S)}function Li({x:t,y:e,z:n},a=!1){const l=1/(1<<n),u=new Gr(oa(t*l),e===(1<<n)-1&&a?-90:Co((e+1)*l)),d=new Gr(oa((t+1)*l),e===0&&a?90:Co(e*l));return new fc(u,d)}function gi(t,e=_a){const n=Pn(t.getNorth()),a=Pn(t.getSouth()),l=Math.cos(n),u=Math.cos(a),d=Math.sin(n),x=Math.sin(a),v=t.getWest(),S=t.getEast();return[tp(u,x,v,e),tp(u,x,S,e),tp(l,d,S,e),tp(l,d,v,e)]}function An(t,e,n,a){const l=1<<n.z,u=(t/ji+n.x)/l;return us(Co((e/ji+n.y)/l),oa(u),a)}function Cn({min:t,max:e}){return q0/Math.max(e[0]-t[0],e[1]-t[1],e[2]-t[2])}const Ti=new Float64Array(16);function pt(t){const e=Cn(t),n=s.ad.fromScaling(Ti,[e,e,e]);return s.ad.translate(n,n,s._.negate([],t.min))}function di(t){const e=s.ad.fromTranslation(Ti,t.min),n=1/Cn(t);return s.ad.scale(e,e,[n,n,n])}function nn(t){const e=ji/(2*Math.PI);return t/(2*Math.PI)/e}function an(t,e){return ji/(512*Math.pow(2,t))*Cn(hr(e))}function rn(t,e,n,a,l){const u=nn(n),d=[t,e,-n/(2*Math.PI)],x=s.ad.identity(new Float64Array(16));return s.ad.translate(x,x,d),s.ad.scale(x,x,[u,u,u]),s.ad.rotateX(x,x,Pn(-l)),s.ad.rotateY(x,x,Pn(-a)),x}function Hn(t){return Mo(tf,iy,t)}function Sr(t,e){const n=us(e.lat,e.lng),a=function(u){const d=us(u._center.lat,u._center.lng),x=s._.fromValues(0,1,0);let v=s._.cross([],x,d);const S=s.ad.fromRotation([],-u.angle,d);v=s._.transformMat4(v,v,S),s.ad.fromRotation(S,-u._pitch,v);const L=s._.normalize([],d);return s._.scale(L,L,vn(u.cameraToCenterDistance/u.pixelsPerMeter)),s._.transformMat4(L,L,S),s._.add([],d,L)}(t),l=s._.subtract([],a,n);return s._.angle(l,n)}function sr(t,e){return Sr(t,e)>Math.PI/2*1.01}const Kr=Pn(85),Xr=Math.cos(Kr),Ko=Math.sin(Kr),Ns=s.ad.create(),Ho=t=>{const e=[];return t.paint.get("circle-pitch-alignment")==="map"&&e.push("PITCH_WITH_MAP"),t.paint.get("circle-pitch-scale")==="map"&&e.push("SCALE_WITH_MAP"),e};function Xa(t,e,n,a,l,u,d,x,v){if(u&&t.queryGeometry.isAboveHorizon)return!1;u&&(v*=t.pixelToTileUnitsFactor);const S=t.tileID.canonical,L=n.projection.upVectorScale(S,n.center.lat,n.worldSize).metersToTile;for(const P of e)for(const O of P){const V=O.add(x),G=l&&n.elevation?n.elevation.exaggeration()*l.getElevationAt(V.x,V.y,!0):0,$=n.projection.projectTilePoint(V.x,V.y,S);if(G>0){const Ae=n.projection.upVector(S,V.x,V.y);$.x+=Ae[0]*L*G,$.y+=Ae[1]*L*G,$.z+=Ae[2]*L*G}const Y=u?V:hd($.x,$.y,$.z,a),ne=u?t.tilespaceRays.map(Ae=>Ul(Ae,G)):t.queryGeometry.screenGeometry,Te=s.aA.transformMat4([],[$.x,$.y,$.z,1],a);if(!d&&u?v*=Te[3]/n.cameraToCenterDistance:d&&!u&&(v*=n.cameraToCenterDistance/Te[3]),u){const Ae=Co((O.y/ji+S.y)/(1<<S.z));v/=n.projection.pixelsPerMeter(Ae,1)/Go(1,Ae)}if(M(ne,Y,v))return!0}return!1}function hd(t,e,n,a){const l=s.aA.transformMat4([],[t,e,n,1],a);return new Kt(l[0]/l[3],l[1]/l[3])}const pu=s._.fromValues(0,0,0),ud=s._.fromValues(0,0,1);function Ul(t,e){const n=s._.create();return pu[2]=e,t.intersectsPlane(pu,ud,n),new Kt(n[0],n[1])}class za extends Fg{}function En(t,{width:e,height:n},a,l){if(l){if(l instanceof Uint8ClampedArray)l=new Uint8Array(l.buffer);else if(l.length!==e*n*a)throw new RangeError("mismatched image size")}else l=new Uint8Array(e*n*a);return t.width=e,t.height=n,t.data=l,t}function Bg(t,e,n){const{width:a,height:l}=e;a===t.width&&l===t.height||(Lm(t,e,{x:0,y:0},{x:0,y:0},{width:Math.min(t.width,a),height:Math.min(t.height,l)},n,null),t.width=a,t.height=l,t.data=e.data)}function Lm(t,e,n,a,l,u,d,x){if(l.width===0||l.height===0)return e;if(l.width>t.width||l.height>t.height||n.x>t.width-l.width||n.y>t.height-l.height)throw new RangeError("out of range source coordinates for image copy");if(l.width>e.width||l.height>e.height||a.x>e.width-l.width||a.y>e.height-l.height)throw new RangeError("out of range destination coordinates for image copy");const v=t.data,S=e.data,L=u===4&&x;for(let P=0;P<l.height;P++){const O=((n.y+P)*t.width+n.x)*u,V=((a.y+P)*e.width+a.x)*u;if(L)for(let G=0;G<l.width;G++){const $=O+G*u+3,Y=V+G*u;S[Y+0]=255,S[Y+1]=255,S[Y+2]=255,S[Y+3]=v[$]}else if(d)for(let G=0;G<l.width;G++){const $=O+G*u,Y=V+G*u,ne=v[$+3],Te=new Yr(v[$+0]/255*ne,v[$+1]/255*ne,v[$+2]/255*ne,ne).toRenderColor(d).toArray();S[Y+0]=Te[0],S[Y+1]=Te[1],S[Y+2]=Te[2],S[Y+3]=Te[3]}else for(let G=0;G<l.width*u;G++)S[V+G]=v[O+G]}return e}xe(za,"HeatmapBucket",{omit:["layers"]});class Fo{constructor(e,n){En(this,e,1,n)}resize(e){Bg(this,new Fo(e),1)}clone(){return new Fo({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,n,a,l,u){Lm(e,n,a,l,u,1,null)}}class $a{constructor(e,n){En(this,e,4,n)}resize(e){Bg(this,new $a(e),4)}replace(e,n){n?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new $a({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,n,a,l,u,d,x){Lm(e,n,a,l,u,4,d,x)}}class Ng{constructor(e,n){this.width=e.width,this.height=e.height,this.data=n instanceof Uint8Array?new Float32Array(n.buffer):n}}xe(Fo,"AlphaImage"),xe($a,"RGBAImage");const ay=new Br({visibility:new oi(Pt.layout_heatmap.visibility)});var Ug={paint:new Br({"heatmap-radius":new on(Pt.paint_heatmap["heatmap-radius"]),"heatmap-weight":new on(Pt.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new oi(Pt.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Eo(Pt.paint_heatmap["heatmap-color"]),"heatmap-opacity":new oi(Pt.paint_heatmap["heatmap-opacity"])}),layout:ay};function np(t){const e={},n=t.resolution||256,a=t.clips?t.clips.length:1,l=t.image||new $a({width:n,height:a}),u=(d,x,v)=>{e[t.evaluationKey]=v;const S=t.expression.evaluate(e);S&&(l.data[d+x+0]=Math.floor(255*S.r/S.a),l.data[d+x+1]=Math.floor(255*S.g/S.a),l.data[d+x+2]=Math.floor(255*S.b/S.a),l.data[d+x+3]=Math.floor(255*S.a))};if(t.clips)for(let d=0,x=0;d<a;++d,x+=4*n)for(let v=0,S=0;v<n;v++,S+=4){const L=v/(n-1),{start:P,end:O}=t.clips[d];u(x,S,P*(1-L)+O*L)}else for(let d=0,x=0;d<n;d++,x+=4)u(0,x,d/(n-1));return l}const ly=new Br({visibility:new oi(Pt.layout_hillshade.visibility)});var dd={paint:new Br({"hillshade-illumination-direction":new oi(Pt.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new oi(Pt.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new oi(Pt.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new oi(Pt.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new oi(Pt.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new oi(Pt.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new oi(Pt.paint_hillshade["hillshade-emissive-strength"])}),layout:ly};const cy=rr([{name:"a_pos",components:2,type:"Int16"}],4),{members:hy}=cy;function fu(t,e,n=2){const a=e&&e.length,l=a?e[0]*n:t.length;let u=uy(t,0,l,n,!0);const d=[];if(!u||u.next===u.prev)return d;let x,v,S;if(a&&(u=function(L,P,O,V){const G=[];for(let $=0,Y=P.length;$<Y;$++){const ne=uy(L,P[$]*V,$<Y-1?P[$+1]*V:L.length,V,!1);ne===ne.next&&(ne.steiner=!0),G.push(Qr(ne))}G.sort(qi);for(let $=0;$<G.length;$++)O=Tn(G[$],O);return O}(t,e,u,n)),t.length>80*n){x=1/0,v=1/0;let L=-1/0,P=-1/0;for(let O=n;O<l;O+=n){const V=t[O],G=t[O+1];V<x&&(x=V),G<v&&(v=G),V>L&&(L=V),G>P&&(P=G)}S=Math.max(L-x,P-v),S=S!==0?32767/S:0}return rp(u,d,n,x,v,S,0),d}function uy(t,e,n,a,l){let u;if(l===function(d,x,v,S){let L=0;for(let P=x,O=v-S;P<v;P+=S)L+=(d[O]-d[P])*(d[P+1]+d[O+1]),O=P;return L}(t,e,n,a)>0)for(let d=e;d<n;d+=a)u=mu(d/a|0,t[d],t[d+1],u);else for(let d=n-a;d>=e;d-=a)u=mu(d/a|0,t[d],t[d+1],u);return u&&os(u,u.next)&&(Hl(u),u=u.next),u}function Rh(t,e){if(!t)return t;e||(e=t);let n,a=t;do if(n=!1,a.steiner||!os(a,a.next)&&Ir(a.prev,a,a.next)!==0)a=a.next;else{if(Hl(a),a=e=a.prev,a===a.next)break;n=!0}while(n||a!==e);return e}function rp(t,e,n,a,l,u,d){if(!t)return;!d&&u&&function(v,S,L,P){let O=v;do O.z===0&&(O.z=vr(O.x,O.y,S,L,P)),O.prevZ=O.prev,O.nextZ=O.next,O=O.next;while(O!==v);O.prevZ.nextZ=null,O.prevZ=null,function(V){let G,$=1;do{let Y,ne=V;V=null;let Te=null;for(G=0;ne;){G++;let Ae=ne,Ce=0;for(let Ge=0;Ge<$&&(Ce++,Ae=Ae.nextZ,Ae);Ge++);let qe=$;for(;Ce>0||qe>0&&Ae;)Ce!==0&&(qe===0||!Ae||ne.z<=Ae.z)?(Y=ne,ne=ne.nextZ,Ce--):(Y=Ae,Ae=Ae.nextZ,qe--),Te?Te.nextZ=Y:V=Y,Y.prevZ=Te,Te=Y;ne=Ae}Te.nextZ=null,$*=2}while(G>1)}(O)}(t,a,l,u);let x=t;for(;t.prev!==t.next;){const v=t.prev,S=t.next;if(u?bt(t,a,l,u):dy(t))e.push(v.i,t.i,S.i),Hl(t),t=S.next,x=S.next;else if((t=S)===x){d?d===1?rp(t=Wi(Rh(t),e),e,n,a,l,u,2):d===2&&pi(t,e,n,a,l,u):rp(Rh(t),e,n,a,l,u,1);break}}}function dy(t){const e=t.prev,n=t,a=t.next;if(Ir(e,n,a)>=0)return!1;const l=e.x,u=n.x,d=a.x,x=e.y,v=n.y,S=a.y,L=l<u?l<d?l:d:u<d?u:d,P=x<v?x<S?x:S:v<S?v:S,O=l>u?l>d?l:d:u>d?u:d,V=x>v?x>S?x:S:v>S?v:S;let G=a.next;for(;G!==e;){if(G.x>=L&&G.x<=O&&G.y>=P&&G.y<=V&&ts(l,x,u,v,d,S,G.x,G.y)&&Ir(G.prev,G,G.next)>=0)return!1;G=G.next}return!0}function bt(t,e,n,a){const l=t.prev,u=t,d=t.next;if(Ir(l,u,d)>=0)return!1;const x=l.x,v=u.x,S=d.x,L=l.y,P=u.y,O=d.y,V=x<v?x<S?x:S:v<S?v:S,G=L<P?L<O?L:O:P<O?P:O,$=x>v?x>S?x:S:v>S?v:S,Y=L>P?L>O?L:O:P>O?P:O,ne=vr(V,G,e,n,a),Te=vr($,Y,e,n,a);let Ae=t.prevZ,Ce=t.nextZ;for(;Ae&&Ae.z>=ne&&Ce&&Ce.z<=Te;){if(Ae.x>=V&&Ae.x<=$&&Ae.y>=G&&Ae.y<=Y&&Ae!==l&&Ae!==d&&ts(x,L,v,P,S,O,Ae.x,Ae.y)&&Ir(Ae.prev,Ae,Ae.next)>=0||(Ae=Ae.prevZ,Ce.x>=V&&Ce.x<=$&&Ce.y>=G&&Ce.y<=Y&&Ce!==l&&Ce!==d&&ts(x,L,v,P,S,O,Ce.x,Ce.y)&&Ir(Ce.prev,Ce,Ce.next)>=0))return!1;Ce=Ce.nextZ}for(;Ae&&Ae.z>=ne;){if(Ae.x>=V&&Ae.x<=$&&Ae.y>=G&&Ae.y<=Y&&Ae!==l&&Ae!==d&&ts(x,L,v,P,S,O,Ae.x,Ae.y)&&Ir(Ae.prev,Ae,Ae.next)>=0)return!1;Ae=Ae.prevZ}for(;Ce&&Ce.z<=Te;){if(Ce.x>=V&&Ce.x<=$&&Ce.y>=G&&Ce.y<=Y&&Ce!==l&&Ce!==d&&ts(x,L,v,P,S,O,Ce.x,Ce.y)&&Ir(Ce.prev,Ce,Ce.next)>=0)return!1;Ce=Ce.nextZ}return!0}function Wi(t,e){let n=t;do{const a=n.prev,l=n.next.next;!os(a,l)&&Jr(a,n,n.next,l)&&Vl(a,l)&&Vl(l,a)&&(e.push(a.i,n.i,l.i),Hl(n),Hl(n.next),n=t=l),n=n.next}while(n!==t);return Rh(n)}function pi(t,e,n,a,l,u){let d=t;do{let x=d.next.next;for(;x!==d.prev;){if(d.i!==x.i&&Gs(d,x)){let v=Gl(d,x);return d=Rh(d,d.next),v=Rh(v,v.next),rp(d,e,n,a,l,u,0),void rp(v,e,n,a,l,u,0)}x=x.next}d=d.next}while(d!==t)}function qi(t,e){return t.x-e.x}function Tn(t,e){const n=function(l,u){let d=u;const x=l.x,v=l.y;let S,L=-1/0;do{if(v<=d.y&&v>=d.next.y&&d.next.y!==d.y){const $=d.x+(v-d.y)*(d.next.x-d.x)/(d.next.y-d.y);if($<=x&&$>L&&(L=$,S=d.x<d.next.x?d:d.next,$===x))return S}d=d.next}while(d!==u);if(!S)return null;const P=S,O=S.x,V=S.y;let G=1/0;d=S;do{if(x>=d.x&&d.x>=O&&x!==d.x&&ts(v<V?x:L,v,O,V,v<V?L:x,v,d.x,d.y)){const $=Math.abs(v-d.y)/(x-d.x);Vl(d,l)&&($<G||$===G&&(d.x>S.x||d.x===S.x&&Hr(S,d)))&&(S=d,G=$)}d=d.next}while(d!==P);return S}(t,e);if(!n)return e;const a=Gl(n,t);return Rh(a,a.next),Rh(n,n.next)}function Hr(t,e){return Ir(t.prev,t,e.prev)<0&&Ir(e.next,t,t.next)<0}function vr(t,e,n,a,l){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*l|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-a)*l|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Qr(t){let e=t,n=t;do(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next;while(e!==t);return n}function ts(t,e,n,a,l,u,d,x){return(l-d)*(e-x)>=(t-d)*(u-x)&&(t-d)*(a-x)>=(n-d)*(e-x)&&(n-d)*(u-x)>=(l-d)*(a-x)}function Gs(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(n,a){let l=n;do{if(l.i!==n.i&&l.next.i!==n.i&&l.i!==a.i&&l.next.i!==a.i&&Jr(l,l.next,n,a))return!0;l=l.next}while(l!==n);return!1}(t,e)&&(Vl(t,e)&&Vl(e,t)&&function(n,a){let l=n,u=!1;const d=(n.x+a.x)/2,x=(n.y+a.y)/2;do l.y>x!=l.next.y>x&&l.next.y!==l.y&&d<(l.next.x-l.x)*(x-l.y)/(l.next.y-l.y)+l.x&&(u=!u),l=l.next;while(l!==n);return u}(t,e)&&(Ir(t.prev,t,e.prev)||Ir(t,e.prev,e))||os(t,e)&&Ir(t.prev,t,t.next)>0&&Ir(e.prev,e,e.next)>0)}function Ir(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function os(t,e){return t.x===e.x&&t.y===e.y}function Jr(t,e,n,a){const l=ro(Ir(t,e,n)),u=ro(Ir(t,e,a)),d=ro(Ir(n,a,t)),x=ro(Ir(n,a,e));return l!==u&&d!==x||!(l!==0||!Xc(t,n,e))||!(u!==0||!Xc(t,a,e))||!(d!==0||!Xc(n,t,a))||!(x!==0||!Xc(n,e,a))}function Xc(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function ro(t){return t>0?1:t<0?-1:0}function Vl(t,e){return Ir(t.prev,t,t.next)<0?Ir(t,e,t.next)>=0&&Ir(t,t.prev,e)>=0:Ir(t,e,t.prev)<0||Ir(t,t.next,e)<0}function Gl(t,e){const n=ko(t.i,t.x,t.y),a=ko(e.i,e.x,e.y),l=t.next,u=e.prev;return t.next=e,e.prev=t,n.next=l,l.prev=n,a.next=n,n.prev=a,u.next=a,a.prev=u,a}function mu(t,e,n,a){const l=ko(t,e,n);return a?(l.next=a.next,l.prev=a,a.next.prev=l,a.next=l):(l.prev=l,l.next=l),l}function Hl(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function ko(t,e,n){return{i:t,x:e,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function _l(t,e){const n=t.length;if(n<=1)return[t];const a=[];let l,u;for(let d=0;d<n;d++){const x=Ka(t[d]);x!==0&&(t[d].area=Math.abs(x),u===void 0&&(u=x<0),u===x<0?(l&&a.push(l),l=[t[d]]):l.push(t[d]))}if(l&&a.push(l),e>1)for(let d=0;d<a.length;d++)a[d].length<=e||(Yf(a[d],e,1,a[d].length-1,ya),a[d]=a[d].slice(0,e));return a}function ya(t,e){return e.area-t.area}function yl(t,e,n){const a=n.patternDependencies;let l=!1;for(const u of e){const d=u.paint.get(`${t}-pattern`);d.isConstant()||(l=!0);const x=d.constantOr(null);x&&(l=!0,a[x]=!0)}return l}function xl(t,e,n,a,l){const u=l.patternDependencies;for(const d of e){const x=d.paint.get(`${t}-pattern`).value;if(x.kind!=="constant"){let v=x.evaluate({zoom:a},n,{},l.availableImages);v=v&&v.name?v.name:v,u[v]=!0,n.patterns[d.id]=v}}return n}class py{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new Fl,this.indexArray=new no,this.indexArray2=new Gc,this.programConfigurations=new Ph(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new Ts,this.segments2=new Ts,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.projection=e.projection}updateFootprints(e,n){}populate(e,n,a,l){this.hasPattern=yl("fill",this.layers,n);const u=this.layers[0].layout.get("fill-sort-key"),d=[];for(const{feature:x,id:v,index:S,sourceLayerIndex:L}of e){const P=this.layers[0]._featureFilter.needGeometry,O=gc(x,P);if(!this.layers[0]._featureFilter.filter(new ir(this.zoom),O,a))continue;const V=u?u.evaluate(O,{},a,n.availableImages):void 0,G={id:v,properties:x.properties,type:x.type,sourceLayerIndex:L,index:S,geometry:P?O.geometry:Za(x,a,l),patterns:{},sortKey:V};d.push(G)}u&&d.sort((x,v)=>x.sortKey-v.sortKey);for(const x of d){const{geometry:v,index:S,sourceLayerIndex:L}=x;if(this.hasPattern){const P=xl("fill",this.layers,x,this.zoom,n);this.patternFeatures.push(P)}else this.addFeature(x,v,S,a,{},n.availableImages,n.brightness);n.featureIndex.insert(e[S].feature,v,S,L,this.index)}}update(e,n,a,l,u){const d=Object.keys(e).length!==0;d&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(e,n,d?this.stateDependentLayers:this.layers,a,l,u)}addFeatures(e,n,a,l,u,d){for(const x of this.patternFeatures)this.addFeature(x,x.geometry,x.index,n,a,l,d)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,hy),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.indexBuffer2=e.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(e,n,a,l,u,d=[],x){for(const v of _l(n,500)){let S=0;for(const $ of v)S+=$.length;const L=this.segments.prepareSegment(S,this.layoutVertexArray,this.indexArray),P=L.vertexLength,O=[],V=[];for(const $ of v){if($.length===0)continue;$!==v[0]&&V.push(O.length/2);const Y=this.segments2.prepareSegment($.length,this.layoutVertexArray,this.indexArray2),ne=Y.vertexLength;this.layoutVertexArray.emplaceBack($[0].x,$[0].y),this.indexArray2.emplaceBack(ne+$.length-1,ne),O.push($[0].x),O.push($[0].y);for(let Te=1;Te<$.length;Te++)this.layoutVertexArray.emplaceBack($[Te].x,$[Te].y),this.indexArray2.emplaceBack(ne+Te-1,ne+Te),O.push($[Te].x),O.push($[Te].y);Y.vertexLength+=$.length,Y.primitiveLength+=$.length}const G=fu(O,V);for(let $=0;$<G.length;$+=3)this.indexArray.emplaceBack(P+G[$],P+G[$+1],P+G[$+2]);L.vertexLength+=S,L.primitiveLength+=G.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,a,u,d,l,x)}}xe(py,"FillBucket",{omit:["layers","patternFeatures"]});const GA=new Br({"fill-sort-key":new on(Pt.layout_fill["fill-sort-key"]),visibility:new oi(Pt.layout_fill.visibility)});var HA={paint:new Br({"fill-antialias":new oi(Pt.paint_fill["fill-antialias"]),"fill-opacity":new on(Pt.paint_fill["fill-opacity"]),"fill-color":new on(Pt.paint_fill["fill-color"]),"fill-outline-color":new on(Pt.paint_fill["fill-outline-color"]),"fill-translate":new oi(Pt.paint_fill["fill-translate"]),"fill-translate-anchor":new oi(Pt.paint_fill["fill-translate-anchor"]),"fill-pattern":new on(Pt.paint_fill["fill-pattern"]),"fill-emissive-strength":new oi(Pt.paint_fill["fill-emissive-strength"])}),layout:GA};class Z0{constructor(e,n,a,l){if(this.triangleCount=n.length/3,this.min=new Kt(0,0),this.max=new Kt(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||e.length===0)return;const[u,d]=[e[0].clone(),e[0].clone()];for(let P=1;P<e.length;++P){const O=e[P];u.x=Math.min(u.x,O.x),u.y=Math.min(u.y,O.y),d.x=Math.max(d.x,O.x),d.y=Math.max(d.y,O.y)}if(l){const P=Math.ceil(Math.max(d.x-u.x,d.y-u.y)/l);a=Math.max(a,P)}if(a===0)return;this.min=u,this.max=d;const x=this.max.sub(this.min);x.x=Math.max(x.x,1),x.y=Math.max(x.y,1);const v=Math.max(x.x,x.y)/a;this.cellsX=Math.max(1,Math.ceil(x.x/v)),this.cellsY=Math.max(1,Math.ceil(x.y/v)),this.xScale=1/v,this.yScale=1/v;const S=[];for(let P=0;P<this.triangleCount;P++){const O=e[n[3*P+0]].sub(this.min),V=e[n[3*P+1]].sub(this.min),G=e[n[3*P+2]].sub(this.min),$=gu(Math.floor(Math.min(O.x,V.x,G.x)),this.xScale,this.cellsX),Y=gu(Math.floor(Math.max(O.x,V.x,G.x)),this.xScale,this.cellsX),ne=gu(Math.floor(Math.min(O.y,V.y,G.y)),this.yScale,this.cellsY),Te=gu(Math.floor(Math.max(O.y,V.y,G.y)),this.yScale,this.cellsY),Ae=new Kt(0,0),Ce=new Kt(0,0),qe=new Kt(0,0),Ge=new Kt(0,0);for(let ot=ne;ot<=Te;++ot){Ae.y=Ce.y=ot*v,qe.y=Ge.y=(ot+1)*v;for(let dt=$;dt<=Y;++dt)Ae.x=qe.x=dt*v,Ce.x=Ge.x=(dt+1)*v,(J(O,V,G,Ae,Ce,Ge)||J(O,V,G,Ae,Ge,qe))&&S.push({cellIdx:ot*this.cellsX+dt,triIdx:P})}}if(S.length===0)return;S.sort((P,O)=>P.cellIdx-O.cellIdx||P.triIdx-O.triIdx);let L=0;for(;L<S.length;){const P=S[L].cellIdx,O={start:this.payload.length,len:0};for(;L<S.length&&S[L].cellIdx===P;)++O.len,this.payload.push(S[L++].triIdx);this.cells[P]=O}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(e,n){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>e.x||e.y>this.max.y||this.min.y>e.y)return;const a=gu(e.x-this.min.x,this.xScale,this.cellsX),l=gu(e.y-this.min.y,this.yScale,this.cellsY),u=this.cells[l*this.cellsX+a];if(u){this._lazyInitLookup();for(let d=0;d<u.len;d++){const x=this.payload[u.start+d],v=Math.floor(x/8),S=1<<x%8;if(!(this.lookup[v]&S)&&(this.lookup[v]|=S,n.push(x),n.length===this.triangleCount))return}}}query(e,n,a){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>n.x||e.y>this.max.y||this.min.y>n.y)return;this._lazyInitLookup();const l=gu(e.x-this.min.x,this.xScale,this.cellsX),u=gu(n.x-this.min.x,this.xScale,this.cellsX),d=gu(e.y-this.min.y,this.yScale,this.cellsY),x=gu(n.y-this.min.y,this.yScale,this.cellsY);for(let v=d;v<=x;v++)for(let S=l;S<=u;S++){const L=this.cells[v*this.cellsX+S];if(L)for(let P=0;P<L.len;P++){const O=this.payload[L.start+P],V=Math.floor(O/8),G=1<<O%8;if(!(this.lookup[V]&G)&&(this.lookup[V]|=G,a.push(O),a.length===this.triangleCount))return}}}}function gu(t,e,n){return Math.max(0,Math.min(n-1,Math.floor(t*e)))}xe(Z0,"TriangleGridIndex");class P1{constructor(e){this.zoom=e.zoom,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.footprints=[]}updateFootprints(e,n){for(const a of this.footprints)n.push({footprint:a,id:e})}populate(e,n,a,l){const u=[];for(const{feature:d,id:x,index:v,sourceLayerIndex:S}of e){const L=this.layers[0]._featureFilter.needGeometry,P=gc(d,L);if(!this.layers[0]._featureFilter.filter(new ir(this.zoom),P,a))continue;const O={id:x,properties:d.properties,type:d.type,sourceLayerIndex:S,index:v,geometry:L?P.geometry:Za(d,a,l),patterns:{}};u.push(O)}for(const d of u){const{geometry:x,index:v,sourceLayerIndex:S}=d;this.addFeature(d,x,v,a,{},n.availableImages,n.brightness),n.featureIndex.insert(e[v].feature,x,v,S,this.index)}}isEmpty(){return this.footprints.length===0}uploadPending(){return!1}upload(e){}update(e,n,a,l,u){}destroy(){}addFeature(e,n,a,l,u,d=[],x){for(const v of _l(n,2)){const S=[],L=[],P=[],O=new Kt(1/0,1/0),V=new Kt(-1/0,-1/0);for(const Y of v)if(Y.length!==0){Y!==v[0]&&P.push(L.length/2);for(let ne=0;ne<Y.length;ne++)L.push(Y[ne].x),L.push(Y[ne].y),S.push(Y[ne]),O.x=Math.min(O.x,Y[ne].x),O.y=Math.min(O.y,Y[ne].y),V.x=Math.max(V.x,Y[ne].x),V.y=Math.max(V.y,Y[ne].y)}const G=fu(L,P),$=new Z0(S,G,8,256);this.footprints.push({vertices:S,indices:G,grid:$,min:O,max:V})}}}xe(P1,"ClipBucket",{omit:["layers"]});const jA=new Br({"clip-layer-types":new oi(Pt.layout_clip["clip-layer-types"])});var WA={paint:new Br({}),layout:jA};const qA=rr([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),ZA=rr([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),XA=rr([{name:"a_centroid_pos",components:2,type:"Uint16"}]),$A=rr([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),YA=rr([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:JA}=qA;var fy={},KA=Bi,R1=Im;function Im(t,e,n,a,l){this.properties={},this.extent=n,this.type=0,this._pbf=t,this._geometry=-1,this._keys=a,this._values=l,t.readFields(QA,this,e)}function QA(t,e,n){t==1?e.id=n.readVarint():t==2?function(a,l){for(var u=a.readVarint()+a.pos;a.pos<u;){var d=l._keys[a.readVarint()],x=l._values[a.readVarint()];l.properties[d]=x}}(n,e):t==3?e.type=n.readVarint():t==4&&(e._geometry=n.pos)}function eC(t){for(var e,n,a=0,l=0,u=t.length,d=u-1;l<u;d=l++)a+=((n=t[d]).x-(e=t[l]).x)*(e.y+n.y);return a}Im.types=["Unknown","Point","LineString","Polygon"],Im.prototype.loadGeometry=function(){var t=this._pbf;t.pos=this._geometry;for(var e,n=t.readVarint()+t.pos,a=1,l=0,u=0,d=0,x=[];t.pos<n;){if(l<=0){var v=t.readVarint();a=7&v,l=v>>3}if(l--,a===1||a===2)u+=t.readSVarint(),d+=t.readSVarint(),a===1&&(e&&x.push(e),e=[]),e.push(new KA(u,d));else{if(a!==7)throw new Error("unknown command "+a);e&&e.push(e[0].clone())}}return e&&x.push(e),x},Im.prototype.bbox=function(){var t=this._pbf;t.pos=this._geometry;for(var e=t.readVarint()+t.pos,n=1,a=0,l=0,u=0,d=1/0,x=-1/0,v=1/0,S=-1/0;t.pos<e;){if(a<=0){var L=t.readVarint();n=7&L,a=L>>3}if(a--,n===1||n===2)(l+=t.readSVarint())<d&&(d=l),l>x&&(x=l),(u+=t.readSVarint())<v&&(v=u),u>S&&(S=u);else if(n!==7)throw new Error("unknown command "+n)}return[d,v,x,S]},Im.prototype.toGeoJSON=function(t,e,n){var a,l,u=this.extent*Math.pow(2,n),d=this.extent*t,x=this.extent*e,v=this.loadGeometry(),S=Im.types[this.type];function L(V){for(var G=0;G<V.length;G++){var $=V[G];V[G]=[360*($.x+d)/u-180,360/Math.PI*Math.atan(Math.exp((180-360*($.y+x)/u)*Math.PI/180))-90]}}switch(this.type){case 1:var P=[];for(a=0;a<v.length;a++)P[a]=v[a][0];L(v=P);break;case 2:for(a=0;a<v.length;a++)L(v[a]);break;case 3:for(v=function(V){var G=V.length;if(G<=1)return[V];for(var $,Y,ne=[],Te=0;Te<G;Te++){var Ae=eC(V[Te]);Ae!==0&&(Y===void 0&&(Y=Ae<0),Y===Ae<0?($&&ne.push($),$=[V[Te]]):$.push(V[Te]))}return $&&ne.push($),ne}(v),a=0;a<v.length;a++)for(l=0;l<v[a].length;l++)L(v[a][l])}v.length===1?v=v[0]:S="Multi"+S;var O={type:"Feature",geometry:{type:S,coordinates:v},properties:this.properties};return"id"in this&&(O.id=this.id),O};var tC=R1,D1=z1;function z1(t,e){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=t,this._keys=[],this._values=[],this._features=[],t.readFields(iC,this,e),this.length=this._features.length}function iC(t,e,n){t===15?e.version=n.readVarint():t===1?e.name=n.readString():t===5?e.extent=n.readVarint():t===2?e._features.push(n.pos):t===3?e._keys.push(n.readString()):t===4&&e._values.push(function(a){for(var l=null,u=a.readVarint()+a.pos;a.pos<u;){var d=a.readVarint()>>3;l=d===1?a.readString():d===2?a.readFloat():d===3?a.readDouble():d===4?a.readVarint64():d===5?a.readVarint():d===6?a.readSVarint():d===7?a.readBoolean():null}return l}(n))}z1.prototype.feature=function(t){if(t<0||t>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[t];var e=this._pbf.readVarint()+this._pbf.pos;return new tC(this._pbf,e,this.extent,this._keys,this._values)};var nC=D1;function rC(t,e,n){if(t===3){var a=new nC(n,n.readVarint()+n.pos);a.length&&(e[a.name]=a)}}var X0=fy.VectorTile=function(t,e){this.layers=t.readFields(rC,{},e)},my=fy.VectorTileFeature=R1;fy.VectorTileLayer=D1;class af extends Kt{constructor(e,n,a){super(e,n),this.z=a}}class O1 extends af{constructor(e,n,a,l){super(e,n,a),this.w=l}}function gy(t,e,n,a){const l=[],u=a===0?(d,x,v,S,L,P)=>{d.push(new Kt(P,v+(P-x)/(S-x)*(L-v)))}:(d,x,v,S,L,P)=>{d.push(new Kt(x+(P-v)/(L-v)*(S-x),P))};for(const d of t){const x=[];for(const v of d){if(v.length<=2)continue;const S=[];for(let O=0;O<v.length-1;O++){const V=v[O].x,G=v[O].y,$=v[O+1].x,Y=v[O+1].y,ne=a===0?V:G,Te=a===0?$:Y;ne<e?Te>e&&u(S,V,G,$,Y,e):ne>n?Te<n&&u(S,V,G,$,Y,n):S.push(v[O]),Te<e&&ne>=e&&u(S,V,G,$,Y,e),Te>n&&ne<=n&&u(S,V,G,$,Y,n)}let L=v[v.length-1];const P=a===0?L.x:L.y;P>=e&&P<=n&&S.push(L),S.length&&(L=S[S.length-1],S[0].x===L.x&&S[0].y===L.y||S.push(S[0]),x.push(S))}x.length&&l.push(x)}return l}function F1(t,e,n,a){const l=n==="x"?"y":"x",u=(a-t[n])/(e[n]-t[n]);t[l]=t[l]+(e[l]-t[l])*u,t[n]=a,t.hasOwnProperty("z")&&(t.z=Qn(t.z,e.z,u)),t.hasOwnProperty("w")&&(t.w=Qn(t.w,e.w,u))}function k1(t,e,n,a){const l=n,u=a;for(const d of["x","y"]){let x=t,v=e;x[d]>=v[d]&&(x=e,v=t),x[d]<l&&v[d]>l&&F1(x,v,d,l),x[d]<u&&v[d]>u&&F1(v,x,d,u)}}function _y(t,e){return t.x-e.x||t.y-e.y}function B1(t,e){return _y(t.min,e.min)===0&&_y(t.max,e.max)===0}function $0(t,e){return!(t.min.x>e.max.x||t.max.x<e.min.x||t.min.y>e.max.y||t.max.y<e.min.y)}function Y0(t,e){if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(t[n].sourceId!==e[n].sourceId||!B1(t[n],e[n])||t[n].order!==e[n].order||t[n].clipMask!==e[n].clipMask)return!1;return!0}function N1(t,e,n){const a=1/ji,l=1/(1<<n.canonical.z),u=(e.x*a+n.canonical.x)*l+n.wrap,d=(e.y*a+n.canonical.y)*l;return{min:new Kt((t.x*a+n.canonical.x)*l+n.wrap,(t.y*a+n.canonical.y)*l),max:new Kt(u,d)}}function sC(t,e,n){const a=1<<n.canonical.z,l=((e.x-n.wrap)*a-n.canonical.x)*ji,u=(e.y*a-n.canonical.y)*ji;return{min:new Kt(((t.x-n.wrap)*a-n.canonical.x)*ji,(t.y*a-n.canonical.y)*ji),max:new Kt(l,u)}}function U1(t,e,n,a,l,u,d){const x=t.indices,v=t.vertices,S=[];for(let L=a;L<a+l;L+=3){const P=e[n[L+0]+u],O=e[n[L+1]+u],V=e[n[L+2]+u],G=Math.min(P.x,O.x,V.x),$=Math.max(P.x,O.x,V.x),Y=Math.min(P.y,O.y,V.y),ne=Math.max(P.y,O.y,V.y);S.length=0,t.grid.query(new Kt(G,Y),new Kt($,ne),S);for(let Te=0;Te<S.length;Te++){const Ae=S[Te];if(J(v[x[3*Ae+0]],v[x[3*Ae+1]],v[x[3*Ae+2]],P,O,V,d))return!0}}return!1}function V1(t,e,n,a){if(!t||!n)return!1;let l=t.vertices;if(!e.canonical.equals(a.canonical)||e.wrap!==a.wrap){if(n.vertices.length<t.vertices.length)return V1(n,a,t,e);const u=e.canonical,d=a.canonical,x=Math.pow(2,d.z-u.z);l=t.vertices.map(v=>new Kt((v.x+u.x*ji)*x-d.x*ji,(v.y+u.y*ji)*x-d.y*ji))}return U1(n,l,t.indices,0,t.indices.length,0,0)}function G1(t,e,n,a){const l=Math.pow(2,a.z-n.z);return new Kt((t+n.x*ji)*l-a.x*ji,(e+n.y*ji)*l-a.y*ji)}function H1(t,e){const n=[];e.footprint.grid.queryPoint(t,n);const a=e.footprint.indices,l=e.footprint.vertices;for(let u=0;u<n.length;u++){const d=n[u];if(z([l[a[3*d+0]],l[a[3*d+1]],l[a[3*d+2]]],t))return!0}return!1}class j1{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,n){const a=this.toIdx(e,n);return{min:this.minimums[a],max:this.maximums[a]}}isLeaf(e,n){return this.leaves[this.toIdx(e,n)]}toIdx(e,n){return n*this.size+e}}function W1(t,e,n,a){let l=0,u=Number.MAX_VALUE;for(let d=0;d<3;d++)if(Math.abs(a[d])<1e-15){if(n[d]<t[d]||n[d]>e[d])return null}else{const x=1/a[d];let v=(t[d]-n[d])*x,S=(e[d]-n[d])*x;if(v>S){const L=v;v=S,S=L}if(v>l&&(l=v),S<u&&(u=S),l>u)return null}return l}function q1(t,e,n,a,l,u,d,x,v,S,L){const P=a-t,O=l-e,V=u-n,G=d-t,$=x-e,Y=v-n,ne=L[1]*Y-L[2]*$,Te=L[2]*G-L[0]*Y,Ae=L[0]*$-L[1]*G,Ce=P*ne+O*Te+V*Ae;if(Math.abs(Ce)<1e-15)return null;const qe=1/Ce,Ge=S[0]-t,ot=S[1]-e,dt=S[2]-n,Rt=(Ge*ne+ot*Te+dt*Ae)*qe;if(Rt<0||Rt>1)return null;const $t=ot*V-dt*O,Vt=dt*P-Ge*V,ai=Ge*O-ot*P,Ci=(L[0]*$t+L[1]*Vt+L[2]*ai)*qe;return Ci<0||Rt+Ci>1?null:(G*$t+$*Vt+Y*ai)*qe}function Z1(t,e,n){return(t-e)/(n-e)}function X1(t,e,n,a,l,u,d,x,v){const S=1<<n,L=u-a,P=d-l,O=(t+1)/S*L+a,V=(e+0)/S*P+l,G=(e+1)/S*P+l;x[0]=(t+0)/S*L+a,x[1]=V,v[0]=O,v[1]=G}class $1{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const n=function(u){const d=Math.ceil(Math.log2(u.dim/8)),x=[];let v=Math.ceil(Math.pow(2,d));const S=1/v,L=(V,G,$,Y,ne)=>{const Te=Y?1:0,Ae=(V+1)*$-Te,Ce=G*$,qe=(G+1)*$-Te;ne[0]=V*$,ne[1]=Ce,ne[2]=Ae,ne[3]=qe};let P=new j1(v);const O=[];for(let V=0;V<v*v;V++){L(V%v,Math.floor(V/v),S,!1,O);const G=sp(O[0],O[1],u),$=sp(O[2],O[1],u),Y=sp(O[2],O[3],u),ne=sp(O[0],O[3],u);P.minimums.push(Math.min(G,$,Y,ne)),P.maximums.push(Math.max(G,$,Y,ne)),P.leaves.push(1)}for(x.push(P),v/=2;v>=1;v/=2){const V=x[x.length-1];P=new j1(v);for(let G=0;G<v*v;G++){L(G%v,Math.floor(G/v),2,!0,O);const $=V.getElevation(O[0],O[1]),Y=V.getElevation(O[2],O[1]),ne=V.getElevation(O[2],O[3]),Te=V.getElevation(O[0],O[3]),Ae=V.isLeaf(O[0],O[1]),Ce=V.isLeaf(O[2],O[1]),qe=V.isLeaf(O[2],O[3]),Ge=V.isLeaf(O[0],O[3]),ot=Math.min($.min,Y.min,ne.min,Te.min),dt=Math.max($.max,Y.max,ne.max,Te.max),Rt=Ae&&Ce&&qe&&Ge;P.maximums.push(dt),P.minimums.push(ot),P.leaves.push(dt-ot<=5&&Rt?1:0)}x.push(P)}return x}(this.dem),a=n.length-1,l=n[a];this._addNode(l.minimums[0],l.maximums[0],l.leaves[0]),this._construct(n,0,0,a,0)}raycastRoot(e,n,a,l,u,d,x=1){return W1([e,n,-100],[a,l,this.maximums[0]*x],u,d)}raycast(e,n,a,l,u,d,x=1){if(!this.nodeCount)return null;const v=this.raycastRoot(e,n,a,l,u,d,x);if(v==null)return null;const S=[],L=[],P=[],O=[],V=[{idx:0,t:v,nodex:0,nodey:0,depth:0}];for(;V.length>0;){const{idx:G,t:$,nodex:Y,nodey:ne,depth:Te}=V.pop();if(this.leaves[G]){X1(Y,ne,Te,e,n,a,l,P,O);const Ce=1<<Te,qe=(Y+0)/Ce,Ge=(Y+1)/Ce,ot=(ne+0)/Ce,dt=(ne+1)/Ce,Rt=sp(qe,ot,this.dem)*x,$t=sp(Ge,ot,this.dem)*x,Vt=sp(Ge,dt,this.dem)*x,ai=sp(qe,dt,this.dem)*x,Ci=q1(P[0],P[1],Rt,O[0],P[1],$t,O[0],O[1],Vt,u,d),ti=q1(O[0],O[1],Vt,P[0],O[1],ai,P[0],P[1],Rt,u,d),bi=Math.min(Ci!==null?Ci:Number.MAX_VALUE,ti!==null?ti:Number.MAX_VALUE);if(bi!==Number.MAX_VALUE)return bi;{const Yt=s._.scaleAndAdd([],u,d,$);if(Y1(Rt,$t,ai,Vt,Z1(Yt[0],P[0],O[0]),Z1(Yt[1],P[1],O[1]))>=Yt[2])return $}continue}let Ae=0;for(let Ce=0;Ce<this._siblingOffset.length;Ce++){X1((Y<<1)+this._siblingOffset[Ce][0],(ne<<1)+this._siblingOffset[Ce][1],Te+1,e,n,a,l,P,O),P[2]=-100,O[2]=this.maximums[this.childOffsets[G]+Ce]*x;const qe=W1(P,O,u,d);if(qe!=null){const Ge=qe;S[Ce]=Ge;let ot=!1;for(let dt=0;dt<Ae&&!ot;dt++)Ge>=S[L[dt]]&&(L.splice(dt,0,Ce),ot=!0);ot||(L[Ae]=Ce),Ae++}}for(let Ce=0;Ce<Ae;Ce++){const qe=L[Ce];V.push({idx:this.childOffsets[G]+qe,t:S[qe],nodex:(Y<<1)+this._siblingOffset[qe][0],nodey:(ne<<1)+this._siblingOffset[qe][1],depth:Te+1})}}return null}_addNode(e,n,a){return this.minimums.push(e),this.maximums.push(n),this.leaves.push(a),this.childOffsets.push(0),this.nodeCount++}_construct(e,n,a,l,u){if(e[l].isLeaf(n,a)===1)return;this.childOffsets[u]||(this.childOffsets[u]=this.nodeCount);const d=l-1,x=e[d];let v=0,S=0;for(let L=0;L<this._siblingOffset.length;L++){const P=2*n+this._siblingOffset[L][0],O=2*a+this._siblingOffset[L][1],V=x.getElevation(P,O),G=x.isLeaf(P,O),$=this._addNode(V.min,V.max,G);G&&(v|=1<<L),S||(S=$)}for(let L=0;L<this._siblingOffset.length;L++)v&1<<L||this._construct(e,2*n+this._siblingOffset[L][0],2*a+this._siblingOffset[L][1],d,S+L)}}function Y1(t,e,n,a,l,u){return Qn(Qn(t,n,u),Qn(e,a,u),l)}function sp(t,e,n){const a=n.dim,l=pn(t*a-.5,0,a-1),u=pn(e*a-.5,0,a-1),d=Math.floor(l),x=Math.floor(u),v=Math.min(d+1,a-1),S=Math.min(x+1,a-1);return Y1(n.get(d,x),n.get(v,x),n.get(d,S),n.get(v,S),l-d,u-x)}const oC={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function aC(t,e,n){return(256*t*256+256*e+n)/10-1e4}function lC(t,e,n){return 256*t+e+n/256-32768}class yy{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,n,a,l=!1){if(this.uid=e,n.height!==n.width)throw new RangeError("DEM tiles must be square");if(a&&a!=="mapbox"&&a!=="terrarium")return Is(`"${a}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=n.height;const u=this.dim=n.height-2,d=new Uint32Array(n.data.buffer);if(this.pixels=new Uint8Array(n.data.buffer),this.floatView=new Float32Array(n.data.buffer),this.borderReady=l,this._modifiedForSources={},!l){for(let v=0;v<u;v++)d[this._idx(-1,v)]=d[this._idx(0,v)],d[this._idx(u,v)]=d[this._idx(u-1,v)],d[this._idx(v,-1)]=d[this._idx(v,0)],d[this._idx(v,u)]=d[this._idx(v,u-1)];d[this._idx(-1,-1)]=d[this._idx(0,0)],d[this._idx(u,-1)]=d[this._idx(u-1,0)],d[this._idx(-1,u)]=d[this._idx(0,u-1)],d[this._idx(u,u)]=d[this._idx(u-1,u-1)]}const x=a==="terrarium"?lC:aC;for(let v=0;v<d.length;++v){const S=4*v;this.floatView[v]=x(this.pixels[S],this.pixels[S+1],this.pixels[S+2])}this._timestamp=mo.now()}_buildQuadTree(){this._tree=new $1(this)}get(e,n,a=!1){a&&(e=pn(e,-1,this.dim),n=pn(n,-1,this.dim));const l=this._idx(e,n);return this.floatView[l]}set(e,n,a){const l=this._idx(e,n),u=this.floatView[l];return this.floatView[l]=a,a-u}static getUnpackVector(e){return oC[e]}_idx(e,n){if(e<-1||e>=this.dim+1||n<-1||n>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(n+1)*this.stride+(e+1)}static pack(e,n){const a=[0,0,0,0],l=yy.getUnpackVector(n);let u=Math.floor((e+l[3])/l[2]);return a[2]=u%256,u=Math.floor(u/256),a[1]=u%256,u=Math.floor(u/256),a[0]=u,a}getPixels(){return new Ng({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,n,a){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let l=n*this.dim,u=n*this.dim+this.dim,d=a*this.dim,x=a*this.dim+this.dim;switch(n){case-1:l=u-1;break;case 1:u=l+1}switch(a){case-1:d=x-1;break;case 1:x=d+1}const v=-n*this.dim,S=-a*this.dim;for(let L=d;L<x;L++)for(let P=l;P<u;P++){const O=4*this._idx(P,L),V=4*this._idx(P+v,L+S);this.pixels[O+0]=e.pixels[V+0],this.pixels[O+1]=e.pixels[V+1],this.pixels[O+2]=e.pixels[V+2],this.pixels[O+3]=e.pixels[V+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}xe(yy,"DEMData"),xe($1,"DemMinMaxQuadTree",{omit:["dem"]});class Pm{constructor(e,n,a){this._demTile=e,this._dem=this._demTile.dem,this._scale=n,this._offset=a}static create(e,n,a){const l=a||e.findDEMTileFor(n);if(!l||!l.dem)return;const u=l.dem,d=l.tileID,x=1<<n.canonical.z-d.canonical.z;return new Pm(l,u.dim/ji/x,[(n.canonical.x/x-d.canonical.x)*u.dim,(n.canonical.y/x-d.canonical.y)*u.dim])}tileCoordToPixel(e,n){const a=n*this._scale+this._offset[1],l=Math.floor(e*this._scale+this._offset[0]),u=Math.floor(a);return new Kt(l,u)}getElevationAt(e,n,a,l){const u=e*this._scale+this._offset[0],d=n*this._scale+this._offset[1],x=Math.floor(u),v=Math.floor(d),S=this._dem;return l=!!l,a?Qn(Qn(S.get(x,v,l),S.get(x,v+1,l),d-v),Qn(S.get(x+1,v,l),S.get(x+1,v+1,l),d-v),u-x):S.get(x,v,l)}getElevationAtPixel(e,n,a){return this._dem.get(e,n,!!a)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*Go(1,e)*this._dem.stride}}const J1={None:0,Model:1,Symbol:2,FillExtrusion:4,All:7},cC=my.types,hC=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius"],uC=["fill-extrusion-flood-light-ground-radius"],dC=Math.pow(2,13),pC=Math.pow(2,15)-1,K1=new Kt(0,1),op=2147483648;function Vg(t,e,n,a,l,u,d,x){t.emplaceBack((e<<1)+d,(n<<1)+u,(Math.floor(a*dC)<<1)+l,Math.round(x))}function xy(t,e,n,a,l,u){t.emplaceBack(e.x,e.y,(n.x<<1)+a,(n.y<<1)+l,u)}function Gg(t,e,n){t.emplaceBack(e.x,e.y,e.z,n[0]*16384,n[1]*16384,n[2]*16384)}class Q1{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class eb{constructor(){this.centroidXY=new Kt(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new Kt(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new Kt(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new Kt(this.max.x-this.min.x,this.max.y-this.min.y)}}class ib{constructor(){this.acc=new Kt(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(e,n){e.min.x===Number.MAX_VALUE&&(e.min.x=e.max.x=n.x,e.min.y=e.max.y=n.y)}appendEdge(e,n,a){this.accCount++,this.acc._add(n);let l=!!this.borders;n.x<e.min.x?(e.min.x=n.x,l=!0):n.x>e.max.x&&(e.max.x=n.x,l=!0),n.y<e.min.y?(e.min.y=n.y,l=!0):n.y>e.max.y&&(e.max.y=n.y,l=!0),((n.x===0||n.x===ji)&&n.x===a.x)!=((n.y===0||n.y===ji)&&n.y===a.y)&&this.processBorderOverlap(n,a),l&&this.checkBorderIntersection(n,a)}checkBorderIntersection(e,n){n.x<0!=e.x<0&&this.addBorderIntersection(0,Qn(n.y,e.y,(0-n.x)/(e.x-n.x))),n.x>ji!=e.x>ji&&this.addBorderIntersection(1,Qn(n.y,e.y,(ji-n.x)/(e.x-n.x))),n.y<0!=e.y<0&&this.addBorderIntersection(2,Qn(n.x,e.x,(0-n.y)/(e.y-n.y))),n.y>ji!=e.y>ji&&this.addBorderIntersection(3,Qn(n.x,e.x,(ji-n.y)/(e.y-n.y)))}addBorderIntersection(e,n){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const a=this.borders[e];n<a[0]&&(a[0]=n),n>a[1]&&(a[1]=n)}processBorderOverlap(e,n){if(e.x===n.x){if(e.y===n.y)return;const a=e.x===0?0:1;this.addBorderIntersection(a,n.y),this.addBorderIntersection(a,e.y)}else{const a=e.y===0?2:3;this.addBorderIntersection(a,n.x),this.addBorderIntersection(a,e.x)}}centroid(){return this.accCount===0?new Kt(0,0):new Kt(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((e,n)=>e+ +(n[0]!==Number.MAX_VALUE),0):0}}function nb(t,e){const n=t.add(e)._unit(),a=pn(t.x*n.x+t.y*n.y,-1,1);var l,u,d;return l=Math.acos(a),Math.min(4,Math.max(-4,Math.tan(l)))/4*pC*((u=t).x*(d=e).y-u.y*d.x<0?-1:1)}const fC=[t=>t.x<0,t=>t.x>ji,t=>t.y<0,t=>t.y>ji];function mC(t,e,n,a){const l=[4];if(a===0)return l;n._mult(a);const u=t.sub(n),d=e.sub(n),x=[t,e,u,d];for(let v=0;v<4;v++)for(const S of x)if(fC[v](S)){l.push(v);break}return l}class rb{constructor(e){this.vertexArray=new dl,this.indexArray=new no,this.programConfigurations=new Ph(e.layers,{zoom:e.zoom,lut:e.lut},n=>uC.includes(n)),this._segments=new Ts,this.hiddenByLandmarkVertexArray=new pm,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new Ts}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(e,n,a,l=!1){const u=e.length;if(u>2){let d=Math.max(0,this._segments.get().length-1);const x=this._segments._prepareSegment(4*u,this.vertexArray.length,2*this._segmentToGroundQuads[d].length);let v;d!==this._segments.get().length-1&&(d++,this._segmentToGroundQuads[d]=[],this._segmentToRegionTriCounts[d]=[0,0,0,0,0]);{const S=e[0],L=e[1];v=nb(S.sub(e[u-1])._perp()._unit(),L.sub(S)._perp()._unit())}for(let S=0;S<u;S++){const L=S===u-1?0:S+1,P=e[S],O=e[L],V=e[L===u-1?0:L+1],G=O.sub(P)._perp()._unit(),$=nb(G,V.sub(O)._perp()._unit()),Y=v,ne=$;if(J0(P,O,n)||l&&ab(P,n)&&ab(O,n)){v=$;continue}const Te=x.vertexLength;xy(this.vertexArray,P,O,1,1,Y),xy(this.vertexArray,P,O,1,0,Y),xy(this.vertexArray,P,O,0,1,ne),xy(this.vertexArray,P,O,0,0,ne),x.vertexLength+=4;const Ae=mC(P,O,G,a);for(const Ce of Ae)this._segmentToGroundQuads[d].push({id:Te,region:Ce}),this._segmentToRegionTriCounts[d][Ce]+=2,x.primitiveLength+=2;v=$}}}prepareBorderSegments(){if(!this.hasData())return;const e=this._segments.get(),n=e.length;for(let a=0;a<n;a++)this._segmentToGroundQuads[a].sort((l,u)=>l.region-u.region);for(let a=0;a<n;a++){const l=this._segmentToGroundQuads[a],u=e[a],d=this._segmentToRegionTriCounts[a];d.reduce((v,S)=>v+S,0);let x=0;for(let v=0;v<=4;v++){const S=d[v];if(S!==0){let L=this.regionSegments[v];L||(L=this.regionSegments[v]=new Ts);const P={vertexOffset:u.vertexOffset,primitiveOffset:u.primitiveOffset+x,vertexLength:u.vertexLength,primitiveLength:S};L.get().push(P)}x+=S}for(let v=0;v<l.length;v++){const S=l[v].id;this.indexArray.emplaceBack(S,S+1,S+3),this.indexArray.emplaceBack(S,S+3,S+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(e,n,a,l,u,d){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,e,n,a,l,u,d)}upload(e){this.hasData()&&(this.vertexBuffer=e.createVertexBuffer(this.vertexArray,ZA.members),this.indexBuffer=e.createIndexBuffer(this.indexArray))}uploadPaintProperties(e){this.hasData()&&this.programConfigurations.upload(e)}update(e,n,a,l,u,d){this.hasData()&&this.programConfigurations.updatePaintArrays(e,n,a,l,u,d)}updateHiddenByLandmark(e){if(!this.hasData())return;const n=e.groundVertexCount+e.groundVertexArrayOffset;if(e.groundVertexCount===0)return;const a=e.flags&op?1:0;for(let l=e.groundVertexArrayOffset;l<n;++l)this.hiddenByLandmarkVertexArray.emplace(l,a);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(e){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=e.createVertexBuffer(this.hiddenByLandmarkVertexArray,$A.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let e=0;e<=4;e++){const n=this.regionSegments[e];n&&n.destroy()}}}}class vy{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=e.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new no,this.footprintVertices=new Fl,this.footprintSegments=[],this.layoutVertexArray=new Sh,this.centroidVertexArray=new vm,this.indexArray=new no,this.programConfigurations=new Ph(e.layers,{zoom:e.zoom,lut:e.lut},n=>hC.includes(n)),this.segments=new Ts,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.groundEffect=new rb(e),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[]}updateFootprints(e,n){}populate(e,n,a,l){this.features=[],this.hasPattern=yl("fill-extrusion",this.layers,n),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.tileToMeter=nf(a),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter;for(const{feature:u,id:d,index:x,sourceLayerIndex:v}of e){const S=this.layers[0]._featureFilter.needGeometry,L=gc(u,S);if(!this.layers[0]._featureFilter.filter(new ir(this.zoom),L,a))continue;const P={id:d,sourceLayerIndex:v,index:x,geometry:S?L.geometry:Za(u,a,l),properties:u.properties,type:u.type,patterns:{}},O=this.layoutVertexArray.length;this.hasPattern?this.features.push(xl("fill-extrusion",this.layers,P,this.zoom,n)):this.addFeature(P,P.geometry,x,a,{},n.availableImages,l,n.brightness),n.featureIndex.insert(u,P.geometry,x,v,this.index,O)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(e,n,a,l,u,d){for(const x of this.features){const{geometry:v}=x;this.addFeature(x,v,x.index,n,a,l,u,d)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(e,n,a,l,u){const d=Object.keys(e).length!==0;if(d&&!this.stateDependentLayers.length)return;const x=d?this.stateDependentLayers:this.layers;this.programConfigurations.updatePaintArrays(e,n,x,a,l,u),this.groundEffect.update(e,n,x,a,l,u)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,JA),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,YA.members,!0)),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.groundEffect.uploadHiddenByLandmark(e),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,XA.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,n,a,l,u,d,x,v){const S=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(e,{})/this.tileToMeter,L=[new Kt(0,0),new Kt(ji,ji)],P=x.projection,O=P.name==="globe",V=cC[e.type]==="Polygon",G=new ib;G.centroidDataIndex=this.centroidData.length;const $=new eb,Y=this.layers[0].paint.get("fill-extrusion-base").evaluate(e,{},l)<=0,ne=this.layers[0].paint.get("fill-extrusion-height").evaluate(e,{},l);$.height=ne,$.vertexArrayOffset=this.layoutVertexArray.length,$.groundVertexArrayOffset=this.groundEffect.vertexArray.length,O&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new Vc);const Te=_l(n,500);for(let dt=Te.length-1;dt>=0;dt--){const Rt=Te[dt];(Rt.length===0||(Ae=Rt[0]).every($t=>$t.x<=0)||Ae.every($t=>$t.x>=ji)||Ae.every($t=>$t.y<=0)||Ae.every($t=>$t.y>=ji))&&Te.splice(dt,1)}var Ae;let Ce;if(O)Ce=ub(Te,L,l);else{Ce=[];for(const dt of Te)Ce.push({polygon:dt,bounds:L})}const qe=V?this.edgeRadius:0,Ge=qe>0&&this.zoom<17,ot=(dt,Rt)=>{if(dt.length===0)return!1;const $t=dt[dt.length-1];return Rt.x===$t.x&&Rt.y===$t.y};for(const{polygon:dt,bounds:Rt}of Ce){let $t=0,Vt=0;for(const bi of dt)V&&!bi[0].equals(bi[bi.length-1])&&bi.push(bi[0]),Vt+=V?bi.length-1:bi.length;const ai=this.segments.prepareSegment((V?5:4)*Vt,this.layoutVertexArray,this.indexArray);$.footprintSegIdx<0&&($.footprintSegIdx=this.footprintSegments.length),$.polygonSegIdx<0&&($.polygonSegIdx=this.polygonSegments.length);const Ci={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},ti=new Q1;if(ti.vertexOffset=this.footprintVertices.length,ti.indexOffset=3*this.footprintIndices.length,ti.ringIndices=[],V){const bi=[],Yt=[];$t=ai.vertexLength;for(let zi=0;zi<dt.length;zi++){const Si=dt[zi];Si.length&&zi!==0&&Yt.push(bi.length/2);const fn=[];let Ii,Ui;Ii=Si[1].sub(Si[0])._perp()._unit(),ti.ringIndices.push(Si.length-1);for(let qn=1;qn<Si.length;qn++){const Fn=Si[qn],Rn=Si[qn===Si.length-1?1:qn+1],Fi=Fn.clone();if(qe){Ui=Rn.sub(Fn)._perp()._unit();const Zn=Ii.add(Ui)._unit(),Cr=qe*Math.min(4,1/(Ii.x*Zn.x+Ii.y*Zn.y));Fi.x+=Cr*Zn.x,Fi.y+=Cr*Zn.y,Fi.x=Math.round(Fi.x),Fi.y=Math.round(Fi.y),Ii=Ui}!Y||qe!==0&&!Ge||ot(fn,Fi)||fn.push(Fi),Vg(this.layoutVertexArray,Fi.x,Fi.y,0,0,1,1,0),ai.vertexLength++,this.footprintVertices.emplaceBack(Fn.x,Fn.y),bi.push(Fn.x,Fn.y),O&&Gg(this.layoutVertexExtArray,P.projectTilePoint(Fi.x,Fi.y,l),P.upVector(l,Fi.x,Fi.y))}Y&&(qe===0||Ge)&&(fn.length!==0&&ot(fn,fn[0])&&fn.pop(),this.groundEffect.addData(fn,Rt,S))}const wi=fu(bi,Yt);for(let zi=0;zi<wi.length;zi+=3)this.footprintIndices.emplaceBack(ti.vertexOffset+wi[zi+0],ti.vertexOffset+wi[zi+1],ti.vertexOffset+wi[zi+2]),this.indexArray.emplaceBack($t+wi[zi],$t+wi[zi+2],$t+wi[zi+1]),ai.primitiveLength++;ti.indexCount+=wi.length,ti.vertexCount+=this.footprintVertices.length-ti.vertexOffset}for(let bi=0;bi<dt.length;bi++){const Yt=dt[bi];G.startRing($,Yt[0]);let wi=Yt.length>4&&lb(Yt[Yt.length-2],Yt[0],Yt[1]),zi=qe?gC(Yt[Yt.length-2],Yt[0],Yt[1],qe):0;const Si=[];let fn,Ii,Ui;Ii=Yt[1].sub(Yt[0])._perp()._unit();let qn=!0;for(let Fn=1,Rn=0;Fn<Yt.length;Fn++){let Fi=Yt[Fn-1],Zn=Yt[Fn];const Cr=Yt[Fn===Yt.length-1?1:Fn+1];if(G.appendEdge($,Zn,Fi),J0(Zn,Fi,Rt)){qe&&(Ii=Cr.sub(Zn)._perp()._unit(),qn=!qn);continue}const or=Zn.sub(Fi)._perp(),Pr=or.x/(Math.abs(or.x)+Math.abs(or.y)),Lr=or.y>0?1:0,Fr=Fi.dist(Zn);if(Rn+Fr>32768&&(Rn=0),qe){Ui=Cr.sub(Zn)._perp()._unit();let is=ob(Fi,Zn,Cr,sb(Ii,Ui),qe);isNaN(is)&&(is=0);const $r=Zn.sub(Fi)._unit();Fi=Fi.add($r.mult(zi))._round(),Zn=Zn.add($r.mult(-is))._round(),zi=is,Ii=Ui,Y&&this.zoom>=17&&(ot(Si,Fi)||Si.push(Fi),ot(Si,Zn)||Si.push(Zn))}const nr=ai.vertexLength,bs=Yt.length>4&&lb(Fi,Zn,Cr);let _s=cb(Rn,wi,qn);if(Vg(this.layoutVertexArray,Fi.x,Fi.y,Pr,Lr,0,0,_s),Vg(this.layoutVertexArray,Fi.x,Fi.y,Pr,Lr,0,1,_s),Rn+=Fr,_s=cb(Rn,bs,!qn),wi=bs,Vg(this.layoutVertexArray,Zn.x,Zn.y,Pr,Lr,0,0,_s),Vg(this.layoutVertexArray,Zn.x,Zn.y,Pr,Lr,0,1,_s),ai.vertexLength+=4,this.indexArray.emplaceBack(nr+0,nr+1,nr+2),this.indexArray.emplaceBack(nr+1,nr+3,nr+2),ai.primitiveLength+=2,qe){const is=$t+(Fn===1?Yt.length-2:Fn-2),$r=Fn===1?$t:is+1;if(this.indexArray.emplaceBack(nr+1,is,nr+3),this.indexArray.emplaceBack(is,$r,nr+3),ai.primitiveLength+=2,fn===void 0&&(fn=nr),!J0(Cr,Yt[Fn],Rt)){const ns=Fn===Yt.length-1?fn:ai.vertexLength;this.indexArray.emplaceBack(nr+2,nr+3,ns),this.indexArray.emplaceBack(nr+3,ns+1,ns),this.indexArray.emplaceBack(nr+3,$r,ns+1),ai.primitiveLength+=3}qn=!qn}if(O){const is=this.layoutVertexExtArray,$r=P.projectTilePoint(Fi.x,Fi.y,l),ns=P.projectTilePoint(Zn.x,Zn.y,l),Ps=P.upVector(l,Fi.x,Fi.y),Ss=P.upVector(l,Zn.x,Zn.y);Gg(is,$r,Ps),Gg(is,$r,Ps),Gg(is,ns,Ss),Gg(is,ns,Ss)}}V&&($t+=Yt.length-1),Y&&qe&&this.zoom>=17&&(Si.length!==0&&ot(Si,Si[0])&&Si.pop(),this.groundEffect.addData(Si,Rt,S,qe>0))}this.footprintSegments.push(ti),Ci.triangleCount=this.indexArray.length-Ci.triangleArrayOffset,this.polygonSegments.push(Ci),++$.footprintSegLen,++$.polygonSegLen}if($.vertexCount=this.layoutVertexArray.length-$.vertexArrayOffset,$.groundVertexCount=this.groundEffect.vertexArray.length-$.groundVertexArrayOffset,$.vertexCount!==0){if($.centroidXY=G.borders?K1:this.encodeCentroid(G,$),this.centroidData.push($),G.borders){this.featuresOnBorder.push(G);const dt=this.featuresOnBorder.length-1;for(let Rt=0;Rt<G.borders.length;Rt++)G.borders[Rt][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[Rt].push(dt)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,a,u,d,l,v),this.groundEffect.addPaintPropertiesData(e,a,u,d,l,v),this.maxHeight=Math.max(this.maxHeight,ne)}}sortBorders(){for(let e=0;e<this.borderFeatureIndices.length;e++)this.borderFeatureIndices[e].sort((n,a)=>this.featuresOnBorder[n].borders[e][0]-this.featuresOnBorder[a].borders[e][0])}splitToSubtiles(){const e=[];for(let x=0;x<this.centroidData.length;x++){const v=this.centroidData[x],S=+(v.min.y+v.max.y>ji),L=2*S+(+(v.min.x+v.max.x>ji)^S);for(let P=0;P<v.polygonSegLen;P++){const O=v.polygonSegIdx+P;e.push({centroidIdx:x,subtile:L,polygonSegmentIdx:O,triangleSegmentIdx:this.polygonSegments[O].triangleSegIdx})}}const n=new no;e.sort((x,v)=>x.triangleSegmentIdx===v.triangleSegmentIdx?x.subtile-v.subtile:x.triangleSegmentIdx-v.triangleSegmentIdx);let a=0,l=0,u=0;for(const x of e){if(x.triangleSegmentIdx!==a)break;u++}const d=e.length;for(;l!==e.length;){a=e[l].triangleSegmentIdx;let x=0,v=l,S=l;for(let L=v;L<u&&e[L].subtile===x;L++)S++;for(;v!==u;){const L=e[v];x=L.subtile;const P=this.centroidData[L.centroidIdx].min.clone(),O=this.centroidData[L.centroidIdx].max.clone(),V={vertexOffset:this.segments.segments[a].vertexOffset,primitiveOffset:n.length,vertexLength:this.segments.segments[a].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let G=v;G<S;G++){const $=e[G],Y=this.polygonSegments[$.polygonSegmentIdx],ne=this.centroidData[$.centroidIdx].min,Te=this.centroidData[$.centroidIdx].max,Ae=this.indexArray.uint16;for(let Ce=Y.triangleArrayOffset;Ce<Y.triangleArrayOffset+Y.triangleCount;Ce++)n.emplaceBack(Ae[3*Ce],Ae[3*Ce+1],Ae[3*Ce+2]);V.primitiveLength+=Y.triangleCount,P.x=Math.min(P.x,ne.x),P.y=Math.min(P.y,ne.y),O.x=Math.max(O.x,Te.x),O.y=Math.max(O.y,Te.y)}V.primitiveLength>0&&this.triangleSubSegments.push({segment:V,min:P,max:O}),v=S;for(let G=v;G<u&&e[G].subtile===e[v].subtile;G++)S++}l=u;for(let L=l;L<d&&e[L].triangleSegmentIdx===e[l].triangleSegmentIdx;L++)u++}n._trim(),this.indexArray=n}getVisibleSegments(e,n,a){let l=0,u=0;const d=1<<e.canonical.z;if(n){const $=n.getMinMaxForTile(e);$&&(l=$.min,u=$.max)}u+=this.maxHeight;const x=e.toUnwrapped();let v;const S=[x.canonical.x/d+x.wrap,x.canonical.y/d],L=[(x.canonical.x+1)/d+x.wrap,(x.canonical.y+1)/d],P=new Ts,O=($,Y,ne)=>[$[0]*(1-ne[0])+Y[0]*ne[0],$[1]*(1-ne[1])+Y[1]*ne[1]],V=[],G=[];for(const $ of this.triangleSubSegments){V[0]=$.min.x/ji,V[1]=$.min.y/ji,G[0]=$.max.x/ji,G[1]=$.max.y/ji;const Y=O(S,L,V),ne=O(S,L,G);if(new Xt([Y[0],Y[1],l],[ne[0],ne[1],u]).intersectsPrecise(a)===0){v&&(P.segments.push(v),v=void 0);continue}const Te=$.segment;v&&v.vertexOffset!==Te.vertexOffset&&(P.segments.push(v),v=void 0),v?(v.vertexLength+=Te.vertexLength,v.primitiveLength+=Te.primitiveLength):v={vertexOffset:Te.vertexOffset,primitiveLength:Te.primitiveLength,vertexLength:Te.vertexLength,primitiveOffset:Te.primitiveOffset,sortKey:void 0,vaos:{}}}return v&&P.segments.push(v),P}encodeCentroid(e,n){const a=e.centroid(),l=n.span(),u=Math.min(7,Math.round(l.x*this.tileToMeter/10)),d=Math.min(7,Math.round(l.y*this.tileToMeter/10));return new Kt(pn(a.x,1,ji-1)<<3|u,pn(a.y,1,ji-1)<<3|d)}encodeBorderCentroid(e){if(!e.borders)return new Kt(0,0);const n=e.borders,a=Number.MAX_VALUE;if(n[0][0]!==a||n[1][0]!==a){const l=n[0][0]!==a?0:1;return new Kt(6|(n[0][0]!==a?0:65528),(n[l][0]+n[l][1])/2<<3|6)}{const l=n[2][0]!==a?2:3;return new Kt((n[l][0]+n[l][1])/2<<3|6,6|(n[2][0]!==a?0:65528))}}showCentroid(e){const n=this.centroidData[e.centroidDataIndex];n.flags&=op,n.centroidXY.x=0,n.centroidXY.y=0,this.writeCentroidToBuffer(n)}writeCentroidToBuffer(e){this.groundEffect.updateHiddenByLandmark(e);const n=e.vertexArrayOffset,a=e.vertexCount+e.vertexArrayOffset,l=e.flags&op?K1:e.centroidXY,u=this.centroidVertexArray.geta_centroid_pos0(n);if(this.centroidVertexArray.geta_centroid_pos1(n)!==l.y||u!==l.x){for(let d=n;d<a;++d)this.centroidVertexArray.emplace(d,l.x,l.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const e of this.centroidData)this.writeCentroidToBuffer(e)}updateReplacement(e,n,a){if(n.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=n.updateTime;const l=n.getReplacementRegionsForTile(e.toUnwrapped());if(Y0(this.activeReplacements,l))return;if(this.activeReplacements=l,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(const d of this.centroidData)d.flags&=2147483647;const u=[];for(const d of this.activeReplacements){if(d.order<a)continue;const x=Math.pow(2,d.footprintTileId.canonical.z-e.canonical.z);for(const v of this.centroidData)if(!(v.flags&op||d.min.x>v.max.x||v.min.x>d.max.x||d.min.y>v.max.y||v.min.y>d.max.y))for(let S=0;S<v.footprintSegLen;S++){const L=this.footprintSegments[v.footprintSegIdx+S];if(u.length=0,_C(this.footprintVertices,L.vertexOffset,L.vertexCount,d.footprintTileId.canonical,e.canonical,u),U1(d.footprint,u,this.footprintIndices.uint16,L.indexOffset,L.indexCount,-L.vertexOffset,-x)){v.flags|=op;break}}}for(const d of this.centroidData)this.writeCentroidToBuffer(d);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(e,n,a){let l=!1;for(let u=0;u<a.footprintSegLen;u++){const d=this.footprintSegments[a.footprintSegIdx+u];let x=0;for(const v of d.ringIndices){for(let S=x,L=v+x-1;S<v+x;L=S++){const P=this.footprintVertices.int16[2*(S+d.vertexOffset)+0],O=this.footprintVertices.int16[2*(S+d.vertexOffset)+1],V=this.footprintVertices.int16[2*(L+d.vertexOffset)+1];O>n!=V>n&&e<(this.footprintVertices.int16[2*(L+d.vertexOffset)+0]-P)*(n-O)/(V-O)+P&&(l=!l)}x=v}}return l}getHeightAtTileCoord(e,n){let a=Number.NEGATIVE_INFINITY,l=!0;const u=4*(e+ji)*ji+(n+ji);if(this.partLookup.hasOwnProperty(u)){const d=this.partLookup[u];return d?{height:d.height,hidden:!!(d.flags&op)}:void 0}for(const d of this.centroidData)e>d.max.x||d.min.x>e||n>d.max.y||d.min.y>n||this.footprintContainsPoint(e,n,d)&&d&&d.height>a&&(a=d.height,this.partLookup[u]=d,l=!!(d.flags&op));if(a!==Number.NEGATIVE_INFINITY)return{height:a,hidden:l};this.partLookup[u]=void 0}}function sb(t,e){const n=t.add(e)._unit();return t.x*n.x+t.y*n.y}function gC(t,e,n,a){const l=e.sub(t)._perp()._unit(),u=n.sub(e)._perp()._unit();return ob(t,e,n,sb(l,u),a)}function ob(t,e,n,a,l){const u=Math.sqrt(1-a*a);return Math.min(t.dist(e)/3,e.dist(n)/3,l*u/a)}function J0(t,e,n){return t.x<n[0].x&&e.x<n[0].x||t.x>n[1].x&&e.x>n[1].x||t.y<n[0].y&&e.y<n[0].y||t.y>n[1].y&&e.y>n[1].y}function ab(t,e){return t.x<e[0].x||t.x>e[1].x||t.y<e[0].y||t.y>e[1].y}function lb(t,e,n){if(t.x<0||t.x>=ji||e.x<0||e.x>=ji||n.x<0||n.x>=ji)return!1;const a=n.sub(e),l=a.perp(),u=t.sub(e);return(a.x*u.x+a.y*u.y)/Math.sqrt((a.x*a.x+a.y*a.y)*(u.x*u.x+u.y*u.y))>-.866&&l.x*u.x+l.y*u.y<0}function cb(t,e,n){const a=e?2|t:-3&t;return n?1|a:-2&a}function hb(){const t=Math.PI/32,e=Math.tan(t),n=cd;return n*Math.sqrt(1+2*e*e)-n}function ub(t,e,n){const a=1<<n.z,l=oa(n.x/a),u=oa((n.x+1)/a),d=Co(n.y/a),x=Co((n.y+1)/a);return function(v,S,L,P,O=0,V){const G=[];if(!v.length||!L||!P)return G;const $=(Ge,ot)=>{for(const dt of Ge)G.push({polygon:dt,bounds:ot})},Y=Math.ceil(Math.log2(L)),ne=Math.ceil(Math.log2(P)),Te=Y-ne,Ae=[];for(let Ge=0;Ge<Math.abs(Te);Ge++)Ae.push(Te>0?0:1);for(let Ge=0;Ge<Math.min(Y,ne);Ge++)Ae.push(0),Ae.push(1);let Ce=v;if(Ce=gy(Ce,S[0].y-O,S[1].y+O,1),Ce=gy(Ce,S[0].x-O,S[1].x+O,0),!Ce.length)return G;const qe=[];for(Ae.length?qe.push({polygons:Ce,bounds:S,depth:0}):$(Ce,S);qe.length;){const Ge=qe.pop(),ot=Ge.depth,dt=Ae[ot],Rt=Ge.bounds[0],$t=Ge.bounds[1],Vt=dt===0?Rt.x:Rt.y,ai=dt===0?$t.x:$t.y,Ci=V?V(dt,Vt,ai):.5*(Vt+ai),ti=gy(Ge.polygons,Vt-O,Ci+O,dt),bi=gy(Ge.polygons,Ci-O,ai+O,dt);if(ti.length){const Yt=[Rt,new Kt(dt===0?Ci:$t.x,dt===1?Ci:$t.y)];Ae.length>ot+1?qe.push({polygons:ti,bounds:Yt,depth:ot+1}):$(ti,Yt)}if(bi.length){const Yt=[new Kt(dt===0?Ci:Rt.x,dt===1?Ci:Rt.y),$t];Ae.length>ot+1?qe.push({polygons:bi,bounds:Yt,depth:ot+1}):$(bi,Yt)}}return G}(t,e,Math.ceil((u-l)/11.25),Math.ceil((d-x)/11.25),1,(v,S,L)=>{if(v===0)return .5*(S+L);{const P=Co((n.y+S/ji)/a);return(sa(.5*(Co((n.y+L/ji)/a)+P))*a-n.y)*ji}})}function _C(t,e,n,a,l,u){const d=Math.pow(2,a.z-l.z);for(let x=0;x<n;x++){let v=t.int16[2*(x+e)+0],S=t.int16[2*(x+e)+1];v=(v+l.x*ji)*d-a.x*ji,S=(S+l.y*ji)*d-a.y*ji,u.push(new Kt(v,S))}}xe(vy,"FillExtrusionBucket",{omit:["layers","features"]}),xe(eb,"PartData"),xe(Q1,"FootprintSegment"),xe(ib,"BorderCentroidData"),xe(rb,"GroundEffect");const yC=new Br({visibility:new oi(Pt["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new oi(Pt["layout_fill-extrusion"]["fill-extrusion-edge-radius"])});var xC={paint:new Br({"fill-extrusion-opacity":new oi(Pt["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new on(Pt["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new oi(Pt["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new oi(Pt["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new on(Pt["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new on(Pt["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new on(Pt["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new oi(Pt["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new oi(Pt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new oi(Pt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new oi(Pt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new oi(Pt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new oi(Pt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new oi(Pt["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new oi(Pt["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new on(Pt["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new on(Pt["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new oi(Pt["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new oi(Pt["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new oi(Pt["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new oi(Pt["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new oi(Pt["paint_fill-extrusion"]["fill-extrusion-emissive-strength"])}),layout:yC};function Hg(t,e){return t.x*e.x+t.y*e.y}function db(t,e){if(t.length===1){let n=0;const a=e[n++];let l;for(;!l||a.equals(l);)if(l=e[n++],!l)return 1/0;for(;n<e.length;n++){const u=e[n],d=t[0],x=l.sub(a),v=u.sub(a),S=d.sub(a),L=Hg(x,x),P=Hg(x,v),O=Hg(v,v),V=Hg(S,x),G=Hg(S,v),$=L*O-P*P,Y=(O*V-P*G)/$,ne=(L*G-P*V)/$,Te=a.z*(1-Y-ne)+l.z*Y+u.z*ne;if(isFinite(Te))return Te}return 1/0}{let n=1/0;for(const a of e)n=Math.min(n,a.z);return n}}function pb(t,e,n,a,l,u,d,x){const v=d*l.getElevationAt(t,e,!0,!0),S=u[0]!==0,L=S?u[1]===0?d*(u[0]/7-450):d*function(P,O,V){const G=Math.floor(O[0]/8),$=Math.floor(O[1]/8),Y=10*(O[0]-8*G),ne=10*(O[1]-8*$),Te=P.getElevationAt(G,$,!0,!0),Ae=P.getMeterToDEM(V),Ce=Math.floor(.5*(Y*Ae-1)),qe=Math.floor(.5*(ne*Ae-1)),Ge=P.tileCoordToPixel(G,$),ot=2*Ce+1,dt=2*qe+1,Rt=function(bi,Yt,wi,zi,Si){return[bi.getElevationAtPixel(Yt,wi,!0),bi.getElevationAtPixel(Yt+Si,wi,!0),bi.getElevationAtPixel(Yt,wi+Si,!0),bi.getElevationAtPixel(Yt+zi,wi+Si,!0)]}(P,Ge.x-Ce,Ge.y-qe,ot,dt),$t=Math.abs(Rt[0]-Rt[1]),Vt=Math.abs(Rt[2]-Rt[3]),ai=Math.abs(Rt[0]-Rt[2])+Math.abs(Rt[1]-Rt[3]),Ci=Math.min(.25,.5*Ae*($t+Vt)/ot),ti=Math.min(.25,.5*Ae*ai/dt);return Te+Math.max(Ci*Y,ti*ne)}(l,u,x):v;return{base:v+(n===0)?-1:n,top:S?Math.max(L+a,v+n+2):v+a}}const vC=rr([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),{members:bC}=vC,wC=rr([{name:"a_packed",components:4,type:"Float32"}]),{members:MC}=wC,TC=rr([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:SC}=TC,EC=rr([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),AC=rr([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),CC=rr([{name:"a_projected_pos",components:4,type:"Float32"}],4);rr([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const K0=rr([{name:"a_occlusion_query_opacity",components:1,type:"Float32"}],4),fb=rr([{name:"a_z_offset",components:1,type:"Float32"}],4),LC=rr([{name:"a_texb",components:2,type:"Uint16"}]),IC=rr([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]),PC=rr([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_z_offset",components:1,type:"Float32"}]);rr([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const mb=rr([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),RC=rr([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);rr([{name:"triangle",components:3,type:"Uint16"}]),rr([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),rr([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Float32",name:"occlusionState"},{type:"Float32",name:"occlusionOpacity"},{type:"Uint8",name:"hasIconTextFit"}]),rr([{type:"Float32",name:"offsetX"}]),rr([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);class gb{constructor(e,n){this.width=e,this.height=n,this.nextRow=0,this.image=new Fo({width:e,height:n}),this.positions={},this.uploaded=!1}getDash(e,n){const a=this.getKey(e,n);return this.positions[a]}trim(){const e=this.width,n=this.height=Kn(this.nextRow);this.image.resize({width:e,height:n})}getKey(e,n){return e.join(",")+n}getDashRanges(e,n,a){const l=[];let u=e.length%2==1?-e[e.length-1]*a:0,d=e[0]*a,x=!0;l.push({left:u,right:d,isDash:x,zeroLength:e[0]===0});let v=e[0];for(let S=1;S<e.length;S++){x=!x;const L=e[S];u=v*a,v+=L,d=v*a,l.push({left:u,right:d,isDash:x,zeroLength:L===0})}return l}addRoundDash(e,n,a){const l=n/2;for(let u=-a;u<=a;u++){const d=this.width*(this.nextRow+a+u);let x=0,v=e[x];for(let S=0;S<this.width;S++){S/v.right>1&&(v=e[++x]);const L=Math.abs(S-v.left),P=Math.abs(S-v.right),O=Math.min(L,P);let V;const G=u/a*(l+1);if(v.isDash){const $=l-Math.abs(G);V=Math.sqrt(O*O+$*$)}else V=l-Math.sqrt(O*O+G*G);this.image.data[d+S]=Math.max(0,Math.min(255,V+128))}}}addRegularDash(e,n){for(let v=e.length-1;v>=0;--v){const S=e[v],L=e[v+1];S.zeroLength?e.splice(v,1):L&&L.isDash===S.isDash&&(L.left=S.left,e.splice(v,1))}const a=e[0],l=e[e.length-1];a.isDash===l.isDash&&(a.left=l.left-this.width,l.right=a.right+this.width);const u=this.width*this.nextRow;let d=0,x=e[d];for(let v=0;v<this.width;v++){v/x.right>1&&(x=e[++d]);const S=Math.abs(v-x.left),L=Math.abs(v-x.right),P=Math.min(S,L);this.image.data[u+v]=Math.max(0,Math.min(255,(x.isDash?P:-P)+n+128))}}addDash(e,n){const a=this.getKey(e,n);if(this.positions[a])return this.positions[a];const l=n==="round",u=l?7:0,d=2*u+1;if(this.nextRow+d>this.height)return Is("LineAtlas out of space"),null;e.length===0&&e.push(1);let x=0;for(let L=0;L<e.length;L++)e[L]<0&&(Is("Negative value is found in line dasharray, replacing values with 0"),e[L]=0),x+=e[L];if(x!==0){const L=this.width/x,P=this.getDashRanges(e,this.width,L);l?this.addRoundDash(P,L,u):this.addRegularDash(P,n==="square"?.5*L:0)}const v=this.nextRow+u;this.nextRow+=d;const S={tl:[v,u],br:[x,0]};return this.positions[a]=S,S}}xe(gb,"LineAtlas");const DC=my.types,zC=Math.cos(Math.PI/180*37.5),OC=Math.cos(Math.PI/180*5);class by{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.hasZOffset=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(n=>{this.gradients[n.id]={}}),this.layoutVertexArray=new Eh,this.layoutVertexArray2=new Uc,this.patternVertexArray=new kl,this.indexArray=new no,this.programConfigurations=new Ph(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new Ts,this.maxLineLength=0,this.zOffsetVertexArray=new pl,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.tessellationStep=e.tessellationStep?e.tessellationStep:ji/64}updateFootprints(e,n){}populate(e,n,a,l){this.hasPattern=yl("line",this.layers,n);const u=this.layers[0].layout.get("line-sort-key"),d=this.layers[0].layout.get("line-z-offset");this.hasZOffset=!d.isConstant()||!!d.constantOr(0);const x=[];for(const{feature:P,id:O,index:V,sourceLayerIndex:G}of e){const $=this.layers[0]._featureFilter.needGeometry,Y=gc(P,$);if(!this.layers[0]._featureFilter.filter(new ir(this.zoom),Y,a))continue;const ne=u?u.evaluate(Y,{},a):void 0,Te={id:O,properties:P.properties,type:P.type,sourceLayerIndex:G,index:V,geometry:$?Y.geometry:Za(P,a,l),patterns:{},sortKey:ne};x.push(Te)}u&&x.sort((P,O)=>P.sortKey-O.sortKey);const{lineAtlas:v,featureIndex:S}=n,L=this.addConstantDashes(v);for(const P of x){const{geometry:O,index:V,sourceLayerIndex:G}=P;if(L&&this.addFeatureDashes(P,v),this.hasPattern){const $=xl("line",this.layers,P,this.zoom,n);this.patternFeatures.push($)}else this.addFeature(P,O,V,a,v.positions,n.availableImages,n.brightness);S.insert(e[V].feature,O,V,G,this.index)}}addConstantDashes(e){let n=!1;for(const a of this.layers){const l=a.paint.get("line-dasharray").value,u=a.layout.get("line-cap").value;if(l.kind!=="constant"||u.kind!=="constant")n=!0;else{const d=u.value,x=l.value;if(!x)continue;e.addDash(x,d)}}return n}addFeatureDashes(e,n){const a=this.zoom;for(const l of this.layers){const u=l.paint.get("line-dasharray").value,d=l.layout.get("line-cap").value;if(u.kind==="constant"&&d.kind==="constant")continue;let x,v;if(u.kind==="constant"){if(x=u.value,!x)continue}else x=u.evaluate({zoom:a},e);v=d.kind==="constant"?d.value:d.evaluate({zoom:a},e),n.addDash(x,v),e.patterns[l.id]=n.getKey(x,v)}}update(e,n,a,l,u){const d=Object.keys(e).length!==0;d&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(e,n,d?this.stateDependentLayers:this.layers,a,l,u)}addFeatures(e,n,a,l,u,d){for(const x of this.patternFeatures)this.addFeature(x,x.geometry,x.index,n,a,l,d)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,MC)),this.patternVertexArray.length!==0&&(this.patternVertexBuffer=e.createVertexBuffer(this.patternVertexArray,SC)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,fb.members,!0)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,bC),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&e.properties.hasOwnProperty("mapbox_clip_start")&&e.properties.hasOwnProperty("mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,n,a,l,u,d,x){const v=this.layers[0].layout,S=v.get("line-join").evaluate(e,{}),L=v.get("line-cap").evaluate(e,{}),P=v.get("line-miter-limit"),O=v.get("line-round-limit");this.lineClips=this.lineFeatureClips(e);for(const V of n)this.addLine(V,e,l,S,L,P,O);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,a,u,d,l,x)}addLine(e,n,a,l,u,d,x){this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0,this.currentVertex=void 0;const v={zoom:this.zoom,lineProgress:void 0},S=this.layers[0].layout,L=l==="none";if(this.patternJoinNone=this.hasPattern&&L,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[],this.lineClips){this.lineClipsArray.push(this.lineClips);for(let Ge=0;Ge<e.length-1;Ge++)this.totalDistance+=e[Ge].dist(e[Ge+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const P=DC[n.type]==="Polygon";let O=e.length;for(;O>=2&&e[O-1].equals(e[O-2]);)O--;let V=0;for(;V<O-1&&e[V].equals(e[V+1]);)V++;if(O<(P?3:2))return;l==="bevel"&&(d=1.05);const G=this.overscaling<=16?15*ji/(512*this.overscaling):0,$=this.segments.prepareSegment(10*O,this.layoutVertexArray,this.indexArray);let Y,ne,Te,Ae,Ce,qe;this.e1=this.e2=-1,P&&(Y=e[O-2],Ce=e[V].sub(Y)._unit()._perp());for(let Ge=V;Ge<O;Ge++){if(Te=Ge===O-1?P?e[V+1]:void 0:e[Ge+1],Te&&e[Ge].equals(Te))continue;if(Ce&&(Ae=Ce),Y&&(ne=Y),Y=e[Ge],this.hasZOffset){const Yt=S.get("line-z-offset").value;if(Yt.kind==="constant")qe=Yt.value;else{if(this.lineClips){const wi=this.totalDistance/(this.lineClips.end-this.lineClips.start);v.lineProgress=(wi*this.lineClips.start+this.distance+(ne?ne.dist(Y):0))/wi}else Is(`line-z-offset evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`),v.lineProgress=0;qe=Yt.evaluate(v,n)}qe=qe||0}Ce=Te?Te.sub(Y)._unit()._perp():Ae,Ae=Ae||Ce;const ot=ne&&Te;let dt=ot?l:P||L?"butt":u;const Rt=Ae.x*Ce.x+Ae.y*Ce.y;if(L){const Yt=function(wi){if(wi.patternJoinNone){const zi=wi.segmentPoints.length/2,Si=wi.lineSoFar-wi.segmentStart;for(let fn=0;fn<zi;++fn){const Ii=wi.segmentPoints[2*fn+1],Ui=Math.round(wi.segmentPoints[2*fn])+.5+.25*Ii;wi.patternVertexArray.emplaceBack(Ui,Si,wi.segmentStart),wi.patternVertexArray.emplaceBack(Ui,Si,wi.segmentStart)}wi.segmentPoints.length=0}wi.e1=wi.e2=-1};if(ot&&Rt<OC){this.updateDistance(ne,Y),this.addCurrentVertex(Y,Ae,1,1,$,qe),Yt(this),this.addCurrentVertex(Y,Ce,-1,-1,$,qe);continue}if(ne){if(!Te){this.updateDistance(ne,Y),this.addCurrentVertex(Y,Ae,1,1,$,qe),Yt(this);continue}dt="miter"}}let $t=Ae.add(Ce);$t.x===0&&$t.y===0||$t._unit();const Vt=$t.x*Ce.x+$t.y*Ce.y,ai=Vt!==0?1/Vt:1/0,Ci=2*Math.sqrt(2-2*Vt),ti=Vt<zC&&ne&&Te,bi=Ae.x*Ce.y-Ae.y*Ce.x>0;if(ti&&Ge>V){const Yt=Y.dist(ne);if(Yt>2*G){const wi=Y.sub(Y.sub(ne)._mult(G/Yt)._round());this.updateDistance(ne,wi),this.addCurrentVertex(wi,Ae,0,0,$,qe),ne=wi}}if(ot&&dt==="round"&&(ai<x?dt="miter":ai<=2&&(dt="fakeround")),dt==="miter"&&ai>d&&(dt="bevel"),dt==="bevel"&&(ai>2&&(dt="flipbevel"),ai<d&&(dt="miter")),ne&&this.updateDistance(ne,Y),dt==="miter")$t._mult(ai),this.addCurrentVertex(Y,$t,0,0,$,qe);else if(dt==="flipbevel"){if(ai>100)$t=Ce.mult(-1);else{const Yt=ai*Ae.add(Ce).mag()/Ae.sub(Ce).mag();$t._perp()._mult(Yt*(bi?-1:1))}this.addCurrentVertex(Y,$t,0,0,$,qe),this.addCurrentVertex(Y,$t.mult(-1),0,0,$,qe)}else if(dt==="bevel"||dt==="fakeround"){const Yt=-Math.sqrt(ai*ai-1),wi=bi?Yt:0,zi=bi?0:Yt;if(ne&&this.addCurrentVertex(Y,Ae,wi,zi,$,qe),dt==="fakeround"){const Si=Math.round(180*Ci/Math.PI/20);for(let fn=1;fn<Si;fn++){let Ii=fn/Si;if(Ii!==.5){const qn=Ii-.5;Ii+=Ii*qn*(Ii-1)*((1.0904+Rt*(Rt*(3.55645-1.43519*Rt)-3.2452))*qn*qn+(.848013+Rt*(.215638*Rt-1.06021)))}const Ui=Ce.sub(Ae)._mult(Ii)._add(Ae)._unit()._mult(bi?-1:1);this.addHalfVertex(Y,Ui.x,Ui.y,!1,bi,0,$,qe)}}Te&&this.addCurrentVertex(Y,Ce,-wi,-zi,$,qe)}else dt==="butt"?this.addCurrentVertex(Y,$t,0,0,$,qe):dt==="square"?(ne||this.addCurrentVertex(Y,$t,-1,-1,$,qe),this.addCurrentVertex(Y,$t,0,0,$,qe),ne&&this.addCurrentVertex(Y,$t,1,1,$,qe)):dt==="round"&&(ne&&(this.addCurrentVertex(Y,Ae,0,0,$,qe),this.addCurrentVertex(Y,Ae,1,1,$,qe,!0)),Te&&(this.addCurrentVertex(Y,Ce,-1,-1,$,qe,!0),this.addCurrentVertex(Y,Ce,0,0,$,qe)));if(ti&&Ge<O-1){const Yt=Y.dist(Te);if(Yt>2*G){const wi=Y.add(Te.sub(Y)._mult(G/Yt)._round());this.updateDistance(Y,wi),this.addCurrentVertex(wi,Ce,0,0,$,qe),Y=wi}}}}addVerticesTo(e,n,a,l,u,d,x,v,S,L){const P=(n.w-e.w)/this.tessellationStep|0;if(P>1){this.lineSoFar=e.w;const O=(n.x-e.x)/P,V=(n.y-e.y)/P,G=(n.z-e.z)/P,$=(n.w-e.w)/P;for(let Y=1;Y<P;++Y)e.x+=O,e.y+=V,e.z+=G,this.lineSoFar+=$,this.addHalfVertex(e,a,l,L,!1,x,S,e.z),this.addHalfVertex(e,u,d,L,!0,-v,S,e.z)}this.lineSoFar=n.w,this.addHalfVertex(n,a,l,L,!1,x,S,n.z),this.addHalfVertex(n,u,d,L,!0,-v,S,n.z)}addCurrentVertex(e,n,a,l,u,d,x=!1){const v=n.x+n.y*a,S=n.y-n.x*a,L=n.y*l-n.x,P=-n.y-n.x*l;if(d!=null){const V=ji+10,G=d,$=new O1(e.x,e.y,G,this.lineSoFar),Y=_b(e,-10,V),ne=this.lineSoFar;if(this.currentVertex)if(Y){const Te=this.currentVertexIsOutside,Ae=this.currentVertex,Ce=new O1(e.x,e.y,G,this.lineSoFar);k1(Ae,Ce,-10,V),_b(Ce,-10,V)||(Te&&(this.e1=this.e2=-1,this.lineSoFar=Ae.w,this.addHalfVertex(Ae,v,S,x,!1,a,u,Ae.z),this.addHalfVertex(Ae,L,P,x,!0,-l,u,Ae.z)),this.addVerticesTo(Ae,Ce,v,S,L,P,a,l,u,x))}else{const Te=this.currentVertex;this.currentVertexIsOutside&&(k1(Te,$,-10,V),this.e1=this.e2=-1,this.lineSoFar=Te.w,this.addHalfVertex(Te,v,S,x,!1,a,u,Te.z),this.addHalfVertex(Te,L,P,x,!0,-l,u,Te.z)),this.addVerticesTo(Te,$,v,S,L,P,a,l,u,x)}else Y||(this.addHalfVertex(e,v,S,x,!1,a,u,d),this.addHalfVertex(e,L,P,x,!0,-l,u,d));this.currentVertex=$,this.currentVertexIsOutside=Y,this.lineSoFar=ne}else this.addHalfVertex(e,v,S,x,!1,a,u,d),this.addHalfVertex(e,L,P,x,!0,-l,u,d)}addHalfVertex({x:e,y:n},a,l,u,d,x,v,S){this.patternJoinNone&&(this.segmentPoints.length===0&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),d||this.segmentPoints.push(this.lineSoFar-this.segmentStart,x)),this.layoutVertexArray.emplaceBack((e<<1)+(u?1:0),(n<<1)+(d?1:0),Math.round(63*a)+128,Math.round(63*l)+128,1+(x===0?0:x<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineClips.start,this.lineClips.end);const L=v.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,L),v.primitiveLength++),d?this.e2=L:this.e1=L,S!=null&&this.zOffsetVertexArray.emplaceBack(S)}updateScaledDistance(){if(this.lineClips){const e=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=e*this.lineClips.start+this.distance}else this.lineSoFar=this.distance}updateDistance(e,n){this.distance+=e.dist(n),this.updateScaledDistance()}}function _b(t,e,n){return t.x<e||t.x>n||t.y<e||t.y>n}xe(by,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const FC=new Br({"line-cap":new on(Pt.layout_line["line-cap"]),"line-join":new on(Pt.layout_line["line-join"]),"line-miter-limit":new oi(Pt.layout_line["line-miter-limit"]),"line-round-limit":new oi(Pt.layout_line["line-round-limit"]),"line-sort-key":new on(Pt.layout_line["line-sort-key"]),"line-z-offset":new on(Pt.layout_line["line-z-offset"]),visibility:new oi(Pt.layout_line.visibility)});var wy={paint:new Br({"line-opacity":new on(Pt.paint_line["line-opacity"]),"line-color":new on(Pt.paint_line["line-color"]),"line-translate":new oi(Pt.paint_line["line-translate"]),"line-translate-anchor":new oi(Pt.paint_line["line-translate-anchor"]),"line-width":new on(Pt.paint_line["line-width"]),"line-gap-width":new on(Pt.paint_line["line-gap-width"]),"line-offset":new on(Pt.paint_line["line-offset"]),"line-blur":new on(Pt.paint_line["line-blur"]),"line-dasharray":new on(Pt.paint_line["line-dasharray"]),"line-pattern":new on(Pt.paint_line["line-pattern"]),"line-gradient":new Eo(Pt.paint_line["line-gradient"]),"line-trim-offset":new oi(Pt.paint_line["line-trim-offset"]),"line-trim-fade-range":new oi(Pt.paint_line["line-trim-fade-range"]),"line-trim-color":new oi(Pt.paint_line["line-trim-color"]),"line-emissive-strength":new oi(Pt.paint_line["line-emissive-strength"]),"line-border-width":new on(Pt.paint_line["line-border-width"]),"line-border-color":new on(Pt.paint_line["line-border-color"]),"line-occlusion-opacity":new oi(Pt.paint_line["line-occlusion-opacity"])}),layout:FC};function yb(t,e,n){return e*(ji/(t.tileSize*Math.pow(2,n-t.tileID.overscaledZ)))}function xb(t,e){return 1/yb(t,1,e.tileZoom)}function vb(t,e,n,a){return t.translatePosMatrix(a||e.tileID.projMatrix,e,n.paint.get("line-translate"),n.paint.get("line-translate-anchor"))}const bb=t=>{const e=[];wb(t)&&e.push("RENDER_LINE_DASH"),t.paint.get("line-gradient")&&e.push("RENDER_LINE_GRADIENT");const n=t.paint.get("line-trim-offset");n[0]===0&&n[1]===0||e.push("RENDER_LINE_TRIM_OFFSET"),t.paint.get("line-border-width").constantOr(1)!==0&&e.push("RENDER_LINE_BORDER");const a=t.layout.get("line-join").constantOr("miter")==="none",l=!!t.paint.get("line-pattern").constantOr(1);return a&&l&&e.push("LINE_JOIN_NONE"),e};function wb(t){const e=t.paint.get("line-dasharray").value;return e.value||e.kind!=="constant"}class Mb{constructor(e){this._stringToNumber={},this._numberToString=[];for(let n=0;n<e.length;n++){const a=e[n];this._stringToNumber[a]=n,this._numberToString[n]=a}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}var kC={read:function(t,e,n,a,l){var u,d,x=8*l-a-1,v=(1<<x)-1,S=v>>1,L=-7,P=n?l-1:0,O=n?-1:1,V=t[e+P];for(P+=O,u=V&(1<<-L)-1,V>>=-L,L+=x;L>0;u=256*u+t[e+P],P+=O,L-=8);for(d=u&(1<<-L)-1,u>>=-L,L+=a;L>0;d=256*d+t[e+P],P+=O,L-=8);if(u===0)u=1-S;else{if(u===v)return d?NaN:1/0*(V?-1:1);d+=Math.pow(2,a),u-=S}return(V?-1:1)*d*Math.pow(2,u-a)},write:function(t,e,n,a,l,u){var d,x,v,S=8*u-l-1,L=(1<<S)-1,P=L>>1,O=l===23?Math.pow(2,-24)-Math.pow(2,-77):0,V=a?0:u-1,G=a?1:-1,$=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(x=isNaN(e)?1:0,d=L):(d=Math.floor(Math.log(e)/Math.LN2),e*(v=Math.pow(2,-d))<1&&(d--,v*=2),(e+=d+P>=1?O/v:O*Math.pow(2,1-P))*v>=2&&(d++,v/=2),d+P>=L?(x=0,d=L):d+P>=1?(x=(e*v-1)*Math.pow(2,l),d+=P):(x=e*Math.pow(2,P-1)*Math.pow(2,l),d=0));l>=8;t[n+V]=255&x,V+=G,x/=256,l-=8);for(d=d<<l|x,S+=l;S>0;t[n+V]=255&d,V+=G,d/=256,S-=8);t[n+V-G]|=128*$}},Tb=Us,My=kC;function Us(t){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(t)?t:new Uint8Array(t||0),this.pos=0,this.type=0,this.length=this.buf.length}Us.Varint=0,Us.Fixed64=1,Us.Bytes=2,Us.Fixed32=5;var Q0=4294967296,Sb=1/Q0,Eb=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function pd(t){return t.type===Us.Bytes?t.readVarint()+t.pos:t.pos+1}function Rm(t,e,n){return n?4294967296*e+(t>>>0):4294967296*(e>>>0)+(t>>>0)}function Ab(t,e,n){var a=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));n.realloc(a);for(var l=n.pos-1;l>=t;l--)n.buf[l+a]=n.buf[l]}function BC(t,e){for(var n=0;n<t.length;n++)e.writeVarint(t[n])}function NC(t,e){for(var n=0;n<t.length;n++)e.writeSVarint(t[n])}function UC(t,e){for(var n=0;n<t.length;n++)e.writeFloat(t[n])}function VC(t,e){for(var n=0;n<t.length;n++)e.writeDouble(t[n])}function GC(t,e){for(var n=0;n<t.length;n++)e.writeBoolean(t[n])}function HC(t,e){for(var n=0;n<t.length;n++)e.writeFixed32(t[n])}function jC(t,e){for(var n=0;n<t.length;n++)e.writeSFixed32(t[n])}function WC(t,e){for(var n=0;n<t.length;n++)e.writeFixed64(t[n])}function qC(t,e){for(var n=0;n<t.length;n++)e.writeSFixed64(t[n])}function Ty(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+16777216*t[e+3]}function Dm(t,e,n){t[n]=e,t[n+1]=e>>>8,t[n+2]=e>>>16,t[n+3]=e>>>24}function Cb(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+(t[e+3]<<24)}Us.prototype={destroy:function(){this.buf=null},readFields:function(t,e,n){for(n=n||this.length;this.pos<n;){var a=this.readVarint(),l=a>>3,u=this.pos;this.type=7&a,t(l,e,this),this.pos===u&&this.skip(a)}return e},readMessage:function(t,e){return this.readFields(t,e,this.readVarint()+this.pos)},readFixed32:function(){var t=Ty(this.buf,this.pos);return this.pos+=4,t},readSFixed32:function(){var t=Cb(this.buf,this.pos);return this.pos+=4,t},readFixed64:function(){var t=Ty(this.buf,this.pos)+Ty(this.buf,this.pos+4)*Q0;return this.pos+=8,t},readSFixed64:function(){var t=Ty(this.buf,this.pos)+Cb(this.buf,this.pos+4)*Q0;return this.pos+=8,t},readFloat:function(){var t=My.read(this.buf,this.pos,!0,23,4);return this.pos+=4,t},readDouble:function(){var t=My.read(this.buf,this.pos,!0,52,8);return this.pos+=8,t},readVarint:function(t){var e,n,a=this.buf;return e=127&(n=a[this.pos++]),n<128?e:(e|=(127&(n=a[this.pos++]))<<7,n<128?e:(e|=(127&(n=a[this.pos++]))<<14,n<128?e:(e|=(127&(n=a[this.pos++]))<<21,n<128?e:function(l,u,d){var x,v,S=d.buf;if(x=(112&(v=S[d.pos++]))>>4,v<128||(x|=(127&(v=S[d.pos++]))<<3,v<128)||(x|=(127&(v=S[d.pos++]))<<10,v<128)||(x|=(127&(v=S[d.pos++]))<<17,v<128)||(x|=(127&(v=S[d.pos++]))<<24,v<128)||(x|=(1&(v=S[d.pos++]))<<31,v<128))return Rm(l,x,u);throw new Error("Expected varint not more than 10 bytes")}(e|=(15&(n=a[this.pos]))<<28,t,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var t=this.readVarint();return t%2==1?(t+1)/-2:t/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var t=this.readVarint()+this.pos,e=this.pos;return this.pos=t,t-e>=12&&Eb?function(n,a,l){return Eb.decode(n.subarray(a,l))}(this.buf,e,t):function(n,a,l){for(var u="",d=a;d<l;){var x,v,S,L=n[d],P=null,O=L>239?4:L>223?3:L>191?2:1;if(d+O>l)break;O===1?L<128&&(P=L):O===2?(192&(x=n[d+1]))==128&&(P=(31&L)<<6|63&x)<=127&&(P=null):O===3?(v=n[d+2],(192&(x=n[d+1]))==128&&(192&v)==128&&((P=(15&L)<<12|(63&x)<<6|63&v)<=2047||P>=55296&&P<=57343)&&(P=null)):O===4&&(v=n[d+2],S=n[d+3],(192&(x=n[d+1]))==128&&(192&v)==128&&(192&S)==128&&((P=(15&L)<<18|(63&x)<<12|(63&v)<<6|63&S)<=65535||P>=1114112)&&(P=null)),P===null?(P=65533,O=1):P>65535&&(P-=65536,u+=String.fromCharCode(P>>>10&1023|55296),P=56320|1023&P),u+=String.fromCharCode(P),d+=O}return u}(this.buf,e,t)},readBytes:function(){var t=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,t);return this.pos=t,e},readPackedVarint:function(t,e){if(this.type!==Us.Bytes)return t.push(this.readVarint(e));var n=pd(this);for(t=t||[];this.pos<n;)t.push(this.readVarint(e));return t},readPackedSVarint:function(t){if(this.type!==Us.Bytes)return t.push(this.readSVarint());var e=pd(this);for(t=t||[];this.pos<e;)t.push(this.readSVarint());return t},readPackedBoolean:function(t){if(this.type!==Us.Bytes)return t.push(this.readBoolean());var e=pd(this);for(t=t||[];this.pos<e;)t.push(this.readBoolean());return t},readPackedFloat:function(t){if(this.type!==Us.Bytes)return t.push(this.readFloat());var e=pd(this);for(t=t||[];this.pos<e;)t.push(this.readFloat());return t},readPackedDouble:function(t){if(this.type!==Us.Bytes)return t.push(this.readDouble());var e=pd(this);for(t=t||[];this.pos<e;)t.push(this.readDouble());return t},readPackedFixed32:function(t){if(this.type!==Us.Bytes)return t.push(this.readFixed32());var e=pd(this);for(t=t||[];this.pos<e;)t.push(this.readFixed32());return t},readPackedSFixed32:function(t){if(this.type!==Us.Bytes)return t.push(this.readSFixed32());var e=pd(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed32());return t},readPackedFixed64:function(t){if(this.type!==Us.Bytes)return t.push(this.readFixed64());var e=pd(this);for(t=t||[];this.pos<e;)t.push(this.readFixed64());return t},readPackedSFixed64:function(t){if(this.type!==Us.Bytes)return t.push(this.readSFixed64());var e=pd(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed64());return t},skip:function(t){var e=7&t;if(e===Us.Varint)for(;this.buf[this.pos++]>127;);else if(e===Us.Bytes)this.pos=this.readVarint()+this.pos;else if(e===Us.Fixed32)this.pos+=4;else{if(e!==Us.Fixed64)throw new Error("Unimplemented type: "+e);this.pos+=8}},writeTag:function(t,e){this.writeVarint(t<<3|e)},realloc:function(t){for(var e=this.length||16;e<this.pos+t;)e*=2;if(e!==this.length){var n=new Uint8Array(e);n.set(this.buf),this.buf=n,this.length=e}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(t){this.realloc(4),Dm(this.buf,t,this.pos),this.pos+=4},writeSFixed32:function(t){this.realloc(4),Dm(this.buf,t,this.pos),this.pos+=4},writeFixed64:function(t){this.realloc(8),Dm(this.buf,-1&t,this.pos),Dm(this.buf,Math.floor(t*Sb),this.pos+4),this.pos+=8},writeSFixed64:function(t){this.realloc(8),Dm(this.buf,-1&t,this.pos),Dm(this.buf,Math.floor(t*Sb),this.pos+4),this.pos+=8},writeVarint:function(t){(t=+t||0)>268435455||t<0?function(e,n){var a,l;if(e>=0?(a=e%4294967296|0,l=e/4294967296|0):(l=~(-e/4294967296),4294967295^(a=~(-e%4294967296))?a=a+1|0:(a=0,l=l+1|0)),e>=18446744073709552e3||e<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");n.realloc(10),function(u,d,x){x.buf[x.pos++]=127&u|128,u>>>=7,x.buf[x.pos++]=127&u|128,u>>>=7,x.buf[x.pos++]=127&u|128,u>>>=7,x.buf[x.pos++]=127&u|128,x.buf[x.pos]=127&(u>>>=7)}(a,0,n),function(u,d){var x=(7&u)<<4;d.buf[d.pos++]|=x|((u>>>=3)?128:0),u&&(d.buf[d.pos++]=127&u|((u>>>=7)?128:0),u&&(d.buf[d.pos++]=127&u|((u>>>=7)?128:0),u&&(d.buf[d.pos++]=127&u|((u>>>=7)?128:0),u&&(d.buf[d.pos++]=127&u|((u>>>=7)?128:0),u&&(d.buf[d.pos++]=127&u)))))}(l,n)}(t,this):(this.realloc(4),this.buf[this.pos++]=127&t|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=t>>>7&127))))},writeSVarint:function(t){this.writeVarint(t<0?2*-t-1:2*t)},writeBoolean:function(t){this.writeVarint(!!t)},writeString:function(t){t=String(t),this.realloc(4*t.length),this.pos++;var e=this.pos;this.pos=function(a,l,u){for(var d,x,v=0;v<l.length;v++){if((d=l.charCodeAt(v))>55295&&d<57344){if(!x){d>56319||v+1===l.length?(a[u++]=239,a[u++]=191,a[u++]=189):x=d;continue}if(d<56320){a[u++]=239,a[u++]=191,a[u++]=189,x=d;continue}d=x-55296<<10|d-56320|65536,x=null}else x&&(a[u++]=239,a[u++]=191,a[u++]=189,x=null);d<128?a[u++]=d:(d<2048?a[u++]=d>>6|192:(d<65536?a[u++]=d>>12|224:(a[u++]=d>>18|240,a[u++]=d>>12&63|128),a[u++]=d>>6&63|128),a[u++]=63&d|128)}return u}(this.buf,t,this.pos);var n=this.pos-e;n>=128&&Ab(e,n,this),this.pos=e-1,this.writeVarint(n),this.pos+=n},writeFloat:function(t){this.realloc(4),My.write(this.buf,t,this.pos,!0,23,4),this.pos+=4},writeDouble:function(t){this.realloc(8),My.write(this.buf,t,this.pos,!0,52,8),this.pos+=8},writeBytes:function(t){var e=t.length;this.writeVarint(e),this.realloc(e);for(var n=0;n<e;n++)this.buf[this.pos++]=t[n]},writeRawMessage:function(t,e){this.pos++;var n=this.pos;t(e,this);var a=this.pos-n;a>=128&&Ab(n,a,this),this.pos=n-1,this.writeVarint(a),this.pos+=a},writeMessage:function(t,e,n){this.writeTag(t,Us.Bytes),this.writeRawMessage(e,n)},writePackedVarint:function(t,e){e.length&&this.writeMessage(t,BC,e)},writePackedSVarint:function(t,e){e.length&&this.writeMessage(t,NC,e)},writePackedBoolean:function(t,e){e.length&&this.writeMessage(t,GC,e)},writePackedFloat:function(t,e){e.length&&this.writeMessage(t,UC,e)},writePackedDouble:function(t,e){e.length&&this.writeMessage(t,VC,e)},writePackedFixed32:function(t,e){e.length&&this.writeMessage(t,HC,e)},writePackedSFixed32:function(t,e){e.length&&this.writeMessage(t,jC,e)},writePackedFixed64:function(t,e){e.length&&this.writeMessage(t,WC,e)},writePackedSFixed64:function(t,e){e.length&&this.writeMessage(t,qC,e)},writeBytesField:function(t,e){this.writeTag(t,Us.Bytes),this.writeBytes(e)},writeFixed32Field:function(t,e){this.writeTag(t,Us.Fixed32),this.writeFixed32(e)},writeSFixed32Field:function(t,e){this.writeTag(t,Us.Fixed32),this.writeSFixed32(e)},writeFixed64Field:function(t,e){this.writeTag(t,Us.Fixed64),this.writeFixed64(e)},writeSFixed64Field:function(t,e){this.writeTag(t,Us.Fixed64),this.writeSFixed64(e)},writeVarintField:function(t,e){this.writeTag(t,Us.Varint),this.writeVarint(e)},writeSVarintField:function(t,e){this.writeTag(t,Us.Varint),this.writeSVarint(e)},writeStringField:function(t,e){this.writeTag(t,Us.Bytes),this.writeString(e)},writeFloatField:function(t,e){this.writeTag(t,Us.Fixed32),this.writeFloat(e)},writeDoubleField:function(t,e){this.writeTag(t,Us.Fixed64),this.writeDouble(e)},writeBooleanField:function(t,e){this.writeVarintField(t,!!e)}};var zm=Ut(Tb);const ZC=["id","tile","layer","source","sourceLayer","state"];class Lb{constructor(e,n,a,l,u){this.type="Feature",this._vectorTileFeature=e,this._z=n,this._x=a,this._y=l,this.properties=e.properties,this.id=u}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const n of ZC)this[n]!==void 0&&(e[n]=this[n]);return e}}class XC{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(e,n,a){const l=String(n);if(this.stateChanges[e]=this.stateChanges[e]||{},this.stateChanges[e][l]=this.stateChanges[e][l]||{},Ls(this.stateChanges[e][l],a),this.deletedStates[e]===null){this.deletedStates[e]={};for(const u in this.state[e])u!==l&&(this.deletedStates[e][u]=null)}else if(this.deletedStates[e]&&this.deletedStates[e][l]===null){this.deletedStates[e][l]={};for(const u in this.state[e][l])a[u]||(this.deletedStates[e][l][u]=null)}else for(const u in a)this.deletedStates[e]&&this.deletedStates[e][l]&&this.deletedStates[e][l][u]===null&&delete this.deletedStates[e][l][u]}removeFeatureState(e,n,a){if(this.deletedStates[e]===null)return;const l=String(n);if(this.deletedStates[e]=this.deletedStates[e]||{},a&&n!==void 0)this.deletedStates[e][l]!==null&&(this.deletedStates[e][l]=this.deletedStates[e][l]||{},this.deletedStates[e][l][a]=null);else if(n!==void 0)if(this.stateChanges[e]&&this.stateChanges[e][l])for(a in this.deletedStates[e][l]={},this.stateChanges[e][l])this.deletedStates[e][l][a]=null;else this.deletedStates[e][l]=null;else this.deletedStates[e]=null}getState(e,n){const a=String(n),l=Ls({},(this.state[e]||{})[a],(this.stateChanges[e]||{})[a]);if(this.deletedStates[e]===null)return{};if(this.deletedStates[e]){const u=this.deletedStates[e][n];if(u===null)return{};for(const d in u)delete l[d]}return l}initializeTileState(e,n){e.setFeatureState(this.state,n)}coalesceChanges(e,n){const a={};for(const l in this.stateChanges){this.state[l]=this.state[l]||{};const u={};for(const d in this.stateChanges[l])this.state[l][d]||(this.state[l][d]={}),Ls(this.state[l][d],this.stateChanges[l][d]),u[d]=this.state[l][d];a[l]=u}for(const l in this.deletedStates){this.state[l]=this.state[l]||{};const u={};if(this.deletedStates[l]===null)for(const d in this.state[l])u[d]={},this.state[l][d]={};else for(const d in this.deletedStates[l]){if(this.deletedStates[l][d]===null)this.state[l][d]={};else if(this.state[l][d])for(const x of Object.keys(this.deletedStates[l][d]))delete this.state[l][d][x];u[d]=this.state[l][d]}a[l]=a[l]||{},Ls(a[l],u)}if(this.stateChanges={},this.deletedStates={},Object.keys(a).length!==0)for(const l in e)e[l].setFeatureState(a,n)}}class Ib{constructor(e,n){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new Ze(ji,16,0),this.featureIndexArray=new xm,this.promoteId=n,this.is3DTile=!1}insert(e,n,a,l,u,d=0,x=0){const v=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(a,l,u,d);const S=this.grid;for(let L=0;L<n.length;L++){const P=n[L],O=[1/0,1/0,-1/0,-1/0];for(let V=0;V<P.length;V++){const G=P[V];O[0]=Math.min(O[0],G.x),O[1]=Math.min(O[1],G.y),O[2]=Math.max(O[2],G.x),O[3]=Math.max(O[3],G.y)}x!==0&&(O[0]-=x,O[1]-=x,O[2]+=x,O[3]+=x),O[0]<ji&&O[1]<ji&&O[2]>=0&&O[3]>=0&&S.insert(v,O[0],O[1],O[2],O[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new X0(new zm(this.rawTileData)).layers,this.sourceLayerCoder=new Mb(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,n,a,l){this.loadVTLayers();const u=e.params||{},d=io(u.filter),x=e.tileResult,v=e.transform,S=x.bufferedTilespaceBounds,L=this.grid.query(S.min.x,S.min.y,S.max.x,S.max.y,(G,$,Y,ne)=>F(x.bufferedTilespaceGeometry,G,$,Y,ne));L.sort($C);let P=null;v.elevation&&L.length>0&&(P=Pm.create(v.elevation,this.tileID));const O={};let V;for(let G=0;G<L.length;G++){const $=L[G];if($===V)continue;V=$;const Y=this.featureIndexArray.get($);let ne=null;if(this.is3DTile){const Te=this.bucketLayerIDs[0][0],Ae=n[Te];if(Ae.type!=="model")continue;const{queryFeature:Ce,intersectionZ:qe}=Ae.queryIntersectsMatchingFeature(x,Y.featureIndex,d,v);Ce&&this.appendToResult(O,Te,Y.featureIndex,Ce,qe)}else this.loadMatchingFeature(O,Y,d,u.layers,u.availableImages,n,a,l,(Te,Ae,Ce,qe=0)=>(ne||(ne=Za(Te,this.tileID.canonical,e.tileTransform)),Ae.queryIntersectsFeature(x,Te,Ce,ne,this.z,e.transform,e.pixelPosMatrix,P,qe)))}return O}loadMatchingFeature(e,n,a,l,u,d,x,v,S){const{featureIndex:L,bucketIndex:P,sourceLayerIndex:O,layoutVertexArrayOffset:V}=n,G=this.bucketLayerIDs[P];if(l&&!function(Te,Ae){for(let Ce=0;Ce<Te.length;Ce++)if(Ae.indexOf(Te[Ce])>=0)return!0;return!1}(l,G))return;const $=this.sourceLayerCoder.decode(O),Y=this.vtLayers[$].feature(L);if(a.needGeometry){const Te=gc(Y,!0);if(!a.filter(new ir(this.tileID.overscaledZ),Te,this.tileID.canonical))return}else if(!a.filter(new ir(this.tileID.overscaledZ),Y))return;const ne=this.getId(Y,$);for(let Te=0;Te<G.length;Te++){const Ae=G[Te];if(l&&l.indexOf(Ae)<0)continue;const Ce=d[Ae];if(!Ce)continue;let qe={};ne!==void 0&&v&&(qe=v.getState(Ce.sourceLayer||"_geojsonTileLayer",ne));const Ge=!S||S(Y,Ce,qe,V);if(!Ge)continue;const ot=new Lb(Y,this.z,this.x,this.y,ne),dt=Ls({},x[Ae]);dt.paint=Pb(dt.paint,Ce.paint,Y,qe,u),dt.layout=Pb(dt.layout,Ce.layout,Y,qe,u),ot.layer=dt,this.appendToResult(e,Ae,L,ot,Ge)}}appendToResult(e,n,a,l,u){let d=e[n];d===void 0&&(d=e[n]=[]),d.push({featureIndex:a,feature:l,intersectionZ:u})}lookupSymbolFeatures(e,n,a,l,u,d,x,v){const S={};this.loadVTLayers();const L=io(u);for(const P of e)this.loadMatchingFeature(S,{bucketIndex:a,sourceLayerIndex:l,featureIndex:P,layoutVertexArrayOffset:0},L,d,x,v,n);return S}loadFeature(e){const{featureIndex:n,sourceLayerIndex:a}=e;this.loadVTLayers();const l=this.sourceLayerCoder.decode(a),u=this.vtFeatures[l];if(u[n])return u[n];const d=this.vtLayers[l].feature(n);return u[n]=d,d}hasLayer(e){for(const n of this.bucketLayerIDs)for(const a of n)if(e===a)return!0;return!1}getId(e,n){let a=e.id;if(this.promoteId){const l=typeof this.promoteId=="string"?this.promoteId:this.promoteId[n];l!=null&&(a=e.properties[l]),typeof a=="boolean"&&(a=Number(a))}return a}}function Pb(t,e,n,a,l){return qo(t,(u,d)=>{const x=e instanceof vs?e.get(d):null;return x&&x.evaluate?x.evaluate(n,a,l):x})}function $C(t,e){return e-t}xe(Ib,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});var aa=24;const Dh=128;function ex(t,e){const{expression:n}=e;if(n.kind==="constant")return{kind:"constant",layoutSize:n.evaluate(new ir(t+1))};if(n.kind==="source")return{kind:"source"};{const{zoomStops:a,interpolationType:l}=n;let u=0;for(;u<a.length&&a[u]<=t;)u++;u=Math.max(0,u-1);let d=u;for(;d<a.length&&a[d]<t+1;)d++;d=Math.min(a.length-1,d);const x=a[u],v=a[d];return n.kind==="composite"?{kind:"composite",minZoom:x,maxZoom:v,interpolationType:l}:{kind:"camera",minZoom:x,maxZoom:v,minSize:n.evaluate(new ir(x)),maxSize:n.evaluate(new ir(v)),interpolationType:l}}}function Sy(t,{uSize:e,uSizeT:n},{lowerSize:a,upperSize:l}){return t.kind==="source"?a/Dh:t.kind==="composite"?Qn(a/Dh,l/Dh,n):e}function Om(t,e){let n=0,a=0;if(t.kind==="constant")a=t.layoutSize;else if(t.kind!=="source"){const{interpolationType:l,minZoom:u,maxZoom:d}=t,x=l?pn(Xo.interpolationFactor(l,e,u,d),0,1):0;t.kind==="camera"?a=Qn(t.minSize,t.maxSize,x):n=x}return{uSizeT:n,uSize:a}}var YC=Object.freeze({__proto__:null,SIZE_PACK_FACTOR:Dh,evaluateSizeForFeature:Sy,evaluateSizeForZoom:Om,getSizeData:ex});function JC(t,e,n){return t.sections.forEach(a=>{a.text=function(l,u,d){const x=u.layout.get("text-transform").evaluate(d,{});return x==="uppercase"?l=l.toLocaleUpperCase():x==="lowercase"&&(l=l.toLocaleLowerCase()),zr.applyArabicShaping&&(l=zr.applyArabicShaping(l)),l}(a.text,e,n)}),t}const jg={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};function KC(t){return t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""}function QC(t){return t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""}const tx=3;function e3(t,e,n){e.glyphs=[],t===1&&n.readMessage(t3,e)}function t3(t,e,n){if(t===3){const{id:a,bitmap:l,width:u,height:d,left:x,top:v,advance:S}=n.readMessage(i3,{});e.glyphs.push({id:a,bitmap:new Fo({width:u+2*tx,height:d+2*tx},l),metrics:{width:u,height:d,left:x,top:v,advance:S}})}else t===4?e.ascender=n.readSVarint():t===5&&(e.descender=n.readSVarint())}function i3(t,e,n){t===1?e.id=n.readVarint():t===2?e.bitmap=n.readBytes():t===3?e.width=n.readVarint():t===4?e.height=n.readVarint():t===5?e.left=n.readSVarint():t===6?e.top=n.readSVarint():t===7&&(e.advance=n.readVarint())}const Rb=tx,_c={horizontal:1,vertical:2,horizontalOnly:3};class Wg{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(e,n){const a=new Wg;return a.scale=e||1,a.fontStack=n,a}static forImage(e){const n=new Wg;return n.imageName=e,n}}class Fm{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,n){const a=new Fm;for(let l=0;l<e.sections.length;l++){const u=e.sections[l];u.image?a.addImageSection(u):a.addTextSection(u,n)}return a}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCodePoint(e){return this.text.codePointAt(e)}verticalizePunctuation(e){this.text=function(n,a){let l="";for(let u=0;u<n.length;u++){const d=n.charCodeAt(u+1)||null,x=n.charCodeAt(u-1)||null;l+=!a&&(d&&vt(d)&&!jg[n[u+1]]||x&&vt(x)&&!jg[n[u-1]])||!jg[n[u]]?n[u]:jg[n[u]]}return l}(this.text,e)}trim(){let e=0;for(let a=0;a<this.text.length&&Ey[this.text.charCodeAt(a)];a++)e++;let n=this.text.length;for(let a=this.text.length-1;a>=0&&a>=e&&Ey[this.text.charCodeAt(a)];a--)n--;this.text=this.text.substring(e,n),this.sectionIndex=this.sectionIndex.slice(e,n)}substring(e,n){const a=new Fm;return a.text=this.text.substring(e,n),a.sectionIndex=this.sectionIndex.slice(e,n),a.sections=this.sections,a}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,n)=>Math.max(e,this.sections[n].scale),0)}addTextSection(e,n){this.text+=e.text,this.sections.push(Wg.forText(e.scale,e.fontStack||n));const a=this.sections.length-1;for(let l=0;l<e.text.length;++l)this.sectionIndex.push(a)}addImageSection(e){const n=e.image?e.image.namePrimary:"";if(n.length===0)return void Is("Can't add FormattedSection with an empty image.");const a=this.getNextImageSectionCharCode();a?(this.text+=String.fromCodePoint(a),this.sections.push(Wg.forImage(n)),this.sectionIndex.push(this.sections.length-1)):Is("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function ix(t,e,n,a,l,u,d,x,v,S,L,P,O,V,G){const $=Fm.fromFeature(t,l);P===_c.vertical&&$.verticalizePunctuation(O);let Y=[];const ne=function(Ge,ot,dt,Rt,$t,Vt){if(!Ge)return[];const ai=[],Ci=function(wi,zi,Si,fn,Ii,Ui){let qn=0;for(let Fn=0;Fn<wi.length();Fn++){const Rn=wi.getSection(Fn);qn+=Db(wi.getCodePoint(Fn),Rn,fn,Ii,zi,Ui)}return qn/Math.max(1,Math.ceil(qn/Si))}(Ge,ot,dt,Rt,$t,Vt),ti=Ge.text.indexOf("")>=0;let bi=0;for(let wi=0;wi<Ge.length();wi++){const zi=Ge.getSection(wi),Si=Ge.getCodePoint(wi);if(Ey[Si]||(bi+=Db(Si,zi,Rt,$t,ot,Vt)),wi<Ge.length()-1){const fn=!((Yt=Si)<11904||!(it["Bopomofo Extended"](Yt)||it.Bopomofo(Yt)||it["CJK Compatibility Forms"](Yt)||it["CJK Compatibility Ideographs"](Yt)||it["CJK Compatibility"](Yt)||it["CJK Radicals Supplement"](Yt)||it["CJK Strokes"](Yt)||it["CJK Symbols and Punctuation"](Yt)||it["CJK Unified Ideographs Extension A"](Yt)||it["CJK Unified Ideographs"](Yt)||it["Enclosed CJK Letters and Months"](Yt)||it["Halfwidth and Fullwidth Forms"](Yt)||it.Hiragana(Yt)||it["Ideographic Description Characters"](Yt)||it["Kangxi Radicals"](Yt)||it["Katakana Phonetic Extensions"](Yt)||it.Katakana(Yt)||it["Vertical Forms"](Yt)||it["Yi Radicals"](Yt)||it["Yi Syllables"](Yt)));(n3[Si]||fn||zi.imageName)&&ai.push(Ob(wi+1,bi,Ci,ai,r3(Si,Ge.getCodePoint(wi+1),fn&&ti),!1))}}var Yt;return Fb(Ob(Ge.length(),bi,Ci,ai,0,!0))}($,S,u,e,a,V),{processBidirectionalText:Te,processStyledBidirectionalText:Ae}=zr;if(Te&&$.sections.length===1){const Ge=Te($.toString(),ne);for(const ot of Ge){const dt=new Fm;dt.text=ot,dt.sections=$.sections;for(let Rt=0;Rt<ot.length;Rt++)dt.sectionIndex.push(0);Y.push(dt)}}else if(Ae){const Ge=Ae($.text,$.sectionIndex,ne);for(const ot of Ge){const dt=new Fm;dt.text=ot[0],dt.sectionIndex=ot[1],dt.sections=$.sections,Y.push(dt)}}else Y=function(Ge,ot){const dt=[],Rt=Ge.text;let $t=0;for(const Vt of ot)dt.push(Ge.substring($t,Vt)),$t=Vt;return $t<Rt.length&&dt.push(Ge.substring($t,Rt.length)),dt}($,ne);const Ce=[],qe={positionedLines:Ce,text:$.toString(),top:L[1],bottom:L[1],left:L[0],right:L[0],writingMode:P,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(Ge,ot,dt,Rt,$t,Vt,ai,Ci,ti,bi,Yt,wi){let zi=0,Si=0,fn=0;const Ii=Ci==="right"?1:Ci==="left"?0:.5;let Ui=!1;for(const Cr of $t){const or=Cr.getSections();for(const Pr of or){if(Pr.imageName)continue;const Lr=ot[Pr.fontStack];if(Lr&&(Ui=Lr.ascender!==void 0&&Lr.descender!==void 0,!Ui))break}if(!Ui)break}let qn=0;for(const Cr of $t){Cr.trim();const or=Cr.getMaxScale(),Pr=(or-1)*aa,Lr={positionedGlyphs:[],lineOffset:0};Ge.positionedLines[qn]=Lr;const Fr=Lr.positionedGlyphs;let nr=0;if(!Cr.length()){Si+=Vt,++qn;continue}let bs=0,_s=0;for(let $r=0;$r<Cr.length();$r++){const ns=Cr.getSection($r),Ps=Cr.getSectionIndex($r),Ss=Cr.getCodePoint($r);let Zs=ns.scale,Hs=null,xa=null,so=null,Vs=aa,xo=0;const Qo=!(ti===_c.horizontal||!Yt&&!hi(Ss)||Yt&&(Ey[Ss]||(Fn=Ss,it.Arabic(Fn)||it["Arabic Supplement"](Fn)||it["Arabic Extended-A"](Fn)||it["Arabic Presentation Forms-A"](Fn)||it["Arabic Presentation Forms-B"](Fn))));if(ns.imageName){const ea=Rt[ns.imageName];if(!ea)continue;so=ns.imageName,Ge.iconsInText=Ge.iconsInText||!0,xa=ea.paddedRect;const Es=ea.displaySize;Zs=Zs*aa/wi,Hs={width:Es[0],height:Es[1],left:0,top:-Rb,advance:Qo?Es[1]:Es[0],localGlyph:!1},xo=Ui?-Hs.height*Zs:or*aa-17-Es[1]*Zs,Vs=Hs.advance;const Ya=(Qo?Es[0]:Es[1])*Zs-aa*or;Ya>0&&Ya>nr&&(nr=Ya)}else{const ea=dt[ns.fontStack];if(!ea)continue;ea[Ss]&&(xa=ea[Ss]);const Es=ot[ns.fontStack];if(!Es)continue;const Ya=Es.glyphs[Ss];if(!Ya)continue;if(Hs=Ya.metrics,Vs=Ss!==8203?aa:0,Ui){const md=Es.ascender!==void 0?Math.abs(Es.ascender):0,Jc=Es.descender!==void 0?Math.abs(Es.descender):0,Nh=(md+Jc)*Zs;bs<Nh&&(bs=Nh,_s=(md-Jc)/2*Zs),xo=-md*Zs}else xo=(or-Zs)*aa-17}Qo?(Ge.verticalizable=!0,Fr.push({glyph:Ss,imageName:so,x:zi,y:Si+xo,vertical:Qo,scale:Zs,localGlyph:Hs.localGlyph,fontStack:ns.fontStack,sectionIndex:Ps,metrics:Hs,rect:xa}),zi+=Vs*Zs+bi):(Fr.push({glyph:Ss,imageName:so,x:zi,y:Si+xo,vertical:Qo,scale:Zs,localGlyph:Hs.localGlyph,fontStack:ns.fontStack,sectionIndex:Ps,metrics:Hs,rect:xa}),zi+=Hs.advance*Zs+bi)}Fr.length!==0&&(fn=Math.max(zi-bi,fn),Ui?kb(Fr,Ii,nr,_s,Vt*or/2):kb(Fr,Ii,nr,0,Vt/2)),zi=0;const is=Vt*or+nr;Lr.lineOffset=Math.max(nr,Pr),Si+=is,++qn}var Fn;const Rn=Si,{horizontalAlign:Fi,verticalAlign:Zn}=nx(ai);(function(Cr,or,Pr,Lr,Fr,nr){const bs=(or-Pr)*Fr,_s=-nr*Lr;for(const is of Cr)for(const $r of is.positionedGlyphs)$r.x+=bs,$r.y+=_s})(Ge.positionedLines,Ii,Fi,Zn,fn,Rn),Ge.top+=-Zn*Rn,Ge.bottom=Ge.top+Rn,Ge.left+=-Fi*fn,Ge.right=Ge.left+fn,Ge.hasBaseline=Ui}(qe,e,n,a,Y,d,x,v,P,S,O,G),!function(Ge){for(const ot of Ge)if(ot.positionedGlyphs.length!==0)return!1;return!0}(Ce)&&qe}const Ey={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},n3={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function Db(t,e,n,a,l,u){if(e.imageName){const d=a[e.imageName];return d?d.displaySize[0]*e.scale*aa/u+l:0}{const d=n[e.fontStack],x=d&&d.glyphs[t];return x?x.metrics.advance*e.scale+l:0}}function zb(t,e,n,a){const l=Math.pow(t-e,2);return a?t<e?l/2:2*l:l+Math.abs(n)*n}function r3(t,e,n){let a=0;return t===10&&(a-=1e4),n&&(a+=150),t!==40&&t!==65288||(a+=50),e!==41&&e!==65289||(a+=50),a}function Ob(t,e,n,a,l,u){let d=null,x=zb(e,n,l,u);for(const v of a){const S=zb(e-v.x,n,l,u)+v.badness;S<=x&&(d=v,x=S)}return{index:t,x:e,priorBreak:d,badness:x}}function Fb(t){return t?Fb(t.priorBreak).concat(t.index):[]}function nx(t){let e=.5,n=.5;switch(t){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(t){case"bottom":case"bottom-right":case"bottom-left":n=1;break;case"top":case"top-right":case"top-left":n=0}return{horizontalAlign:e,verticalAlign:n}}function kb(t,e,n,a,l){if(!(e||n||a||l))return;const u=t.length-1,d=t[u],x=(d.x+d.metrics.advance*d.scale)*e;for(let v=0;v<=u;v++)t[v].x-=x,t[v].y+=n+a+l}function s3(t,e,n,a){const{horizontalAlign:l,verticalAlign:u}=nx(a),d=n[0]-t.displaySize[0]*l,x=n[1]-t.displaySize[1]*u;return{imagePrimary:t,imageSecondary:e,top:x,bottom:x+t.displaySize[1],left:d,right:d+t.displaySize[0]}}function Bb(t,e,n,a,l,u){const d=t.imagePrimary;let x;if(d.content){const Y=d.content,ne=d.pixelRatio||1;x=[Y[0]/ne,Y[1]/ne,d.displaySize[0]-Y[2]/ne,d.displaySize[1]-Y[3]/ne]}const v=e.left*u,S=e.right*u;let L,P,O,V;n==="width"||n==="both"?(V=l[0]+v-a[3],P=l[0]+S+a[1]):(V=l[0]+(v+S-d.displaySize[0])/2,P=V+d.displaySize[0]);const G=e.top*u,$=e.bottom*u;return n==="height"||n==="both"?(L=l[1]+G-a[0],O=l[1]+$+a[2]):(L=l[1]+(G+$-d.displaySize[1])/2,O=L+d.displaySize[1]),{imagePrimary:d,imageSecondary:void 0,top:L,right:P,bottom:O,left:V,collisionPadding:x}}class fd extends Kt{constructor(e,n,a,l,u){super(e,n),this.angle=l,this.z=a,u!==void 0&&(this.segment=u)}clone(){return new fd(this.x,this.y,this.z,this.angle,this.segment)}}function Nb(t,e,n,a,l){if(e.segment===void 0)return!0;let u=e,d=e.segment+1,x=0;for(;x>-n/2;){if(d--,d<0)return!1;x-=t[d].dist(u),u=t[d]}x+=t[d].dist(t[d+1]),d++;const v=[];let S=0;for(;x<n/2;){const L=t[d],P=t[d+1];if(!P)return!1;let O=t[d-1].angleTo(L)-L.angleTo(P);for(O=Math.abs((O+3*Math.PI)%(2*Math.PI)-Math.PI),v.push({distance:x,angleDelta:O}),S+=O;x-v[0].distance>a;)S-=v.shift().angleDelta;if(S>l)return!1;d++,x+=L.dist(P)}return!0}function Ub(t){let e=0;for(let n=0;n<t.length-1;n++)e+=t[n].dist(t[n+1]);return e}function Vb(t,e,n){return t?.6*e*n:0}function Gb(t,e){return Math.max(t?t.right-t.left:0,e?e.right-e.left:0)}function o3(t,e,n,a,l,u){const d=Vb(n,l,u),x=Gb(n,a)*u;let v=0;const S=Ub(t)/2;for(let L=0;L<t.length-1;L++){const P=t[L],O=t[L+1],V=P.dist(O);if(v+V>S){const G=(S-v)/V,$=Qn(P.x,O.x,G),Y=Qn(P.y,O.y,G),ne=new fd($,Y,0,O.angleTo(P),L);return!d||Nb(t,ne,x,d,e)?ne:void 0}v+=V}}function a3(t,e,n,a,l,u,d,x,v){const S=Vb(a,u,d),L=Gb(a,l),P=L*d,O=t[0].x===0||t[0].x===v||t[0].y===0||t[0].y===v;return e-P<e/4&&(e=P+e/4),Hb(t,O?e/2*x%e:(L/2+2*u)*d*x%e,e,S,n,P,O,!1,v)}function Hb(t,e,n,a,l,u,d,x,v){const S=u/2,L=Ub(t);let P=0,O=e-n,V=[];for(let G=0;G<t.length-1;G++){const $=t[G],Y=t[G+1],ne=$.dist(Y),Te=Y.angleTo($);for(;O+n<P+ne;){O+=n;const Ae=(O-P)/ne,Ce=Qn($.x,Y.x,Ae),qe=Qn($.y,Y.y,Ae);if(Ce>=0&&Ce<v&&qe>=0&&qe<v&&O-S>=0&&O+S<=L){const Ge=new fd(Ce,qe,0,Te,G);a&&!Nb(t,Ge,u,a,l)||V.push(Ge)}}P+=ne}return x||V.length||d||(V=Hb(t,P/2,n,a,l,u,d,!0,v)),V}function jb(t,e,n,a,l){const u=[];for(let d=0;d<t.length;d++){const x=t[d];let v;for(let S=0;S<x.length-1;S++){let L=x[S],P=x[S+1];L.x<e&&P.x<e||(L.x<e?L=new Kt(e,L.y+(e-L.x)/(P.x-L.x)*(P.y-L.y))._round():P.x<e&&(P=new Kt(e,L.y+(e-L.x)/(P.x-L.x)*(P.y-L.y))._round()),L.y<n&&P.y<n||(L.y<n?L=new Kt(L.x+(n-L.y)/(P.y-L.y)*(P.x-L.x),n)._round():P.y<n&&(P=new Kt(L.x+(n-L.y)/(P.y-L.y)*(P.x-L.x),n)._round()),L.x>=a&&P.x>=a||(L.x>=a?L=new Kt(a,L.y+(a-L.x)/(P.x-L.x)*(P.y-L.y))._round():P.x>=a&&(P=new Kt(a,L.y+(a-L.x)/(P.x-L.x)*(P.y-L.y))._round()),L.y>=l&&P.y>=l||(L.y>=l?L=new Kt(L.x+(l-L.y)/(P.y-L.y)*(P.x-L.x),l)._round():P.y>=l&&(P=new Kt(L.x+(l-L.y)/(P.y-L.y)*(P.x-L.x),l)._round()),v&&L.equals(v[v.length-1])||(v=[L],u.push(v)),v.push(P)))))}}return u}function Wb(t){let e=0,n=0;for(const d of t)e+=d.w*d.h,n=Math.max(n,d.w);t.sort((d,x)=>x.h-d.h);const a=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),n),h:1/0}];let l=0,u=0;for(const d of t)for(let x=a.length-1;x>=0;x--){const v=a[x];if(!(d.w>v.w||d.h>v.h)){if(d.x=v.x,d.y=v.y,u=Math.max(u,d.y+d.h),l=Math.max(l,d.x+d.w),d.w===v.w&&d.h===v.h){const S=a.pop();x<a.length&&(a[x]=S)}else d.h===v.h?(v.x+=d.w,v.w-=d.w):d.w===v.w?(v.y+=d.h,v.h-=d.h):(a.push({x:v.x+d.w,y:v.y,w:v.w-d.w,h:d.h}),v.y+=d.h,v.h-=d.h);break}}return{w:l,h:u,fill:e/(l*u)||0}}xe(fd,"Anchor");const jl=1;class rx{constructor(e,{pixelRatio:n,version:a,stretchX:l,stretchY:u,content:d}){this.paddedRect=e,this.pixelRatio=n,this.stretchX=l,this.stretchY=u,this.content=d,this.version=a}get tl(){return[this.paddedRect.x+jl,this.paddedRect.y+jl]}get br(){return[this.paddedRect.x+this.paddedRect.w-jl,this.paddedRect.y+this.paddedRect.h-jl]}get displaySize(){return[(this.paddedRect.w-2*jl)/this.pixelRatio,(this.paddedRect.h-2*jl)/this.pixelRatio]}}class qb{constructor(e,n,a){const l={},u={};this.haveRenderCallbacks=[];const d=[];this.addImages(e,l,d),this.addImages(n,u,d);const{w:x,h:v}=Wb(d),S=new $a({width:x||1,height:v||1});for(const L in e){const P=e[L],O=l[L].paddedRect;$a.copy(P.data,S,{x:0,y:0},{x:O.x+jl,y:O.y+jl},P.data,a,P.sdf)}for(const L in n){const P=n[L],O=u[L].paddedRect,V=O.x+jl,G=O.y+jl,$=P.data.width,Y=P.data.height;$a.copy(P.data,S,{x:0,y:0},{x:V,y:G},P.data,a),$a.copy(P.data,S,{x:0,y:Y-1},{x:V,y:G-1},{width:$,height:1},a),$a.copy(P.data,S,{x:0,y:0},{x:V,y:G+Y},{width:$,height:1},a),$a.copy(P.data,S,{x:$-1,y:0},{x:V-1,y:G},{width:1,height:Y},a),$a.copy(P.data,S,{x:0,y:0},{x:V+$,y:G},{width:1,height:Y},a)}this.image=S,this.iconPositions=l,this.patternPositions=u}addImages(e,n,a){for(const l in e){const u=e[l],d={x:0,y:0,w:u.data.width+2*jl,h:u.data.height+2*jl};a.push(d),n[l]=new rx(d,u),u.hasRenderCallback&&this.haveRenderCallbacks.push(l)}}patchUpdatedImages(e,n,a){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(l=>e.hasImage(l,a)),e.dispatchRenderCallbacks(this.haveRenderCallbacks,a);for(const l in e.getUpdatedImages(a))this.patchUpdatedImage(this.iconPositions[l],e.getImage(l,a),n),this.patchUpdatedImage(this.patternPositions[l],e.getImage(l,a),n)}patchUpdatedImage(e,n,a){if(!e||!n||e.version===n.version)return;e.version=n.version;const[l,u]=e.tl,d=!!Object.keys(this.patternPositions).length;a.update(n.data,{useMipmap:d},{x:l,y:u})}}xe(rx,"ImagePosition"),xe(qb,"ImageAtlas");const qg=1e20;function Zb(t,e,n,a,l,u,d,x,v){for(let S=e;S<e+a;S++)Xb(t,n*u+S,u,l,d,x,v);for(let S=n;S<n+l;S++)Xb(t,S*u+e,1,a,d,x,v)}function Xb(t,e,n,a,l,u,d){u[0]=0,d[0]=-qg,d[1]=qg,l[0]=t[e];for(let x=1,v=0,S=0;x<a;x++){l[x]=t[e+x*n];const L=x*x;do{const P=u[v];S=(l[x]-l[P]+L-P*P)/(x-P)/2}while(S<=d[v]&&--v>-1);v++,u[v]=x,d[v]=S,d[v+1]=qg}for(let x=0,v=0;x<a;x++){for(;d[v+1]<x;)v++;const S=u[v],L=x-S;t[e+x*n]=l[S]+L*L}}const zh=2,sx={none:0,ideographs:1,all:2};class km{constructor(e,n,a){this.requestManager=e,this.localGlyphMode=n,this.localFontFamily=a,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e,n){this.urls[n]=e}getGlyphs(e,n,a){const l=[],u=this.urls[n]||Q.GLYPHS_URL;for(const d in e)for(const x of e[d])l.push({stack:d,id:x});Ds(l,({stack:d,id:x},v)=>{let S=this.entries[d];S||(S=this.entries[d]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let L=S.glyphs[x];if(L!==void 0)return void v(null,{stack:d,id:x,glyph:L});if(L=this._tinySDF(S,d,x),L)return S.glyphs[x]=L,void v(null,{stack:d,id:x,glyph:L});const P=Math.floor(x/256);if(256*P>65535)return void v(new Error("glyphs > 65535 not supported"));if(S.ranges[P])return void v(null,{stack:d,id:x,glyph:L});let O=S.requests[P];O||(O=S.requests[P]=[],km.loadGlyphRange(d,P,u,this.requestManager,(V,G)=>{if(G){S.ascender=G.ascender,S.descender=G.descender;for(const $ in G.glyphs)this._doesCharSupportLocalGlyph(+$)||(S.glyphs[+$]=G.glyphs[+$]);S.ranges[P]=!0}for(const $ of O)$(V,G);delete S.requests[P]})),O.push((V,G)=>{V?v(V):G&&v(null,{stack:d,id:x,glyph:G.glyphs[x]||null})})},(d,x)=>{if(d)a(d);else if(x){const v={};for(const{stack:S,id:L,glyph:P}of x)v[S]===void 0&&(v[S]={}),v[S].glyphs===void 0&&(v[S].glyphs={}),v[S].glyphs[L]=P&&{id:P.id,bitmap:P.bitmap.clone(),metrics:P.metrics},v[S].ascender=this.entries[S].ascender,v[S].descender=this.entries[S].descender;a(null,v)}})}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==sx.none&&(this.localGlyphMode===sx.all?!!this.localFontFamily:!!this.localFontFamily&&(it["CJK Unified Ideographs"](e)||it["Hangul Syllables"](e)||it.Hiragana(e)||it.Katakana(e)||it["CJK Symbols and Punctuation"](e)||it["CJK Unified Ideographs Extension A"](e)||it["CJK Unified Ideographs Extension B"](e)))}_tinySDF(e,n,a){const l=this.localFontFamily;if(!l||!this._doesCharSupportLocalGlyph(a))return;let u=e.tinySDF;if(!u){let $="400";/bold/i.test(n)?$="900":/medium/i.test(n)?$="500":/light/i.test(n)&&($="200"),u=e.tinySDF=new km.TinySDF({fontFamily:l,fontWeight:$,fontSize:24*zh,buffer:3*zh,radius:8*zh}),u.fontWeight=$}if(this.localGlyphs[u.fontWeight][a])return this.localGlyphs[u.fontWeight][a];const d=String.fromCodePoint(a),{data:x,width:v,height:S,glyphWidth:L,glyphHeight:P,glyphLeft:O,glyphTop:V,glyphAdvance:G}=u.draw(d);return this.localGlyphs[u.fontWeight][a]={id:a,bitmap:new Fo({width:v,height:S},x),metrics:{width:L/zh,height:P/zh,left:O/zh,top:V/zh-27,advance:G/zh,localGlyph:!0}}}}km.loadGlyphRange=function(t,e,n,a,l){const u=256*e,d=u+255,x=a.transformRequest(a.normalizeGlyphsURL(n).replace("{fontstack}",t).replace("{range}",`${u}-${d}`),Ma.Glyphs);ic(x,(v,S)=>{if(v)l(v);else if(S){const L={},P=function(O){return new zm(O).readFields(e3,{})}(S);for(const O of P.glyphs)L[O.id]=O;l(null,{glyphs:L,ascender:P.ascender,descender:P.descender})}})},km.TinySDF=class{constructor({fontSize:t=24,buffer:e=3,radius:n=8,cutoff:a=.25,fontFamily:l="sans-serif",fontWeight:u="normal",fontStyle:d="normal"}={}){this.buffer=e,this.cutoff=a,this.radius=n;const x=this.size=t+4*e,v=this._createCanvas(x),S=this.ctx=v.getContext("2d",{willReadFrequently:!0});S.font=`${d} ${u} ${t}px ${l}`,S.textBaseline="alphabetic",S.textAlign="left",S.fillStyle="black",this.gridOuter=new Float64Array(x*x),this.gridInner=new Float64Array(x*x),this.f=new Float64Array(x),this.z=new Float64Array(x+1),this.v=new Uint16Array(x)}_createCanvas(t){const e=document.createElement("canvas");return e.width=e.height=t,e}draw(t){const{width:e,actualBoundingBoxAscent:n,actualBoundingBoxDescent:a,actualBoundingBoxLeft:l,actualBoundingBoxRight:u}=this.ctx.measureText(t),d=Math.ceil(n),x=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(u-l))),v=Math.min(this.size-this.buffer,d+Math.ceil(a)),S=x+2*this.buffer,L=v+2*this.buffer,P=Math.max(S*L,0),O=new Uint8ClampedArray(P),V={data:O,width:S,height:L,glyphWidth:x,glyphHeight:v,glyphTop:d,glyphLeft:0,glyphAdvance:e};if(x===0||v===0)return V;const{ctx:G,buffer:$,gridInner:Y,gridOuter:ne}=this;G.clearRect($,$,x,v),G.fillText(t,$,$+d);const Te=G.getImageData($,$,x,v);ne.fill(qg,0,P),Y.fill(0,0,P);for(let Ae=0;Ae<v;Ae++)for(let Ce=0;Ce<x;Ce++){const qe=Te.data[4*(Ae*x+Ce)+3]/255;if(qe===0)continue;const Ge=(Ae+$)*S+Ce+$;if(qe===1)ne[Ge]=0,Y[Ge]=qg;else{const ot=.5-qe;ne[Ge]=ot>0?ot*ot:0,Y[Ge]=ot<0?ot*ot:0}}Zb(ne,0,0,S,L,S,this.f,this.v,this.z),Zb(Y,$,$,x,v,S,this.f,this.v,this.z);for(let Ae=0;Ae<P;Ae++){const Ce=Math.sqrt(ne[Ae])-Math.sqrt(Y[Ae]);O[Ae]=Math.round(255-255*(Ce/this.radius+this.cutoff))}return V}};const ap=jl;function $b(t,e,n,a){const l=[],u=t.imagePrimary,d=u.pixelRatio,x=u.paddedRect.w-2*ap,v=u.paddedRect.h-2*ap,S=t.right-t.left,L=t.bottom-t.top,P=u.stretchX||[[0,x]],O=u.stretchY||[[0,v]],V=(Vt,ai)=>Vt+ai[1]-ai[0],G=P.reduce(V,0),$=O.reduce(V,0),Y=x-G,ne=v-$;let Te=0,Ae=G,Ce=0,qe=$,Ge=0,ot=Y,dt=0,Rt=ne;if(u.content&&a){const Vt=u.content;Te=Ay(P,0,Vt[0]),Ce=Ay(O,0,Vt[1]),Ae=Ay(P,Vt[0],Vt[2]),qe=Ay(O,Vt[1],Vt[3]),Ge=Vt[0]-Te,dt=Vt[1]-Ce,ot=Vt[2]-Vt[0]-Ae,Rt=Vt[3]-Vt[1]-qe}const $t=(Vt,ai,Ci,ti)=>{const bi=Cy(Vt.stretch-Te,Ae,S,t.left),Yt=Ly(Vt.fixed-Ge,ot,Vt.stretch,G),wi=Cy(ai.stretch-Ce,qe,L,t.top),zi=Ly(ai.fixed-dt,Rt,ai.stretch,$),Si=Cy(Ci.stretch-Te,Ae,S,t.left),fn=Ly(Ci.fixed-Ge,ot,Ci.stretch,G),Ii=Cy(ti.stretch-Ce,qe,L,t.top),Ui=Ly(ti.fixed-dt,Rt,ti.stretch,$),qn=new Kt(bi,wi),Fn=new Kt(Si,wi),Rn=new Kt(Si,Ii),Fi=new Kt(bi,Ii),Zn=new Kt(Yt/d,zi/d),Cr=new Kt(fn/d,Ui/d),or=e*Math.PI/180;if(or){const _s=Math.sin(or),is=Math.cos(or),$r=[is,-_s,_s,is];qn._matMult($r),Fn._matMult($r),Fi._matMult($r),Rn._matMult($r)}const Pr=Vt.stretch+Vt.fixed,Lr=Ci.stretch+Ci.fixed,Fr=ai.stretch+ai.fixed,nr=ti.stretch+ti.fixed,bs=t.imageSecondary;return{tl:qn,tr:Fn,bl:Fi,br:Rn,texPrimary:{x:u.paddedRect.x+ap+Pr,y:u.paddedRect.y+ap+Fr,w:Lr-Pr,h:nr-Fr},texSecondary:bs?{x:bs.paddedRect.x+ap+Pr,y:bs.paddedRect.y+ap+Fr,w:Lr-Pr,h:nr-Fr}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Zn,pixelOffsetBR:Cr,minFontScaleX:ot/d/S,minFontScaleY:Rt/d/L,isSDF:n}};if(a&&(u.stretchX||u.stretchY)){const Vt=Yb(P,Y,G),ai=Yb(O,ne,$);for(let Ci=0;Ci<Vt.length-1;Ci++){const ti=Vt[Ci],bi=Vt[Ci+1];for(let Yt=0;Yt<ai.length-1;Yt++)l.push($t(ti,ai[Yt],bi,ai[Yt+1]))}}else l.push($t({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:x+1},{fixed:0,stretch:v+1}));return l}function Ay(t,e,n){let a=0;for(const l of t)a+=Math.max(e,Math.min(n,l[1]))-Math.max(e,Math.min(n,l[0]));return a}function Yb(t,e,n){const a=[{fixed:-ap,stretch:0}];for(const[l,u]of t){const d=a[a.length-1];a.push({fixed:l-d.stretch,stretch:d.stretch}),a.push({fixed:l-d.stretch,stretch:d.stretch+(u-l)})}return a.push({fixed:e+ap,stretch:n}),a}function Cy(t,e,n,a){return t/e*n+a}function Ly(t,e,n,a){return t-e*n/a}function l3(t,e,n,a){const l=e+t.positionedLines[a].lineOffset;return a===0?n+l/2:n+(l+(e+t.positionedLines[a-1].lineOffset))/2}function c3(t,e=1,n=!1){let a=1/0,l=1/0,u=-1/0,d=-1/0;const x=t[0];for(let V=0;V<x.length;V++){const G=x[V];(!V||G.x<a)&&(a=G.x),(!V||G.y<l)&&(l=G.y),(!V||G.x>u)&&(u=G.x),(!V||G.y>d)&&(d=G.y)}const v=Math.min(u-a,d-l);let S=v/2;const L=new Pp([],h3);if(v===0)return new Kt(a,l);for(let V=a;V<u;V+=v)for(let G=l;G<d;G+=v)L.push(new Bm(V+S,G+S,S,t));let P=function(V){let G=0,$=0,Y=0;const ne=V[0];for(let Te=0,Ae=ne.length,Ce=Ae-1;Te<Ae;Ce=Te++){const qe=ne[Te],Ge=ne[Ce],ot=qe.x*Ge.y-Ge.x*qe.y;$+=(qe.x+Ge.x)*ot,Y+=(qe.y+Ge.y)*ot,G+=3*ot}return new Bm($/G,Y/G,0,V)}(t),O=L.length;for(;L.length;){const V=L.pop();(V.d>P.d||!P.d)&&(P=V,n&&console.log("found best %d after %d probes",Math.round(1e4*V.d)/1e4,O)),V.max-P.d<=e||(S=V.h/2,L.push(new Bm(V.p.x-S,V.p.y-S,S,t)),L.push(new Bm(V.p.x+S,V.p.y-S,S,t)),L.push(new Bm(V.p.x-S,V.p.y+S,S,t)),L.push(new Bm(V.p.x+S,V.p.y+S,S,t)),O+=4)}return n&&(console.log(`num probes: ${O}`),console.log(`best distance: ${P.d}`)),P.p}function h3(t,e){return e.max-t.max}class Bm{constructor(e,n,a,l){this.p=new Kt(e,n),this.h=a,this.d=function(u,d){let x=!1,v=1/0;for(let S=0;S<d.length;S++){const L=d[S];for(let P=0,O=L.length,V=O-1;P<O;V=P++){const G=L[P],$=L[V];G.y>u.y!=$.y>u.y&&u.x<($.x-G.x)*(u.y-G.y)/($.y-G.y)+G.x&&(x=!x),v=Math.min(v,A(u,G,$))}}return(x?1:-1)*Math.sqrt(v)}(this.p,l),this.max=this.d+this.h*Math.SQRT2}}const ox=Number.POSITIVE_INFINITY,u3=Math.sqrt(2);function Jb(t,[e,n]){let a=0,l=0;if(n===ox){e<0&&(e=0);const u=e/u3;switch(t){case"top-right":case"top-left":l=u-7;break;case"bottom-right":case"bottom-left":l=7-u;break;case"bottom":l=7-e;break;case"top":l=e-7}switch(t){case"top-right":case"bottom-right":a=-u;break;case"top-left":case"bottom-left":a=u;break;case"left":a=e;break;case"right":a=-e}}else{switch(e=Math.abs(e),n=Math.abs(n),t){case"top-right":case"top-left":case"top":l=n-7;break;case"bottom-right":case"bottom-left":case"bottom":l=7-n}switch(t){case"top-right":case"bottom-right":case"right":a=-e;break;case"top-left":case"bottom-left":case"left":a=e}}return[a,l]}function ax(t){switch(t){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function d3(t,e,n,a,l,u,d,x,v,S,L,P,O,V,G){let $=u.textMaxSize.evaluate(e,{},P);$===void 0&&($=d);const Y=t.layers[0].layout,ne=Y.get("icon-offset").evaluate(e,{},P),Te=Qb(n.horizontal)||n.vertical,Ae=O.name==="globe",Ce=aa,qe=d/Ce,Ge=t.tilePixelRatio*$/Ce,ot=(bi=t.overscaling,t.zoom>18&&bi>2&&(bi>>=1),Math.max(ji/(512*bi),1)*Y.get("symbol-spacing")),dt=Y.get("text-padding")*t.tilePixelRatio,Rt=Y.get("icon-padding")*t.tilePixelRatio,$t=Pn(Y.get("text-max-angle")),Vt=Y.get("text-rotation-alignment")==="map"&&Y.get("symbol-placement")!=="point",ai=Y.get("icon-rotation-alignment")==="map"&&Y.get("symbol-placement")!=="point",Ci=Y.get("symbol-placement"),ti=ot/2;var bi;const Yt=Y.get("icon-text-fit").evaluate(e,{},P),wi=Y.get("icon-text-fit-padding").evaluate(e,{},P),zi=Yt!=="none";let Si;t.hasAnyIconTextFit===!1&&zi&&(t.hasAnyIconTextFit=!0),a&&zi&&(t.allowVerticalPlacement&&n.vertical&&(Si=Bb(a,n.vertical,Yt,wi,ne,qe)),Te&&(a=Bb(a,Te,Yt,wi,ne,qe)));const fn=(Ii,Ui,qn)=>{if(Ui.x<0||Ui.x>=ji||Ui.y<0||Ui.y>=ji)return;let Fn=null;if(Ae){const{x:Rn,y:Fi,z:Zn}=O.projectTilePoint(Ui.x,Ui.y,qn);Fn={anchor:new fd(Rn,Fi,Zn,0,void 0),up:O.upVector(qn,Ui.x,Ui.y)}}(function(Rn,Fi,Zn,Cr,or,Pr,Lr,Fr,nr,bs,_s,is,$r,ns,Ps,Ss,Zs,Hs,xa,so,Vs,xo,Qo,ea,Es,Ya,md){const Jc=Rn.addToLineVertexArray(Fi,Cr);let Nh,fp,mp,ff,tM,iM,nM,rM=0,sM=0,oM=0,aM=0,zx=-1,Ox=-1;const xu={};let lM=Fu("");const mf=Zn?Zn.anchor:Fi,Fx=nr.layout.get("icon-text-fit").evaluate(Vs,{},Es)!=="none";let kx=0,Bx=0;if(nr._unevaluatedLayout.getValue("text-radial-offset")===void 0?[kx,Bx]=nr.layout.get("text-offset").evaluate(Vs,{},Es).map(ql=>ql*aa):(kx=nr.layout.get("text-radial-offset").evaluate(Vs,{},Es)*aa,Bx=ox),Rn.allowVerticalPlacement&&or.vertical){const ql=or.vertical;if(Ps)iM=lx(ql),Fr&&(nM=lx(Fr));else{const Zl=nr.layout.get("text-rotate").evaluate(Vs,{},Es)+90;mp=Iy(bs,mf,Fi,_s,is,$r,ql,ns,Zl,Ss),Fr&&(ff=Iy(bs,mf,Fi,_s,is,$r,Fr,Hs,Zl))}}if(Pr){const ql=nr.layout.get("icon-rotate").evaluate(Vs,{},Es),Zl=$b(Pr,ql,Qo,Fx),Zm=Fr?$b(Fr,ql,Qo,Fx):void 0;fp=Iy(bs,mf,Fi,_s,is,$r,Pr,Hs,ql),rM=4*Zl.length;const cM=Rn.iconSizeData;let gf=null;cM.kind==="source"?(gf=[Dh*nr.layout.get("icon-size").evaluate(Vs,{},Es)],gf[0]>lp&&Is(`${Rn.layerIds[0]}: Value for "icon-size" is >= ${Zg}. Reduce your "icon-size".`)):cM.kind==="composite"&&(gf=[Dh*xo.compositeIconSizes[0].evaluate(Vs,{},Es),Dh*xo.compositeIconSizes[1].evaluate(Vs,{},Es)],(gf[0]>lp||gf[1]>lp)&&Is(`${Rn.layerIds[0]}: Value for "icon-size" is >= ${Zg}. Reduce your "icon-size".`)),Rn.addSymbols(Rn.icon,Zl,gf,so,xa,Vs,!1,Zn,Fi,Jc.lineStartIndex,Jc.lineLength,-1,ea,Es,Ya,md),zx=Rn.icon.placedSymbolArray.length-1,Zm&&(sM=4*Zm.length,Rn.addSymbols(Rn.icon,Zm,gf,so,xa,Vs,_c.vertical,Zn,Fi,Jc.lineStartIndex,Jc.lineLength,-1,ea,Es,Ya,md),Ox=Rn.icon.placedSymbolArray.length-1)}for(const ql in or.horizontal){const Zl=or.horizontal[ql];Nh||(lM=Fu(Zl.text),Ps?tM=lx(Zl):Nh=Iy(bs,mf,Fi,_s,is,$r,Zl,ns,nr.layout.get("text-rotate").evaluate(Vs,{},Es),Ss));const Zm=Zl.positionedLines.length===1;if(oM+=Kb(Rn,Zn,Fi,Zl,Lr,nr,Ps,Vs,Ss,Jc,or.vertical?_c.horizontal:_c.horizontalOnly,Zm?Object.keys(or.horizontal):[ql],xu,zx,xo,ea,Es,Ya),Zm)break}or.vertical&&(aM+=Kb(Rn,Zn,Fi,or.vertical,Lr,nr,Ps,Vs,Ss,Jc,_c.vertical,["vertical"],xu,Ox,xo,ea,Es,Ya));let gp=-1;const Nx=(ql,Zl)=>ql?Math.max(ql,Zl):Zl;gp=Nx(tM,gp),gp=Nx(iM,gp),gp=Nx(nM,gp);const BL=gp>-1?1:0;Rn.glyphOffsetArray.length>=65535&&Is("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),Vs.sortKey!==void 0&&Rn.addToSortKeyRanges(Rn.symbolInstances.length,Vs.sortKey),Rn.symbolInstances.emplaceBack(Fi.x,Fi.y,mf.x,mf.y,mf.z,xu.right>=0?xu.right:-1,xu.center>=0?xu.center:-1,xu.left>=0?xu.left:-1,xu.vertical>=0?xu.vertical:-1,zx,Ox,lM,Nh!==void 0?Nh:Rn.collisionBoxArray.length,Nh!==void 0?Nh+1:Rn.collisionBoxArray.length,mp!==void 0?mp:Rn.collisionBoxArray.length,mp!==void 0?mp+1:Rn.collisionBoxArray.length,fp!==void 0?fp:Rn.collisionBoxArray.length,fp!==void 0?fp+1:Rn.collisionBoxArray.length,ff||Rn.collisionBoxArray.length,ff?ff+1:Rn.collisionBoxArray.length,_s,oM,aM,rM,sM,BL,0,kx,Bx,gp,0,1,1,Fx?1:0)})(t,Ui,Fn,Ii,n,a,l,Si,t.layers[0],t.collisionBoxArray,e.index,e.sourceLayerIndex,t.index,dt,Vt,v,0,Rt,ai,ne,e,u,S,L,P,V,G)};if(Ci==="line")for(const Ii of jb(e.geometry,0,0,ji,ji)){const Ui=a3(Ii,ot,$t,n.vertical||Te,a,Ce,Ge,t.overscaling,ji);for(const qn of Ui)Te&&p3(t,Te.text,ti,qn)||fn(Ii,qn,P)}else if(Ci==="line-center"){for(const Ii of e.geometry)if(Ii.length>1){const Ui=o3(Ii,$t,n.vertical||Te,a,Ce,Ge);Ui&&fn(Ii,Ui,P)}}else if(e.type==="Polygon")for(const Ii of _l(e.geometry,0)){const Ui=c3(Ii,16);fn(Ii[0],new fd(Ui.x,Ui.y,0,0,void 0),P)}else if(e.type==="LineString")for(const Ii of e.geometry)fn(Ii,new fd(Ii[0].x,Ii[0].y,0,0,void 0),P);else if(e.type==="Point")for(const Ii of e.geometry)for(const Ui of Ii)fn([Ui],new fd(Ui.x,Ui.y,0,0,void 0),P)}const Zg=255,lp=Zg*Dh;function Kb(t,e,n,a,l,u,d,x,v,S,L,P,O,V,G,$,Y,ne){const Te=function(qe,Ge,ot,dt,Rt,$t,Vt,ai){const Ci=[];if(Ge.positionedLines.length===0)return Ci;const ti=dt.layout.get("text-rotate").evaluate($t,{})*Math.PI/180,bi=function(fn){const Ii=fn[0],Ui=fn[1],qn=Ii*Ui;return qn>0?[Ii,-Ui]:qn<0?[-Ii,Ui]:Ii===0?[Ui,Ii]:[Ui,-Ii]}(ot);let Yt=Math.abs(Ge.top-Ge.bottom);for(const fn of Ge.positionedLines)Yt-=fn.lineOffset;const wi=Ge.positionedLines.length,zi=Yt/wi;let Si=Ge.top-ot[1];for(let fn=0;fn<wi;++fn){const Ii=Ge.positionedLines[fn];Si=l3(Ge,zi,Si,fn);for(const Ui of Ii.positionedGlyphs){if(!Ui.rect)continue;const qn=Ui.rect||{};let Fn=Rb+1,Rn=!0,Fi=1,Zn=0;if(Ui.imageName){const so=Vt[Ui.imageName];if(!so)continue;if(so.sdf){Is("SDF images are not supported in formatted text and will be ignored.");continue}Rn=!1,Fi=so.pixelRatio,Fn=jl/Fi}const Cr=(Rt||ai)&&Ui.vertical,or=Ui.metrics.advance*Ui.scale/2,Pr=Ui.metrics,Lr=Ui.rect;if(Lr===null)continue;ai&&Ge.verticalizable&&(Zn=Ui.imageName?or-Ui.metrics.width*Ui.scale/2:0);const Fr=Rt?[Ui.x+or,Ui.y]:[0,0];let nr=[0,0],bs=[0,0],_s=!1;Rt||(Cr?(bs=[Ui.x+or+bi[0],Ui.y+bi[1]-Zn],_s=!0):nr=[Ui.x+or+ot[0],Ui.y+ot[1]-Zn]);const is=Lr.w*Ui.scale/(Fi*(Ui.localGlyph?zh:1)),$r=Lr.h*Ui.scale/(Fi*(Ui.localGlyph?zh:1));let ns,Ps,Ss,Zs;if(Cr){const so=Ui.y-Si,Vs=new Kt(-or,or-so),xo=-Math.PI/2,Qo=new Kt(...bs);ns=new Kt(-or+nr[0],nr[1]),ns._rotateAround(xo,Vs)._add(Qo),ns.x+=-so+or,ns.y-=(Pr.left-Fn)*Ui.scale;const ea=Ui.imageName?Pr.advance*Ui.scale:aa*Ui.scale,Es=String.fromCodePoint(Ui.glyph);KC(Es)?ns.x+=(1-Fn)*Ui.scale:QC(Es)?ns.x+=ea-Pr.height*Ui.scale+(-Fn-1)*Ui.scale:ns.x+=Ui.imageName||Pr.width+2*Fn===Lr.w&&Pr.height+2*Fn===Lr.h?(ea-$r)/2:(ea-(Pr.height+2*Fn)*Ui.scale)/2,Ps=new Kt(ns.x,ns.y-is),Ss=new Kt(ns.x+$r,ns.y),Zs=new Kt(ns.x+$r,ns.y-is)}else{const so=(Pr.left-Fn)*Ui.scale-or+nr[0],Vs=(-Pr.top-Fn)*Ui.scale+nr[1],xo=so+is,Qo=Vs+$r;ns=new Kt(so,Vs),Ps=new Kt(xo,Vs),Ss=new Kt(so,Qo),Zs=new Kt(xo,Qo)}if(ti){let so;so=Rt?new Kt(0,0):_s?new Kt(bi[0],bi[1]):new Kt(ot[0],ot[1]),ns._rotateAround(ti,so),Ps._rotateAround(ti,so),Ss._rotateAround(ti,so),Zs._rotateAround(ti,so)}const Hs=new Kt(0,0),xa=new Kt(0,0);Ci.push({tl:ns,tr:Ps,bl:Ss,br:Zs,texPrimary:qn,texSecondary:void 0,writingMode:Ge.writingMode,glyphOffset:Fr,sectionIndex:Ui.sectionIndex,isSDF:Rn,pixelOffsetTL:Hs,pixelOffsetBR:xa,minFontScaleX:0,minFontScaleY:0})}}return Ci}(0,a,v,u,d,x,l,t.allowVerticalPlacement),Ae=t.textSizeData;let Ce=null;Ae.kind==="source"?(Ce=[Dh*u.layout.get("text-size").evaluate(x,{},Y)],Ce[0]>lp&&Is(`${t.layerIds[0]}: Value for "text-size" is >= ${Zg}. Reduce your "text-size".`)):Ae.kind==="composite"&&(Ce=[Dh*G.compositeTextSizes[0].evaluate(x,{},Y),Dh*G.compositeTextSizes[1].evaluate(x,{},Y)],(Ce[0]>lp||Ce[1]>lp)&&Is(`${t.layerIds[0]}: Value for "text-size" is >= ${Zg}. Reduce your "text-size".`)),t.addSymbols(t.text,Te,Ce,v,d,x,L,e,n,S.lineStartIndex,S.lineLength,V,$,Y,ne,!1);for(const qe of P)O[qe]=t.text.placedSymbolArray.length-1;return 4*Te.length}function Qb(t){for(const e in t)return t[e];return null}function Iy(t,e,n,a,l,u,d,x,v,S){let L=d.top,P=d.bottom,O=d.left,V=d.right;const G=d.collisionPadding;if(G&&(O-=G[0],L-=G[1],V+=G[2],P+=G[3]),v){const $=new Kt(O,L),Y=new Kt(V,L),ne=new Kt(O,P),Te=new Kt(V,P),Ae=Pn(v);let Ce=new Kt(0,0);S&&(Ce=new Kt(S[0],S[1])),$._rotateAround(Ae,Ce),Y._rotateAround(Ae,Ce),ne._rotateAround(Ae,Ce),Te._rotateAround(Ae,Ce),O=Math.min($.x,Y.x,ne.x,Te.x),V=Math.max($.x,Y.x,ne.x,Te.x),L=Math.min($.y,Y.y,ne.y,Te.y),P=Math.max($.y,Y.y,ne.y,Te.y)}return t.emplaceBack(e.x,e.y,e.z,n.x,n.y,O,L,V,P,x,a,l,u),t.length-1}function lx(t){t.collisionPadding&&(t.top-=t.collisionPadding[1],t.bottom+=t.collisionPadding[3]);const e=t.bottom-t.top;return e>0?Math.max(10,e):null}function p3(t,e,n,a){const l=t.compareText;if(e in l){const u=l[e];for(let d=u.length-1;d>=0;d--)if(a.dist(u[d])<n)return!0}else l[e]=[];return l[e].push(a),!1}function ew(t,e){const n=t.fovAboveCenter,a=t.elevation?t.elevation.getMinElevationBelowMSL()*e:0,l=(t._camera.position[2]*t.worldSize-a)/Math.cos(t._pitch),u=Math.sin(n)*l/Math.sin(Math.max(Math.PI/2-t._pitch-n,.01)),d=Math.sin(t._pitch)*u+l;return Math.min(1.01*d,l*(1/t._horizonShift))}function lf(t,e){if(!e.isReprojectedInTileSpace)return{scale:1<<t.z,x:t.x,y:t.y,x2:t.x+1,y2:t.y+1,projection:e};const n=Math.pow(2,-t.z),a=t.x*n,l=(t.x+1)*n,u=t.y*n,d=(t.y+1)*n,x=oa(a),v=oa(l),S=Co(u),L=Co(d),P=e.project(x,S),O=e.project(v,S),V=e.project(v,L),G=e.project(x,L);let $=Math.min(P.x,O.x,V.x,G.x),Y=Math.min(P.y,O.y,V.y,G.y),ne=Math.max(P.x,O.x,V.x,G.x),Te=Math.max(P.y,O.y,V.y,G.y);const Ae=n/16;function Ce(Ge,ot,dt,Rt,$t,Vt){const ai=(dt+$t)/2,Ci=(Rt+Vt)/2,ti=e.project(oa(ai),Co(Ci)),bi=Math.max(0,$-ti.x,Y-ti.y,ti.x-ne,ti.y-Te);$=Math.min($,ti.x),ne=Math.max(ne,ti.x),Y=Math.min(Y,ti.y),Te=Math.max(Te,ti.y),bi>Ae&&(Ce(Ge,ti,dt,Rt,ai,Ci),Ce(ti,ot,ai,Ci,$t,Vt))}Ce(P,O,a,u,l,u),Ce(O,V,l,u,l,d),Ce(V,G,l,d,a,d),Ce(G,P,a,d,a,u),$-=Ae,Y-=Ae,ne+=Ae,Te+=Ae;const qe=1/Math.max(ne-$,Te-Y);return{scale:qe,x:$*qe,y:Y*qe,x2:ne*qe,y2:Te*qe,projection:e}}function tw(t,{x:e,y:n},a=0){return new Kt(((e-a)*t.scale-t.x)*ji,(n*t.scale-t.y)*ji)}const f3=s.ad.identity(new Float32Array(16));class cp{constructor(e){this.spec=e,this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,n){return{x:0,y:0,z:0}}unproject(e,n){return new Gr(0,0)}projectTilePoint(e,n,a){return{x:e,y:n,z:0}}locationPoint(e,n,a=!0){return e._coordinatePoint(e.locationCoordinate(n),a)}pixelsPerMeter(e,n){return Go(1,e)*n}pixelSpaceConversion(e,n,a){return 1}farthestPixelDistance(e){return ew(e,e.pixelsPerMeter)}pointCoordinate(e,n,a,l){const u=e.horizonLineFromTop(!1),d=new Kt(n,Math.max(u,a));return e.rayIntersectionCoordinate(e.pointRayIntersection(d,l))}pointCoordinate3D(e,n,a){const l=new Kt(n,a);if(e.elevation)return e.elevation.pointCoordinate(l);{const u=this.pointCoordinate(e,l.x,l.y,0);return[u.x,u.y,u.z]}}isPointAboveHorizon(e,n){if(e.elevation&&e.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(e,n.x,n.y);const a=e.horizonLineFromTop();return n.y<a}createInversionMatrix(e,n){return f3}createTileMatrix(e,n,a){let l,u,d;const x=a.canonical,v=s.ad.identity(new Float64Array(16));if(this.isReprojectedInTileSpace){const S=lf(x,this);l=1,u=S.x+a.wrap*S.scale,d=S.y,s.ad.scale(v,v,[l/S.scale,l/S.scale,e.pixelsPerMeter/n])}else l=n/e.zoomScale(x.z),u=(x.x+Math.pow(2,x.z)*a.wrap)*l,d=x.y*l;return s.ad.translate(v,v,[u,d,0]),s.ad.scale(v,v,[l/ji,l/ji,1]),v}upVector(e,n,a){return[0,0,1]}upVectorScale(e,n,a){return{metersToTile:1}}}class m3 extends cp{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];const[n,a]=this.parallels=e.parallels||[29.5,45.5],l=Math.sin(Pn(n));this.n=(l+Math.sin(Pn(a)))/2,this.c=1+l*(2*this.n-l),this.r0=Math.sqrt(this.c)/this.n}project(e,n){const{n:a,c:l,r0:u}=this,d=Pn(e-this.center[0]),x=Pn(n),v=Math.sqrt(l-2*a*Math.sin(x))/a;return{x:v*Math.sin(d*a),y:v*Math.cos(d*a)-u,z:0}}unproject(e,n){const{n:a,c:l,r0:u}=this,d=u+n;let x=Math.atan2(e,Math.abs(d))*Math.sign(d);d*a<0&&(x-=Math.PI*Math.sign(e)*Math.sign(d));const v=Pn(this.center[0])*a;x=To(x,-Math.PI-v,Math.PI-v);const S=pn(_r(x/a)+this.center[0],-180,180),L=Math.asin(pn((l-(e*e+d*d)*a*a)/(2*a),-1,1)),P=pn(_r(L),-Js,Js);return new Gr(S,P)}}const Xg=1.340264,$g=-.081106,Yg=893e-6,Jg=.003796,Py=Math.sqrt(3)/2;class g3 extends cp{project(e,n){n=n/180*Math.PI,e=e/180*Math.PI;const a=Math.asin(Py*Math.sin(n)),l=a*a,u=l*l*l;return{x:.5*(e*Math.cos(a)/(Py*(Xg+3*$g*l+u*(7*Yg+9*Jg*l)))/Math.PI+.5),y:1-.5*(a*(Xg+$g*l+u*(Yg+Jg*l))/Math.PI+1),z:0}}unproject(e,n){e=(2*e-.5)*Math.PI;let a=n=(2*(1-n)-1)*Math.PI,l=a*a,u=l*l*l;for(let L,P,O,V=0;V<12&&(P=a*(Xg+$g*l+u*(Yg+Jg*l))-n,O=Xg+3*$g*l+u*(7*Yg+9*Jg*l),L=P/O,a=pn(a-L,-Math.PI/3,Math.PI/3),l=a*a,u=l*l*l,!(Math.abs(L)<1e-12));++V);const d=Py*e*(Xg+3*$g*l+u*(7*Yg+9*Jg*l))/Math.cos(a),x=Math.asin(Math.sin(a)/Py),v=pn(180*d/Math.PI,-180,180),S=pn(180*x/Math.PI,-Js,Js);return new Gr(v,S)}}class _3 extends cp{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,n){return{x:.5+e/360,y:.5-n/360,z:0}}unproject(e,n){const a=360*(e-.5),l=pn(360*(.5-n),-Js,Js);return new Gr(a,l)}}const Nm=Math.PI/2;function Ry(t){return Math.tan((Nm+t)/2)}class y3 extends cp{constructor(e){super(e),this.center=e.center||[0,30];const[n,a]=this.parallels=e.parallels||[30,30];let l=Pn(n),u=Pn(a);this.southernCenter=l+u<0,this.southernCenter&&(l=-l,u=-u);const d=Math.cos(l),x=Ry(l);this.n=l===u?Math.sin(l):Math.log(d/Math.cos(u))/Math.log(Ry(u)/x),this.f=d*Math.pow(Ry(l),this.n)/this.n}project(e,n){n=Pn(n),this.southernCenter&&(n=-n),e=Pn(e-this.center[0]);const a=1e-6,{n:l,f:u}=this;u>0?n<-Nm+a&&(n=-Nm+a):n>Nm-a&&(n=Nm-a);const d=u/Math.pow(Ry(n),l);let x=d*Math.sin(l*e),v=u-d*Math.cos(l*e);return x=.5*(x/Math.PI+.5),v=.5*(v/Math.PI+.5),{x,y:this.southernCenter?v:1-v,z:0}}unproject(e,n){e=(2*e-.5)*Math.PI,this.southernCenter&&(n=1-n),n=(2*(1-n)-.5)*Math.PI;const{n:a,f:l}=this,u=l-n,d=Math.sign(u),x=Math.sign(a)*Math.sqrt(e*e+u*u);let v=Math.atan2(e,Math.abs(u))*d;u*a<0&&(v-=Math.PI*Math.sign(e)*d);const S=pn(_r(v/a)+this.center[0],-180,180),L=pn(_r(2*Math.atan(Math.pow(l/x,1/a))-Nm),-Js,Js);return new Gr(S,this.southernCenter?-L:L)}}class iw extends cp{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,n){return{x:mc(e),y:sa(n),z:0}}unproject(e,n){const a=oa(e),l=Co(n);return new Gr(a,l)}}const nw=Pn(Js);class x3 extends cp{project(e,n){const a=(n=Pn(n))*n,l=a*a;return{x:.5*((e=Pn(e))*(.8707-.131979*a+l*(l*(.003971*a-.001529*l)-.013791))/Math.PI+.5),y:1-.5*(n*(1.007226+a*(.015085+l*(.028874*a-.044475-.005916*l)))/Math.PI+1),z:0}}unproject(e,n){e=(2*e-.5)*Math.PI;let a=n=(2*(1-n)-1)*Math.PI,l=25,u=0,d=a*a;do{d=a*a;const S=d*d;u=(a*(1.007226+d*(.015085+S*(.028874*d-.044475-.005916*S)))-n)/(1.007226+d*(.045255+S*(.259866*d-.311325-.005916*11*S))),a=pn(a-u,-nw,nw)}while(Math.abs(u)>1e-6&&--l>0);d=a*a;const x=pn(_r(e/(.8707+d*(d*(d*d*d*(.003971-.001529*d)-.013791)-.131979))),-180,180),v=_r(a);return new Gr(x,v)}}const rw=Pn(Js);class v3 extends cp{project(e,n){n=Pn(n),e=Pn(e);const a=Math.cos(n),l=2/Math.PI,u=Math.acos(a*Math.cos(e/2)),d=Math.sin(u)/u,x=.5*(e*l+2*a*Math.sin(e/2)/d)||0,v=.5*(n+Math.sin(n)/d)||0;return{x:.5*(x/Math.PI+.5),y:1-.5*(v/Math.PI+1),z:0}}unproject(e,n){let a=e=(2*e-.5)*Math.PI,l=n=(2*(1-n)-1)*Math.PI,u=25;const d=1e-6;let x=0,v=0;do{const S=Math.cos(l),L=Math.sin(l),P=2*L*S,O=L*L,V=S*S,G=Math.cos(a/2),$=Math.sin(a/2),Y=2*G*$,ne=$*$,Te=1-V*G*G,Ae=Te?1/Te:0,Ce=Te?Math.acos(S*G)*Math.sqrt(1/Te):0,qe=.5*(2*Ce*S*$+2*a/Math.PI)-e,Ge=.5*(Ce*L+l)-n,ot=.5*Ae*(V*ne+Ce*S*G*O)+1/Math.PI,dt=Ae*(Y*P/4-Ce*L*$),Rt=.125*Ae*(P*$-Ce*L*V*Y),$t=.5*Ae*(O*G+Ce*ne*S)+.5,Vt=dt*Rt-$t*ot;x=(Ge*dt-qe*$t)/Vt,v=(qe*Rt-Ge*ot)/Vt,a=pn(a-x,-Math.PI,Math.PI),l=pn(l-v,-rw,rw)}while((Math.abs(x)>d||Math.abs(v)>d)&&--u>0);return new Gr(_r(a),_r(l))}}class sw extends cp{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(Pn(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,n){const{scale:a,cosPhi:l}=this;return{x:Pn(e)*l*a+.5,y:-Math.sin(Pn(n))/l*a+.5,z:0}}unproject(e,n){const{scale:a,cosPhi:l}=this,u=-(n-.5)/a,d=pn(_r((e-.5)/a)/l,-180,180),x=Math.asin(pn(u*l,-1,1)),v=pn(_r(x),-Js,Js);return new Gr(d,v)}}class b3 extends iw{constructor(e){super(e),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(e,n,a){const l=An(e,n,a),u=pt(hr(a));return s._.transformMat4(l,l,u),{x:l[0],y:l[1],z:l[2]}}locationPoint(e,n){const a=us(n.lat,n.lng),l=s._.normalize([],a),u=e.elevation?e.elevation.getAtPointOrZero(e.locationCoordinate(n),e._centerAltitude):e._centerAltitude,d=Go(1,0)*ji*u;s._.scaleAndAdd(a,a,l,d);const x=s.ad.identity(new Float64Array(16));return s.ad.multiply(x,e.pixelMatrix,e.globeMatrix),s._.transformMat4(a,a,x),new Kt(a[0],a[1])}pixelsPerMeter(e,n){return Go(1,0)*n}pixelSpaceConversion(e,n,a){const l=Go(1,e)*n,u=Qn(Go(1,45)*n,l,a);return this.pixelsPerMeter(e,n)/u}createTileMatrix(e,n,a){const l=di(hr(a.canonical));return s.ad.multiply(new Float64Array(16),e.globeMatrix,l)}createInversionMatrix(e,n){const{center:a}=e,l=pt(hr(n));return s.ad.rotateY(l,l,Pn(a.lng)),s.ad.rotateX(l,l,Pn(a.lat)),s.ad.scale(l,l,[e._pixelsPerMercatorPixel,e._pixelsPerMercatorPixel,1]),Float32Array.from(l)}pointCoordinate(e,n,a,l){return tr(e,n,a,!0)||new Lo(0,0)}pointCoordinate3D(e,n,a){const l=this.pointCoordinate(e,n,a,0);return[l.x,l.y,l.z]}isPointAboveHorizon(e,n){return!tr(e,n.x,n.y,!1)}farthestPixelDistance(e){const n=function(l,u){const d=l.cameraToCenterDistance,x=l._centerAltitude*u,v=l._camera,S=l._camera.forward(),L=s._.add([],s._.scale([],S,-d),[0,0,x]),P=l.worldSize/(2*Math.PI),O=[0,0,-P],V=l.width/l.height,G=Math.tan(l.fovAboveCenter),$=s._.scale([],v.up(),G),Y=s._.scale([],v.right(),G*V),ne=s._.normalize([],s._.add([],s._.add([],S,$),Y)),Te=[];let Ae;if(new nt(L,ne).closestPointOnSphere(O,P,Te)){const Ce=s._.add([],Te,O),qe=s._.sub([],Ce,L);Ae=Math.cos(l.fovAboveCenter)*s._.length(qe)}else{const Ce=s._.sub([],L,O),qe=s._.sub([],O,L);s._.normalize(qe,qe);const Ge=s._.length(Ce)-P;Ae=Math.sqrt(Ge*(Ge+2*P));const ot=Math.acos(Ae/(P+Ge))-Math.acos(s._.dot(S,qe));Ae*=Math.cos(ot)}return 1.01*Ae}(e,this.pixelsPerMeter(e.center.lat,e.worldSize)),a=Hn(e.zoom);if(a>0){const l=ew(e,Go(1,e.center.lat)*e.worldSize),u=e.worldSize/(2*Math.PI),d=Math.max(e.width,e.height)/e.worldSize*Math.PI;return Qn(n,l+u*(1-Math.cos(d)),Math.pow(a,10))}return n}upVector(e,n,a){return An(n,a,e,1)}upVectorScale(e){return{metersToTile:vn(Cn(hr(e)))}}}function ow(t){const e=t.parallels,n=!!e&&Math.abs(e[0]+e[1])<.01;switch(t.name){case"mercator":return new iw(t);case"equirectangular":return new _3(t);case"naturalEarth":return new x3(t);case"equalEarth":return new g3(t);case"winkelTripel":return new v3(t);case"albers":return n?new sw(t):new m3(t);case"lambertConformalConic":return n?new sw(t):new y3(t);case"globe":return new b3(t)}throw new Error(`Invalid projection name: ${t.name}`)}class cf{constructor(e,n,a,l){this.id=cf.uniqueIdxCounter,cf.uniqueIdxCounter++,this.context=e;const u=e.gl;this.buffer=u.createBuffer(),this.dynamicDraw=!!a,this.context.unbindVAO(),e.bindElementBuffer.set(this.buffer),u.bufferData(u.ELEMENT_ARRAY_BUFFER,n.arrayBuffer,this.dynamicDraw?u.DYNAMIC_DRAW:u.STATIC_DRAW),this.dynamicDraw||l||n.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(e){this.id=cf.uniqueIdxCounter,cf.uniqueIdxCounter++;const n=this.context.gl;this.context.unbindVAO(),this.bind(),n.bufferSubData(n.ELEMENT_ARRAY_BUFFER,0,e.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}cf.uniqueIdxCounter=0;class Um{constructor(e,n,a){this.func=e,this.mask=n,this.range=a}}Um.ReadOnly=!1,Um.ReadWrite=!0,Um.disabled=new Um(519,Um.ReadOnly,[0,1]);const cx=7680;class hx{constructor(e,n,a,l,u,d){this.test=e,this.ref=n,this.mask=a,this.fail=l,this.depthFail=u,this.pass=d}}hx.disabled=new hx({func:519,mask:0},0,0,cx,cx,cx);const Kg=771;class Wl{constructor(e,n,a,l){this.blendFunction=e,this.blendColor=n,this.mask=a,this.blendEquation=l}}Wl.Replace=[1,0,1,0],Wl.disabled=new Wl(Wl.Replace,Yr.transparent,[!1,!1,!1,!1]),Wl.unblended=new Wl(Wl.Replace,Yr.transparent,[!0,!0,!0,!0]),Wl.alphaBlended=new Wl([1,Kg,1,Kg],Yr.transparent,[!0,!0,!0,!0]),Wl.alphaBlendedNonPremultiplied=new Wl([770,Kg,770,Kg],Yr.transparent,[!0,!0,!0,!0]),Wl.multiply=new Wl([774,0,774,0],Yr.transparent,[!0,!0,!0,!0]);const ux=1029,dx=2305;class Oh{constructor(e,n,a){this.enable=e,this.mode=n,this.frontFace=a}}Oh.disabled=new Oh(!1,ux,dx),Oh.backCCW=new Oh(!0,ux,dx),Oh.backCW=new Oh(!0,ux,2304),Oh.frontCW=new Oh(!0,1028,2304),Oh.frontCCW=new Oh(!0,1028,dx);const w3=my.types,M3=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Dy(t,e,n,a,l,u,d,x,v,S,L,P,O){const V=x?Math.min(lp,Math.round(x[0])):0,G=x?Math.min(lp,Math.round(x[1])):0;t.emplaceBack(e,n,Math.round(32*a),Math.round(32*l),u,d,(V<<1)+(v?1:0),G,16*S,16*L,256*P,256*O)}function zy(t,e,n){t.emplaceBack(e,n)}function Oy(t,e,n,a,l,u,d){t.emplaceBack(e,n,a,l,u,d)}function Fy(t,e,n,a,l){t.emplaceBack(e,n,a,l),t.emplaceBack(e,n,a,l),t.emplaceBack(e,n,a,l),t.emplaceBack(e,n,a,l)}function T3(t){for(const e of t.sections)if($i(e.text))return!0;return!1}class px{constructor(e){this.layoutVertexArray=new sd,this.indexArray=new no,this.programConfigurations=e,this.segments=new Ts,this.dynamicLayoutVertexArray=new Uc,this.opacityVertexArray=new vg,this.occlusionQueryOpacityVertexArray=new pl,this.placedSymbolArray=new bg,this.iconTransitioningVertexArray=new Gc,this.globeExtVertexArray=new od,this.zOffsetVertexArray=new pl}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}upload(e,n,a,l,u){this.isEmpty()||(a&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,EC.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,n),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,CC.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,M3,!0),this.occlusionQueryOpacityVertexBuffer=e.createVertexBuffer(this.occlusionQueryOpacityVertexArray,K0.members,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=e.createVertexBuffer(this.iconTransitioningVertexArray,LC.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,AC.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||u)&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,fb.members,!0)),this.opacityVertexBuffer.itemSize=1),(a||l)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.occlusionQueryOpacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy())}}xe(px,"SymbolBuffers");class fx{constructor(e,n,a){this.layoutVertexArray=new e,this.layoutAttributes=n,this.indexArray=new a,this.segments=new Ts,this.collisionVertexArray=new ml,this.collisionVertexArrayExt=new Uc}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,IC.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,PC.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}xe(fx,"CollisionBuffers");class Vm{constructor(e){this.queries=new Map,this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.lut=e.lut,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(d=>d.fqid),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=s.ad.identity([]),this.placementViewportMatrix=s.ad.identity([]);const n=this.layers[0]._unevaluatedLayout._values;this.textSizeData=ex(this.zoom,n["text-size"]),this.iconSizeData=ex(this.zoom,n["icon-size"]);const a=this.layers[0].layout,l=a.get("symbol-sort-key"),u=a.get("symbol-z-order");this.canOverlap=a.get("text-allow-overlap")||a.get("icon-allow-overlap")||a.get("text-ignore-placement")||a.get("icon-ignore-placement"),this.sortFeaturesByKey=u!=="viewport-y"&&l.constantOr(1)!==void 0,this.sortFeaturesByY=(u==="viewport-y"||u==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=a.get("text-writing-mode").map(d=>_c[d]),this.stateDependentLayerIds=this.layers.filter(d=>d.isStateDependent()).map(d=>d.id),this.sourceID=e.sourceID,this.projection=e.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=a.get("symbol-z-elevate"),this.activeReplacements=[],this.replacementUpdateTime=0}createArrays(){this.text=new px(new Ph(this.layers,{zoom:this.zoom,lut:this.lut},e=>/^text/.test(e))),this.icon=new px(new Ph(this.layers,{zoom:this.zoom,lut:this.lut},e=>/^icon/.test(e))),this.glyphOffsetArray=new wg,this.lineVertexArray=new ym,this.symbolInstances=new _m}calculateGlyphDependencies(e,n,a,l,u){for(let d=0;d<e.length;d++){const x=e.codePointAt(d);if(x===void 0)break;if(n[x]=!0,l&&u&&x<=65535){const v=jg[e.charAt(d)];v&&(n[v.charCodeAt(0)]=!0)}}}updateFootprints(e,n){}updateReplacement(e,n){if(n.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=n.updateTime;const a=n.getReplacementRegionsForTile(e.toUnwrapped(),!0);return!Y0(this.activeReplacements,a)&&(this.activeReplacements=a,!0)}populate(e,n,a,l){const u=this.layers[0],d=u.layout,x=this.projection.name==="globe",v=d.get("text-font"),S=d.get("text-field"),L=d.get("icon-image"),P=(S.value.kind!=="constant"||S.value.value instanceof zo&&!S.value.value.isEmpty()||S.value.value.toString().length>0)&&(v.value.kind!=="constant"||v.value.value.length>0),O=L.value.kind!=="constant"||!!L.value.value||Object.keys(L.parameters).length>0,V=d.get("symbol-sort-key");if(this.features=[],!P&&!O)return;const G=n.iconDependencies,$=n.glyphDependencies,Y=n.availableImages,ne=new ir(this.zoom);for(const{feature:Te,id:Ae,index:Ce,sourceLayerIndex:qe}of e){const Ge=u._featureFilter.needGeometry,ot=gc(Te,Ge);if(!u._featureFilter.filter(ne,ot,a))continue;if(Ge||(ot.geometry=Za(Te,a,l)),x&&Te.type!==1&&a.z<=5){const Vt=ot.geometry,ai=.98078528056,Ci=(ti,bi)=>{const Yt=An(ti.x,ti.y,a,1),wi=An(bi.x,bi.y,a,1);return s._.dot(Yt,wi)<ai};for(let ti=0;ti<Vt.length;ti++)Vt[ti]=Io(Vt[ti],Ci)}let dt,Rt;if(P){const Vt=u.getValueAndResolveTokens("text-field",ot,a,Y),ai=zo.factory(Vt);T3(ai)&&(this.hasRTLText=!0),(!this.hasRTLText||er()==="unavailable"||this.hasRTLText&&zr.isParsed())&&(dt=JC(ai,u,ot))}if(O){const Vt=u.getValueAndResolveTokens("icon-image",ot,a,Y);Rt=Vt instanceof Aa?Vt:Aa.fromString(Vt)}if(!dt&&!Rt)continue;const $t=this.sortFeaturesByKey?V.evaluate(ot,{},a):void 0;if(this.features.push({id:Ae,text:dt,icon:Rt,index:Ce,sourceLayerIndex:qe,geometry:ot.geometry,properties:Te.properties,type:w3[Te.type],sortKey:$t}),Rt&&(G[Rt.namePrimary]=!0,Rt.nameSecondary&&(G[Rt.nameSecondary]=!0)),dt){const Vt=v.evaluate(ot,{},a).join(","),ai=d.get("text-rotation-alignment")==="map"&&d.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(_c.vertical)>=0;for(const Ci of dt.sections)if(Ci.image)G[Ci.image.namePrimary]=!0;else{const ti=Nt(dt.toString()),bi=Ci.fontStack||Vt,Yt=$[bi]=$[bi]||{};this.calculateGlyphDependencies(Ci.text,Yt,ai,this.allowVerticalPlacement,ti)}}}d.get("symbol-placement")==="line"&&(this.features=function(Te){const Ae={},Ce={},qe=[];let Ge=0;function ot(Vt){qe.push(Te[Vt]),Ge++}function dt(Vt,ai,Ci){const ti=Ce[Vt];return delete Ce[Vt],Ce[ai]=ti,qe[ti].geometry[0].pop(),qe[ti].geometry[0]=qe[ti].geometry[0].concat(Ci[0]),ti}function Rt(Vt,ai,Ci){const ti=Ae[ai];return delete Ae[ai],Ae[Vt]=ti,qe[ti].geometry[0].shift(),qe[ti].geometry[0]=Ci[0].concat(qe[ti].geometry[0]),ti}function $t(Vt,ai,Ci){const ti=Ci?ai[0][ai[0].length-1]:ai[0][0];return`${Vt}:${ti.x}:${ti.y}`}for(let Vt=0;Vt<Te.length;Vt++){const ai=Te[Vt],Ci=ai.geometry,ti=ai.text?ai.text.toString():null;if(!ti){ot(Vt);continue}const bi=$t(ti,Ci),Yt=$t(ti,Ci,!0);if(bi in Ce&&Yt in Ae&&Ce[bi]!==Ae[Yt]){const wi=Rt(bi,Yt,Ci),zi=dt(bi,Yt,qe[wi].geometry);delete Ae[bi],delete Ce[Yt],Ce[$t(ti,qe[zi].geometry,!0)]=zi,qe[wi].geometry=null}else bi in Ce?dt(bi,Yt,Ci):Yt in Ae?Rt(bi,Yt,Ci):(ot(Vt),Ae[bi]=Ge-1,Ce[Yt]=Ge-1)}return qe.filter(Vt=>Vt.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((Te,Ae)=>Te.sortKey-Ae.sortKey)}update(e,n,a,l,u){const d=Object.keys(e).length!==0;if(d&&!this.stateDependentLayers.length)return;const x=d?this.stateDependentLayers:this.layers;this.text.programConfigurations.updatePaintArrays(e,n,x,a,l,u),this.icon.programConfigurations.updatePaintArrays(e,n,x,a,l,u)}updateOcclusionOpacities(e,n,a){if(!n.useOcclusionQueries)return!1;const l=this;if(l.projection.name==="globe")return!1;let u=!1;l.hasTextData()&&(u=u||l.text.occlusionQueryOpacityVertexArray.length!==0),l.hasIconData()&&(u=u||l.icon.occlusionQueryOpacityVertexArray.length!==0);const d=l.layers[0].paint,x=d.get("icon-occlusion-opacity").constantOr(0),v=d.get("text-occlusion-opacity").constantOr(0);if(!l.layers[0].hasInitialOcclusionOpacityProperties||x===1&&v===1)return!1;let S=!u;for(let V=0;V<l.symbolInstances.length;V++){const G=l.symbolInstances.get(V),$=G.occlusionOpacity;G.occlusionOpacity+=(G.occlusionState>.5?1:-1)*n.fadeSpeed*a*.001,G.occlusionOpacity=pn(G.occlusionOpacity,0,1),S=S||G.occlusionOpacity!==$}if(!S)return!1;let L=0,P=0;const O=(V,G,$,Y)=>{let ne=0,Te=0;$?(ne=P,P+=Y,Te=P):(ne=L,L+=Y,Te=L),Te>G.occlusionQueryOpacityVertexArray.length&&G.occlusionQueryOpacityVertexArray.resize(Te);const Ae=V.occlusionOpacity;for(let Ce=0;Ce<Y;Ce++)G.occlusionQueryOpacityVertexArray.emplace(Ce+ne,Ae)};for(let V=0;V<l.symbolInstances.length;V++){const G=l.symbolInstances.get(V),{numHorizontalGlyphVertices:$,numVerticalGlyphVertices:Y,numIconVertices:ne}=G,Te=ne>0;if(($>0||Y>0)&&(O(G,l.text,!1,$),O(G,l.text,!1,Y)),Te){const{placedIconSymbolIndex:Ae,verticalPlacedIconSymbolIndex:Ce}=G;Ae>=0&&O(G,l.icon,!0,ne),Ce>=0&&O(G,l.icon,!0,G.numVerticalIconVertices)}}return l.hasTextData()&&l.text.occlusionQueryOpacityVertexBuffer&&(l.text.occlusionQueryOpacityVertexBuffer.length<l.text.occlusionQueryOpacityVertexArray.length?l.text.occlusionQueryOpacityVertexBuffer=e.createVertexBuffer(l.text.occlusionQueryOpacityVertexArray,K0.members,!0):l.text.occlusionQueryOpacityVertexBuffer.updateData(l.text.occlusionQueryOpacityVertexArray)),l.hasIconData()&&l.icon.occlusionQueryOpacityVertexBuffer&&(l.icon.occlusionQueryOpacityVertexBuffer.length<l.icon.occlusionQueryOpacityVertexArray.length?l.icon.occlusionQueryOpacityVertexBuffer=e.createVertexBuffer(l.icon.occlusionQueryOpacityVertexArray,K0.members,!0):l.icon.occlusionQueryOpacityVertexBuffer.updateData(l.icon.occlusionQueryOpacityVertexArray)),!0}updateZOffset(){const e=(u,d,x)=>{a+=d,a>u.length&&u.resize(a);for(let v=-d;v<0;v++)u.emplace(v+a,x)},n=(u,d,x)=>{l+=d,l>u.length&&u.resize(l);for(let v=-d;v<0;v++)u.emplace(v+l,x)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let a=0,l=0;for(let u=0;u<this.symbolInstances.length;u++){const d=this.symbolInstances.get(u),{numHorizontalGlyphVertices:x,numVerticalGlyphVertices:v,numIconVertices:S}=d,L=d.zOffset,P=S>0;if((x>0||v>0)&&(e(this.text.zOffsetVertexArray,x,L),e(this.text.zOffsetVertexArray,v,L)),P){const{placedIconSymbolIndex:O,verticalPlacedIconSymbolIndex:V}=d;O>=0&&n(this.icon.zOffsetVertexArray,S,L),V>=0&&n(this.icon.zOffsetVertexArray,d.numVerticalIconVertices,L)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=ow(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData();for(const e of this.queries.values())e.destroy()}addToLineVertexArray(e,n){const a=this.lineVertexArray.length;if(e.segment!==void 0)for(const{x:l,y:u}of n)this.lineVertexArray.emplaceBack(l,u);return{lineStartIndex:a,lineLength:this.lineVertexArray.length-a}}addSymbols(e,n,a,l,u,d,x,v,S,L,P,O,V,G,$,Y){const ne=e.indexArray,Te=e.layoutVertexArray,Ae=e.globeExtVertexArray,Ce=e.segments.prepareSegment(4*n.length,Te,ne,this.canOverlap?d.sortKey:void 0),qe=this.glyphOffsetArray.length,Ge=Ce.vertexLength,ot=this.allowVerticalPlacement&&x===_c.vertical?Math.PI/2:0,dt=d.text&&d.text.sections;for(let $t=0;$t<n.length;$t++){const{tl:Vt,tr:ai,bl:Ci,br:ti,texPrimary:bi,texSecondary:Yt,pixelOffsetTL:wi,pixelOffsetBR:zi,minFontScaleX:Si,minFontScaleY:fn,glyphOffset:Ii,isSDF:Ui,sectionIndex:qn}=n[$t],Fn=Ce.vertexLength,Rn=Ii[1];if(Dy(Te,S.x,S.y,Vt.x,Rn+Vt.y,bi.x,bi.y,a,Ui,wi.x,wi.y,Si,fn),Dy(Te,S.x,S.y,ai.x,Rn+ai.y,bi.x+bi.w,bi.y,a,Ui,zi.x,wi.y,Si,fn),Dy(Te,S.x,S.y,Ci.x,Rn+Ci.y,bi.x,bi.y+bi.h,a,Ui,wi.x,zi.y,Si,fn),Dy(Te,S.x,S.y,ti.x,Rn+ti.y,bi.x+bi.w,bi.y+bi.h,a,Ui,zi.x,zi.y,Si,fn),v){const{x:Fi,y:Zn,z:Cr}=v.anchor,[or,Pr,Lr]=v.up;Oy(Ae,Fi,Zn,Cr,or,Pr,Lr),Oy(Ae,Fi,Zn,Cr,or,Pr,Lr),Oy(Ae,Fi,Zn,Cr,or,Pr,Lr),Oy(Ae,Fi,Zn,Cr,or,Pr,Lr),Fy(e.dynamicLayoutVertexArray,Fi,Zn,Cr,ot)}else Fy(e.dynamicLayoutVertexArray,S.x,S.y,S.z,ot);if(Y){const Fi=Yt||bi;zy(e.iconTransitioningVertexArray,Fi.x,Fi.y),zy(e.iconTransitioningVertexArray,Fi.x+Fi.w,Fi.y),zy(e.iconTransitioningVertexArray,Fi.x,Fi.y+Fi.h),zy(e.iconTransitioningVertexArray,Fi.x+Fi.w,Fi.y+Fi.h)}ne.emplaceBack(Fn,Fn+1,Fn+2),ne.emplaceBack(Fn+1,Fn+2,Fn+3),Ce.vertexLength+=4,Ce.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(Ii[0]),$t!==n.length-1&&qn===n[$t+1].sectionIndex||e.programConfigurations.populatePaintArrays(Te.length,d,d.index,{},V,G,$,dt&&dt[qn])}const Rt=v?v.anchor:S;e.placedSymbolArray.emplaceBack(Rt.x,Rt.y,Rt.z,S.x,S.y,qe,this.glyphOffsetArray.length-qe,Ge,L,P,S.segment,a?a[0]:0,a?a[1]:0,l[0],l[1],x,0,!1,0,O,0)}_commitLayoutVertex(e,n,a,l,u,d,x){e.emplaceBack(n,a,l,u,d,Math.round(x.x),Math.round(x.y))}_addCollisionDebugVertices(e,n,a,l,u,d,x){const v=a.segments.prepareSegment(4,a.layoutVertexArray,a.indexArray),S=v.vertexLength,L=x.tileAnchorX,P=x.tileAnchorY;for(let V=0;V<4;V++)a.collisionVertexArray.emplaceBack(0,0,0,0);this._commitDebugCollisionVertexUpdate(a.collisionVertexArrayExt,n,e.padding,x.zOffset),this._commitLayoutVertex(a.layoutVertexArray,l,u,d,L,P,new Kt(e.x1,e.y1)),this._commitLayoutVertex(a.layoutVertexArray,l,u,d,L,P,new Kt(e.x2,e.y1)),this._commitLayoutVertex(a.layoutVertexArray,l,u,d,L,P,new Kt(e.x2,e.y2)),this._commitLayoutVertex(a.layoutVertexArray,l,u,d,L,P,new Kt(e.x1,e.y2)),v.vertexLength+=4;const O=a.indexArray;O.emplaceBack(S,S+1),O.emplaceBack(S+1,S+2),O.emplaceBack(S+2,S+3),O.emplaceBack(S+3,S),v.primitiveLength+=4}_addTextDebugCollisionBoxes(e,n,a,l,u,d){for(let x=l;x<u;x++){const v=a.get(x),S=this.getSymbolInstanceTextSize(e,d,n,x);this._addCollisionDebugVertices(v,S,this.textCollisionBox,v.projectedAnchorX,v.projectedAnchorY,v.projectedAnchorZ,d)}}_addIconDebugCollisionBoxes(e,n,a,l,u,d){for(let x=l;x<u;x++){const v=a.get(x),S=this.getSymbolInstanceIconSize(e,n,d.placedIconSymbolIndex);this._addCollisionDebugVertices(v,S,this.iconCollisionBox,v.projectedAnchorX,v.projectedAnchorY,v.projectedAnchorZ,d)}}generateCollisionDebugBuffers(e,n){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new fx(Vo,mb.members,Gc),this.iconCollisionBox=new fx(Vo,mb.members,Gc);const a=Om(this.iconSizeData,e),l=Om(this.textSizeData,e);for(let u=0;u<this.symbolInstances.length;u++){const d=this.symbolInstances.get(u);this._addTextDebugCollisionBoxes(l,e,n,d.textBoxStartIndex,d.textBoxEndIndex,d),this._addTextDebugCollisionBoxes(l,e,n,d.verticalTextBoxStartIndex,d.verticalTextBoxEndIndex,d),this._addIconDebugCollisionBoxes(a,e,n,d.iconBoxStartIndex,d.iconBoxEndIndex,d),this._addIconDebugCollisionBoxes(a,e,n,d.verticalIconBoxStartIndex,d.verticalIconBoxEndIndex,d)}}getSymbolInstanceTextSize(e,n,a,l){const u=this.text.placedSymbolArray.get(n.rightJustifiedTextSymbolIndex>=0?n.rightJustifiedTextSymbolIndex:n.centerJustifiedTextSymbolIndex>=0?n.centerJustifiedTextSymbolIndex:n.leftJustifiedTextSymbolIndex>=0?n.leftJustifiedTextSymbolIndex:n.verticalPlacedTextSymbolIndex>=0?n.verticalPlacedTextSymbolIndex:l),d=Sy(this.textSizeData,e,u)/aa;return this.tilePixelRatio*d}getSymbolInstanceIconSize(e,n,a){const l=this.icon.placedSymbolArray.get(a),u=Sy(this.iconSizeData,e,l);return this.tilePixelRatio*u}_commitDebugCollisionVertexUpdate(e,n,a,l){e.emplaceBack(n,-a,-a,l),e.emplaceBack(n,a,-a,l),e.emplaceBack(n,a,a,l),e.emplaceBack(n,-a,a,l)}_updateTextDebugCollisionBoxes(e,n,a,l,u,d){for(let x=l;x<u;x++){const v=a.get(x),S=this.getSymbolInstanceTextSize(e,d,n,x);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,S,v.padding,d.zOffset)}}_updateIconDebugCollisionBoxes(e,n,a,l,u,d){for(let x=l;x<u;x++){const v=a.get(x),S=this.getSymbolInstanceIconSize(e,n,d.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,S,v.padding,d.zOffset)}}updateCollisionDebugBuffers(e,n){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const a=Om(this.iconSizeData,e),l=Om(this.textSizeData,e);for(let u=0;u<this.symbolInstances.length;u++){const d=this.symbolInstances.get(u);this._updateTextDebugCollisionBoxes(l,e,n,d.textBoxStartIndex,d.textBoxEndIndex,d),this._updateTextDebugCollisionBoxes(l,e,n,d.verticalTextBoxStartIndex,d.verticalTextBoxEndIndex,d),this._updateIconDebugCollisionBoxes(a,e,n,d.iconBoxStartIndex,d.iconBoxEndIndex,d),this._updateIconDebugCollisionBoxes(a,e,n,d.verticalIconBoxStartIndex,d.verticalIconBoxEndIndex,d)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,n,a,l,u,d,x,v,S){const L={};if(n<a){const{x1:P,y1:O,x2:V,y2:G,padding:$,projectedAnchorX:Y,projectedAnchorY:ne,projectedAnchorZ:Te,tileAnchorX:Ae,tileAnchorY:Ce,featureIndex:qe}=e.get(n);L.textBox={x1:P,y1:O,x2:V,y2:G,padding:$,projectedAnchorX:Y,projectedAnchorY:ne,projectedAnchorZ:Te,tileAnchorX:Ae,tileAnchorY:Ce},L.textFeatureIndex=qe}if(l<u){const{x1:P,y1:O,x2:V,y2:G,padding:$,projectedAnchorX:Y,projectedAnchorY:ne,projectedAnchorZ:Te,tileAnchorX:Ae,tileAnchorY:Ce,featureIndex:qe}=e.get(l);L.verticalTextBox={x1:P,y1:O,x2:V,y2:G,padding:$,projectedAnchorX:Y,projectedAnchorY:ne,projectedAnchorZ:Te,tileAnchorX:Ae,tileAnchorY:Ce},L.verticalTextFeatureIndex=qe}if(d<x){const{x1:P,y1:O,x2:V,y2:G,padding:$,projectedAnchorX:Y,projectedAnchorY:ne,projectedAnchorZ:Te,tileAnchorX:Ae,tileAnchorY:Ce,featureIndex:qe}=e.get(d);L.iconBox={x1:P,y1:O,x2:V,y2:G,padding:$,projectedAnchorX:Y,projectedAnchorY:ne,projectedAnchorZ:Te,tileAnchorX:Ae,tileAnchorY:Ce},L.iconFeatureIndex=qe}if(v<S){const{x1:P,y1:O,x2:V,y2:G,padding:$,projectedAnchorX:Y,projectedAnchorY:ne,projectedAnchorZ:Te,tileAnchorX:Ae,tileAnchorY:Ce,featureIndex:qe}=e.get(v);L.verticalIconBox={x1:P,y1:O,x2:V,y2:G,padding:$,projectedAnchorX:Y,projectedAnchorY:ne,projectedAnchorZ:Te,tileAnchorX:Ae,tileAnchorY:Ce},L.verticalIconFeatureIndex=qe}return L}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let n=0;n<this.symbolInstances.length;n++){const a=this.symbolInstances.get(n);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,a.textBoxStartIndex,a.textBoxEndIndex,a.verticalTextBoxStartIndex,a.verticalTextBoxEndIndex,a.iconBoxStartIndex,a.iconBoxEndIndex,a.verticalIconBoxStartIndex,a.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(e,n){const a=e.placedSymbolArray.get(n),l=a.vertexStartIndex+4*a.numGlyphs;for(let u=a.vertexStartIndex;u<l;u+=4)e.indexArray.emplaceBack(u,u+1,u+2),e.indexArray.emplaceBack(u+1,u+2,u+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const n=Math.sin(e),a=Math.cos(e),l=[],u=[],d=[];for(let x=0;x<this.symbolInstances.length;++x){d.push(x);const v=this.symbolInstances.get(x);l.push(0|Math.round(n*v.tileAnchorX+a*v.tileAnchorY)),u.push(v.featureIndex)}return d.sort((x,v)=>l[x]-l[v]||u[v]-u[x]),d}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let e=0;e<this.symbolInstances.length;++e)this.symbolInstanceIndexesSortedZOffset.push(e)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((e,n)=>this.symbolInstances.get(n).zOffset-this.symbolInstances.get(e).zOffset)}addToSortKeyRanges(e,n){const a=this.sortKeyRanges[this.sortKeyRanges.length-1];a&&a.sortKey===n?a.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:n,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const n of this.symbolInstanceIndexes){const a=this.symbolInstances.get(n);this.featureSortOrder.push(a.featureIndex);const{rightJustifiedTextSymbolIndex:l,centerJustifiedTextSymbolIndex:u,leftJustifiedTextSymbolIndex:d,verticalPlacedTextSymbolIndex:x,placedIconSymbolIndex:v,verticalPlacedIconSymbolIndex:S}=a;l>=0&&this.addIndicesForPlacedSymbol(this.text,l),u>=0&&u!==l&&this.addIndicesForPlacedSymbol(this.text,u),d>=0&&d!==u&&d!==l&&this.addIndicesForPlacedSymbol(this.text,d),x>=0&&this.addIndicesForPlacedSymbol(this.text,x),v>=0&&this.addIndicesForPlacedSymbol(this.icon,v),S>=0&&this.addIndicesForPlacedSymbol(this.icon,S)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}xe(Vm,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),Vm.addDynamicAttributes=Fy;class $c{constructor(e,n,a,l){this.context=e,this.format=a,this.texture=e.gl.createTexture(),this.update(n,l)}update(e,n,a){const{width:l,height:u}=e,{context:d}=this,{gl:x}=d;if(x.bindTexture(x.TEXTURE_2D,this.texture),d.pixelStoreUnpackFlipY.set(!1),d.pixelStoreUnpack.set(1),d.pixelStoreUnpackPremultiplyAlpha.set(this.format===x.RGBA&&(!n||n.premultiply!==!1)),this.useMipmap=!!(n&&n.useMipmap),a||this.size&&this.size[0]===l&&this.size[1]===u){const{x:v,y:S}=a||{x:0,y:0};if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap)x.texSubImage2D(x.TEXTURE_2D,0,v,S,x.RGBA,x.UNSIGNED_BYTE,e);else{let L=this.format,P=x.UNSIGNED_BYTE;this.format===x.R32F&&(L=x.RED,P=x.FLOAT),x.texSubImage2D(x.TEXTURE_2D,0,v,S,l,u,L,P,e.data)}}else if(this.size=[l,u],e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap){let v=this.format;this.format===x.R8&&(v=x.RED),x.texImage2D(x.TEXTURE_2D,0,this.format,v,x.UNSIGNED_BYTE,e)}else{let v=this.format,S=this.format,L=x.UNSIGNED_BYTE,P=!1;this.format===x.DEPTH_COMPONENT&&(v=x.DEPTH_COMPONENT16,L=x.UNSIGNED_SHORT),this.format===x.DEPTH_STENCIL&&(v=x.DEPTH24_STENCIL8,L=x.UNSIGNED_INT_24_8,P=!0),this.format===x.R8&&(S=x.RED),this.format===x.R32F&&(L=x.FLOAT,S=x.RED),!this.useMipmap&&P?x.texStorage2D(x.TEXTURE_2D,1,v,l,u):x.texImage2D(x.TEXTURE_2D,0,v,l,u,0,S,L,e.data)}this.useMipmap&&x.generateMipmap(x.TEXTURE_2D)}bind(e,n,a=!1){const{context:l}=this,{gl:u}=l;u.bindTexture(u.TEXTURE_2D,this.texture),e!==this.minFilter&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,e),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,this.useMipmap&&!a?e===u.NEAREST?u.NEAREST_MIPMAP_NEAREST:u.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),n!==this.wrapS&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,n),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,n),this.wrapS=n)}bindExtraParam(e,n,a,l){const{context:u}=this,{gl:d}=u;d.bindTexture(d.TEXTURE_2D,this.texture),n!==this.magFilter&&(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,n),this.magFilter=n),e!==this.minFilter&&(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,this.useMipmap?e===d.NEAREST?d.NEAREST_MIPMAP_NEAREST:d.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),a!==this.wrapS&&(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,a),this.wrapS=a),l!==this.wrapT&&(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,l),this.wrapT=l)}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class ky{constructor(e,n){this.context=e,this.texture=n}bind(e,n){const{context:a}=this,{gl:l}=a;l.bindTexture(l.TEXTURE_2D,this.texture),e!==this.minFilter&&(l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,e),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,e),this.minFilter=e),n!==this.wrapS&&(l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,n),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,n),this.wrapS=n)}}const Yc=32,_u=33,hp=new Uint16Array(8184);for(let t=0;t<2046;t++){let e=t+2,n=0,a=0,l=0,u=0,d=0,x=0;for(1&e?l=u=d=Yc:n=a=x=Yc;(e>>=1)>1;){const S=n+l>>1,L=a+u>>1;1&e?(l=n,u=a,n=d,a=x):(n=l,a=u,l=d,u=x),d=S,x=L}const v=4*t;hp[v+0]=n,hp[v+1]=a,hp[v+2]=l,hp[v+3]=u}const yu=new Uint16Array(2178),up=new Uint8Array(1089),By=new Uint16Array(1089);function aw(t){return t===0?-.03125:t===32?.03125:0}var Ny=rr([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]),S3=rr([{name:"a_index",type:"Int16",components:1}]);const lw={type:2,extent:ji,loadGeometry:()=>[[new Kt(0,0),new Kt(ji+1,0),new Kt(ji+1,ji+1),new Kt(0,ji+1),new Kt(0,0)]]};class Uy{constructor(e,n,a,l,u){this.tileID=e,this.uid=Xs(),this.uses=0,this.tileSize=n,this.tileZoom=a,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=u,l&&l.style&&(this._lastUpdatedBrightness=l.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",l&&l.transform&&(this.projection=l.transform.projection)}registerFadeDuration(e){const n=e+this.timeAdded;n<mo.now()||this.fadeEndTime&&n<this.fadeEndTime||(this.fadeEndTime=n)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=lf(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(e,n,a){if(this.unloadVectorData(),this.state="loaded",e){e.featureIndex&&(this.latestFeatureIndex=e.featureIndex,e.rawTileData?(this.latestRawTileData=e.rawTileData,this.latestFeatureIndex.rawTileData=e.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=e.collisionBoxArray,this.buckets=function(l,u){const d={};if(!u)return d;for(const x of l){const v=x.layerIds.map(S=>u.getLayer(S)).filter(Boolean);if(v.length!==0){x.layers=v,x.stateDependentLayerIds&&(x.stateDependentLayers=x.stateDependentLayerIds.map(S=>v.filter(L=>L.id===S)[0]));for(const S of v)d[S.fqid]=x}}return d}(e.buckets,n.style),this.hasSymbolBuckets=!1;for(const l in this.buckets){const u=this.buckets[l];if(u instanceof Vm){if(this.hasSymbolBuckets=!0,!a)break;u.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const l in this.buckets){const u=this.buckets[l];if(u instanceof Vm&&u.hasRTLText){this.hasRTLText=!0,zr.isLoading()||zr.isLoaded()||er()!=="deferred"||xs();break}}this.queryPadding=0;for(const l in this.buckets){const u=this.buckets[l],d=n.style.getOwnLayer(l);if(!d)continue;const x=d.queryRadius(u);this.queryPadding=Math.max(this.queryPadding,x)}e.imageAtlas&&(this.imageAtlas=e.imageAtlas),e.glyphAtlasImage&&(this.glyphAtlasImage=e.glyphAtlasImage),e.lineAtlas&&(this.lineAtlas=e.lineAtlas),this._lastUpdatedBrightness=e.brightness}else this.collisionBoxArray=new mm}unloadVectorData(){if(this.hasData()){for(const e in this.buckets)this.buckets[e].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}getBucket(e){return this.buckets[e.fqid]}upload(e){for(const l in this.buckets){const u=this.buckets[l];u.uploadPending()&&u.upload(e)}const n=e.gl,a=this.imageAtlas;if(a&&!a.uploaded){const l=!!Object.keys(a.patternPositions).length;this.imageAtlasTexture=new $c(e,a.image,n.RGBA,{useMipmap:l}),this.imageAtlas.uploaded=!0}this.glyphAtlasImage&&(this.glyphAtlasTexture=new $c(e,this.glyphAtlasImage,n.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new $c(e,this.lineAtlas.image,n.R8),this.lineAtlas.uploaded=!0)}prepare(e,n,a){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(e,this.imageAtlasTexture,a),!n||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const l=n.style.getBrightness();(this._lastUpdatedBrightness||l)&&(this._lastUpdatedBrightness&&l&&Math.abs(this._lastUpdatedBrightness-l)<.001||(this._lastUpdatedBrightness=l,this.updateBuckets(void 0,n)))}queryRenderedFeatures(e,n,a,l,u,d,x,v){return this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)?this.latestFeatureIndex.query({tileResult:l,pixelPosMatrix:x,transform:d,params:u,tileTransform:this.tileTransform},e,n,a):{}}querySourceFeatures(e,n){const a=this.latestFeatureIndex;if(!a||!a.rawTileData)return;const l=a.loadVTLayers(),u=n?n.sourceLayer:"",d=l._geojsonTileLayer||l[u];if(!d)return;const x=io(n&&n.filter),{z:v,x:S,y:L}=this.tileID.canonical,P={z:v,x:S,y:L};for(let O=0;O<d.length;O++){const V=d.feature(O);if(x.needGeometry){const Y=gc(V,!0);if(!x.filter(new ir(this.tileID.overscaledZ),Y,this.tileID.canonical))continue}else if(!x.filter(new ir(this.tileID.overscaledZ),V))continue;const G=a.getId(V,u),$=new Lb(V,v,S,L,G);$.tile=P,e.push($)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}bucketsLoaded(){for(const e in this.buckets)if(this.buckets[e].uploadPending())return!1;return!0}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(e){const n=this.expirationTime;if(e.cacheControl){const a=Td(e.cacheControl);a["max-age"]&&(this.expirationTime=Date.now()+1e3*a["max-age"])}else e.expires&&(this.expirationTime=new Date(e.expires).getTime());if(this.expirationTime){const a=Date.now();let l=!1;if(this.expirationTime>a)l=!1;else if(n)if(this.expirationTime<n)l=!0;else{const u=this.expirationTime-n;u?this.expirationTime=a+Math.max(u,3e4):l=!0}else l=!0;l?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(e,n){this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData&&Object.keys(e).length!==0&&n&&this.updateBuckets(e,n)}updateBuckets(e,n){if(!this.latestFeatureIndex)return;const a=this.latestFeatureIndex.loadVTLayers(),l=n.style.listImages(),u=n.style.getBrightness();for(const d in this.buckets){if(!n.style.hasLayer(d))continue;const x=this.buckets[d],v=x.layers[0].sourceLayer||"_geojsonTileLayer",S=a[v];let L={};if(e&&(L=e[v],!S||!L||Object.keys(L).length===0))continue;if(x.update(L,S,l,this.imageAtlas&&this.imageAtlas.patternPositions||{},u),x instanceof by||x instanceof py){const O=n.style.getOwnSourceCache(x.layers[0].source);n._terrain&&n._terrain.enabled&&O&&x.programConfigurations.needsUpload&&n._terrain._clearRenderCacheForTile(O.id,this.tileID)}const P=n&&n.style&&n.style.getOwnLayer(d);P&&(this.queryPadding=Math.max(this.queryPadding,P.queryRadius(x)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<mo.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(e){this.symbolFadeHoldUntil=mo.now()+e}setTexture(e,n){const a=n.context,l=a.gl;this.texture=this.texture||n.getTileTexture(e.width),this.texture&&this.texture instanceof $c?this.texture.update(e,{useMipmap:!0}):(this.texture=new $c(a,e,l.RGBA,{useMipmap:!0}),this.texture.bind(l.LINEAR,l.CLAMP_TO_EDGE))}setDependencies(e,n){const a={};for(const l of n)a[l]=!0;this.dependencies[e]=a}hasDependency(e,n){for(const a of e){const l=this.dependencies[a];if(l){for(const u of n)if(l[u])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(e,n){if(!n||n.name==="mercator"||this._tileDebugBuffer)return;const a=Za(lw,this.tileID.canonical,this.tileTransform)[0],l=new Fl,u=new Da;for(let d=0;d<a.length;d++){const{x,y:v}=a[d];l.emplaceBack(x,v),u.emplaceBack(d)}u.emplaceBack(0),this._tileDebugIndexBuffer=e.createIndexBuffer(u),this._tileDebugBuffer=e.createVertexBuffer(l,Vi.members),this._tileDebugSegments=Ts.simpleSegment(0,0,l.length,u.length)}_makeTileBoundsBuffers(e,n){if(this._tileBoundsBuffer||!n||n.name==="mercator")return;const a=Za(lw,this.tileID.canonical,this.tileTransform)[0];let l,u;if(this.isRaster){const d=function(x,v){const S=lf(x,v),L=Math.pow(2,x.z);for(let Y=0;Y<_u;Y++)for(let ne=0;ne<_u;ne++){const Te=oa((x.x+(ne+aw(ne))/Yc)/L),Ae=Co((x.y+(Y+aw(Y))/Yc)/L),Ce=v.project(Te,Ae),qe=Y*_u+ne;yu[2*qe+0]=Math.round((Ce.x*S.scale-S.x)*ji),yu[2*qe+1]=Math.round((Ce.y*S.scale-S.y)*ji)}up.fill(0),By.fill(0);for(let Y=2045;Y>=0;Y--){const ne=4*Y,Te=hp[ne+0],Ae=hp[ne+1],Ce=hp[ne+2],qe=hp[ne+3],Ge=Te+Ce>>1,ot=Ae+qe>>1,dt=Ge+ot-Ae,Rt=ot+Te-Ge,$t=Ae*_u+Te,Vt=qe*_u+Ce,ai=ot*_u+Ge,Ci=Math.hypot((yu[2*$t+0]+yu[2*Vt+0])/2-yu[2*ai+0],(yu[2*$t+1]+yu[2*Vt+1])/2-yu[2*ai+1])>=16;up[ai]=up[ai]||(Ci?1:0),Y<1022&&(up[ai]=up[ai]||up[(Ae+Rt>>1)*_u+(Te+dt>>1)]||up[(qe+Rt>>1)*_u+(Ce+dt>>1)])}const P=new Sh,O=new no;let V=0;function G(Y,ne){const Te=ne*_u+Y;return By[Te]===0&&(P.emplaceBack(yu[2*Te+0],yu[2*Te+1],Y*ji/Yc,ne*ji/Yc),By[Te]=++V),By[Te]-1}function $(Y,ne,Te,Ae,Ce,qe){const Ge=Y+Te>>1,ot=ne+Ae>>1;if(Math.abs(Y-Ce)+Math.abs(ne-qe)>1&&up[ot*_u+Ge])$(Ce,qe,Y,ne,Ge,ot),$(Te,Ae,Ce,qe,Ge,ot);else{const dt=G(Y,ne),Rt=G(Te,Ae),$t=G(Ce,qe);O.emplaceBack(dt,Rt,$t)}}return $(0,0,Yc,Yc,Yc,0),$(Yc,Yc,0,0,0,Yc),{vertices:P,indices:O}}(this.tileID.canonical,n);l=d.vertices,u=d.indices}else{l=new Sh,u=new no;for(const{x,y:v}of a)l.emplaceBack(x,v,0,0);const d=fu(l.int16,void 0,4);for(let x=0;x<d.length;x+=3)u.emplaceBack(d[x],d[x+1],d[x+2])}this._tileBoundsBuffer=e.createVertexBuffer(l,Ny.members),this._tileBoundsIndexBuffer=e.createIndexBuffer(u),this._tileBoundsSegments=Ts.simpleSegment(0,0,l.length,u.length)}_makeGlobeTileDebugBuffers(e,n){const a=n.projection;if(!a||a.name!=="globe"||n.freezeTileCoverage)return;const l=this.tileID.canonical,u=pt(wt(l,n)),d=Hn(n.zoom);let x;d>0&&(x=s.ad.invert(new Float64Array(16),n.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(e,l,n,u,x,d),this._makeGlobeTileDebugTextBuffer(e,l,n,u,x,d)}_globePoint(e,n,a,l,u,d,x){let v=An(e,n,a);if(d){const S=1<<a.z,L=mc(l.center.lng),P=sa(l.center.lat),O=(a.x+.5)/S-L;let V=0;O>.5?V=-1:O<-.5&&(V=1);let G=(e/ji+a.x)/S+V,$=(n/ji+a.y)/S;G=(G-L)*l._pixelsPerMercatorPixel+L,$=($-P)*l._pixelsPerMercatorPixel+P;const Y=[G*l.worldSize,$*l.worldSize,0];s._.transformMat4(Y,Y,d),v=mn(v,Y,x)}return s._.transformMat4(v,v,u)}_makeGlobeTileDebugBorderBuffer(e,n,a,l,u,d){const x=new Fl,v=new Da,S=new $d,L=(O,V,G,$,Y)=>{const ne=(G-O)/(Y-1),Te=($-V)/(Y-1),Ae=x.length;for(let Ce=0;Ce<Y;Ce++){const qe=O+Ce*ne,Ge=V+Ce*Te;x.emplaceBack(qe,Ge);const ot=this._globePoint(qe,Ge,n,a,l,u,d);S.emplaceBack(ot[0],ot[1],ot[2]),v.emplaceBack(Ae+Ce)}},P=ji;L(0,0,P,0,16),L(P,0,P,P,16),L(P,P,0,P,16),L(0,P,0,0,16),this._tileDebugIndexBuffer=e.createIndexBuffer(v),this._tileDebugBuffer=e.createVertexBuffer(x,Vi.members),this._globeTileDebugBorderBuffer=e.createVertexBuffer(S,gn.members),this._tileDebugSegments=Ts.simpleSegment(0,0,x.length,v.length)}_makeGlobeTileDebugTextBuffer(e,n,a,l,u,d){const x=ji/4,v=new Fl,S=new no,L=new $d,P=25;S.reserve(32),v.reserve(P),L.reserve(P);const O=(V,G)=>P*V+G;for(let V=0;V<P;V++){const G=V*x;for(let $=0;$<P;$++){const Y=$*x;v.emplaceBack(Y,G);const ne=this._globePoint(Y,G,n,a,l,u,d);L.emplaceBack(ne[0],ne[1],ne[2])}}for(let V=0;V<4;V++)for(let G=0;G<4;G++){const $=O(V,G),Y=O(V,G+1),ne=O(V+1,G),Te=O(V+1,G+1);S.emplaceBack($,Y,ne),S.emplaceBack(ne,Y,Te)}this._tileDebugTextIndexBuffer=e.createIndexBuffer(S),this._tileDebugTextBuffer=e.createVertexBuffer(v,Vi.members),this._globeTileDebugTextBuffer=e.createVertexBuffer(L,gn.members),this._tileDebugTextSegments=Ts.simpleSegment(0,0,P,32)}destroy(e=!1){for(const n in this.buckets)this.buckets[n].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!e&&this.texture&&this.texture instanceof $c&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}function E3(t,e,n){t===1?e.header_length=n.readFixed32():t===2?e.x=n.readVarint():t===3?e.y=n.readVarint():t===4?e.z=n.readVarint():t===5&&e.layers.push(function(a,l){return a.readFields(P3,{version:0,name:"",units:"",tilesize:0,buffer:0,pixel_format:0,data_index:[]},l)}(n,n.readVarint()+n.pos))}function A3(t,e,n){t===1?(e.delta_filter=function(a,l){return a.readFields(C3,{block_size:0},l)}(n,n.readVarint()+n.pos),e.filter="delta_filter"):t===2?(n.readVarint(),e.filter="zigzag_filter"):t===3?(n.readVarint(),e.filter="bitshuffle_filter"):t===4&&(n.readVarint(),e.filter="byteshuffle_filter")}function C3(t,e,n){t===1&&(e.block_size=n.readVarint())}function L3(t,e,n){t===1?(n.readVarint(),e.codec="gzip_data"):t===2?(n.readVarint(),e.codec="jpeg_image"):t===3?(n.readVarint(),e.codec="webp_image"):t===4&&(n.readVarint(),e.codec="png_image")}function I3(t,e,n){t===1?e.first_byte=n.readFixed64():t===2?e.last_byte=n.readFixed64():t===3?e.filters.push(function(a,l){return a.readFields(A3,{},l)}(n,n.readVarint()+n.pos)):t===4?e.codec=function(a,l){return a.readFields(L3,{},l)}(n,n.readVarint()+n.pos):t===5?e.offset=n.readFloat():t===6?e.scale=n.readFloat():t===7&&e.bands.push(n.readString())}function P3(t,e,n){t===1?e.version=n.readVarint():t===2?e.name=n.readString():t===3?e.units=n.readString():t===4?e.tilesize=n.readVarint():t===5?e.buffer=n.readVarint():t===6?e.pixel_format=n.readVarint():t===7&&e.data_index.push(function(a,l){return a.readFields(I3,{first_byte:0,last_byte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},l)}(n,n.readVarint()+n.pos))}function R3(t,e,n){if(t===2)(function(a,l,u){a.readFields(D3,u,l)})(n,n.readVarint()+n.pos,e);else if(t===3)throw new Error("Not implemented")}function D3(t,e,n){if(t===1){let a=0;const l=n.readVarint()+n.pos;for(;n.pos<l;)e[a++]=n.readVarint()}}/**
 * tiny-lru
 *
 * @copyright 2024 Jason Mulligan <jason.mulligan@avoidwork.com>
 * @license BSD-3-Clause
 * @version 11.2.11
 */class z3{constructor(e=0,n=0,a=!1){this.first=null,this.items=Object.create(null),this.last=null,this.max=e,this.resetTtl=a,this.size=0,this.ttl=n}clear(){return this.first=null,this.items=Object.create(null),this.last=null,this.size=0,this}delete(e){if(this.has(e)){const n=this.items[e];delete this.items[e],this.size--,n.prev!==null&&(n.prev.next=n.next),n.next!==null&&(n.next.prev=n.prev),this.first===n&&(this.first=n.next),this.last===n&&(this.last=n.prev)}return this}entries(e=this.keys()){return e.map(n=>[n,this.get(n)])}evict(e=!1){if(e||this.size>0){const n=this.first;delete this.items[n.key],--this.size==0?(this.first=null,this.last=null):(this.first=n.next,this.first.prev=null)}return this}expiresAt(e){let n;return this.has(e)&&(n=this.items[e].expiry),n}get(e){let n;if(this.has(e)){const a=this.items[e];this.ttl>0&&a.expiry<=Date.now()?this.delete(e):(n=a.value,this.set(e,n,!0))}return n}has(e){return e in this.items}keys(){const e=[];let n=this.first;for(;n!==null;)e.push(n.key),n=n.next;return e}set(e,n,a=!1,l=this.resetTtl){let u;if(a||this.has(e)){if(u=this.items[e],u.value=n,a===!1&&l&&(u.expiry=this.ttl>0?Date.now()+this.ttl:this.ttl),this.last!==u){const d=this.last,x=u.next,v=u.prev;this.first===u&&(this.first=u.next),u.next=null,u.prev=this.last,d.next=u,v!==null&&(v.next=x),x!==null&&(x.prev=v)}}else this.max>0&&this.size===this.max&&this.evict(!0),u=this.items[e]={expiry:this.ttl>0?Date.now()+this.ttl:this.ttl,key:e,prev:this.last,next:null,value:n},++this.size==1?this.first=u:this.last.next=u;return this.last=u,this}values(e=this.keys()){return e.map(n=>this.get(n))}}function O3(t,e){if(e.length!==4)throw new Error(`Expected data of dimension 4 but got ${e.length}.`);let n=e[3];for(let a=2;a>=1;a--){const l=a===1?1:0,u=a===2?1:0;for(let d=0;d<e[0];d++){const x=e[1]*d;for(let v=l;v<e[1];v++){const S=e[2]*(v+x);for(let L=u;L<e[2];L++){const P=e[3]*(L+S);for(let O=0;O<e[3];O++){const V=P+O;t[V]+=t[V-n]}}}}n*=e[a]}return t}function F3(t){for(let e=0,n=t.length;e<n;e++)t[e]=t[e]>>>1^-(1&t[e]);return t}function k3(t,e){switch(e){case"uint32":return t;case"uint16":for(let n=0;n<t.length;n+=2){const a=t[n],l=t[n+1];t[n]=(240&a)>>4|(61440&a)>>8|(240&l)<<4|61440&l,t[n+1]=15&a|(3840&a)>>4|(15&l)<<8|(3840&l)<<4}return t;case"uint8":for(let n=0;n<t.length;n+=4){const a=t[n],l=t[n+1],u=t[n+2],d=t[n+3];t[n+0]=(192&a)>>6|(192&l)>>4|(192&u)>>2|192&d,t[n+1]=(48&a)>>4|(48&l)>>2|48&u|(48&d)<<2,t[n+2]=(12&a)>>2|12&l|(12&u)<<2|(12&d)<<4,t[n+3]=3&a|(3&l)<<2|(3&u)<<4|(3&d)<<6}return t;default:throw new Error(`Invalid pixel format, "${e}"`)}}class dp extends Error{constructor(e){super(e),this.name="MRTError"}}var yc=Uint8Array,Qg=Uint16Array,B3=Int32Array,cw=new yc([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),hw=new yc([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),N3=new yc([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),uw=function(t,e){for(var n=new Qg(31),a=0;a<31;++a)n[a]=e+=1<<t[a-1];var l=new B3(n[30]);for(a=1;a<30;++a)for(var u=n[a];u<n[a+1];++u)l[u]=u-n[a]<<5|a;return{b:n,r:l}},dw=uw(cw,2),pw=dw.b,U3=dw.r;pw[28]=258,U3[258]=28;for(var V3=uw(hw,0).b,fw=new Qg(32768),fo=0;fo<32768;++fo){var Gm=(43690&fo)>>1|(21845&fo)<<1;fw[fo]=((65280&(Gm=(61680&(Gm=(52428&Gm)>>2|(13107&Gm)<<2))>>4|(3855&Gm)<<4))>>8|(255&Gm)<<8)>>1}var e_=function(t,e,n){for(var a=t.length,l=0,u=new Qg(e);l<a;++l)t[l]&&++u[t[l]-1];var d,x=new Qg(e);for(l=1;l<e;++l)x[l]=x[l-1]+u[l-1]<<1;{d=new Qg(1<<e);var v=15-e;for(l=0;l<a;++l)if(t[l])for(var S=l<<4|t[l],L=e-t[l],P=x[t[l]-1]++<<L,O=P|(1<<L)-1;P<=O;++P)d[fw[P]>>v]=S}return d},t_=new yc(288);for(fo=0;fo<144;++fo)t_[fo]=8;for(fo=144;fo<256;++fo)t_[fo]=9;for(fo=256;fo<280;++fo)t_[fo]=7;for(fo=280;fo<288;++fo)t_[fo]=8;var mw=new yc(32);for(fo=0;fo<32;++fo)mw[fo]=5;var G3=e_(t_,9),H3=e_(mw,5),mx=function(t){for(var e=t[0],n=1;n<t.length;++n)t[n]>e&&(e=t[n]);return e},Fh=function(t,e,n){var a=e/8|0;return(t[a]|t[a+1]<<8)>>(7&e)&n},gx=function(t,e){var n=e/8|0;return(t[n]|t[n+1]<<8|t[n+2]<<16)>>(7&e)},j3=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],kh=function(t,e,n){var a=new Error(e||j3[t]);if(a.code=t,Error.captureStackTrace&&Error.captureStackTrace(a,kh),!n)throw a;return a},W3=new yc(0),q3=typeof TextDecoder<"u"&&new TextDecoder;try{q3.decode(W3,{stream:!0})}catch{}const Z3={gzip_data:"gzip"},X3={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},$3={uint32:1,uint16:2,uint8:4},Y3={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};class _x{constructor(e=1){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=e}getLayer(e){return this.layers[e]}getHeaderLength(e){const n=new Uint8Array(e),a=new DataView(e);if(n[0]!==13)throw new dp("File is not a valid MRT.");return a.getUint32(1,!0)}parseHeader(e){const n=new Uint8Array(e),a=this.getHeaderLength(e);if(n.length<a)throw new dp(`Expected header with length >= ${a} but got buffer of length ${n.length}`);const l=function(u,d){return u.readFields(E3,{header_length:0,x:0,y:0,z:0,layers:[]},void 0)}(new zm(n.subarray(0,a)));if(!isNaN(this.x)&&(this.x!==l.x||this.y!==l.y||this.z!==l.z))throw new dp(`Invalid attempt to parse header ${l.z}/${l.x}/${l.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=l.x,this.y=l.y,this.z=l.z;for(const u of l.layers)this.layers[u.name]=new J3(u,{cacheSize:this._cacheSize});return this}createDecodingTask(e){const n=[],a=this.getLayer(e.layerName);for(let l=0;l<a.dataIndex.length;l++){const u=a.dataIndex[l],d=u.first_byte-e.firstByte,x=u.last_byte+1-e.firstByte;if(l<e.firstBlock||l>e.lastBlock||a._blocksInProgress.has(l))continue;const v={layerName:a.name,firstByte:d,lastByte:x,pixelFormat:a.pixelFormat,blockIndex:l,blockShape:[u.bands.length].concat(a.bandShape),buffer:a.buffer,codec:u.codec.codec,filters:u.filters.map(S=>S.filter)};a._blocksInProgress.add(l),n.push(v)}return new gw(n,()=>{n.forEach(l=>a._blocksInProgress.delete(l.blockIndex))},(l,u)=>{if(n.forEach(d=>a._blocksInProgress.delete(d.blockIndex)),l)throw l;u.forEach(d=>{this.getLayer(d.layerName).processDecodedData(d)})})}}class J3{constructor({version:e,name:n,units:a,tilesize:l,pixel_format:u,buffer:d,data_index:x},v){if(this.version=e,this.version!==1)throw new dp(`Cannot parse raster layer encoded with MRT version ${e}`);this.name=n,this.units=a,this.tileSize=l,this.buffer=d,this.pixelFormat=X3[u],this.dataIndex=x,this.bandShape=[l+2*d,l+2*d,$3[this.pixelFormat]],this._decodedBlocks=function(S=1e3,L=0,P=!1){if(isNaN(S)||S<0)throw new TypeError("Invalid max value");if(isNaN(L)||L<0)throw new TypeError("Invalid ttl value");if(typeof P!="boolean")throw new TypeError("Invalid resetTtl value");return new z3(S,L,P)}(v?v.cacheSize:5),this._blocksInProgress=new Set}processDecodedData(e){const n=e.blockIndex.toString();this._decodedBlocks.get(n)||this._decodedBlocks.set(n,e.data)}getBlockForBand(e){let n=0;switch(typeof e){case"string":for(const[a,l]of this.dataIndex.entries()){for(const[u,d]of l.bands.entries())if(d===e)return{bandIndex:n+u,blockIndex:a,blockBandIndex:u};n+=l.bands.length}break;case"number":for(const[a,l]of this.dataIndex.entries()){if(e>=n&&e<n+l.bands.length)return{bandIndex:e,blockIndex:a,blockBandIndex:e-n};n+=l.bands.length}break;default:throw new dp(`Invalid band \`${JSON.stringify(e)}\`. Expected string or integer.`)}throw new dp(`Band not found: ${JSON.stringify(e)}`)}getDataRange(e){let n=1/0,a=-1/0,l=1/0,u=-1/0;for(const d of e){const{blockIndex:x}=this.getBlockForBand(d);if(x<0)throw new dp(`Invalid band: ${JSON.stringify(d)}`);const v=this.dataIndex[x];l=Math.min(l,x),u=Math.max(u,x),n=Math.min(n,v.first_byte),a=Math.max(a,v.last_byte)}return{layerName:this.name,firstByte:n,lastByte:a,firstBlock:l,lastBlock:u}}hasBand(e){const{blockIndex:n}=this.getBlockForBand(e);return n>=0}hasDataForBand(e){const{blockIndex:n}=this.getBlockForBand(e);return n>=0&&!!this._decodedBlocks.get(n.toString())}getBandView(e){const{blockIndex:n,blockBandIndex:a}=this.getBlockForBand(e),l=this._decodedBlocks.get(n.toString());if(!l)throw new dp(`Data for band ${JSON.stringify(e)} of layer "${this.name}" not decoded.`);const u=this.dataIndex[n],d=this.bandShape.reduce((S,L)=>S*L,1),x=a*d,v=l.subarray(x,x+d);return{data:v,bytes:new Uint8Array(v.buffer).subarray(v.byteOffset,v.byteOffset+v.byteLength),tileSize:this.tileSize,buffer:this.buffer,offset:u.offset,scale:u.scale}}}class gw{constructor(e,n,a){this.tasks=e,this._onCancel=n,this._onComplete=a,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(e,n){this._finalized||(this._onComplete(e,n),this._finalized=!0)}}_x.performDecoding=function(t,e){return Promise.all(e.tasks.map(n=>{const{layerName:a,firstByte:l,lastByte:u,pixelFormat:d,blockShape:x,blockIndex:v,filters:S,codec:L}=n,P=new Uint8Array(t).subarray(l,u+1),O=new Uint32Array(x[0]*x[1]*x[2]);let V;if(L!=="gzip_data")throw new Error(`Unhandled codec: ${L}`);return V=function(G,$){if(!globalThis.DecompressionStream&&$==="gzip_data")return Promise.resolve(((Ae=function(Ge){Ge[0]==31&&Ge[1]==139&&Ge[2]==8||kh(6,"invalid gzip data");var ot=Ge[3],dt=10;4&ot&&(dt+=2+(Ge[10]|Ge[11]<<8));for(var Rt=(ot>>3&1)+(ot>>4&1);Rt>0;Rt-=!Ge[dt++]);return dt+(2&ot)}(Te=G))+8>Te.length&&kh(6,"invalid gzip data"),function(Ge,ot,dt,Rt){var $t=Ge.length;if(!$t||ot.f&&!ot.l)return dt||new yc(0);var Vt=!dt,ai=Vt||ot.i!=2,Ci=ot.i;Vt&&(dt=new yc(3*$t));var ti,bi,Yt=function(fp){var mp=dt.length;if(fp>mp){var ff=new yc(Math.max(2*mp,fp));ff.set(dt),dt=ff}},wi=ot.f||0,zi=ot.p||0,Si=ot.b||0,fn=ot.l,Ii=ot.d,Ui=ot.m,qn=ot.n,Fn=8*$t;do{if(!fn){wi=Fh(Ge,zi,1);var Rn=Fh(Ge,zi+1,3);if(zi+=3,!Rn){var Fi=Ge[($r=4+((zi+7)/8|0))-4]|Ge[$r-3]<<8,Zn=$r+Fi;if(Zn>$t){Ci&&kh(0);break}ai&&Yt(Si+Fi),dt.set(Ge.subarray($r,Zn),Si),ot.b=Si+=Fi,ot.p=zi=8*Zn,ot.f=wi;continue}if(Rn==1)fn=G3,Ii=H3,Ui=9,qn=5;else if(Rn==2){var Cr=Fh(Ge,zi,31)+257,or=Fh(Ge,zi+10,15)+4,Pr=Cr+Fh(Ge,zi+5,31)+1;zi+=14;for(var Lr=new yc(Pr),Fr=new yc(19),nr=0;nr<or;++nr)Fr[N3[nr]]=Fh(Ge,zi+3*nr,7);zi+=3*or;var bs=mx(Fr),_s=(1<<bs)-1,is=e_(Fr,bs);for(nr=0;nr<Pr;){var $r,ns=is[Fh(Ge,zi,_s)];if(zi+=15&ns,($r=ns>>4)<16)Lr[nr++]=$r;else{var Ps=0,Ss=0;for($r==16?(Ss=3+Fh(Ge,zi,3),zi+=2,Ps=Lr[nr-1]):$r==17?(Ss=3+Fh(Ge,zi,7),zi+=3):$r==18&&(Ss=11+Fh(Ge,zi,127),zi+=7);Ss--;)Lr[nr++]=Ps}}var Zs=Lr.subarray(0,Cr),Hs=Lr.subarray(Cr);Ui=mx(Zs),qn=mx(Hs),fn=e_(Zs,Ui),Ii=e_(Hs,qn)}else kh(1);if(zi>Fn){Ci&&kh(0);break}}ai&&Yt(Si+131072);for(var xa=(1<<Ui)-1,so=(1<<qn)-1,Vs=zi;;Vs=zi){var xo=(Ps=fn[gx(Ge,zi)&xa])>>4;if((zi+=15&Ps)>Fn){Ci&&kh(0);break}if(Ps||kh(2),xo<256)dt[Si++]=xo;else{if(xo==256){Vs=zi,fn=null;break}var Qo=xo-254;xo>264&&(Qo=Fh(Ge,zi,(1<<(Ya=cw[nr=xo-257]))-1)+pw[nr],zi+=Ya);var ea=Ii[gx(Ge,zi)&so],Es=ea>>4;if(ea||kh(3),zi+=15&ea,Hs=V3[Es],Es>3){var Ya=hw[Es];Hs+=gx(Ge,zi)&(1<<Ya)-1,zi+=Ya}if(zi>Fn){Ci&&kh(0);break}ai&&Yt(Si+131072);var md=Si+Qo;if(Si<Hs){var Jc=0-Hs,Nh=Math.min(Hs,md);for(Jc+Si<0&&kh(3);Si<Nh;++Si)dt[Si]=(void 0)[Jc+Si]}for(;Si<md;++Si)dt[Si]=dt[Si-Hs]}}ot.l=fn,ot.p=Vs,ot.b=Si,ot.f=wi,fn&&(wi=1,ot.m=Ui,ot.d=Ii,ot.n=qn)}while(!wi);return Si!=dt.length&&Vt?(ti=dt,((bi=Si)==null||bi>ti.length)&&(bi=ti.length),new yc(ti.subarray(0,bi))):dt.subarray(0,Si)}(Te.subarray(Ae,-8),{i:2},new yc(((Y=Te)[(ne=Y.length)-4]|Y[ne-3]<<8|Y[ne-2]<<16|Y[ne-1]<<24)>>>0))));var Y,ne,Te,Ae;const Ce=Z3[$];if(!Ce)throw new Error(`Unhandled codec: ${$}`);const qe=new globalThis.DecompressionStream(Ce);return new Response(new Blob([G]).stream().pipeThrough(qe)).arrayBuffer().then(Ge=>new Uint8Array(Ge))}(P,L).then(G=>(function($,Y){$.readFields(R3,Y)}(new zm(G),O),new Y3[d](O.buffer))),V.then(G=>{for(let $=S.length-1;$>=0;$--)switch(S[$]){case"delta_filter":O3(G,x);break;case"zigzag_filter":F3(G);break;case"bitshuffle_filter":k3(G,d);break;default:throw new Error(`Unhandled filter "${S[$]}"`)}return{layerName:a,blockIndex:v,data:G}}).catch(G=>{throw G})}))};class _w extends Uy{constructor(e,n,a,l,u){super(e,n,a,l,u),this._workQueue=[],this._fetchQueue=[],this._isHeaderLoaded=!1}setTexture(e,n){const a=n.context,l=a.gl;this.texture=this.texture||n.getTileTexture(e.width),this.texture&&this.texture instanceof $c?this.texture.update(e,{useMipmap:!1,premultiply:!1}):this.texture=new $c(a,e,l.RGBA,{useMipmap:!1,premultiply:!1})}flushQueues(){for(;this._workQueue.length;)this._workQueue.pop()();for(;this._fetchQueue.length;)this._fetchQueue.pop()()}fetchHeader(e=16384,n){const a=this._mrt=new _x(30),l=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(e-1)}});return this.entireBuffer=null,this.request=ic(l,(u,d,x,v)=>{if(u)n(u);else try{const S=a.getHeaderLength(d);if(S>e)return void(this.request=this.fetchHeader(S,n));a.parseHeader(d),this._isHeaderLoaded=!0;let L=0;for(const P of Object.values(a.layers))L=Math.max(L,P.dataIndex[P.dataIndex.length-1].last_byte);d.byteLength>=L&&(this.entireBuffer=d),n(null,this.entireBuffer||d,x,v)}catch(S){n(S)}}),this.request}fetchBand(e,n,a){const l=this._mrt;if(!this._isHeaderLoaded||!l)return void a(new Error("Tile header is not ready"));const u=this.actor;if(!u)return void a(new Error("Can't fetch tile band without an actor"));let d;const x=(P,O)=>{d.complete(P,O),P?a(P):(this.updateTextureDescriptor(e,n),a(null,this.textureDescriptor&&this.textureDescriptor.img))},v=(P,O)=>{if(P)return a(P);const V=u.send("decodeRasterArray",{buffer:O,task:d},x,void 0,!0);this._workQueue.push(()=>{V&&V.cancel(),d.cancel()})},S=l.getLayer(e);if(!S)return void a(new Error(`Unknown sourceLayer "${e}"`));if(S.hasDataForBand(n))return this.updateTextureDescriptor(e,n),void a(null,this.textureDescriptor?this.textureDescriptor.img:null);const L=S.getDataRange([n]);if(d=l.createDecodingTask(L),!d||d.tasks.length)if(this.flushQueues(),this.entireBuffer)v(null,this.entireBuffer.slice(L.firstByte,L.lastByte+1));else{const P=Object.assign({},this.requestParams,{headers:{Range:`bytes=${L.firstByte}-${L.lastByte}`}}),O=ic(P,v);this._fetchQueue.push(()=>{O.cancel(),d.cancel()})}else a(null)}updateNeeded(e,n){return(!this.textureDescriptor||this.textureDescriptor.band!==n||this.textureDescriptor.layer!==e)&&this.state!=="errored"}updateTextureDescriptor(e,n){if(!this._mrt)return;const a=this._mrt.getLayer(e);if(!a||!a.hasBand(n)||!a.hasDataForBand(n))return;const{bytes:l,tileSize:u,buffer:d,offset:x,scale:v}=a.getBandView(n),S=u+2*d,L={data:l,width:S,height:S},P=this.texture;P&&P instanceof $c&&P.update(L,{useMipmap:!1,premultiply:!1}),this.textureDescriptor={layer:e,band:n,img:L,buffer:d,offset:x,tileSize:u,format:a.pixelFormat,mix:[v,256*v,65536*v,16777216*v]}}}class K3{constructor(e,n){this.max=e,this.onRemove=n,this.reset()}reset(){for(const e in this.data)for(const n of this.data[e])n.timeout&&clearTimeout(n.timeout),this.onRemove(n.value);return this.data={},this.order=[],this}add(e,n,a){const l=e.wrapped().key;this.data[l]===void 0&&(this.data[l]=[]);const u={value:n,timeout:void 0};if(a!==void 0&&(u.timeout=setTimeout(()=>{this.remove(e,u)},a)),this.data[l].push(u),this.order.push(l),this.order.length>this.max){const d=this._getAndRemoveByKey(this.order[0]);d&&this.onRemove(d)}return this}has(e){return e.wrapped().key in this.data}getAndRemove(e){return this.has(e)?this._getAndRemoveByKey(e.wrapped().key):null}_getAndRemoveByKey(e){const n=this.data[e].shift();return n.timeout&&clearTimeout(n.timeout),this.data[e].length===0&&delete this.data[e],this.order.splice(this.order.indexOf(e),1),n.value}getByKey(e){const n=this.data[e];return n?n[0].value:null}get(e){return this.has(e)?this.data[e.wrapped().key][0].value:null}remove(e,n){if(!this.has(e))return this;const a=e.wrapped().key,l=n===void 0?0:this.data[a].indexOf(n),u=this.data[a][l];return this.data[a].splice(l,1),u.timeout&&clearTimeout(u.timeout),this.data[a].length===0&&delete this.data[a],this.onRemove(u.value),this.order.splice(this.order.indexOf(a),1),this}setMaxSize(e){for(this.max=e;this.order.length>this.max;){const n=this._getAndRemoveByKey(this.order[0]);n&&this.onRemove(n)}return this}filter(e){const n=[];for(const a in this.data)for(const l of this.data[a])e(l.value)||n.push(l);for(const a of n)this.remove(a.value.tileID,a)}}class hf extends oc{constructor(e,n,a){super(),this.id=e,this._onlySymbols=a,n.on("data",l=>{l.dataType==="source"&&l.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&l.dataType==="source"&&l.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),n.on("error",()=>{this._sourceErrored=!0}),this._source=n,this._tiles={},this._cache=new K3(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=n.minTileCacheSize,this._maxTileCacheSize=n.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new XC,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(e){this.map=e,this._minTileCacheSize=this._minTileCacheSize===void 0&&e?e._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&e?e._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const e in this._tiles){const n=this._tiles[e];if(n.state!=="errored"&&(n.state!=="loaded"||!n.bucketsLoaded()))return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const e=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,e&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(e,n){return e.isSymbolTile=this._onlySymbols,e.isExtraShadowCaster=this._shadowCasterTiles[e.tileID.key],this._source.loadTile(e,n)}_unloadTile(e){if(this._source.unloadTile)return this._source.unloadTile(e)}_abortTile(e){if(this._source.abortTile)return this._source.abortTile(e)}serialize(){return this._source.serialize()}prepare(e){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const n in this._tiles){const a=this._tiles[n];a.upload(e),a.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return ua(this._tiles).map(e=>e.tileID).sort(yw).map(e=>e.key)}getRenderableIds(e,n){const a=[];for(const l in this._tiles)this._isIdRenderable(+l,e,n)&&a.push(this._tiles[l]);return e?a.sort((l,u)=>{const d=l.tileID,x=u.tileID,v=new Kt(d.canonical.x,d.canonical.y)._rotate(this.transform.angle),S=new Kt(x.canonical.x,x.canonical.y)._rotate(this.transform.angle);return d.overscaledZ-x.overscaledZ||S.y-v.y||S.x-v.x}).map(l=>l.tileID.key):a.map(l=>l.tileID).sort(yw).map(l=>l.key)}hasRenderableParent(e){const n=this.findLoadedParent(e,0);return!!n&&this._isIdRenderable(n.tileID.key)}_isIdRenderable(e,n,a){return this._tiles[e]&&this._tiles[e].hasData()&&!this._coveredTiles[e]&&(n||!this._tiles[e].holdingForFade())&&(a||!this._shadowCasterTiles[e])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const e in this._tiles)this._tiles[e].state!=="errored"&&this._reloadTile(+e,"reloading")}}_reloadTile(e,n){const a=this._tiles[e];a&&(a.state!=="loading"&&(a.state=n),this._loadTile(a,this._tileLoaded.bind(this,a,e,n)))}_tileLoaded(e,n,a,l){if(l)if(e.state="errored",l.status!==404)this._source.fire(new Na(l,{tile:e}));else{if(!(e.tileID.key in this._loadedParentTiles))return void this._source.fire(new pa("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id}));if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const u=this.map.painter.terrain;this.update(this.transform,u.getScaledDemTileSize(),!0),u.resetTileLookupCache(this.id)}else this.update(this.transform)}else e.timeAdded=mo.now(),a==="expired"&&(e.refreshedUponExpiration=!0),this._setTileReloadTimer(n,e),this._source.type==="raster-dem"&&e.dem&&this._backfillDEM(e),this._state.initializeTileState(e,this.map?this.map.painter:null),this._source.fire(new pa("data",{dataType:"source",tile:e,coord:e.tileID,sourceCacheId:this.id}))}_backfillDEM(e){const n=this.getRenderableIds();for(let l=0;l<n.length;l++){const u=n[l];if(e.neighboringTiles&&e.neighboringTiles[u]){const d=this.getTileByID(u);a(e,d),a(d,e)}}function a(l,u){if(!l.dem||l.dem.borderReady)return;l.needsHillshadePrepare=!0,l.needsDEMTextureUpload=!0;let d=u.tileID.canonical.x-l.tileID.canonical.x;const x=u.tileID.canonical.y-l.tileID.canonical.y,v=Math.pow(2,l.tileID.canonical.z),S=u.tileID.key;d===0&&x===0||Math.abs(x)>1||(Math.abs(d)>1&&(Math.abs(d+v)===1?d+=v:Math.abs(d-v)===1&&(d-=v)),u.dem&&l.dem&&(l.dem.backfillBorder(u.dem,d,x),l.neighboringTiles&&l.neighboringTiles[S]&&(l.neighboringTiles[S].backfilled=!0)))}}getTile(e){return this.getTileByID(e.key)}getTileByID(e){return this._tiles[e]}_retainLoadedChildren(e,n,a,l){for(const u in this._tiles){let d=this._tiles[u];if(l[u]||!d.hasData()||d.tileID.overscaledZ<=n||d.tileID.overscaledZ>a)continue;let x=d.tileID;for(;d&&d.tileID.overscaledZ>n+1;){const S=d.tileID.scaledTo(d.tileID.overscaledZ-1);d=this._tiles[S.key],d&&d.hasData()&&(x=S)}let v=x;for(;v.overscaledZ>n;)if(v=v.scaledTo(v.overscaledZ-1),e[v.key]){l[x.key]=x;break}}}findLoadedParent(e,n){if(e.key in this._loadedParentTiles){const a=this._loadedParentTiles[e.key];return a&&a.tileID.overscaledZ>=n?a:null}for(let a=e.overscaledZ-1;a>=n;a--){const l=e.scaledTo(a),u=this._getLoadedTile(l);if(u)return u}}_getLoadedTile(e){const n=this._tiles[e.key];return n&&n.hasData()?n:this._cache.getByKey(this._source.reparseOverscaled?e.wrapped().key:e.canonical.key)}updateCacheSize(e,n){n=n||this._source.tileSize;const a=Math.ceil(e.width/n)+1,l=Math.ceil(e.height/n)+1,u=Math.floor(a*l*5),d=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,u):u,x=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,d):d;this._cache.setMaxSize(x)}handleWrapJump(e){const n=Math.round((e-(this._prevLng===void 0?e:this._prevLng))/360);if(this._prevLng=e,n){const a={};for(const l in this._tiles){const u=this._tiles[l];u.tileID=u.tileID.unwrapTo(u.tileID.wrap+n),a[u.tileID.key]=u}this._tiles=a;for(const l in this._timers)clearTimeout(this._timers[l]),delete this._timers[l];for(const l in this._tiles)this._setTileReloadTimer(+l,this._tiles[l])}}update(e,n,a,l){if(this.transform=e,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!a)return;let u;if(this.updateCacheSize(e,n),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={},this.used||this.usedForTerrain){if(this._source.tileID)u=e.getVisibleUnwrappedCoordinates(this._source.tileID).map(v=>new lo(v.canonical.z,v.wrap,v.canonical.z,v.canonical.x,v.canonical.y));else if(this.tileCoverLift!==0){const v=e.clone();v.tileCoverLift=this.tileCoverLift,u=v.coveringTiles({tileSize:n||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!a,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.minzoom<=1&&e.projection.name==="globe"&&(u.push(new lo(1,0,1,0,0)),u.push(new lo(1,0,1,1,0)),u.push(new lo(1,0,1,0,1)),u.push(new lo(1,0,1,1,1)))}else if(u=e.coveringTiles({tileSize:n||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!a,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.hasTile){const v=this._source.hasTile.bind(this._source);u=u.filter(S=>v(S))}}else u=[];if(u.length>0&&this.castsShadows&&l&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!yx(this._source.type)){const v=e.coveringZoomLevel({tileSize:n||this._source.tileSize,roundZoom:this._source.roundZoom&&!a}),S=Math.min(v,this._source.maxzoom),L=e.extendTileCoverForShadows(u,l,S);for(const P of L)this._shadowCasterTiles[P.key]=!0,u.push(P)}const d=this._updateRetainedTiles(u);if(yx(this._source.type)&&u.length!==0){const v={},S={},L=Object.keys(d);for(const O of L){const V=d[O],G=this._tiles[O];if(!G||G.fadeEndTime&&G.fadeEndTime<=mo.now())continue;const $=this.findLoadedParent(V,Math.max(V.overscaledZ-hf.maxOverzooming,this._source.minzoom));$&&(this._addTile($.tileID),v[$.tileID.key]=$.tileID),S[O]=V}const P=u[u.length-1].overscaledZ;for(const O in this._tiles){const V=this._tiles[O];if(d[O]||!V.hasData())continue;let G=V.tileID;for(;G.overscaledZ>P;){G=G.scaledTo(G.overscaledZ-1);const $=this._tiles[G.key];if($&&$.hasData()&&S[G.key]){d[O]=V.tileID;break}}}for(const O in v)d[O]||(this._coveredTiles[O]=!0,d[O]=v[O])}for(const v in d)this._tiles[v].clearFadeHold();const x=function(v,S){const L=[];for(const P in v)P in S||L.push(P);return L}(this._tiles,d);for(const v of x){const S=this._tiles[v];S.hasSymbolBuckets&&!S.holdingForFade()?S.setHoldDuration(this.map._fadeDuration):S.hasSymbolBuckets&&!S.symbolFadeFinished()||this._removeTile(+v)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const e in this._tiles)this._tiles[e].holdingForFade()&&this._removeTile(+e)}_updateRetainedTiles(e){const n={};if(e.length===0)return n;const a={},l=e.reduce((S,L)=>Math.min(S,L.overscaledZ),1/0),u=e[0].overscaledZ,d=Math.max(u-hf.maxOverzooming,this._source.minzoom),x=Math.max(u+hf.maxUnderzooming,this._source.minzoom),v={};for(const S of e){const L=this._addTile(S);n[S.key]=S,L.hasData()||l<this._source.maxzoom&&(v[S.key]=S)}this._retainLoadedChildren(v,l,x,n);for(const S of e){let L=this._tiles[S.key];if(L.hasData())continue;if(S.canonical.z>=this._source.maxzoom){const O=S.children(this._source.maxzoom)[0],V=this.getTile(O);if(V&&V.hasData()){n[O.key]=O;continue}}else{const O=S.children(this._source.maxzoom);if(n[O[0].key]&&n[O[1].key]&&n[O[2].key]&&n[O[3].key])continue}let P=L.wasRequested();for(let O=S.overscaledZ-1;O>=d;--O){const V=S.scaledTo(O);if(a[V.key]||(a[V.key]=!0,L=this.getTile(V),!L&&P&&(L=this._addTile(V)),L&&(n[V.key]=V,P=L.wasRequested(),L.hasData())))break}}return n}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const e in this._tiles){const n=[];let a,l=this._tiles[e].tileID;for(;l.overscaledZ>0;){if(l.key in this._loadedParentTiles){a=this._loadedParentTiles[l.key];break}n.push(l.key);const u=l.scaledTo(l.overscaledZ-1);if(a=this._getLoadedTile(u),a)break;l=u}for(const u of n)this._loadedParentTiles[u]=a}}_addTile(e){let n=this._tiles[e.key];if(n)return n.isExtraShadowCaster!==!0||this._shadowCasterTiles[e.key]||this._reloadTile(e.key,"reloading"),n;n=this._cache.getAndRemove(e),n&&(this._setTileReloadTimer(e.key,n),n.tileID=e,this._state.initializeTileState(n,this.map?this.map.painter:null),this._cacheTimers[e.key]&&(clearTimeout(this._cacheTimers[e.key]),delete this._cacheTimers[e.key],this._setTileReloadTimer(e.key,n)));const a=!!n;if(!a){const l=this.map?this.map.painter:null,u=this._source.tileSize*e.overscaleFactor();n=this._source.type==="raster-array"?new _w(e,u,this.transform.tileZoom,l,this._isRaster):new Uy(e,u,this.transform.tileZoom,l,this._isRaster),this._loadTile(n,this._tileLoaded.bind(this,n,e.key,n.state))}return n?(n.uses++,this._tiles[e.key]=n,a||this._source.fire(new pa("dataloading",{tile:n,coord:n.tileID,dataType:"source"})),n):null}_setTileReloadTimer(e,n){e in this._timers&&(clearTimeout(this._timers[e]),delete this._timers[e]);const a=n.getExpiryTimeout();a&&(this._timers[e]=setTimeout(()=>{this._reloadTile(e,"expired"),delete this._timers[e]},a))}_removeTile(e){const n=this._tiles[e];n&&(n.uses--,delete this._tiles[e],this._timers[e]&&(clearTimeout(this._timers[e]),delete this._timers[e]),n.uses>0||(n.hasData()&&n.state!=="reloading"||n.state==="empty"?this._cache.add(n.tileID,n,n.getExpiryTimeout()):(n.aborted=!0,this._abortTile(n),this._unloadTile(n))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const e in this._tiles)this._removeTile(+e);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(e,n,a){const l=[],u=this.transform;if(!u)return l;const d=u.projection.name==="globe",x=mc(u.center.lng);for(const v in this._tiles){const S=this._tiles[v];if(a&&S.clearQueryDebugViz(),S.holdingForFade())continue;let L;if(d){const P=S.tileID.canonical;if(P.z===0){const O=[Math.abs(pn(x,...i_(P,-1))-x),Math.abs(pn(x,...i_(P,1))-x)];L=[0,2*O.indexOf(Math.min(...O))-1]}else{const O=[Math.abs(pn(x,...i_(P,-1))-x),Math.abs(pn(x,...i_(P,0))-x),Math.abs(pn(x,...i_(P,1))-x)];L=[O.indexOf(Math.min(...O))-1]}}else L=[0];for(const P of L){const O=e.containsTile(S,u,n,P);O&&l.push(O)}}return l}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(e){return this._getRenderableCoordinates(e)}_getRenderableCoordinates(e,n){const a=this.getRenderableIds(e,n).map(u=>this._tiles[u].tileID),l=this.transform.projection.name==="globe";for(const u of a)u.projMatrix=this.transform.calculateProjMatrix(u.toUnwrapped()),u.expandedProjMatrix=l?this.transform.calculateProjMatrix(u.toUnwrapped(),!1,!0):u.projMatrix;return a}sortCoordinatesByDistance(e){const n=e.slice(),a=this.transform._camera.position,l=this.transform._camera.forward(),u={};for(const d of n){const x=1/(1<<d.canonical.z);u[d.key]=((d.canonical.x+.5)*x+d.wrap-a[0])*l[0]+((d.canonical.y+.5)*x-a[1])*l[1]-a[2]*l[2]}return n.sort((d,x)=>u[d.key]-u[x.key]),n}hasTransition(){if(this._source.hasTransition())return!0;if(yx(this._source.type))for(const e in this._tiles){const n=this._tiles[e];if(n.fadeEndTime!==void 0&&n.fadeEndTime>=mo.now())return!0}return!1}setFeatureState(e,n,a){this._state.updateState(e=e||"_geojsonTileLayer",n,a)}removeFeatureState(e,n,a){this._state.removeFeatureState(e=e||"_geojsonTileLayer",n,a)}getFeatureState(e,n){return this._state.getState(e=e||"_geojsonTileLayer",n)}setDependencies(e,n,a){const l=this._tiles[e];l&&l.setDependencies(n,a)}reloadTilesForDependencies(e,n){for(const a in this._tiles)this._tiles[a].hasDependency(e,n)&&this._reloadTile(+a,"reloading");this._cache.filter(a=>!a.hasDependency(e,n))}_preloadTiles(e,n){if(!this._sourceLoaded){const x=()=>{this._sourceLoaded&&(this._source.off("data",x),this._preloadTiles(e,n))};return void this._source.on("data",x)}const a=new Map,l=Array.isArray(e)?e:[e],u=this.map.painter.terrain,d=this.usedForTerrain&&u?u.getScaledDemTileSize():this._source.tileSize;for(const x of l){const v=x.coveringTiles({tileSize:d,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const S of v)a.set(S.key,S);this.usedForTerrain&&x.updateElevation(!1)}Ds(Array.from(a.values()),(x,v)=>{const S=new Uy(x,this._source.tileSize*x.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(S,L=>{this._source.type==="raster-dem"&&S.dem&&this._backfillDEM(S),v(L,S)})},n)}}function yw(t,e){const n=Math.abs(2*t.wrap)-+(t.wrap<0),a=Math.abs(2*e.wrap)-+(e.wrap<0);return t.overscaledZ-e.overscaledZ||a-n||e.canonical.y-t.canonical.y||e.canonical.x-t.canonical.x}function yx(t){return t==="raster"||t==="image"||t==="video"||t==="custom"}function i_(t,e){const n=1<<t.z;return[t.x/n+e,(t.x+1)/n+e]}hf.maxOverzooming=10,hf.maxUnderzooming=3;const xw=new class extends on{possiblyEvaluate(t,e){return e=new ir(Math.floor(e.zoom),{now:e.now,fadeDuration:e.fadeDuration,transition:e.transition}),super.possiblyEvaluate(t,e)}evaluate(t,e,n,a){return e=Ls({},e,{zoom:Math.floor(e.zoom)}),super.evaluate(t,e,n,a)}}(wy.paint.properties["line-width"].specification);function vw(t,e){return e>0?e+2*t:t}xw.useIntegerZoom=!0;const Q3=new Br({"symbol-placement":new oi(Pt.layout_symbol["symbol-placement"]),"symbol-spacing":new oi(Pt.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new oi(Pt.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new on(Pt.layout_symbol["symbol-sort-key"]),"symbol-z-order":new oi(Pt.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new oi(Pt.layout_symbol["symbol-z-elevate"]),"icon-allow-overlap":new oi(Pt.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new oi(Pt.layout_symbol["icon-ignore-placement"]),"icon-optional":new oi(Pt.layout_symbol["icon-optional"]),"icon-rotation-alignment":new oi(Pt.layout_symbol["icon-rotation-alignment"]),"icon-size":new on(Pt.layout_symbol["icon-size"]),"icon-text-fit":new on(Pt.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new on(Pt.layout_symbol["icon-text-fit-padding"]),"icon-image":new on(Pt.layout_symbol["icon-image"]),"icon-rotate":new on(Pt.layout_symbol["icon-rotate"]),"icon-padding":new oi(Pt.layout_symbol["icon-padding"]),"icon-keep-upright":new oi(Pt.layout_symbol["icon-keep-upright"]),"icon-offset":new on(Pt.layout_symbol["icon-offset"]),"icon-anchor":new on(Pt.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new oi(Pt.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new oi(Pt.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new oi(Pt.layout_symbol["text-rotation-alignment"]),"text-field":new on(Pt.layout_symbol["text-field"]),"text-font":new on(Pt.layout_symbol["text-font"]),"text-size":new on(Pt.layout_symbol["text-size"]),"text-max-width":new on(Pt.layout_symbol["text-max-width"]),"text-line-height":new on(Pt.layout_symbol["text-line-height"]),"text-letter-spacing":new on(Pt.layout_symbol["text-letter-spacing"]),"text-justify":new on(Pt.layout_symbol["text-justify"]),"text-radial-offset":new on(Pt.layout_symbol["text-radial-offset"]),"text-variable-anchor":new oi(Pt.layout_symbol["text-variable-anchor"]),"text-anchor":new on(Pt.layout_symbol["text-anchor"]),"text-max-angle":new oi(Pt.layout_symbol["text-max-angle"]),"text-writing-mode":new oi(Pt.layout_symbol["text-writing-mode"]),"text-rotate":new on(Pt.layout_symbol["text-rotate"]),"text-padding":new oi(Pt.layout_symbol["text-padding"]),"text-keep-upright":new oi(Pt.layout_symbol["text-keep-upright"]),"text-transform":new on(Pt.layout_symbol["text-transform"]),"text-offset":new on(Pt.layout_symbol["text-offset"]),"text-allow-overlap":new oi(Pt.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new oi(Pt.layout_symbol["text-ignore-placement"]),"text-optional":new oi(Pt.layout_symbol["text-optional"]),visibility:new oi(Pt.layout_symbol.visibility)});var xx={paint:new Br({"icon-opacity":new on(Pt.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new on(Pt.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new on(Pt.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new on(Pt.paint_symbol["text-emissive-strength"]),"icon-color":new on(Pt.paint_symbol["icon-color"]),"icon-halo-color":new on(Pt.paint_symbol["icon-halo-color"]),"icon-halo-width":new on(Pt.paint_symbol["icon-halo-width"]),"icon-halo-blur":new on(Pt.paint_symbol["icon-halo-blur"]),"icon-translate":new oi(Pt.paint_symbol["icon-translate"]),"icon-translate-anchor":new oi(Pt.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new on(Pt.paint_symbol["icon-image-cross-fade"]),"text-opacity":new on(Pt.paint_symbol["text-opacity"]),"text-occlusion-opacity":new on(Pt.paint_symbol["text-occlusion-opacity"]),"text-color":new on(Pt.paint_symbol["text-color"],{runtimeType:Ea,getOverride:t=>t.textColor,hasOverride:t=>!!t.textColor}),"text-halo-color":new on(Pt.paint_symbol["text-halo-color"]),"text-halo-width":new on(Pt.paint_symbol["text-halo-width"]),"text-halo-blur":new on(Pt.paint_symbol["text-halo-blur"]),"text-translate":new oi(Pt.paint_symbol["text-translate"]),"text-translate-anchor":new oi(Pt.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new oi(Pt.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new oi(Pt.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new oi(Pt.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new oi(Pt.paint_symbol["icon-color-brightness-max"])}),layout:Q3};class bw{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:ol,this.defaultValue=e}evaluate(e){if(e.formattedSection){const n=this.defaultValue.property.overrides;if(n&&n.hasOverride(e.formattedSection))return n.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}xe(bw,"FormatSectionOverride",{omit:["defaultValue"]});class Vy extends Ao{constructor(e,n,a,l){super(e,xx,n,a,l),this._colorAdjustmentMatrix=s.ad.identity([]),this.hasInitialOcclusionOpacityProperties=e.paint!==void 0&&("icon-occlusion-opacity"in e.paint||"text-occlusion-opacity"in e.paint)}recalculate(e,n){super.recalculate(e,n),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const a=this.layout.get("text-writing-mode");if(a){const l=[];for(const u of a)l.indexOf(u)<0&&l.push(u);this.layout._values["text-writing-mode"]=l}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(e,n,a,l){return this._saturation===e&&this._contrast===n&&this._brightnessMin===a&&this._brightnessMax===l||(this._colorAdjustmentMatrix=function(u,d,x,v){u=Kl(u),d=sh(d);const S=s.ad.create(),L=u/3,P=1-2*L,O=[P,L,L,0,L,P,L,0,L,L,P,0,0,0,0,1],V=.5-.5*d,G=v-x;return s.ad.multiply(S,[G,0,0,0,0,G,0,0,0,0,G,0,x,x,x,1],[d,0,0,0,0,d,0,0,0,0,d,0,V,V,V,1]),s.ad.multiply(S,S,O),S}(e,n,a,l),this._saturation=e,this._contrast=n,this._brightnessMin=a,this._brightnessMax=l),this._colorAdjustmentMatrix}getValueAndResolveTokens(e,n,a,l){const u=this.layout.get(e).evaluate(n,{},a,l),d=this._unevaluatedLayout._values[e];return d.isDataDriven()||ee(d.value)||!u?u:function(x,v){return v.replace(/{([^{}]+)}/g,(S,L)=>L in x?String(x[L]):"")}(n.properties,u)}createBucket(e){return new Vm(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const e of xx.paint.overridableProperties){if(!Vy.hasPaintOverride(this.layout,e))continue;const n=this.paint.get(e),a=new bw(n),l=new X(a,n.property.specification,this.scope,this.options);let u=null;u=n.value.kind==="constant"||n.value.kind==="source"?new ue("source",l):new pe("composite",l,n.value.zoomStops,n.value._interpolationType),this.paint._values[e]=new Ur(n.property,u,n.parameters)}}_handleOverridablePaintPropertyUpdate(e,n,a){return!(!this.layout||n.isDataDriven()||a.isDataDriven())&&Vy.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,n){const a=e.get("text-field"),l=xx.paint.properties[n];let u=!1;const d=x=>{for(const v of x)if(l.overrides&&l.overrides.hasOverride(v))return void(u=!0)};if(a.value.kind==="constant"&&a.value.value instanceof zo)d(a.value.value.sections);else if(a.value.kind==="source"){const x=S=>{u||(S instanceof ac&&Qs(S.value)===na?d(S.value.sections):S instanceof Uu?d(S.sections):S.eachChild(x))},v=a.value;v._styleExpression&&x(v._styleExpression.expression)}return u}getProgramIds(){const e=this.paint.get("icon-opacity").constantOr(1)!==0,n=this.paint.get("text-opacity").constantOr(1)!==0,a=[];return e&&a.push("symbolIcon"),n&&a.push("symbolSDF"),a}getDefaultProgramParams(e,n,a){return{config:new gl(this,{zoom:n,lut:a}),overrideFog:!1}}}const eL=new Br({visibility:new oi(Pt.layout_background.visibility)});var tL={paint:new Br({"background-color":new oi(Pt.paint_background["background-color"]),"background-pattern":new oi(Pt.paint_background["background-pattern"]),"background-opacity":new oi(Pt.paint_background["background-opacity"]),"background-emissive-strength":new oi(Pt.paint_background["background-emissive-strength"])}),layout:eL};const iL=new Br({visibility:new oi(Pt.layout_raster.visibility)});var nL={paint:new Br({"raster-opacity":new oi(Pt.paint_raster["raster-opacity"]),"raster-color":new Eo(Pt.paint_raster["raster-color"]),"raster-color-mix":new oi(Pt.paint_raster["raster-color-mix"]),"raster-color-range":new oi(Pt.paint_raster["raster-color-range"]),"raster-hue-rotate":new oi(Pt.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new oi(Pt.paint_raster["raster-brightness-min"]),"raster-brightness-max":new oi(Pt.paint_raster["raster-brightness-max"]),"raster-saturation":new oi(Pt.paint_raster["raster-saturation"]),"raster-contrast":new oi(Pt.paint_raster["raster-contrast"]),"raster-resampling":new oi(Pt.paint_raster["raster-resampling"]),"raster-fade-duration":new oi(Pt.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new oi(Pt.paint_raster["raster-emissive-strength"]),"raster-array-band":new oi(Pt.paint_raster["raster-array-band"]),"raster-elevation":new oi(Pt.paint_raster["raster-elevation"])}),layout:iL};function Gy(t,e,n,a,l,u,d,x){const v=[t,e,1,n,a,1,l,u,1],S=[d,x,1],L=s.bC.adjoint([],v),[P,O,V]=s._.transformMat3(S,S,L);return s.bC.multiply(v,v,[P,0,0,0,O,0,0,0,V])}function ww(t,e,n,a,l,u,d,x){const v=function(S,L,P,O,V,G,$,Y){const ne=Gy(0,0,1,0,1,1,0,1),Te=Gy(S,L,P,O,V,G,$,Y),Ae=s.bC.adjoint([],ne);return s.bC.multiply(Te,Te,Ae)}(t,e,n,a,l,u,d,x);return[v[2]/v[8]/ji,v[5]/v[8]/ji]}function Hy(t){return[t[0],Math.min(Math.max(t[1],-Js),Js)]}class Mw extends oc{constructor(e,n,a,l){super(),this.id=e,this.dispatcher=a,this.coordinates=n.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(l),this.options=n,this._dirty=!1}load(e,n){if(this._loaded=n||!1,this.fire(new pa("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return e&&(this.coordinates=e),this._loaded=!0,void this._finishLoading();this._imageRequest=Ta(this.map._requestManager.transformRequest(this.url,Ma.Image),(a,l)=>{this._imageRequest=null,this._loaded=!0,a?this.fire(new Na(a)):l&&(this.image=l instanceof HTMLImageElement?mo.getImageData(l):l,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading())})}loaded(){return this._loaded}updateImage(e){return e.url?(this._imageRequest&&e.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=e.url,this.load(e.coordinates,this._loaded),this):this}setTexture(e){if(!(e.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new ky(this.map.painter.context,e.handle),this.width=e.dimensions[0],this.height=e.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new pa("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(e){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof ky||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(e){if(this.coordinates=e,this._boundsArray=void 0,this._unsupportedCoords=!1,!e.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let n=e[0][1],a=e[0][1];for(const u of e)u[1]>a&&(a=u[1]),u[1]<n&&(n=u[1]);const l=(a+n)/2;if(l>Js?this.onNorthPole=!0:l<-Js&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const u=e.map(Lo.fromLngLat);this.tileID=function(d){let x=1/0,v=1/0,S=-1/0,L=-1/0;for(const $ of d)x=Math.min(x,$.x),v=Math.min(v,$.y),S=Math.max(S,$.x),L=Math.max(L,$.y);const P=Math.max(S-x,L-v),O=Math.max(0,Math.floor(-Math.log(P)/Math.LN2)),V=Math.pow(2,O);let G=Math.floor((x+S)/2*V);return G>1&&(G-=1),new uu(O,G,Math.floor((v+L)/2*V))}(u),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new pa("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(e){for(const Y in this.tiles){const ne=this.tiles[Y];ne.state!=="loaded"&&(ne.state="loaded",ne.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const n=lf(new uu(0,0,0),this.map.transform.projection),a=[n.projection.project(this.coordinates[0][0],this.coordinates[0][1]),n.projection.project(this.coordinates[1][0],this.coordinates[1][1]),n.projection.project(this.coordinates[2][0],this.coordinates[2][1]),n.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(Y){const ne=Y[1].x-Y[0].x,Te=Y[1].y-Y[0].y,Ae=Y[2].x-Y[1].x,Ce=Y[2].y-Y[1].y,qe=Y[3].x-Y[2].x,Ge=Y[3].y-Y[2].y,ot=Y[0].x-Y[3].x,dt=Y[0].y-Y[3].y,Rt=ne*Ce-Ae*Te,$t=Ae*Ge-qe*Ce,Vt=qe*dt-ot*Ge,ai=ot*Te-ne*dt;return Rt>0&&$t>0&&Vt>0&&ai>0||Rt<0&&$t<0&&Vt<0&&ai<0}(a))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const l=lf(this.tileID,this.map.transform.projection),[u,d,x,v]=this.coordinates.map(Y=>{const ne=l.projection.project(Y[0],Y[1]);return tw(l,ne)._round()});this.perspectiveTransform=ww(u.x,u.y,d.x,d.y,x.x,x.y,v.x,v.y);const S=this._boundsArray=new Sh;S.emplaceBack(u.x,u.y,0,0),S.emplaceBack(d.x,d.y,ji,0),S.emplaceBack(v.x,v.y,0,ji),S.emplaceBack(x.x,x.y,ji,ji),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=e.createVertexBuffer(S,Ny.members),this.boundsSegments=Ts.simpleSegment(0,0,4,2);const L=[],P=function(Y){return[Hy(Y[0]),Hy(Y[1]),Hy(Y[2]),Hy(Y[3])]}(this.coordinates),[O,V,G,$]=function(Y){let ne=Y[0][0],Te=ne,Ae=Y[0][1],Ce=Ae;for(let qe=1;qe<Y.length;qe++)Y[qe][0]<ne?ne=Y[qe][0]:Y[qe][0]>Te&&(Te=Y[qe][0]),Y[qe][1]<Ae?Ae=Y[qe][1]:Y[qe][1]>Ce&&(Ce=Y[qe][1]);return[ne,Ae,Te-ne,Ce-Ae]}(P);{const Y=new Sh,[ne,Te,Ae,Ce]=function(Yt){let wi=Yt[0].x,zi=wi,Si=Yt[0].y,fn=Si;for(let Ii=1;Ii<Yt.length;Ii++)Yt[Ii].x<wi?wi=Yt[Ii].x:Yt[Ii].x>zi&&(zi=Yt[Ii].x),Yt[Ii].y<Si?Si=Yt[Ii].y:Yt[Ii].y>fn&&(fn=Yt[Ii].y);return[wi,Si,zi-wi,fn-Si]}(a),qe=Yt=>[(Yt.x-ne)/Ae,(Yt.y-Te)/Ce],[Ge,ot,dt,Rt]=a.map(qe),$t=function(Yt,wi,zi,Si,fn,Ii,Ui,qn){const Fn=Gy(0,0,1,0,1,1,0,1),Rn=Gy(Yt,wi,zi,Si,fn,Ii,Ui,qn),Fi=s.bC.adjoint([],Rn);return s.bC.multiply(Fn,Fn,Fi)}(Ge[0],Ge[1],ot[0],ot[1],dt[0],dt[1],Rt[0],Rt[1]);this.elevatedGlobePerspectiveTransform=ww(Ge[0],Ge[1],ot[0],ot[1],dt[0],dt[1],Rt[0],Rt[1]);const Vt=(Yt,wi)=>{L.push(Yt.lng);const zi=Math.round((Yt.lng-O)/G*ji),Si=Math.round((Yt.lat-V)/$*ji),fn=qe(wi),Ii=s._.transformMat3([],[fn[0],fn[1],1],$t),Ui=Math.round(Ii[0]/Ii[2]*ji),qn=Math.round(Ii[1]/Ii[2]*ji);Y.emplaceBack(zi,Si,Ui,qn)},ai=a[3].x-a[0].x,Ci=a[3].y-a[0].y,ti=a[2].x-a[1].x,bi=a[2].y-a[1].y;for(let Yt=0;Yt<65;Yt++){const wi=Yt/64,zi=[a[0].x+wi*ai,a[0].y+wi*Ci],Si=[a[1].x+wi*ti,a[1].y+wi*bi],fn=Si[0]-zi[0],Ii=Si[1]-zi[1];for(let Ui=0;Ui<65;Ui++){const qn=Ui/64,Fn={x:zi[0]+fn*qn,y:zi[1]+Ii*qn,z:0};Vt(n.projection.unproject(Fn.x,Fn.y),Fn)}}this.elevatedGlobeVertexBuffer=e.createVertexBuffer(Y,Ny.members)}{this.maxLongitudeTriangleSize=0;let Y=[],ne=new no;const Te=(Ae,Ce,qe)=>{ne.emplaceBack(Ae,Ce,qe);const Ge=L[Ae],ot=L[Ce],dt=L[qe],Rt=Math.min(Math.min(Ge,ot),dt),$t=Math.max(Math.max(Ge,ot),dt)-Rt;$t>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=$t),Y.push(Rt+$t/2)};for(let Ae=0;Ae<64;Ae++)for(let Ce=0;Ce<64;Ce++){const qe=65*Ae+Ce,Ge=qe+1,ot=qe+65,dt=ot+1;Te(qe,ot,Ge),Te(Ge,ot,dt)}[Y,ne]=function(Ae,Ce){const qe=Array.from({length:Ae.length},(dt,Rt)=>Rt);qe.sort((dt,Rt)=>Ae[dt]-Ae[Rt]);const Ge=[],ot=new no;for(let dt=0;dt<qe.length;dt++){const Rt=qe[dt];Ge.push(Ae[Rt]);const $t=3*Rt,Vt=$t+1;ot.emplaceBack(Ce.uint16[$t],Ce.uint16[Vt],Ce.uint16[Vt+1])}return[Ge,ot]}(Y,ne),this.elevatedGlobeTrianglesCenterLongitudes=Y,this.elevatedGlobeIndexBuffer=e.createIndexBuffer(ne)}this.elevatedGlobeSegments=Ts.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,G/ji,0,$/ji,0,0,V,O,0])}prepare(){const e=Object.keys(this.tiles).length!==0;if(this.tileID&&!e)return;const n=this.map.painter.context,a=n.gl;!this._dirty||this.texture instanceof ky||(this.texture?this.texture.update(this.image):(this.texture=new $c(n,this.image,a.RGBA),this.texture.bind(a.LINEAR,a.CLAMP_TO_EDGE)),this._dirty=!1),e&&this._prepareData(n)}loadTile(e,n){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},n(null)):(e.state="errored",n(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(e){const n=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!n)return null;const a=this.elevatedGlobeTrianglesCenterLongitudes;let l=(u=e+180)+360*Math.round((a[0]-u)/360);var u;const d=new Ts,x=(P,O)=>{d.segments.push({vertexOffset:0,primitiveOffset:P,vertexLength:n.segments[0].vertexLength,primitiveLength:O,sortKey:void 0,vaos:{}})},v=.51*this.maxLongitudeTriangleSize;if(Math.abs(a[0]-l)<=v){const P=rh(a,0,a.length,l+v);return P===a.length||x(P,Cu(a,P+1,a.length,l+360-v)-P),d}l<a[0]&&(l+=360);const S=Cu(a,0,a.length,l-v);if(S===a.length)return x(0,a.length),d;x(0,S-0);const L=rh(a,S+1,a.length,l+v);return L!==a.length&&x(L,a.length-L),d}}const rL=(Math.pow(256,2)-1)/16907520;class Tw extends Ao{constructor(e,n,a,l){super(e,nL,n,a,l),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(e){return!(e&&e._source instanceof Mw&&(e._source.onNorthPole||e._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(e){e!=="raster-color"&&e!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}updateColorRamp(e){if(!this.hasColorMap()||!this._curRampRange)return;const n=this._transitionablePaint._values["raster-color"].value.expression,[a,l]=e||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(a)&&isNaN(l)||a===this._curRampRange[0]&&l===this._curRampRange[1]||(this.colorRamp=np({expression:n,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:a,end:l}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[a,l])}}const sL=new Br({visibility:new oi(Pt["layout_raster-particle"].visibility)});var oL={paint:new Br({"raster-particle-array-band":new oi(Pt["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new oi(Pt["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new Eo(Pt["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new oi(Pt["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new oi(Pt["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new oi(Pt["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new oi(Pt["paint_raster-particle"]["raster-particle-reset-rate-factor"])}),layout:sL};class Sw extends Ao{constructor(e,n,a,l){super(e,oL,n,a,l),this._updateColorRamp(),this.lastInvalidatedAt=mo.now()}onRemove(e){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isDraped(e){return!1}_handleSpecialPaintPropertyUpdate(e){e!=="raster-particle-color"&&e!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),e==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const e=this._transitionablePaint._values["raster-particle-color"].value.expression,n=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=np({expression:e,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:n}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=mo.now()}}class aL extends Ao{constructor(e,n){super(e,{},n,null),this.implementation=e,e.slot&&(this.slot=e.slot)}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isDraped(e){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}const lL=new Br({visibility:new oi(Pt.layout_sky.visibility)});var cL={paint:new Br({"sky-type":new oi(Pt.paint_sky["sky-type"]),"sky-atmosphere-sun":new oi(Pt.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new oi(Pt.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new oi(Pt.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new oi(Pt.paint_sky["sky-gradient-radius"]),"sky-gradient":new Eo(Pt.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new oi(Pt.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new oi(Pt.paint_sky["sky-atmosphere-color"]),"sky-opacity":new oi(Pt.paint_sky["sky-opacity"])}),layout:lL};function vx(t,e,n){const a=[0,0,1],l=s.av.identity([]);return s.av.rotateY(l,l,n?-Pn(t)+Math.PI:Pn(t)),s.av.rotateX(l,l,-Pn(e)),s._.transformQuat(a,a,l),s._.normalize(a,a)}var hL={paint:new Br({})};function Ew(t,e){const n=jy(t.projection,t.zoom,t.width,t.height),a=function(u,d,x,v,S){const L=new Gr(x.lng-180*pp,x.lat),P=new Gr(x.lng+180*pp,x.lat),O=u.project(L.lng,L.lat),V=u.project(P.lng,P.lat),G=-Math.atan2(V.y-O.y,V.x-O.x),$=Lo.fromLngLat(x);$.y=pn($.y,-1+pp,1-pp);const Y=$.toLngLat(),ne=u.project(Y.lng,Y.lat),Te=Lo.fromLngLat(Y);Te.x+=pp;const Ae=Te.toLngLat(),Ce=u.project(Ae.lng,Ae.lat),qe=Lw(Ce.x-ne.x,Ce.y-ne.y,G),Ge=Lo.fromLngLat(Y);Ge.y+=pp;const ot=Ge.toLngLat(),dt=u.project(ot.lng,ot.lat),Rt=Lw(dt.x-ne.x,dt.y-ne.y,G),$t=Math.abs(qe.x)/Math.abs(Rt.y),Vt=s.ad.identity([]);s.ad.rotateZ(Vt,Vt,-G*(1-(S?0:v)));const ai=s.ad.identity([]);return s.ad.scale(ai,ai,[1,1-(1-$t)*v,1]),ai[4]=-Rt.x/Rt.y*v,s.ad.rotateZ(ai,ai,G),s.ad.multiply(ai,Vt,ai),ai}(t.projection,0,t.center,n,e),l=Aw(t);return s.ad.scale(a,a,[l,l,1]),a}function Aw(t){const e=t.projection,n=jy(t.projection,t.zoom,t.width,t.height),a=Cw(e,t.center),l=Cw(e,Gr.convert(e.center));return Math.pow(2,a*n+(1-n)*l)}function jy(t,e,n,a,l=1/0){const u=t.range;if(!u)return 0;const d=Math.min(l,Math.max(n,a)),x=Math.log(d/1024)/Math.LN2;return Mo(u[0]+x,u[1]+x,e)}const pp=1/4e4;function Cw(t,e){const n=pn(e.lat,-Js,Js),a=new Gr(e.lng-180*pp,n),l=new Gr(e.lng+180*pp,n),u=t.project(a.lng,n),d=t.project(l.lng,n),x=Lo.fromLngLat(a),v=Lo.fromLngLat(l),S=d.x-u.x,L=d.y-u.y,P=v.x-x.x,O=v.y-x.y,V=Math.sqrt((P*P+O*O)/(S*S+L*L));return Math.log(V)/Math.LN2}function Lw(t,e,n){const a=Math.cos(n),l=Math.sin(n);return{x:t*a-e*l,y:t*l+e*a}}function Iw(t,e,n){s.ad.identity(t),s.ad.rotateZ(t,t,Pn(e[2])),s.ad.rotateX(t,t,Pn(e[0])),s.ad.rotateY(t,t,Pn(e[1])),s.ad.scale(t,t,n),s.ad.multiply(t,t,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function Wy(t,e,n,a,l,u,d,x){const v=[n[0]-e[0],n[1]-e[1],0],S=[a[0]-e[0],a[1]-e[1],0];if(s._.length(v)<1e-12||s._.length(S)<1e-12)return s.av.identity(t);const L=s._.cross([],v,S);s._.normalize(L,L),s._.subtract(S,a,e),v[2]=(u-l)*x,S[2]=(d-l)*x;const P=v;return s._.cross(P,v,S),s._.normalize(P,P),s.av.rotationTo(t,L,P)}function bx(t,e,n=!1){const a=Hn(e.zoom),l=function(u,d,x){const v=d.worldSize,S=[u[12],u[13],u[14]],L=Co(S[1]/v),P=oa(S[0]/v),O=s.ad.identity([]),V=Go(1,L)*v,G=Go(1,0)*v*du(L,d.zoom),$=1/nn(v);let Y=G*$;if(x){const Ce=jy(d.projection,d.zoom,d.width,d.height,1024);Y=$*d.projection.pixelSpaceConversion(d.center.lat,v,Ce)}const ne=us(L,P);s._.add(ne,ne,s._.scale([],s._.normalize([],ne),V*Y*S[2]));const Te=function(Ce){const qe=[Ce[0],Ce[1],Ce[2]];let Ge=[0,1,0];const ot=s._.cross([],Ge,qe);return s._.cross(Ge,qe,ot),s._.squaredLength(Ge)===0&&(Ge=[0,1,0],s._.cross(ot,qe,Ge)),s._.normalize(ot,ot),s._.normalize(Ge,Ge),s._.normalize(qe,qe),[ot[0],ot[1],ot[2],0,Ge[0],Ge[1],Ge[2],0,qe[0],qe[1],qe[2],0,Ce[0],Ce[1],Ce[2],1]}(ne);s.ad.scale(O,O,[Y,Y,Y*V]),s.ad.translate(O,O,[-S[0],-S[1],-S[2]]);const Ae=s.ad.multiply([],d.globeMatrix,Te);return s.ad.multiply(Ae,Ae,O),s.ad.multiply(Ae,Ae,u),Ae}(t,e,n);if(a>0){const u=function(d,x){const v=x.worldSize,S=Go(1,0)*v*du(x.center.lat,x.zoom)/nn(v),L=Go(1,x.center.lat)*v,P=s.ad.identity([]);return s.ad.rotateY(P,P,Pn(x.center.lng)),s.ad.rotateX(P,P,Pn(x.center.lat)),s.ad.translate(P,P,[0,0,_a]),s.ad.scale(P,P,[S,S,S*L]),s.ad.translate(P,P,[x.point.x-.5*v,x.point.y-.5*v,0]),s.ad.multiply(P,P,d),s.ad.multiply(P,x.globeMatrix,P)}(t,e);return function(d,x,v){const S=(G,$,Y)=>{const ne=s._.length(G),Te=s._.length($),Ae=mn(G,$,Y);return s._.scale(Ae,Ae,1/s._.length(Ae)*Qn(ne,Te,Y))},L=S([d[0],d[1],d[2]],[x[0],x[1],x[2]],v),P=S([d[4],d[5],d[6]],[x[4],x[5],x[6]],v),O=S([d[8],d[9],d[10]],[x[8],x[9],x[10]],v),V=mn([d[12],d[13],d[14]],[x[12],x[13],x[14]],v);return[L[0],L[1],L[2],0,P[0],P[1],P[2],0,O[0],O[1],O[2],0,V[0],V[1],V[2],1]}(l,u,a)}return l}function Pw(t,e,n,a){const l=Xt.projectAabbCorners(a,n);let u=Number.MAX_VALUE,d=-1;for(let S=0;S<l.length;++S){const L=l[S];L[0]=(.5*L[0]+.5)*e.width,L[1]=(.5-.5*L[1])*e.height,L[2]<u&&(d=S,u=L[2])}const x=S=>new Kt(l[S][0],l[S][1]);let v;switch(d){case 0:case 6:v=[x(1),x(5),x(4),x(7),x(3),x(2),x(1)];break;case 1:case 7:v=[x(0),x(4),x(5),x(6),x(2),x(3),x(0)];break;case 3:case 5:v=[x(1),x(0),x(4),x(7),x(6),x(2),x(1)];break;default:v=[x(1),x(5),x(6),x(7),x(3),x(0),x(1)]}if(kg(t,v))return u}const uL=rr([{name:"a_pos_3f",components:3,type:"Float32"}]),dL=rr([{name:"a_color_3f",components:3,type:"Float32"}]),pL=rr([{name:"a_color_4f",components:4,type:"Float32"}]),fL=rr([{name:"a_uv_2f",components:2,type:"Float32"}]),mL=rr([{name:"a_normal_3f",components:3,type:"Float32"}]),gL=rr([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),_L=rr([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);class qy{constructor(e,n,a,l){this.message=(e?`${e}: `:"")+a,l&&(this.identifier=l),n!=null&&n.__line__&&(this.line=n.__line__)}}function Rw(t,e){const n=t.indexOf("://")===-1;try{return new URL(t,n&&e?"http://example.com":void 0),!0}catch{return!1}}class Dw{constructor(e,n){this.feature=e,this.instancedDataOffset=n,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class zw{constructor(){this.instancedDataArray=new Yp,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class wx{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.projection=e.projection,this.index=e.index,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0}updateFootprints(e,n){}populate(e,n,a,l){this.tileToMeter=nf(a);const u=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:d,id:x,index:v,sourceLayerIndex:S}of e){const L=x??(d.properties&&d.properties.hasOwnProperty("id")?d.properties.id:void 0),P=gc(d,u);if(!this.layers[0]._featureFilter.filter(new ir(this.zoom),P,a))continue;const O={id:L,sourceLayerIndex:S,index:v,geometry:u?P.geometry:Za(d,a,l),properties:d.properties,type:d.type,patterns:{}},V=this.addFeature(O,O.geometry,P);V&&n.featureIndex.insert(d,O.geometry,v,S,this.index,this.instancesPerModel[V].instancedDataArray.length,ji/32)}this.lookup=null}update(e,n,a,l){for(const u in this.instancesPerModel){const d=this.instancesPerModel[u];for(const x in e)d.idToFeaturesIndex.hasOwnProperty(x)&&(this.evaluate(d.features[d.idToFeaturesIndex[x]],e[x],d,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let e=!1;for(const n in this.instancesPerModel){const a=this.instancesPerModel[n];for(const l of a.features){const u=this.layers[0],d=l.feature,x=this.canonical,v=u.paint.get("model-rotation").evaluate(d,{},x),S=u.paint.get("model-scale").evaluate(d,{},x),L=u.paint.get("model-translation").evaluate(d,{},x);s._.exactEquals(l.rotation,v)&&s._.exactEquals(l.scale,S)&&s._.exactEquals(l.translation,L)||(this.evaluate(l,l.featureStates,a,!0),e=!0)}}return e}updateReplacement(e,n,a){if(n.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=n.updateTime;const l=n.getReplacementRegionsForTile(e.toUnwrapped(),!0);if(Y0(this.activeReplacements,l))return!1;this.activeReplacements=l;let u=!1;for(const d in this.instancesPerModel){const x=this.instancesPerModel[d],v=x.instancedDataArray;for(const S of x.features){const L=S.instancedDataOffset,P=S.instancedDataCount;for(let O=0;O<P;O++){const V=16*(O+L);let G=v.float32[V+0];G=G>ji?G-ji:G;const $=Math.floor(G),Y=v.float32[V+1];let ne=!1;for(const Te of this.activeReplacements)if(!(Te.order<a||Te.order===1/0)&&Te.clipMask&J1.Model&&!(Te.min.x>$||$>Te.max.x||Te.min.y>Y||Y>Te.max.y)&&(ne=H1(G1($,Y,e.canonical,Te.footprintTileId.canonical),Te),ne))break;v.float32[V]=ne?G+ji:G,u=u||ne}}}return u}isEmpty(){for(const e in this.instancesPerModel)if(this.instancesPerModel[e].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(e){if(!this.uploaded)for(const n in this.instancesPerModel){const a=this.instancesPerModel[n];a.instancedDataArray.length<0||a.instancedDataArray.length===0||(a.instancedDataBuffer?a.instancedDataBuffer.updateData(a.instancedDataArray):a.instancedDataBuffer=e.createVertexBuffer(a.instancedDataArray,gL.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const n in this.instancesPerModel){const a=this.instancesPerModel[n];a.instancedDataArray.length!==0&&a.instancedDataBuffer&&a.instancedDataBuffer.destroy()}const e=this.layers[0].modelManager;if(e&&this.modelUris)for(const n of this.modelUris)e.removeModel(n,"")}addFeature(e,n,a){const l=this.layers[0],u=l.layout.get("model-id").evaluate(a,{},this.canonical);if(!u)return Is(`modelId is not evaluated for layer ${l.id} and it is not going to get rendered.`),u;Rw(u,!1)&&(this.modelUris.includes(u)||this.modelUris.push(u)),this.instancesPerModel[u]||(this.instancesPerModel[u]=new zw);const d=this.instancesPerModel[u],x=d.instancedDataArray,v=new Dw(a,x.length);for(const S of n)for(const L of S){if(L.x<0||L.x>=ji||L.y<0||L.y>=ji)continue;const P=(this.lookupDim-1)/ji,O=this.lookupDim*(L.y*P|0)+L.x*P|0;if(this.lookup){if(this.lookup[O]!==0)continue;this.lookup[O]=1}this.instanceCount++;const V=x.length;x.resize(V+1),d.instancesEvaluatedElevation.push(0),x.float32[16*V]=L.x,x.float32[16*V+1]=L.y}return v.instancedDataCount=d.instancedDataArray.length-v.instancedDataOffset,v.instancedDataCount>0&&(e.id&&(d.idToFeaturesIndex[e.id]=d.features.length),d.features.push(v),this.evaluate(v,{},d,!1)),u}getModelUris(){return this.modelUris}evaluate(e,n,a,l){const u=this.layers[0],d=e.feature,x=this.canonical,v=e.rotation=u.paint.get("model-rotation").evaluate(d,n,x),S=e.scale=u.paint.get("model-scale").evaluate(d,n,x),L=e.translation=u.paint.get("model-translation").evaluate(d,n,x),P=u.paint.get("model-color").evaluate(d,n,x);P.a=u.paint.get("model-color-mix-intensity").evaluate(d,n,x);const O=[];this.maxVerticalOffset<L[2]&&(this.maxVerticalOffset=L[2]),this.maxScale=Math.max(Math.max(this.maxScale,S[0]),Math.max(S[1],S[2])),Iw(O,v,S);const V=Math.round(100*P.a)+P.b/1.05;for(let G=0;G<e.instancedDataCount;++G){const $=e.instancedDataOffset+G,Y=16*$,ne=a.instancedDataArray.float32;let Te=0;l&&(Te=ne[Y+6]-a.instancesEvaluatedElevation[$]);const Ae=0|ne[Y+1];ne[Y]=(0|ne[Y])+P.r/1.05,ne[Y+1]=Ae+P.g/1.05,ne[Y+2]=V,ne[Y+3]=1/(x.z>10?this.tileToMeter:nf(x,Ae)),ne[Y+4]=L[0],ne[Y+5]=L[1],ne[Y+6]=L[2]+Te,ne[Y+7]=O[0],ne[Y+8]=O[1],ne[Y+9]=O[2],ne[Y+10]=O[4],ne[Y+11]=O[5],ne[Y+12]=O[6],ne[Y+13]=O[8],ne[Y+14]=O[9],ne[Y+15]=O[10],a.instancesEvaluatedElevation[$]=L[2]}}}xe(wx,"ModelBucket",{omit:["layers"]}),xe(zw,"PerModelAttributes"),xe(Dw,"ModelFeature");const yL=new Br({visibility:new oi(Pt.layout_model.visibility),"model-id":new on(Pt.layout_model["model-id"])});var xL={paint:new Br({"model-opacity":new oi(Pt.paint_model["model-opacity"]),"model-rotation":new on(Pt.paint_model["model-rotation"]),"model-scale":new on(Pt.paint_model["model-scale"]),"model-translation":new on(Pt.paint_model["model-translation"]),"model-color":new on(Pt.paint_model["model-color"]),"model-color-mix-intensity":new on(Pt.paint_model["model-color-mix-intensity"]),"model-type":new oi(Pt.paint_model["model-type"]),"model-cast-shadows":new oi(Pt.paint_model["model-cast-shadows"]),"model-receive-shadows":new oi(Pt.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new oi(Pt.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new on(Pt.paint_model["model-emissive-strength"]),"model-roughness":new on(Pt.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new on(Pt.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new oi(Pt.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new oi(Pt.paint_model["model-front-cutoff"])}),layout:yL};const uf=64,Hm={CoordinateSpaceTile:1,CoordinateSpaceYUp:2,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function Ow(t,e,n,a,l,u,d,x,v,S=!1){const L=n.zoom,P=n.project(a),O=du(a.lat,L),V=1/O;s.ad.identity(t),s.ad.translate(t,t,[P.x+d[0]*V,P.y+d[1]*V,d[2]]);let G=1,$=1;const Y=n.worldSize;if(S){if(n.projection.name==="mercator"){let Ce=0;n.elevation&&(Ce=n.elevation.getAtPointOrZero(new Lo(P.x/Y,P.y/Y),0));const qe=s.aA.transformMat4([],[P.x,P.y,Ce,1],n.projMatrix)[3]/n.cameraToCenterDistance;G=qe,$=qe*du(n.center.lat,L)}else if(n.projection.name==="globe"){const Ce=bx(t,n),qe=s.ad.multiply([],n.projMatrix,Ce),Ge=[0,0,0,1];s.aA.transformMat4(Ge,Ge,qe);const ot=Ge[3]/n.cameraToCenterDistance,dt=Hn(L),Rt=n.projection.pixelsPerMeter(a.lat,Y)*du(a.lat,L),$t=n.projection.pixelsPerMeter(n.center.lat,Y)*du(n.center.lat,L);G=ot/Qn(Rt,Dg(n.center.lat),dt),$=ot*O/Rt,G*=$t,$*=$t}}else G=V;s.ad.scale(t,t,[G,G,$]);const ne=[...t],Te=e.orientation,Ae=[];if(Iw(Ae,[Te[0]+l[0],Te[1]+l[1],Te[2]+l[2]],u),s.ad.multiply(t,ne,Ae),x&&n.elevation){let Ce=0;const qe=[];if(v&&n.elevation){Ce=function(dt,Rt,$t,Vt,ai){const Ci=Rt.elevation;if(!Ci)return 0;const ti=Xt.projectAabbCorners($t,Vt),bi=Go(1,ai.lat)*Rt.worldSize,Yt=function(Zn,Cr){const or=[0,0,1],Pr=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const Lr of Pr){const Fr=Zn[Lr.corners[0]],nr=Zn[Lr.corners[1]],bs=Zn[Lr.corners[2]],_s=[nr[0]-Fr[0],nr[1]-Fr[1],Cr*(nr[2]-Fr[2])],is=s._.cross(_s,_s,[bs[0]-Fr[0],bs[1]-Fr[1],Cr*(bs[2]-Fr[2])]);s._.normalize(is,is),Lr.dotProductWithUp=s._.dot(is,or)}return Pr.sort((Lr,Fr)=>Lr.dotProductWithUp-Fr.dotProductWithUp),Pr[0].corners}(ti,bi),wi=ti[Yt[0]],zi=ti[Yt[1]],Si=ti[Yt[2]],fn=ti[Yt[3]],Ii=Ci.getAtPointOrZero(new Lo(wi[0]/Rt.worldSize,wi[1]/Rt.worldSize),0),Ui=Ci.getAtPointOrZero(new Lo(zi[0]/Rt.worldSize,zi[1]/Rt.worldSize),0),qn=Ci.getAtPointOrZero(new Lo(Si[0]/Rt.worldSize,Si[1]/Rt.worldSize),0),Fn=Ci.getAtPointOrZero(new Lo(fn[0]/Rt.worldSize,fn[1]/Rt.worldSize),0),Rn=(Ii+Fn)/2,Fi=(Ui+qn)/2;return Rn>Fi?Ui<qn?Wy(dt,zi,fn,wi,Ui,Fn,Ii,bi):Wy(dt,Si,wi,fn,qn,Ii,Fn,bi):Ii<Fn?Wy(dt,wi,zi,Si,Ii,Ui,qn,bi):Wy(dt,fn,Si,zi,Fn,qn,Ui,bi),Math.max(Rn,Fi)}(qe,n,e.aabb,t,a);const Ge=s.ad.fromQuat([],qe),ot=s.ad.multiply([],Ge,Ae);s.ad.multiply(t,ne,ot)}else Ce=n.elevation.getAtPointOrZero(new Lo(P.x/Y,P.y/Y),0);Ce!==0&&(t[14]+=Ce)}}function n_(t,e,n=!1){t.uploaded||(t.gfxTexture=new $c(e,t.image,n?e.gl.R8:e.gl.RGBA,{useMipmap:t.sampler.minFilter>=e.gl.NEAREST_MIPMAP_NEAREST}),t.uploaded=!0,t.image=null)}function vL(t,e,n){t.indexBuffer=e.createIndexBuffer(t.indexArray,!1,!0),t.vertexBuffer=e.createVertexBuffer(t.vertexArray,uL.members,!1,!0),t.normalArray&&(t.normalBuffer=e.createVertexBuffer(t.normalArray,mL.members,!1,!0)),t.texcoordArray&&(t.texcoordBuffer=e.createVertexBuffer(t.texcoordArray,fL.members,!1,!0)),t.colorArray&&(t.colorBuffer=e.createVertexBuffer(t.colorArray,(t.colorArray.bytesPerElement===12?dL:pL).members,!1,!0)),t.featureArray&&(t.pbrBuffer=e.createVertexBuffer(t.featureArray,_L.members,!0)),t.segments=Ts.simpleSegment(0,0,t.vertexArray.length,t.indexArray.length);const a=t.material;a.pbrMetallicRoughness.baseColorTexture&&n_(a.pbrMetallicRoughness.baseColorTexture,e),a.pbrMetallicRoughness.metallicRoughnessTexture&&n_(a.pbrMetallicRoughness.metallicRoughnessTexture,e),a.normalTexture&&n_(a.normalTexture,e),a.occlusionTexture&&n_(a.occlusionTexture,e,n),a.emissionTexture&&n_(a.emissionTexture,e)}function Mx(t,e,n){if(t.meshes)for(const a of t.meshes)vL(a,e,n);if(t.children)for(const a of t.children)Mx(a,e,n)}function Zy(t){if(t.meshes)for(const e of t.meshes)e.indexArray.destroy(),e.vertexArray.destroy(),e.colorArray&&e.colorArray.destroy(),e.normalArray&&e.normalArray.destroy(),e.texcoordArray&&e.texcoordArray.destroy(),e.featureArray&&e.featureArray.destroy();if(t.children)for(const e of t.children)Zy(e)}function Tx(t){if(t.meshes)for(const n of t.meshes)n.vertexBuffer&&(n.vertexBuffer.destroy(),n.indexBuffer.destroy(),n.normalBuffer&&n.normalBuffer.destroy(),n.texcoordBuffer&&n.texcoordBuffer.destroy(),n.colorBuffer&&n.colorBuffer.destroy(),n.pbrBuffer&&n.pbrBuffer.destroy(),n.segments.destroy(),n.material&&((e=n.material).pbrMetallicRoughness.baseColorTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),e.pbrMetallicRoughness.metallicRoughnessTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),e.normalTexture&&e.normalTexture.gfxTexture&&e.normalTexture.gfxTexture.destroy(),e.emissionTexture&&e.emissionTexture.gfxTexture&&e.emissionTexture.gfxTexture.destroy(),e.occlusionTexture&&e.occlusionTexture.gfxTexture&&e.occlusionTexture.gfxTexture.destroy()));var e;if(t.children)for(const n of t.children)Tx(n)}class bL{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class wL{constructor(){this.tasks={},this.taskQueue=[],vc(["process"],this),this.invoker=new bL(this.process),this.nextId=0}add(e,n){const a=this.nextId++,l=function({type:u,isSymbolTile:d,zoom:x}){return x=x||0,u==="message"?0:u!=="maybePrepare"||d?u!=="parseTile"||d?u==="parseTile"&&d?300-x:u==="maybePrepare"&&d?400-x:500:200-x:100-x}(n);if(l===0){try{e()}finally{}return null}return this.tasks[a]={fn:e,metadata:n,priority:l,id:a},this.taskQueue.push(a),this.invoker.trigger(),{cancel:()=>{delete this.tasks[a]}}}process(){try{if(this.taskQueue=this.taskQueue.filter(a=>!!this.tasks[a]),!this.taskQueue.length)return;const e=this.pick();if(e===null)return;const n=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!n)return;n.fn()}finally{}}pick(){let e=null,n=1/0;for(let l=0;l<this.taskQueue.length;l++){const u=this.tasks[this.taskQueue[l]];u.priority<n&&(n=u.priority,e=l)}if(e===null)return null;const a=this.taskQueue[e];return this.taskQueue.splice(e,1),a}remove(){this.invoker.remove()}}class Fw{constructor(e,n,a){this.target=e,this.parent=n,this.mapId=a,this.callbacks={},this.cancelCallbacks={},vc(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new wL}send(e,n,a,l,u=!1,d){const x=Math.round(1e18*Math.random()).toString(36).substring(0,10);a&&(a.metadata=d,this.callbacks[x]=a);const v=new Set;return this.target.postMessage({id:x,type:e,hasCallback:!!a,targetMapId:l,mustQueue:u,sourceMapId:this.mapId,data:Ot(n,v)},v),{cancel:()=>{a&&delete this.callbacks[x],this.target.postMessage({id:x,type:"<cancel>",targetMapId:l,sourceMapId:this.mapId})}}}receive(e){const n=e.data,a=n.id;if(a&&(!n.targetMapId||this.mapId===n.targetMapId))if(n.type==="<cancel>"){const l=this.cancelCallbacks[a];delete this.cancelCallbacks[a],l&&l.cancel()}else if(n.mustQueue||Er()){const l=this.callbacks[a],u=this.scheduler.add(()=>this.processTask(a,n),l&&l.metadata||{type:"message"});u&&(this.cancelCallbacks[a]=u)}else this.processTask(a,n)}processTask(e,n){if(delete this.cancelCallbacks[e],n.type==="<response>"){const a=this.callbacks[e];delete this.callbacks[e],a&&(n.error?a(mt(n.error)):a(null,mt(n.data)))}else{const a=new Set,l=n.hasCallback?(d,x)=>{this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:d?Ot(d):null,data:Ot(x,a)},a)}:d=>{},u=mt(n.data);if(this.parent[n.type])this.parent[n.type](n.sourceMapId,u,l);else if(this.parent.getWorkerSource){const d=n.type.split(".");this.parent.getWorkerSource(n.sourceMapId,d[0],u.source,u.scope)[d[1]](u,l)}else l(new Error(`Could not find function ${n.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}class jm{constructor(e,n){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=Xs();const a=this.workerPool.acquire(this.id);for(let l=0;l<a.length;l++){const u=new jm.Actor(a[l],n,this.id);u.name=`Worker ${l}`,this.actors.push(u)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(e,n,a){Ds(this.actors,(l,u)=>{l.send(e,n,u)},a=a||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(e=>{e.remove()}),this.actors=[],this.workerPool.release(this.id)}}jm.Actor=Fw;var r_={workerUrl:"",workerClass:null,workerParams:void 0};function ML(){return r_.workerClass!=null?new r_.workerClass:new self.Worker(r_.workerUrl,r_.workerParams)}const Sx="mapboxgl_preloaded_worker_pool";class s_{constructor(){this.active={}}acquire(e){if(!this.workers)for(this.workers=[];this.workers.length<s_.workerCount;)this.workers.push(new ML);return this.active[e]=!0,this.workers.slice()}release(e){delete this.active[e],this.workers&&this.numActive()===0&&(this.workers.forEach(n=>{n.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[Sx]}numActive(){return Object.keys(this.active).length}}let o_;function Xy(){return o_||(o_=new s_),o_}s_.workerCount=2;let $y,Ex,Bh,Wm,Ax,qm=null;function kw(){return Er()&&self.worker&&self.worker.dracoUrl?self.worker.dracoUrl:Ex||Q.DRACO_URL}function Bw(){if(Er()&&self.worker&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(Wm)return Wm;const t=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return Wm=WebAssembly.validate(t)?Q.MESHOPT_SIMD_URL:Q.MESHOPT_URL,Wm}const Yy={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},TL={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},a_={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function Nw(t,e,n){const a=n.json.bufferViews.length,l=n.buffers.length;e.bufferView=a,n.json.bufferViews[a]={buffer:l,byteLength:t.byteLength},n.buffers[l]=t}const Cx="KHR_draco_mesh_compression";function SL(t,e){const n=t.extensions&&t.extensions[Cx];if(!n)return;const a=new Bh.Decoder,l=Hw(e,n.bufferView),u=new Bh.Mesh;if(!a.DecodeArrayToMesh(l,l.byteLength,u))throw new Error("Failed to decode Draco mesh");const d=e.json.accessors[t.indices],x=Yy[d.componentType],v=d.count*x.BYTES_PER_ELEMENT,S=Bh._malloc(v);x===Uint16Array?a.GetTrianglesUInt16Array(u,v,S):a.GetTrianglesUInt32Array(u,v,S),Nw(Bh.memory.buffer.slice(S,S+v),d,e),Bh._free(S);for(const L of Object.keys(n.attributes)){const P=a.GetAttributeByUniqueId(u,n.attributes[L]),O=e.json.accessors[t.attributes[L]],V=TL[O.componentType],G=O.count*a_[O.type]*Yy[O.componentType].BYTES_PER_ELEMENT,$=Bh._malloc(G);a.GetAttributeDataArrayForAllPoints(u,P,Bh[V],G,$),Nw(Bh.memory.buffer.slice($,$+G),O,e),Bh._free($)}a.destroy(),u.destroy(),delete t.extensions[Cx]}const Jy="EXT_meshopt_compression";function EL(t,e){if(!t.extensions||!t.extensions[Jy])return;const n=t.extensions[Jy],a=new Uint8Array(e.buffers[n.buffer],n.byteOffset||0,n.byteLength||0),l=new Uint8Array(n.count*n.byteStride);Ax.decodeGltfBuffer(l,n.count,n.byteStride,a,n.mode,n.filter),t.buffer=e.buffers.length,t.byteOffset=0,e.buffers[t.buffer]=l.buffer,delete t.extensions[Jy]}const Uw=1179937895,Vw=new TextDecoder("utf8");function Gw(t,e){return new URL(t,e).href}function AL(t,e,n,a){return fetch(Gw(t.uri,a)).then(l=>l.arrayBuffer()).then(l=>{e.buffers[n]=l})}function Hw(t,e){const n=t.json.bufferViews[e];return new Uint8Array(t.buffers[n.buffer],n.byteOffset||0,n.byteLength)}function CL(t,e,n,a){if(t.uri){const l=Gw(t.uri,a);return fetch(l).then(u=>u.blob()).then(u=>createImageBitmap(u)).then(u=>{e.images[n]=u})}if(t.bufferView!==void 0){const l=Hw(e,t.bufferView),u=new Blob([l],{type:t.mimeType});return createImageBitmap(u).then(d=>{e.images[n]=d})}}function jw(t,e=0,n){const a={json:null,images:[],buffers:[]};if(new Uint32Array(t,e,1)[0]===Uw){const L=new Uint32Array(t,e);let P=2;const O=(L[P++]>>2)-3,V=L[P++]>>2;if(P++,a.json=JSON.parse(Vw.decode(L.subarray(P,P+V))),P+=V,P<O){const G=L[P++];P++;const $=e+(P<<2);a.buffers[0]=t.slice($,$+G)}}else a.json=JSON.parse(Vw.decode(new Uint8Array(t,e)));const{buffers:l,images:u,meshes:d,extensionsUsed:x,bufferViews:v}=a.json;let S=Promise.resolve();if(l){const L=[];for(let P=0;P<l.length;P++){const O=l[P];O.uri?L.push(AL(O,a,P,n)):a.buffers[P]||(a.buffers[P]=null)}S=Promise.all(L)}return S.then(()=>{const L=[],P=x&&x.includes(Cx),O=x&&x.includes(Jy);if(P&&L.push(function(){if(!Bh)return $y||($y=function(V){let G,$=null;function Y(){G=new Uint8Array($.buffer)}function ne(){throw new Error("Unexpected Draco error.")}const Te={a:{a:ne,d:function(Ae,Ce,qe){return G.copyWithin(Ae,Ce,Ce+qe)},c:function(Ae){const Ce=G.length,qe=Math.max(Ae>>>0,Math.ceil(1.2*Ce)),Ge=Math.ceil((qe-Ce)/65536);try{return $.grow(Ge),Y(),!0}catch{return!1}},b:ne}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(V,Te):V.then(Ae=>Ae.arrayBuffer()).then(Ae=>WebAssembly.instantiate(Ae,Te))).then(Ae=>{const{Rb:Ce,Qb:qe,P:Ge,T:ot,X:dt,Ja:Rt,La:$t,Qa:Vt,Va:ai,Wa:Ci,eb:ti,jb:bi,f:Yt,e:wi,yb:zi,zb:Si,Ab:fn,Bb:Ii,Db:Ui,Gb:qn}=Ae.instance.exports;$=wi;const Fn=(()=>{let Rn=0,Fi=0,Zn=0,Cr=0;return or=>{Zn&&(Ce(Cr),Ce(Rn),Fi+=Zn,Zn=Rn=0),Rn||(Fi+=128,Rn=qe(Fi));const Pr=or.length+7&-8;let Lr=Rn;Pr>=Fi&&(Zn=Pr,Lr=Cr=qe(Pr));for(let Fr=0;Fr<or.length;Fr++)G[Lr+Fr]=or[Fr];return Lr}})();return Y(),Yt(),{memory:wi,_free:Ce,_malloc:qe,Mesh:class{constructor(){this.ptr=Ge()}destroy(){ot(this.ptr)}},Decoder:class{constructor(){this.ptr=Rt()}destroy(){bi(this.ptr)}DecodeArrayToMesh(Rn,Fi,Zn){const Cr=Fn(Rn),or=$t(this.ptr,Cr,Fi,Zn.ptr);return!!dt(or)}GetAttributeByUniqueId(Rn,Fi){return{ptr:Vt(this.ptr,Rn.ptr,Fi)}}GetTrianglesUInt16Array(Rn,Fi,Zn){ai(this.ptr,Rn.ptr,Fi,Zn)}GetTrianglesUInt32Array(Rn,Fi,Zn){Ci(this.ptr,Rn.ptr,Fi,Zn)}GetAttributeDataArrayForAllPoints(Rn,Fi,Zn,Cr,or){ti(this.ptr,Rn.ptr,Fi.ptr,Zn,Cr,or)}},DT_INT8:zi(),DT_UINT8:Si(),DT_INT16:fn(),DT_UINT16:Ii(),DT_UINT32:Ui(),DT_FLOAT32:qn()}})}(fetch(kw())),$y.then(V=>{Bh=V,$y=void 0}))}()),O&&L.push(function(){if(Ax)return;const V=function(G){let $;const Y=WebAssembly.instantiateStreaming(G,{}).then(Ae=>{$=Ae.instance,$.exports.__wasm_call_ctors()}),ne={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},Te={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:Y,supported:!0,decodeGltfBuffer(Ae,Ce,qe,Ge,ot,dt){(function(Rt,$t,Vt,ai,Ci,ti,bi){const Yt=Rt.exports.sbrk,wi=ai+3&-4,zi=Yt(wi*Ci),Si=Yt(ti.length),fn=new Uint8Array(Rt.exports.memory.buffer);fn.set(ti,Si);const Ii=$t(zi,ai,Ci,Si,ti.length);if(Ii===0&&bi&&bi(zi,wi,Ci),Vt.set(fn.subarray(zi,zi+ai*Ci)),Yt(zi-Yt(0)),Ii!==0)throw new Error(`Malformed buffer data: ${Ii}`)})($,$.exports[Te[ot]],Ae,Ce,qe,Ge,$.exports[ne[dt]])}}}(fetch(Bw()));return V.ready.then(()=>{Ax=V})}()),u)for(let V=0;V<u.length;V++)L.push(CL(u[V],a,V,n));return(L.length?Promise.all(L):Promise.resolve()).then(()=>{if(P&&d)for(const{primitives:V}of d)for(const G of V)SL(G,a);if(O&&d&&v)for(const V of v)EL(V,a);return a})})}function df(t,e){const n=t.json.bufferViews[e.bufferView],a=Yy[e.componentType];return new a(t.buffers[n.buffer],(e.byteOffset||0)+(n.byteOffset||0),e.count*(n.byteStride&&n.byteStride!==a_[e.type]*a.BYTES_PER_ELEMENT?n.byteStride/a.BYTES_PER_ELEMENT:a_[e.type]))}function Lx(t,e,n,a){const l=Yy[e.componentType],u=function(L){switch(L){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(l),d=t.json.bufferViews[e.bufferView],x=d.byteStride?d.byteStride/l.BYTES_PER_ELEMENT:a_[e.type],v=n.float32,S=v.length/n.capacity;for(let L=0,P=0;L<e.count*x;L+=x,P+=S)for(let O=0;O<S;O++)v[P+O]=a[L+O]*u;n._trim()}function LL(t,e,n){const a=t.indices,l=t.attributes,u={};u.indexArray=new no;const d=e.json.accessors[a],x=d.count/3;u.indexArray.reserve(x);const v=df(e,d);for(let O=0;O<x;O++)u.indexArray.emplaceBack(v[3*O],v[3*O+1],v[3*O+2]);u.indexArray._trim(),u.vertexArray=new kl;const S=e.json.accessors[l.POSITION];u.vertexArray.reserve(S.count);const L=df(e,S);for(let O=0;O<S.count;O++)u.vertexArray.emplaceBack(L[3*O],L[3*O+1],L[3*O+2]);if(u.vertexArray._trim(),u.aabb=new Xt(S.min,S.max),u.centroid=function(O,V){const G=[0,0,0],$=O.length;if($>0){for(let Y=0;Y<$;Y++){const ne=3*O[Y];G[0]+=V[ne],G[1]+=V[ne+1],G[2]+=V[ne+2]}G[0]/=$,G[1]/=$,G[2]/=$}return G}(v,L),l.COLOR_0!==void 0){const O=e.json.accessors[l.COLOR_0],V=a_[O.type],G=df(e,O);u.colorArray=V===3?new kl:new Uc,u.colorArray.resize(O.count),Lx(e,O,u.colorArray,G)}if(l.NORMAL!==void 0){u.normalArray=new kl;const O=e.json.accessors[l.NORMAL];u.normalArray.resize(O.count);const V=df(e,O);Lx(e,O,u.normalArray,V)}if(l.TEXCOORD_0!==void 0&&n.length>0){u.texcoordArray=new Hc;const O=e.json.accessors[l.TEXCOORD_0];u.texcoordArray.resize(O.count);const V=df(e,O);Lx(e,O,u.texcoordArray,V)}if(l._FEATURE_ID_RGBA4444!==void 0){const O=e.json.accessors[l._FEATURE_ID_RGBA4444];e.json.extensionsUsed&&e.json.extensionsUsed.includes("EXT_meshopt_compression")&&(u.featureData=df(e,O))}l._FEATURE_RGBA4444!==void 0&&(u.featureData=new Uint32Array(df(e,e.json.accessors[l._FEATURE_RGBA4444]).buffer));const P=t.material;return u.material=function(O,V){const{emissiveFactor:G=[0,0,0],alphaMode:$="OPAQUE",alphaCutoff:Y=.5,normalTexture:ne,occlusionTexture:Te,emissiveTexture:Ae,doubleSided:Ce}=O,{baseColorFactor:qe=[1,1,1,1],metallicFactor:Ge=1,roughnessFactor:ot=1,baseColorTexture:dt,metallicRoughnessTexture:Rt}=O.pbrMetallicRoughness||{},$t=Te?V[Te.index]:void 0;if(Te&&Te.extensions&&Te.extensions.KHR_texture_transform&&$t){const Vt=Te.extensions.KHR_texture_transform;$t.offsetScale=[Vt.offset[0],Vt.offset[1],Vt.scale[0],Vt.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new Yr(...qe),metallicFactor:Ge,roughnessFactor:ot,baseColorTexture:dt?V[dt.index]:void 0,metallicRoughnessTexture:Rt?V[Rt.index]:void 0},doubleSided:Ce,emissiveFactor:G,alphaMode:$,alphaCutoff:Y,normalTexture:ne?V[ne.index]:void 0,occlusionTexture:$t,emissionTexture:Ae?V[Ae.index]:void 0,defined:O.defined===void 0}}(P!==void 0?e.json.materials[P]:{defined:!1},n),u}function Ww(t,e,n){const{matrix:a,rotation:l,translation:u,scale:d,mesh:x,extras:v,children:S}=t,L={};if(L.matrix=a||s.ad.fromRotationTranslationScale([],l||[0,0,0,1],u||[0,0,0],d||[1,1,1]),x!==void 0){L.meshes=n[x];const P=L.anchor=[0,0];for(const O of L.meshes){const{min:V,max:G}=O.aabb;P[0]+=V[0]+G[0],P[1]+=V[1]+G[1]}P[0]=Math.floor(P[0]/L.meshes.length/2),P[1]=Math.floor(P[1]/L.meshes.length/2)}if(v&&(v.id&&(L.id=v.id),v.lights&&(L.lights=function(P){if(!P.length)return[];const O=function(ne){const Te=atob(ne),Ae=new Uint8Array(Te.length);for(let Ce=0;Ce<Te.length;Ce++)Ae[Ce]=Te.codePointAt(Ce);return Ae}(P),V=[],G=O.length/24,$=new Uint16Array(O.buffer),Y=new Float32Array(O.buffer);for(let ne=0;ne<G;ne++){const Te=$[2*ne*6]/30,Ae=$[2*ne*6+1]/30,Ce=$[2*ne*6+10]/100,qe=Y[6*ne+1],Ge=Y[6*ne+2],ot=Y[6*ne+3],dt=Y[6*ne+4],Rt=ot-qe,$t=dt-Ge,Vt=Math.hypot(Rt,$t);V.push({pos:[qe+.5*Rt,Ge+.5*$t,Ae],normal:[$t/Vt,-Rt/Vt,0],width:Vt,height:Te,depth:Ce,points:[qe,Ge,ot,dt]})}return V}(v.lights))),S){const P=[];for(const O of S)P.push(Ww(e.json.nodes[O],e,n));L.children=P}return L}function IL(t){if(t.vertices.length===0||t.indices.length===0)return null;const e=new Z0(t.vertices,t.indices,8,256),[n,a]=[e.min.clone(),e.max.clone()];return{vertices:t.vertices,indices:t.indices,grid:e,min:n,max:a}}function PL(t){if(!t.extras||!t.extras.ground)return null;const e=t.extras.ground;if(!e||!Array.isArray(e)||e.length===0)return null;const n=e[0];if(!n||!Array.isArray(n)||n.length===0)return null;const a=[];for(const d of n){if(!Array.isArray(d)||d.length!==2)continue;const x=d[0],v=d[1];typeof x=="number"&&typeof v=="number"&&a.push(new Kt(x,v))}if(a.length<3)return null;a.length>1&&a[a.length-1].equals(a[0])&&a.pop();let l=0;for(let d=0;d<a.length;d++){const x=a[d],v=a[(d+1)%a.length],S=a[(d+2)%a.length];l+=(x.x-v.x)*(S.y-v.y)-(S.x-v.x)*(x.y-v.y)}l>0&&a.reverse();const u=fu(a.flatMap(d=>[d.x,d.y]),[]);return u.length===0?null:{vertices:a,indices:u}}function RL(t,e){const n=[],a=[];let l=0;const u=[];for(const d of t){l=n.length;const x=d.vertexArray.float32,v=d.indexArray.uint16;for(let S=0;S<d.vertexArray.length;S++)u[0]=x[3*S+0],u[1]=x[3*S+1],u[2]=x[3*S+2],s._.transformMat4(u,u,e),n.push(new Kt(u[0],u[1]));for(let S=0;S<3*d.indexArray.length;S++)a.push(v[S]+l)}if(a.length%3!=0)return null;for(let d=0;d<a.length;d+=3){const x=n[a[d+0]],v=n[a[d+1]],S=n[a[d+2]];(x.x-v.x)*(S.y-v.y)-(S.x-v.x)*(x.y-v.y)>0&&([a[d+1],a[d+2]]=[a[d+2],a[d+1]])}return{vertices:n,indices:a}}function qw(t){const e=function(v,S){const L=[],P=WebGL2RenderingContext;if(v.json.textures)for(const O of v.json.textures){const V={magFilter:P.LINEAR,minFilter:P.NEAREST,wrapS:P.REPEAT,wrapT:P.REPEAT};O.sampler!==void 0&&Object.assign(V,v.json.samplers[O.sampler]),L.push({image:S[O.source],sampler:V,uploaded:!1})}return L}(t,t.images),n=function(v,S){const L=[];for(const P of v.json.meshes){const O=[];for(const V of P.primitives)O.push(LL(V,v,S));L.push(O)}return L}(t,e),{scenes:a,scene:l,nodes:u}=t.json,d=a?a[l||0].nodes:u,x=[];for(const v of d)x.push(Ww(u[v],t,n));return function(v,S,L){const P={},O=new Set;for(let V=0;V<v.length;V++){const G=L[S[V]];if(!G.extras)continue;const $=G.extras["mapbox:footprint:version"],Y=G.extras["mapbox:footprint:id"];($||Y)&&O.add(V),$==="1.0.0"&&Y&&(P[Y]=V)}for(let V=0;V<v.length;V++){if(O.has(V))continue;const G=v[V],$=L[S[V]];if(!$.extras)continue;let Y=null;G.id in P&&(Y=RL(v[P[G.id]].meshes,G.matrix)),Y||(Y=PL($)),Y&&(G.footprint=IL(Y))}if(O.size>0){const V=Array.from(O.values()).sort((G,$)=>G-$);for(let G=V.length-1;G>=0;G--)v.splice(V[G],1)}}(x,d,t.json.nodes),x}function DL(t){t.heightmap=new Float32Array(4096),t.heightmap.fill(-1);const e=t.vertexArray.float32,n=t.aabb.min[0]-1,a=t.aabb.min[1]-1,l=uf/(t.aabb.max[0]-n+2),u=uf/(t.aabb.max[1]-a+2);for(let d=0;d<e.length;d+=3){const x=e[d+2],v=(e[d+0]-n)*l|0,S=(e[d+1]-a)*u|0;x>t.heightmap[S*uf+v]&&(t.heightmap[S*uf+v]=x)}}function zL(t,e){const n={};n.indexArray=new no,n.indexArray.reserve(4*t.length),n.vertexArray=new kl,n.vertexArray.reserve(10*t.length),n.colorArray=new Uc,n.vertexArray.reserve(10*t.length);let a=0;for(const d of t){const x=Math.min(10,Math.max(4,1.3*d.height))*e,v=[-d.normal[1],d.normal[0],0],S=Math.min(.29,.1*d.width/d.depth),L=d.width-2*d.depth*e*(S+.01),P=s._.scaleAndAdd([],d.pos,v,L/2),O=s._.scaleAndAdd([],d.pos,v,-L/2),V=[P[0],P[1],P[2]+d.height],G=[O[0],O[1],O[2]+d.height],$=s._.scaleAndAdd([],d.normal,v,S);s._.scale($,$,x);const Y=s._.scaleAndAdd([],d.normal,v,-S);s._.scale(Y,Y,x),s._.add($,P,$),s._.add(Y,O,Y),P[2]+=.1,O[2]+=.1,n.vertexArray.emplaceBack($[0],$[1],$[2]),n.vertexArray.emplaceBack(Y[0],Y[1],Y[2]),n.vertexArray.emplaceBack(P[0],P[1],P[2]),n.vertexArray.emplaceBack(O[0],O[1],O[2]),n.vertexArray.emplaceBack(V[0],V[1],V[2]),n.vertexArray.emplaceBack(G[0],G[1],G[2]),n.vertexArray.emplaceBack(P[0],P[1],P[2]),n.vertexArray.emplaceBack(O[0],O[1],O[2]),n.vertexArray.emplaceBack($[0],$[1],$[2]),n.vertexArray.emplaceBack(Y[0],Y[1],Y[2]);const ne=L/x/2;n.colorArray.emplaceBack(-ne-S,-1,ne,.8),n.colorArray.emplaceBack(ne+S,-1,ne,.8),n.colorArray.emplaceBack(-ne,0,ne,1.3),n.colorArray.emplaceBack(ne,0,ne,1.3),n.colorArray.emplaceBack(ne+S,-.8,ne,.7),n.colorArray.emplaceBack(ne+S,-.8,ne,.7),n.colorArray.emplaceBack(0,0,ne,1.3),n.colorArray.emplaceBack(0,0,ne,1.3),n.colorArray.emplaceBack(ne+S,-1.2,ne,.8),n.colorArray.emplaceBack(ne+S,-1.2,ne,.8),n.indexArray.emplaceBack(6+a,4+a,8+a),n.indexArray.emplaceBack(7+a,9+a,5+a),n.indexArray.emplaceBack(0+a,1+a,2+a),n.indexArray.emplaceBack(1+a,3+a,2+a),a+=10}const l={defined:!0,emissiveFactor:[0,0,0]},u={};return u.baseColorFactor=Yr.white,l.pbrMetallicRoughness=u,n.material=l,n.aabb=new Xt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),n}const Ix=new Float32Array(262144),pf=new Uint8Array(262144);function Zw(t){let e=0;if(t.meshes)for(const n of t.meshes)e=Math.max(e,n.aabb.max[2]);if(t.children)for(const n of t.children)e=Math.max(e,Zw(n));return e}function Xw(t,e,n){if(t.meshes)for(const a of t.meshes)a.aabb.min[0]!==1/0&&n.insert(e,a.aabb.min[0],a.aabb.min[1],a.aabb.max[0],a.aabb.max[1]);if(t.children)for(const a of t.children)Xw(a,e,n)}const $w=["","wall","door","roof","window","lamp","logo"];class Yw{constructor(e){this.node=e,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.feature={type:"Point",id:e.id,geometry:[],properties:{height:Zw(e)}},this.aabb=this._getLocalBounds()}_getLocalBounds(){if(!this.node.meshes)return new Xt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let e=0;const n=new Xt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const a of this.node.meshes)this.node.lightMeshIndex!==e&&(a.transformedAabb=Xt.applyTransformFast(a.aabb,this.node.matrix),n.encapsulate(a.transformedAabb)),e++;this.aabb=n}return this.aabb}}class Ky{constructor(e,n,a,l,u,d){this.id=n,this.modelTraits|=Hm.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,a&&(this.modelTraits|=Hm.HasMapboxMeshFeatures),l&&(this.modelTraits|=Hm.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=u,this.dirty=!0,this.needsUpload=!1,this.nodesInfo=[];for(const x of e)this.nodesInfo.push(new Yw(x)),Xw(x,d.featureIndexArray.length,d.grid),d.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,d.bucketLayerIDs.length-1,0)}updateFootprints(e,n){for(const a of this.getNodesInfo()){const l=a.node;l.footprint&&n.push({footprint:l.footprint,id:e})}}update(){console.log("Update 3D model bucket")}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(e){if(!this.needsUpload)return;const n=this.getNodesInfo();for(const a of n){const l=a.node;this.uploaded?this.updatePbrBuffer(l):Mx(l,e,!0)}for(const a of n)Zy(a.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(e){let n=!1;if(!e.meshes)return n;for(const a of e.meshes)a.pbrBuffer&&(a.pbrBuffer.updateData(a.featureArray),n=!0);return n}needsReEvaluation(e,n,a){const l=e.transform.projectionOptions,u=e.style.getBrightness(),d=this.brightness!==u;return!!(!this.uploaded||this.dirty||l.name!==this.projection.name||l_(a.paint.get("model-color").value,d)||l_(a.paint.get("model-color-mix-intensity").value,d)||l_(a.paint.get("model-roughness").value,d)||l_(a.paint.get("model-emissive-strength").value,d)||l_(a.paint.get("model-height-based-emissive-strength-multiplier").value,d))&&(this.projection=l,this.brightness=u,!0)}evaluateScale(e,n){if(e.transform.zoom===this.zoom)return;this.zoom=e.transform.zoom;const a=this.getNodesInfo(),l=this.id.canonical;for(const u of a){const d=u.feature;u.evaluatedScale=n.paint.get("model-scale").evaluate(d,{},l)}}evaluate(e){const n=this.getNodesInfo();for(const a of n){if(!a.node.meshes)continue;const l=a.feature,u=a.node.meshes&&a.node.meshes[0].featureData,d=a.evaluatedColor[2],x=a.evaluatedRMEA[2],v=this.id.canonical;if(a.hasTranslucentParts=!1,u){for(let S=0;S<$w.length;S++){const L=$w[S];L.length&&(l.properties.part=L);const P=e.paint.get("model-color").evaluate(l,{},v).toRenderColor(null),O=e.paint.get("model-color-mix-intensity").evaluate(l,{},v);a.evaluatedColor[S]=[P.r,P.g,P.b,O],a.evaluatedRMEA[S][0]=e.paint.get("model-roughness").evaluate(l,{},v),a.evaluatedRMEA[S][2]=e.paint.get("model-emissive-strength").evaluate(l,{},v),a.evaluatedRMEA[S][3]=P.a,a.emissionHeightBasedParams[S]=e.paint.get("model-height-based-emissive-strength-multiplier").evaluate(l,{},v),!a.hasTranslucentParts&&P.a<1&&(a.hasTranslucentParts=!0)}delete l.properties.part,FL(a,d!==a.evaluatedColor[2]||x!==a.evaluatedRMEA[2],this.modelTraits)}else a.evaluatedRMEA[0][2]=e.paint.get("model-emissive-strength").evaluate(l,{},v);a.evaluatedScale=e.paint.get("model-scale").evaluate(l,{},v),this.updatePbrBuffer(a.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(e,n,a,l){const u=e.findDEMTileFor(a);if(u&&(u.tileID.canonical!==this.terrainTile||n!==this.terrainExaggeration)){if(u.dem&&u.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=u.tileID.overscaledZ;const d=Pm.create(e,a,u);if(!d)return;this.modelTraits&Hm.HasMapboxMeshFeatures&&this.updateDEM(e,d,a,l);for(const x of this.getNodesInfo()){const v=x.node;if(!v.footprint||!v.footprint.vertices||!v.footprint.vertices.length)continue;const S=v.footprint.vertices;let L=d.getElevationAt(S[0].x,S[0].y,!0,!0);for(let P=1;P<S.length;P++)L=Math.min(L,d.getElevationAt(S[P].x,S[P].y,!0,!0));v.elevation=L}}this.terrainTile=u.tileID.canonical,this.terrainExaggeration=n}}updateDEM(e,n,a,l){let u=n._dem._modifiedForSources[l];if(u===void 0&&(n._dem._modifiedForSources[l]=[],u=n._dem._modifiedForSources[l]),u.includes(a.canonical))return;const d=n._dem.dim;u.push(a.canonical);let x=!1;for(const v of this.getNodesInfo()){const S=v.node;if(!S.footprint||!S.footprint.grid)continue;const L=S.footprint.grid,P=n.tileCoordToPixel(L.min.x,L.min.y),O=n.tileCoordToPixel(L.max.x,L.max.y),V=Math.min(Math.min(d-O.y,P.x),Math.min(P.y,d-O.x));if(V<0)continue;const G=pn(V,2,5);let $=Math.max(0,P.x-G),Y=Math.max(0,P.y-G),ne=Math.min(O.x+G,d-1),Te=Math.min(O.y+G,d-1);for(let Ge=Y;Ge<=Te;++Ge)for(let ot=$;ot<=ne;++ot)pf[Ge*d+ot]=255;let Ae=0,Ce=0;for(let Ge=0;Ge<L.cellsY;++Ge)for(let ot=0;ot<L.cellsX;++ot){if(!L.cells[Ge*L.cellsX+ot])continue;const dt=n.tileCoordToPixel(L.min.x+ot/L.xScale,L.min.y+Ge/L.yScale),Rt=n.tileCoordToPixel(L.min.x+(ot+1)/L.xScale,L.min.y+(Ge+1)/L.yScale);for(let $t=dt.y;$t<=Math.min(Rt.y+1,d-1);++$t)for(let Vt=dt.x;Vt<=Math.min(Rt.x+1,d-1);++Vt)pf[$t*d+Vt]===255&&(pf[$t*d+Vt]=0,Ae+=n.getElevationAtPixel(Vt,$t),Ce++)}const qe=Ae/Ce;$=Math.max(1,P.x-G),Y=Math.max(1,P.y-G),ne=Math.min(O.x+G,d-2),Te=Math.min(O.y+G,d-2),x=!0;for(let Ge=Y;Ge<=Te;++Ge)for(let ot=$;ot<=ne;++ot)pf[Ge*d+ot]===0&&(Ix[Ge*d+ot]=n._dem.set(ot,Ge,qe));for(let Ge=1;Ge<G;++Ge){$=Math.max(1,P.x-Ge),Y=Math.max(1,P.y-Ge),ne=Math.min(O.x+Ge,d-2),Te=Math.min(O.y+Ge,d-2);for(let ot=Y;ot<=Te;++ot)for(let dt=$;dt<=ne;++dt){const Rt=ot*d+dt;if(pf[Rt]===255){let $t=0,Vt=0,ai=-1,Ci=-1;for(let ti=-1;ti<=1;++ti)for(let bi=-1;bi<=1;++bi){const Yt=(ot+ti)*d+dt+bi;if(pf[Yt]>=Ge)continue;const wi=Ix[Yt],zi=Math.abs(wi);zi>Vt&&($t=wi,Vt=zi,ai=bi,Ci=ti)}if(Vt>.1){const ti=1-(Ge+.5*Math.abs(ai*Ci))/G;let bi=n._dem.get(dt,ot)+$t*ti;const Yt=n._dem.get(dt+ai,ot+Ci),wi=n._dem.get(dt-ai,ot-Ci,!0);(bi-Yt)*(bi-wi)>0&&(bi=(Yt+wi)/2),Ix[Rt]=n._dem.set(dt,ot,bi),pf[Rt]=Ge}}}}}x&&(n._demTile.needsDEMTextureUpload=!0,n._dem._timestamp=mo.now())}getNodesInfo(){return this.nodesInfo}destroy(){const e=this.getNodesInfo();for(const n of e)Zy(n.node),Tx(n.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(e,n){if(n.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=n.updateTime;const a=n.getReplacementRegionsForTile(e.toUnwrapped()),l=this.getNodesInfo();for(let u=0;u<this.nodesInfo.length;u++){const d=l[u].node;l[u].hiddenByReplacement=!!d.footprint&&!a.find(x=>x.footprint===d.footprint)}}getHeightAtTileCoord(e,n){const a=this.getNodesInfo(),l=[],u=[0,0,0],d=s.ad.identity([]);for(let x=0;x<this.nodesInfo.length;x++){const v=a[x],S=v.node.meshes[0],L=S.transformedAabb;if(e<L.min[0]||n<L.min[1]||e>L.max[0]||n>L.max[1])continue;if(v.node.hidden===!0)return{height:0,maxHeight:v.feature.properties.height,hidden:!1,verticalScale:v.evaluatedScale[2]};s.ad.invert(d,v.node.matrix),u[0]=e,u[1]=n,s._.transformMat4(u,u,d);const P=(u[0]-S.aabb.min[0])/(S.aabb.max[0]-S.aabb.min[0])*uf|0,O=Math.min(63,(u[1]-S.aabb.min[1])/(S.aabb.max[1]-S.aabb.min[1])*uf|0)*uf+Math.min(63,P),V=S.heightmap[O];if(!(V<0&&v.node.footprint))return v.hiddenByReplacement?void 0:{height:V,maxHeight:v.feature.properties.height,hidden:!1,verticalScale:v.evaluatedScale[2]};if(v.node.footprint.grid.query(new Kt(e,n),new Kt(e,n),l),l.length>0)return{height:void 0,maxHeight:v.feature.properties.height,hidden:v.hiddenByReplacement,verticalScale:v.evaluatedScale[2]}}}}function l_(t,e){return!t.isLightConstant&&e}function OL(t,e,n,a,l,u,d,x){let v=(61440&e|(61440&e)>>4)>>8,S=(3840&e|(3840&e)>>4)>>4,L=240&e|(240&e)>>4;n[3]>0&&(v=Qn(v,255*n[0],n[3]),S=Qn(S,255*n[1],n[3]),L=Qn(L,255*n[2],n[3]));const P=v<<8|S,O=L<<8|Math.floor(255*a[3]),V=function(Ge){const ot=pn(Ge,0,2);return Math.min(Math.round(.5*ot*255),255)}(a[2])<<8|15*a[0]<<4|15*a[1],G=pn(l[0],0,1),$=pn(l[1],0,1),Y=pn(l[2],0,1),ne=pn(l[3],0,1);let Te,Ae,Ce,qe;if(G!==$&&d!==u&&$!==G){const Ge=d-u;Ae=1/(Ge*($-G)),Ce=-(u+Ge*G)/(Ge*($-G));const ot=pn(l[4],-1,1);qe=Math.pow(10,ot),Te=255*Y<<8|255*ne}else Te=65535,Ae=0,Ce=1,qe=1;if(t.emplaceBack(P,O,V,Te,Ae,Ce,qe),x){const Ge=x.length;x.clear();for(let ot=0;ot<Ge;ot++)x.emplaceBack(P,O,V,Te,Ae,Ce,qe)}}function FL(t,e,n){const a=t.node;let l=0;const u=n&Hm.HasMeshoptCompression;for(const d of a.meshes){if(a.lights&&a.lightMeshIndex===l||!d.featureData)continue;d.featureArray=new Jp,d.featureArray.reserve(d.featureData.length);let x=e;for(const v of d.featureData){const S=u?65535&v:v>>16&65535,L=u?v>>16&65535:65535&v,P=(15&L)<8?15&L:0,O=t.evaluatedRMEA[P],V=t.evaluatedColor[P],G=t.emissionHeightBasedParams[P];let $;if(x&&P===2&&a.lights&&($=new Jp,$.resize(10*a.lights.length)),OL(d.featureArray,S,V,O,G,d.aabb.min[2],d.aabb.max[2],$),$&&x){x=!1;const Y=a.meshes[a.lightMeshIndex];Y.featureArray=$,Y.featureArray._trim()}}d.featureArray._trim(),l++}}function Jw(t,e,n,a){const l=1<<t.z;e.lat=Co((a/ji+t.y)/l),e.lng=oa((n/ji+t.x)/l)}xe(Ky,"Tiled3dModelBucket",{omit:["layers"]}),xe(Yw,"Tiled3dModelFeature");const kL={circle:class extends Ao{constructor(t,e,n,a){super(t,Xe,e,n,a)}createBucket(t){return new Fg(t)}queryRadius(t){const e=t;return K("circle-radius",this,e)+K("circle-stroke-width",this,e)+re(this.paint.get("circle-translate"))}queryIntersectsFeature(t,e,n,a,l,u,d,x){const v=Me(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),u.angle,t.pixelToTileUnitsFactor),S=this.paint.get("circle-radius").evaluate(e,n)+this.paint.get("circle-stroke-width").evaluate(e,n);return Xa(t,a,u,d,x,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",v,S)}getProgramIds(){return["circle"]}getDefaultProgramParams(t,e,n){const a=Ho(this);return{config:new gl(this,{zoom:e,lut:n}),defines:a,overrideFog:!1}}},heatmap:class extends Ao{createBucket(t){return new za(t)}constructor(t,e,n,a){super(t,Ug,e,n,a),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(t){t==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=np({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(t){return K("heatmap-radius",this,t)}queryIntersectsFeature(t,e,n,a,l,u,d,x){const v=this.paint.get("heatmap-radius").evaluate(e,n);return Xa(t,a,u,d,x,!0,!0,new Kt(0,0),v)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(t,e,n){return t==="heatmap"?{config:new gl(this,{zoom:e,lut:n}),overrideFog:!1}:{}}},hillshade:class extends Ao{constructor(t,e,n,a){super(t,dd,e,n,a)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(t,e,n){return{overrideFog:!1}}},fill:class extends Ao{constructor(t,e,n,a){super(t,HA,e,n,a)}getProgramIds(){const t=this.paint.get("fill-pattern"),e=t&&t.constantOr(1),n=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&n.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),n}getDefaultProgramParams(t,e,n){return{config:new gl(this,{zoom:e,lut:n}),overrideFog:!1}}recalculate(t,e){super.recalculate(t,e);const n=this.paint._values["fill-outline-color"];n.value.kind==="constant"&&n.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(t){return new py(t)}queryRadius(){return re(this.paint.get("fill-translate"))}queryIntersectsFeature(t,e,n,a,l,u){return!t.queryGeometry.isAboveHorizon&&i(ce(t.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),u.angle,t.pixelToTileUnitsFactor),a)}isTileClipped(){return!0}},"fill-extrusion":class extends Ao{constructor(t,e,n,a){super(t,xC,e,n,a),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(t){return new vy(t)}queryRadius(){return re(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}hasShadowPass(){return!0}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(t,e,n,a,l,u,d,x,v){const S=Me(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),u.angle,t.pixelToTileUnitsFactor),L=this.paint.get("fill-extrusion-height").evaluate(e,n),P=this.paint.get("fill-extrusion-base").evaluate(e,n),O=[0,0],V=x&&u.elevation,G=u.elevation?u.elevation.exaggeration():1,$=t.tile.getBucket(this);if(V&&$ instanceof vy){const Ce=$.centroidVertexArray,qe=v+1;qe<Ce.length&&(O[0]=Ce.geta_centroid_pos0(qe),O[1]=Ce.geta_centroid_pos1(qe))}if(O[0]===0&&O[1]===1)return!1;u.projection.name==="globe"&&(a=ub([a],[new Kt(0,0),new Kt(ji,ji)],t.tileID.canonical).map(Ce=>Ce.polygon).flat());const Y=V?x:null,[ne,Te]=function(Ce,qe,Ge,ot,dt,Rt,$t,Vt,ai,Ci,ti){return Ce.projection.name==="globe"?function(bi,Yt,wi,zi,Si,fn,Ii,Ui,qn,Fn,Rn){const Fi=[],Zn=[],Cr=bi.projection.upVectorScale(Rn,bi.center.lat,bi.worldSize).metersToTile,or=[0,0,0,1],Pr=[0,0,0,1],Lr=(nr,bs,_s,is)=>{nr[0]=bs,nr[1]=_s,nr[2]=is,nr[3]=1},Fr=hb();wi>0&&(wi+=Fr),zi+=Fr;for(const nr of Yt){const bs=[],_s=[];for(const is of nr){const $r=is.x+Si.x,ns=is.y+Si.y,Ps=bi.projection.projectTilePoint($r,ns,Rn),Ss=bi.projection.upVector(Rn,is.x,is.y);let Zs=wi,Hs=zi;if(Ii){const xa=pb($r,ns,wi,zi,Ii,Ui,qn,Fn);Zs+=xa.base,Hs+=xa.top}wi!==0?Lr(or,Ps.x+Ss[0]*Cr*Zs,Ps.y+Ss[1]*Cr*Zs,Ps.z+Ss[2]*Cr*Zs):Lr(or,Ps.x,Ps.y,Ps.z),Lr(Pr,Ps.x+Ss[0]*Cr*Hs,Ps.y+Ss[1]*Cr*Hs,Ps.z+Ss[2]*Cr*Hs),s._.transformMat4(or,or,fn),s._.transformMat4(Pr,Pr,fn),bs.push(new af(or[0],or[1],or[2])),_s.push(new af(Pr[0],Pr[1],Pr[2]))}Fi.push(bs),Zn.push(_s)}return[Fi,Zn]}(Ce,qe,Ge,ot,dt,Rt,$t,Vt,ai,Ci,ti):$t?function(bi,Yt,wi,zi,Si,fn,Ii,Ui,qn){const Fn=[],Rn=[],Fi=[0,0,0,1];for(const Zn of bi){const Cr=[],or=[];for(const Pr of Zn){const Lr=Pr.x+zi.x,Fr=Pr.y+zi.y,nr=pb(Lr,Fr,Yt,wi,fn,Ii,Ui,qn);Fi[0]=Lr,Fi[1]=Fr,Fi[2]=nr.base,Fi[3]=1,s.aA.transformMat4(Fi,Fi,Si),Fi[3]=Math.max(Fi[3],1e-5);const bs=new af(Fi[0]/Fi[3],Fi[1]/Fi[3],Fi[2]/Fi[3]);Fi[0]=Lr,Fi[1]=Fr,Fi[2]=nr.top,Fi[3]=1,s.aA.transformMat4(Fi,Fi,Si),Fi[3]=Math.max(Fi[3],1e-5);const _s=new af(Fi[0]/Fi[3],Fi[1]/Fi[3],Fi[2]/Fi[3]);Cr.push(bs),or.push(_s)}Fn.push(Cr),Rn.push(or)}return[Fn,Rn]}(qe,Ge,ot,dt,Rt,$t,Vt,ai,Ci):function(bi,Yt,wi,zi,Si){const fn=[],Ii=[],Ui=Si[8]*Yt,qn=Si[9]*Yt,Fn=Si[10]*Yt,Rn=Si[11]*Yt,Fi=Si[8]*wi,Zn=Si[9]*wi,Cr=Si[10]*wi,or=Si[11]*wi;for(const Pr of bi){const Lr=[],Fr=[];for(const nr of Pr){const bs=nr.x+zi.x,_s=nr.y+zi.y,is=Si[0]*bs+Si[4]*_s+Si[12],$r=Si[1]*bs+Si[5]*_s+Si[13],ns=Si[2]*bs+Si[6]*_s+Si[14],Ps=Si[3]*bs+Si[7]*_s+Si[15],Ss=is+Ui,Zs=$r+qn,Hs=ns+Fn,xa=Math.max(Ps+Rn,1e-5),so=is+Fi,Vs=$r+Zn,xo=ns+Cr,Qo=Math.max(Ps+or,1e-5);Lr.push(new af(Ss/xa,Zs/xa,Hs/xa)),Fr.push(new af(so/Qo,Vs/Qo,xo/Qo))}fn.push(Lr),Ii.push(Fr)}return[fn,Ii]}(qe,Ge,ot,dt,Rt)}(u,a,P,L,S,d,Y,O,G,u.center.lat,t.tileID.canonical),Ae=t.queryGeometry;return function(Ce,qe,Ge){let ot=1/0;i(Ge,qe)&&(ot=db(Ge,qe[0]));for(let dt=0;dt<qe.length;dt++){const Rt=qe[dt],$t=Ce[dt];for(let Vt=0;Vt<Rt.length-1;Vt++){const ai=Rt[Vt],Ci=[ai,Rt[Vt+1],$t[Vt+1],$t[Vt],ai];kg(Ge,Ci)&&(ot=Math.min(ot,db(Ge,Ci)))}}return ot!==1/0&&ot}(ne,Te,Ae.isPointQuery()?Ae.screenBounds:Ae.screenGeometry)}},line:class extends Ao{constructor(t,e,n,a){super(t,wy,e,n,a),wy.layout&&(this.layout=new vs(wy.layout)),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(t){if(t==="line-gradient"){const e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof Wa,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(t,e){super.recalculate(t,e),this.paint._values["line-floorwidth"]=xw.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,t)}createBucket(t){return new by(t)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(t,e,n){const a=bb(this);return{config:new gl(this,{zoom:e,lut:n}),defines:a,overrideFog:!1}}queryRadius(t){const e=t,n=vw(K("line-width",this,e),K("line-gap-width",this,e)),a=K("line-offset",this,e);return n/2+Math.abs(a)+re(this.paint.get("line-translate"))}queryIntersectsFeature(t,e,n,a,l,u){if(t.queryGeometry.isAboveHorizon)return!1;const d=ce(t.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),u.angle,t.pixelToTileUnitsFactor),x=t.pixelToTileUnitsFactor/2*vw(this.paint.get("line-width").evaluate(e,n),this.paint.get("line-gap-width").evaluate(e,n)),v=this.paint.get("line-offset").evaluate(e,n);return v&&(a=function(S,L){const P=[],O=new Kt(0,0);for(let V=0;V<S.length;V++){const G=S[V],$=[];for(let Y=0;Y<G.length;Y++){const ne=G[Y],Te=G[Y+1],Ae=Y===0?O:ne.sub(G[Y-1])._unit()._perp(),Ce=Y===G.length-1?O:Te.sub(ne)._unit()._perp(),qe=Ae._add(Ce)._unit();qe._mult(1/(qe.x*Ce.x+qe.y*Ce.y)),$.push(qe._mult(L)._add(ne))}P.push($)}return P}(a,v*t.pixelToTileUnitsFactor)),function(S,L,P){for(let O=0;O<L.length;O++){const V=L[O];if(S.length>=3){for(let G=0;G<V.length;G++)if(z(S,V[G]))return!0}if(c(S,V,P))return!0}return!1}(d,a,x)}isTileClipped(){return!0}isDraped(t){const e=this.layout.get("line-z-offset");return e.isConstant()&&!e.constantOr(0)}},symbol:Vy,background:class extends Ao{constructor(t,e,n,a){super(t,tL,e,n,a)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(t,e,n){return{overrideFog:!1}}},raster:Tw,"raster-particle":Sw,sky:class extends Ao{constructor(t,e,n,a){super(t,cL,e,n,a),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(t){t==="sky-gradient"?this._updateColorRamp():t!=="sky-atmosphere-sun"&&t!=="sky-atmosphere-halo-color"&&t!=="sky-atmosphere-color"&&t!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=np({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(t){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const e=t.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(t,e){if(this.paint.get("sky-type")==="atmosphere"){const a=this.paint.get("sky-atmosphere-sun"),l=!a,u=t.style.light,d=u.properties.get("position");return l&&u.properties.get("anchor")==="viewport"&&Is("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),l?vx(d.azimuthal,90-d.polar,e):vx(a[0],90-a[1],e)}const n=this.paint.get("sky-gradient-center");return vx(n[0],90-n[1],e)}isSky(){return!0}markSkyboxValid(t){this._skyboxInvalidated=!1,this._lightPosition=t.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const t=this.paint.get("sky-type");return t==="atmosphere"?["skyboxCapture","skybox"]:t==="gradient"?["skyboxGradient"]:null}},slot:class extends Ao{constructor(t,e,n,a){super(t,hL,e,null)}},model:class extends Ao{constructor(t,e,n,a){super(t,xL,e,n,a),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(t){return new wx(t)}getProgramIds(){return["model"]}is3D(){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(t){return t instanceof Ky?ji-1:0}queryIntersectsFeature(t,e,n,a,l,u){if(!this.modelManager)return!1;const d=this.modelManager,x=t.tile.getBucket(this);if(!(x&&x instanceof wx))return!1;const v=x;for(const S in v.instancesPerModel){const L=v.instancesPerModel[S],P=e.id!==void 0?e.id:e.properties&&e.properties.hasOwnProperty("id")?e.properties.id:void 0;if(L.idToFeaturesIndex.hasOwnProperty(P)){const O=L.features[L.idToFeaturesIndex[P]],V=d.getModel(S,this.scope);if(!V)return!1;let G=s.ad.create();const $=new Gr(0,0),Y=v.canonical;let ne=Number.MAX_VALUE;for(let Te=0;Te<O.instancedDataCount;++Te){const Ae=16*(O.instancedDataOffset+Te),Ce=L.instancedDataArray.float32,qe=[Ce[Ae+4],Ce[Ae+5],Ce[Ae+6]];Jw(Y,$,Ce[Ae],0|Ce[Ae+1]),Ow(G,V,u,$,O.rotation,O.scale,qe,!1,!1,!1),u.projection.name==="globe"&&(G=bx(G,u));const Ge=s.ad.multiply([],u.projMatrix,G),ot=t.queryGeometry,dt=Pw(ot.isPointQuery()?ot.screenBounds:ot.screenGeometry,u,Ge,V.aabb);dt!=null&&(ne=Math.min(dt,ne))}return ne!==Number.MAX_VALUE&&ne}}return!1}_handleOverridablePaintPropertyUpdate(t,e,n){return!(!this.layout||e.isDataDriven()||n.isDataDriven()||t!=="model-color"&&t!=="model-color-mix-intensity"&&t!=="model-rotation"&&t!=="model-scale"&&t!=="model-translation"&&t!=="model-emissive-strength")}_isPropertyZoomDependent(t){const e=this._transitionablePaint._values[t];return e!=null&&e.value!=null&&e.value.expression!=null&&e.value.expression instanceof pe}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}queryIntersectsMatchingFeature(t,e,n,a){const l=t.tile,u=l.getBucket(this);let d=null,x=Number.MAX_VALUE;if(!(u&&u instanceof Ky))return{queryFeature:d,intersectionZ:x};const v=u.getNodesInfo()[e];if(v.hiddenByReplacement||!v.node.meshes||!n.filter(new ir(l.tileID.overscaledZ),v.feature,l.tileID.canonical))return{queryFeature:d,intersectionZ:x};const S=v.node,L=a.calculatePosMatrix(l.tileID.toUnwrapped(),a.worldSize),P=v.evaluatedScale;let O=0;a.elevation&&S.elevation&&(O=S.elevation*a.elevation.exaggeration()),s.ad.translate(L,L,[(S.anchor?S.anchor[0]:0)*(P[0]-1),(S.anchor?S.anchor[1]:0)*(P[1]-1),O]),s.ad.scale(L,L,P),s.ad.multiply(L,L,S.matrix);const V=t.queryGeometry,G=V.isPointQuery()?V.screenBounds:V.screenGeometry,$=function(ne){const Te=s.ad.multiply([],L,ne.matrix),Ae=s.ad.multiply(Te,a.expandedFarZProjMatrix,Te);for(let Ce=0;Ce<ne.meshes.length;++Ce){const qe=ne.meshes[Ce];if(Ce===ne.lightMeshIndex)continue;const Ge=Pw(G,a,Ae,qe.aabb);Ge!=null&&(x=Math.min(Ge,x))}if(ne.children)for(const Ce of ne.children)$(Ce)};if($(S),x===Number.MAX_VALUE)return{queryFeature:d,intersectionZ:x};const Y=new Gr(0,0);return Jw(l.tileID.canonical,Y,v.node.anchor[0],v.node.anchor[1]),d={type:"Feature",geometry:{type:"Point",coordinates:[Y.lng,Y.lat]},properties:v.feature.properties,id:v.feature.id,state:{},layer:this.serialize()},{queryFeature:d,intersectionZ:x}}},clip:class extends Ao{constructor(t,e,n,a){super(t,WA,e,n,a)}recalculate(t,e){super.recalculate(t,e)}createBucket(t){return new P1(t)}isTileClipped(){return!0}is3D(){return!0}}};xe(gw,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]});const Kw=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class Px{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[n,a]=new Uint8Array(e,0,2);if(n!==219)throw new Error("Data does not appear to be in a KDBush format.");const l=a>>4;if(l!==1)throw new Error(`Got v${l} data when expected v1.`);const u=Kw[15&a];if(!u)throw new Error("Unrecognized array type.");const[d]=new Uint16Array(e,2,1),[x]=new Uint32Array(e,4,1);return new Px(x,d,u,e)}constructor(e,n=64,a=Float64Array,l){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+n,2),65535),this.ArrayType=a,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const u=Kw.indexOf(this.ArrayType),d=2*e*this.ArrayType.BYTES_PER_ELEMENT,x=e*this.IndexArrayType.BYTES_PER_ELEMENT,v=(8-x%8)%8;if(u<0)throw new Error(`Unexpected typed array class: ${a}.`);l&&l instanceof ArrayBuffer?(this.data=l,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+x+v,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+d+x+v),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+x+v,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+u]),new Uint16Array(this.data,2,1)[0]=n,new Uint32Array(this.data,4,1)[0]=e)}add(e,n){const a=this._pos>>1;return this.ids[a]=a,this.coords[this._pos++]=e,this.coords[this._pos++]=n,a}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return Rx(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,n,a,l){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:u,coords:d,nodeSize:x}=this,v=[0,u.length-1,0],S=[];for(;v.length;){const L=v.pop()||0,P=v.pop()||0,O=v.pop()||0;if(P-O<=x){for(let Y=O;Y<=P;Y++){const ne=d[2*Y],Te=d[2*Y+1];ne>=e&&ne<=a&&Te>=n&&Te<=l&&S.push(u[Y])}continue}const V=O+P>>1,G=d[2*V],$=d[2*V+1];G>=e&&G<=a&&$>=n&&$<=l&&S.push(u[V]),(L===0?e<=G:n<=$)&&(v.push(O),v.push(V-1),v.push(1-L)),(L===0?a>=G:l>=$)&&(v.push(V+1),v.push(P),v.push(1-L))}return S}within(e,n,a){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:l,coords:u,nodeSize:d}=this,x=[0,l.length-1,0],v=[],S=a*a;for(;x.length;){const L=x.pop()||0,P=x.pop()||0,O=x.pop()||0;if(P-O<=d){for(let Y=O;Y<=P;Y++)eM(u[2*Y],u[2*Y+1],e,n)<=S&&v.push(l[Y]);continue}const V=O+P>>1,G=u[2*V],$=u[2*V+1];eM(G,$,e,n)<=S&&v.push(l[V]),(L===0?e-a<=G:n-a<=$)&&(x.push(O),x.push(V-1),x.push(1-L)),(L===0?e+a>=G:n+a>=$)&&(x.push(V+1),x.push(P),x.push(1-L))}return v}}function Rx(t,e,n,a,l,u){if(l-a<=n)return;const d=a+l>>1;Qw(t,e,d,a,l,u),Rx(t,e,n,a,d-1,1-u),Rx(t,e,n,d+1,l,1-u)}function Qw(t,e,n,a,l,u){for(;l>a;){if(l-a>600){const S=l-a+1,L=n-a+1,P=Math.log(S),O=.5*Math.exp(2*P/3),V=.5*Math.sqrt(P*O*(S-O)/S)*(L-S/2<0?-1:1);Qw(t,e,n,Math.max(a,Math.floor(n-L*O/S+V)),Math.min(l,Math.floor(n+(S-L)*O/S+V)),u)}const d=e[2*n+u];let x=a,v=l;for(c_(t,e,a,n),e[2*l+u]>d&&c_(t,e,a,l);x<v;){for(c_(t,e,x,v),x++,v--;e[2*x+u]<d;)x++;for(;e[2*v+u]>d;)v--}e[2*a+u]===d?c_(t,e,a,v):(v++,c_(t,e,v,l)),v<=n&&(a=v+1),n<=v&&(l=v-1)}}function c_(t,e,n,a){Dx(t,n,a),Dx(e,2*n,2*a),Dx(e,2*n+1,2*a+1)}function Dx(t,e,n){const a=t[e];t[e]=t[n],t[n]=a}function eM(t,e,n,a){const l=t-n,u=e-a;return l*l+u*u}s.$=Mo,s.A=ja,s.B=Lc,s.C=Yr,s.D=Zo,s.E=oc,s.G=Ys,s.H=y,s.I=cf,s.J=m,s.K=function(t){const e=t.value;let n=[];if(!e)return n;const a=dh(e);return a!=="string"?(n=n.concat([new qy(t.key,e,`string expected, "${a}" found`)]),n):(Rw(e,!0)||(n=n.concat([new qy(t.key,e,`invalid url "${e}"`)])),n)},s.L=Pt,s.M=class{constructor(t,e,n,a){this.id=t,this.position=e!=null?new Gr(e[0],e[1]):new Gr(0,0),this.orientation=n??[0,0,0],this.nodes=a,this.uploaded=!1,this.aabb=new Xt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(t,e){if(s.ad.multiply(t.matrix,e,t.matrix),t.meshes)for(const n of t.meshes){const a=Xt.applyTransformFast(n.aabb,t.matrix);this.aabb.encapsulate(a)}if(t.children)for(const n of t.children)this._applyTransformations(n,t.matrix)}computeBoundsAndApplyParent(){const t=s.ad.identity([]);for(const e of this.nodes)this._applyTransformations(e,t)}computeModelMatrix(t,e,n,a,l,u,d=!1){Ow(this.matrix,this,t.transform,this.position,e,n,a,l,u,d)}upload(t){if(!this.uploaded){for(const e of this.nodes)Mx(e,t);for(const e of this.nodes)Zy(e);this.uploaded=!0}}destroy(){for(const t of this.nodes)Tx(t)}},s.N=Br,s.O=oi,s.P=Kt,s.Q=class{constructor(t){this.specification=t}possiblyEvaluate(t,e){return ws(t.expression.evaluate(e))}interpolate(t,e,n){return{x:Qn(t.x,e.x,n),y:Qn(t.y,e.y,n),z:Qn(t.z,e.z,n),azimuthal:Qn(t.azimuthal,e.azimuthal,n),polar:Qn(t.polar,e.polar,n)}}},s.R=Ma,s.S=dm,s.T=$c,s.U=Or,s.V=qy,s.W=Ls,s.X=ir,s.Y=Lo,s.Z=pe,s.a=Wl,s.a$=function(t){const{x:e,y:n}=t.point,{lng:a,lat:l}=t._center;return rn(e,n,t.worldSize,a,l)},s.a0=vs,s.a1=Hn,s.a2=Qn,s.a3=ji,s.a4=$f,s.a5=class{constructor(t){this.specification=t}possiblyEvaluate(t,e){return function([n,a]){const l=ws([1,n,a]);return{x:l.x,y:l.y,z:l.z}}(t.expression.evaluate(e))}interpolate(t,e,n){return{x:Qn(t.x,e.x,n),y:Qn(t.y,e.y,n),z:Qn(t.z,e.z,n)}}},s.a6=Qd,s.a7=Qp,s.a8=Lh,s.a9=Cg,s.aB=function(t,e){const{x:n,y:a}=t.point,l=rn(n,a,t.worldSize/t._pixelsPerMercatorPixel,0,0);return s.ad.multiply(l,l,di(hr(e)))},s.aD=Om,s.aE=_c,s.aF=Sy,s.aG=function(t,e,n,a,l){const u=5*e+2;t.float32[u+0]=n,t.float32[u+1]=a,t.float32[u+2]=l},s.aH=Fy,s.aI=Gr,s.aJ=ow,s.aK=Sm,s.aL=lo,s.aM=vi,s.aN=Aw,s.aO=uu,s.aP=Xi,s.aQ=function(t,e,n,a,l,u,d,x,v){if(v.name==="globe")return Xi(t,e,new uu(n,a,l),!1);const S=lf({z:n,x:a,y:l},v);return new Xt([(u+S.x/S.scale)*e,e*(S.y/S.scale),d],[(u+S.x2/S.scale)*e,e*(S.y2/S.scale),x])},s.aR=function(t,e,n){let a=0;for(let l=0;l<2;++l)t[l]>0&&(a+=(t[l]-0)*(t[l]-0)),e[l]<0&&(a+=(0-e[l])*(0-e[l]));return a},s.aS=Js,s.aT=nt,s.aU=iy,s.aV=function(t){const e=s.ad.identity(new Float64Array(16));s.ad.multiply(e,t.pixelMatrix,t.globeMatrix);const n=[0,Bl,0],a=[0,Nl,0];return s._.transformMat4(n,n,e),s._.transformMat4(a,a,e),[n[0]>0&&n[0]<=t.width&&n[1]>0&&n[1]<=t.height&&!sr(t,new Gr(t.center.lat,90)),a[0]>0&&a[0]<=t.width&&a[1]>0&&a[1]<=t.height&&!sr(t,new Gr(t.center.lat,-90))]},s.aW=function(t,e){const{scale:n}=t.tileTransform,a=n*ji/(t.tileSize*Math.pow(2,e.zoom-t.tileID.overscaledZ+t.tileID.canonical.z));return s.aC.scale(new Float32Array(4),e.inverseAdjustmentMatrix,[a,a])},s.aX=jy,s.aY=Ew,s.aZ=function(t){const e=Ew(t,!0);return s.aC.invert([],[e[0],e[1],e[4],e[5]])},s.a_=Je,s.aa=Jo,s.ab=Pn,s.ac=function(t,e,n){const a=Math.sqrt(t*t+e*e+n*n),l=a>0?Math.acos(n/a)*gr:0;let u=t!==0||e!==0?Math.atan2(-e,-t)*gr+90:0;return u<0&&(u+=360),[a,u,l]},s.ae=Um,s.af=Oh,s.ag=hx,s.ah=function(t,e){const n={};for(let a=0;a<e.length;a++){const l=e[a];l in t&&(n[l]=t[l])}return n},s.ai=fc,s.aj=mc,s.ak=sa,s.al=lu,s.am=function(t){go++,go>ah&&(t.getActor().send("enforceCacheSizeLimit",el),go=0)},s.an=Sd,s.ao=class{constructor(t){this.entries={},this.scheduler=t}request(t,e,n,a){const l=this.entries[t]=this.entries[t]||{callbacks:[]};if(l.result){const[u,d]=l.result;return this.scheduler?this.scheduler.add(()=>{a(u,d)},e):a(u,d),()=>{}}return l.callbacks.push(a),l.cancel||(l.cancel=n((u,d)=>{l.result=[u,d];for(const x of l.callbacks)this.scheduler?this.scheduler.add(()=>{x(u,d)},e):x(u,d);setTimeout(()=>delete this.entries[t],3e3)})),()=>{l.result||(l.callbacks=l.callbacks.filter(u=>u!==a),l.callbacks.length||(l.cancel(),delete this.entries[t]))}}},s.ap=function(t,e,n){const a=JSON.stringify(t.request);return t.data&&(this.deduped.entries[a]={result:[null,t.data]}),this.deduped.request(a,{type:"parseTile",isSymbolTile:t.isSymbolTile,zoom:t.tileZoom},l=>{const u=ic(t.request,(d,x,v,S)=>{d?l(d):x&&l(null,{vectorTile:n?void 0:new X0(new zm(x)),rawData:x,cacheControl:v,expires:S})});return()=>{u.cancel(),l()}},e)},s.aq=Kd,s.ar=class extends Wc{constructor(t){super(t),this.current=J_}set(t,e,n){if(this.fetchUniformLocation(t,e)){for(let a=0;a<9;a++)if(n[a]!==this.current[a]){this.current=n,this.gl.uniformMatrix3fv(this.location,!1,n);break}}}},s.as=ef,s.at=pn,s.au=To,s.aw=Mc,s.ax=Go,s.ay=Co,s.az=function(t,e,n){t[4*e+0]=n[0],t[4*e+1]=n[1],t[4*e+2]=n[2],t[4*e+3]=n[3]},s.b=Ts,s.b$=op,s.b0=_r,s.b1=tf,s.b2=function(t){const e=Math.round((t+45+360)%360/90)%4;return un[e]},s.b3=45,s.b4=Am,s.b5=nf,s.b6=Xt,s.b7=ws,s.b8=function(t){return[Math.pow(t[0],1/2.2),Math.pow(t[1],1/2.2),Math.pow(t[2],1/2.2)]},s.b9=fs,s.bA=function(t,e){return[Math.pow(t[0],2.2)*e,Math.pow(t[1],2.2)*e,Math.pow(t[2],2.2)*e]},s.bB=yb,s.bD=an,s.bE=Kl,s.bF=sh,s.bG=256,s.bH=function(t,e){const n=[0,0,0],a=pt(hr(e.canonical));return s._.transformMat4(n,n,a),s._.transformMat4(n,n,t),n},s.bI=t=>({u_camera_to_center_distance:new Jo(t),u_extrude_scale:new Mm(t),u_device_pixel_ratio:new Jo(t),u_matrix:new Qd(t),u_inv_rot_matrix:new Qd(t),u_merc_center:new Lh(t),u_tile_id:new Kd(t),u_zoom_transition:new Jo(t),u_up_dir:new Kd(t),u_emissive_strength:new Jo(t)}),s.bJ=t=>({u_matrix:new Qd(t),u_pixels_to_tile_units:new Mm(t),u_device_pixel_ratio:new Jo(t),u_units_to_pixels:new Lh(t),u_dash_image:new Qp(t),u_gradient_image:new Qp(t),u_image_height:new Jo(t),u_texsize:new Lh(t),u_tile_units_to_pixels:new Jo(t),u_alpha_discard_threshold:new Jo(t),u_trim_offset:new Lh(t),u_trim_fade_range:new Lh(t),u_trim_color:new ef(t),u_emissive_strength:new Jo(t)}),s.bK=t=>({u_matrix:new Qd(t),u_texsize:new Lh(t),u_pixels_to_tile_units:new Mm(t),u_device_pixel_ratio:new Jo(t),u_image:new Qp(t),u_units_to_pixels:new Lh(t),u_tile_units_to_pixels:new Jo(t),u_alpha_discard_threshold:new Jo(t),u_trim_offset:new Lh(t)}),s.bL=fl,s.bM=RC,s.bN=aa,s.bO=YC,s.bP=Jb,s.bQ=nx,s.bR=Ho,s.bS=(t,e,n,a,l,u)=>{const d=t.transform,x=d.projection.name==="globe";let v;if(u.paint.get("circle-pitch-alignment")==="map")if(x){const L=an(d.zoom,e.canonical)*d._pixelsPerMercatorPixel;v=Float32Array.from([L,0,0,L])}else v=d.calculatePixelsToTileUnitsMatrix(n);else v=new Float32Array([d.pixelsToGLUnits[0],0,0,d.pixelsToGLUnits[1]]);const S={u_camera_to_center_distance:t.transform.getCameraToCenterDistance(d.projection),u_matrix:t.translatePosMatrix(e.projMatrix,n,u.paint.get("circle-translate"),u.paint.get("circle-translate-anchor")),u_device_pixel_ratio:mo.devicePixelRatio,u_extrude_scale:v,u_inv_rot_matrix:Ns,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:u.paint.get("circle-emissive-strength")};if(x){S.u_inv_rot_matrix=a,S.u_merc_center=l,S.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],S.u_zoom_transition=Hn(d.zoom);const L=l[0]*ji,P=l[1]*ji;S.u_up_dir=d.projection.upVector(new uu(0,0,0),L,P)}return S},s.bT=bb,s.bU=(t,e,n,a,l,u)=>{const d=t.transform;return{u_matrix:vb(t,e,n,a),u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:d.calculatePixelsToTileUnitsMatrix(e),u_device_pixel_ratio:l,u_image:0,u_tile_units_to_pixels:xb(e,d),u_units_to_pixels:[1/d.pixelsToGLUnits[0],1/d.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:u}},s.bV=(t,e,n,a,l,u,d)=>{const x=t.transform,v=x.calculatePixelsToTileUnitsMatrix(e);return{u_matrix:vb(t,e,n,a),u_pixels_to_tile_units:v,u_device_pixel_ratio:u,u_units_to_pixels:[1/x.pixelsToGLUnits[0],1/x.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:l,u_texsize:wb(n)&&e.lineAtlasTexture?e.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:xb(e,t.transform),u_alpha_discard_threshold:0,u_trim_offset:d,u_trim_fade_range:n.paint.get("line-trim-fade-range"),u_trim_color:n.paint.get("line-trim-color").toRenderColor(n.lut).toArray01(),u_emissive_strength:n.paint.get("line-emissive-strength")}},s.bW=Kn,s.bX=np,s.bY=hb,s.bZ=ry,s.b_=vy,s.ba=function(t,e,n){const a=Hn(n.zoom),l=t.style.map._antialias,u=e.options.extStandardDerivativesForceOff||t.terrain&&t.terrain.exaggeration()>0;return a===0&&!l&&!u},s.bb=function(t){const e=t.pixelsPerMeter,n=e/Go(1,t.center.lat),a=s.ad.identity(new Float64Array(16));return s.ad.translate(a,a,[t.point.x,t.point.y,0]),s.ad.scale(a,a,[n,n,e]),Float32Array.from(a)},s.bc=Li,s.bd=function(t){const e=Js-5;t=pn(t,-e,e)/e*90;const n=Math.pow(Math.abs(Math.sin(Pn(t))),3);return Math.round(n*(Lg.length-1))},s.be=function(t,e,n,a){const l=e.getNorth(),u=e.getSouth(),d=e.getWest(),x=e.getEast(),v=1<<t.z,S=x-d,L=l-u,P=S/ep,O=-L/Lg[n],V=[0,P,0,O,0,0,l,d,0];if(t.z>0){const G=180/a;s.bC.multiply(V,V,[G/S+1,0,0,0,G/L+1,0,-.5*G/P,.5*G/O,1])}return V[2]=v,V[5]=t.x,V[8]=t.y,V},s.bf=pt,s.bg=hr,s.bh=function(t,e,n){const a=s.ad.identity(new Float64Array(16)),l=(e/(1<<t)-.5)*Math.PI*2;return s.ad.rotateY(a,n.globeMatrix,l),Float32Array.from(a)},s.bi=oh,s.bj=function(t){return t<=1?1:Math.pow(2,Math.floor(Math.log(t)/Math.LN2))},s.bk=Tw,s.bl=Sw,s.bm=Mw,s.bn=function(t,e){const n=document.createElement("video");n.muted=!0,n.onloadstart=function(){e(null,n)};for(let a=0;a<t.length;a++){const l=document.createElement("source");Wf(t[a])||(n.crossOrigin="Anonymous"),l.src=t[a],n.appendChild(l)}return{cancel:()=>{}}},s.bo=ky,s.bp=vc,s.bq=class{isDataAvailableAtPoint(t){const e=this._source();if(this.isUsingMockSource()||!e||t.y<0||t.y>1)return!1;const n=e.getSource().maxzoom,a=1<<n,l=Math.floor(t.x),u=Math.floor((t.x-l)*a),d=Math.floor(t.y*a),x=this.findDEMTileFor(new lo(n,l,n,u,d));return!(!x||!x.dem)}getAtPointOrZero(t,e=0){return this.getAtPoint(t,e)||0}getAtPoint(t,e,n=!0){if(this.isUsingMockSource())return null;e==null&&(e=null);const a=this._source();if(!a||t.y<0||t.y>1)return e;const l=a.getSource().maxzoom,u=1<<l,d=Math.floor(t.x),x=t.x-d,v=new lo(l,d,l,Math.floor(x*u),Math.floor(t.y*u)),S=this.findDEMTileFor(v);if(!S||!S.dem)return e;const L=S.dem,P=1<<S.tileID.canonical.z,O=(x*P-S.tileID.canonical.x)*L.dim,V=(t.y*P-S.tileID.canonical.y)*L.dim,G=Math.floor(O),$=Math.floor(V);return(n?this.exaggeration():1)*Qn(Qn(L.get(G,$),L.get(G,$+1),V-$),Qn(L.get(G+1,$),L.get(G+1,$+1),V-$),O-G)}getAtTileOffset(t,e,n){const a=1<<t.canonical.z;return this.getAtPointOrZero(new Lo(t.wrap+(t.canonical.x+e/ji)/a,(t.canonical.y+n/ji)/a))}getAtTileOffsetFunc(t,e,n,a){return l=>{const u=this.getAtTileOffset(t,l.x,l.y),d=a.upVector(t.canonical,l.x,l.y),x=a.upVectorScale(t.canonical,e,n).metersToTile;return s._.scale(d,d,u*x),d}}getForTilePoints(t,e,n,a){if(this.isUsingMockSource())return!1;const l=Pm.create(this,t,a);return!!l&&(e.forEach(u=>{u[2]=this.exaggeration()*l.getElevationAt(u[0],u[1],n)}),!0)}getMinMaxForTile(t){if(this.isUsingMockSource())return null;const e=this.findDEMTileFor(t);if(!e||!e.dem)return null;const n=e.dem.tree,a=e.tileID,l=1<<t.canonical.z-a.canonical.z;let u=t.canonical.x/l-a.canonical.x,d=t.canonical.y/l-a.canonical.y,x=0;for(let v=0;v<t.canonical.z-a.canonical.z&&!n.leaves[x];v++){u*=2,d*=2;const S=2*Math.floor(d)+Math.floor(u);x=n.childOffsets[x]+S,u%=1,d%=1}return{min:this.exaggeration()*n.minimums[x],max:this.exaggeration()*n.maximums[x]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(t,e,n){throw new Error("Pure virtual method called.")}pointCoordinate(t){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(t){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const t=this.visibleDemTiles;if(t.length===0)return null;let e=!1,n=Number.MAX_VALUE,a=Number.MIN_VALUE;for(const l of t){const u=this.getMinMaxForTile(l.tileID);u&&(n=Math.min(n,u.min),a=Math.max(a,u.max),e=!0)}return e?{min:n,max:a}:null}},s.br=Vi,s.bs=vn,s.bt=Fl,s.bu=no,s.bv=hf,s.bw=jm,s.bx=Xy,s.by=Uy,s.bz=Ng,s.c=qw,s.c$=tc,s.c0=450,s.c1=7,s.c2=rL,s.c3=_w,s.c4=256,s.c5=wt,s.c6=di,s.c7=rr,s.c8=kl,s.c9=hu,s.cA=function(t){let e=1/0,n=1/0,a=-1/0,l=-1/0;for(const u of t)e=Math.min(e,u.x),n=Math.min(n,u.y),a=Math.max(a,u.x),l=Math.max(l,u.y);return{min:new Kt(e,n),max:new Kt(a,l)}},s.cB=z,s.cC=rf,s.cD=_a,s.cE=["type","source","source-layer","minzoom","maxzoom","filter","layout"],s.cF=jb,s.cG=kg,s.cH=G1,s.cI=H1,s.cJ=ax,s.cK=Px,s.cL=function(t){return t({pluginStatus:Qt,pluginURL:xn}),cr.on("pluginStateChange",t),t},s.cM=km,s.cN=sx,s.cO=Gh,s.cP=Tr,s.cQ=ve,s.cR=oo,s.cS=Fu,s.cT=po,s.cU=function(t){const e=t.indexOf(Bc);return e>=0?t.slice(0,e):t},s.cV=function(t){return t.indexOf(Bc)>=0},s.cW=function(t){const e=t.indexOf(Bc);return e>=0?t.slice(e+1):""},s.cX=function(t){const e=[],n=t.id;return n===void 0&&e.push({message:`layers.${n}: missing required property "id"`}),t.render===void 0&&e.push({message:`layers.${n}: missing required method "render"`}),t.renderingMode&&t.renderingMode!=="2d"&&t.renderingMode!=="3d"&&e.push({message:`layers.${n}: property "renderingMode" must be either "2d" or "3d"`}),e},s.cY=function(t,e,n,a){return t.type==="custom"?new aL(t,e):new kL[t.type](t,e,n,a)},s.cZ=nh,s.c_=cr,s.ca=1,s.cb=Kg,s.cc=0,s.cd=um,s.ce=function(t,e,n,a,l){return pn((t-e)/(n-e)*(l-a)+a,a,l)},s.cf=$o,s.cg=du,s.ch=class{constructor(t,e,n,a){this.context=t,this.format=a,this.size=n,this.texture=t.gl.createTexture();const[l,u,d]=this.size,{gl:x}=t;x.bindTexture(x.TEXTURE_3D,this.texture),t.pixelStoreUnpackFlipY.set(!1),t.pixelStoreUnpack.set(1),t.pixelStoreUnpackPremultiplyAlpha.set(!1);let v=this.format,S=x.UNSIGNED_BYTE;this.format===x.DEPTH_COMPONENT&&(v=x.DEPTH_COMPONENT16,S=x.UNSIGNED_SHORT),this.format===x.R8&&(a=x.RED),this.format===x.R32F&&(S=x.FLOAT,a=x.RED),x.texImage3D(x.TEXTURE_3D,0,v,l,u,d,0,a,S,e.data)}bind(t,e){const{context:n}=this,{gl:a}=n;a.bindTexture(a.TEXTURE_3D,this.texture),t!==this.minFilter&&(a.texParameteri(a.TEXTURE_3D,a.TEXTURE_MAG_FILTER,t),a.texParameteri(a.TEXTURE_3D,a.TEXTURE_MIN_FILTER,t),this.minFilter=t),e!==this.wrapS&&(a.texParameteri(a.TEXTURE_3D,a.TEXTURE_WRAP_S,e),a.texParameteri(a.TEXTURE_3D,a.TEXTURE_WRAP_T,e),this.wrapS=e)}destroy(){const{gl:t}=this.context;t.deleteTexture(this.texture),this.texture=null}},s.ci=bx,s.cj=[1,1,1],s.ck=Pm,s.cl=Hm,s.cm=Gc,s.cn=Hc,s.co=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new Kt(1/0,1/0),max:new Kt(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(t,e=!1){const n=N1(new Kt(0,0),new Kt(ji,ji),t),a=[];if(e&&!$0(n,this._globalClipBounds))return a;for(const l of this._activeRegions){if(l.hiddenByOverlap||!$0(n,l))continue;const u=sC(l.min,l.max,t);a.push({min:u.min,max:u.max,sourceId:this._sourceIds[l.priority],footprint:l.footprint,footprintTileId:l.tileId,order:l.order,clipMask:l.clipMask})}return a}setSources(t){this._setSources(t.map(e=>({getSourceId:()=>e.cache.id,getFootprints:()=>{const n=[];for(const a of e.cache.getVisibleCoordinates()){const l=e.cache.getTile(a).buckets[e.layer];l&&l.updateFootprints(a.toUnwrapped(),n)}return n},getOrder:()=>e.order,getClipMask:()=>e.clipMask})))}_addSource(t){const e=t.getFootprints();if(e.length===0)return;const n=t.getOrder(),a=t.getClipMask();for(const l of e){if(!l.footprint)continue;const u=N1(l.footprint.min,l.footprint.max,l.id);this._activeRegions.push({min:u.min,max:u.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:l.id,footprint:l.footprint,order:n,clipMask:a})}this._sourceIds.push(t.getSourceId())}_computeReplacement(){this._activeRegions.sort((e,n)=>e.priority-n.priority||_y(e.min,n.min)||_y(e.max,n.max));let t=this._activeRegions.length!==this._prevRegions.length;if(!t){let e=0;for(;!t&&e!==this._activeRegions.length;){const n=this._activeRegions[e],a=this._prevRegions[e];t=n.priority!==a.priority||!B1(n,a)||n.order!==a.order||n.clipMask!==a.clipMask,++e}}if(t){++this._updateTime;for(const n of this._activeRegions)n.order!==1/0&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,n.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,n.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,n.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,n.max.y));const e=n=>{const a=this._activeRegions;if(n>=a.length)return n;const l=a[n].priority;for(;n<a.length&&a[n].priority===l;)++n;return n};if(this._sourceIds.length>1){let n=0,a=e(n);for(;n!==a;){let l=n;const u=n;for(;l!==a;){const d=this._activeRegions[l];d.hiddenByOverlap=!1;for(let x=0;x<u;x++){const v=this._activeRegions[x];if(!v.hiddenByOverlap&&d.order===1/0&&$0(d,v)&&(d.hiddenByOverlap=V1(d.footprint,d.tileId,v.footprint,v.tileId),d.hiddenByOverlap))break}++l}n=a,a=e(n)}}}}_setSources(t){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let e=t.length-1;e>=0;e--)this._addSource(t[e]);this._computeReplacement()}},s.cp=Sh,s.cq=Ny,s.cr=Da,s.cs=class{constructor(t){this._createGrid(t),this._createPoles(t)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const t of this._poleSegments)t.destroy();for(const t of this._gridSegments)t.withSkirts.destroy(),t.withoutSkirts.destroy()}_fillGridMeshWithLods(t,e){const n=new Fl,a=new no,l=[],u=t+1+2,d=e[0]+1,x=e[0]+1+(1+e.length),v=(S,L,P)=>{let O=S===u-1?S-2:S===0?S:S-1;return O+=P?24575:0,[O,L]};for(let S=0;S<u;++S)n.emplaceBack(...v(S,0,!0));for(let S=0;S<d;++S)for(let L=0;L<u;++L)n.emplaceBack(...v(L,S,(L===0||L===u-1)&&!0));for(let S=0;S<e.length;++S){const L=e[S];for(let P=0;P<u;++P)n.emplaceBack(...v(P,L,!0))}for(let S=0;S<e.length;++S){const L=a.length,P=e[S]+1+2,O=new no;for(let $=0;$<P-1;$++){const Y=$===P-2,ne=Y?u*(x-e.length+S-$):u;for(let Te=0;Te<u-1;Te++){const Ae=$*u+Te;$===0||Y||Te===0||Te===u-2?(O.emplaceBack(Ae+1,Ae,Ae+ne),O.emplaceBack(Ae+ne,Ae+ne+1,Ae+1)):(a.emplaceBack(Ae+1,Ae,Ae+ne),a.emplaceBack(Ae+ne,Ae+ne+1,Ae+1))}}const V=Ts.simpleSegment(0,L,n.length,a.length-L);for(let $=0;$<O.uint16.length;$+=3)a.emplaceBack(O.uint16[$],O.uint16[$+1],O.uint16[$+2]);const G=Ts.simpleSegment(0,L,n.length,a.length-L);l.push({withoutSkirts:V,withSkirts:G})}return{vertices:n,indices:a,segments:l}}_createGrid(t){const e=this._fillGridMeshWithLods(ep,Lg);this._gridSegments=e.segments,this._gridBuffer=t.createVertexBuffer(e.vertices,Vi.members),this._gridIndexBuffer=t.createIndexBuffer(e.indices,!0)}_createPoles(t){const e=new no;for(let d=0;d<=ep;d++)e.emplaceBack(0,d+1,d+2);this._poleIndexBuffer=t.createIndexBuffer(e,!0);const n=new hu,a=new hu,l=new hu,u=new hu;this._poleSegments=[];for(let d=0,x=0;d<tf;d++){const v=360/(1<<d);n.emplaceBack(0,-_a,0,.5,0),a.emplaceBack(0,-_a,0,.5,1),l.emplaceBack(0,-_a,0,.5,.5),u.emplaceBack(0,-_a,0,.5,.5);for(let S=0;S<=ep;S++){let L=S/ep,P=0;const O=Qn(0,v,L),[V,G,$]=tp(Xr,Ko,O,_a);n.emplaceBack(V,G,$,L,P),a.emplaceBack(V,G,$,L,1-P);const Y=Pn(O);L=.5+.5*Math.sin(Y),P=.5+.5*Math.cos(Y),l.emplaceBack(V,G,$,L,P),u.emplaceBack(V,G,$,L,1-P)}this._poleSegments.push(Ts.simpleSegment(x,0,66,64)),x+=66}this._poleNorthVertexBuffer=t.createVertexBuffer(n,In,!1),this._poleSouthVertexBuffer=t.createVertexBuffer(a,In,!1),this._texturedPoleNorthVertexBuffer=t.createVertexBuffer(l,In,!1),this._texturedPoleSouthVertexBuffer=t.createVertexBuffer(u,In,!1)}getGridBuffers(t,e){return[this._gridBuffer,this._gridIndexBuffer,e?this._gridSegments[t].withSkirts:this._gridSegments[t].withoutSkirts]}getPoleBuffers(t,e){return[e?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,e?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[t]]}},s.ct=function(t){return sc.has(t)},s.cu=J1,s.cv=function(t,e,n=0,a=!0){const l=new Kt(n,n),u=t.sub(l),d=e.add(l),x=[u,new Kt(d.x,u.y),d,new Kt(u.x,d.y)];return a&&x.push(u.clone()),x},s.cw=function(t,e){const n=[];for(let a=0;a<t.length;a++){const l=To(a-1,-1,t.length-1),u=To(a+1,-1,t.length-1),d=t[a],x=t[u],v=t[l].sub(d).unit(),S=x.sub(d).unit(),L=S.angleWithSep(v.x,v.y),P=v.add(S).unit().mult(-1*e/Math.sin(L/2));n.push(d.add(P))}return n},s.cx=tw,s.cy=F,s.cz=function(t,e,n=0){return s._.fromValues(((e.x-n)*t.scale-t.x)*ji,(e.y*t.scale-t.y)*ji,Rg(e.z,e.y))},s.d=Na,s.d$=Bi,s.d0=yr,s.d1=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},s.d2=Ks,s.d3=zg,s.d4=us,s.d5=function([t,e,n]){const a=Math.hypot(t,e,n),l=Math.atan2(t,n),u=.5*Math.PI-Math.acos(-e/a);return new Gr(_r(l),_r(u))},s.d6=oa,s.d7=cd,s.d8=Q,s.d9=sr,s.dA=function(t){const e=tl();if(!e)return;const n=e.delete(Vh);t&&n.catch(t).then(()=>t())},s.dB=r_,s.dC=kw,s.dD=function(t){Ex=mo.resolveURL(t),qm||(qm=new jm(Xy(),new oc)),qm.broadcast("setDracoUrl",Ex)},s.dE=Bw,s.dF=function(t){Wm=mo.resolveURL(t),qm||(qm=new jm(Xy(),new oc)),qm.broadcast("setMeshoptUrl",Wm)},s.dG=ua,s.dH=xe,s.dI=Fo,s.dJ=zh,s.dK=lf,s.dL=mm,s.dM=Mb,s.dN=Ib,s.dO=gb,s.dP=qo,s.dQ=qb,s.dR=Vm,s.dS=function(t,e,n,a,l,u,d,x,v,S,L){t.createArrays(),t.tilePixelRatio=ji/(512*t.overscaling),t.compareText={},t.iconsNeedLinear=!1;const P=t.layers[0].layout,O=t.layers[0]._unevaluatedLayout._values,V={};if(t.textSizeData.kind==="composite"){const{minZoom:ne,maxZoom:Te}=t.textSizeData;V.compositeTextSizes=[O["text-size"].possiblyEvaluate(new ir(ne),x),O["text-size"].possiblyEvaluate(new ir(Te),x)]}if(t.iconSizeData.kind==="composite"){const{minZoom:ne,maxZoom:Te}=t.iconSizeData;V.compositeIconSizes=[O["icon-size"].possiblyEvaluate(new ir(ne),x),O["icon-size"].possiblyEvaluate(new ir(Te),x)]}V.layoutTextSize=O["text-size"].possiblyEvaluate(new ir(v+1),x),V.layoutIconSize=O["icon-size"].possiblyEvaluate(new ir(v+1),x),V.textMaxSize=O["text-size"].possiblyEvaluate(new ir(18),x);const G=P.get("text-rotation-alignment")==="map"&&P.get("symbol-placement")!=="point",$=P.get("text-size");let Y=!1;for(const ne of t.features)if(ne.icon&&ne.icon.nameSecondary){Y=!0;break}for(const ne of t.features){const Te=P.get("text-font").evaluate(ne,{},x).join(","),Ae=$.evaluate(ne,{},x),Ce=V.layoutTextSize.evaluate(ne,{},x),qe=(V.layoutIconSize.evaluate(ne,{},x),{horizontal:{},vertical:void 0}),Ge=ne.text;let ot,dt=[0,0];if(Ge){const Vt=Ge.toString(),ai=P.get("text-letter-spacing").evaluate(ne,{},x)*aa,Ci=P.get("text-line-height").evaluate(ne,{},x)*aa,ti=mi(Vt)?ai:0,bi=P.get("text-anchor").evaluate(ne,{},x),Yt=P.get("text-variable-anchor");if(!Yt){const Ii=P.get("text-radial-offset").evaluate(ne,{},x);dt=Ii?Jb(bi,[Ii*aa,ox]):P.get("text-offset").evaluate(ne,{},x).map(Ui=>Ui*aa)}let wi=G?"center":P.get("text-justify").evaluate(ne,{},x);const zi=P.get("symbol-placement")==="point",Si=zi?P.get("text-max-width").evaluate(ne,{},x)*aa:1/0,fn=Ii=>{t.allowVerticalPlacement&&Nt(Vt)&&(qe.vertical=ix(Ge,e,n,l,Te,Si,Ci,bi,Ii,ti,dt,_c.vertical,!0,Ce,Ae))};if(!G&&Yt){const Ii=wi==="auto"?Yt.map(qn=>ax(qn)):[wi];let Ui=!1;for(let qn=0;qn<Ii.length;qn++){const Fn=Ii[qn];if(!qe.horizontal[Fn])if(Ui)qe.horizontal[Fn]=qe.horizontal[0];else{const Rn=ix(Ge,e,n,l,Te,Si,Ci,"center",Fn,ti,dt,_c.horizontal,!1,Ce,Ae);Rn&&(qe.horizontal[Fn]=Rn,Ui=Rn.positionedLines.length===1)}}fn("left")}else{if(wi==="auto"&&(wi=ax(bi)),zi||P.get("text-writing-mode").indexOf("horizontal")>=0||!Nt(Vt)){const Ii=ix(Ge,e,n,l,Te,Si,Ci,bi,wi,ti,dt,_c.horizontal,!1,Ce,Ae);Ii&&(qe.horizontal[wi]=Ii)}fn(zi?"left":wi)}}let Rt=!1;if(ne.icon&&ne.icon.namePrimary){const Vt=a[ne.icon.namePrimary];Vt&&(ot=s3(l[ne.icon.namePrimary],ne.icon.nameSecondary?l[ne.icon.nameSecondary]:void 0,P.get("icon-offset").evaluate(ne,{},x),P.get("icon-anchor").evaluate(ne,{},x)),Rt=Vt.sdf,t.sdfIcons===void 0?t.sdfIcons=Vt.sdf:t.sdfIcons!==Vt.sdf&&Is("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Vt.pixelRatio!==t.pixelRatio||P.get("icon-rotate").constantOr(1)!==0)&&(t.iconsNeedLinear=!0))}const $t=Qb(qe.horizontal)||qe.vertical;t.iconsInText||(t.iconsInText=!!$t&&$t.iconsInText),($t||ot)&&d3(t,ne,qe,ot,a,V,Ce,0,dt,Rt,d,x,S,L,Y)}u&&t.generateCollisionDebugBuffers(v,t.collisionBoxArray)},s.dT=by,s.dU=py,s.dV=X0,s.dW=zm,s.dX=yy,s.dY=_x,s.dZ=my,s.d_=fy,s.da=Sr,s.db=function(t){const e=[0,0,0],n=s.ad.identity(new Float64Array(16));return s.ad.multiply(n,t.pixelMatrix,t.globeMatrix),s._.transformMat4(e,e,n),new Kt(e[0],e[1])},s.dc=Mt,s.dd=He,s.de=function(t){const e=t.navigator?t.navigator.userAgent:null;return!!function(n){if(Al==null){const a=n.navigator?n.navigator.userAgent:null;Al=!!n.safari||!(!a||!(/\b(iPad|iPhone|iPod)\b/.test(a)||a.match("Safari")&&!a.match("Chrome")))}return Al}(t)&&e&&(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))},s.df=Xs,s.dg=class{constructor(t,e,n){this._transformRequestFn=t,this._customAccessToken=e,this._silenceAuthErrors=!!n,this._createSkuToken()}_createSkuToken(){const t=function(){let e="";for(let n=0;n<10;n++)e+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",wp,e].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,e){return this._transformRequestFn&&this._transformRequestFn(t,e)||{url:t}}normalizeStyleURL(t,e){if(!ve(t))return t;const n=nl(t);return n.params.push(`sdk=js-${Z}`),n.path=`/styles/v1${n.path}`,this._makeAPIURL(n,this._customAccessToken||e)}normalizeGlyphsURL(t,e){if(!ve(t))return t;const n=nl(t);return n.path=`/fonts/v1${n.path}`,this._makeAPIURL(n,this._customAccessToken||e)}normalizeModelURL(t,e){if(!ve(t))return t;const n=nl(t);return n.path=`/models/v1${n.path}`,this._makeAPIURL(n,this._customAccessToken||e)}normalizeSourceURL(t,e,n,a){if(!ve(t))return t;const l=nl(t);return l.path=`/v4/${l.authority}.json`,l.params.push("secure"),n&&l.params.push(`language=${n}`),a&&l.params.push(`worldview=${a}`),this._makeAPIURL(l,this._customAccessToken||e)}normalizeSpriteURL(t,e,n,a){const l=nl(t);return ve(t)?(l.path=`/styles/v1${l.path}/sprite${e}${n}`,this._makeAPIURL(l,this._customAccessToken||a)):(l.path+=`${e}${n}`,ch(l))}normalizeTileURL(t,e,n){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!ve(t))return t;const a=nl(t);a.path=a.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${e||n&&a.authority!=="raster"&&n===512?"@2x":""}${Cl.supported?".webp":"$1"}`),a.authority==="raster"?a.path=`/${Q.RASTER_URL_PREFIX}${a.path}`:a.authority==="rasterarrays"?a.path=`/${Q.RASTERARRAYS_URL_PREFIX}${a.path}`:a.authority==="3dtiles"?a.path=`/${Q.TILES3D_URL_PREFIX}${a.path}`:(a.path=a.path.replace(/^.+\/v4\//,"/"),a.path=`/${Q.TILE_URL_VERSION}${a.path}`);const l=this._customAccessToken||function(u){for(const d of u){const x=d.match(/^access_token=(.*)$/);if(x)return x[1]}return null}(a.params)||Q.ACCESS_TOKEN;return Q.REQUIRE_ACCESS_TOKEN&&l&&this._skuToken&&a.params.push(`sku=${this._skuToken}`),this._makeAPIURL(a,l)}canonicalizeTileURL(t,e){const n=nl(t);if(!n.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!n.path.match(/\.[\w]+$/))return t;let a="mapbox://";n.path.match(/^\/raster\/v1\//)?a+=`raster/${n.path.replace(`/${Q.RASTER_URL_PREFIX}/`,"")}`:n.path.match(/^\/rasterarrays\/v1\//)?a+=`rasterarrays/${n.path.replace(`/${Q.RASTERARRAYS_URL_PREFIX}/`,"")}`:a+=`tiles/${n.path.replace(`/${Q.TILE_URL_VERSION}/`,"")}`;let l=n.params;return e&&(l=l.filter(u=>!u.match(/^access_token=/))),l.length&&(a+=`?${l.join("&")}`),a}canonicalizeTileset(t,e){const n=!!e&&ve(e),a=[];for(const l of t.tiles||[])oe(l)?a.push(this.canonicalizeTileURL(l,n)):a.push(l);return a}_makeAPIURL(t,e){const n="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",a=nl(Q.API_URL);if(t.protocol=a.protocol,t.authority=a.authority,t.protocol==="http"){const l=t.params.indexOf("secure");l>=0&&t.params.splice(l,1)}if(a.path!=="/"&&(t.path=`${a.path}${t.path}`),!Q.REQUIRE_ACCESS_TOKEN)return ch(t);if(e=e||Q.ACCESS_TOKEN,!this._silenceAuthErrors){if(!e)throw new Error(`An API access token is required to use Mapbox GL. ${n}`);if(e[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${n}`)}return t.params=t.params.filter(l=>l.indexOf("access_token")===-1),t.params.push(`access_token=${e||""}`),ch(t)}},s.dh=function(t,e){e?sc.add(t):sc.delete(t)},s.di=Cl,s.dj=zu,s.dk=Tp,s.dl=Mp,s.dm=Ed,s.dn=Du,s.dp=function(t){sc.delete(t)},s.dq=rc,s.dr=Ru,s.ds=Ds,s.dt=Z,s.du=function(t,e){el=t,ah=e},s.dv=function(t,e,n=!1){if(Qt===Yi||Qt===hn||Qt===Ji)throw new Error("setRTLTextPlugin cannot be called multiple times.");xn=mo.resolveURL(t),Qt=Yi,Gi=e,Wn(),n||xs()},s.dw=er,s.dx=function(){Xy().acquire(Sx)},s.dy=function(){const t=o_;t&&(t.isPreloaded()&&t.numActive()===1?(t.release(Sx),o_=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},s.dz=s_,s.e=mo,s.e0=Tb,s.e1=Ut,s.e2=ic,s.e3=function(t){let e=0;if(new Uint32Array(t,0,1)[0]!==Uw){const n=new Uint32Array(t,0,7),[,,a,l,u,d]=n;e=n.byteLength+l+u+d+u,(a!==t.byteLength||e>=t.byteLength)&&Is("Invalid b3dm header information.")}return jw(t,e)},s.e4=function(t,e){const n=qw(t);for(const a of n){for(const l of a.meshes)DL(l);a.lights&&(a.lightMeshIndex=a.meshes.length,a.meshes.push(zL(a.lights,e)))}return n},s.e5=Ky,s.e6=Fw,s.e7=zr,s.e8=function(t){Ql(),$s&&$s.then(e=>{e.keys().then(n=>{for(let a=0;a<n.length-t;a++)e.delete(n[a])})})},s.f=pa,s.g=function(t,e){return tc(Ls(t,{type:"json"}),e)},s.h=Ta,s.i=$a,s.j=Wb,s.k=rx,s.l=function(t){return fetch(t).then(e=>e.arrayBuffer()).then(e=>jw(e,0,t))},s.m=class extends qy{},s.n=dh,s.o=ku,s.p=S3,s.q=nd,s.r=r,s.s=h,s.t=ee,s.u=ao,s.v=yo,s.w=Is,s.x=fe,s.y=ie,s.z=Pl}),U(["./shared"],function(s){function Z(at){const se=at?at.url.toString():void 0;return se?performance.getEntriesByName(se):[]}function j(at){if(typeof at=="number"||typeof at=="boolean"||typeof at=="string"||at==null)return JSON.stringify(at);if(Array.isArray(at)){let me="[";for(const Oe of at)me+=`${j(Oe)},`;return`${me}]`}let se="{";for(const me of Object.keys(at).sort())se+=`${me}:${j(at[me])},`;return`${se}}`}function Q(at){let se="";for(const me of s.cE)se+=`/${j(at[me])}`;return se}class oe{constructor(se){this.keyCache={},this._layers={},this._layerConfigs={},se&&this.replace(se)}replace(se,me){this._layerConfigs={},this._layers={},this.update(se,[],me)}update(se,me,Oe){this._options=Oe;for(const tt of se)this._layerConfigs[tt.id]=tt,(this._layers[tt.id]=s.cY(tt,this.scope,null,this._options)).compileFilter(),this.keyCache[tt.id]&&delete this.keyCache[tt.id];for(const tt of me)delete this.keyCache[tt],delete this._layerConfigs[tt],delete this._layers[tt];this.familiesBySource={};const Ke=function(tt,At){const Ft={};for(let jt=0;jt<tt.length;jt++){const Oi=At&&At[tt[jt].id]||Q(tt[jt]);At&&(At[tt[jt].id]=Oi);let Mi=Ft[Oi];Mi||(Mi=Ft[Oi]=[]),Mi.push(tt[jt])}const yt=[];for(const jt in Ft)yt.push(Ft[jt]);return yt}(s.dG(this._layerConfigs),this.keyCache);for(const tt of Ke){const At=tt.map(wn=>this._layers[wn.id]),Ft=At[0];if(Ft.visibility==="none")continue;const yt=Ft.source||"";let jt=this.familiesBySource[yt];jt||(jt=this.familiesBySource[yt]={});const Oi=Ft.sourceLayer||"_geojsonTileLayer";let Mi=jt[Oi];Mi||(Mi=jt[Oi]=[]),Mi.push(At)}}}const ve=1*s.dJ;class Ee{constructor(se){const me={},Oe=[];for(const Ft in se){const yt=se[Ft],jt=me[Ft]={};for(const Oi in yt.glyphs){const Mi=yt.glyphs[+Oi];if(!Mi||Mi.bitmap.width===0||Mi.bitmap.height===0)continue;const wn=Mi.metrics.localGlyph?ve:1,Bn={x:0,y:0,w:Mi.bitmap.width+2*wn,h:Mi.bitmap.height+2*wn};Oe.push(Bn),jt[Oi]=Bn}}const{w:Ke,h:tt}=s.j(Oe),At=new s.dI({width:Ke||1,height:tt||1});for(const Ft in se){const yt=se[Ft];for(const jt in yt.glyphs){const Oi=yt.glyphs[+jt];if(!Oi||Oi.bitmap.width===0||Oi.bitmap.height===0)continue;const Mi=me[Ft][jt],wn=Oi.metrics.localGlyph?ve:1;s.dI.copy(Oi.bitmap,At,{x:0,y:0},{x:Mi.x+wn,y:Mi.y+wn},Oi.bitmap)}}this.image=At,this.positions=me}}s.dH(Ee,"GlyphAtlas");class We{constructor(se){this.tileID=new s.aL(se.tileID.overscaledZ,se.tileID.wrap,se.tileID.canonical.z,se.tileID.canonical.x,se.tileID.canonical.y),this.tileZoom=se.tileZoom,this.uid=se.uid,this.zoom=se.zoom,this.lut=se.lut,this.canonical=se.tileID.canonical,this.pixelRatio=se.pixelRatio,this.tileSize=se.tileSize,this.source=se.source,this.scope=se.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=se.showCollisionBoxes,this.collectResourceTiming=!!se.collectResourceTiming,this.promoteId=se.promoteId,this.isSymbolTile=se.isSymbolTile,this.tileTransform=s.dK(se.tileID.canonical,se.projection),this.projection=se.projection,this.brightness=se.brightness,this.extraShadowCaster=!!se.extraShadowCaster,this.tessellationStep=se.tessellationStep}parse(se,me,Oe,Ke,tt){this.status="parsing",this.data=se,this.collisionBoxArray=new s.dL;const At=new s.dM(Object.keys(se.layers).sort()),Ft=new s.dN(this.tileID,this.promoteId);Ft.bucketLayerIDs=[];const yt={},jt=new s.dO(256,256),Oi={featureIndex:Ft,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:jt,availableImages:Oe,brightness:this.brightness},Mi=me.familiesBySource[this.source];for(const bn in Mi){const as=se.layers[bn];if(!as)continue;let Vr=!1,br=!1,Mn=!1;for(const Cs of Mi[bn])Cs[0].type==="symbol"?Vr=!0:br=!0,Cs[0].is3D()&&Cs[0].type!=="model"&&(Mn=!0);if(this.extraShadowCaster&&!Mn||this.isSymbolTile===!0&&!Vr||this.isSymbolTile===!1&&!br)continue;as.version===1&&s.w(`Vector tile source "${this.source}" layer "${bn}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Wr=At.encode(bn),ss=[];for(let Cs=0;Cs<as.length;Cs++){const uo=as.feature(Cs),bo=Ft.getId(uo,bn);ss.push({feature:uo,id:bo,index:Cs,sourceLayerIndex:Wr})}for(const Cs of Mi[bn]){const uo=Cs[0];(!this.extraShadowCaster||uo.is3D()&&uo.type!=="model")&&(this.isSymbolTile!==void 0&&uo.type==="symbol"!==this.isSymbolTile||uo.minzoom&&this.zoom<Math.floor(uo.minzoom)||uo.maxzoom&&this.zoom>=uo.maxzoom||uo.visibility!=="none"&&(Re(Cs,this.zoom,Oi.brightness,Oe),(yt[uo.id]=uo.createBucket({index:Ft.bucketLayerIDs.length,layers:Cs,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Wr,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep})).populate(ss,Oi,this.tileID.canonical,this.tileTransform),Ft.bucketLayerIDs.push(Cs.map(bo=>bo.id))))}}let wn,Bn,Vn,lr;jt.trim();const jn={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},fr=()=>{if(wn)return this.status="done",tt(wn);if(this.extraShadowCaster)this.status="done",tt(null,{buckets:s.dG(yt).filter(bn=>!bn.isEmpty()),featureIndex:Ft,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:Oi.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(Bn&&Vn&&lr){const bn=new Ee(Bn),as=new s.dQ(Vn,lr,this.lut);for(const Vr in yt){const br=yt[Vr];br instanceof s.dR?(Re(br.layers,this.zoom,Oi.brightness,Oe),s.dS(br,Bn,bn.positions,Vn,as.iconPositions,this.showCollisionBoxes,Oe,this.tileID.canonical,this.tileZoom,this.projection,this.brightness)):br.hasPattern&&(br instanceof s.dT||br instanceof s.dU||br instanceof s.b_)&&(Re(br.layers,this.zoom,Oi.brightness,Oe),br.addFeatures(Oi,this.tileID.canonical,as.patternPositions,Oe,this.tileTransform,this.brightness))}this.status="done",tt(null,{buckets:s.dG(yt).filter(Vr=>!Vr.isEmpty()),featureIndex:Ft,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:bn.image,lineAtlas:jt,imageAtlas:as,brightness:Oi.brightness})}};if(!this.extraShadowCaster){const bn=s.dP(Oi.glyphDependencies,br=>Object.keys(br).map(Number));Object.keys(bn).length?Ke.send("getGlyphs",{uid:this.uid,stacks:bn,scope:this.scope},(br,Mn)=>{wn||(wn=br,Bn=Mn,fr())},void 0,!1,jn):Bn={};const as=Object.keys(Oi.iconDependencies);as.length?Ke.send("getImages",{icons:as,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(br,Mn)=>{wn||(wn=br,Vn=Mn,fr())},void 0,!1,jn):Vn={};const Vr=Object.keys(Oi.patternDependencies);Vr.length?Ke.send("getImages",{icons:Vr,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(br,Mn)=>{wn||(wn=br,lr=Mn,fr())},void 0,!1,jn):lr={}}fr()}}function Re(at,se,me,Oe){const Ke=new s.X(se,{brightness:me});for(const tt of at)tt.recalculate(Ke,Oe)}class He extends s.E{constructor(se,me,Oe,Ke,tt,At){super(),this.actor=se,this.layerIndex=me,this.availableImages=Oe,this.loadVectorData=tt||s.ap,this.loading={},this.loaded={},this.deduped=new s.ao(se.scheduler),this.isSpriteLoaded=Ke,this.scheduler=se.scheduler,this.brightness=At}loadTile(se,me){const Oe=se.uid,Ke=se&&se.request,tt=Ke&&Ke.collectResourceTiming,At=this.loading[Oe]=new We(se);At.abort=this.loadVectorData(se,(Ft,yt)=>{const jt=!this.loading[Oe];if(delete this.loading[Oe],jt||Ft||!yt)return At.status="done",jt||(this.loaded[Oe]=At),me(Ft);const Oi=yt.rawData,Mi={};yt.expires&&(Mi.expires=yt.expires),yt.cacheControl&&(Mi.cacheControl=yt.cacheControl),At.vectorTile=yt.vectorTile||new s.dV(new s.dW(Oi));const wn=()=>{At.parse(At.vectorTile,this.layerIndex,this.availableImages,this.actor,(Bn,Vn)=>{if(Bn||!Vn)return me(Bn);const lr={};if(tt){const jn=Z(Ke);jn.length>0&&(lr.resourceTiming=JSON.parse(JSON.stringify(jn)))}me(null,s.W({rawTileData:Oi.slice(0)},Vn,Mi,lr))})};this.isSpriteLoaded?wn():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(wn,{type:"parseTile",isSymbolTile:se.isSymbolTile,zoom:se.tileZoom}):wn()}),this.loaded=this.loaded||{},this.loaded[Oe]=At})}reloadTile(se,me){const Oe=this.loaded,Ke=se.uid;if(Oe&&Oe[Ke]){const tt=Oe[Ke];tt.showCollisionBoxes=se.showCollisionBoxes,tt.projection=se.projection,tt.brightness=se.brightness,tt.tileTransform=s.dK(se.tileID.canonical,se.projection),tt.extraShadowCaster=se.extraShadowCaster,tt.lut=se.lut;const At=(Ft,yt)=>{const jt=tt.reloadCallback;jt&&(delete tt.reloadCallback,tt.parse(tt.vectorTile,this.layerIndex,this.availableImages,this.actor,jt)),me(Ft,yt)};tt.status==="parsing"?tt.reloadCallback=At:tt.status==="done"&&(tt.vectorTile?tt.parse(tt.vectorTile,this.layerIndex,this.availableImages,this.actor,At):At())}else me(null,void 0)}abortTile(se,me){const Oe=se.uid,Ke=this.loading[Oe];Ke&&(Ke.abort&&Ke.abort(),delete this.loading[Oe]),me()}removeTile(se,me){const Oe=this.loaded,Ke=se.uid;Oe&&Oe[Ke]&&delete Oe[Ke],me()}}class Mt{loadTile(se,me){const{uid:Oe,encoding:Ke,rawImageData:tt,padding:At}=se,Ft=ImageBitmap&&tt instanceof ImageBitmap?this.getImageData(tt,At):tt;me(null,new s.dX(Oe,Ft,Ke,At<1))}getImageData(se,me){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(se.width,se.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=se.width,this.offscreenCanvas.height=se.height,this.offscreenCanvasContext.drawImage(se,0,0,se.width,se.height);const Oe=this.offscreenCanvasContext.getImageData(-me,-me,se.width+2*me,se.height+2*me);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),Oe}}class Lt{decodeRasterArray({task:se,buffer:me},Oe){s.dY.performDecoding(me,se).then(Ke=>{Oe(null,Ke)},Ke=>{Oe(Ke)})}}const Ut=s.dZ.prototype.toGeoJSON;let Wt=class{constructor(at){this._feature=at,this.extent=s.a3,this.type=at.type,this.properties=at.tags,"id"in at&&!isNaN(at.id)&&(this.id=parseInt(at.id,10))}loadGeometry(){if(this._feature.type===1){const at=[];for(const se of this._feature.geometry)at.push([new s.P(se[0],se[1])]);return at}{const at=[];for(const se of this._feature.geometry){const me=[];for(const Oe of se)me.push(new s.P(Oe[0],Oe[1]));at.push(me)}return at}}toGeoJSON(at,se,me){return Ut.call(this,at,se,me)}},lt=class{constructor(at){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=s.a3,this.length=at.length,this._features=at}feature(at){return new Wt(this._features[at])}};const Ct=64/4096;class qt{constructor(){this.features=new Map}clear(){this.features.clear()}load(se=[],me){for(const Oe of se){const Ke=Oe.id;if(Ke==null)continue;let tt=this.features.get(Ke);tt&&this.updateCache(tt,me),Oe.geometry?(tt=Ni(Oe),this.updateCache(tt,me),this.features.set(Ke,tt)):this.features.delete(Ke),this.updateCache(tt,me)}}updateCache(se,me){for(const{canonical:Oe,uid:Ke}of Object.values(me)){const{z:tt,x:At,y:Ft}=Oe;Ai(se,Math.pow(2,tt),At,Ft)&&delete me[Ke]}}getTile(se,me,Oe){const Ke=Math.pow(2,se),tt=[];for(const At of this.features.values())Ai(At,Ke,me,Oe)&&tt.push(en(At,Ke,me,Oe));return{features:tt}}getFeatures(){return[...this.features.values()]}}function Ai({minX:at,minY:se,maxX:me,maxY:Oe},Ke,tt,At){return at<(tt+1+Ct)/Ke&&se<(At+1+Ct)/Ke&&me>(tt-Ct)/Ke&&Oe>(At-Ct)/Ke}function Ni(at){const{id:se,geometry:me,properties:Oe}=at;if(!me)return;if(me.type==="GeometryCollection")throw new Error("GeometryCollection not supported in dynamic mode.");const{type:Ke,coordinates:tt}=me,At={id:se,type:1,geometry:[],tags:Oe,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},Ft=At.geometry;if(Ke==="Point")Qe(tt,Ft,At);else if(Ke==="MultiPoint")for(const yt of tt)Qe(yt,Ft,At);else if(Ke==="LineString")At.type=2,st(tt,Ft,At);else if(Ke==="MultiLineString")At.type=2,Ht(tt,Ft,At);else if(Ke==="Polygon")At.type=3,Ht(tt,Ft,At,!0);else{if(Ke!=="MultiPolygon")throw new Error("Input data is not a valid GeoJSON object.");At.type=3;for(const yt of tt)Ht(yt,Ft,At,!0)}return At}function Qe([at,se],me,Oe){const Ke=s.aj(at);let tt=s.ak(se);tt=tt<0?0:tt>1?1:tt,me.push(Ke,tt),Oe.minX=Math.min(Oe.minX,Ke),Oe.minY=Math.min(Oe.minY,tt),Oe.maxX=Math.max(Oe.maxX,Ke),Oe.maxY=Math.max(Oe.maxY,tt)}function st(at,se,me,Oe=!1,Ke=!1){const tt=[];for(const At of at)Qe(At,tt,me);se.push(tt),Oe&&function(At,Ft){let yt=0;for(let jt=0,Oi=At.length,Mi=Oi-2;jt<Oi;Mi=jt,jt+=2)yt+=(At[jt]-At[Mi])*(At[jt+1]+At[Mi+1]);if(yt>0===Ft)for(let jt=0,Oi=At.length;jt<Oi/2;jt+=2){const Mi=At[jt],wn=At[jt+1];At[jt]=At[Oi-2-jt],At[jt+1]=At[Oi-1-jt],At[Oi-2-jt]=Mi,At[Oi-1-jt]=wn}}(tt,Ke)}function Ht(at,se,me,Oe=!1){for(let Ke=0;Ke<at.length;Ke++)st(at[Ke],se,me,Oe,Ke===0)}function en(at,se,me,Oe){const{id:Ke,type:tt,geometry:At,tags:Ft}=at,yt=[];if(tt===1)ci(At,se,me,Oe,yt);else for(const jt of At)yt.push(ci(jt,se,me,Oe));return{id:Ke,type:tt,geometry:yt,tags:Ft}}function ci(at,se,me,Oe,Ke=[]){for(let tt=0;tt<at.length;tt+=2)Ke.push(ae(at[tt],at[tt+1],se,me,Oe));return Ke}function ae(at,se,me,Oe,Ke){return[Math.round(s.a3*(at*me-Oe)),Math.round(s.a3*(se*me-Ke))]}var ye={exports:{}},Se=s.d$,Pe=s.d_.VectorTileFeature,je=Et;function Et(at,se){this.options=se||{},this.features=at,this.length=at.length}function _t(at,se){this.id=typeof at.id=="number"?at.id:void 0,this.type=at.type,this.rawGeometry=at.type===1?[at.geometry]:at.geometry,this.properties=at.tags,this.extent=se||4096}Et.prototype.feature=function(at){return new _t(this.features[at],this.options.extent)},_t.prototype.loadGeometry=function(){var at=this.rawGeometry;this.geometry=[];for(var se=0;se<at.length;se++){for(var me=at[se],Oe=[],Ke=0;Ke<me.length;Ke++)Oe.push(new Se(me[Ke][0],me[Ke][1]));this.geometry.push(Oe)}return this.geometry},_t.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var at=this.geometry,se=1/0,me=-1/0,Oe=1/0,Ke=-1/0,tt=0;tt<at.length;tt++)for(var At=at[tt],Ft=0;Ft<At.length;Ft++){var yt=At[Ft];se=Math.min(se,yt.x),me=Math.max(me,yt.x),Oe=Math.min(Oe,yt.y),Ke=Math.max(Ke,yt.y)}return[se,Oe,me,Ke]},_t.prototype.toGeoJSON=Pe.prototype.toGeoJSON;var ft=s.e0,ii=je;function St(at){var se=new ft;return function(me,Oe){for(var Ke in me.layers)Oe.writeMessage(3,Jt,me.layers[Ke])}(at,se),se.finish()}function Jt(at,se){var me;se.writeVarintField(15,at.version||1),se.writeStringField(1,at.name||""),se.writeVarintField(5,at.extent||4096);var Oe={keys:[],values:[],keycache:{},valuecache:{}};for(me=0;me<at.length;me++)Oe.feature=at.feature(me),se.writeMessage(2,sn,Oe);var Ke=Oe.keys;for(me=0;me<Ke.length;me++)se.writeStringField(3,Ke[me]);var tt=Oe.values;for(me=0;me<tt.length;me++)se.writeMessage(4,wr,tt[me])}function sn(at,se){var me=at.feature;me.id!==void 0&&se.writeVarintField(1,me.id),se.writeMessage(2,Ki,at),se.writeVarintField(3,me.type),se.writeMessage(4,Xn,me)}function Ki(at,se){var me=at.feature,Oe=at.keys,Ke=at.values,tt=at.keycache,At=at.valuecache;for(var Ft in me.properties){var yt=me.properties[Ft],jt=tt[Ft];if(yt!==null){jt===void 0&&(Oe.push(Ft),tt[Ft]=jt=Oe.length-1),se.writeVarint(jt);var Oi=typeof yt;Oi!=="string"&&Oi!=="boolean"&&Oi!=="number"&&(yt=JSON.stringify(yt));var Mi=Oi+":"+yt,wn=At[Mi];wn===void 0&&(Ke.push(yt),At[Mi]=wn=Ke.length-1),se.writeVarint(wn)}}}function fi(at,se){return(se<<3)+(7&at)}function pr(at){return at<<1^at>>31}function Xn(at,se){for(var me=at.loadGeometry(),Oe=at.type,Ke=0,tt=0,At=me.length,Ft=0;Ft<At;Ft++){var yt=me[Ft],jt=1;Oe===1&&(jt=yt.length),se.writeVarint(fi(1,jt));for(var Oi=Oe===3?yt.length-1:yt.length,Mi=0;Mi<Oi;Mi++){Mi===1&&Oe!==1&&se.writeVarint(fi(2,Oi-1));var wn=yt[Mi].x-Ke,Bn=yt[Mi].y-tt;se.writeVarint(pr(wn)),se.writeVarint(pr(Bn)),Ke+=wn,tt+=Bn}Oe===3&&se.writeVarint(fi(7,1))}}function wr(at,se){var me=typeof at;me==="string"?se.writeStringField(1,at):me==="boolean"?se.writeBooleanField(7,at):me==="number"&&(at%1!=0?se.writeDoubleField(3,at):at<0?se.writeSVarintField(6,at):se.writeVarintField(5,at))}ye.exports=St,ye.exports.fromVectorTileJs=St,ye.exports.fromGeojsonVt=function(at,se){se=se||{};var me={};for(var Oe in at)me[Oe]=new ii(at[Oe].features,se),me[Oe].name=Oe,me[Oe].version=se.version,me[Oe].extent=se.extent;return St({layers:me})},ye.exports.GeoJSONWrapper=ii;var dn=s.e1(ye.exports);const ln={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:at=>at},_n=Math.fround||(li=new Float32Array(1),at=>(li[0]=+at,li[0]));var li;const Ie=3,ke=5,ht=6;class Ue{constructor(se){this.options=Object.assign(Object.create(ln),se),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(se){const{log:me,minZoom:Oe,maxZoom:Ke}=this.options;me&&console.time("total time");const tt=`prepare ${se.length} points`;me&&console.time(tt),this.points=se;const At=[];for(let yt=0;yt<se.length;yt++){const jt=se[yt];if(!jt.geometry)continue;const[Oi,Mi]=jt.geometry.coordinates,wn=_n(zt(Oi)),Bn=_n(It(Mi));At.push(wn,Bn,1/0,yt,-1,1),this.options.reduce&&At.push(0)}let Ft=this.trees[Ke+1]=this._createTree(At);me&&console.timeEnd(tt);for(let yt=Ke;yt>=Oe;yt--){const jt=+Date.now();Ft=this.trees[yt]=this._createTree(this._cluster(Ft,yt)),me&&console.log("z%d: %d clusters in %dms",yt,Ft.numItems,+Date.now()-jt)}return me&&console.timeEnd("total time"),this}getClusters(se,me){let Oe=((se[0]+180)%360+360)%360-180;const Ke=Math.max(-90,Math.min(90,se[1]));let tt=se[2]===180?180:((se[2]+180)%360+360)%360-180;const At=Math.max(-90,Math.min(90,se[3]));if(se[2]-se[0]>=360)Oe=-180,tt=180;else if(Oe>tt){const Mi=this.getClusters([Oe,Ke,180,At],me),wn=this.getClusters([-180,Ke,tt,At],me);return Mi.concat(wn)}const Ft=this.trees[this._limitZoom(me)],yt=Ft.range(zt(Oe),It(At),zt(tt),It(Ke)),jt=Ft.data,Oi=[];for(const Mi of yt){const wn=this.stride*Mi;Oi.push(jt[wn+ke]>1?Ye(jt,wn,this.clusterProps):this.points[jt[wn+Ie]])}return Oi}getChildren(se){const me=this._getOriginId(se),Oe=this._getOriginZoom(se),Ke="No cluster with the specified id.",tt=this.trees[Oe];if(!tt)throw new Error(Ke);const At=tt.data;if(me*this.stride>=At.length)throw new Error(Ke);const Ft=this.options.radius/(this.options.extent*Math.pow(2,Oe-1)),yt=tt.within(At[me*this.stride],At[me*this.stride+1],Ft),jt=[];for(const Oi of yt){const Mi=Oi*this.stride;At[Mi+4]===se&&jt.push(At[Mi+ke]>1?Ye(At,Mi,this.clusterProps):this.points[At[Mi+Ie]])}if(jt.length===0)throw new Error(Ke);return jt}getLeaves(se,me,Oe){const Ke=[];return this._appendLeaves(Ke,se,me=me||10,Oe=Oe||0,0),Ke}getTile(se,me,Oe){const Ke=this.trees[this._limitZoom(se)],tt=Math.pow(2,se),{extent:At,radius:Ft}=this.options,yt=Ft/At,jt=(Oe-yt)/tt,Oi=(Oe+1+yt)/tt,Mi={features:[]};return this._addTileFeatures(Ke.range((me-yt)/tt,jt,(me+1+yt)/tt,Oi),Ke.data,me,Oe,tt,Mi),me===0&&this._addTileFeatures(Ke.range(1-yt/tt,jt,1,Oi),Ke.data,tt,Oe,tt,Mi),me===tt-1&&this._addTileFeatures(Ke.range(0,jt,yt/tt,Oi),Ke.data,-1,Oe,tt,Mi),Mi.features.length?Mi:null}getClusterExpansionZoom(se){let me=this._getOriginZoom(se)-1;for(;me<=this.options.maxZoom;){const Oe=this.getChildren(se);if(me++,Oe.length!==1)break;se=Oe[0].properties.cluster_id}return me}_appendLeaves(se,me,Oe,Ke,tt){const At=this.getChildren(me);for(const Ft of At){const yt=Ft.properties;if(yt&&yt.cluster?tt+yt.point_count<=Ke?tt+=yt.point_count:tt=this._appendLeaves(se,yt.cluster_id,Oe,Ke,tt):tt<Ke?tt++:se.push(Ft),se.length===Oe)break}return tt}_createTree(se){const me=new s.cK(se.length/this.stride|0,this.options.nodeSize,Float32Array);for(let Oe=0;Oe<se.length;Oe+=this.stride)me.add(se[Oe],se[Oe+1]);return me.finish(),me.data=se,me}_addTileFeatures(se,me,Oe,Ke,tt,At){for(const Ft of se){const yt=Ft*this.stride,jt=me[yt+ke]>1;let Oi,Mi,wn;if(jt)Oi=xt(me,yt,this.clusterProps),Mi=me[yt],wn=me[yt+1];else{const lr=this.points[me[yt+Ie]];Oi=lr.properties;const[jn,fr]=lr.geometry.coordinates;Mi=zt(jn),wn=It(fr)}const Bn={type:1,geometry:[[Math.round(this.options.extent*(Mi*tt-Oe)),Math.round(this.options.extent*(wn*tt-Ke))]],tags:Oi};let Vn;Vn=jt||this.options.generateId?me[yt+Ie]:this.points[me[yt+Ie]].id,Vn!==void 0&&(Bn.id=Vn),At.features.push(Bn)}}_limitZoom(se){return Math.max(this.options.minZoom,Math.min(Math.floor(+se),this.options.maxZoom+1))}_cluster(se,me){const{radius:Oe,extent:Ke,reduce:tt,minPoints:At}=this.options,Ft=Oe/(Ke*Math.pow(2,me)),yt=se.data,jt=[],Oi=this.stride;for(let Mi=0;Mi<yt.length;Mi+=Oi){if(yt[Mi+2]<=me)continue;yt[Mi+2]=me;const wn=yt[Mi],Bn=yt[Mi+1],Vn=se.within(yt[Mi],yt[Mi+1],Ft),lr=yt[Mi+ke];let jn=lr;for(const fr of Vn){const bn=fr*Oi;yt[bn+2]>me&&(jn+=yt[bn+ke])}if(jn>lr&&jn>=At){let fr,bn=wn*lr,as=Bn*lr,Vr=-1;const br=(Mi/Oi<<5)+(me+1)+this.points.length;for(const Mn of Vn){const Wr=Mn*Oi;if(yt[Wr+2]<=me)continue;yt[Wr+2]=me;const ss=yt[Wr+ke];bn+=yt[Wr]*ss,as+=yt[Wr+1]*ss,yt[Wr+4]=br,tt&&(fr||(fr=this._map(yt,Mi,!0),Vr=this.clusterProps.length,this.clusterProps.push(fr)),tt(fr,this._map(yt,Wr)))}yt[Mi+4]=br,jt.push(bn/jn,as/jn,1/0,br,-1,jn),tt&&jt.push(Vr)}else{for(let fr=0;fr<Oi;fr++)jt.push(yt[Mi+fr]);if(jn>1)for(const fr of Vn){const bn=fr*Oi;if(!(yt[bn+2]<=me)){yt[bn+2]=me;for(let as=0;as<Oi;as++)jt.push(yt[bn+as])}}}}return jt}_getOriginId(se){return se-this.points.length>>5}_getOriginZoom(se){return(se-this.points.length)%32}_map(se,me,Oe){if(se[me+ke]>1){const At=this.clusterProps[se[me+ht]];return Oe?Object.assign({},At):At}const Ke=this.points[se[me+Ie]].properties,tt=this.options.map(Ke);return Oe&&tt===Ke?Object.assign({},tt):tt}}function Ye(at,se,me){return{type:"Feature",id:at[se+Ie],properties:xt(at,se,me),geometry:{type:"Point",coordinates:[(Oe=at[se],360*(Oe-.5)),si(at[se+1])]}};var Oe}function xt(at,se,me){const Oe=at[se+ke],Ke=Oe>=1e4?`${Math.round(Oe/1e3)}k`:Oe>=1e3?Math.round(Oe/100)/10+"k":Oe,tt=at[se+ht],At=tt===-1?{}:Object.assign({},me[tt]);return Object.assign(At,{cluster:!0,cluster_id:at[se+Ie],point_count:Oe,point_count_abbreviated:Ke})}function zt(at){return at/360+.5}function It(at){const se=Math.sin(at*Math.PI/180),me=.5-.25*Math.log((1+se)/(1-se))/Math.PI;return me<0?0:me>1?1:me}function si(at){const se=(180-360*at)*Math.PI/180;return 360*Math.atan(Math.exp(se))/Math.PI-90}function Qi(at,se,me,Oe){let Ke=Oe;const tt=se+(me-se>>1);let At,Ft=me-se;const yt=at[se],jt=at[se+1],Oi=at[me],Mi=at[me+1];for(let wn=se+3;wn<me;wn+=3){const Bn=tn(at[wn],at[wn+1],yt,jt,Oi,Mi);if(Bn>Ke)At=wn,Ke=Bn;else if(Bn===Ke){const Vn=Math.abs(wn-tt);Vn<Ft&&(At=wn,Ft=Vn)}}Ke>Oe&&(At-se>3&&Qi(at,se,At,Oe),at[At+2]=Ke,me-At>3&&Qi(at,At,me,Oe))}function tn(at,se,me,Oe,Ke,tt){let At=Ke-me,Ft=tt-Oe;if(At!==0||Ft!==0){const yt=((at-me)*At+(se-Oe)*Ft)/(At*At+Ft*Ft);yt>1?(me=Ke,Oe=tt):yt>0&&(me+=At*yt,Oe+=Ft*yt)}return At=at-me,Ft=se-Oe,At*At+Ft*Ft}function kn(at,se,me,Oe){const Ke={id:at??null,type:se,geometry:me,tags:Oe,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(se==="Point"||se==="MultiPoint"||se==="LineString")Gn(Ke,me);else if(se==="Polygon")Gn(Ke,me[0]);else if(se==="MultiLineString")for(const tt of me)Gn(Ke,tt);else if(se==="MultiPolygon")for(const tt of me)Gn(Ke,tt[0]);return Ke}function Gn(at,se){for(let me=0;me<se.length;me+=3)at.minX=Math.min(at.minX,se[me]),at.minY=Math.min(at.minY,se[me+1]),at.maxX=Math.max(at.maxX,se[me]),at.maxY=Math.max(at.maxY,se[me+1])}function Yn(at,se,me,Oe){if(!se.geometry)return;const Ke=se.geometry.coordinates;if(Ke&&Ke.length===0)return;const tt=se.geometry.type,At=Math.pow(me.tolerance/((1<<me.maxZoom)*me.extent),2);let Ft=[],yt=se.id;if(me.promoteId?yt=se.properties[me.promoteId]:me.generateId&&(yt=Oe||0),tt==="Point")Jn(Ke,Ft);else if(tt==="MultiPoint")for(const jt of Ke)Jn(jt,Ft);else if(tt==="LineString")Dn(Ke,Ft,At,!1);else if(tt==="MultiLineString"){if(me.lineMetrics){for(const jt of Ke)Ft=[],Dn(jt,Ft,At,!1),at.push(kn(yt,"LineString",Ft,se.properties));return}ar(Ke,Ft,At,!1)}else if(tt==="Polygon")ar(Ke,Ft,At,!0);else{if(tt!=="MultiPolygon"){if(tt==="GeometryCollection"){for(const jt of se.geometry.geometries)Yn(at,{id:yt,geometry:jt,properties:se.properties},me,Oe);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const jt of Ke){const Oi=[];ar(jt,Oi,At,!0),Ft.push(Oi)}}at.push(kn(yt,tt,Ft,se.properties))}function Jn(at,se){se.push(rs(at[0]),ms(at[1]),0)}function Dn(at,se,me,Oe){let Ke,tt,At=0;for(let yt=0;yt<at.length;yt++){const jt=rs(at[yt][0]),Oi=ms(at[yt][1]);se.push(jt,Oi,0),yt>0&&(At+=Oe?(Ke*Oi-jt*tt)/2:Math.sqrt(Math.pow(jt-Ke,2)+Math.pow(Oi-tt,2))),Ke=jt,tt=Oi}const Ft=se.length-3;se[2]=1,Qi(se,0,Ft,me),se[Ft+2]=1,se.size=Math.abs(At),se.start=0,se.end=se.size}function ar(at,se,me,Oe){for(let Ke=0;Ke<at.length;Ke++){const tt=[];Dn(at[Ke],tt,me,Oe),se.push(tt)}}function rs(at){return at/360+.5}function ms(at){const se=Math.sin(at*Math.PI/180),me=.5-.25*Math.log((1+se)/(1-se))/Math.PI;return me<0?0:me>1?1:me}function Un(at,se,me,Oe,Ke,tt,At,Ft){if(Oe/=se,tt>=(me/=se)&&At<Oe)return at;if(At<me||tt>=Oe)return null;const yt=[];for(const jt of at){const Oi=jt.geometry;let Mi=jt.type;const wn=Ke===0?jt.minX:jt.minY,Bn=Ke===0?jt.maxX:jt.maxY;if(wn>=me&&Bn<Oe){yt.push(jt);continue}if(Bn<me||wn>=Oe)continue;let Vn=[];if(Mi==="Point"||Mi==="MultiPoint")ho(Oi,Vn,me,Oe,Ke);else if(Mi==="LineString")Ri(Oi,Vn,me,Oe,Ke,!1,Ft.lineMetrics);else if(Mi==="MultiLineString")Ms(Oi,Vn,me,Oe,Ke,!1);else if(Mi==="Polygon")Ms(Oi,Vn,me,Oe,Ke,!0);else if(Mi==="MultiPolygon")for(const lr of Oi){const jn=[];Ms(lr,jn,me,Oe,Ke,!0),jn.length&&Vn.push(jn)}if(Vn.length){if(Ft.lineMetrics&&Mi==="LineString"){for(const lr of Vn)yt.push(kn(jt.id,Mi,lr,jt.tags));continue}Mi!=="LineString"&&Mi!=="MultiLineString"||(Vn.length===1?(Mi="LineString",Vn=Vn[0]):Mi="MultiLineString"),Mi!=="Point"&&Mi!=="MultiPoint"||(Mi=Vn.length===3?"Point":"MultiPoint"),yt.push(kn(jt.id,Mi,Vn,jt.tags))}}return yt.length?yt:null}function ho(at,se,me,Oe,Ke){for(let tt=0;tt<at.length;tt+=3){const At=at[tt+Ke];At>=me&&At<=Oe&&Fs(se,at[tt],at[tt+1],at[tt+2])}}function Ri(at,se,me,Oe,Ke,tt,At){let Ft=jr(at);const yt=Ke===0?Po:ds;let jt,Oi,Mi=at.start;for(let jn=0;jn<at.length-3;jn+=3){const fr=at[jn],bn=at[jn+1],as=at[jn+2],Vr=at[jn+3],br=at[jn+4],Mn=Ke===0?fr:bn,Wr=Ke===0?Vr:br;let ss=!1;At&&(jt=Math.sqrt(Math.pow(fr-Vr,2)+Math.pow(bn-br,2))),Mn<me?Wr>me&&(Oi=yt(Ft,fr,bn,Vr,br,me),At&&(Ft.start=Mi+jt*Oi)):Mn>Oe?Wr<Oe&&(Oi=yt(Ft,fr,bn,Vr,br,Oe),At&&(Ft.start=Mi+jt*Oi)):Fs(Ft,fr,bn,as),Wr<me&&Mn>=me&&(Oi=yt(Ft,fr,bn,Vr,br,me),ss=!0),Wr>Oe&&Mn<=Oe&&(Oi=yt(Ft,fr,bn,Vr,br,Oe),ss=!0),!tt&&ss&&(At&&(Ft.end=Mi+jt*Oi),se.push(Ft),Ft=jr(at)),At&&(Mi+=jt)}let wn=at.length-3;const Bn=at[wn],Vn=at[wn+1],lr=Ke===0?Bn:Vn;lr>=me&&lr<=Oe&&Fs(Ft,Bn,Vn,at[wn+2]),wn=Ft.length-3,tt&&wn>=3&&(Ft[wn]!==Ft[0]||Ft[wn+1]!==Ft[1])&&Fs(Ft,Ft[0],Ft[1],Ft[2]),Ft.length&&se.push(Ft)}function jr(at){const se=[];return se.size=at.size,se.start=at.start,se.end=at.end,se}function Ms(at,se,me,Oe,Ke,tt){for(const At of at)Ri(At,se,me,Oe,Ke,tt,!1)}function Fs(at,se,me,Oe){at.push(se,me,Oe)}function Po(at,se,me,Oe,Ke,tt){const At=(tt-se)/(Oe-se);return Fs(at,tt,me+(Ke-me)*At,1),At}function ds(at,se,me,Oe,Ke,tt){const At=(tt-me)/(Ke-me);return Fs(at,se+(Oe-se)*At,tt,1),At}function ys(at,se){const me=[];for(let Oe=0;Oe<at.length;Oe++){const Ke=at[Oe],tt=Ke.type;let At;if(tt==="Point"||tt==="MultiPoint"||tt==="LineString")At=Mr(Ke.geometry,se);else if(tt==="MultiLineString"||tt==="Polygon"){At=[];for(const Ft of Ke.geometry)At.push(Mr(Ft,se))}else if(tt==="MultiPolygon"){At=[];for(const Ft of Ke.geometry){const yt=[];for(const jt of Ft)yt.push(Mr(jt,se));At.push(yt)}}me.push(kn(Ke.id,tt,At,Ke.tags))}return me}function Mr(at,se){const me=[];me.size=at.size,at.start!==void 0&&(me.start=at.start,me.end=at.end);for(let Oe=0;Oe<at.length;Oe+=3)me.push(at[Oe]+se,at[Oe+1],at[Oe+2]);return me}function Bs(at,se){if(at.transformed)return at;const me=1<<at.z,Oe=at.x,Ke=at.y;for(const tt of at.features){const At=tt.geometry,Ft=tt.type;if(tt.geometry=[],Ft===1)for(let yt=0;yt<At.length;yt+=2)tt.geometry.push(js(At[yt],At[yt+1],se,me,Oe,Ke));else for(let yt=0;yt<At.length;yt++){const jt=[];for(let Oi=0;Oi<At[yt].length;Oi+=2)jt.push(js(At[yt][Oi],At[yt][Oi+1],se,me,Oe,Ke));tt.geometry.push(jt)}}return at.transformed=!0,at}function js(at,se,me,Oe,Ke,tt){return[Math.round(me*(at*Oe-Ke)),Math.round(me*(se*Oe-tt))]}function Wo(at,se,me,Oe,Ke){const tt=se===Ke.maxZoom?0:Ke.tolerance/((1<<se)*Ke.extent),At={features:[],numPoints:0,numSimplified:0,numFeatures:at.length,source:null,x:me,y:Oe,z:se,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const Ft of at)Rs(At,Ft,tt,Ke);return At}function Rs(at,se,me,Oe){const Ke=se.geometry,tt=se.type,At=[];if(at.minX=Math.min(at.minX,se.minX),at.minY=Math.min(at.minY,se.minY),at.maxX=Math.max(at.maxX,se.maxX),at.maxY=Math.max(at.maxY,se.maxY),tt==="Point"||tt==="MultiPoint")for(let Ft=0;Ft<Ke.length;Ft+=3)At.push(Ke[Ft],Ke[Ft+1]),at.numPoints++,at.numSimplified++;else if(tt==="LineString")et(At,Ke,at,me,!1,!1);else if(tt==="MultiLineString"||tt==="Polygon")for(let Ft=0;Ft<Ke.length;Ft++)et(At,Ke[Ft],at,me,tt==="Polygon",Ft===0);else if(tt==="MultiPolygon")for(let Ft=0;Ft<Ke.length;Ft++){const yt=Ke[Ft];for(let jt=0;jt<yt.length;jt++)et(At,yt[jt],at,me,!0,jt===0)}if(At.length){let Ft=se.tags||null;if(tt==="LineString"&&Oe.lineMetrics){Ft={};for(const jt in se.tags)Ft[jt]=se.tags[jt];Ft.mapbox_clip_start=Ke.start/Ke.size,Ft.mapbox_clip_end=Ke.end/Ke.size}const yt={geometry:At,type:tt==="Polygon"||tt==="MultiPolygon"?3:tt==="LineString"||tt==="MultiLineString"?2:1,tags:Ft};se.id!==null&&(yt.id=se.id),at.features.push(yt)}}function et(at,se,me,Oe,Ke,tt){const At=Oe*Oe;if(Oe>0&&se.size<(Ke?At:Oe))return void(me.numPoints+=se.length/3);const Ft=[];for(let yt=0;yt<se.length;yt+=3)(Oe===0||se[yt+2]>At)&&(me.numSimplified++,Ft.push(se[yt],se[yt+1])),me.numPoints++;Ke&&function(yt,jt){let Oi=0;for(let Mi=0,wn=yt.length,Bn=wn-2;Mi<wn;Bn=Mi,Mi+=2)Oi+=(yt[Mi]-yt[Bn])*(yt[Mi+1]+yt[Bn+1]);if(Oi>0===jt)for(let Mi=0,wn=yt.length;Mi<wn/2;Mi+=2){const Bn=yt[Mi],Vn=yt[Mi+1];yt[Mi]=yt[wn-2-Mi],yt[Mi+1]=yt[wn-1-Mi],yt[wn-2-Mi]=Bn,yt[wn-1-Mi]=Vn}}(Ft,tt),at.push(Ft)}const Bo={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class As{constructor(se,me){const Oe=(me=this.options=function(tt,At){for(const Ft in At)tt[Ft]=At[Ft];return tt}(Object.create(Bo),me)).debug;if(Oe&&console.time("preprocess data"),me.maxZoom<0||me.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(me.promoteId&&me.generateId)throw new Error("promoteId and generateId cannot be used together.");let Ke=function(tt,At){const Ft=[];if(tt.type==="FeatureCollection")for(let yt=0;yt<tt.features.length;yt++)Yn(Ft,tt.features[yt],At,yt);else Yn(Ft,tt.type==="Feature"?tt:{geometry:tt},At);return Ft}(se,me);this.tiles={},this.tileCoords=[],Oe&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",me.indexMaxZoom,me.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),Ke=function(tt,At){const Ft=At.buffer/At.extent;let yt=tt;const jt=Un(tt,1,-1-Ft,Ft,0,-1,2,At),Oi=Un(tt,1,1-Ft,2+Ft,0,-1,2,At);return(jt||Oi)&&(yt=Un(tt,1,-Ft,1+Ft,0,-1,2,At)||[],jt&&(yt=ys(jt,1).concat(yt)),Oi&&(yt=yt.concat(ys(Oi,-1)))),yt}(Ke,me),Ke.length&&this.splitTile(Ke,0,0,0),Oe&&(Ke.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(se,me,Oe,Ke,tt,At,Ft){const yt=[se,me,Oe,Ke],jt=this.options,Oi=jt.debug;for(;yt.length;){Ke=yt.pop(),Oe=yt.pop(),me=yt.pop(),se=yt.pop();const Mi=1<<me,wn=ps(me,Oe,Ke);let Bn=this.tiles[wn];if(!Bn&&(Oi>1&&console.time("creation"),Bn=this.tiles[wn]=Wo(se,me,Oe,Ke,jt),this.tileCoords.push({z:me,x:Oe,y:Ke}),Oi)){Oi>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",me,Oe,Ke,Bn.numFeatures,Bn.numPoints,Bn.numSimplified),console.timeEnd("creation"));const ss=`z${me}`;this.stats[ss]=(this.stats[ss]||0)+1,this.total++}if(Bn.source=se,tt==null){if(me===jt.indexMaxZoom||Bn.numPoints<=jt.indexMaxPoints)continue}else{if(me===jt.maxZoom||me===tt)continue;if(tt!=null){const ss=tt-me;if(Oe!==At>>ss||Ke!==Ft>>ss)continue}}if(Bn.source=null,se.length===0)continue;Oi>1&&console.time("clipping");const Vn=.5*jt.buffer/jt.extent,lr=.5-Vn,jn=.5+Vn,fr=1+Vn;let bn=null,as=null,Vr=null,br=null,Mn=Un(se,Mi,Oe-Vn,Oe+jn,0,Bn.minX,Bn.maxX,jt),Wr=Un(se,Mi,Oe+lr,Oe+fr,0,Bn.minX,Bn.maxX,jt);se=null,Mn&&(bn=Un(Mn,Mi,Ke-Vn,Ke+jn,1,Bn.minY,Bn.maxY,jt),as=Un(Mn,Mi,Ke+lr,Ke+fr,1,Bn.minY,Bn.maxY,jt),Mn=null),Wr&&(Vr=Un(Wr,Mi,Ke-Vn,Ke+jn,1,Bn.minY,Bn.maxY,jt),br=Un(Wr,Mi,Ke+lr,Ke+fr,1,Bn.minY,Bn.maxY,jt),Wr=null),Oi>1&&console.timeEnd("clipping"),yt.push(bn||[],me+1,2*Oe,2*Ke),yt.push(as||[],me+1,2*Oe,2*Ke+1),yt.push(Vr||[],me+1,2*Oe+1,2*Ke),yt.push(br||[],me+1,2*Oe+1,2*Ke+1)}}getTile(se,me,Oe){se=+se,me=+me,Oe=+Oe;const Ke=this.options,{extent:tt,debug:At}=Ke;if(se<0||se>24)return null;const Ft=1<<se,yt=ps(se,me=me+Ft&Ft-1,Oe);if(this.tiles[yt])return Bs(this.tiles[yt],tt);At>1&&console.log("drilling down to z%d-%d-%d",se,me,Oe);let jt,Oi=se,Mi=me,wn=Oe;for(;!jt&&Oi>0;)Oi--,Mi>>=1,wn>>=1,jt=this.tiles[ps(Oi,Mi,wn)];return jt&&jt.source?(At>1&&(console.log("found parent tile z%d-%d-%d",Oi,Mi,wn),console.time("drilling down")),this.splitTile(jt.source,Oi,Mi,wn,se,me,Oe),At>1&&console.timeEnd("drilling down"),this.tiles[yt]?Bs(this.tiles[yt],tt):null):null}}function ps(at,se,me){return 32*((1<<at)*me+se)+at}function No(at,se){const me=at.tileID.canonical;if(!this._geoJSONIndex)return se(null,null);const Oe=this._geoJSONIndex.getTile(me.z,me.x,me.y);if(!Oe)return se(null,null);const Ke=new lt(Oe.features);let tt=dn(Ke);tt.byteOffset===0&&tt.byteLength===tt.buffer.byteLength||(tt=new Uint8Array(tt)),se(null,{vectorTile:Ke,rawData:tt.buffer})}class Ro extends He{constructor(se,me,Oe,Ke,tt,At){super(se,me,Oe,Ke,No,At),tt&&(this.loadGeoJSON=tt),this._dynamicIndex=new qt}loadData(se,me){const Oe=se&&se.request,Ke=Oe&&Oe.collectResourceTiming;this.loadGeoJSON(se,(tt,At)=>{if(tt||!At)return me(tt);if(typeof At!="object")return me(new Error(`Input data given to '${se.source}' is not a valid GeoJSON object.`));{try{if(se.filter){const yt=s.y(se.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(yt.result==="error")throw new Error(yt.value.map(jt=>`${jt.key}: ${jt.message}`).join(", "));At.features=At.features.filter(jt=>yt.value.evaluate({zoom:0},jt))}se.dynamic?(At.type==="Feature"&&(At={type:"FeatureCollection",features:[At]}),se.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(At.features,this.loaded),se.cluster&&(At.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=se.cluster?new Ue(function({superclusterOptions:yt,clusterProperties:jt}){if(!jt||!yt)return yt;const Oi={},Mi={},wn={accumulated:null,zoom:0},Bn={properties:null},Vn=Object.keys(jt);for(const lr of Vn){const[jn,fr]=jt[lr],bn=s.y(fr),as=s.y(typeof jn=="string"?[jn,["accumulated"],["get",lr]]:jn);Oi[lr]=bn.value,Mi[lr]=as.value}return yt.map=lr=>{Bn.properties=lr;const jn={};for(const fr of Vn)jn[fr]=Oi[fr].evaluate(wn,Bn);return jn},yt.reduce=(lr,jn)=>{Bn.properties=jn;for(const fr of Vn)wn.accumulated=lr[fr],lr[fr]=Mi[fr].evaluate(wn,Bn)},yt}(se)).load(At.features):se.dynamic?this._dynamicIndex:function(yt,jt){return new As(yt,jt)}(At,se.geojsonVtOptions)}catch(yt){return me(yt)}const Ft={};if(Ke){const yt=Z(Oe);yt&&(Ft.resourceTiming={},Ft.resourceTiming[se.source]=JSON.parse(JSON.stringify(yt)))}me(null,Ft)}})}reloadTile(se,me){const Oe=this.loaded;return Oe&&Oe[se.uid]?se.partial?me(null,void 0):super.reloadTile(se,me):this.loadTile(se,me)}loadGeoJSON(se,me){if(se.request)s.g(se.request,me);else{if(typeof se.data!="string")return me(new Error(`Input data given to '${se.source}' is not a valid GeoJSON object.`));try{return me(null,JSON.parse(se.data))}catch{return me(new Error(`Input data given to '${se.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(se,me){try{me(null,this._geoJSONIndex.getClusterExpansionZoom(se.clusterId))}catch(Oe){me(Oe)}}getClusterChildren(se,me){try{me(null,this._geoJSONIndex.getChildren(se.clusterId))}catch(Oe){me(Oe)}}getClusterLeaves(se,me){try{me(null,this._geoJSONIndex.getLeaves(se.clusterId,se.limit,se.offset))}catch(Oe){me(Oe)}}}class ca{constructor(se,me){this.tileID=new s.aL(se.tileID.overscaledZ,se.tileID.wrap,se.tileID.canonical.z,se.tileID.canonical.x,se.tileID.canonical.y),this.tileZoom=se.tileZoom,this.uid=se.uid,this.zoom=se.zoom,this.canonical=se.tileID.canonical,this.pixelRatio=se.pixelRatio,this.tileSize=se.tileSize,this.source=se.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=se.projection,this.brightness=me}parse(se,me,Oe,Ke){this.status="parsing";const tt=new s.aL(Oe.tileID.overscaledZ,Oe.tileID.wrap,Oe.tileID.canonical.z,Oe.tileID.canonical.x,Oe.tileID.canonical.y),At={},Ft=me.familiesBySource[Oe.source],yt=new s.dN(tt,Oe.promoteId);return yt.bucketLayerIDs=[],yt.is3DTile=!0,s.e3(se).then(jt=>{if(!jt)return Ke(new Error("Could not parse tile"));const Oi=s.e4(jt,1/s.b5(Oe.tileID.canonical)),Mi=jt.json.extensionsUsed&&jt.json.extensionsUsed.includes("MAPBOX_mesh_features")||jt.json.asset.extras&&jt.json.asset.extras.MAPBOX_mesh_features,wn=jt.json.extensionsUsed&&jt.json.extensionsUsed.includes("EXT_meshopt_compression"),Bn=new s.X(this.zoom,{brightness:this.brightness});for(const Vn in Ft)for(const lr of Ft[Vn]){const jn=lr[0];yt.bucketLayerIDs.push(lr.map(bn=>bn.id)),jn.recalculate(Bn,[]);const fr=new s.e5(Oi,tt,Mi,wn,this.brightness,yt);Mi||(fr.needsUpload=!0),At[jn.fqid]=fr,fr.evaluate(jn)}this.status="done",Ke(null,{buckets:At,featureIndex:yt})}).catch(jt=>Ke(new Error(jt.message)))}}class ha{constructor(se,me,Oe,Ke,tt,At){this.actor=se,this.layerIndex=me,this.brightness=At,this.loading={},this.loaded={}}loadTile(se,me){const Oe=se.uid,Ke=this.loading[Oe]=new ca(se,this.brightness);s.e2(se.request,(tt,At)=>{const Ft=!this.loading[Oe];return delete this.loading[Oe],Ft||tt?(Ke.status="done",Ft||(this.loaded[Oe]=Ke),me(tt)):At&&At.byteLength!==0?void Ke.parse(At,this.layerIndex,se,(yt,jt)=>{Ke.status="done",this.loaded=this.loaded||{},this.loaded[Oe]=Ke,yt||!jt?me(yt):me(null,jt)}):(Ke.status="done",this.loaded[Oe]=Ke,me())})}reloadTile(se,me){const Oe=this.loaded,Ke=se.uid;if(Oe&&Oe[Ke]){const tt=Oe[Ke];tt.projection=se.projection,tt.brightness=se.brightness;const At=(Ft,yt)=>{tt.reloadCallback&&(delete tt.reloadCallback,this.loadTile(se,me)),me(Ft,yt)};tt.status==="parsing"?tt.reloadCallback=At:tt.status==="done"&&this.loadTile(se,me)}}abortTile(se,me){const Oe=se.uid;this.loading[Oe]&&delete this.loading[Oe],me()}removeTile(se,me){const Oe=this.loaded,Ke=se.uid;Oe&&Oe[Ke]&&delete Oe[Ke],me()}}class ta{constructor(se){this.self=se,this.actor=new s.e6(se,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=s.aJ({name:"mercator"}),this.workerSourceTypes={vector:He,geojson:Ro,"batched-model":ha},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(me,Oe)=>{if(this.workerSourceTypes[me])throw new Error(`Worker source with name "${me}" already registered.`);this.workerSourceTypes[me]=Oe},this.self.registerRTLTextPlugin=me=>{if(s.e7.isParsed())throw new Error("RTL text plugin already registered.");s.e7.applyArabicShaping=me.applyArabicShaping,s.e7.processBidirectionalText=me.processBidirectionalText,s.e7.processStyledBidirectionalText=me.processStyledBidirectionalText}}clearCaches(se,me,Oe){delete this.layerIndexes[se],delete this.availableImages[se],delete this.workerSources[se],delete this.demWorkerSources[se],delete this.rasterArrayWorkerSource,Oe()}checkIfReady(se,me,Oe){Oe()}setReferrer(se,me){this.referrer=me}spriteLoaded(se,{scope:me,isLoaded:Oe}){if(this.isSpriteLoaded[se]||(this.isSpriteLoaded[se]={}),this.isSpriteLoaded[se][me]=Oe,this.workerSources[se]&&this.workerSources[se][me])for(const Ke in this.workerSources[se][me]){const tt=this.workerSources[se][me][Ke];for(const At in tt){const Ft=tt[At];Ft instanceof He&&(Ft.isSpriteLoaded=Oe,Ft.fire(new s.f("isSpriteLoaded")))}}}setImages(se,{scope:me,images:Oe},Ke){if(this.availableImages[se]||(this.availableImages[se]={}),this.availableImages[se][me]=Oe,this.workerSources[se]&&this.workerSources[se][me]){for(const tt in this.workerSources[se][me]){const At=this.workerSources[se][me][tt];for(const Ft in At)At[Ft].availableImages=Oe}Ke()}else Ke()}setProjection(se,me){this.projections[se]=s.aJ(me)}setBrightness(se,me,Oe){this.brightness=me,Oe()}setLayers(se,me,Oe){this.getLayerIndex(se,me.scope).replace(me.layers,me.options),Oe()}updateLayers(se,me,Oe){this.getLayerIndex(se,me.scope).update(me.layers,me.removedIds,me.options),Oe()}loadTile(se,me,Oe){me.projection=this.projections[se]||this.defaultProjection,this.getWorkerSource(se,me.type,me.source,me.scope).loadTile(me,Oe)}loadDEMTile(se,me,Oe){this.getDEMWorkerSource(se,me.source,me.scope).loadTile(me,Oe)}decodeRasterArray(se,me,Oe){this.getRasterArrayWorkerSource().decodeRasterArray(me,Oe)}reloadTile(se,me,Oe){me.projection=this.projections[se]||this.defaultProjection,this.getWorkerSource(se,me.type,me.source,me.scope).reloadTile(me,Oe)}abortTile(se,me,Oe){this.getWorkerSource(se,me.type,me.source,me.scope).abortTile(me,Oe)}removeTile(se,me,Oe){this.getWorkerSource(se,me.type,me.source,me.scope).removeTile(me,Oe)}removeSource(se,me,Oe){if(!(this.workerSources[se]&&this.workerSources[se][me.scope]&&this.workerSources[se][me.scope][me.type]&&this.workerSources[se][me.scope][me.type][me.source]))return;const Ke=this.workerSources[se][me.scope][me.type][me.source];delete this.workerSources[se][me.scope][me.type][me.source],Ke.removeSource!==void 0?Ke.removeSource(me,Oe):Oe()}loadWorkerSource(se,me,Oe){try{this.self.importScripts(me.url),Oe()}catch(Ke){Oe(Ke.toString())}}syncRTLPluginState(se,me,Oe){try{s.e7.setState(me);const Ke=s.e7.getPluginURL();if(s.e7.isLoaded()&&!s.e7.isParsed()&&Ke!=null){this.self.importScripts(Ke);const tt=s.e7.isParsed();Oe(tt?void 0:new Error(`RTL Text Plugin failed to import scripts from ${Ke}`),tt)}}catch(Ke){Oe(Ke.toString())}}setDracoUrl(se,me){this.dracoUrl=me}getAvailableImages(se,me){this.availableImages[se]||(this.availableImages[se]={});let Oe=this.availableImages[se][me];return Oe||(Oe=[]),Oe}getLayerIndex(se,me){this.layerIndexes[se]||(this.layerIndexes[se]={});let Oe=this.layerIndexes[se][me];return Oe||(Oe=this.layerIndexes[se][me]=new oe,Oe.scope=me),Oe}getWorkerSource(se,me,Oe,Ke){return this.workerSources[se]||(this.workerSources[se]={}),this.workerSources[se][Ke]||(this.workerSources[se][Ke]={}),this.workerSources[se][Ke][me]||(this.workerSources[se][Ke][me]={}),this.isSpriteLoaded[se]||(this.isSpriteLoaded[se]={}),this.workerSources[se][Ke][me][Oe]||(this.workerSources[se][Ke][me][Oe]=new this.workerSourceTypes[me]({send:(tt,At,Ft,yt,jt,Oi)=>{this.actor.send(tt,At,Ft,se,jt,Oi)},scheduler:this.actor.scheduler},this.getLayerIndex(se,Ke),this.getAvailableImages(se,Ke),this.isSpriteLoaded[se][Ke],void 0,this.brightness)),this.workerSources[se][Ke][me][Oe]}getDEMWorkerSource(se,me,Oe){return this.demWorkerSources[se]||(this.demWorkerSources[se]={}),this.demWorkerSources[se][Oe]||(this.demWorkerSources[se][Oe]={}),this.demWorkerSources[se][Oe][me]||(this.demWorkerSources[se][Oe][me]=new Mt),this.demWorkerSources[se][Oe][me]}getRasterArrayWorkerSource(){return this.rasterArrayWorkerSource||(this.rasterArrayWorkerSource=new Lt),this.rasterArrayWorkerSource}enforceCacheSizeLimit(se,me){s.e8(me)}getWorkerPerformanceMetrics(se,me,Oe){Oe(void 0,void 0)}}return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope&&(self.worker=new ta(self)),ta}),U(["./shared"],function(s){function Z(m,r){if(Array.isArray(m)){if(!Array.isArray(r)||m.length!==r.length)return!1;for(let h=0;h<m.length;h++)if(!Z(m[h],r[h]))return!1;return!0}if(typeof m=="object"&&m!==null&&r!==null){if(typeof r!="object"||Object.keys(m).length!==Object.keys(r).length)return!1;for(const h in m)if(!Z(m[h],r[h]))return!1;return!0}return m===r}var j=Q;function Q(m){return!function(r){return typeof window>"u"||typeof document>"u"?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var y,b,T=new Blob([""],{type:"text/javascript"}),E=URL.createObjectURL(T);try{b=new Worker(E),y=!0}catch{y=!1}return b&&b.terminate(),URL.revokeObjectURL(E),y}()?function(){var y=document.createElement("canvas");y.width=y.height=1;var b=y.getContext("2d");if(!b)return!1;var T=b.getImageData(0,0,1,1);return T&&T.width===y.width}()?(oe[h=r&&r.failIfMajorPerformanceCaveat]===void 0&&(oe[h]=function(y){var b,T=function(E){var I=document.createElement("canvas"),k=Object.create(Q.webGLContextAttributes);return k.failIfMajorPerformanceCaveat=E,I.getContext("webgl2",k)}(y);if(!T)return!1;try{b=T.createShader(T.VERTEX_SHADER)}catch{return!1}return!(!b||T.isContextLost())&&(T.shaderSource(b,"void main() {}"),T.compileShader(b),T.getShaderParameter(b,T.COMPILE_STATUS)===!0)}(h)),oe[h]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var h}(m)}var oe={};function ve(m,r,h){const y=document.createElement(m);return r!=null&&(y.className=r),h&&h.appendChild(y),y}function Ee(m,r,h){const y=document.createElementNS("http://www.w3.org/2000/svg",m);for(const b of Object.keys(r))y.setAttributeNS(null,b,String(r[b]));return h&&h.appendChild(y),y}Q.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};const We=typeof document<"u"?document.documentElement&&document.documentElement.style:null,Re=We&&We.userSelect!==void 0?"userSelect":"WebkitUserSelect";let He;function Mt(){We&&Re&&(He=We[Re],We[Re]="none")}function Lt(){We&&Re&&(We[Re]=He)}function Ut(m){m.preventDefault(),m.stopPropagation(),window.removeEventListener("click",Ut,!0)}function Wt(){window.addEventListener("click",Ut,!0),window.setTimeout(()=>{window.removeEventListener("click",Ut,!0)},0)}function lt(m,r){const h=m.getBoundingClientRect();return Ai(m,h,r)}function Ct(m,r){const h=m.getBoundingClientRect(),y=[];for(let b=0;b<r.length;b++)y.push(Ai(m,h,r[b]));return y}function qt(m){return window.InstallTrigger!==void 0&&m.button===2&&m.ctrlKey&&window.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:m.button}function Ai(m,r,h){const y=m.offsetWidth===r.width?1:m.offsetWidth/r.width;return new s.P((h.clientX-r.left)*y,(h.clientY-r.top)*y)}class Ni{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages=new Set}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(r,h){this._updatedSourceCaches[r]=h,this.setDirty()}discardSourceCacheUpdate(r){delete this._updatedSourceCaches[r]}updateLayer(r){const h=r.scope;this._updatedLayers[h]=this._updatedLayers[h]||new Set,this._updatedLayers[h].add(r.id),this.setDirty()}removeLayer(r){const h=r.scope;this._removedLayers[h]=this._removedLayers[h]||{},this._updatedLayers[h]=this._updatedLayers[h]||new Set,this._removedLayers[h][r.id]=r,this._updatedLayers[h].delete(r.id),this._updatedPaintProps.delete(r.fqid),this.setDirty()}getRemovedLayer(r){return this._removedLayers[r.scope]?this._removedLayers[r.scope][r.id]:null}discardLayerRemoval(r){this._removedLayers[r.scope]&&delete this._removedLayers[r.scope][r.id]}getLayerUpdatesByScope(){const r={};for(const h in this._updatedLayers)r[h]=r[h]||{},r[h].updatedIds=Array.from(this._updatedLayers[h].values());for(const h in this._removedLayers)r[h]=r[h]||{},r[h].removedIds=Object.keys(this._removedLayers[h]);return r}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(r){this._updatedPaintProps.add(r.fqid),this.setDirty()}getUpdatedImages(){return Array.from(this._updatedImages.values())}updateImage(r){this._updatedImages.add(r),this.setDirty()}resetUpdatedImages(){this._updatedImages.clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages.clear()}}const Qe={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class st{constructor(r,h,y,b,T,E){this.length=h.length,this.attributes=y,this.itemSize=h.bytesPerElement,this.dynamicDraw=b,this.instanceCount=E,this.context=r;const I=r.gl;this.buffer=I.createBuffer(),r.bindVertexBuffer.set(this.buffer),I.bufferData(I.ARRAY_BUFFER,h.arrayBuffer,this.dynamicDraw?I.DYNAMIC_DRAW:I.STATIC_DRAW),this.dynamicDraw||T||h.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(r){const h=this.context.gl;this.bind(),h.bufferSubData(h.ARRAY_BUFFER,0,r.arrayBuffer)}enableAttributes(r,h){for(let y=0;y<this.attributes.length;y++){const b=h.attributes[this.attributes[y].name];b!==void 0&&r.enableVertexAttribArray(b)}}setVertexAttribPointers(r,h,y){for(let b=0;b<this.attributes.length;b++){const T=this.attributes[b],E=h.attributes[T.name];E!==void 0&&r.vertexAttribPointer(E,T.components,r[Qe[T.type]],!1,this.itemSize,T.offset+this.itemSize*(y||0))}}setVertexAttribDivisor(r,h,y){for(let b=0;b<this.attributes.length;b++){const T=h.attributes[this.attributes[b].name];T!==void 0&&this.instanceCount&&this.instanceCount>0&&r.vertexAttribDivisor(T,y)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Ht{constructor(r){this.gl=r.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(r){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class en extends Ht{getDefault(){return s.C.transparent}set(r){const h=this.current;(r.r!==h.r||r.g!==h.g||r.b!==h.b||r.a!==h.a||this.dirty)&&(this.gl.clearColor(r.r,r.g,r.b,r.a),this.current=r,this.dirty=!1)}}class ci extends Ht{getDefault(){return 1}set(r){(r!==this.current||this.dirty)&&(this.gl.clearDepth(r),this.current=r,this.dirty=!1)}}class ae extends Ht{getDefault(){return 0}set(r){(r!==this.current||this.dirty)&&(this.gl.clearStencil(r),this.current=r,this.dirty=!1)}}class ye extends Ht{getDefault(){return[!0,!0,!0,!0]}set(r){const h=this.current;(r[0]!==h[0]||r[1]!==h[1]||r[2]!==h[2]||r[3]!==h[3]||this.dirty)&&(this.gl.colorMask(r[0],r[1],r[2],r[3]),this.current=r,this.dirty=!1)}}class Se extends Ht{getDefault(){return!0}set(r){(r!==this.current||this.dirty)&&(this.gl.depthMask(r),this.current=r,this.dirty=!1)}}class Pe extends Ht{getDefault(){return 255}set(r){(r!==this.current||this.dirty)&&(this.gl.stencilMask(r),this.current=r,this.dirty=!1)}}class je extends Ht{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(r){const h=this.current;(r.func!==h.func||r.ref!==h.ref||r.mask!==h.mask||this.dirty)&&(this.gl.stencilFunc(r.func,r.ref,r.mask),this.current=r,this.dirty=!1)}}class Et extends Ht{getDefault(){const r=this.gl;return[r.KEEP,r.KEEP,r.KEEP]}set(r){const h=this.current;(r[0]!==h[0]||r[1]!==h[1]||r[2]!==h[2]||this.dirty)&&(this.gl.stencilOp(r[0],r[1],r[2]),this.current=r,this.dirty=!1)}}class _t extends Ht{getDefault(){return!1}set(r){if(r===this.current&&!this.dirty)return;const h=this.gl;r?h.enable(h.STENCIL_TEST):h.disable(h.STENCIL_TEST),this.current=r,this.dirty=!1}}class ft extends Ht{getDefault(){return[0,1]}set(r){const h=this.current;(r[0]!==h[0]||r[1]!==h[1]||this.dirty)&&(this.gl.depthRange(r[0],r[1]),this.current=r,this.dirty=!1)}}class ii extends Ht{getDefault(){return!1}set(r){if(r===this.current&&!this.dirty)return;const h=this.gl;r?h.enable(h.DEPTH_TEST):h.disable(h.DEPTH_TEST),this.current=r,this.dirty=!1}}class St extends Ht{getDefault(){return this.gl.LESS}set(r){(r!==this.current||this.dirty)&&(this.gl.depthFunc(r),this.current=r,this.dirty=!1)}}class Jt extends Ht{getDefault(){return!1}set(r){if(r===this.current&&!this.dirty)return;const h=this.gl;r?h.enable(h.BLEND):h.disable(h.BLEND),this.current=r,this.dirty=!1}}class sn extends Ht{getDefault(){const r=this.gl;return[r.ONE,r.ZERO,r.ONE,r.ZERO]}set(r){const h=this.current;(r[0]!==h[0]||r[1]!==h[1]||r[2]!==h[2]||r[3]!==h[3]||this.dirty)&&(this.gl.blendFuncSeparate(r[0],r[1],r[2],r[3]),this.current=r,this.dirty=!1)}}class Ki extends Ht{getDefault(){return s.C.transparent}set(r){const h=this.current;(r.r!==h.r||r.g!==h.g||r.b!==h.b||r.a!==h.a||this.dirty)&&(this.gl.blendColor(r.r,r.g,r.b,r.a),this.current=r,this.dirty=!1)}}class fi extends Ht{getDefault(){return this.gl.FUNC_ADD}set(r){(r!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(r,r),this.current=r,this.dirty=!1)}}class pr extends Ht{getDefault(){return!1}set(r){if(r===this.current&&!this.dirty)return;const h=this.gl;r?h.enable(h.CULL_FACE):h.disable(h.CULL_FACE),this.current=r,this.dirty=!1}}class Xn extends Ht{getDefault(){return this.gl.BACK}set(r){(r!==this.current||this.dirty)&&(this.gl.cullFace(r),this.current=r,this.dirty=!1)}}class wr extends Ht{getDefault(){return this.gl.CCW}set(r){(r!==this.current||this.dirty)&&(this.gl.frontFace(r),this.current=r,this.dirty=!1)}}let dn=class extends Ht{getDefault(){return null}set(m){(m!==this.current||this.dirty)&&(this.gl.useProgram(m),this.current=m,this.dirty=!1)}};class ln extends Ht{getDefault(){return this.gl.TEXTURE0}set(r){(r!==this.current||this.dirty)&&(this.gl.activeTexture(r),this.current=r,this.dirty=!1)}}class _n extends Ht{getDefault(){const r=this.gl;return[0,0,r.drawingBufferWidth,r.drawingBufferHeight]}set(r){const h=this.current;(r[0]!==h[0]||r[1]!==h[1]||r[2]!==h[2]||r[3]!==h[3]||this.dirty)&&(this.gl.viewport(r[0],r[1],r[2],r[3]),this.current=r,this.dirty=!1)}}class li extends Ht{getDefault(){return null}set(r){if(r===this.current&&!this.dirty)return;const h=this.gl;h.bindFramebuffer(h.FRAMEBUFFER,r),this.current=r,this.dirty=!1}}class Ie extends Ht{getDefault(){return null}set(r){if(r===this.current&&!this.dirty)return;const h=this.gl;h.bindRenderbuffer(h.RENDERBUFFER,r),this.current=r,this.dirty=!1}}class ke extends Ht{getDefault(){return null}set(r){if(r===this.current&&!this.dirty)return;const h=this.gl;h.bindTexture(h.TEXTURE_2D,r),this.current=r,this.dirty=!1}}class ht extends Ht{getDefault(){return null}set(r){if(r===this.current&&!this.dirty)return;const h=this.gl;h.bindBuffer(h.ARRAY_BUFFER,r),this.current=r,this.dirty=!1}}class Ue extends Ht{getDefault(){return null}set(r){const h=this.gl;h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,r),this.current=r,this.dirty=!1}}class Ye extends Ht{getDefault(){return null}set(r){this.gl&&(r!==this.current||this.dirty)&&(this.gl.bindVertexArray(r),this.current=r,this.dirty=!1)}}class xt extends Ht{getDefault(){return 4}set(r){if(r===this.current&&!this.dirty)return;const h=this.gl;h.pixelStorei(h.UNPACK_ALIGNMENT,r),this.current=r,this.dirty=!1}}class zt extends Ht{getDefault(){return!1}set(r){if(r===this.current&&!this.dirty)return;const h=this.gl;h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,r),this.current=r,this.dirty=!1}}class It extends Ht{getDefault(){return!1}set(r){if(r===this.current&&!this.dirty)return;const h=this.gl;h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,r),this.current=r,this.dirty=!1}}class si extends Ht{constructor(r,h){super(r),this.context=r,this.parent=h}getDefault(){return null}}class Qi extends si{setDirty(){this.dirty=!0}set(r){if(r===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const h=this.gl;h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_2D,r,0),this.current=r,this.dirty=!1}}class tn extends si{attachment(){return this.gl.DEPTH_ATTACHMENT}set(r){if(r===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const h=this.gl;h.framebufferRenderbuffer(h.FRAMEBUFFER,this.attachment(),h.RENDERBUFFER,r),this.current=r,this.dirty=!1}}class kn extends si{attachment(){return this.gl.DEPTH_ATTACHMENT}set(r){if(r===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const h=this.gl;h.framebufferTexture2D(h.FRAMEBUFFER,this.attachment(),h.TEXTURE_2D,r,0),this.current=r,this.dirty=!1}}class Gn extends tn{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}class Yn{constructor(r,h,y,b,T){this.context=r,this.width=h,this.height=y;const E=this.framebuffer=r.gl.createFramebuffer();b&&(this.colorAttachment=new Qi(r,E)),T&&(this.depthAttachmentType=T,this.depthAttachment=T==="renderbuffer"?new tn(r,E):new kn(r,E))}destroy(){const r=this.context.gl;if(this.colorAttachment){const h=this.colorAttachment.get();h&&r.deleteTexture(h)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){const h=this.depthAttachment.get();h&&r.deleteRenderbuffer(h)}else{const h=this.depthAttachment.get();h&&r.deleteTexture(h)}r.deleteFramebuffer(this.framebuffer)}}class Jn{constructor(r,h){this.gl=r,this.clearColor=new en(this),this.clearDepth=new ci(this),this.clearStencil=new ae(this),this.colorMask=new ye(this),this.depthMask=new Se(this),this.stencilMask=new Pe(this),this.stencilFunc=new je(this),this.stencilOp=new Et(this),this.stencilTest=new _t(this),this.depthRange=new ft(this),this.depthTest=new ii(this),this.depthFunc=new St(this),this.blend=new Jt(this),this.blendFunc=new sn(this),this.blendColor=new Ki(this),this.blendEquation=new fi(this),this.cullFace=new pr(this),this.cullFaceSide=new Xn(this),this.frontFace=new wr(this),this.program=new dn(this),this.activeTexture=new ln(this),this.viewport=new _n(this),this.bindFramebuffer=new li(this),this.bindRenderbuffer=new Ie(this),this.bindTexture=new ke(this),this.bindVertexBuffer=new ht(this),this.bindElementBuffer=new Ue(this),this.bindVertexArrayOES=new Ye(this),this.pixelStoreUnpack=new xt(this),this.pixelStoreUnpackPremultiplyAlpha=new zt(this),this.pixelStoreUnpackFlipY=new It(this),this.options=h?{...h}:{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=r.getExtension("EXT_texture_filter_anisotropic")||r.getExtension("MOZ_EXT_texture_filter_anisotropic")||r.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=r.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=r.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=r.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=r.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=r.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=r.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=r.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=r.getParameter(r.MAX_TEXTURE_SIZE),this.maxPointSize=r.getParameter(r.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(r,h,y){return new s.I(this,r,h,y)}createVertexBuffer(r,h,y,b,T){return new st(this,r,h,y,b,T)}createRenderbuffer(r,h,y){const b=this.gl,T=b.createRenderbuffer();return this.bindRenderbuffer.set(T),b.renderbufferStorage(b.RENDERBUFFER,r,h,y),this.bindRenderbuffer.set(null),T}createFramebuffer(r,h,y,b){return new Yn(this,r,h,y,b)}clear({color:r,depth:h,stencil:y,colorMask:b}){const T=this.gl;let E=0;r&&(E|=T.COLOR_BUFFER_BIT,this.clearColor.set(r),this.colorMask.set(b||[!0,!0,!0,!0])),h!==void 0&&(E|=T.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(h),this.depthMask.set(!0)),y!==void 0&&(E|=T.STENCIL_BUFFER_BIT,this.clearStencil.set(y),this.stencilMask.set(255)),T.clear(E)}setCullFace(r){r.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(r.mode),this.frontFace.set(r.frontFace))}setDepthMode(r){r.func!==this.gl.ALWAYS||r.mask?(this.depthTest.set(!0),this.depthFunc.set(r.func),this.depthMask.set(r.mask),this.depthRange.set(r.range)):this.depthTest.set(!1)}setStencilMode(r){r.test.func!==this.gl.ALWAYS||r.mask?(this.stencilTest.set(!0),this.stencilMask.set(r.mask),this.stencilOp.set([r.fail,r.depthFail,r.pass]),this.stencilFunc.set({func:r.test.func,ref:r.ref,mask:r.test.mask})):this.stencilTest.set(!1)}setColorMode(r){Z(r.blendFunction,s.a.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(r.blendFunction),this.blendColor.set(r.blendColor),r.blendEquation?this.blendEquation.set(r.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(r.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}class Dn{constructor(r){this._gl=r.gl,this._query=this._gl.createQuery(),this._isFree=!0}begin(){this._gl.beginQuery(this._gl.ANY_SAMPLES_PASSED,this._query),this._isFree=!1}end(){this._gl.endQuery(this._gl.ANY_SAMPLES_PASSED)}isResultAvailable(){return this._gl.getQueryParameter(this._query,this._gl.QUERY_RESULT_AVAILABLE)}consumeResult(){const r=this._gl.getQueryParameter(this._query,this._gl.QUERY_RESULT);return this._isFree=!0,r}isFree(){return this._isFree}destroy(){this._gl.deleteQuery(this._query)}}class ar{constructor(r){this.useOcclusionQueries=!0,this.visualizeOcclusions="none",this.occlusionQueryFrameWindow=5,this.occluderSize=32,this.fadeSpeed=7,this.depthOffset=-1e-4,r.registerParameter(this,["Symbols"],"useOcclusionQueries"),r.registerParameter(this,["Symbols"],"visualizeOcclusions",{options:{none:"none",zPass:"zPass",zTest:"zTest"}}),r.registerParameter(this,["Symbols"],"occlusionQueryFrameWindow",{min:1,max:30,step:1}),r.registerParameter(this,["Symbols"],"occluderSize",{min:1,max:100,step:1}),r.registerParameter(this,["Symbols"],"fadeSpeed",{min:.1,max:50,step:.1}),r.registerParameter(this,["Symbols"],"depthOffset",{min:-.001,max:0,step:1e-4})}}class rs{constructor(r,h,y,b){const T={width:y[0],height:y[1],data:null},E=r.gl;this.targetColorTexture=new s.T(r,T,E.RGBA,{useMipmap:!1}),this.backgroundColorTexture=new s.T(r,T,E.RGBA,{useMipmap:!1}),this.context=r,this.updateParticleTexture(h,b),this.lastInvalidatedAt=0}updateParticleTexture(r,h){if(this.particleTextureDimension===h.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const y=this.context.gl,b=h.width*h.height;this.particleTexture0=new s.T(this.context,h,y.RGBA,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new s.T(this.context,h,y.RGBA,{premultiply:!1,useMipmap:!1});const T=new s.S;T.reserve(b);for(let E=0;E<b;E++)T.emplaceBack(E);this.particleIndexBuffer=this.context.createVertexBuffer(T,s.p.members,!0),this.particleSegment=s.b.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=h.width}update(r){return!(this.lastInvalidatedAt<r&&(this.lastInvalidatedAt=s.e.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}class ms extends s.E{constructor(r){super(),this.requestManager=r,this.models={"":{}},this.numModelsLoading={}}loadModel(r,h){return s.l(this.requestManager.transformRequest(h,s.R.Model).url).then(y=>{if(!y)return;const b=s.c(y),T=new s.M(r,void 0,void 0,b);return T.computeBoundsAndApplyParent(),T}).catch(y=>{if(y&&y.status===404)return null;this.fire(new s.d(new Error(`Could not load model ${r} from ${h}: ${y.message}`)))})}load(r,h){this.models[h]||(this.models[h]={});const y=Object.keys(r);this.numModelsLoading[h]=(this.numModelsLoading[h]||0)+y.length;const b=[];for(const T of y)b.push(this.loadModel(T,r[T]));Promise.allSettled(b).then(T=>{for(let E=0;E<T.length;E++){const{status:I,value:k}=T[E];I==="fulfilled"&&k&&(this.models[h][y[E]]={model:k,numReferences:1})}this.numModelsLoading[h]-=y.length,this.fire(new s.f("data",{dataType:"style"}))}).catch(T=>{this.fire(new s.d(new Error(`Could not load models: ${T.message}`)))})}isLoaded(){for(const r in this.numModelsLoading)if(this.numModelsLoading[r]>0)return!1;return!0}hasModel(r,h){return!!this.getModel(r,h)}getModel(r,h){return this.models[h]||(this.models[h]={}),this.models[h][r]?this.models[h][r].model:void 0}addModel(r,h,y){this.models[y]||(this.models[y]={}),this.hasModel(r,y)&&this.models[y][r].numReferences++,this.load({[r]:this.requestManager.normalizeModelURL(h)},y)}addModels(r,h){this.models[h]||(this.models[h]={});const y={};for(const b in r)this.models[h][b]={},y[b]=this.requestManager.normalizeModelURL(r[b]);this.load(y,h)}addModelsFromBucket(r,h){this.models[h]||(this.models[h]={});const y={};for(const b of r)this.hasModel(b,h)?this.models[h][b].numReferences++:y[b]=this.requestManager.normalizeModelURL(b);this.load(y,h)}removeModel(r,h){if(this.models[h]&&this.models[h][r]&&(this.models[h][r].numReferences--,this.models[h][r].numReferences===0)){const y=this.models[h][r].model;delete this.models[h][r],y.destroy()}}listModels(r){return this.models[r]||(this.models[r]={}),Object.keys(this.models[r])}upload(r,h){this.models[h]||(this.models[h]={});for(const y in this.models[h])this.models[h][y].model&&this.models[h][y].model.upload(r.context)}}function Un(m){const{userImage:r}=m;return!!(r&&r.render&&r.render())&&(m.data.replace(new Uint8Array(r.data.buffer)),!0)}class ho extends s.E{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded={},this.requestors=[],this.patterns={},this.atlasImage={},this.atlasTexture={},this.dirty=!0}createScope(r){this.images[r]={},this.loaded[r]=!1,this.updatedImages[r]={},this.patterns[r]={},this.callbackDispatchedThisFrame[r]={},this.atlasImage[r]=new s.i({width:1,height:1})}isLoaded(){for(const r in this.loaded)if(!this.loaded[r])return!1;return!0}setLoaded(r,h){if(this.loaded[h]!==r&&(this.loaded[h]=r,r)){for(const{ids:y,callback:b}of this.requestors)this._notify(y,h,b);this.requestors=[]}}hasImage(r,h){return!!this.getImage(r,h)}getImage(r,h){return this.images[h][r]}addImage(r,h,y){this._validate(r,y)&&(this.images[h][r]=y)}_validate(r,h){let y=!0;return this._validateStretch(h.stretchX,h.data&&h.data.width)||(this.fire(new s.d(new Error(`Image "${r}" has invalid "stretchX" value`))),y=!1),this._validateStretch(h.stretchY,h.data&&h.data.height)||(this.fire(new s.d(new Error(`Image "${r}" has invalid "stretchY" value`))),y=!1),this._validateContent(h.content,h)||(this.fire(new s.d(new Error(`Image "${r}" has invalid "content" value`))),y=!1),y}_validateStretch(r,h){if(!r)return!0;let y=0;for(const b of r){if(b[0]<y||b[1]<b[0]||h<b[1])return!1;y=b[1]}return!0}_validateContent(r,h){return!(r&&(r.length!==4||r[0]<0||h.data.width<r[0]||r[1]<0||h.data.height<r[1]||r[2]<0||h.data.width<r[2]||r[3]<0||h.data.height<r[3]||r[2]<r[0]||r[3]<r[1]))}updateImage(r,h,y){y.version=this.images[h][r].version+1,this.images[h][r]=y,this.updatedImages[h][r]=!0}removeImage(r,h){const y=this.images[h][r];delete this.images[h][r],delete this.patterns[h][r],y.userImage&&y.userImage.onRemove&&y.userImage.onRemove()}listImages(r){return Object.keys(this.images[r])}getImages(r,h,y){let b=!0;const T=!!this.loaded[h];if(!T)for(const E of r)this.images[h][E]||(b=!1);T||b?this._notify(r,h,y):this.requestors.push({ids:r,scope:h,callback:y})}getUpdatedImages(r){return this.updatedImages[r]}_notify(r,h,y){const b={};for(const T of r){this.images[h][T]||this.fire(new s.f("styleimagemissing",{id:T}));const E=this.images[h][T];E?b[T]={data:E.data.clone(),pixelRatio:E.pixelRatio,sdf:E.sdf,version:E.version,stretchX:E.stretchX,stretchY:E.stretchY,content:E.content,hasRenderCallback:!!(E.userImage&&E.userImage.render)}:s.w(`Image "${T}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}y(null,b)}getPixelSize(r){const{width:h,height:y}=this.atlasImage[r];return{width:h,height:y}}getPattern(r,h,y){const b=this.patterns[h][r],T=this.getImage(r,h);if(!T)return null;if(b&&b.position.version===T.version)return b.position;if(b)b.position.version=T.version;else{const E={w:T.data.width+2,h:T.data.height+2,x:0,y:0},I=new s.k(E,T);this.patterns[h][r]={bin:E,position:I}}return this._updatePatternAtlas(h,y),this.patterns[h][r].position}bind(r,h){const y=r.gl;let b=this.atlasTexture[h];b?this.dirty&&(b.update(this.atlasImage[h]),this.dirty=!1):(b=new s.T(r,this.atlasImage[h],y.RGBA),this.atlasTexture[h]=b),b.bind(y.LINEAR,y.CLAMP_TO_EDGE)}_updatePatternAtlas(r,h){const y=[];for(const I in this.patterns[r])y.push(this.patterns[r][I].bin);const{w:b,h:T}=s.j(y),E=this.atlasImage[r];E.resize({width:b||1,height:T||1});for(const I in this.patterns[r]){const{bin:k}=this.patterns[r][I],N=k.x+1,H=k.y+1,X=this.images[r][I].data,ee=X.width,ie=X.height;s.i.copy(X,E,{x:0,y:0},{x:N,y:H},{width:ee,height:ie},h),s.i.copy(X,E,{x:0,y:ie-1},{x:N,y:H-1},{width:ee,height:1},h),s.i.copy(X,E,{x:0,y:0},{x:N,y:H+ie},{width:ee,height:1},h),s.i.copy(X,E,{x:ee-1,y:0},{x:N-1,y:H},{width:1,height:ie},h),s.i.copy(X,E,{x:0,y:0},{x:N+ee,y:H},{width:1,height:ie},h)}this.dirty=!0}beginFrame(){for(const r in this.images)this.callbackDispatchedThisFrame[r]={}}dispatchRenderCallbacks(r,h){for(const y of r){if(this.callbackDispatchedThisFrame[h][y])continue;this.callbackDispatchedThisFrame[h][y]=!0;const b=this.images[h][y];Un(b)&&this.updateImage(y,h,b)}}}function Ri(m){const r=m.key,h=m.value,y=m.valueSpec||{},b=m.objectElementValidators||{},T=m.style,E=m.styleSpec;let I=[];const k=s.n(h);if(k!=="object")return[new s.V(r,h,`object expected, ${k} found`)];for(const N in h){const H=N.split(".")[0];let X;b[H]?X=b[H]:y[H]?X=se:b["*"]?X=b["*"]:y["*"]&&(X=se),X?I=I.concat(X({key:(r&&`${r}.`)+N,value:h[N],valueSpec:y[H]||y["*"],style:T,styleSpec:E,object:h,objectKey:N},h)):I.push(new s.m(r,h[N],`unknown property "${N}"`))}for(const N in y)b[N]||y[N].required&&y[N].default===void 0&&h[N]===void 0&&I.push(new s.V(r,h,`missing required property "${N}"`));return I}function jr(m){const r=m.value,h=m.valueSpec,y=m.style,b=m.styleSpec,T=m.key,E=m.arrayElementValidator||se;if(s.n(r)!=="array")return[new s.V(T,r,`array expected, ${s.n(r)} found`)];if(h.length&&r.length!==h.length)return[new s.V(T,r,`array length ${h.length} expected, length ${r.length} found`)];if(h["min-length"]&&r.length<h["min-length"])return[new s.V(T,r,`array length at least ${h["min-length"]} expected, length ${r.length} found`)];let I={type:h.value,values:h.values,minimum:h.minimum,maximum:h.maximum,function:void 0};b.$version<7&&(I.function=h.function),s.n(h.value)==="object"&&(I=h.value);let k=[];for(let N=0;N<r.length;N++)k=k.concat(E({array:r,arrayIndex:N,value:r[N],valueSpec:I,style:y,styleSpec:b,key:`${T}[${N}]`},!0));return k}function Ms(m){const r=m.key,h=m.value,y=m.valueSpec;let b=s.n(h);if(b==="number"&&h!=h&&(b="NaN"),b!=="number")return[new s.V(r,h,`number expected, ${b} found`)];if("minimum"in y){let T=y.minimum;if(s.n(y.minimum)==="array"&&(T=y.minimum[m.arrayIndex]),h<T)return[new s.V(r,h,`${h} is less than the minimum value ${T}`)]}if("maximum"in y){let T=y.maximum;if(s.n(y.maximum)==="array"&&(T=y.maximum[m.arrayIndex]),h>T)return[new s.V(r,h,`${h} is greater than the maximum value ${T}`)]}return[]}function Fs(m){const r=m.valueSpec,h=s.u(m.value.type);let y,b,T,E={};const I=h!=="categorical"&&m.value.property===void 0,k=!I,N=s.n(m.value.stops)==="array"&&s.n(m.value.stops[0])==="array"&&s.n(m.value.stops[0][0])==="object",H=Ri({key:m.key,value:m.value,valueSpec:m.styleSpec.function,style:m.style,styleSpec:m.styleSpec,objectElementValidators:{stops:function(ie){if(h==="identity")return[new s.V(ie.key,ie.value,'identity function may not have a "stops" property')];let ue=[];const pe=ie.value;return ue=ue.concat(jr({key:ie.key,value:pe,valueSpec:ie.valueSpec,style:ie.style,styleSpec:ie.styleSpec,arrayElementValidator:X})),s.n(pe)==="array"&&pe.length===0&&ue.push(new s.V(ie.key,pe,"array must have at least one stop")),ue},default:function(ie){return se({key:ie.key,value:ie.value,valueSpec:r,style:ie.style,styleSpec:ie.styleSpec})}}});return h==="identity"&&I&&H.push(new s.V(m.key,m.value,'missing required property "property"')),h==="identity"||m.value.stops||H.push(new s.V(m.key,m.value,'missing required property "stops"')),h==="exponential"&&m.valueSpec.expression&&!s.s(m.valueSpec)&&H.push(new s.V(m.key,m.value,"exponential functions not supported")),m.styleSpec.$version>=8&&(k&&!s.q(m.valueSpec)?H.push(new s.V(m.key,m.value,"property functions not supported")):I&&!s.r(m.valueSpec)&&H.push(new s.V(m.key,m.value,"zoom functions not supported"))),h!=="categorical"&&!N||m.value.property!==void 0||H.push(new s.V(m.key,m.value,'"property" property is required')),H;function X(ie){let ue=[];const pe=ie.value,fe=ie.key;if(s.n(pe)!=="array")return[new s.V(fe,pe,`array expected, ${s.n(pe)} found`)];if(pe.length!==2)return[new s.V(fe,pe,`array length 2 expected, length ${pe.length} found`)];if(N){if(s.n(pe[0])!=="object")return[new s.V(fe,pe,`object expected, ${s.n(pe[0])} found`)];if(pe[0].zoom===void 0)return[new s.V(fe,pe,"object stop key must have zoom")];if(pe[0].value===void 0)return[new s.V(fe,pe,"object stop key must have value")];const _e=s.u(pe[0].zoom);if(typeof _e!="number")return[new s.V(fe,pe[0].zoom,"stop zoom values must be numbers")];if(T&&T>_e)return[new s.V(fe,pe[0].zoom,"stop zoom values must appear in ascending order")];_e!==T&&(T=_e,b=void 0,E={}),ue=ue.concat(Ri({key:`${fe}[0]`,value:pe[0],valueSpec:{zoom:{}},style:ie.style,styleSpec:ie.styleSpec,objectElementValidators:{zoom:Ms,value:ee}}))}else ue=ue.concat(ee({key:`${fe}[0]`,value:pe[0],valueSpec:{},style:ie.style,styleSpec:ie.styleSpec},pe));return s.t(s.v(pe[1]))?ue.concat([new s.V(`${fe}[1]`,pe[1],"expressions are not allowed in function stops.")]):ue.concat(se({key:`${fe}[1]`,value:pe[1],valueSpec:r,style:ie.style,styleSpec:ie.styleSpec}))}function ee(ie,ue){const pe=s.n(ie.value),fe=s.u(ie.value),_e=ie.value!==null?ie.value:ue;if(y){if(pe!==y)return[new s.V(ie.key,_e,`${pe} stop domain type must match previous stop domain type ${y}`)]}else y=pe;if(pe!=="number"&&pe!=="string"&&pe!=="boolean"&&typeof fe!="number"&&typeof fe!="string"&&typeof fe!="boolean")return[new s.V(ie.key,_e,"stop domain value must be a number, string, or boolean")];if(pe!=="number"&&h!=="categorical"){let Le=`number expected, ${pe} found`;return s.q(r)&&h===void 0&&(Le+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new s.V(ie.key,_e,Le)]}return h!=="categorical"||pe!=="number"||typeof fe=="number"&&isFinite(fe)&&Math.floor(fe)===fe?h!=="categorical"&&pe==="number"&&typeof fe=="number"&&typeof b=="number"&&b!==void 0&&fe<b?[new s.V(ie.key,_e,"stop domain values must appear in ascending order")]:(b=fe,h==="categorical"&&fe in E?[new s.V(ie.key,_e,"stop domain values must be unique")]:(E[fe]=!0,[])):[new s.V(ie.key,_e,`integer expected, found ${String(fe)}`)]}}function Po(m){const r=(m.expressionContext==="property"?s.x:s.y)(s.v(m.value),m.valueSpec);if(r.result==="error")return r.value.map(y=>new s.V(`${m.key}${y.key}`,m.value,y.message));const h=r.value.expression||r.value._styleExpression.expression;if(m.expressionContext==="property"&&m.propertyKey==="text-font"&&!h.outputDefined())return[new s.V(m.key,m.value,`Invalid data expression for "${m.propertyKey}". Output values must be contained as literals within the expression.`)];if(m.expressionContext==="property"&&m.propertyType==="layout"&&!s.z(h))return[new s.V(m.key,m.value,'"feature-state" data expressions are not supported with layout properties.')];if(m.expressionContext==="filter")return ds(h,m);if(m.expressionContext&&m.expressionContext.indexOf("cluster")===0){if(!s.A(h,["zoom","feature-state"]))return[new s.V(m.key,m.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(m.expressionContext==="cluster-initial"&&!s.B(h))return[new s.V(m.key,m.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function ds(m,r){const h=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(r.valueSpec&&r.valueSpec.expression)for(const b of r.valueSpec.expression.parameters)h.delete(b);if(h.size===0)return[];const y=[];return m instanceof s.D&&h.has(m.name)?[new s.V(r.key,r.value,`["${m.name}"] expression is not supported in a filter for a ${r.object.type} layer with id: ${r.object.id}`)]:(m.eachChild(b=>{y.push(...ds(b,r))}),y)}function ys(m){const r=m.key,h=m.value,y=m.valueSpec,b=[];return Array.isArray(y.values)?y.values.indexOf(s.u(h))===-1&&b.push(new s.V(r,h,`expected one of [${y.values.join(", ")}], ${JSON.stringify(h)} found`)):Object.keys(y.values).indexOf(s.u(h))===-1&&b.push(new s.V(r,h,`expected one of [${Object.keys(y.values).join(", ")}], ${JSON.stringify(h)} found`)),b}function Mr(m){return s.G(s.v(m.value))?Po(s.o({},m,{expressionContext:"filter",valueSpec:m.styleSpec[`filter_${m.layerType||"fill"}`]})):Bs(m)}function Bs(m){const r=m.value,h=m.key;if(s.n(r)!=="array")return[new s.V(h,r,`array expected, ${s.n(r)} found`)];const y=m.styleSpec;let b,T=[];if(r.length<1)return[new s.V(h,r,"filter array must have at least 1 element")];switch(T=T.concat(ys({key:`${h}[0]`,value:r[0],valueSpec:y.filter_operator,style:m.style,styleSpec:m.styleSpec})),s.u(r[0])){case"<":case"<=":case">":case">=":r.length>=2&&s.u(r[1])==="$type"&&T.push(new s.V(h,r,`"$type" cannot be use with operator "${r[0]}"`));case"==":case"!=":r.length!==3&&T.push(new s.V(h,r,`filter array for operator "${r[0]}" must have 3 elements`));case"in":case"!in":r.length>=2&&(b=s.n(r[1]),b!=="string"&&T.push(new s.V(`${h}[1]`,r[1],`string expected, ${b} found`)));for(let E=2;E<r.length;E++)b=s.n(r[E]),s.u(r[1])==="$type"?T=T.concat(ys({key:`${h}[${E}]`,value:r[E],valueSpec:y.geometry_type,style:m.style,styleSpec:m.styleSpec})):b!=="string"&&b!=="number"&&b!=="boolean"&&T.push(new s.V(`${h}[${E}]`,r[E],`string, number, or boolean expected, ${b} found`));break;case"any":case"all":case"none":for(let E=1;E<r.length;E++)T=T.concat(Bs({key:`${h}[${E}]`,value:r[E],style:m.style,styleSpec:m.styleSpec}));break;case"has":case"!has":b=s.n(r[1]),r.length!==2?T.push(new s.V(h,r,`filter array for "${r[0]}" operator must have 2 elements`)):b!=="string"&&T.push(new s.V(`${h}[1]`,r[1],`string expected, ${b} found`))}return T}function js(m,r){const h=m.key,y=m.style,b=m.layer,T=m.styleSpec,E=m.value,I=m.objectKey,k=T[`${r}_${m.layerType}`];if(!k)return[];const N=I.match(/^(.*)-transition$/);if(r==="paint"&&N&&k[N[1]]&&k[N[1]].transition)return se({key:h,value:E,valueSpec:T.transition,style:y,styleSpec:T});const H=m.valueSpec||k[I];if(!H)return[new s.m(h,E,`unknown property "${I}"`)];let X;if(s.n(E)==="string"&&s.q(H)&&!H.tokens&&(X=/^{([^}]+)}$/.exec(E))){const ie=`\`{ "type": "identity", "property": ${X?JSON.stringify(X[1]):'"_"'} }\``;return[new s.V(h,E,`"${I}" does not support interpolation syntax
Use an identity property function instead: ${ie}.`)]}const ee=[];if(m.layerType==="symbol")I!=="text-field"||!y||y.glyphs||y.imports||ee.push(new s.V(h,E,'use of "text-field" requires a style "glyphs" property')),I==="text-font"&&s.H(s.v(E))&&s.u(E.type)==="identity"&&ee.push(new s.V(h,E,'"text-font" does not support identity functions'));else if(m.layerType==="model"&&r==="paint"&&b&&b.layout&&b.layout.hasOwnProperty("model-id")&&s.q(H)&&(s.J(H)||s.r(H))){const ie=s.x(s.v(E),H),ue=ie.value.expression||ie.value._styleExpression.expression;ue&&!s.A(ue,["measure-light"])&&(I==="model-emissive-strength"&&s.B(ue)&&s.z(ue)||ee.push(new s.V(h,E,`${I} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return ee.concat(se({key:m.key,value:E,valueSpec:H,style:y,styleSpec:T,expressionContext:"property",propertyType:r,propertyKey:I}))}function Wo(m){return js(m,"paint")}function Rs(m){return js(m,"layout")}function et(m){let r=[];const h=m.value,y=m.key,b=m.style,T=m.styleSpec;h.type||h.ref||r.push(new s.V(y,h,'either "type" or "ref" is required'));let E=s.u(h.type);const I=s.u(h.ref);if(h.id){const k=s.u(h.id);for(let N=0;N<m.arrayIndex;N++){const H=b.layers[N];s.u(H.id)===k&&r.push(new s.V(y,h.id,`duplicate layer id "${h.id}", previously used at line ${H.id.__line__}`))}}if("ref"in h){let k;["type","source","source-layer","filter","layout"].forEach(N=>{N in h&&r.push(new s.V(y,h[N],`"${N}" is prohibited for ref layers`))}),b.layers.forEach(N=>{s.u(N.id)===I&&(k=N)}),k?k.ref?r.push(new s.V(y,h.ref,"ref cannot reference another ref layer")):E=s.u(k.type):typeof I=="string"&&r.push(new s.V(y,h.ref,`ref layer "${I}" not found`))}else if(E!=="background"&&E!=="sky"&&E!=="slot")if(h.source){const k=b.sources&&b.sources[h.source],N=k&&s.u(k.type);k?N==="vector"&&E==="raster"?r.push(new s.V(y,h.source,`layer "${h.id}" requires a raster source`)):N==="raster"&&E!=="raster"?r.push(new s.V(y,h.source,`layer "${h.id}" requires a vector source`)):N!=="vector"||h["source-layer"]?N==="raster-dem"&&E!=="hillshade"?r.push(new s.V(y,h.source,"raster-dem source can only be used with layer type 'hillshade'.")):N!=="raster-array"||["raster","raster-particle"].includes(E)?E!=="line"||!h.paint||!h.paint["line-gradient"]&&!h.paint["line-trim-offset"]||N==="geojson"&&k.lineMetrics?E==="raster-particle"&&N!=="raster-array"&&r.push(new s.V(y,h.source,`layer "${h.id}" requires a 'raster-array' source.`)):r.push(new s.V(y,h,`layer "${h.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):r.push(new s.V(y,h.source,"raster-array source can only be used with layer type 'raster'.")):r.push(new s.V(y,h,`layer "${h.id}" must specify a "source-layer"`)):r.push(new s.V(y,h.source,`source "${h.source}" not found`))}else r.push(new s.V(y,h,'missing required property "source"'));return r=r.concat(Ri({key:y,value:h,valueSpec:T.layer,style:m.style,styleSpec:m.styleSpec,objectElementValidators:{"*":()=>[],type:()=>se({key:`${y}.type`,value:h.type,valueSpec:T.layer.type,style:m.style,styleSpec:m.styleSpec,object:h,objectKey:"type"}),filter:k=>Mr(s.o({layerType:E},k)),layout:k=>Ri({layer:h,key:k.key,value:k.value,valueSpec:{},style:k.style,styleSpec:k.styleSpec,objectElementValidators:{"*":N=>Rs(s.o({layerType:E},N))}}),paint:k=>Ri({layer:h,key:k.key,value:k.value,valueSpec:{},style:k.style,styleSpec:k.styleSpec,objectElementValidators:{"*":N=>Wo(s.o({layerType:E,layer:h},N))}})}})),r}function Bo(m){const r=m.value,h=m.key,y=s.n(r);return y!=="string"?[new s.V(h,r,`string expected, ${y} found`)]:[]}const As={promoteId:function({key:m,value:r}){if(s.n(r)==="string")return Bo({key:m,value:r});{const h=[];for(const y in r)h.push(...Bo({key:`${m}.${y}`,value:r[y]}));return h}}};function ps(m){const r=m.value,h=m.key,y=m.styleSpec,b=m.style;if(!r.type)return[new s.V(h,r,'"type" is required')];const T=s.u(r.type);let E=[];switch(["vector","raster","raster-dem","raster-array"].includes(T)&&(r.url||r.tiles||E.push(new s.m(h,r,'Either "url" or "tiles" is required.'))),T){case"vector":case"raster":case"raster-dem":case"raster-array":return E=E.concat(Ri({key:h,value:r,valueSpec:y[`source_${T.replace("-","_")}`],style:m.style,styleSpec:y,objectElementValidators:As})),E;case"geojson":if(E=Ri({key:h,value:r,valueSpec:y.source_geojson,style:b,styleSpec:y,objectElementValidators:As}),r.cluster)for(const I in r.clusterProperties){const[k,N]=r.clusterProperties[I],H=typeof k=="string"?[k,["accumulated"],["get",I]]:k;E.push(...Po({key:`${h}.${I}.map`,value:N,expressionContext:"cluster-map"})),E.push(...Po({key:`${h}.${I}.reduce`,value:H,expressionContext:"cluster-reduce"}))}return E;case"video":return Ri({key:h,value:r,valueSpec:y.source_video,style:b,styleSpec:y});case"image":return Ri({key:h,value:r,valueSpec:y.source_image,style:b,styleSpec:y});case"canvas":return[new s.V(h,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return ys({key:`${h}.type`,value:r.type,valueSpec:{values:No(y)},style:b,styleSpec:y})}}function No(m){return m.source.reduce((r,h)=>{const y=m[h];return y.type.type==="enum"&&(r=r.concat(Object.keys(y.type.values))),r},[])}function Ro(m){const r=m.value,h=m.styleSpec,y=h.light,b=m.style;let T=[];const E=s.n(r);if(r===void 0)return T;if(E!=="object")return T=T.concat([new s.V("light",r,`object expected, ${E} found`)]),T;for(const I in r){const k=I.match(/^(.*)-transition$/);T=T.concat(k&&y[k[1]]&&y[k[1]].transition?se({key:I,value:r[I],valueSpec:h.transition,style:b,styleSpec:h}):y[I]?se({key:I,value:r[I],valueSpec:y[I],style:b,styleSpec:h}):[new s.V(I,r[I],`unknown property "${I}"`)])}return T}function ca(m){const r=m.value;let h=[];if(!r)return h;const y=s.n(r);if(y!=="object")return h=h.concat([new s.V("light-3d",r,`object expected, ${y} found`)]),h;const b=m.styleSpec,T=b["light-3d"],E=m.key,I=m.style,k=m.style.lights;for(const X of["type","id"])if(!(X in r))return h=h.concat([new s.V("light-3d",r,`missing property ${X} on light`)]),h;if(r.type&&k)for(let X=0;X<m.arrayIndex;X++){const ee=s.u(r.type),ie=k[X];s.u(ie.type)===ee&&h.push(new s.V(E,r.id,`duplicate light type "${r.type}", previously defined at line ${ie.id.__line__}`))}const N=`properties_light_${r.type}`;if(!(N in b))return h=h.concat([new s.V("light-3d",r,`Invalid light type ${r.type}`)]),h;const H=b[N];for(const X in r)if(X==="properties"){const ee=r[X],ie=s.n(ee);if(ie!=="object")return h=h.concat([new s.V("properties",ee,`object expected, ${ie} found`)]),h;for(const ue in ee)h=h.concat(H[ue]?se({key:ue,value:ee[ue],valueSpec:H[ue],style:I,styleSpec:b}):[new s.m(m.key,ee[ue],`unknown property "${ue}"`)])}else{const ee=X.match(/^(.*)-transition$/);h=h.concat(ee&&T[ee[1]]&&T[ee[1]].transition?se({key:X,value:r[X],valueSpec:b.transition,style:I,styleSpec:b}):T[X]?se({key:X,value:r[X],valueSpec:T[X],style:I,styleSpec:b}):[new s.m(X,r[X],`unknown property "${X}"`)])}return h}function ha(m){const r=m.value,h=m.key,y=m.style,b=m.styleSpec,T=b.terrain;let E=[];const I=s.n(r);if(r===void 0||I==="null")return E;if(I!=="object")return E=E.concat([new s.V("terrain",r,`object expected, ${I} found`)]),E;for(const k in r){const N=k.match(/^(.*)-transition$/);E=E.concat(N&&T[N[1]]&&T[N[1]].transition?se({key:k,value:r[k],valueSpec:b.transition,style:y,styleSpec:b}):T[k]?se({key:k,value:r[k],valueSpec:T[k],style:y,styleSpec:b}):[new s.m(k,r[k],`unknown property "${k}"`)])}if(r.source){const k=y.sources&&y.sources[r.source],N=k&&s.u(k.type);k?N!=="raster-dem"&&E.push(new s.V(h,r.source,`terrain cannot be used with a source of type ${String(N)}, it only be used with a "raster-dem" source type`)):E.push(new s.V(h,r.source,`source "${r.source}" not found`))}else E.push(new s.V(h,r,'terrain is missing required property "source"'));return E}function ta(m){const r=m.value,h=m.style,y=m.styleSpec,b=y.fog;let T=[];const E=s.n(r);if(r===void 0)return T;if(E!=="object")return T=T.concat([new s.V("fog",r,`object expected, ${E} found`)]),T;for(const I in r){const k=I.match(/^(.*)-transition$/);T=T.concat(k&&b[k[1]]&&b[k[1]].transition?se({key:I,value:r[I],valueSpec:y.transition,style:h,styleSpec:y}):b[I]?se({key:I,value:r[I],valueSpec:b[I],style:h,styleSpec:y}):[new s.m(I,r[I],`unknown property "${I}"`)])}return T}const at={"*":()=>[],array:jr,boolean:function(m){const r=m.value,h=m.key,y=s.n(r);return y!=="boolean"?[new s.V(h,r,`boolean expected, ${y} found`)]:[]},number:Ms,color:function(m){const r=m.key,h=m.value,y=s.n(h);return y!=="string"?[new s.V(r,h,`color expected, ${y} found`)]:s.F(h)===null?[new s.V(r,h,`color expected, "${h}" found`)]:[]},enum:ys,filter:Mr,function:Fs,layer:et,object:Ri,source:ps,model:s.K,light:Ro,"light-3d":ca,terrain:ha,fog:ta,string:Bo,formatted:function(m){return Bo(m).length===0?[]:Po(m)},resolvedImage:function(m){return Bo(m).length===0?[]:Po(m)},projection:function(m){const r=m.value,h=m.styleSpec,y=h.projection,b=m.style;let T=[];const E=s.n(r);if(E==="object")for(const I in r)T=T.concat(se({key:I,value:r[I],valueSpec:y[I],style:b,styleSpec:h}));else E!=="string"&&(T=T.concat([new s.V("projection",r,`object or string expected, ${E} found`)]));return T},import:function(m){const{value:r,styleSpec:h}=m,{data:y,...b}=r;Object.defineProperty(b,"__line__",{value:r.__line__,enumerable:!1});let T=Ri(s.o({},m,{value:b,valueSpec:h.import}));return s.u(b.id)===""&&T.push(new s.V(`${m.key}.id`,b,"import id can't be an empty string")),y&&(T=T.concat(Oe(y,h,{key:`${m.key}.data`}))),T}};function se(m,r=!1){const h=m.value,y=m.valueSpec,b=m.styleSpec;if(y.expression&&s.H(s.u(h)))return Fs(m);if(y.expression&&s.t(s.v(h)))return Po(m);if(y.type&&at[y.type]){const T=at[y.type](m);return r===!0&&T.length>0&&s.n(m.value)==="array"?Po(m):T}return Ri(s.o({},m,{valueSpec:y.type?b[y.type]:y}))}function me(m){const r=m.value,h=m.key,y=Bo(m);return y.length||(r.indexOf("{fontstack}")===-1&&y.push(new s.V(h,r,'"glyphs" url must include a "{fontstack}" token')),r.indexOf("{range}")===-1&&y.push(new s.V(h,r,'"glyphs" url must include a "{range}" token'))),y}function Oe(m,r=s.L,h={}){return se({key:h.key||"",value:m,valueSpec:r.$root,styleSpec:r,style:m,objectElementValidators:{glyphs:me,"*":()=>[]}})}function Ke(m,r=s.L){return lr(Oe(m,r))}const tt=m=>lr(ps(m)),At=m=>lr(Ro(m)),Ft=m=>lr(ca(m)),yt=m=>lr(ha(m)),jt=m=>lr(ta(m)),Oi=m=>lr(et(m)),Mi=m=>lr(Mr(m)),wn=m=>lr(Wo(m)),Bn=m=>lr(Rs(m)),Vn=m=>lr(s.K(m));function lr(m){return m.slice().sort((r,h)=>r.line&&h.line?r.line-h.line:0)}function jn(m,r){let h=!1;if(r&&r.length)for(const y of r)y instanceof s.m?s.w(y.message):(m.fire(new s.d(new Error(y.message))),h=!0);return h}const fr=new s.N({anchor:new s.O(s.L.light.anchor),position:new s.Q(s.L.light.position),color:new s.O(s.L.light.color),intensity:new s.O(s.L.light.intensity)});class bn extends s.E{constructor(r,h="flat"){super(),this._transitionable=new s.U(fr),this.setLight(r,h),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(r,h,y={}){this._validate(At,r,y)||(this._transitionable.setTransitionOrValue(r),this.id=h)}updateTransitions(r){this._transitioning=this._transitionable.transitioned(r,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(r){this.properties=this._transitioning.possiblyEvaluate(r)}_validate(r,h,y){return(!y||y.validate!==!1)&&jn(this,r.call(Ke,s.W({value:h,style:{glyphs:!0,sprite:!0},styleSpec:s.L})))}}const as=new s.N({source:new s.O(s.L.terrain.source),exaggeration:new s.O(s.L.terrain.exaggeration)});let Vr=class extends s.E{constructor(m,r,h,y){super(),this.scope=h,this._transitionable=new s.U(as,h,y),this._transitionable.setTransitionOrValue(m,y),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=r}get(){return this._transitionable.serialize()}set(m,r){this._transitionable.setTransitionOrValue(m,r)}updateTransitions(m){this._transitioning=this._transitionable.transitioned(m,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(m){this.properties=this._transitioning.possiblyEvaluate(m)}getExaggeration(m){return this._transitioning.possiblyEvaluate(new s.X(m)).get("exaggeration")}isZoomDependent(){const m=this._transitionable._values.exaggeration;return m!=null&&m.value!=null&&m.value.expression!=null&&m.value.expression instanceof s.Z}};const br=45,Mn=65,Wr=.05;function ss(m,r,h,y){const b=s.$(br,Mn,h),[T,E]=Cs(m,y);let I=1-Math.min(1,Math.exp((r-T)/(E-T)*-6));return I*=I*I,I=Math.min(1,1.00747*I),I*b*m.alpha}function Cs(m,r){const h=.5/Math.tan(.5*r);return[m.range[0]+h,m.range[1]+h]}function uo(m,r,h,y,b){const T=s._.transformMat4([],[r,h,y],b.mercatorFogMatrix);return ss(m,s._.length(T),b.pitch,b._fov)}function bo(m,r,h,y,b,T,E){const I=[[h,y,0],[b,y,0],[b,T,0],[h,T,0]];let k=Number.MAX_VALUE,N=-Number.MAX_VALUE;for(const H of I){const X=s._.transformMat4([],H,r),ee=s._.length(X);k=Math.min(k,ee),N=Math.max(N,ee)}return[ss(m,k,E.pitch,E._fov),ss(m,N,E.pitch,E._fov)]}const wl=new s.N({range:new s.O(s.L.fog.range),color:new s.O(s.L.fog.color),"high-color":new s.O(s.L.fog["high-color"]),"space-color":new s.O(s.L.fog["space-color"]),"horizon-blend":new s.O(s.L.fog["horizon-blend"]),"star-intensity":new s.O(s.L.fog["star-intensity"]),"vertical-range":new s.O(s.L.fog["vertical-range"])});class wo extends s.E{constructor(r,h,y,b){super(),this._transitionable=new s.U(wl,y,new Map(b)),this.set(r,b),this._transitioning=this._transitionable.untransitioned(),this._transform=h,this.properties=new s.a0(wl),this.scope=y}get state(){const r=this._transform,h=r.projection.name==="globe",y=s.a1(r.zoom),b=this.properties.get("range"),T=[.5,3];return{range:h?[s.a2(T[0],b[0],y),s.a2(T[1],b[1],y)]:b,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(r,h,y={}){if(this._validate(jt,r,y))return;const b=s.W({},r);for(const T of Object.keys(s.L.fog))b[T]===void 0&&(b[T]=s.L.fog[T].default);this._options=b,this._transitionable.setTransitionOrValue(this._options,h)}getOpacity(r){if(!this._transform.projection.supportsFog)return 0;const h=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:s.$(br,Mn,r))*h.a}getOpacityAtLatLng(r,h){return this._transform.projection.supportsFog?function(y,b,T){const E=s.Y.fromLngLat(b),I=T.elevation?T.elevation.getAtPointOrZero(E):0;return uo(y,E.x,E.y,I,T)}(this.state,r,h):0}getOpacityForTile(r){if(!this._transform.projection.supportsFog)return[1,1];const h=this._transform.calculateFogTileMatrix(r.toUnwrapped());return bo(this.state,h,0,0,s.a3,s.a3,this._transform)}getOpacityForBounds(r,h,y,b,T){return this._transform.projection.supportsFog?bo(this.state,r,h,y,b,T,this._transform):[1,1]}getFovAdjustedRange(r){return this._transform.projection.supportsFog?Cs(this.state,r):[0,1]}isVisibleOnFrustum(r){if(!this._transform.projection.supportsFog)return!1;const h=[4,5,6,7];for(const y of h){const b=r.points[y];let T;if(b[2]>=0)T=b;else{const E=r.points[y-4];T=s.a4(E,b,E[2]/(E[2]-b[2]))}if(uo(this.state,T[0],T[1],0,this._transform)>=Wr)return!0}return!1}updateConfig(r){this._transitionable.setTransitionOrValue(this._options,new Map(r))}updateTransitions(r){this._transitioning=this._transitionable.transitioned(r,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(r){this.properties=this._transitioning.possiblyEvaluate(r)}_validate(r,h,y){return(!y||y.validate!==!1)&&jn(this,r.call(Ke,s.W({value:h,style:{glyphs:!0,sprite:!0},styleSpec:s.L})))}}class Ml extends s.E{constructor(r,h,y,b){super(),this.scope=y,this._options=r,this.properties=new s.a0(h),this._transitionable=new s.U(h,y,new Map(b)),this._transitionable.setTransitionOrValue(r.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(r){this._transitionable.setTransitionOrValue(this._options.properties,new Map(r))}updateTransitions(r){this._transitioning=this._transitionable.transitioned(r,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(r){this.properties=this._transitioning.possiblyEvaluate(r)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(r,h){this._options=r,this._transitionable.setTransitionOrValue(r.properties,h)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}const ur=new s.N({color:new s.O(s.L.properties_light_ambient.color),intensity:new s.O(s.L.properties_light_ambient.intensity)}),ba=new s.N({direction:new s.a5(s.L.properties_light_directional.direction),color:new s.O(s.L.properties_light_directional.color),intensity:new s.O(s.L.properties_light_directional.intensity),"cast-shadows":new s.O(s.L.properties_light_directional["cast-shadows"]),"shadow-intensity":new s.O(s.L.properties_light_directional["shadow-intensity"])});var ia=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#ifdef RENDER_CUTOFF
float cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}
#endif`,Ws=`
out vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec2 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color) {
#ifdef INDICATOR_CUTOUT
float holeMinOpacity=u_indicator_cutout_params.x;float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
glFragColor=vec4(0.7,0.0,0.0,0.7); \\
gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif
#ifdef RENDER_CUTOFF
uniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;
#endif
vec4 textureLodCustom(sampler2D image,vec2 pos,vec2 lod_coord) {vec2 size=vec2(textureSize(image,0));vec2 dx=dFdx(lod_coord.xy*size);vec2 dy=dFdy(lod_coord.xy*size);float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}`,Tl=`
#define EXTENT 8192.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}
#ifdef RENDER_CUTOFF
uniform vec4 u_cutoff_params;out float v_cutoff_opacity;
#endif
const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}`,Ba="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",be=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;uniform highp sampler2D u_depth;uniform vec2 u_depth_size_inv;uniform vec2 u_depth_range_unpack;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
#ifdef TERRAIN_DEPTH_D24
float unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}
#else
highp float unpack_depth_rgba(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;
#ifdef TERRAIN_DEPTH_D24
float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);
#else
float depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));
#endif
return coord.z > depth+0.0005;}float occlusionFade(vec4 frag) {vec3 coord=frag.xyz/frag.w;vec3 df=vec3(5.0*u_depth_size_inv,0.0);vec2 uv=0.5*coord.xy+0.5;
#ifdef TERRAIN_DEPTH_D24
vec4 depth=vec4(
texture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r
);depth=unpack_depth4(depth);
#else
vec4 depth=vec4(
unpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))
);
#endif
return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z-0.001)-depth),0.0,1.0));}vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }bool isOccluded(vec4 frag) { return false; }float occlusionFade(vec4 frag) { return 1.0; }
#endif`,ge=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,De=`highp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}
#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {
#ifdef FOG_DITHERING
vec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);
#else
return color;
#endif
}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,ut=`#ifdef RASTER_ARRAY
uniform sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)
);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)
);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}
#endif`,ui=`#ifdef RASTER_ARRAY
uniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}
#endif
uniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}`,Ei=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif//RENDER_SHADOWS`,ni=`#ifdef RENDER_SHADOWS
#ifdef DEPTH_TEXTURE
uniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;
#else
uniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;
#endif
uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;
#ifdef DEPTH_TEXTURE
shadow_depth=texture(u_shadowmap_1,uv).r;
#else
shadow_depth=unpack_depth(texture(u_shadowmap_1,uv))*0.5+0.5;
#endif
return step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;
#ifdef DEPTH_TEXTURE
shadow_depth=texture(u_shadowmap_0,uv).r;
#else
shadow_depth=unpack_depth(texture(u_shadowmap_0,uv))*0.5+0.5;
#endif
return step(shadow_depth,compare);}float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp vec2 uv=pos.xy;return shadow_sample_1(uv,pos.z-bias);}float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;
#ifdef NATIVE
highp vec2 uv=pos.xy;highp vec4 samples=textureGather(u_shadowmap_0,uv,0);lowp vec4 stepSamples=step(samples,vec4(compare0));
#else
highp vec2 uv00=pos.xy-vec2(0.5*u_shadow_texel_size);highp vec2 uv10=uv00+vec2(u_shadow_texel_size,0.0);highp vec2 uv01=uv00+vec2(0.0,u_shadow_texel_size);highp vec2 uv11=uv01+vec2(u_shadow_texel_size,0.0);lowp vec4 stepSamples=vec4(
shadow_sample_0(uv01,compare0),shadow_sample_0(uv11,compare0),shadow_sample_0(uv10,compare0),shadow_sample_0(uv00,compare0)
);
#endif
vec2 f=fract(pos.xy*u_shadow_map_resolution-vec2(0.5));lowp vec2 lerpx=mix(stepSamples.wx,stepSamples.zy,f.xx);return mix(lerpx.x,lerpx.y,f.y);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {
#ifdef SHADOWS_SINGLE_CASCADE
light_view_pos0.xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);
#else
light_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth));
#endif
}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;const ki=[];Bt(ia,ki),Bt(Tl,ki),Bt(Ws,ki);const he={"_prelude_fog.vertex.glsl":ge,"_prelude_terrain.vertex.glsl":be,"_prelude_shadow.vertex.glsl":Ei,"_prelude_fog.fragment.glsl":De,"_prelude_shadow.fragment.glsl":ni,"_prelude_lighting.glsl":`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif//LIGHTING_3D_MODE`,"_prelude_raster_array.glsl":ut,"_prelude_raster_particle.glsl":ui},le={};kt("",be),kt(De,ge),kt(ni,Ei),kt(ut,""),kt(ui,"");const we=kt(Ws,Tl),Ve=ia;var ze={background:kt(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec4 u_color;uniform float u_opacity;
#ifdef LIGHTING_3D_MODE
in vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_lighting.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:kt(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in vec2 v_pos;void main() {vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_tile_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),circle:kt(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
glFragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:kt("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:kt(`#include "_prelude_fog.fragment.glsl"
uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:kt(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:kt("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`#include "_prelude_terrain.vertex.glsl"
in vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in float a_size_scale;in vec2 a_padding;in float a_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;out float v_placed;out float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*(a_z_offset+elevation(a_anchor_pos)),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:kt("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}",`in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:kt("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",`#include "_prelude_terrain.vertex.glsl"
in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;
#endif
out vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),fill:kt(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutline:kt(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in highp vec2 v_pos;uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
in vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:kt(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_emissive_strength;in highp vec2 v_pos;in highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;out highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:kt(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;in vec2 v_pos;uniform float u_emissive_strength;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:kt(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in vec4 v_flat;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
in vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
in highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
in float v_flood_radius;in float v_has_floodlight;
#endif
uniform float u_emissive_strength;in float v_height;void main() {
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor;
#ifdef RENDER_CUTOFF
shadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}
#else
shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);
#endif
color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color.rgb=mix(color.rgb,v_flat.rgb,u_emissive_strength);color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
uniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
out vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
out highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
out float v_flood_radius;out float v_has_floodlight;
#endif
out float v_height;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float cutoff=1.0;vec3 scaled_pos=pos;
#ifdef RENDER_CUTOFF
vec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);cutoff=cutoff_opacity(u_cutoff_params,ground.z);if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0));gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=vec4(color.rgb,1.0);v_flat=vec4(linearProduct(color.rgb,vec3(calculate_NdotL(normal))),1.0);
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionDepth:kt(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_vertical_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
out highp float v_depth;void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base);pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:kt(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
in vec3 v_normal;
#endif
in vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
out vec2 v_pos;out vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
out vec3 v_normal;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif 
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:kt(`#include "_prelude_shadow.fragment.glsl"
precision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#ifdef FOG
in float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef RENDER_CUTOFF
shadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));
#endif
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0)).r);
#endif
glFragColor=vec4(shadow,1.0);}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#ifdef FOG
out float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);
#ifdef FOG
v_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);
#endif
}`),fillExtrusionGroundEffect:kt(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;
#ifdef SDF_SUBPASS
in highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
in highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));
#endif
glFragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
#ifdef RENDER_CUTOFF
fog*=v_cutoff_opacity;
#endif
glFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
glFragColor=color;
#endif
HANDLE_WIREFRAME_DEBUG;
#endif
}`,`#include "_prelude_fog.vertex.glsl"
in highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
out highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;
#ifdef FOG
out highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
const float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(1.0,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),hillshadePrepare:kt(`precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:kt(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
glFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);
#endif
#ifdef FOG
glFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:kt(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform lowp float u_device_pixel_ratio;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform lowp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec4 v_uv;
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;in vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;alpha*=linearstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture(u_gradient_image,v_uv.xy);
#else
out_color=color;
#endif
float trim_alpha=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/clamp(u_trim_fade_range[0],1e-4,1.0)));float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/clamp(u_trim_fade_range[1],1e-4,1.0)));float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=out_color.a;}
#endif
if (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}
#ifdef RENDER_LINE_BORDER
float edgeBlur=(border_width+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color.rgb=mix(border_color.rgb*border_color.a*trim_alpha,out_color.rgb,smoothAlpha);}}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define EXTRUDE_SCALE 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED)
in float a_z_offset;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
in highp vec4 a_packed;
#endif
#ifdef RENDER_LINE_DASH
in float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec4 v_uv;
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);
#if defined(ELEVATED)
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 halfCellProgress=normal.yx*32.0;float ele0=elevation(pos);float ele_line=max(ele0,max(elevation(pos+halfCellProgress),elevation(pos-halfCellProgress)));float ele1=elevation(pos+offsetTile);float ele2=elevation(pos-offsetTile);float ele_max=max(ele_line,0.5*(ele1+ele2));float ele=ele_max-ele0+ele1+a_z_offset ;gl_Position=u_matrix*vec4(pos+offsetTile,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*0.1*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);
#else
gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec4(a_uv_x,a_split_index*texel_height-half_texel_height,a_clip_start,a_clip_end);
#else
v_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/floorwidth,(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),linePattern:kt(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform highp float u_device_pixel_ratio;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec4 v_uv;
#endif
#ifdef LINE_JOIN_NONE
in vec2 v_pattern_data;
#endif
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define mediump float pixel_ratio
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize mediump float pixel_ratio
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;float x=mod(pattern_x,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);
#ifdef RENDER_LINE_TRIM_OFFSET
highp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {if (line_progress <=trim_end && line_progress >=trim_start) {color=vec4(0,0,0,0);}}
#endif
#ifdef LINE_JOIN_NONE
float pattern_len=pattern_size/aspect;float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}
#endif
#ifdef LIGHTING_3D_MODE
color=apply_lighting_ground(color);
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}
#ifdef INDICATOR_CUTOUT
color=applyCutout(color);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED)
in float a_z_offset;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec4 a_packed;
#endif
in highp float a_linesofar;
#ifdef LINE_JOIN_NONE
in highp vec3 a_pattern_data;out vec2 v_pattern_data;
#endif
uniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
out highp vec4 v_uv;
#endif
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
#pragma mapbox: define mediump float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define mediump float floorwidth
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define mediump float pixel_ratio
void main() {
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
#pragma mapbox: initialize mediump float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize mediump float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize mediump float pixel_ratio
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);
#if defined(ELEVATED)
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 halfCellProgress=normal.yx*32.0;float ele0=elevation(pos);float ele_line=max(ele0,max(elevation(pos+halfCellProgress),elevation(pos-halfCellProgress)));float ele1=elevation(pos+offsetTile);float ele2=elevation(pos-offsetTile);float ele_max=max(ele_line,0.5*(ele1+ele2));float ele=ele_max-ele0+ele1+a_z_offset ;gl_Position=u_matrix*vec4(pos+offsetTile,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*0.1*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);
#else
gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
float a_uv_x=a_packed[0];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];v_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;
#ifdef LINE_JOIN_NONE
v_width=floorwidth+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),raster:kt(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_raster_array.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
in float v_split_fade;
#endif
uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;
#ifndef RASTER_ARRAY
uniform sampler2D u_image0;uniform sampler2D u_image1;
#endif
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;
#endif
void main() {vec4 color0,color1,color;vec2 value;
#ifdef RASTER_COLOR
#ifdef RASTER_ARRAY
#ifdef RASTER_ARRAY_LINEAR
value=mix(
raTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#else
value=mix(
raTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#endif
if (value.y > 0.0) value.x/=value.y;
#else
color=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);
#endif
color=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;
#else
color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;
#ifdef GLOBE_POLES
color.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);
#endif
vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef PROJECTION_GLOBE_VIEW
glFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));
#endif
#ifdef RENDER_CUTOFF
glFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;in vec2 a_texture_pos;
#endif
out vec2 v_pos0;out vec2 v_pos1;out float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
out float v_split_fade;
#endif
void main() {vec2 uv;
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);
#endif
#else
float w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    
v_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;
#ifdef RENDER_CUTOFF
v_depth=gl_Position.z;
#endif
}`),rasterParticle:kt(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
uv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),rasterParticleDraw:kt("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",`#include "_prelude_raster_particle.glsl"
in float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(
mod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}`),rasterParticleTexture:kt("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:kt(`#include "_prelude_raster_particle.glsl"
uniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(
linearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)
);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}`,"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbolIcon:kt(`#include "_prelude_lighting.glsl"
uniform sampler2D u_texture;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
in float v_fade_opacity;in vec2 v_tex_a;
#ifdef ICON_TRANSITION
in vec2 v_tex_b;
#endif
#ifdef COLOR_ADJUSTMENT
uniform mat4 u_color_adj_mat;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float emissive_strength
lowp float alpha=opacity*v_fade_opacity;vec4 out_color;
#ifdef ICON_TRANSITION
vec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);
#else
out_color=texture(u_texture,v_tex_a);
#endif
#ifdef COLOR_ADJUSTMENT
out_color=u_color_adj_mat*out_color;
#endif
out_color*=alpha;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef OCCLUSION_QUERIES
in float a_occlusion_query_opacity;
#endif
#ifdef Z_OFFSET
in float a_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
in vec2 a_texb;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform vec3 u_up_vector;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out vec2 v_tex_a;
#ifdef ICON_TRANSITION
out vec2 v_tex_b;
#endif
out float v_fade_opacity;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float emissive_strength
#pragma mapbox: define lowp float occlusion_opacity
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float emissive_strength
#pragma mapbox: initialize lowp float occlusion_opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjected_point;vec2 a;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetProjected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;
#else
offsetProjected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;
#endif
vec2 b=offsetProjected_point.xy/offsetProjected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=globe_occlusion_fade;
#ifdef SYMBOL_OCCLUSION_BY_TERRAIN_DEPTH
occlusion_fade*=occlusionFade(projected_point);
#endif
float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change))*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);
#endif
v_tex_a=a_tex/u_texsize;
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
v_fade_opacity=out_fade_opacity;
#ifdef OCCLUSION_QUERIES
float occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);v_fade_opacity*=occludedFadeMultiplier;
#endif
}`),symbolSDF:kt(`#include "_prelude_lighting.glsl"
#define SDF_PX 8.0
uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;in float v_draw_halo;in vec2 v_data0;in vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef OCCLUSION_QUERIES
in float a_occlusion_query_opacity;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out float v_draw_halo;out vec2 v_data0;out vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
#pragma mapbox: define lowp float occlusion_opacity
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
#pragma mapbox: initialize lowp float occlusion_opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;
#endif
vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=globe_occlusion_fade;
#ifdef SYMBOL_OCCLUSION_BY_TERRAIN_DEPTH
occlusion_fade*=occlusionFade(projected_point);
#endif
float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;
#ifdef OCCLUSION_QUERIES
float occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;
#endif
float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);
#endif
float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,out_fade_opacity);}`),symbolTextAndIcon:kt(`#include "_prelude_lighting.glsl"
#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_halo;in float v_draw_halo;in vec4 v_data0;in vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef OCCLUSION_QUERIES
in float a_occlusion_query_opacity;
#endif
#ifdef Z_OFFSET
in float a_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out float v_draw_halo;out vec4 v_data0;out vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
#pragma mapbox: define lowp float occlusion_opacity
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
#pragma mapbox: initialize lowp float occlusion_opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offset_projected_point=u_matrix*vec4(a_pos+vec2(1,0),0,1);vec2 a=projected_point.xy/projected_point.w;vec2 b=offset_projected_point.xy/offset_projected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*font_scale);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=globe_occlusion_fade;
#ifdef SYMBOL_OCCLUSION_BY_TERRAIN_DEPTH
occlusion_fade*=occlusionFade(projected_point);
#endif
vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
float out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;
#ifdef OCCLUSION_QUERIES
float occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;
#endif
float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+ xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);
#endif
float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,out_fade_opacity,is_sdf);}`),terrainRaster:kt(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;in vec2 v_pos0;
#ifdef FOG
in float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
float cutoffOpacity=1.0;
#ifdef RENDER_CUTOFF
cutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);
#endif
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
vec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));
#endif
#else
float lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;
#ifdef FOG
out float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);
#endif
}`),terrainDepth:kt("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}`),skybox:kt(`#include "_prelude_fog.fragment.glsl"
in lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,Ba),skyboxGradient:kt(`#include "_prelude_fog.fragment.glsl"
in highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,Ba),skyboxCapture:kt(`
in highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}`,"in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:kt(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);vec3 dir=normalize(ray_dir);vec3 closest_point=dot(u_globe_pos,dir)*dir;float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
raster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(raster.rgb*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;
#endif
out vec2 v_pos0;void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:kt(`#include "_prelude_fog.fragment.glsl"
uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
glFragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
glFragColor=vec4(1,1,1,1);
#else
glFragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;
#ifndef NATIVE
c=dither(c,gl_FragCoord.xy+u_temporal_offset);
#endif
glFragColor=vec4(c*t,t);
#endif
}`,`in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:kt(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef OCCLUSION_TEXTURE_TRANSFORM
uniform vec4 u_occlusionTextureTransform;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
in lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
in highp float v_depth;uniform highp sampler2D u_depthTexture;uniform vec2 u_inv_depth_size;uniform vec2 u_depth_range_unpack;
#ifdef TERRAIN_DEPTH_D24
float unpack_depth(float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}
#else
highp float unpack_depth_rgba(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded() {vec2 coord=gl_FragCoord.xy*u_inv_depth_size;
#ifdef TERRAIN_DEPTH_D24
highp float depth=unpack_depth(texture(u_depthTexture,coord).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));
#endif
return v_depth > depth+0.0005;}
#endif
#define saturate(_x) clamp(_x,0.,1.)
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
if(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}
#endif
vec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
return color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
#ifdef OCCLUSION_TEXTURE_TRANSFORM
vec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;
#else
vec2 uv=uv_2f;
#endif
ao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);
#endif
#ifdef APPLY_LUT_ON_GPU
float emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;
#ifdef APPLY_LUT_ON_GPU
color_mix=applyLUT(u_lutTexture,color_mix);
#endif
color=mix(color,color_mix,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
vec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));
#endif
#ifdef RENDER_CUTOFF
finalColor*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor);
#endif
glFragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
out vec4 v_position_height;out lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
out highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
out lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
v_position_height.w=a_pos_3f.z;
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normalize(normal_3f));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:kt(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:kt(`in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
in vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`),occlusion:kt("uniform vec4 u_color;void main() {glFragColor=u_color;}",`#include "_prelude_terrain.vertex.glsl"
in highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;
#ifdef TERRAIN
float e=elevation(world_pos.xy);world_pos.z+=e;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}`)};function Bt(m,r){const h=m.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let y of h)if(y=y.trim(),y[0]==="#"&&y.includes("if")&&!y.includes("endif")){y=y.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const b=y.split(" ");for(const T of b)r.includes(T)||r.push(T)}}function kt(m,r){const h=/#include\s+"([^"]+)"/g,y=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let b=r.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);b&&(b=b.map(N=>{const H=N.split(" ");return H[H.length-1]}),b=[...new Set(b)]);const T={},E=[],I=[];if(m=m.replace(h,(N,H)=>(I.push(H),"")),(r=r.replace(h,(N,H)=>(E.push(H),""))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let k=[...ki];Bt(m,k),Bt(r,k);for(const N of[...E,...I])he[N]||console.error(`Undefined include: ${N}`),le[N]||(le[N]=[],Bt(he[N],le[N])),k=[...k,...le[N]];return{fragmentSource:m=m.replace(y,(N,H,X,ee,ie)=>(T[ie]=!0,H==="define"?`
#ifndef HAS_UNIFORM_u_${ie}
in ${X} ${ee} ${ie};
#else
uniform ${X} ${ee} u_${ie};
#endif
`:H==="initialize"?`
#ifdef HAS_UNIFORM_u_${ie}
    ${X} ${ee} ${ie} = u_${ie};
#endif
`:H==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${ie}
    in ${X} ${ee} ${ie};
#endif
`:H==="initialize-attribute"?"":void 0)),vertexSource:r=r.replace(y,(N,H,X,ee,ie)=>{const ue=ee==="float"?"vec2":ee,pe=ie.match(/color/)?"color":ue;return H==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${ie}
in ${X} ${ee} a_${ie};
#endif
`:T[ie]?H==="define"?`
#ifndef HAS_UNIFORM_u_${ie}
uniform lowp float u_${ie}_t;
in ${X} ${ue} a_${ie};
out ${X} ${ee} ${ie};
#else
uniform ${X} ${ee} u_${ie};
#endif
`:H==="initialize"?pe==="vec4"?`
#ifndef HAS_UNIFORM_u_${ie}
    ${ie} = a_${ie};
#else
    ${X} ${ee} ${ie} = u_${ie};
#endif
`:`
#ifndef HAS_UNIFORM_u_${ie}
    ${ie} = unpack_mix_${pe}(a_${ie}, u_${ie}_t);
#else
    ${X} ${ee} ${ie} = u_${ie};
#endif
`:H==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${ie}
    in ${X} ${ee} a_${ie};
    out ${X} ${ee} ${ie};
#endif
`:H==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${ie}
    ${ie} = a_${ie};
#endif
`:void 0:H==="define"?`
#ifndef HAS_UNIFORM_u_${ie}
uniform lowp float u_${ie}_t;
in ${X} ${ue} a_${ie};
#else
uniform ${X} ${ee} u_${ie};
#endif
`:H==="define-instanced"?pe==="mat4"?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${ie}0;
in vec4 a_${ie}1;
in vec4 a_${ie}2;
in vec4 a_${ie}3;
#else
uniform ${X} ${ee} u_${ie};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${X} ${ue} a_${ie};
#else
uniform ${X} ${ee} u_${ie};
#endif
`:H==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${ie}
    ${X} ${ee} ${ie} = a_${ie};
#endif
`:pe==="vec4"?`
#ifndef HAS_UNIFORM_u_${ie}
    ${X} ${ee} ${ie} = a_${ie};
#else
    ${X} ${ee} ${ie} = u_${ie};
#endif
`:`
#ifndef HAS_UNIFORM_u_${ie}
    ${X} ${ee} ${ie} = unpack_mix_${pe}(a_${ie}, u_${ie}_t);
#else
    ${X} ${ee} ${ie} = u_${ie};
#endif
`}),staticAttributes:b,usedDefines:k,vertexIncludes:E,fragmentIncludes:I}}class Di{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(r,h,y,b,T,E,I,k){this.context=r;let N=this.boundPaintVertexBuffers.length!==b.length;for(let X=0;!N&&X<b.length;X++)this.boundPaintVertexBuffers[X]!==b[X]&&(N=!0);let H=this.boundDynamicVertexBuffers.length!==I.length;for(let X=0;!H&&X<I.length;X++)this.boundDynamicVertexBuffers[X]!==I[X]&&(H=!0);if(!this.vao||this.boundProgram!==h||this.boundLayoutVertexBuffer!==y||N||H||this.boundIndexBuffer!==T||this.boundVertexOffset!==E)this.freshBind(h,y,b,T,E,I,k);else{r.bindVertexArrayOES.set(this.vao);for(const X of I)X&&(X.bind(),k&&X.instanceCount&&X.setVertexAttribDivisor(r.gl,h,k));T&&T.dynamicDraw&&T.bind()}}freshBind(r,h,y,b,T,E,I){const k=r.numAttributes,N=this.context,H=N.gl;this.vao&&this.destroy(),this.vao=N.gl.createVertexArray(),N.bindVertexArrayOES.set(this.vao),this.boundProgram=r,this.boundLayoutVertexBuffer=h,this.boundPaintVertexBuffers=y,this.boundIndexBuffer=b,this.boundVertexOffset=T,this.boundDynamicVertexBuffers=E,h.enableAttributes(H,r),h.bind(),h.setVertexAttribPointers(H,r,T);for(const X of y)X.enableAttributes(H,r),X.bind(),X.setVertexAttribPointers(H,r,T);for(const X of E)X&&(X.enableAttributes(H,r),X.bind(),X.setVertexAttribPointers(H,r,T),I&&X.instanceCount&&X.setVertexAttribDivisor(H,r,I));b&&b.bind(),N.currentNumAttributes=k}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function cn(m,r){const h=Math.pow(2,r.canonical.z),y=r.canonical.y;return[new s.Y(0,y/h).toLngLat().lat,new s.Y(0,(y+1)/h).toLngLat().lat]}function Sn(m,r,h,y,b,T,E){const I=m.context,k=I.gl,N=h.hillshadeFBO;if(!N)return;m.prepareDrawTile();const H=m.isTileAffectedByFog(r),X=m.getOrCreateProgram("hillshade",{overrideFog:H});I.activeTexture.set(k.TEXTURE0),k.bindTexture(k.TEXTURE_2D,N.colorAttachment.get());const ee=((fe,_e,Le,Fe)=>{const Be=Le.paint.get("hillshade-shadow-color"),$e=Le.paint.get("hillshade-highlight-color"),Ze=Le.paint.get("hillshade-accent-color"),rt=Le.paint.get("hillshade-emissive-strength");let xe=s.ab(Le.paint.get("hillshade-illumination-direction"));if(Le.paint.get("hillshade-illumination-anchor")==="viewport")xe-=fe.transform.angle;else if(fe.style&&fe.style.enable3dLights()&&fe.style.directionalLight){const ct=fe.style.directionalLight.properties.get("direction"),Ot=s.ac(ct.x,ct.y,ct.z);xe=s.ab(Ot[1])}const Ne=!fe.options.moving;return{u_matrix:Fe||fe.transform.calculateProjMatrix(_e.tileID.toUnwrapped(),Ne),u_image:0,u_latrange:cn(0,_e.tileID),u_light:[Le.paint.get("hillshade-exaggeration"),xe],u_shadow:Be.toRenderColor(Le.lut),u_highlight:$e.toRenderColor(Le.lut),u_emissive_strength:rt,u_accent:Ze.toRenderColor(Le.lut)}})(m,h,y,m.terrain?r.projMatrix:null);m.uploadCommonUniforms(I,X,r.toUnwrapped());const{tileBoundsBuffer:ie,tileBoundsIndexBuffer:ue,tileBoundsSegments:pe}=m.getTileBoundsBuffers(h);X.draw(m,k.TRIANGLES,b,T,E,s.af.disabled,ee,y.id,ie,ue,pe)}function Hi(m,r,h){if(!r.needsDEMTextureUpload)return;const y=m.context,b=y.gl;y.pixelStoreUnpackPremultiplyAlpha.set(!1),r.demTexture=r.demTexture||m.getTileTexture(h.stride);const T=h.getPixels();r.demTexture?r.demTexture.update(T,{premultiply:!1}):r.demTexture=new s.T(y,T,b.R32F,{premultiply:!1}),r.needsDEMTextureUpload=!1}function yi(m,r,h){const y=m.context,b=y.gl;if(!r.dem)return;const T=r.dem;if(y.activeTexture.set(b.TEXTURE1),Hi(m,r,T),!r.demTexture)return;r.demTexture.bind(b.NEAREST,b.CLAMP_TO_EDGE);const E=T.dim;y.activeTexture.set(b.TEXTURE0);let I=r.hillshadeFBO;if(!I){const ee=new s.T(y,{width:E,height:E,data:null},b.RGBA);ee.bind(b.LINEAR,b.CLAMP_TO_EDGE),I=r.hillshadeFBO=y.createFramebuffer(E,E,!0,"renderbuffer"),I.colorAttachment.set(ee.texture)}y.bindFramebuffer.set(I.framebuffer),y.viewport.set([0,0,E,E]);const{tileBoundsBuffer:k,tileBoundsIndexBuffer:N,tileBoundsSegments:H}=m.getMercatorTileBoundsBuffers(),X=[];m.linearFloatFilteringSupported()&&X.push("TERRAIN_DEM_FLOAT_FORMAT"),m.getOrCreateProgram("hillshadePrepare",{defines:X}).draw(m,b.TRIANGLES,s.ae.disabled,s.ag.disabled,s.a.unblended,s.af.disabled,((ee,ie)=>{const ue=ie.stride,pe=s.ad.create();return s.ad.ortho(pe,0,s.a3,-s.a3,0,0,1),s.ad.translate(pe,pe,[0,-s.a3,0]),{u_matrix:pe,u_image:1,u_dimension:[ue,ue],u_zoom:ee.overscaledZ}})(r.tileID,T),h.id,k,N,H),r.needsHillshadePrepare=!1}function zn(m,r,h,y,b){const T=function(E,I){if(E)return b(E);if(I){if(m.url&&I.tiles&&m.tiles&&delete m.tiles,I.variants){if(!Array.isArray(I.variants))return b(new Error("variants must be an array"));for(const N of I.variants){if(N==null||typeof N!="object"||N.constructor!==Object)return b(new Error("variant must be an object"));if(!Array.isArray(N.capabilities))return b(new Error("capabilities must be an array"));if(N.capabilities.length===1&&N.capabilities[0]==="meshopt"){I=s.W(I,N);break}}}const k=s.ah(s.W(I,m),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);I.vector_layers&&(k.vectorLayers=I.vector_layers,k.vectorLayerIds=k.vectorLayers.map(N=>N.id)),I.raster_layers&&(k.rasterLayers=I.raster_layers,k.rasterLayerIds=k.rasterLayers.map(N=>N.id)),k.tiles=r.canonicalizeTileset(k,m.url),b(null,k)}};return m.url?s.g(r.transformRequest(r.normalizeSourceURL(m.url,null,h,y),s.R.Source),T):s.e.frame(()=>T(null,m))}class Zi{constructor(r,h,y){this.bounds=s.ai.convert(this.validateBounds(r)),this.minzoom=h||0,this.maxzoom=y||24}validateBounds(r){return Array.isArray(r)&&r.length===4?[Math.max(-180,r[0]),Math.max(-90,r[1]),Math.min(180,r[2]),Math.min(90,r[3])]:[-180,-90,180,90]}contains(r){const h=Math.pow(2,r.z),y=Math.floor(s.aj(this.bounds.getWest())*h),b=Math.floor(s.ak(this.bounds.getNorth())*h),T=Math.ceil(s.aj(this.bounds.getEast())*h),E=Math.ceil(s.ak(this.bounds.getSouth())*h);return r.x>=y&&r.x<T&&r.y>=b&&r.y<E}}class Ln extends s.E{constructor(r,h,y,b){super(),this.id=r,this.dispatcher=y,this.setEventedParent(b),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=s.W({type:"raster"},h),s.W(this,s.ah(h,["url","scheme","tileSize"]))}load(r){this._loaded=!1,this.fire(new s.f("dataloading",{dataType:"source"})),this._tileJSONRequest=zn(this._options,this.map._requestManager,null,null,(h,y)=>{this._tileJSONRequest=null,this._loaded=!0,h?this.fire(new s.d(h)):y&&(s.W(this,y),y.bounds&&(this.tileBounds=new Zi(y.bounds,this.minzoom,this.maxzoom)),s.an(y.tiles),this.fire(new s.f("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.f("data",{dataType:"source",sourceDataType:"content"}))),r&&r(h)})}loaded(){return this._loaded}onAdd(r){this.map=r,this.load()}reload(){this.cancelTileJSONRequest();const r=s.al(this.id,this.scope);this.load(()=>this.map.style.clearSource(r))}setTiles(r){return this._options.tiles=r,this.reload(),this}setUrl(r){return this.url=r,this._options.url=r,this.reload(),this}onRemove(r){this.cancelTileJSONRequest()}serialize(){return s.W({},this._options)}hasTile(r){return!this.tileBounds||this.tileBounds.contains(r.canonical)}loadTile(r,h){const y=s.e.devicePixelRatio>=2,b=this.map._requestManager.normalizeTileURL(r.tileID.canonical.url(this.tiles,this.scheme),y,this.tileSize);r.request=s.h(this.map._requestManager.transformRequest(b,s.R.Tile),(T,E,I,k)=>(delete r.request,r.aborted?(r.state="unloaded",h(null)):T?(r.state="errored",h(T)):E?(this.map._refreshExpiredTiles&&r.setExpiryData({cacheControl:I,expires:k}),r.setTexture(E,this.map.painter),r.state="loaded",s.am(this.dispatcher),void h(null)):h(null)))}abortTile(r,h){r.request&&(r.request.cancel(),delete r.request),h&&h()}unloadTile(r,h){r.texture&&r.texture instanceof s.T?(r.destroy(!0),r.texture&&r.texture instanceof s.T&&this.map.painter.saveTileTexture(r.texture)):r.destroy(),h&&h()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class Bi extends s.E{constructor(r,h,y,b){if(super(),this.id=r,this.dispatcher=y,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,s.W(this,s.ah(h,["url","scheme","tileSize","promoteId"])),this._options=s.W({type:"vector"},h),this._collectResourceTiming=!!h.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(b),this._tileWorkers={},this._deduped=new s.ao}load(r){this._loaded=!1,this.fire(new s.f("dataloading",{dataType:"source"}));const h=Array.isArray(this.map._language)?this.map._language.join():this.map._language,y=this.map._worldview;this._tileJSONRequest=zn(this._options,this.map._requestManager,h,y,(b,T)=>{this._tileJSONRequest=null,this._loaded=!0,b?(h&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${h}`),y&&y.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${y}`),this.fire(new s.d(b))):T&&(s.W(this,T),T.bounds&&(this.tileBounds=new Zi(T.bounds,this.minzoom,this.maxzoom)),s.an(T.tiles,this.map._requestManager._customAccessToken),this.fire(new s.f("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.f("data",{dataType:"source",sourceDataType:"content"}))),r&&r(b)})}loaded(){return this._loaded}hasTile(r){return!this.tileBounds||this.tileBounds.contains(r.canonical)}onAdd(r){this.map=r,this.load()}reload(){this.cancelTileJSONRequest();const r=s.al(this.id,this.scope);this.load(()=>this.map.style.clearSource(r))}setTiles(r){return this._options.tiles=r,this.reload(),this}setUrl(r){return this.url=r,this._options.url=r,this.reload(),this}onRemove(r){this.cancelTileJSONRequest()}serialize(){return s.W({},this._options)}loadTile(r,h){const y=this.map._requestManager.normalizeTileURL(r.tileID.canonical.url(this.tiles,this.scheme)),b=this.map._requestManager.transformRequest(y,s.R.Tile),T=this.map.style?this.map.style.getLut(this.scope):null,E={request:b,data:void 0,uid:r.uid,tileID:r.tileID,tileZoom:r.tileZoom,zoom:r.tileID.overscaledZ,lut:T?{image:T.image.clone()}:null,tileSize:this.tileSize*r.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:s.e.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:r.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:r.isExtraShadowCaster,tessellationStep:this.map._tessellationStep};if(E.request.collectResourceTiming=this._collectResourceTiming,r.actor&&r.state!=="expired")r.state==="loading"?r.reloadCallback=h:r.request=r.actor.send("reloadTile",E,I.bind(this));else if(r.actor=this._tileWorkers[y]=this._tileWorkers[y]||this.dispatcher.getActor(),this.dispatcher.ready)r.request=r.actor.send("loadTile",E,I.bind(this),void 0,!0);else{const k=s.ap.call({deduped:this._deduped},E,(N,H)=>{N||!H?I.call(this,N):(E.data={cacheControl:H.cacheControl,expires:H.expires,rawData:H.rawData.slice(0)},r.actor&&r.actor.send("loadTile",E,I.bind(this),void 0,!0))},!0);r.request={cancel:k}}function I(k,N){return delete r.request,r.aborted?h(null):k&&k.status!==404?h(k):(N&&N.resourceTiming&&(r.resourceTiming=N.resourceTiming),this.map._refreshExpiredTiles&&N&&r.setExpiryData(N),r.loadVectorData(N,this.map.painter),s.am(this.dispatcher),h(null),void(r.reloadCallback&&(this.loadTile(r,r.reloadCallback),r.reloadCallback=null)))}}abortTile(r){r.request&&(r.request.cancel(),delete r.request),r.actor&&r.actor.send("abortTile",{uid:r.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(r,h){r.actor&&r.actor.send("removeTile",{uid:r.uid,type:this.type,source:this.id,scope:this.scope}),r.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}const Nn=(m,r,h)=>({u_matrix:m,u_image0:0,u_skirt_height:r,u_ground_shadow_factor:h}),Kt=(m,r,h,y,b,T,E,I,k,N,H,X,ee,ie,ue,pe)=>({u_proj_matrix:Float32Array.from(m),u_globe_matrix:r,u_normalize_matrix:Float32Array.from(y),u_merc_matrix:h,u_zoom_transition:b,u_merc_center:T,u_image0:0,u_frustum_tl:E,u_frustum_tr:I,u_frustum_br:k,u_frustum_bl:N,u_globe_pos:H,u_globe_radius:X,u_viewport:ee,u_grid_matrix:pe?Float32Array.from(pe):new Float32Array(9),u_skirt_height:ie,u_far_z_cutoff:ue});class xr{constructor(r=0,h=0,y=0,b=0){if(isNaN(r)||r<0||isNaN(h)||h<0||isNaN(y)||y<0||isNaN(b)||b<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=r,this.bottom=h,this.left=y,this.right=b}interpolate(r,h,y){return h.top!=null&&r.top!=null&&(this.top=s.a2(r.top,h.top,y)),h.bottom!=null&&r.bottom!=null&&(this.bottom=s.a2(r.bottom,h.bottom,y)),h.left!=null&&r.left!=null&&(this.left=s.a2(r.left,h.left,y)),h.right!=null&&r.right!=null&&(this.right=s.a2(r.right,h.right,y)),this}getCenter(r,h){const y=s.at((this.left+r-this.right)/2,0,r),b=s.at((this.top+h-this.bottom)/2,0,h);return new s.P(y,b)}equals(r){return this.top===r.top&&this.bottom===r.bottom&&this.left===r.left&&this.right===r.right}clone(){return new xr(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function gr(m,r){const h=s.aw(m,3);s.ad.fromQuat(m,r),s.az(m,3,h)}function Pn(m,r){const h=s.av.identity([]);return s.av.rotateZ(h,h,-r),s.av.rotateX(h,h,-m),h}function _r(m,r){const h=[m[0],m[1],0],y=[r[0],r[1],0];if(s._.length(h)>=1e-15){const E=s._.normalize([],h);s._.scale(y,E,s._.dot(y,E)),r[0]=y[0],r[1]=y[1]}const b=s._.cross([],r,m);if(s._.len(b)<1e-15)return null;const T=Math.atan2(-b[1],b[0]);return Pn(Math.atan2(Math.sqrt(m[0]*m[0]+m[1]*m[1]),-m[2]),T)}class un{constructor(r,h){this.position=r,this.orientation=h}get position(){return this._position}set position(r){if(r){const h=r instanceof s.Y?r:new s.Y(r[0],r[1],r[2]);this._renderWorldCopies&&(h.x=s.au(h.x,0,1)),this._position=h}else this._position=null}lookAtPoint(r,h){if(this.orientation=null,!this.position)return;const y=this.position,b=this._elevation?this._elevation.getAtPointOrZero(s.Y.fromLngLat(r)):0,T=s.Y.fromLngLat(r,b),E=[T.x-y.x,T.y-y.y,T.z-y.z];h||(h=[0,0,1]),h[2]=Math.abs(h[2]),this.orientation=_r(E,h)}setPitchBearing(r,h){this.orientation=Pn(s.ab(r),s.ab(-h))}}class fs{constructor(r,h){this._transform=s.ad.identity([]),this.orientation=h,this.position=r}get mercatorPosition(){const r=this.position;return new s.Y(r[0],r[1],r[2])}get position(){const r=s.aw(this._transform,3);return[r[0],r[1],r[2]]}set position(r){var h;r&&s.az(this._transform,3,[(h=r)[0],h[1],h[2],1])}get orientation(){return this._orientation}set orientation(r){this._orientation=r||s.av.identity([]),r&&gr(this._transform,this._orientation)}getPitchBearing(){const r=this.forward(),h=this.right();return{bearing:Math.atan2(-h[1],h[0]),pitch:Math.atan2(Math.sqrt(r[0]*r[0]+r[1]*r[1]),-r[2])}}setPitchBearing(r,h){this._orientation=Pn(r,h),gr(this._transform,this._orientation)}forward(){const r=s.aw(this._transform,2);return[-r[0],-r[1],-r[2]]}up(){const r=s.aw(this._transform,1);return[-r[0],-r[1],-r[2]]}right(){const r=s.aw(this._transform,0);return[r[0],r[1],r[2]]}getCameraToWorld(r,h){const y=new Float64Array(16);return s.ad.invert(y,this.getWorldToCamera(r,h)),y}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(r,h,y){const b=this.position;s._.scale(b,b,-r);const T=new Float64Array(16);return s.ad.fromScaling(T,[y,y,y]),s.ad.translate(T,T,b),T[10]*=h,T}getWorldToCamera(r,h){const y=new Float64Array(16),b=new Float64Array(4),T=this.position;return s.av.conjugate(b,this._orientation),s._.scale(T,T,-r),s.ad.fromQuat(y,b),s.ad.translate(y,y,T),y[1]*=-1,y[5]*=-1,y[9]*=-1,y[13]*=-1,y[8]*=h,y[9]*=h,y[10]*=h,y[11]*=h,y}getCameraToClipPerspective(r,h,y,b){const T=new Float64Array(16);return s.ad.perspective(T,r,h,y,b),T}getCameraToClipOrthographic(r,h,y,b,T,E){const I=new Float64Array(16);return s.ad.ortho(I,r,h,y,b,T,E),I}getDistanceToElevation(r,h=!1){const y=r===0?0:s.ax(r,h?s.ay(this.position[1]):this.position[1]),b=this.forward();return(y-this.position[2])/b[2]}clone(){return new fs([...this.position],[...this.orientation])}}const yr={unknown:0,flipRequired:1,flipNotRequired:2},Ks=Math.tan(85*Math.PI/180);function pn(m,r,h,y,b,T,E){const I=s.ad.create();if(h)if(T.name==="globe"){const k=s.aB(b,r);s.ad.multiply(I,I,k)}else{const k=s.aC.invert([],E);I[0]=k[0],I[1]=k[1],I[4]=k[2],I[5]=k[3],y||s.ad.rotateZ(I,I,b.angle)}else s.ad.multiply(I,b.labelPlaneMatrix,m);return I}function Mo(m,r,h,y,b,T,E){const I=pn(m,r,h,y,b,T,E);return T.name==="globe"&&h||(I[2]=I[6]=I[10]=I[14]=0),I}function To(m,r,h,y,b,T,E){if(h){if(T.name==="globe"){const I=pn(m,r,h,y,b,T,E);return s.ad.invert(I,I),s.ad.multiply(I,m,I),I}{const I=s.ad.clone(m),k=s.ad.identity([]);return k[0]=E[0],k[1]=E[1],k[4]=E[2],k[5]=E[3],s.ad.multiply(I,I,k),y||s.ad.rotateZ(I,I,-b.angle),I}}return b.glCoordMatrix}function Ds(m,r,h,y){const b=[m,r,h,1];h?s.aA.transformMat4(b,b,y):nh(b,b,y);const T=b[3];return b[0]/=T,b[1]/=T,b[2]/=T,b}function ua(m,r){return Math.min(.5+m/r*.5,1.5)}function Ls(m,r){const h=m[0]/m[3],y=m[1]/m[3];return h>=-r[0]&&h<=r[0]&&y>=-r[1]&&y<=r[1]}function Do(m,r,h,y,b,T,E,I,k,N){const H=h.transform,X=y?m.textSizeData:m.iconSizeData,ee=s.aD(X,h.transform.zoom),ie=H.projection.name==="globe",ue=[256/h.width*2+1,256/h.height*2+1],pe=y?m.text.dynamicLayoutVertexArray:m.icon.dynamicLayoutVertexArray;pe.clear();let fe=null;ie&&(fe=y?m.text.globeExtVertexArray:m.icon.globeExtVertexArray);const _e=m.lineVertexArray,Le=y?m.text.placedSymbolArray:m.icon.placedSymbolArray,Fe=h.transform.width/h.transform.height;let Be,$e=!1;for(let Ze=0;Ze<Le.length;Ze++){const rt=Le.get(Ze),{numGlyphs:xe,writingMode:Ne}=rt;if(Ne!==s.aE.vertical||$e||Be===s.aE.horizontal||($e=!0),Be=Ne,(rt.hidden||Ne===s.aE.vertical)&&!$e){qo(xe,pe);continue}$e=!1;const ct=new s.P(rt.tileAnchorX,rt.tileAnchorY);let{x:Ot,y:mt,z:it}=H.projection.projectTilePoint(ct.x,ct.y,N.canonical);if(k){const[hn,Ji,Gi]=k(ct);Ot+=hn,mt+=Ji,it+=Gi}const Nt=[Ot,mt,it,1];if(s.aA.transformMat4(Nt,Nt,r),!Ls(Nt,ue)){qo(xe,pe);continue}const mi=Nt[3],_i=ua(h.transform.getCameraToCenterDistance(H.projection),mi),hi=s.aF(X,ee,rt),vt=E?hi/_i:hi*_i,Gt=Ds(Ot,mt,it,b);if(Gt[3]<=0){qo(xe,pe);continue}let ri={};const $i=E?null:k,Yi=Kn(rt,vt,!1,I,r,b,T,m.glyphOffsetArray,_e,pe,fe,Gt,ct,ri,Fe,$i,H.projection,N,E);$e=Yi.useVertical,$i&&Yi.needsFlipping&&(ri={}),(Yi.notEnoughRoom||$e||Yi.needsFlipping&&Kn(rt,vt,!0,I,r,b,T,m.glyphOffsetArray,_e,pe,fe,Gt,ct,ri,Fe,$i,H.projection,N,E).notEnoughRoom)&&qo(xe,pe)}y?(m.text.dynamicLayoutVertexBuffer.updateData(pe),fe&&m.text.globeExtVertexBuffer&&m.text.globeExtVertexBuffer.updateData(fe)):(m.icon.dynamicLayoutVertexBuffer.updateData(pe),fe&&m.icon.globeExtVertexBuffer&&m.icon.globeExtVertexBuffer.updateData(fe))}function Xs(m,r,h,y,b,T,E,I,k,N,H,X,ee,ie,ue,pe){const{lineStartIndex:fe,glyphStartIndex:_e,segment:Le}=I,Fe=_e+I.numGlyphs,Be=fe+I.lineLength,$e=r.getoffsetX(_e),Ze=r.getoffsetX(Fe-1),rt=El(m*$e,h,y,b,T,E,Le,fe,Be,k,N,H,X,ee,!0,ie,ue,pe);if(!rt)return null;const xe=El(m*Ze,h,y,b,T,E,Le,fe,Be,k,N,H,X,ee,!0,ie,ue,pe);return xe?{first:rt,last:xe}:null}function Sl(m,r,h,y){return m===s.aE.horizontal&&Math.abs(y)>Math.abs(h)?{useVertical:!0}:m===s.aE.vertical?y>0?{needsFlipping:!0}:null:r!==yr.unknown&&function(b,T){return b===0||Math.abs(T/b)>Ks}(h,y)?r===yr.flipRequired?{needsFlipping:!0}:null:h<0?{needsFlipping:!0}:null}function Kn(m,r,h,y,b,T,E,I,k,N,H,X,ee,ie,ue,pe,fe,_e,Le){const Fe=r/24,Be=m.lineOffsetX*Fe,$e=m.lineOffsetY*Fe,{lineStartIndex:Ze,glyphStartIndex:rt,numGlyphs:xe,segment:Ne,writingMode:ct,flipState:Ot}=m,mt=Ze+m.lineLength,it=Nt=>{if(H){const[vt,Gt,ri]=Nt.up,$i=N.length;s.aG(H,$i+0,vt,Gt,ri),s.aG(H,$i+1,vt,Gt,ri),s.aG(H,$i+2,vt,Gt,ri),s.aG(H,$i+3,vt,Gt,ri)}const[mi,_i,hi]=Nt.point;s.aH(N,mi,_i,hi,Nt.angle)};if(xe>1){const Nt=Xs(Fe,I,Be,$e,h,X,ee,m,k,T,ie,pe,!1,fe,_e,Le);if(!Nt)return{notEnoughRoom:!0};if(y&&!h){let[mi,_i,hi]=Nt.first.point,[vt,Gt,ri]=Nt.last.point;[mi,_i]=Ds(mi,_i,hi,E),[vt,Gt]=Ds(vt,Gt,ri,E);const $i=Sl(ct,Ot,(vt-mi)*ue,Gt-_i);if(m.flipState=$i&&$i.needsFlipping?yr.flipRequired:yr.flipNotRequired,$i)return $i}it(Nt.first);for(let mi=rt+1;mi<rt+xe-1;mi++){const _i=El(Fe*I.getoffsetX(mi),Be,$e,h,X,ee,Ne,Ze,mt,k,T,ie,pe,!1,!1,fe,_e,Le);if(!_i)return N.length-=4*(mi-rt),{notEnoughRoom:!0};it(_i)}it(Nt.last)}else{if(y&&!h){const mi=Ds(ee.x,ee.y,0,b),_i=Ze+Ne+1,hi=new s.P(k.getx(_i),k.gety(_i)),vt=Ds(hi.x,hi.y,0,b),Gt=vt[3]>0?vt:vc(ee,hi,mi,1,b,void 0,fe,_e.canonical),ri=Sl(ct,Ot,(Gt[0]-mi[0])*ue,Gt[1]-mi[1]);if(m.flipState=ri&&ri.needsFlipping?yr.flipRequired:yr.flipNotRequired,ri)return ri}const Nt=El(Fe*I.getoffsetX(rt),Be,$e,h,X,ee,Ne,Ze,mt,k,T,ie,pe,!1,!1,fe,_e,Le);if(!Nt)return{notEnoughRoom:!0};it(Nt)}return{}}function Ja(m,r,h,y,b){const{x:T,y:E,z:I}=y.projectTilePoint(m.x,m.y,r);if(!b)return Ds(T,E,I,h);const[k,N,H]=b(m);return Ds(T+k,E+N,I+H,h)}function vc(m,r,h,y,b,T,E,I){const k=Ja(m.sub(r)._unit()._add(m),I,b,E,T);return s._.sub(k,h,k),s._.normalize(k,k),s._.scaleAndAdd(k,h,k,y)}function El(m,r,h,y,b,T,E,I,k,N,H,X,ee,ie,ue,pe,fe,_e){const Le=y?m-r:m+r;let Fe=Le>0?1:-1,Be=0;y&&(Fe*=-1,Be=Math.PI),Fe<0&&(Be+=Math.PI);let $e=I+E+(Fe>0?0:1)|0,Ze=b,rt=b,xe=0,Ne=0;const ct=Math.abs(Le),Ot=[],mt=[];let it=T,Nt=it;const mi=()=>vc(Nt,it,rt,ct-xe+1,H,ee,pe,fe.canonical);for(;xe+Ne<=ct;){if($e+=Fe,$e<I||$e>=k)return null;if(rt=Ze,Nt=it,Ot.push(rt),ie&&mt.push(Nt),it=new s.P(N.getx($e),N.gety($e)),Ze=X[$e],!Ze){const Ji=Ja(it,fe.canonical,H,pe,ee);Ze=Ji[3]>0?X[$e]=Ji:mi()}xe+=Ne,Ne=s._.distance(rt,Ze)}ue&&ee&&(X[$e]&&(Ze=mi(),Ne=s._.distance(rt,Ze)),X[$e]=Ze);const _i=(ct-xe)/Ne,hi=it.sub(Nt)._mult(_i)._add(Nt),vt=s._.sub([],Ze,rt),Gt=s._.scaleAndAdd([],rt,vt,_i);let ri=[0,0,1],$i=vt[0],Yi=vt[1];if(_e&&(ri=pe.upVector(fe.canonical,hi.x,hi.y),ri[0]!==0||ri[1]!==0||ri[2]!==1)){const Ji=[ri[2],0,-ri[0]],Gi=s._.cross([],ri,Ji);s._.normalize(Ji,Ji),s._.normalize(Gi,Gi),$i=s._.dot(vt,Ji),Yi=s._.dot(vt,Gi)}if(h){const Ji=s._.cross([],ri,vt);s._.normalize(Ji,Ji),s._.scaleAndAdd(Gt,Gt,Ji,h*Fe)}const hn=Be+Math.atan2(Yi,$i);return Ot.push(Gt),ie&&mt.push(hi),{point:Gt,angle:hn,path:Ot,tilePath:mt,up:ri}}function qo(m,r){const h=r.length,y=h+4*m;r.resize(y),r.float32.fill(-1/0,4*h,4*y)}function nh(m,r,h){const y=r[0],b=r[1];return m[0]=h[0]*y+h[4]*b+h[12],m[1]=h[1]*y+h[5]*b+h[13],m[3]=h[3]*y+h[7]*b+h[15],m}const po=(m,r,h)=>(1-h)*m+h*r,Eu=m=>m*m*m*m*m;class Is{constructor(r,h,y,b,T,E,I){this.tileSize=512,this._renderWorldCopies=T===void 0||T,this._minZoom=r||0,this._maxZoom=h||22,this._minPitch=y??0,this._maxPitch=b??60,this.setProjection(E),this.setMaxBounds(I),this.width=0,this.height=0,this._center=new s.aI(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new xr,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new fs,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1}clone(){const r=new Is(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return r._elevation=this._elevation,r._centerAltitude=this._centerAltitude,r._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,r.tileSize=this.tileSize,r.mercatorFromTransition=this.mercatorFromTransition,r.width=this.width,r.height=this.height,r.cameraElevationReference=this.cameraElevationReference,r._center=this._center,r._setZoom(this.zoom),r._seaLevelZoom=this._seaLevelZoom,r.angle=this.angle,r._fov=this._fov,r._pitch=this._pitch,r._nearZ=this._nearZ,r._farZ=this._farZ,r._averageElevation=this._averageElevation,r._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,r._unmodified=this._unmodified,r._edgeInsets=this._edgeInsets.clone(),r._camera=this._camera.clone(),r._calcMatrices(),r.freezeTileCoverage=this.freezeTileCoverage,r.frustumCorners=this.frustumCorners,r}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<15}get elevation(){return this._elevation}set elevation(r){this._elevation!==r&&(this._elevation=r,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(r,h=!1){const y=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||y)&&this._updateCameraOnTerrain(),(r||y)&&this._constrainCamera(h),this._calcMatrices()}getProjection(){return s.ah(this.projection,["name","center","parallels"])}setProjection(r){this.projectionOptions=r||{name:"mercator"};const h=this.projection?this.getProjection():void 0;this.projection=s.aJ(this.projectionOptions);const y=!Z(h,this.getProjection());return y&&this._calcMatrices(),this.mercatorFromTransition=!1,y}setOrthographicProjectionAtLowPitch(r){return this._orthographicProjectionAtLowPitch!==r&&(this._orthographicProjectionAtLowPitch=r,this._calcMatrices(),!0)}setMercatorFromTransition(){const r=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=s.aJ({name:"mercator"});const h=r!==this.projection.name;return h&&this._calcMatrices(),h}get minZoom(){return this._minZoom}set minZoom(r){this._minZoom!==r&&(this._minZoom=r,this.zoom=Math.max(this.zoom,r))}get maxZoom(){return this._maxZoom}set maxZoom(r){this._maxZoom!==r&&(this._maxZoom=r,this.zoom=Math.min(this.zoom,r))}get minPitch(){return this._minPitch}set minPitch(r){this._minPitch!==r&&(this._minPitch=r,this.pitch=Math.max(this.pitch,r))}get maxPitch(){return this._maxPitch}set maxPitch(r){this._maxPitch!==r&&(this._maxPitch=r,this.pitch=Math.min(this.pitch,r))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(r){r===void 0?r=!0:r===null&&(r=!1),this._renderWorldCopies=r}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const r=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(r))}get cameraWorldSize(){const r=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(r))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return s.ax(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new s.P(this.width,this.height)}get bearing(){return s.au(this.rotation,-180,180)}set bearing(r){this.rotation=r}get rotation(){return-this.angle/Math.PI*180}set rotation(r){const h=-r*Math.PI/180;this.angle!==h&&(this._unmodified=!1,this.angle=h,this._calcMatrices(),this.rotationMatrix=s.aC.create(),s.aC.rotate(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(r){const h=s.at(r,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==h&&(this._unmodified=!1,this._pitch=h,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}get fovX(){return this._fov}get fovY(){const r=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/r)}set fov(r){r=Math.max(.01,Math.min(60,r)),this._fov!==r&&(this._unmodified=!1,this._fov=s.ab(r),this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(r){this._averageElevation=r,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(r){const h=Math.min(Math.max(r,this.minZoom),this.maxZoom);this._zoom!==h&&(this._unmodified=!1,this._setZoom(h),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(r){this._zoom=r,this.scale=this.zoomScale(r),this.tileZoom=Math.floor(r),this.zoomFraction=r-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(r){this._tileCoverLift!==r&&(this._tileCoverLift=r)}_updateCameraOnTerrain(){const r=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,h=this.elevation&&r===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||r===Number.NEGATIVE_INFINITY&&(!h||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const y=this._elevation;h||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&y.exaggeration()&&this._centerAltitudeValidForExaggeration!==y.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*y.exaggeration(),this._centerAltitudeValidForExaggeration=y.exaggeration()):(this._centerAltitude=r||0,this._centerAltitudeValidForExaggeration=y.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){this._centerAltitudeValidForExaggeration!==void 0&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const r=this._elevation,h=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],y=this.horizonLineFromTop();let b=0,T=0;for(let E=0;E<h.length;E++){const I=new s.P(h[E][0]*this.width,y+h[E][1]*(this.height-y)),k=r.pointCoordinate(I);if(!k)continue;const N=1/Math.hypot(k[0]-this._camera.position[0],k[1]-this._camera.position[1]);b+=k[3]*N,T+=N}return T===0?NaN:b/T}get center(){return this._center}set center(r){r.lat===this._center.lat&&r.lng===this._center.lng||(this._unmodified=!1,this._center=r,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const r=this._seaLevelZoom,h=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),y=this.pixelsPerMeter/this.worldSize*h,b=this._mercatorZfromZoom(r),T=this._mercatorZfromZoom(this._maxZoom),E=Math.max(b-y,T);this._setZoom(this._zoomFromMercatorZ(E))}get padding(){return this._edgeInsets.toJSON()}set padding(r){this._edgeInsets.equals(r)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,r,1),this._calcMatrices())}computeZoomRelativeTo(r){const h=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,r.toAltitude()));let y;y=r.z<this._camera.position[2]?[h.x,h.y,h.z]:[r.x,r.y,r.z];const b=s._.length(s._.sub([],this._camera.position,y));return s.at(this._zoomFromMercatorZ(b),this._minZoom,this._maxZoom)}setFreeCameraOptions(r){if(!this.height||!r.position&&!r.orientation)return;this._updateCameraState();let h=!1;if(r.orientation&&!s.av.exactEquals(r.orientation,this._camera.orientation)&&(h=this._setCameraOrientation(r.orientation)),r.position){const y=[r.position.x,r.position.y,r.position.z];s._.exactEquals(y,this._camera.position)||(this._setCameraPosition(y),h=!0)}h&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const r=this._camera.position,h=new un;return h.position=new s.Y(r[0],r[1],r[2]),h.orientation=this._camera.orientation,h._elevation=this.elevation,h._renderWorldCopies=this.renderWorldCopies,h}_setCameraOrientation(r){if(!s.av.length(r))return!1;s.av.normalize(r,r);const h=s._.transformQuat([],[0,0,-1],r),y=s._.transformQuat([],[0,-1,0],r);if(y[2]<0)return!1;const b=_r(h,y);return!!b&&(this._camera.orientation=b,!0)}_setCameraPosition(r){const h=this.zoomScale(this.minZoom)*this.tileSize,y=this.zoomScale(this.maxZoom)*this.tileSize,b=this.cameraToCenterDistance;r[2]=s.at(r[2],b/y,b/h),this._camera.position=r}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(r){return this._edgeInsets.equals(r)}interpolatePadding(r,h,y){this._unmodified=!1,this._edgeInsets.interpolate(r,h,y),this._constrain(),this._calcMatrices()}coveringZoomLevel(r){const h=(r.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/r.tileSize));return Math.max(0,h)}getVisibleUnwrappedCoordinates(r){const h=[new s.aK(0,r)];if(this.renderWorldCopies){const y=this.pointCoordinate(new s.P(0,0)),b=this.pointCoordinate(new s.P(this.width,0)),T=this.pointCoordinate(new s.P(this.width,this.height)),E=this.pointCoordinate(new s.P(0,this.height)),I=Math.floor(Math.min(y.x,b.x,T.x,E.x)),k=Math.floor(Math.max(y.x,b.x,T.x,E.x)),N=1;for(let H=I-N;H<=k+N;H++)H!==0&&h.push(new s.aK(H,r))}return h}isLODDisabled(r){return(!r||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCoverForShadows(r,h,y){let b=[];if(h[0]===0&&h[1]===0)return b;for(const E of r){const I=E.canonical,k=E.overscaledZ,N=E.wrap,H=1<<I.z,X=I.x+1<H,ee=I.x>0,ie=I.y+1<H,ue=I.y>0,pe=E.wrap-(ee?0:1),fe=E.wrap+(X?0:1),_e=ee?I.x-1:H-1,Le=X?I.x+1:0;h[0]<0?(b.push(new s.aL(k,fe,I.z,Le,I.y)),h[1]<0&&ie&&(b.push(new s.aL(k,N,I.z,I.x,I.y+1)),b.push(new s.aL(k,fe,I.z,Le,I.y+1))),h[1]>0&&ue&&(b.push(new s.aL(k,N,I.z,I.x,I.y-1)),b.push(new s.aL(k,fe,I.z,Le,I.y-1)))):h[0]>0?(b.push(new s.aL(k,pe,I.z,_e,I.y)),h[1]<0&&ie&&(b.push(new s.aL(k,N,I.z,I.x,I.y+1)),b.push(new s.aL(k,pe,I.z,_e,I.y+1))),h[1]>0&&ue&&(b.push(new s.aL(k,N,I.z,I.x,I.y-1)),b.push(new s.aL(k,pe,I.z,_e,I.y-1)))):h[1]<0&&ie?b.push(new s.aL(k,N,I.z,I.x,I.y+1)):ue&&b.push(new s.aL(k,N,I.z,I.x,I.y-1))}if(b.length>1){b.sort((k,N)=>k.overscaledZ-N.overscaledZ||k.wrap-N.wrap||k.canonical.z-N.canonical.z||k.canonical.x-N.canonical.x||k.canonical.y-N.canonical.y);let E=0,I=0;for(;I<b.length;)b[I].equals(b[E])?++I:b[++E]=b[I++];b.length=E+1}const T=[];for(const E of b)b.some(I=>E.isChildOf(I))||T.push(E);return b=T.filter(E=>!r.some(I=>!!(E.overscaledZ<y&&I.isChildOf(E))||E.equals(I)||E.isChildOf(I))),b}coveringTiles(r){let h=this.coveringZoomLevel(r);const y=h,b=this.elevation&&this.elevation.exaggeration(),T=b&&!r.isTerrainDEM,E=this.projection.name==="mercator";if(r.minzoom!==void 0&&h<r.minzoom)return[];r.maxzoom!==void 0&&h>r.maxzoom&&(h=r.maxzoom);const I=this.locationCoordinate(this.center),k=this.center.lat,N=1<<h,H=[N*I.x,N*I.y,0],X=this.projection.name==="globe",ee=!X,ie=s.aM.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,h,ee),ue=X?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),pe=N*s.ax(1,this.center.lat),fe=this._camera.position[2]/s.ax(1,this.center.lat),_e=[N*ue.x,N*ue.y,fe*(ee?1:pe)],Le=X||b,Fe=this.cameraToCenterDistance/r.tileSize*(r.roundZoom?1:.502),Be=this.isLODDisabled(!0)?h:0;let $e;if(this._elevation&&r.isTerrainDEM)$e=1e4*this._elevation.exaggeration();else if(this._elevation){const vt=this._elevation.getMinMaxForVisibleTiles();$e=vt?vt.max:this._centerAltitude}else $e=this._centerAltitude;const Ze=r.isTerrainDEM?-$e:this._elevation?this._elevation.getMinElevationBelowMSL():0,rt=this.projection.isReprojectedInTileSpace?s.aN(this):1,xe=vt=>{const ri=new s.Y(vt.x+25e-6,vt.y,vt.z),$i=new s.Y(vt.x,vt.y+25e-6,vt.z),Yi=vt.toLngLat(),hn=ri.toLngLat(),Ji=$i.toLngLat(),Gi=this.locationCoordinate(Yi),Qt=this.locationCoordinate(hn),xn=this.locationCoordinate(Ji),Tr=Math.hypot(Qt.x-Gi.x,Qt.y-Gi.y),Wn=Math.hypot(xn.x-Gi.x,xn.y-Gi.y);return Math.sqrt(Tr*Wn)*rt/25e-6},Ne=vt=>{const Gt=$e,ri=Ze;return{aabb:s.aQ(this,N,0,0,0,vt,ri,Gt,this.projection),zoom:0,x:0,y:0,minZ:ri,maxZ:Gt,wrap:vt,fullyVisible:!1}},ct=[];let Ot=[];const mt=h,it=r.reparseOverscaled?y:h,Nt=(fe-this._centerAltitude)*pe,mi=vt=>{if(!this._elevation||!vt.tileID||!E)return;const Gt=this._elevation.getMinMaxForTile(vt.tileID),ri=vt.aabb;Gt?(ri.min[2]=Gt.min,ri.max[2]=Gt.max,ri.center[2]=(ri.min[2]+ri.max[2])/2):(vt.shouldSplit=hi(vt),vt.shouldSplit||(ri.min[2]=ri.max[2]=ri.center[2]=this._centerAltitude))},_i=(vt,Gt)=>{if(.707*Gt<vt)return 1;const ri=Gt/vt;return ri/(1.4144271570014144+(Math.pow(1.1,ri-1.4144271570014144+1)-1)/(1.1-1)-1)},hi=vt=>{if(vt.zoom<Be)return!0;if(vt.zoom===mt)return!1;if(vt.shouldSplit!=null)return vt.shouldSplit;const Gt=vt.aabb.distanceX(_e),ri=vt.aabb.distanceY(_e);let $i=Nt,Yi=1;if(X){$i=vt.aabb.distanceZ(_e);const Wn=Math.pow(2,vt.zoom),cr=s.ay((vt.y+1)/Wn),er=s.ay(vt.y/Wn),xs=Math.min(Math.max(k,cr),er),zr=s.b4(xs)/s.b4(k);if(Yi=xs===k?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,zr/this._mercatorScaleRatio),this.zoom<=s.b1&&vt.zoom===mt-1&&zr>=.9)return!0}else if(T&&($i=vt.aabb.distanceZ(_e)*pe),this.projection.isReprojectedInTileSpace&&y<=5){const Wn=Math.pow(2,vt.zoom),cr=xe(new s.Y((vt.x+.5)/Wn,(vt.y+.5)/Wn));Yi=cr>.85?1:cr}if(!E){const Wn=Math.sqrt(Gt*Gt+ri*ri+$i*$i);let cr=(1<<mt-vt.zoom)*Fe*Yi;return cr*=_i(Math.max($i,Nt),Wn),Wn<cr}let hn=Number.MAX_VALUE,Ji=0;const Gi=vt.aabb.getCorners(),Qt=[];for(const Wn of Gi){s._.sub(Qt,Wn,_e),X||(T?Qt[2]*=pe:Qt[2]=Nt);const cr=s._.dot(Qt,this._camera.forward());cr<hn&&(hn=cr,Ji=Math.abs(Qt[2]))}let xn=(1<<mt-vt.zoom)*Fe*Yi;if(xn*=_i(Math.max(Ji,Nt),hn),hn<xn)return!0;const Tr=vt.aabb.closestPoint(H);return Tr[0]===H[0]&&Tr[1]===H[1]};if(this.renderWorldCopies)for(let vt=1;vt<=3;vt++)ct.push(Ne(-vt)),ct.push(Ne(vt));for(ct.push(Ne(0));ct.length>0;){const vt=ct.pop(),Gt=vt.x,ri=vt.y;let $i=vt.fullyVisible;const Yi=()=>this.projection.name==="globe"&&(vt.y===0||vt.y===(1<<vt.zoom)-1);if(!$i){let hn=Le?vt.aabb.intersects(ie):vt.aabb.intersectsFlat(ie);if(hn===0&&Yi()){const Ji=new s.aO(vt.zoom,Gt,ri);hn=s.aP(this,N,Ji,!0).intersects(ie)}if(hn===0)continue;$i=hn===2}if(vt.zoom!==mt&&hi(vt))for(let hn=0;hn<4;hn++){const Ji=(Gt<<1)+hn%2,Gi=(ri<<1)+(hn>>1),Qt={aabb:E?vt.aabb.quadrant(hn):s.aQ(this,N,vt.zoom+1,Ji,Gi,vt.wrap,vt.minZ,vt.maxZ,this.projection),zoom:vt.zoom+1,x:Ji,y:Gi,wrap:vt.wrap,fullyVisible:$i,tileID:void 0,shouldSplit:void 0,minZ:vt.minZ,maxZ:vt.maxZ};T&&!X&&(Qt.tileID=new s.aL(vt.zoom+1===mt?it:vt.zoom+1,vt.wrap,vt.zoom+1,Ji,Gi),mi(Qt)),ct.push(Qt)}else{const hn=vt.zoom===mt?it:vt.zoom;if(r.minzoom&&r.minzoom>hn)continue;if(!$i){let xn=Le?vt.aabb.intersectsPrecise(ie):vt.aabb.intersectsPreciseFlat(ie);if(xn===0&&Yi()){const Tr=new s.aO(vt.zoom,Gt,ri);xn=s.aP(this,N,Tr,!0).intersectsPrecise(ie)}if(xn===0)continue}const Ji=H[0]-(.5+Gt+(vt.wrap<<vt.zoom))*(1<<h-vt.zoom),Gi=H[1]-.5-ri,Qt=vt.tileID?vt.tileID:new s.aL(hn,vt.wrap,vt.zoom,Gt,ri);Ot.push({tileID:Qt,distanceSq:Ji*Ji+Gi*Gi})}}if(this.fogCullDistSq){const vt=this.fogCullDistSq,Gt=this.horizonLineFromTop();Ot=Ot.filter(ri=>{const $i=[0,0,0,1],Yi=[s.a3,s.a3,0,1],hn=this.calculateFogTileMatrix(ri.tileID.toUnwrapped());s.aA.transformMat4($i,$i,hn),s.aA.transformMat4(Yi,Yi,hn);const Ji=s.aA.min([],$i,Yi),Gi=s.aA.max([],$i,Yi),Qt=s.aR(Ji,Gi);if(Qt===0)return!0;let xn=!1;const Tr=this._elevation;if(Tr&&Qt>vt&&Gt!==0){const Wn=this.calculateProjMatrix(ri.tileID.toUnwrapped());let cr;r.isTerrainDEM||(cr=Tr.getMinMaxForTile(ri.tileID)),cr||(cr={min:Ze,max:$e});const er=s.b2(this.rotation),xs=[er[0]*s.a3,er[1]*s.a3,cr.max];s._.transformMat4(xs,xs,Wn),xn=(1-xs[1])*this.height*.5<Gt}return Qt<vt||xn})}return Ot.sort((vt,Gt)=>vt.distanceSq-Gt.distanceSq).map(vt=>vt.tileID)}resize(r,h){this.width=r,this.height=h,this.pixelsToGLUnits=[2/r,-2/h],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(r){return Math.pow(2,r)}scaleZoom(r){return Math.log(r)/Math.LN2}project(r){const h=s.at(r.lat,-s.aS,s.aS),y=this.projection.project(r.lng,h);return new s.P(y.x*this.worldSize,y.y*this.worldSize)}unproject(r){return this.projection.unproject(r.x/this.worldSize,r.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/s.ax(1,this.center.lat)/this.worldSize}setLocationAtPoint(r,h){let y,b;const T=this.centerPoint;if(this.projection.name==="globe"){const I=this.worldSize;y=(h.x-T.x)/I,b=(h.y-T.y)/I}else{const I=this.pointCoordinate(h),k=this.pointCoordinate(T);y=I.x-k.x,b=I.y-k.y}const E=this.locationCoordinate(r);this.setLocation(new s.Y(E.x-y,E.y-b))}setLocation(r){this.center=this.coordinateLocation(r),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(r){return this.projection.locationPoint(this,r)}locationPoint3D(r){return this.projection.locationPoint(this,r,!0)}pointLocation(r){return this.coordinateLocation(this.pointCoordinate(r))}pointLocation3D(r){return this.coordinateLocation(this.pointCoordinate3D(r))}locationCoordinate(r,h){const y=h?s.ax(h,r.lat):void 0,b=this.projection.project(r.lng,r.lat);return new s.Y(b.x,b.y,y)}coordinateLocation(r){return this.projection.unproject(r.x,r.y)}pointRayIntersection(r,h){const y=h??this._centerAltitude,b=[r.x,r.y,0,1],T=[r.x,r.y,1,1];s.aA.transformMat4(b,b,this.pixelMatrixInverse),s.aA.transformMat4(T,T,this.pixelMatrixInverse);const E=T[3];s.aA.scale(b,b,1/b[3]),s.aA.scale(T,T,1/E);const I=b[2],k=T[2];return{p0:b,p1:T,t:I===k?0:(y-I)/(k-I)}}screenPointToMercatorRay(r){const h=[r.x,r.y,0,1],y=[r.x,r.y,1,1];return s.aA.transformMat4(h,h,this.pixelMatrixInverse),s.aA.transformMat4(y,y,this.pixelMatrixInverse),s.aA.scale(h,h,1/h[3]),s.aA.scale(y,y,1/y[3]),h[2]=s.ax(h[2],this._center.lat)*this.worldSize,y[2]=s.ax(y[2],this._center.lat)*this.worldSize,s.aA.scale(h,h,1/this.worldSize),s.aA.scale(y,y,1/this.worldSize),new s.aT([h[0],h[1],h[2]],s._.normalize([],s._.sub([],y,h)))}rayIntersectionCoordinate(r){const{p0:h,p1:y,t:b}=r,T=s.ax(h[2],this._center.lat),E=s.ax(y[2],this._center.lat);return new s.Y(s.a2(h[0],y[0],b)/this.worldSize,s.a2(h[1],y[1],b)/this.worldSize,s.a2(T,E,b))}pointCoordinate(r,h=this._centerAltitude){return this.projection.pointCoordinate(this,r.x,r.y,h)}pointCoordinate3D(r){if(!this.elevation)return this.pointCoordinate(r);let h=this.projection.pointCoordinate3D(this,r.x,r.y);if(h)return new s.Y(h[0],h[1],h[2]);let y=0,b=this.horizonLineFromTop();if(r.y>b)return this.pointCoordinate(r);const T=.02*b,E=r.clone();for(let I=0;I<10&&b-y>T;I++){E.y=s.a2(y,b,.66);const k=this.projection.pointCoordinate3D(this,E.x,E.y);k?(b=E.y,h=k):y=E.y}return h?new s.Y(h[0],h[1],h[2]):this.pointCoordinate(r)}isPointAboveHorizon(r){return this.projection.isPointAboveHorizon(this,r)}isPointOnSurface(r){if(r.y<0||r.y>this.height||r.x<0||r.x>this.width)return!1;if(this.elevation||this.zoom>=s.aU)return!this.isPointAboveHorizon(r);const h=this.pointCoordinate(r);return h.y>=0&&h.y<=1}_coordinatePoint(r,h){const y=h&&this.elevation?this.elevation.getAtPointOrZero(r,this._centerAltitude):this._centerAltitude,b=[r.x*this.worldSize,r.y*this.worldSize,y+r.toAltitude(),1];return s.aA.transformMat4(b,b,this.pixelMatrix),b[3]>0?new s.P(b[0]/b[3],b[1]/b[3]):new s.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:r,left:h}=this._edgeInsets,y=this.height-this._edgeInsets.bottom,b=this.width-this._edgeInsets.right,T=this.pointLocation3D(new s.P(h,r)),E=this.pointLocation3D(new s.P(b,r)),I=this.pointLocation3D(new s.P(b,y)),k=this.pointLocation3D(new s.P(h,y));let N=Math.min(T.lng,E.lng,I.lng,k.lng),H=Math.max(T.lng,E.lng,I.lng,k.lng),X=Math.min(T.lat,E.lat,I.lat,k.lat),ee=Math.max(T.lat,E.lat,I.lat,k.lat);const ie=Math.pow(2,-this.zoom)/16*270,ue=this.projection.name==="globe"?1:4,pe=(fe,_e,Le,Fe,Be)=>{const $e=(fe+Le)/2,Ze=(_e+Fe)/2,rt=new s.P($e,Ze),{lng:xe,lat:Ne}=this.pointLocation3D(rt),ct=Math.max(0,N-xe,X-Ne,xe-H,Ne-ee);N=Math.min(N,xe),H=Math.max(H,xe),X=Math.min(X,Ne),ee=Math.max(ee,Ne),(Be<ue||ct>ie)&&(pe(fe,_e,$e,Ze,Be+1),pe($e,Ze,Le,Fe,Be+1))};if(pe(h,r,b,r,1),pe(b,r,b,y,1),pe(b,y,h,y,1),pe(h,y,h,r,1),this.projection.name==="globe"){const[fe,_e]=s.aV(this);fe?(ee=90,H=180,N=-180):_e&&(X=-90,H=180,N=-180)}return new s.ai(new s.aI(N,X),new s.aI(H,ee))}_getBoundsRectangular(r,h){const{top:y,left:b}=this._edgeInsets,T=this.height-this._edgeInsets.bottom,E=this.width-this._edgeInsets.right,I=new s.P(b,y),k=new s.P(E,y),N=new s.P(E,T),H=new s.P(b,T);let X=this.pointCoordinate(I,r),ee=this.pointCoordinate(k,r);const ie=this.pointCoordinate(N,h),ue=this.pointCoordinate(H,h),pe=(fe,_e)=>(_e.y-fe.y)/(_e.x-fe.x);return X.y>1&&ee.y>=0?X=new s.Y((1-ue.y)/pe(ue,X)+ue.x,1):X.y<0&&ee.y<=1&&(X=new s.Y(-ue.y/pe(ue,X)+ue.x,0)),ee.y>1&&X.y>=0?ee=new s.Y((1-ie.y)/pe(ie,ee)+ie.x,1):ee.y<0&&X.y<=1&&(ee=new s.Y(-ie.y/pe(ie,ee)+ie.x,0)),new s.ai().extend(this.coordinateLocation(X)).extend(this.coordinateLocation(ee)).extend(this.coordinateLocation(ue)).extend(this.coordinateLocation(ie))}_getBoundsRectangularTerrain(){const r=this.elevation;if(!r.visibleDemTiles.length||r.isUsingMockSource())return this._getBoundsRectangular(0,0);const h=r.visibleDemTiles.reduce((y,b)=>{if(b.dem){const T=b.dem.tree;y.min=Math.min(y.min,T.minimums[0]),y.max=Math.max(y.max,T.maximums[0])}return y},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(h.min*r.exaggeration(),h.max*r.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(r=!0){const h=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,y=this.height/2-h*(1-this._horizonShift);return r?Math.max(0,y):y}getMaxBounds(){return this.maxBounds}setMaxBounds(r){this.maxBounds=r,this.minLat=-s.aS,this.maxLat=s.aS,this.minLng=-180,this.maxLng=180,r&&(this.minLat=r.getSouth(),this.maxLat=r.getNorth(),this.minLng=r.getWest(),this.maxLng=r.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=s.aj(this.minLng)*this.tileSize,this.worldMaxX=s.aj(this.maxLng)*this.tileSize,this.worldMinY=s.ak(this.maxLat)*this.tileSize,this.worldMaxY=s.ak(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(r,h){return this.projection.createTileMatrix(this,h,r)}calculateDistanceTileData(r){const h=r.key,y=this._distanceTileDataCache;if(y[h])return y[h];const b=r.canonical,T=1/this.height,E=this.cameraWorldSize,I=E/this.zoomScale(b.z),k=(b.x+Math.pow(2,b.z)*r.wrap)*I,N=b.y*I,H=this.point;H.x*=E/this.worldSize,H.y*=E/this.worldSize;const X=this.angle,ee=Math.sin(-X),ie=-Math.cos(-X);return y[h]={bearing:[ee,ie],center:[(H.x-k)*T,(H.y-N)*T],scale:I/s.a3*T},y[h]}calculateFogTileMatrix(r){const h=r.key,y=this._fogTileMatrixCache;if(y[h])return y[h];const b=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,r);return s.ad.multiply(b,this.worldToFogMatrix,b),y[h]=new Float32Array(b),y[h]}calculateProjMatrix(r,h=!1,y=!1){const b=r.key;let T;if(T=y?this._expandedProjMatrixCache:h?this._alignedProjMatrixCache:this._projMatrixCache,T[b])return T[b];const E=this.calculatePosMatrix(r,this.worldSize);let I;return I=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:y?this.expandedFarZProjMatrix:h?this.alignedProjMatrix:this.projMatrix,s.ad.multiply(E,I,E),T[b]=new Float32Array(E),T[b]}calculatePixelsToTileUnitsMatrix(r){const h=r.tileID.key,y=this._pixelsToTileUnitsCache;if(y[h])return y[h];const b=s.aW(r,this);return y[h]=b,y[h]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){const r=1/this.worldSize,h=s.ad.fromScaling([],[r,r,r]);return s.ad.multiply(h,h,this.globeMatrix),h}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;const r=this._elevation;this._updateCameraState();const h=s.ax(1,this._center.lat)*this.worldSize,y=this._computeCameraPosition(h),b=this._camera.forward(),T=s.ax(1,this._center.lat);y[2]/=T,b[2]/=T,s._.normalize(b,b);const E=r.raycast(y,b,r.exaggeration());if(E){const I=s._.scaleAndAdd([],y,b,E),k=new s.Y(I[0],I[1],s.ax(I[2],s.ay(I[1]))),N=(k.z+s._.length([k.x-y[0],k.y-y[1],k.z-y[2]*T]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(N),this._centerAltitude=k.toAltitude(),this._center=this.coordinateLocation(k),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(r=!1){if(!this._elevation)return;const h=this._elevation,y=s.ax(1,this._center.lat)*this.worldSize,b=this._computeCameraPosition(y),T=h.getAtPointOrZero(new s.Y(...b)),E=this.pixelsPerMeter/this.worldSize*T,I=this._minimumHeightOverTerrain(),k=b[2]-E;if(k<=I)if(k<0||r){const N=this.locationCoordinate(this._center,this._centerAltitude),H=[b[0],b[1],N.z-b[2]],X=s._.length(H);H[2]-=(I-k)/this._pixelsPerMercatorPixel;const ee=s._.length(H);if(ee===0)return;s._.scale(H,H,X/ee*this._pixelsPerMercatorPixel),this._camera.position=[b[0],b[1],N.z*this._pixelsPerMercatorPixel-H[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const r=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||r){const ee=this.center;return ee.lat=s.at(ee.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!r)&&(ee.lng=s.at(ee.lng,this.minLng,this.maxLng)),this.center=ee,void(this._constraining=!1)}const h=this._unmodified,{x:y,y:b}=this.point;let T=0,E=y,I=b;const k=this.width/2,N=this.height/2,H=this.worldMinY*this.scale,X=this.worldMaxY*this.scale;if(b-N<H&&(I=H+N),b+N>X&&(I=X-N),X-H<this.height&&(T=Math.max(T,this.height/(X-H)),I=(X+H)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const ee=this.worldMinX*this.scale,ie=this.worldMaxX*this.scale,ue=this.worldSize/2-(ee+ie)/2;E=(y+ue+this.worldSize)%this.worldSize-ue,E-k<ee&&(E=ee+k),E+k>ie&&(E=ie-k),ie-ee<this.width&&(T=Math.max(T,this.width/(ie-ee)),E=(ie+ee)/2)}E===y&&I===b||(this.center=this.unproject(new s.P(E,I))),T&&(this.zoom+=this.scaleZoom(T)),this._constrainCamera(),this._unmodified=h,this._constraining=!1}_minZoomForBounds(){let r=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(r=Math.max(r,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),r}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const r=this.centerOffset,h=this.projection.name==="globe",y=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=s.ax(1,this.center.lat)/s.ax(1,s.b3));const b=s.aX(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,b),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const T=this.projection.zAxisUnit==="meters"?y:1,E=this._camera.getWorldToCamera(this.worldSize,T);let I;const k=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(k[8]=2*-r.x/this.width,k[9]=2*r.y/this.height,this.isOrthographic){let Ne=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),ct=Ne*this.aspect,Ot=-ct,mt=-Ne;ct-=r.x,Ot-=r.x,Ne+=r.y,mt+=r.y,I=this._camera.getCameraToClipOrthographic(Ot,ct,mt,Ne,this._nearZ,this._farZ),((it,Nt,mi,_i)=>{for(let hi=0;hi<16;hi++)it[hi]=po(Nt[hi],mi[hi],_i)})(I,I,k,Eu(this.pitch>=15?1:this.pitch/15))}else I=k;const N=s.ad.mul([],k,E);let H=s.ad.mul([],I,E);if(this.projection.isReprojectedInTileSpace){const Ne=this.locationCoordinate(this.center),ct=s.ad.identity([]);s.ad.translate(ct,ct,[Ne.x*this.worldSize,Ne.y*this.worldSize,0]),s.ad.multiply(ct,ct,s.aY(this)),s.ad.translate(ct,ct,[-Ne.x*this.worldSize,-Ne.y*this.worldSize,0]),s.ad.multiply(H,H,ct),s.ad.multiply(N,N,ct),this.inverseAdjustmentMatrix=s.aZ(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=s.ad.scale([],H,[this.worldSize,this.worldSize,this.worldSize/T,1]),this.projMatrix=H,this.invProjMatrix=s.ad.invert(new Float64Array(16),this.projMatrix),h){const Ne=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);Ne[8]=2*-r.x/this.width,Ne[9]=2*r.y/this.height,this.expandedFarZProjMatrix=s.ad.mul([],Ne,E)}else this.expandedFarZProjMatrix=this.projMatrix;const X=s.ad.invert([],I);this.frustumCorners=s.a_.fromInvProjectionMatrix(X,this.horizonLineFromTop(),this.height),this.cameraFrustum=s.aM.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!h);const ee=new Float32Array(16);s.ad.identity(ee),s.ad.scale(ee,ee,[1,-1,1]),s.ad.rotateX(ee,ee,this._pitch),s.ad.rotateZ(ee,ee,this.angle);const ie=s.ad.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=s.ad.clone(ie);const ue=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;ie[8]=2*-r.x/this.width,ie[9]=2*(r.y+ue)/this.height,this.skyboxMatrix=s.ad.multiply(ee,ie,ee);const pe=this.point,fe=pe.x,_e=pe.y,Le=this.width%2/2,Fe=this.height%2/2,Be=Math.cos(this.angle),$e=Math.sin(this.angle),Ze=fe-Math.round(fe)+Be*Le+$e*Fe,rt=_e-Math.round(_e)+Be*Fe+$e*Le,xe=new Float64Array(H);if(s.ad.translate(xe,xe,[Ze>.5?Ze-1:Ze,rt>.5?rt-1:rt,0]),this.alignedProjMatrix=xe,H=s.ad.create(),s.ad.scale(H,H,[this.width/2,-this.height/2,1]),s.ad.translate(H,H,[1,-1,0]),this.labelPlaneMatrix=H,H=s.ad.create(),s.ad.scale(H,H,[1,-1,1]),s.ad.translate(H,H,[-1,-1,0]),s.ad.scale(H,H,[2/this.width,2/this.height,1]),this.glCoordMatrix=H,this.pixelMatrix=s.ad.multiply(new Float64Array(16),this.labelPlaneMatrix,N),this._calcFogMatrices(),this._distanceTileDataCache={},H=s.ad.invert(new Float64Array(16),this.pixelMatrix),!H)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=H,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=s.a$(this);const Ne=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=s._.transformMat4(Ne,Ne,E),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=H;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const r=this.cameraWorldSizeForFog,h=this.cameraPixelsPerMeter,y=this._camera.position,b=1/this.height/this._pixelsPerMercatorPixel,T=[r,r,h];s._.scale(T,T,b),s._.scale(y,y,-1),s._.multiply(y,y,T);const E=s.ad.create();s.ad.translate(E,E,y),s.ad.scale(E,E,T),this.mercatorFogMatrix=E,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(r,h,b)}_computeCameraPosition(r){const h=(r=r||this.pixelsPerMeter)/this.pixelsPerMeter,y=this._camera.forward(),b=this.point,T=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*h-r/this.worldSize*this._centerAltitude;return[b.x/this.worldSize-y[0]*T,b.y/this.worldSize-y[1]*T,r/this.worldSize*this._centerAltitude-y[2]*T]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(r){const h=this._maxCameraBoundsDistance()*Math.cos(this._pitch),y=this._camera.position[2],b=r[2];let T=1;this.projection.wrap&&(this.center=this.center.wrap()),b>0&&(T=Math.min((h-y)/b,1)),this._camera.position=s._.scaleAndAdd([],this._camera.position,r,T),this._updateStateFromCamera()}_updateStateFromCamera(){const r=this._camera.position,h=this._camera.forward(),{pitch:y,bearing:b}=this._camera.getPitchBearing(),T=s.ax(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,E=this._mercatorZfromZoom(this._maxZoom)*Math.cos(s.ab(this._maxPitch)),I=Math.max((r[2]-T)/Math.cos(y),E),k=this._zoomFromMercatorZ(I);s._.scaleAndAdd(r,r,h,I),this._pitch=s.at(y,s.ab(this.minPitch),s.ab(this.maxPitch)),this.angle=s.au(b,-Math.PI,Math.PI),this._setZoom(s.at(k,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new s.Y(r[0],r[1],r[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(r){return Math.pow(2,r)*this.tileSize}_mercatorZfromZoom(r){return this.cameraToCenterDistance/this._worldSizeFromZoom(r)}_minimumHeightOverTerrain(){const r=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(r)}_zoomFromMercatorZ(r){return this.scaleZoom(this.cameraToCenterDistance/(r*this.tileSize))}zoomFromMercatorZAdjusted(r){let h=0,y=s.aU,b=0,T=1/0;for(;y-h>1e-6&&y>h;){const E=h+.5*(y-h),I=this.tileSize*Math.pow(2,E),k=this.getCameraToCenterDistance(this.projection,E,I),N=this.scaleZoom(k/(r*this.tileSize)),H=Math.abs(E-N);H<T&&(T=H,b=E),E<N?h=E:y=E}return b}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(s.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(r,h){const y=Math.min(r.x,h.x),b=Math.max(r.x,h.x),T=Math.min(r.y,h.y),E=Math.max(r.y,h.y);if(T<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const I=[new s.P(y,T),new s.P(b,E),new s.P(y,E),new s.P(b,T)],k=this.renderWorldCopies?-3:0,N=this.renderWorldCopies?4:1;for(const H of I){const X=this.pointRayIntersection(H);if(X.t<0)return!0;const ee=this.rayIntersectionCoordinate(X);if(ee.x<k||ee.y<0||ee.x>N||ee.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+s.b0(this.fovAboveCenter)>88||this.anyCornerOffEdge(new s.P(0,0),new s.P(this.width,this.height))}zoomDeltaToMovement(r,h){const y=s._.length(s._.sub([],this._camera.position,r)),b=this._zoomFromMercatorZ(y)+h;return y-this._mercatorZfromZoom(b)}getCameraPoint(){if(this.projection.name==="globe"){const r=function([h,y,b],T){const E=[h,y,b,1];s.aA.transformMat4(E,E,T);const I=E[3]=Math.max(E[3],1e-6);return E[0]/=I,E[1]/=I,E[2]/=I,E}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new s.P(r[0],r[1])}{const r=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new s.P(0,r))}}getCameraToCenterDistance(r,h=this.zoom,y=this.worldSize){const b=s.aX(r,h,this.width,this.height,1024),T=r.pixelSpaceConversion(this.center.lat,y,b);let E=.5/Math.tan(.5*this._fov)*this.height*T;return this.isOrthographic&&(E=po(1,E,Eu(this.pitch>=15?1:this.pitch/15))),E}getWorldToCameraMatrix(){const r=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&s.ad.multiply(r,r,this.globeMatrix),r}getFrustum(r){return s.aM.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,r,this.projection.zAxisUnit==="meters")}}const gs={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11},Ka=(m,r)=>{if(r>0&&m.terrain&&s.w("Cutoff is currently disabled on terrain"),r<=0||m.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const h=m.transform,y=Math.max(Math.abs(h._zoom-(m.minCutoffZoom-1)),1),b=h.isLODDisabled(!1)?s.$(60,45,h.pitch):s.$(30,15,h.pitch),T=h._farZ-h._nearZ,E=r*h.height,I=((1-(k=b))*h.cameraToCenterDistance+k*(h._farZ+E))*y;var k;return{shouldRenderCutoff:b<1,uniformValues:{u_cutoff_params:[h._nearZ,h._farZ,(I-h._nearZ)/T,(I-E-h._nearZ)/T]}}},ws={cascadeCount:2,shadowMapResolution:2048};class Er{constructor(r,h){this.aabb=r,this.lastCascade=h}}class Td{add(r,h){const y=this.receivers[r.key];y!==void 0?(y.aabb.min[0]=Math.min(y.aabb.min[0],h.min[0]),y.aabb.min[1]=Math.min(y.aabb.min[1],h.min[1]),y.aabb.min[2]=Math.min(y.aabb.min[2],h.min[2]),y.aabb.max[0]=Math.max(y.aabb.max[0],h.max[0]),y.aabb.max[1]=Math.max(y.aabb.max[1],h.max[1]),y.aabb.max[2]=Math.max(y.aabb.max[2],h.max[2])):this.receivers[r.key]=new Er(h,null)}clear(){this.receivers={}}get(r){return this.receivers[r.key]}computeRequiredCascades(r,h,y){const b=s.b6.fromPoints(r.points);let T=0;for(const E in this.receivers){const I=this.receivers[E];if(!I||!b.intersectsAabb(I.aabb))continue;I.aabb.min=b.closestPoint(I.aabb.min),I.aabb.max=b.closestPoint(I.aabb.max);const k=I.aabb.getCorners();for(let N=0;N<y.length;N++){let H=!0;for(const X of k){const ee=[X[0]*h,X[1]*h,X[2]];if(s._.transformMat4(ee,ee,y[N].matrix),ee[0]<-1||ee[0]>1||ee[1]<-1||ee[1]>1){H=!1;break}}if(I.lastCascade=N,T=Math.max(T,N),H)break}}return T+1}}class bc{constructor(r){this.painter=r,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new Td,this._depthMode=new s.ae(r.context.gl.LEQUAL,s.ae.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,r.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},()=>{this.painter.style.map.triggerRepaint()}),r.tp.registerParameter(ws,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),r.tp.registerParameter(ws,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),r.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(const r of this._cascades)r.texture.destroy(),r.framebuffer.destroy();this._cascades=[]}updateShadowParameters(r,h){const y=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!h||!h.properties)return;const b=h.properties.get("shadow-intensity");if(!h.shadowsEnabled()||b<=0||(this._shadowLayerCount=y.style.order.reduce((ue,pe)=>{const fe=y.style._mergedLayers[pe];return ue+(fe.hasShadowPass()&&!fe.isHidden(r.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;const T=y.context,E=ws.shadowMapResolution,I=ws.shadowMapResolution;if(this._cascades.length===0||ws.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let ue=0;ue<ws.cascadeCount;++ue){const pe=y._shadowMapDebug,fe=T.gl,_e=T.createFramebuffer(E,I,pe,"texture"),Le=new s.T(T,{width:E,height:I,data:null},fe.DEPTH_COMPONENT);if(_e.depthAttachment.set(Le.texture),pe){const Fe=new s.T(T,{width:E,height:I,data:null},fe.RGBA);_e.colorAttachment.set(Fe.texture)}this._cascades.push({framebuffer:_e,texture:Le,matrix:[],far:0,boundingSphereRadius:0,frustum:new s.aM,scale:0})}}this.shadowDirection=Qa(h);let k=0;if(r.elevation){const ue=r.elevation,pe=[1e4,-1e4];ue.visibleDemTiles.filter(fe=>fe.dem).forEach(fe=>{const _e=fe.dem.tree;pe[0]=Math.min(pe[0],_e.minimums[0]),pe[1]=Math.max(pe[1],_e.maximums[0])}),pe[0]!==1e4&&(k=(pe[1]-pe[0])*ue.exaggeration())}const N=1.5*r.cameraToCenterDistance,H=3*N,X=new Float64Array(16);for(let ue=0;ue<this._cascades.length;++ue){const pe=this._cascades[ue];let fe=r.height/50,_e=1;ws.cascadeCount===1?_e=H:ue===0?_e=N:(fe=N,_e=H);const[Le,Fe]=da(r,this.shadowDirection,fe,_e,ws.shadowMapResolution,k);pe.scale=r.scale,pe.matrix=Le,pe.boundingSphereRadius=Fe,s.ad.invert(X,pe.matrix),pe.frustum=s.aM.fromInvProjectionMatrix(X,1,0,!0),pe.far=_e}const ee=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[ee].far,this._cascades[ee].far],this._uniformValues.u_shadow_intensity=b,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/ws.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=ws.shadowMapResolution,this._uniformValues.u_shadowmap_0=gs.ShadowMap0,this._uniformValues.u_shadowmap_1=gs.ShadowMap0+1,this._groundShadowTiles=y.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const ie=y.transform.elevation;for(const ue of this._groundShadowTiles){let pe={min:0,max:0};if(ie){const fe=ie.getMinMaxForTile(ue);fe&&(pe=fe)}this.addShadowReceiver(ue.toUnwrapped(),pe.min,pe.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(r){this._enabled=r}drawShadowPass(r,h){if(!this.enabled)return;const y=this.painter,b=y.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(y.transform.getFrustum(0),y.transform.worldSize,this._cascades),b.viewport.set([0,0,ws.shadowMapResolution,ws.shadowMapResolution]);for(let T=0;T<this._numCascadesToRender;++T){y.currentShadowCascade=T,b.bindFramebuffer.set(this._cascades[T].framebuffer.framebuffer),b.clear({color:s.C.white,depth:1});for(const E of r.order){const I=r._mergedLayers[E];if(!I.hasShadowPass()||I.isHidden(y.transform.zoom))continue;const k=r.getLayerSourceCache(I),N=k?h[k.id]:void 0;(I.type==="model"||N&&N.length)&&y.renderLayer(y,k,I,N)}}y.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const r=this.painter,h=r.style,y=r.context,b=h.directionalLight,T=h.ambientLight;if(!b||!T)return;const E=[],I=Ka(r,r.longestCutoffRange);I.shouldRenderCutoff&&E.push("RENDER_CUTOFF");const k=wa(h,b,T),N=new s.ae(y.gl.LEQUAL,s.ae.ReadOnly,r.depthRangeFor3D);for(const H of this._groundShadowTiles){const X=H.toUnwrapped(),ee=r.isTileAffectedByFog(H),ie=r.getOrCreateProgram("groundShadow",{defines:E,overrideFog:ee});this.setupShadows(X,ie),r.uploadCommonUniforms(y,ie,X,null,I);const ue={u_matrix:r.transform.calculateProjMatrix(X),u_ground_shadow_factor:k};ie.draw(r,y.gl.TRIANGLES,N,s.ag.disabled,s.a.multiply,s.af.disabled,ue,"ground_shadow",r.tileExtentBuffer,r.quadTriangleIndexBuffer,r.tileExtentSegments,{},r.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?s.a.unblended:s.a.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(r){const h=this.painter.transform,y=h.calculatePosMatrix(r,h.worldSize);return s.ad.multiply(y,this._cascades[this.painter.currentShadowCascade].matrix,y),Float32Array.from(y)}calculateShadowPassMatrixFromMatrix(r){return s.ad.multiply(r,this._cascades[this.painter.currentShadowCascade].matrix,r),Float32Array.from(r)}setupShadows(r,h,y,b=0){if(!this.enabled)return;const T=this.painter.transform,E=this.painter.context,I=E.gl,k=this._uniformValues,N=new Float64Array(16),H=T.calculatePosMatrix(r,T.worldSize);for(let X=0;X<this._cascades.length;X++)s.ad.multiply(N,this._cascades[X].matrix,H),k[X===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(N),E.activeTexture.set(I.TEXTURE0+gs.ShadowMap0+X),this._cascades[X].texture.bind(I.NEAREST,I.CLAMP_TO_EDGE);if(this.useNormalOffset=!!y,this.useNormalOffset){const X=s.b5(r.canonical),ee=2/T.tileSize*s.a3/ws.shadowMapResolution,ie=ee*this._cascades[0].boundingSphereRadius,ue=ee*this._cascades[this._cascades.length-1].boundingSphereRadius,pe=(y==="vector-tile"?1:3)/Math.pow(2,b-r.canonical.z-(1-T.zoom+Math.floor(T.zoom)));k.u_shadow_normal_offset=[X,ie*pe,ue*pe],k.u_shadow_bias=[6e-5,.0012,.012]}else k.u_shadow_bias=[36e-5,.0012,.012];h.setShadowUniformValues(E,k)}setupShadowsFromMatrix(r,h,y=!1){if(!this.enabled)return;const b=this.painter.context,T=b.gl,E=this._uniformValues,I=new Float64Array(16);for(let k=0;k<ws.cascadeCount;k++)s.ad.multiply(I,this._cascades[k].matrix,r),E[k===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(I),b.activeTexture.set(T.TEXTURE0+gs.ShadowMap0+k),this._cascades[k].texture.bind(T.NEAREST,T.CLAMP_TO_EDGE);this.useNormalOffset=y,y?(E.u_shadow_normal_offset=[1,5,5],E.u_shadow_bias=[6e-5,.0012,.012]):E.u_shadow_bias=[36e-5,.0012,.012],h.setShadowUniformValues(b,E)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(r,h,y,b){if(b[2]>=0)return{};const T=function(k,N,H){const X=H/(1<<k.canonical.z);return new s.b6([k.canonical.x*X+k.wrap*H,k.canonical.y*X+k.wrap*H,0],[(k.canonical.x+1)*X+k.wrap*H,(k.canonical.y+1)*X+k.wrap*H,N])}(r,h,y).getCorners(),E=h/-b[2];b[0]<0?(s._.add(T[0],T[0],[b[0]*E,0,0]),s._.add(T[3],T[3],[b[0]*E,0,0])):b[0]>0&&(s._.add(T[1],T[1],[b[0]*E,0,0]),s._.add(T[2],T[2],[b[0]*E,0,0])),b[1]<0?(s._.add(T[0],T[0],[0,b[1]*E,0]),s._.add(T[1],T[1],[0,b[1]*E,0])):b[1]>0&&(s._.add(T[2],T[2],[0,b[1]*E,0]),s._.add(T[3],T[3],[0,b[1]*E,0]));const I={};return I.vertices=T,I.planes=[Jl(T[1],T[0],T[4]),Jl(T[2],T[1],T[5]),Jl(T[3],T[2],T[6]),Jl(T[0],T[3],T[7])],I}addShadowReceiver(r,h,y){this._receivers.add(r,s.b6.fromTileIdAndHeight(r,h,y))}getMaxCascadeForTile(r){const h=this._receivers.get(r);return h&&h.lastCascade?h.lastCascade:0}}function Jl(m,r,h){const y=s._.sub([],h,r),b=s._.sub([],m,r),T=s._.cross([],y,b),E=s._.length(T);return E===0?[0,0,1,0]:(s._.scale(T,T,1/E),[T[0],T[1],T[2],-s._.dot(T,r)])}function Qa(m){const r=m.properties.get("direction"),h=s.ac(r.x,r.y,r.z);h[2]=s.at(h[2],0,75);const y=s.b7([h[0],h[1],h[2]]);return s._.fromValues(y.x,y.y,y.z)}function wa(m,r,h){const y=r.properties.get("color"),b=r.properties.get("intensity"),T=r.properties.get("direction"),E=[T.x,T.y,T.z],I=h.properties.get("color"),k=h.properties.get("intensity"),N=Math.max(s._.dot([0,0,1],E),0),H=[0,0,0];s._.scale(H,I.toRenderColor(m.getLut(r.scope)).toArray01Linear().slice(0,3),k);const X=[0,0,0];return s._.scale(X,y.toRenderColor(m.getLut(h.scope)).toArray01Linear().slice(0,3),N*b),s.b8([H[0]>0?H[0]/(H[0]+X[0]):0,H[1]>0?H[1]/(H[1]+X[1]):0,H[2]>0?H[2]/(H[2]+X[2]):0])}function da(m,r,h,y,b,T){const E=m.zoom,I=m.scale,k=m.worldSize,N=1/k,H=m.aspect,X=Math.sqrt(1+H*H)*Math.tan(.5*m.fovX),ee=X*X,ie=y-h,ue=y+h;let pe,fe;ee>ie/ue?(pe=y,fe=y*X):(pe=.5*ue*(1+ee),fe=.5*Math.sqrt(ie*ie+2*(y*y+h*h)*ee+ue*ue*ee*ee));const _e=m.projection.pixelsPerMeter(m.center.lat,k),Le=m._camera.getCameraToWorldMercator(),Fe=[0,0,-pe*N];s._.transformMat4(Fe,Fe,Le);let Be=fe*N;const $e=m._edgeInsets;if(!($e.left===0&&$e.top===0&&$e.right===0&&$e.bottom===0||$e.left===$e.right&&$e.top===$e.bottom)){const $i=m._camera.getWorldToCamera(m.worldSize,m.projection.zAxisUnit==="meters"?_e:1),Yi=m._camera.getCameraToClipPerspective(m._fov,m.width/m.height,h,y);Yi[8]=2*-m.centerOffset.x/m.width,Yi[9]=2*m.centerOffset.y/m.height;const hn=new Float64Array(16);s.ad.mul(hn,Yi,$i);const Ji=new Float64Array(16);s.ad.invert(Ji,hn);const Gi=s.aM.fromInvProjectionMatrix(Ji,k,E,!0);for(const Qt of Gi.points){const xn=((Ze=Qt)[0]/=I,Ze[1]/=I,Ze[2]=s.ax(Ze[2],m._center.lat),Ze);Be=Math.max(Be,s._.len(s._.subtract([],Fe,xn)))}}var Ze;Be*=b/(b-1);const rt=Math.acos(r[2]),xe=Math.atan2(-r[0],-r[1]),Ne=new fs;Ne.position=Fe,Ne.setPitchBearing(rt,xe);const ct=Ne.getWorldToCamera(k,_e),Ot=Be*k,mt=Math.min(m._mercatorZfromZoom(17)*k*-2,-2*Ot),it=Ne.getCameraToClipOrthographic(-Ot,Ot,-Ot,Ot,mt,(Ot+T*_e)/r[2]),Nt=new Float64Array(16);s.ad.multiply(Nt,it,ct);const mi=s._.fromValues(Math.floor(1e6*Fe[0])/1e6*k,Math.floor(1e6*Fe[1])/1e6*k,0),_i=.5*b,hi=[0,0,0];s._.transformMat4(hi,mi,Nt),s._.scale(hi,hi,_i);const vt=[Math.floor(hi[0]),Math.floor(hi[1]),Math.floor(hi[2])],Gt=[0,0,0];s._.sub(Gt,hi,vt),s._.scale(Gt,Gt,-1/_i);const ri=new Float64Array(16);return s.ad.identity(ri),s.ad.translate(ri,ri,Gt),s.ad.multiply(Nt,ri,Nt),[Nt,Ot]}function wc(m,r){return m!=null&&r!=null&&!(!m.hasData()||!r.hasData())&&m.demTexture!=null&&r.demTexture!=null&&m.tileID.key!==r.tileID.key}const Al=new class{constructor(){this.operations={}}newMorphing(m,r,h,y,b){if(m in this.operations){const T=this.operations[m];T.to.tileID.key!==h.tileID.key&&(T.queued=h)}else this.operations[m]={startTime:y,phase:0,duration:b,from:r,to:h,queued:null}}getMorphValuesForProxy(m){if(!(m in this.operations))return null;const r=this.operations[m];return{from:r.from,to:r.to,phase:r.phase}}update(m){for(const r in this.operations){const h=this.operations[r];for(h.phase=(m-h.startTime)/h.duration;h.phase>=1||!this._validOp(h);)if(!this._nextOp(h,m)){delete this.operations[r];break}}}_nextOp(m,r){return!!m.queued&&(m.from=m.to,m.to=m.queued,m.queued=null,m.phase=0,m.startTime=r,!0)}_validOp(m){return m.from.hasData()&&m.to.hasData()}},Au={0:null,1:"TERRAIN_VERTEX_MORPHING"};function Mc(m,r,h){if(r===0)return 0;const y=r<1&&h===514?.25/r:1;return 6*Math.pow(1.5,22-m)*Math.max(r,1)*y}function Cu(m,r){const h=1<<m.z;return!r&&(m.x===0||m.x===h-1)||m.y===0||m.y===h-1}const rh=m=>({u_matrix:m});function sh(m,r,h,y,b){if(b>0){const T=s.e.now(),E=(T-m.timeAdded)/b,I=r?(T-r.timeAdded)/b:-1,k=h.getSource(),N=y.coveringZoomLevel({tileSize:k.tileSize,roundZoom:k.roundZoom}),H=!r||Math.abs(r.tileID.overscaledZ-N)>Math.abs(m.tileID.overscaledZ-N),X=H&&m.refreshedUponExpiration?1:s.at(H?E:1-I,0,1);return m.refreshedUponExpiration&&E>=1&&(m.refreshedUponExpiration=!1),r?{opacity:1,mix:1-X}:{opacity:X,mix:0}}return{opacity:1,mix:0}}class Kl extends Ln{constructor(r,h,y,b){super(r,h,y,b),this.type="raster-array",this.maxzoom=22,this._options=s.W({type:"raster-array"},h)}triggerRepaint(r){const h=this.map.painter._terrain,y=this.map.style.getSourceCache(this.id);h&&h.enabled&&y&&h._clearRenderCacheForTile(y.id,r.tileID),this.map.triggerRepaint()}loadTile(r,h){const y=this.map._requestManager.normalizeTileURL(r.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),b=this.map._requestManager.transformRequest(y,s.R.Tile);r.requestParams=b,r.actor||(r.actor=this.dispatcher.getActor()),r.request=r.fetchHeader(void 0,(T,E,I,k)=>{if(delete r.request,r.aborted)return r.state="unloaded",h(null);if(T)return T.code===20?void 0:(r.state="errored",h(T));this.map._refreshExpiredTiles&&r.setExpiryData({cacheControl:I,expires:k}),r.state="empty",h(null)})}unloadTile(r,h){const y=r.texture;y&&y instanceof s.T?(r.destroy(!0),this.map.painter.saveTileTexture(y)):(r.destroy(),r.flushQueues(),r._isHeaderLoaded=!1,delete r._mrt,delete r.textureDescriptor),r.fbo&&(r.fbo.destroy(),delete r.fbo),delete r.request,delete r.requestParams,delete r.neighboringTiles,r.state="unloaded"}prepareTile(r,h,y){r._isHeaderLoaded&&(r.state!=="empty"&&(r.state="reloading"),r.fetchBand(h,y,(b,T)=>{if(b)return r.state="errored",this.fire(new s.d(b)),void this.triggerRepaint(r);T&&(r.setTexture(T,this.map.painter),r.state="loaded",this.triggerRepaint(r))}))}getInitialBand(r){if(!this.rasterLayers)return 0;const h=this.rasterLayers.find(({id:T})=>T===r),y=h&&h.fields,b=y&&y.bands&&y.bands;return b?b[0]:0}getTextureDescriptor(r,h,y){if(!r)return;const b=h.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!b)return;let T=null;h instanceof s.bk?T=h.paint.get("raster-array-band"):h instanceof s.bl&&(T=h.paint.get("raster-particle-array-band"));const E=T||this.getInitialBand(b);if(E!=null)if(r.textureDescriptor){if(!r.updateNeeded(b,E)||y)return Object.assign({},r.textureDescriptor,{texture:r.texture})}else this.prepareTile(r,b,E)}}const oh={vector:Bi,raster:Ln,"raster-dem":class extends Ln{constructor(m,r,h,y){super(m,r,h,y),this.type="raster-dem",this.maxzoom=22,this._options=s.W({type:"raster-dem"},r),this.encoding=r.encoding||"mapbox"}loadTile(m,r){const h=this.map._requestManager.normalizeTileURL(m.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function y(b,T){b&&(m.state="errored",r(b)),T&&(m.dem=T,m.dem.onDeserialize(),m.needsHillshadePrepare=!0,m.needsDEMTextureUpload=!0,m.state="loaded",r(null))}m.request=s.h(this.map._requestManager.transformRequest(h,s.R.Tile),(function(b,T,E,I){if(delete m.request,m.aborted)m.state="unloaded",r(null);else if(b)m.state="errored",r(b);else if(T){this.map._refreshExpiredTiles&&m.setExpiryData({cacheControl:E,expires:I});const k=ImageBitmap&&T instanceof ImageBitmap&&s.bi(),N=1-(T.width-s.bj(T.width))/2;N<1||m.neighboringTiles||(m.neighboringTiles=this._getNeighboringTiles(m.tileID));const H=k?T:s.e.getImageData(T,N),X={uid:m.uid,coord:m.tileID,source:this.id,scope:this.scope,rawImageData:H,encoding:this.encoding,padding:N};m.actor&&m.state!=="expired"||(m.actor=this.dispatcher.getActor(),m.actor.send("loadDEMTile",X,y.bind(this),void 0,!0))}}).bind(this))}_getNeighboringTiles(m){const r=m.canonical,h=Math.pow(2,r.z),y=(r.x-1+h)%h,b=r.x===0?m.wrap-1:m.wrap,T=(r.x+1+h)%h,E=r.x+1===h?m.wrap+1:m.wrap,I={};return I[new s.aL(m.overscaledZ,b,r.z,y,r.y).key]={backfilled:!1},I[new s.aL(m.overscaledZ,E,r.z,T,r.y).key]={backfilled:!1},r.y>0&&(I[new s.aL(m.overscaledZ,b,r.z,y,r.y-1).key]={backfilled:!1},I[new s.aL(m.overscaledZ,m.wrap,r.z,r.x,r.y-1).key]={backfilled:!1},I[new s.aL(m.overscaledZ,E,r.z,T,r.y-1).key]={backfilled:!1}),r.y+1<h&&(I[new s.aL(m.overscaledZ,b,r.z,y,r.y+1).key]={backfilled:!1},I[new s.aL(m.overscaledZ,m.wrap,r.z,r.x,r.y+1).key]={backfilled:!1},I[new s.aL(m.overscaledZ,E,r.z,T,r.y+1).key]={backfilled:!1}),I}},"raster-array":Kl,geojson:class extends s.E{constructor(m,r,h,y){super(),this.id=m,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=h.getActor(),this.setEventedParent(y),this._data=r.data,this._options=s.W({},r),this._collectResourceTiming=r.collectResourceTiming,r.maxzoom!==void 0&&(this.maxzoom=r.maxzoom),r.minzoom!==void 0&&(this.minzoom=r.minzoom),r.type&&(this.type=r.type),r.attribution&&(this.attribution=r.attribution),this.promoteId=r.promoteId;const b=s.a3/this.tileSize;this.workerOptions=s.W({source:this.id,scope:this.scope,cluster:r.cluster||!1,geojsonVtOptions:{buffer:(r.buffer!==void 0?r.buffer:128)*b,tolerance:(r.tolerance!==void 0?r.tolerance:.375)*b,extent:s.a3,maxZoom:this.maxzoom,lineMetrics:r.lineMetrics||!1,generateId:r.generateId||!1},superclusterOptions:{maxZoom:r.clusterMaxZoom!==void 0?r.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,r.clusterMinPoints||2),extent:s.a3,radius:(r.clusterRadius!==void 0?r.clusterRadius:50)*b,log:!1,generateId:r.generateId||!1},clusterProperties:r.clusterProperties,filter:r.filter,dynamic:r.dynamic},r.workerOptions)}onAdd(m){this.map=m,this.setData(this._data)}setData(m){return this._data=m,this._updateWorkerData(),this}updateData(m){return this._options.dynamic?typeof m!="string"&&(m.type==="Feature"&&(m={type:"FeatureCollection",features:[m]}),m.type!=="FeatureCollection")?this.fire(new s.d(new Error("Data to update should be a feature or a feature collection."))):(this._coalesce&&typeof m!="string"&&typeof this._data!="string"&&this._data.type==="FeatureCollection"?this._data.features.push(...m.features):this._data=m,this._updateWorkerData(!0),this):this.fire(new s.d(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")))}getClusterExpansionZoom(m,r){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:m,source:this.id,scope:this.scope},r),this}getClusterChildren(m,r){return this.actor.send("geojson.getClusterChildren",{clusterId:m,source:this.id,scope:this.scope},r),this}getClusterLeaves(m,r,h,y){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:m,limit:r,offset:h},y),this}_updateWorkerData(m=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new s.f("dataloading",{dataType:"source"})),this._loaded=!1;const r=s.W({append:m},this.workerOptions);r.scope=this.scope;const h=this._data;typeof h=="string"?(r.request=this.map._requestManager.transformRequest(s.e.resolveURL(h),s.R.Source),r.request.collectResourceTiming=this._collectResourceTiming):r.data=JSON.stringify(h),this._pendingLoad=this.actor.send(`${this.type}.loadData`,r,(y,b)=>{if(this._loaded=!0,this._pendingLoad=null,y)this.fire(new s.d(y));else{const T={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&b&&b.resourceTiming&&b.resourceTiming[this.id]&&(T.resourceTiming=b.resourceTiming[this.id]),m&&(this._partialReload=!0),this.fire(new s.f("data",T)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(m),this._coalesce=!1)})}loaded(){return this._loaded}loadTile(m,r){const h=m.actor?"reloadTile":"loadTile";m.actor=this.actor;const y=this.map.style?this.map.style.getLut(this.scope):null,b=this._partialReload,T={type:this.type,uid:m.uid,tileID:m.tileID,tileZoom:m.tileZoom,zoom:m.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:y?{image:y.image.clone()}:null,scope:this.scope,pixelRatio:s.e.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,partial:b};m.request=this.actor.send(h,T,(E,I)=>b&&!I?(m.state="loaded",r(null)):(delete m.request,m.destroy(),m.aborted?r(null):E?r(E):(m.loadVectorData(I,this.map.painter,h==="reloadTile"),r(null))),void 0,h==="loadTile")}abortTile(m){m.request&&(m.request.cancel(),delete m.request),m.aborted=!0}unloadTile(m,r){this.actor.send("removeTile",{uid:m.uid,type:this.type,source:this.id,scope:this.scope}),m.destroy()}onRemove(m){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return s.W({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends s.bm{constructor(m,r,h,y){super(m,r,h,y),this.roundZoom=!0,this.type="video",this.options=r}load(){this._loaded=!1;const m=this.options;this.urls=[];for(const r of m.urls)this.urls.push(this.map._requestManager.transformRequest(r,s.R.Source).url);s.bn(this.urls,(r,h)=>{this._loaded=!0,r?this.fire(new s.d(r)):h&&(this.video=h,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(m){if(this.video){const r=this.video.seekable;m<r.start(0)||m>r.end(0)?this.fire(new s.d(new s.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${r.start(0)} and ${r.end(0)}-second mark.`))):this.video.currentTime=m}}getVideo(){return this.video}onAdd(m){this.map||(this.map=m,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const m=this.map.painter.context,r=m.gl;this.texture?this.video.paused||(this.texture.bind(r.LINEAR,r.CLAMP_TO_EDGE),r.texSubImage2D(r.TEXTURE_2D,0,0,0,r.RGBA,r.UNSIGNED_BYTE,this.video)):(this.texture=new s.T(m,this.video,r.RGBA),this.texture.bind(r.LINEAR,r.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(m)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:s.bm,model:class extends s.E{constructor(m,r,h,y){super(),this.id=m,this.type="model",this.models=[],this._loaded=!1,this._options=r}load(){const m=[];for(const r in this._options.models){const h=this._options.models[r],y=s.l(this.map._requestManager.transformRequest(h.uri,s.R.Model).url).then(b=>{if(!b)return;const T=s.c(b),E=new s.M(r,h.position,h.orientation,T);E.computeBoundsAndApplyParent(),this.models.push(E)}).catch(b=>{this.fire(new s.d(new Error(`Could not load model ${r} from ${h.uri}: ${b.message}`)))});m.push(y)}return Promise.allSettled(m).then(()=>{this._loaded=!0,this.fire(new s.f("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(r=>{this.fire(new s.d(new Error(`Could not load models: ${r.message}`)))})}onAdd(m){this.map=m,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(m,r){}serialize(){return{type:"model"}}},"batched-model":class extends s.E{constructor(m,r,h,y){super(),this.type="batched-model",this.id=m,this.tileSize=512,this._options=r,this.tiles=this._options.tiles,this.maxzoom=r.maxzoom||19,this.minzoom=r.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=h,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(y)}onAdd(m){this.map=m,this.load()}load(m){this._loaded=!1,this.fire(new s.f("dataloading",{dataType:"source"}));const r=Array.isArray(this.map._language)?this.map._language.join():this.map._language,h=this.map._worldview;this._tileJSONRequest=zn(this._options,this.map._requestManager,r,h,(y,b)=>{this._tileJSONRequest=null,this._loaded=!0,y?(r&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${r}`),h&&h.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${h}`),this.fire(new s.d(y))):b&&(s.W(this,b),b.bounds&&(this.tileBounds=new Zi(b.bounds,this.minzoom,this.maxzoom)),s.an(b.tiles,this.map._requestManager._customAccessToken),this.fire(new s.f("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.f("data",{dataType:"source",sourceDataType:"content"}))),m&&m(y)})}hasTransition(){return!1}hasTile(m){return!this.tileBounds||this.tileBounds.contains(m.canonical)}loaded(){return this._loaded}loadTile(m,r){const h=this.map._requestManager.normalizeTileURL(m.tileID.canonical.url(this.tiles,this.scheme)),y={request:this.map._requestManager.transformRequest(h,s.R.Tile),data:void 0,uid:m.uid,tileID:m.tileID,tileZoom:m.tileZoom,zoom:m.tileID.overscaledZ,tileSize:this.tileSize*m.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:m.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0};if(m.actor&&m.state!=="expired")if(m.state==="loading")m.reloadCallback=r;else{if(m.buckets){const T=Object.values(m.buckets);for(const E of T)E.dirty=!0;return void(m.state="loaded")}m.request=m.actor.send("reloadTile",y,b.bind(this))}else m.actor=this.dispatcher.getActor(),m.request=m.actor.send("loadTile",y,b.bind(this),void 0,!0);function b(T,E){return m.aborted?r(null):T&&T.status!==404?r(T):(E&&(E.resourceTiming&&(m.resourceTiming=E.resourceTiming),this.map._refreshExpiredTiles&&m.setExpiryData(E),m.buckets={...m.buckets,...E.buckets},E.featureIndex&&(m.latestFeatureIndex=E.featureIndex)),m.state="loaded",void r(null))}}serialize(){return s.W({},this._options)}},canvas:class extends s.bm{constructor(m,r,h,y){super(m,r,h,y),r.coordinates?Array.isArray(r.coordinates)&&r.coordinates.length===4&&!r.coordinates.some(b=>!Array.isArray(b)||b.length!==2||b.some(T=>typeof T!="number"))||this.fire(new s.d(new s.V(`sources.${m}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new s.d(new s.V(`sources.${m}`,null,'missing required property "coordinates"'))),r.animate&&typeof r.animate!="boolean"&&this.fire(new s.d(new s.V(`sources.${m}`,null,'optional "animate" property must be a boolean value'))),r.canvas?typeof r.canvas=="string"||r.canvas instanceof HTMLCanvasElement||this.fire(new s.d(new s.V(`sources.${m}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new s.d(new s.V(`sources.${m}`,null,'missing required property "canvas"'))),this.options=r,this.animate=r.animate===void 0||r.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new s.d(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(m){this.map=m,this.load(),this.canvas&&this.animate&&this.play()}onRemove(m){this.pause()}prepare(){let m=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,m=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,m=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const r=this.map.painter.context;this.texture?!m&&!this._playing||this.texture instanceof s.bo||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new s.T(r,this.canvas,r.gl.RGBA,{premultiply:!0}),this._prepareData(r)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const m of[this.canvas.width,this.canvas.height])if(isNaN(m)||m<=0)return!0;return!1}},custom:class extends s.E{constructor(m,r,h,y){super(),this.id=m,this.type="custom",this._dataType="raster",this._dispatcher=h,this._implementation=r,this.setEventedParent(y),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new s.d(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new s.d(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new Zi(this._implementation.bounds,this.minzoom,this.maxzoom)),r.update=this._update.bind(this),r.clearTiles=this._clearTiles.bind(this),r.coveringTiles=this._coveringTiles.bind(this),s.W(this,s.ah(r,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return s.ah(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new s.f("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.f("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(m){this.map=m,this._loaded=!1,this.fire(new s.f("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(m),this.load()}onRemove(m){this._implementation.onRemove&&this._implementation.onRemove(m)}hasTile(m){if(this._implementation.hasTile){const{x:r,y:h,z:y}=m.canonical;return this._implementation.hasTile({x:r,y:h,z:y})}return!this.tileBounds||this.tileBounds.contains(m.canonical)}loadTile(m,r){const{x:h,y,z:b}=m.tileID.canonical,T=new AbortController;m.request=Promise.resolve(this._implementation.loadTile({x:h,y,z:b},{signal:T.signal})).then((function(E){return delete m.request,m.aborted?(m.state="unloaded",r(null)):E===void 0?(m.state="errored",r(null)):E===null?(this.loadTileData(m,{width:this.tileSize,height:this.tileSize,data:null}),m.state="loaded",r(null)):function(I){return I instanceof ImageData||I instanceof HTMLCanvasElement||I instanceof ImageBitmap||I instanceof HTMLImageElement}(E)?(this.loadTileData(m,E),m.state="loaded",void r(null)):(m.state="errored",r(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch(E=>{E.code!==20&&(m.state="errored",r(E))}),m.request.cancel=()=>T.abort()}loadTileData(m,r){m.setTexture(r,this.map.painter)}unloadTile(m,r){if(m.texture&&m.texture instanceof s.T?(m.destroy(!0),m.texture&&m.texture instanceof s.T&&this.map.painter.saveTileTexture(m.texture)):m.destroy(),this._implementation.unloadTile){const{x:h,y,z:b}=m.tileID.canonical;this._implementation.unloadTile({x:h,y,z:b})}r&&r()}abortTile(m,r){m.request&&m.request.cancel&&(m.request.cancel(),delete m.request),r&&r()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(m=>({x:m.canonical.x,y:m.canonical.y,z:m.canonical.z}))}_clearTiles(){const m=s.al(this.id,this.scope);this.map.style.clearSource(m)}_update(){this.fire(new s.f("data",{dataType:"source",sourceDataType:"content"}))}}},mo=function(m,r,h,y){const b=new oh[r.type](m,r,h,y);if(b.id!==m)throw new Error(`Expected Source id to be ${m} instead of ${b.id}`);return s.bp(["load","abort","unload","serialize","prepare"],b),b};class Lu extends s.bv{constructor(r){const h={type:"raster-dem",maxzoom:r.transform.maxZoom},y=new s.bw(s.bx(),null),b=mo("mock-dem",h,y,r.style);super("mock-dem",b,!1),b.setEventedParent(this),this._sourceLoaded=!0}_loadTile(r,h){r.state="loaded",h(null)}}class oo extends s.bv{constructor(r){const h=mo("proxy",{type:"geojson",maxzoom:r.transform.maxZoom},new s.bw(s.bx(),null),r.style);super("proxy",h,!1),h.setEventedParent(this),this.map=this.getSource().map=r,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(r,h,y){if(r.freezeTileCoverage)return;this.transform=r;const b=r.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((T,E)=>{if(T[E.key]="",!this._tiles[E.key]){const I=new s.by(E,this._source.tileSize*E.overscaleFactor(),r.tileZoom);I.state="loaded",this._tiles[E.key]=I}return T},{});for(const T in this._tiles)T in b||(this.freeFBO(T),this._tiles[T].unloadVectorData(),delete this._tiles[T])}freeFBO(r){const h=this.proxyCachedFBO[r];if(h!==void 0){const y=Object.values(h);this.renderCachePool.push(...y),delete this.proxyCachedFBO[r]}}deallocRenderCache(){this.renderCache.forEach(r=>r.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Vh extends s.aL{constructor(r,h,y){super(r.overscaledZ,r.wrap,r.canonical.z,r.canonical.x,r.canonical.y),this.proxyTileKey=h,this.projMatrix=y}}class el extends s.bq{constructor(r,h){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},r.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),r.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),r.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=r,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[y,b,T]=function(k){const N=new s.bt,H=new s.bu,X=131;N.reserve(17161),H.reserve(33800);const ee=s.a3/128,ie=s.a3+ee/2,ue=ie+ee;for(let fe=-ee;fe<ue;fe+=ee)for(let _e=-ee;_e<ue;_e+=ee){const Le=_e<0||_e>ie||fe<0||fe>ie?24575:0,Fe=s.at(Math.round(_e),0,s.a3),Be=s.at(Math.round(fe),0,s.a3);N.emplaceBack(Fe+Le,Be)}const pe=(fe,_e)=>{const Le=_e*X+fe;H.emplaceBack(Le+1,Le,Le+X),H.emplaceBack(Le+X,Le+X+1,Le+1)};for(let fe=1;fe<129;fe++)for(let _e=1;_e<129;_e++)pe(_e,fe);return[0,129].forEach(fe=>{for(let _e=0;_e<130;_e++)pe(_e,fe),pe(fe,_e)}),[N,H,32768]}(),E=r.context;this.gridBuffer=E.createVertexBuffer(y,s.br.members),this.gridIndexBuffer=E.createIndexBuffer(b),this.gridSegments=s.b.simpleSegment(0,0,y.length,b.length),this.gridNoSkirtSegments=s.b.simpleSegment(0,0,y.length,T),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new oo(h.map),this.orthoMatrix=s.ad.create(),s.ad.ortho(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,s.a3,0,s.a3,0,1);const I=E.gl;this._overlapStencilMode=new s.ag({func:I.GEQUAL,mask:255},0,255,I.KEEP,I.KEEP,I.REPLACE),this._previousZoom=r.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=h,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new Lu(h.map),this._pendingGroundEffectLayers=[]}set style(r){r.on("data",this._onStyleDataEvent.bind(this)),this._style=r,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(r,h,y){if(r&&r.terrain){this._style!==r&&(this.style=r,this._evaluationZoom=void 0);const b=r.terrain.properties,T=r.terrain.drapeRenderMode===0,E=r.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=s.e.now();const I=r.terrain&&r.terrain.scope,k=b.get("source"),N=T?this._mockSourceCache:r.getSourceCache(k,I);if(!N)return void s.w(`Couldn't find terrain source "${k}".`);if(this.sourceCache=N,this._exaggeration=E?this.calculateExaggeration(h):b.get("exaggeration"),!h.projection.requiresDraping&&E&&this._exaggeration===0)return void this._disable();this.enabled=!0;const H=()=>{this.sourceCache.used&&s.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const X=this.getScaledDemTileSize();this.sourceCache.update(h,X,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,H(),this._initializing=!0),H(),h.updateElevation(!0,y),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(h),this._emptyDEMTextureDirty=!0,this._previousZoom=h.zoom}else this._disable()}calculateExaggeration(r){const h=this._previousCameraAltitude,y=r.getFreeCameraOptions().position.z/r.pixelsPerMeter*r.worldSize;this._previousCameraAltitude=y;const b=h!=null?y-h:Number.MAX_VALUE;if(Math.abs(b)<2)return this._exaggeration;const T=r.zoom,E=this._style.terrain;if(!this._previousUpdateTimestamp)return E.getExaggeration(T);let I=T-this._previousZoom;const k=this._previousUpdateTimestamp;let N=T;this._evaluationZoom!=null&&(N=this._evaluationZoom,Math.abs(T-N)>.5&&(I=.5*(T-N+I)),I*b<0&&(N+=I)),this._evaluationZoom=N;const H=E.getExaggeration(N),X=H===E.getExaggeration(Math.max(0,N-.1));if(X&&Math.abs(H-this._exaggeration)<.01)return H;let ee=Math.min(.1,.00375*(this._updateTimestamp-k));return(X||H<.1||Math.abs(I)<1e-4)&&(ee=Math.min(.2,4*ee)),s.a2(this._exaggeration,H,ee)}resetTileLookupCache(r){this._findCoveringTileCache[r]={}}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(r){r.coord&&r.dataType==="source"?this._clearRenderCacheForTile(r.sourceCacheId,r.coord):r.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const r in this._style._mergedSourceCaches)this._style._mergedSourceCaches[r].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this._emptyDepthBufferTexture&&this._emptyDepthBufferTexture.destroy(),this.pool.forEach(r=>r.fb.destroy()),this.pool=[],this._depthFBO&&(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const r=2*this.proxySourceCache.getSource().tileSize;return[r,r]}set useVertexMorphing(r){this._useVertexMorphing=r}updateTileBinding(r){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const h=this.proxySourceCache,y=this.painter.transform;this._initializing&&(this._initializing=y._centerAltitude===0&&this.getAtPointOrZero(s.Y.fromLngLat(y.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const b=this.proxyCoords=h.getIds().map(k=>{const N=h.getTileByID(k).tileID;return N.projMatrix=y.calculateProjMatrix(N.toUnwrapped()),N});(function(k,N){const H=N.transform.pointCoordinate(N.transform.getCameraPoint()),X=new s.P(H.x,H.y);k.sort((ee,ie)=>{if(ie.overscaledZ-ee.overscaledZ)return ie.overscaledZ-ee.overscaledZ;const ue=new s.P(ee.canonical.x+(1<<ee.canonical.z)*ee.wrap,ee.canonical.y),pe=new s.P(ie.canonical.x+(1<<ie.canonical.z)*ie.wrap,ie.canonical.y),fe=X.mult(1<<ee.canonical.z);return fe.x-=.5,fe.y-=.5,fe.distSqr(ue)-fe.distSqr(pe)})})(b,this.painter);const T=this.proxyToSource||{};this.proxyToSource={},b.forEach(k=>{this.proxyToSource[k.key]={}}),this.terrainTileForTile={};const E=this._style._mergedSourceCaches;for(const k in E){const N=E[k];if(!N.used||(N!==this.sourceCache&&this.resetTileLookupCache(N.id),this._setupProxiedCoordsForOrtho(N,r[k],T),N.usedForTerrain))continue;const H=r[k];N.getSource().reparseOverscaled&&this._assignTerrainTiles(H)}this.proxiedCoords[h.id]=b.map(k=>new Vh(k,k.key,this.orthoMatrix)),this._assignTerrainTiles(b),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(T),this.renderingToTexture=!1;const I={};this._visibleDemTiles=[];for(const k of this.proxyCoords){const N=this.terrainTileForTile[k.key];if(!N)continue;const H=N.tileID.key;H in I||(this._visibleDemTiles.push(N),I[H]=H)}}_assignTerrainTiles(r){this._initializing||r.forEach(h=>{if(this.terrainTileForTile[h.key])return;const y=this._findTileCoveringTileID(h,this.sourceCache);y&&(this.terrainTileForTile[h.key]=y)})}_prepareDEMTextures(){const r=this.painter.context,h=r.gl;for(const y in this.terrainTileForTile){const b=this.terrainTileForTile[y],T=b.dem;!T||b.demTexture&&!b.needsDEMTextureUpload||(r.activeTexture.set(h.TEXTURE1),Hi(this.painter,b,T))}}_prepareDemTileUniforms(r,h,y,b){if(!h||h.demTexture==null)return!1;const T=r.tileID.canonical,E=Math.pow(2,h.tileID.canonical.z-T.z),I=b||"";return y[`u_dem_tl${I}`]=[T.x*E%1,T.y*E%1],y[`u_dem_scale${I}`]=E,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}get emptyDepthBufferTexture(){const r=this.painter.context,h=r.gl;if(!this._emptyDepthBufferTexture){const y=new s.i({width:1,height:1},Uint8Array.of(255,255,255,255));this._emptyDepthBufferTexture=new s.T(r,y,h.RGBA,{premultiply:!1})}return this._emptyDepthBufferTexture}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let r=0;const h=this._visibleDemTiles.reduce((y,b)=>{if(!b.dem)return y;const T=b.dem.tree.minimums[0];return T>0&&r++,y+T},0);return r?h/r:0}_updateEmptyDEMTexture(){const r=this.painter.context,h=r.gl;r.activeTexture.set(h.TEXTURE2);const y=this._getLoadedAreaMinimum(),[b,T]=(()=>{const I=new s.bz({width:1,height:1},new Float32Array([y]));return[h.R32F,I]})();this._emptyDEMTextureDirty=!1;let E=this._emptyDEMTexture;return E?E.update(T,{premultiply:!1}):E=this._emptyDEMTexture=new s.T(r,T,b,{premultiply:!1}),E}setupElevationDraw(r,h,y){const b=this.painter.context,T=b.gl,E={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[2,0],u_exaggeration:0};E.u_exaggeration=this.exaggeration();let I=null,k=null,N=1;if(y&&y.morphing&&this._useVertexMorphing){const ue=y.morphing.srcDemTile,pe=y.morphing.dstDemTile;N=y.morphing.phase,ue&&pe&&(this._prepareDemTileUniforms(r,ue,E,"_prev")&&(k=ue),this._prepareDemTileUniforms(r,pe,E)&&(I=pe))}const H=ue=>ue&&ue.demTexture&&this.painter.linearFloatFilteringSupported()?T.LINEAR:T.NEAREST;let X=null;var ee,ie;if(this.enabled?k&&I?(X=I.demTexture,b.activeTexture.set(T.TEXTURE4),k.demTexture.bind(H(k),T.CLAMP_TO_EDGE),E.u_dem_lerp=N):(I=this.terrainTileForTile[r.tileID.key],X=this._prepareDemTileUniforms(r,I,E)?I.demTexture:this.emptyDEMTexture):X=this.emptyDEMTexture,b.activeTexture.set(T.TEXTURE2),X&&(E.u_dem_size=(ee=X).size[0]===1?1:ee.size[0]-2,X.bind(H(I),T.CLAMP_TO_EDGE)),b.activeTexture.set(T.TEXTURE3),y&&y.useDepthForOcclusion&&this.painter.terrainDepthTexture&&this.painter.terrainDepthFBO?(this.painter.terrainDepthTexture.bind(T.NEAREST,T.CLAMP_TO_EDGE),E.u_depth_size_inv=[1/this.painter.terrainDepthFBO.width,1/this.painter.terrainDepthFBO.height],E.u_depth_range_unpack=[2/((ie=this.painter.depthRangeFor3D)[1]-ie[0]),-1-2*ie[0]/(ie[1]-ie[0])]):(this.emptyDepthBufferTexture.bind(T.NEAREST,T.CLAMP_TO_EDGE),E.u_depth_range_unpack=[2,0]),b.activeTexture.set(T.TEXTURE0),y&&y.useMeterToDem&&I){const ue=(1<<I.tileID.canonical.z)*s.ax(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;E.u_meter_to_dem=ue}if(y&&y.labelPlaneMatrixInv&&(E.u_label_plane_matrix_inv=y.labelPlaneMatrixInv),h.setTerrainUniformValues(b,E),this.painter.transform.projection.name==="globe"){const ue=this.globeUniformValues(this.painter.transform,r.tileID.canonical,y&&y.useDenormalizedUpVectorScale);h.setGlobeUniformValues(b,ue)}}globeUniformValues(r,h,y){const b=r.projection;return{u_tile_tl_up:b.upVector(h,0,0),u_tile_tr_up:b.upVector(h,s.a3,0),u_tile_br_up:b.upVector(h,s.a3,s.a3),u_tile_bl_up:b.upVector(h,0,s.a3),u_tile_up_scale:y?s.bs(1):b.upVectorScale(h,r.center.lat,r.worldSize).metersToTile}}renderToBackBuffer(r){const h=this.painter,y=this.painter.context;r.length!==0&&(y.bindFramebuffer.set(null),y.viewport.set([0,0,h.width,h.height]),h.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(b,T,E,I,k){if(b.transform.projection.name==="globe")(function(N,H,X,ee,ie){const ue=N.context,pe=ue.gl;let fe,_e;const Le=N.transform,Fe=s.ba(N,ue,Le),Be=(it,Nt)=>{if(_e===Nt)return;const mi=[Au[Nt],"PROJECTION_GLOBE_VIEW"];Fe&&mi.push("CUSTOM_ANTIALIASING");const _i=N.isTileAffectedByFog(it);fe=N.getOrCreateProgram("globeRaster",{defines:mi,overrideFog:_i}),_e=Nt},$e=N.colorModeForRenderPass(),Ze=new s.ae(pe.LEQUAL,s.ae.ReadWrite,N.depthRangeFor3D);Al.update(ie);const rt=s.bb(Le),xe=[s.aj(Le.center.lng),s.ak(Le.center.lat)],Ne=N.globeSharedBuffers,ct=[Le.width*s.e.devicePixelRatio,Le.height*s.e.devicePixelRatio],Ot=Float32Array.from(Le.globeMatrix),mt={useDenormalizedUpVectorScale:!0};{const it=N.transform,Nt=Mc(it.zoom,H.exaggeration(),H.sourceCache._source.tileSize);_e=-1;const mi=pe.TRIANGLES;for(const _i of ee){const hi=X.getTile(_i),vt=s.ag.disabled,Gt=H.prevTerrainTileForTile[_i.key],ri=H.terrainTileForTile[_i.key];wc(Gt,ri)&&Al.newMorphing(_i.key,Gt,ri,ie,250),ue.activeTexture.set(pe.TEXTURE0),hi.texture&&hi.texture.bind(pe.LINEAR,pe.CLAMP_TO_EDGE);const $i=Al.getMorphValuesForProxy(_i.key),Yi=$i?1:0;$i&&s.o(mt,{morphing:{srcDemTile:$i.from,dstDemTile:$i.to,phase:s.b9($i.phase)}});const hn=s.bc(_i.canonical),Ji=s.bd(hn.getCenter().lat),Gi=s.be(_i.canonical,hn,Ji,it.worldSize/it._pixelsPerMercatorPixel),Qt=s.bf(s.bg(_i.canonical)),xn=Kt(it.expandedFarZProjMatrix,Ot,rt,Qt,s.a1(it.zoom),xe,it.frustumCorners.TL,it.frustumCorners.TR,it.frustumCorners.BR,it.frustumCorners.BL,it.globeCenterInViewSpace,it.globeRadius,ct,Nt,it._farZ,Gi);if(Be(_i,Yi),fe&&(H.setupElevationDraw(hi,fe,mt),N.uploadCommonUniforms(ue,fe,_i.toUnwrapped()),Ne)){const[Tr,Wn,cr]=Ne.getGridBuffers(Ji,Nt!==0);fe.draw(N,mi,Ze,vt,$e,s.af.backCCW,xn,"globe_raster",Tr,Wn,cr)}}}if(Ne&&(N.renderDefaultNorthPole||N.renderDefaultSouthPole)){const it=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];Fe&&it.push("CUSTOM_ANTIALIASING"),fe=N.getOrCreateProgram("globeRaster",{defines:it});for(const Nt of ee){const{x:mi,y:_i,z:hi}=Nt.canonical,vt=_i===0,Gt=_i===(1<<hi)-1,[ri,$i,Yi,hn]=Ne.getPoleBuffers(hi,!1);if(hn&&(vt||Gt)){const Ji=X.getTile(Nt);ue.activeTexture.set(pe.TEXTURE0),Ji.texture&&Ji.texture.bind(pe.LINEAR,pe.CLAMP_TO_EDGE);let Gi=s.bh(hi,mi,Le);const Qt=s.bf(s.bg(Nt.canonical)),xn=(Tr,Wn)=>Tr.draw(N,pe.TRIANGLES,Ze,s.ag.disabled,$e,s.af.disabled,Kt(Le.expandedFarZProjMatrix,Gi,Gi,Qt,0,xe,Le.frustumCorners.TL,Le.frustumCorners.TR,Le.frustumCorners.BR,Le.frustumCorners.BL,Le.globeCenterInViewSpace,Le.globeRadius,ct,0,Le._farZ),"globe_pole_raster",Wn,Yi,hn);H.setupElevationDraw(Ji,fe,mt),N.uploadCommonUniforms(ue,fe,Nt.toUnwrapped()),vt&&N.renderDefaultNorthPole&&xn(fe,ri),Gt&&N.renderDefaultSouthPole&&(Gi=s.ad.scale(s.ad.create(),Gi,[1,-1,1]),xn(fe,$i))}}}})(b,T,E,I,k);else{const N=b.context,H=N.gl;let X,ee;const ie=b.shadowRenderer,ue=Ka(b,b.longestCutoffRange),pe=$e=>{if(ee===$e)return;const Ze=[];Ze.push(Au[$e]),ue.shouldRenderCutoff&&Ze.push("RENDER_CUTOFF"),X=b.getOrCreateProgram("terrainRaster",{defines:Ze}),ee=$e},fe=b.colorModeForRenderPass(),_e=new s.ae(H.LEQUAL,s.ae.ReadWrite,b.depthRangeFor3D);Al.update(k);const Le=b.transform,Fe=Mc(Le.zoom,T.exaggeration(),T.sourceCache._source.tileSize);let Be=[0,0,0];if(ie){const $e=b.style.directionalLight,Ze=b.style.ambientLight;$e&&Ze&&(Be=wa(b.style,$e,Ze))}{ee=-1;const $e=H.TRIANGLES,[Ze,rt]=[T.gridIndexBuffer,T.gridSegments];for(const xe of I){const Ne=E.getTile(xe),ct=s.ag.disabled,Ot=T.prevTerrainTileForTile[xe.key],mt=T.terrainTileForTile[xe.key];wc(Ot,mt)&&Al.newMorphing(xe.key,Ot,mt,k,250),N.activeTexture.set(H.TEXTURE0),Ne.texture&&Ne.texture.bind(H.LINEAR,H.CLAMP_TO_EDGE);const it=Al.getMorphValuesForProxy(xe.key),Nt=it?1:0;let mi;it&&(mi={morphing:{srcDemTile:it.from,dstDemTile:it.to,phase:s.b9(it.phase)}});const _i=Nn(xe.projMatrix,Cu(xe.canonical,Le.renderWorldCopies)?Fe/10:Fe,Be);if(pe(Nt),!X)continue;T.setupElevationDraw(Ne,X,mi);const hi=xe.toUnwrapped();ie&&ie.setupShadows(hi,X),b.uploadCommonUniforms(N,X,hi,null,ue),X.draw(b,$e,_e,ct,fe,s.af.backCCW,_i,"terrain_raster",T.gridBuffer,Ze,rt)}}}}(h,this,this.proxySourceCache,r,this._updateTimestamp),this.renderingToTexture=!0,h.gpuTimingDeferredRenderEnd(),r.splice(0,r.length))}renderBatch(r){if(this._drapedRenderBatches.length===0)return r+1;this.renderingToTexture=!0;const h=this.painter,y=this.painter.context,b=this.proxySourceCache,T=this.proxiedCoords[b.id],E=this._drapedRenderBatches.shift(),I=h.style.order,k=[];let N=0;for(const H of T){const X=b.getTileByID(H.proxyTileKey),ee=b.proxyCachedFBO[H.key]?b.proxyCachedFBO[H.key][r]:void 0,ie=ee!==void 0?b.renderCache[ee]:this.pool[N++],ue=ee!==void 0;if(X.texture=ie.tex,ue&&!ie.dirty){k.push(X.tileID);continue}let pe;y.bindFramebuffer.set(ie.fb.framebuffer),this.renderedToTile=!1,ie.dirty&&(y.clear({color:s.C.transparent,stencil:0}),ie.dirty=!1);for(let fe=E.start;fe<=E.end;++fe){const _e=h.style._mergedLayers[I[fe]];if(_e.isHidden(h.transform.zoom))continue;const Le=h.style.getLayerSourceCache(_e),Fe=Le?this.proxyToSource[H.key][Le.id]:[H];if(!Fe)continue;const Be=Fe;y.viewport.set([0,0,ie.fb.width,ie.fb.height]),pe!==(Le?Le.id:null)&&(this._setupStencil(ie,Fe,_e,Le),pe=Le?Le.id:null),h.renderLayer(h,Le,_e,Be)}if(this._drapedRenderBatches.length===0)for(const fe of this._pendingGroundEffectLayers){const _e=h.style._mergedLayers[I[fe]];if(_e.isHidden(h.transform.zoom))continue;const Le=h.style.getLayerSourceCache(_e),Fe=Le?this.proxyToSource[H.key][Le.id]:[H];if(!Fe)continue;const Be=Fe;y.viewport.set([0,0,ie.fb.width,ie.fb.height]),pe!==(Le?Le.id:null)&&(this._setupStencil(ie,Fe,_e,Le),pe=Le?Le.id:null),h.renderLayer(h,Le,_e,Be)}this.renderedToTile?(ie.dirty=!0,k.push(X.tileID)):ue||--N,N===5&&(N=0,this.renderToBackBuffer(k))}return this.renderToBackBuffer(k),this.renderingToTexture=!1,y.bindFramebuffer.set(null),y.viewport.set([0,0,h.width,h.height]),E.end+1}postRender(){}isLayerOrderingCorrect(r){const h=r.order.length;let y=-1,b=h;for(let T=0;T<h;++T)this._style.isLayerDraped(r._mergedLayers[r.order[T]])?y=Math.max(y,T):b=Math.min(b,T);return b>y}getMinElevationBelowMSL(){let r=0;return this._visibleDemTiles.filter(h=>h.dem).forEach(h=>{r=Math.min(r,h.dem.tree.minimums[0])}),r===0?r:(r-30)*this._exaggeration}raycast(r,h,y){if(!this._visibleDemTiles)return null;const b=this._visibleDemTiles.filter(T=>T.dem).map(T=>{const E=T.tileID,I=1<<E.overscaledZ,{x:k,y:N}=E.canonical,H=k/I,X=(k+1)/I,ee=N/I,ie=(N+1)/I;return{minx:H,miny:ee,maxx:X,maxy:ie,t:T.dem.tree.raycastRoot(H,ee,X,ie,r,h,y),tile:T}});b.sort((T,E)=>(T.t!==null?T.t:Number.MAX_VALUE)-(E.t!==null?E.t:Number.MAX_VALUE));for(const T of b){if(T.t==null)return null;const E=T.tile.dem.tree.raycast(T.minx,T.miny,T.maxx,T.maxy,r,h,y);if(E!=null)return E}return null}_createFBO(){const r=this.painter.context,h=r.gl,y=this.drapeBufferSize;r.activeTexture.set(h.TEXTURE0);const b=new s.T(r,{width:y[0],height:y[1],data:null},h.RGBA);b.bind(h.LINEAR,h.CLAMP_TO_EDGE);const T=r.createFramebuffer(y[0],y[1],!0,null);return T.colorAttachment.set(b.texture),T.depthAttachment=new Gn(r,T.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=r.createRenderbuffer(r.gl.DEPTH_STENCIL,y[0],y[1]),this._stencilRef=0,T.depthAttachment.set(this._sharedDepthStencil),r.clear({stencil:0})):T.depthAttachment.set(this._sharedDepthStencil),r.extTextureFilterAnisotropic&&h.texParameterf(h.TEXTURE_2D,r.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,r.extTextureFilterAnisotropicMax),{fb:T,tex:b,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(const r in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[r].hasTransition())return!0;return this._style.order.some(r=>{const h=this._style._mergedLayers[r],y=h.isHidden(this.painter.transform.zoom);return h.type==="custom"?!y&&h.shouldRedrape():!y&&h.hasTransition()})}_clearLineLayersFromRenderCache(){let r=!1;for(const y of this._style.getSources())if(y instanceof Bi){r=!0;break}if(!r)return;const h={};for(let y=0;y<this._style.order.length;++y){const b=this._style._mergedLayers[this._style.order[y]],T=this._style.getLayerSourceCache(b);if(T&&!h[T.id]&&!b.isHidden(this.painter.transform.zoom)&&b.type==="line"&&b.widthExpression()instanceof s.Z){h[T.id]=!0;for(const E of this.proxyCoords){const I=this.proxyToSource[E.key][T.id];if(I)for(const k of I)this._clearRenderCacheForTile(T.id,k)}}}}_clearRasterLayersFromRenderCache(){let r=!1;for(const y in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[y]._source instanceof Ln){r=!0;break}if(!r)return;const h={};for(let y=0;y<this._style.order.length;++y){const b=this._style._mergedLayers[this._style.order[y]],T=this._style.getLayerSourceCache(b);if(!T||h[T.id]||b.isHidden(this.painter.transform.zoom)||b.type!=="raster")continue;const E=b.paint.get("raster-fade-duration");for(const I of this.proxyCoords){const k=this.proxyToSource[I.key][T.id];if(k)for(const N of k){const H=sh(T.getTile(N),T.findLoadedParent(N,0),T,this.painter.transform,E);(H.opacity!==1||H.mix!==0)&&this._clearRenderCacheForTile(T.id,N)}}}}_setupDrapedRenderBatches(){const r=this._style.order,h=r.length;if(h===0)return;const y=[];this._pendingGroundEffectLayers=[];let b,T=0,E=this._style._mergedLayers[r[T]];for(;!this._style.isLayerDraped(E)&&E.isHidden(this.painter.transform.zoom)&&++T<h;)E=this._style._mergedLayers[r[T]];for(;T<h;++T){const I=this._style._mergedLayers[r[T]];I.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(I)?b===void 0&&(b=T):(I.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(T),b!==void 0&&(y.push({start:b,end:T-1}),b=void 0)))}if(b!==void 0&&y.push({start:b,end:T-1}),y.length!==0){const I=y[y.length-1];this._pendingGroundEffectLayers.every(k=>k>I.end)||s.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=y}_setupRenderCache(r){const h=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,h.renderCache.length>h.renderCachePool.length){const E=Object.values(h.proxyCachedFBO);h.proxyCachedFBO={};for(let I=0;I<E.length;++I){const k=Object.values(E[I]);h.renderCachePool.push(...k)}}return}this._clearRasterLayersFromRenderCache();const y=this.proxyCoords,b=this._tilesDirty;for(let E=y.length-1;E>=0;E--){const I=y[E];if(h.getTileByID(I.key),h.proxyCachedFBO[I.key]!==void 0){const k=r[I.key],N=this.proxyToSource[I.key];let H=0;for(const X in N){const ee=N[X],ie=k[X];if(!ie||ie.length!==ee.length||ee.some((ue,pe)=>ue!==ie[pe]||b[X]&&b[X].hasOwnProperty(ue.key))){H=-1;break}++H}for(const X in h.proxyCachedFBO[I.key])h.renderCache[h.proxyCachedFBO[I.key][X]].dirty=H<0||H!==Object.values(k).length}}const T=[...this._drapedRenderBatches];T.sort((E,I)=>I.end-I.start-(E.end-E.start));for(const E of T)for(const I of y){if(h.proxyCachedFBO[I.key])continue;let k=h.renderCachePool.pop();k===void 0&&h.renderCache.length<50&&(k=h.renderCache.length,h.renderCache.push(this._createFBO())),k!==void 0&&(h.proxyCachedFBO[I.key]={},h.proxyCachedFBO[I.key][E.start]=k,h.renderCache[k].dirty=!0)}this._tilesDirty={}}_setupStencil(r,h,y,b){if(!b||!this._sourceTilesOverlap[b.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const T=this.painter.context,E=T.gl;if(h.length<=1)return void(this._overlapStencilType=!1);let I;if(y.isTileClipped())I=h.length,this._overlapStencilMode.test={func:E.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(h[0].overscaledZ>h[h.length-1].overscaledZ))return void(this._overlapStencilType=!1);I=1,this._overlapStencilMode.test={func:E.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+I>255&&(T.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=I,this._overlapStencilMode.ref=this._stencilRef,y.isTileClipped()&&this._renderTileClippingMasks(h,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(r){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[r.key]),this._overlapStencilMode):s.ag.disabled}_renderTileClippingMasks(r,h){const y=this.painter,b=this.painter.context,T=b.gl;y._tileClippingMaskIDs={},b.setColorMode(s.a.disabled),b.setDepthMode(s.ae.disabled);const E=y.getOrCreateProgram("clippingMask");for(const I of r){const k=y._tileClippingMaskIDs[I.key]=--h;E.draw(y,T.TRIANGLES,s.ae.disabled,new s.ag({func:T.ALWAYS,mask:0},k,255,T.KEEP,T.KEEP,T.REPLACE),s.a.disabled,s.af.disabled,rh(I.projMatrix),"$clipping",y.tileExtentBuffer,y.quadTriangleIndexBuffer,y.tileExtentSegments)}}pointCoordinate(r){const h=this.painter.transform;if(r.x<0||r.x>h.width||r.y<0||r.y>h.height)return null;const y=[r.x,r.y,1,1];s.aA.transformMat4(y,y,h.pixelMatrixInverse),s.aA.scale(y,y,1/y[3]),y[0]/=h.worldSize,y[1]/=h.worldSize;const b=h._camera.position,T=s.ax(1,h.center.lat),E=[b[0],b[1],b[2]/T,0],I=s._.subtract([],y.slice(0,3),E);s._.normalize(I,I);const k=this.raycast(E,I,this._exaggeration);return k!==null&&k?(s._.scaleAndAdd(E,E,I,k),E[3]=E[2],E[2]*=T,E):null}_setupProxiedCoordsForOrtho(r,h,y){if(r.getSource()instanceof s.bm)return this._setupProxiedCoordsForImageSource(r,h,y);this._findCoveringTileCache[r.id]=this._findCoveringTileCache[r.id]||{};const b=this.proxiedCoords[r.id]=[],T=this.proxyCoords;for(let k=0;k<T.length;k++){const N=T[k],H=this._findTileCoveringTileID(N,r);if(H){const X=this._createProxiedId(N,H,y[N.key]&&y[N.key][r.id]);b.push(X),this.proxyToSource[N.key][r.id]=[X]}}let E=!1;const I=new Set;for(let k=0;k<h.length;k++){const N=r.getTile(h[k]);if(!N||!N.hasData())continue;const H=this._findTileCoveringTileID(N.tileID,this.proxySourceCache);if(H&&H.tileID.canonical.z!==N.tileID.canonical.z){const X=this.proxyToSource[H.tileID.key][r.id],ee=this._createProxiedId(H.tileID,N,y[H.tileID.key]&&y[H.tileID.key][r.id]);X?X.splice(X.length-1,0,ee):this.proxyToSource[H.tileID.key][r.id]=[ee];const ie=this.proxyToSource[H.tileID.key][r.id];I.has(ie)||I.add(ie),b.push(ee),E=!0}}if(this._sourceTilesOverlap[r.id]=E,E&&this._debugParams.sortTilesHiZFirst)for(const k of I)k.sort((N,H)=>H.overscaledZ-N.overscaledZ)}_setupProxiedCoordsForImageSource(r,h,y){if(!r.getSource().loaded())return;const b=this.proxiedCoords[r.id]=[],T=this.proxyCoords,E=r.getSource(),I=E.tileID;if(!I)return;const k=new s.P(I.x,I.y)._div(1<<I.z),N=E.coordinates.map(s.Y.fromLngLat).reduce((X,ee)=>(X.min.x=Math.min(X.min.x,ee.x-k.x),X.min.y=Math.min(X.min.y,ee.y-k.y),X.max.x=Math.max(X.max.x,ee.x-k.x),X.max.y=Math.max(X.max.y,ee.y-k.y),X),{min:new s.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new s.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),H=(X,ee)=>{const ie=X.wrap+X.canonical.x/(1<<X.canonical.z),ue=X.canonical.y/(1<<X.canonical.z),pe=s.a3/(1<<X.canonical.z),fe=ee.wrap+ee.canonical.x/(1<<ee.canonical.z),_e=ee.canonical.y/(1<<ee.canonical.z);return ie+pe<fe+N.min.x||ie>fe+N.max.x||ue+pe<_e+N.min.y||ue>_e+N.max.y};for(let X=0;X<T.length;X++){const ee=T[X];for(let ie=0;ie<h.length;ie++){const ue=r.getTile(h[ie]);if(!ue||!ue.hasData()||H(ee,ue.tileID))continue;const pe=this._createProxiedId(ee,ue,y[ee.key]&&y[ee.key][r.id]),fe=this.proxyToSource[ee.key][r.id];fe?fe.push(pe):this.proxyToSource[ee.key][r.id]=[pe],b.push(pe)}}}_createProxiedId(r,h,y){let b=this.orthoMatrix;if(y){const T=y.find(E=>E.key===h.tileID.key);if(T)return T}if(h.tileID.key!==r.key){const T=r.canonical.z-h.tileID.canonical.z;let E,I,k;b=s.ad.create();const N=h.tileID.wrap-r.wrap<<r.overscaledZ;T>0?(E=s.a3>>T,I=E*((h.tileID.canonical.x<<T)-r.canonical.x+N),k=E*((h.tileID.canonical.y<<T)-r.canonical.y)):(E=s.a3<<-T,I=s.a3*(h.tileID.canonical.x-(r.canonical.x+N<<-T)),k=s.a3*(h.tileID.canonical.y-(r.canonical.y<<-T))),s.ad.ortho(b,0,E,0,E,0,1),s.ad.translate(b,b,[I,k,0])}return new Vh(h.tileID,r.key,b)}_findTileCoveringTileID(r,h){let y=h.getTile(r);if(y&&y.hasData())return y;const b=this._findCoveringTileCache[h.id],T=b[r.key];if(y=T?h.getTileByID(T):null,y&&y.hasData()||T===null)return y;let E=y?y.tileID:r,I=E.overscaledZ;const k=h.getSource().minzoom,N=[];if(!T){const X=h.getSource().maxzoom;if(r.canonical.z>=X){const ee=r.canonical.z-X;h.getSource().reparseOverscaled?(I=Math.max(r.canonical.z+2,h.transform.tileZoom),E=new s.aL(I,r.wrap,X,r.canonical.x>>ee,r.canonical.y>>ee)):ee!==0&&(I=X,E=new s.aL(I,r.wrap,X,r.canonical.x>>ee,r.canonical.y>>ee))}E.key!==r.key&&(N.push(E.key),y=h.getTile(E))}const H=X=>{N.forEach(ee=>{b[ee]=X}),N.length=0};for(I-=1;I>=k&&(!y||!y.hasData());I--){y&&H(y.tileID.key);const X=E.calculateScaledKey(I);if(y=h.getTileByID(X),y&&y.hasData())break;const ee=b[X];if(ee===null)break;ee===void 0?N.push(X):y=h.getTileByID(ee)}return H(y?y.tileID.key:null),y&&y.hasData()?y:null}findDEMTileFor(r){return this.enabled?this._findTileCoveringTileID(r,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(r,h){let y=this._tilesDirty[r];y||(y=this._tilesDirty[r]={}),y[h.key]=!0}}function ah(m,r,h){const y=function(I,k,N){const H=s._.dot(k,I),X=s._.dot(N,[.2126,.7152,.0722]),ee=(ue,pe,fe)=>(1-fe)*ue+fe*pe,ie=ee(1-.3*Math.min(X,1),1,Math.min(H+1,1));return ee(.92,1,Math.asin(s.at(k[2],-1,1))/Math.PI+.5)*ie}(m,[0,0,1],r),b=[0,0,0];s._.scale(b,h.slice(0,3),y);const T=[0,0,0];s._.scale(T,r.slice(0,3),m[2]);const E=[0,0,0];return s._.add(E,b,T),s.b8(E)}const $s=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],Iu=["stars","fillExtrusion","fillExtrusionGroundEffect","model","symbolSDF","symbolIcon","symbolTextAndIcon"];class tl{static cacheKey(r,h,y,b){let T=`${h}${b?b.cacheKey:""}`;for(const E of y)r.usedDefines.includes(E)&&(T+=`/${E}`);return T}constructor(r,h,y,b,T,E){const I=r.gl;this.program=I.createProgram(),this.configuration=b,this.name=h,this.fixedDefines=[...E];const k=b?b.getBinderAttributes():[],N=(y.staticAttributes||[]).concat(k);let H=b?b.defines():[];H=H.concat(E.map(fe=>`#define ${fe}`));const X=`#version 300 es
`;let ee=X+H.concat("precision mediump float;",Ve,we.fragmentSource).join(`
`);for(const fe of y.fragmentIncludes)ee+=`
${he[fe]}`;ee+=`
${y.fragmentSource}`;let ie=X+H.concat("precision highp float;",Ve,we.vertexSource).join(`
`);for(const fe of y.vertexIncludes)ie+=`
${he[fe]}`;ie+=`
${y.vertexSource}`;const ue=I.createShader(I.FRAGMENT_SHADER);if(I.isContextLost())return void(this.failedToCreate=!0);I.shaderSource(ue,ee),I.compileShader(ue),I.attachShader(this.program,ue);const pe=I.createShader(I.VERTEX_SHADER);if(I.isContextLost())this.failedToCreate=!0;else{I.shaderSource(pe,ie),I.compileShader(pe),I.attachShader(this.program,pe),this.attributes={},this.numAttributes=N.length;for(let fe=0;fe<this.numAttributes;fe++)if(N[fe]){const _e=N[fe].startsWith("a_")?N[fe]:`a_${N[fe]}`;I.bindAttribLocation(this.program,fe,_e),this.attributes[_e]=fe}I.linkProgram(this.program),I.deleteShader(pe),I.deleteShader(ue),this.fixedUniforms=T(r),this.binderUniforms=b?b.getUniforms(r):[],E.includes("TERRAIN")&&(this.terrainUniforms=(fe=>({u_dem:new s.a7(fe),u_dem_prev:new s.a7(fe),u_dem_tl:new s.a8(fe),u_dem_scale:new s.aa(fe),u_dem_tl_prev:new s.a8(fe),u_dem_scale_prev:new s.aa(fe),u_dem_size:new s.aa(fe),u_dem_lerp:new s.aa(fe),u_exaggeration:new s.aa(fe),u_depth:new s.a7(fe),u_depth_size_inv:new s.a8(fe),u_depth_range_unpack:new s.a8(fe),u_meter_to_dem:new s.aa(fe),u_label_plane_matrix_inv:new s.a6(fe)}))(r)),E.includes("GLOBE")&&(this.globeUniforms=(fe=>({u_tile_tl_up:new s.aq(fe),u_tile_tr_up:new s.aq(fe),u_tile_br_up:new s.aq(fe),u_tile_bl_up:new s.aq(fe),u_tile_up_scale:new s.aa(fe)}))(r)),E.includes("FOG")&&(this.fogUniforms=(fe=>({u_fog_matrix:new s.a6(fe),u_fog_range:new s.a8(fe),u_fog_color:new s.as(fe),u_fog_horizon_blend:new s.aa(fe),u_fog_vertical_limit:new s.a8(fe),u_fog_temporal_offset:new s.aa(fe),u_frustum_tl:new s.aq(fe),u_frustum_tr:new s.aq(fe),u_frustum_br:new s.aq(fe),u_frustum_bl:new s.aq(fe),u_globe_pos:new s.aq(fe),u_globe_radius:new s.aa(fe),u_globe_transition:new s.aa(fe),u_is_globe:new s.a7(fe),u_viewport:new s.a8(fe)}))(r)),E.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(fe=>({u_cutoff_params:new s.as(fe)}))(r)),E.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(fe=>({u_lighting_ambient_color:new s.aq(fe),u_lighting_directional_dir:new s.aq(fe),u_lighting_directional_color:new s.aq(fe),u_ground_radiance:new s.aq(fe)}))(r)),E.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(fe=>({u_light_matrix_0:new s.a6(fe),u_light_matrix_1:new s.a6(fe),u_fade_range:new s.a8(fe),u_shadow_normal_offset:new s.aq(fe),u_shadow_intensity:new s.aa(fe),u_shadow_texel_size:new s.aa(fe),u_shadow_map_resolution:new s.aa(fe),u_shadow_direction:new s.aq(fe),u_shadow_bias:new s.aq(fe),u_shadowmap_0:new s.a7(fe),u_shadowmap_1:new s.a7(fe)}))(r))}}setTerrainUniformValues(r,h){if(!this.terrainUniforms)return;const y=this.terrainUniforms;if(!this.failedToCreate){r.program.set(this.program);for(const b in h)y[b]&&y[b].set(this.program,b,h[b])}}setGlobeUniformValues(r,h){if(!this.globeUniforms)return;const y=this.globeUniforms;if(!this.failedToCreate){r.program.set(this.program);for(const b in h)y[b]&&y[b].set(this.program,b,h[b])}}setFogUniformValues(r,h){if(!this.fogUniforms)return;const y=this.fogUniforms;if(!this.failedToCreate){r.program.set(this.program);for(const b in h)y[b].set(this.program,b,h[b])}}setCutoffUniformValues(r,h){if(!this.cutoffUniforms)return;const y=this.cutoffUniforms;if(!this.failedToCreate){r.program.set(this.program);for(const b in h)y[b].set(this.program,b,h[b])}}setLightsUniformValues(r,h){if(!this.lightsUniforms)return;const y=this.lightsUniforms;if(!this.failedToCreate){r.program.set(this.program);for(const b in h)y[b].set(this.program,b,h[b])}}setShadowUniformValues(r,h){if(this.failedToCreate||!this.shadowUniforms)return;const y=this.shadowUniforms;r.program.set(this.program);for(const b in h)y[b].set(this.program,b,h[b])}_drawDebugWireframe(r,h,y,b,T,E,I,k,N,H){const X=r.options.wireframe;if(X.terrain===!1&&X.layers2D===!1&&X.layers3D===!1)return;const ee=r.context;if(!(!(!X.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!X.layers2D||r._terrain&&r._terrain.renderingToTexture||!$s.includes(this.name))||!(!X.layers3D||!Iu.includes(this.name))))return;const ie=ee.gl,ue=r.wireframeDebugCache.getLinesFromTrianglesBuffer(r.frameCounter,T,ee);if(!ue)return;const pe=[...this.fixedDefines];pe.push("DEBUG_WIREFRAME");const fe=r.getOrCreateProgram(this.name,{config:this.configuration,defines:pe});ee.program.set(fe.program);const _e=(Be,$e,Ze)=>{if($e[Be]&&Ze[Be])for(const rt in $e[Be])Ze[Be][rt]&&Ze[Be][rt].set(Ze.program,rt,$e[Be][rt].current)};N&&N.setUniforms(fe.program,ee,fe.binderUniforms,I,{zoom:k}),_e("fixedUniforms",this,fe),_e("terrainUniforms",this,fe),_e("globeUniforms",this,fe),_e("fogUniforms",this,fe),_e("lightsUniforms",this,fe),_e("shadowUniforms",this,fe),ue.bind(),ee.setColorMode(new s.a([ie.ONE,ie.ONE_MINUS_SRC_ALPHA,ie.ZERO,ie.ONE],s.C.transparent,[!0,!0,!0,!1])),ee.setDepthMode(new s.ae(h.func===ie.LESS?ie.LEQUAL:h.func,s.ae.ReadOnly,h.range)),ee.setStencilMode(s.ag.disabled);const Le=3*E.primitiveLength*2,Fe=3*E.primitiveOffset*2*2;H&&H>1?ie.drawElementsInstanced(ie.LINES,Le,ie.UNSIGNED_SHORT,Fe,H):ie.drawElements(ie.LINES,Le,ie.UNSIGNED_SHORT,Fe),T.bind(),ee.program.set(this.program),ee.setDepthMode(h),ee.setStencilMode(y),ee.setColorMode(b)}draw(r,h,y,b,T,E,I,k,N,H,X,ee,ie,ue,pe,fe){const _e=r.context,Le=_e.gl;if(this.failedToCreate)return;_e.program.set(this.program),_e.setDepthMode(y),_e.setStencilMode(b),_e.setColorMode(T),_e.setCullFace(E);for(const $e of Object.keys(this.fixedUniforms))this.fixedUniforms[$e].set(this.program,$e,I[$e]);ue&&ue.setUniforms(this.program,_e,this.binderUniforms,ee,{zoom:ie});const Fe={[Le.POINTS]:1,[Le.LINES]:2,[Le.TRIANGLES]:3,[Le.LINE_STRIP]:1}[h],Be=fe&&fe>0?1:void 0;for(const $e of X.get()){const Ze=$e.vaos||($e.vaos={});(Ze[k]||(Ze[k]=new Di)).bind(_e,this,N,ue?ue.getPaintVertexBuffers():[],H,$e.vertexOffset,pe||[],Be),fe&&fe>1?Le.drawElementsInstanced(h,$e.primitiveLength*Fe,Le.UNSIGNED_SHORT,$e.primitiveOffset*Fe*2,fe):H?Le.drawElements(h,$e.primitiveLength*Fe,Le.UNSIGNED_SHORT,$e.primitiveOffset*Fe*2):Le.drawArrays(h,$e.vertexOffset,$e.vertexLength),h===Le.TRIANGLES&&H&&this._drawDebugWireframe(r,y,b,T,H,$e,ee,ie,ue,fe)}}}function Ql(m,r){const h=Math.pow(2,r.tileID.overscaledZ),y=r.tileSize*Math.pow(2,m.transform.tileZoom)/h,b=y*(r.tileID.canonical.x+r.tileID.wrap*h),T=y*r.tileID.canonical.y;return{u_image:0,u_texsize:r.imageAtlasTexture?r.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/s.bB(r,1,m.transform.tileZoom),u_pixel_coord_upper:[b>>16,T>>16],u_pixel_coord_lower:[65535&b,65535&T]}}const go=s.ad.create(),Cl=(m,r,h,y,b,T,E,I,k,N,H,X,ee,ie,ue,pe)=>{const fe=r.style.light,_e=fe.properties.get("position"),Le=[_e.x,_e.y,_e.z],Fe=s.bC.create();fe.properties.get("anchor")==="viewport"&&(s.bC.fromRotation(Fe,-r.transform.angle),s._.transformMat3(Le,Le,Fe));const Be=fe.properties.get("color"),$e=r.transform,Ze={u_matrix:m,u_lightpos:Le,u_lightintensity:fe.properties.get("intensity"),u_lightcolor:[Be.r,Be.g,Be.b],u_vertical_gradient:+h,u_opacity:y,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:go,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_ao:b,u_edge_radius:T,u_flood_light_color:X,u_vertical_scale:ee,u_flood_light_intensity:ie,u_ground_shadow_factor:ue,u_emissive_strength:pe};return $e.projection.name==="globe"&&(Ze.u_tile_id=[E.canonical.x,E.canonical.y,1<<E.canonical.z],Ze.u_zoom_transition=k,Ze.u_inv_rot_matrix=H,Ze.u_merc_center=N,Ze.u_up_dir=$e.projection.upVector(new s.aO(0,0,0),N[0]*s.a3,N[1]*s.a3),Ze.u_height_lift=I),Ze},Tc=(m,r,h)=>({u_matrix:m,u_edge_radius:r,u_vertical_scale:h}),il=(m,r,h,y,b,T,E,I,k,N,H,X,ee,ie)=>{const ue=Cl(m,r,h,y,b,T,E,k,N,H,X,ee,ie,1,[0,0,0],0),pe={u_height_factor:-Math.pow(2,E.overscaledZ)/I.tileSize/8};return s.W(ue,Ql(r,I),pe)},lh=(m,r)=>({u_matrix:m,u_emissive_strength:r}),Pu=(m,r,h,y)=>s.W(lh(m,r),Ql(h,y)),Hf=(m,r,h)=>({u_matrix:m,u_world:h,u_emissive_strength:r}),jf=(m,r,h,y,b)=>s.W(Pu(m,r,h,y),{u_world:b}),Ma=(m,r,h,y)=>{const b=s.a3/h.tileSize;return{u_matrix:m,u_camera_to_center_distance:r.getCameraToCenterDistance(y),u_extrude_scale:[r.pixelsToGLUnits[0]/b,r.pixelsToGLUnits[1]/b]}},ec=(m,r,h=1)=>({u_matrix:m,u_color:r.toRenderColor(null),u_overlay:0,u_overlay_scale:h}),Gh=s.ad.create(),tc=(m,r,h,y,b,T,E)=>{const I=m.transform,k=I.projection.name==="globe",N=k?s.bD(I.zoom,r.canonical)*I._pixelsPerMercatorPixel:s.bB(h,1,T),H={u_matrix:r.projMatrix,u_extrude_scale:N,u_intensity:E,u_inv_rot_matrix:Gh,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(k){H.u_inv_rot_matrix=y,H.u_merc_center=b,H.u_tile_id=[r.canonical.x,r.canonical.y,1<<r.canonical.z],H.u_zoom_transition=s.a1(I.zoom);const X=b[0]*s.a3,ee=b[1]*s.a3;H.u_up_dir=I.projection.upVector(new s.aO(0,0,0),X,ee)}return H};function ic(m,[r,h,y,b],[T,E]){if(T===E)return[0,0,0,0];const I=255*(m-1)/(m*(E-T));return[r*I,h*I,y*I,b*I]}function Wf(m,r,[h,y]){return h===y?0:.5/m+(r-h)*(m-1)/(m*(y-h))}const nc=(m,r,h,y,b,T,E,I,k,N,H,X,ee,ie,ue,pe,fe,_e,Le,Fe,Be)=>({u_matrix:m,u_normalize_matrix:r,u_globe_matrix:h,u_merc_matrix:y,u_grid_matrix:b,u_tl_parent:T,u_scale_parent:N,u_fade_t:H.mix,u_opacity:H.opacity*X.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:X.paint.get("raster-brightness-min"),u_brightness_high:X.paint.get("raster-brightness-max"),u_saturation_factor:s.bE(X.paint.get("raster-saturation")),u_contrast_factor:s.bF(X.paint.get("raster-contrast")),u_spin_weights:es(X.paint.get("raster-hue-rotate")),u_perspective_transform:ee,u_raster_elevation:ie,u_zoom_transition:E,u_merc_center:I,u_cutoff_params:k,u_colorization_mix:ic(s.bG,pe,_e),u_colorization_offset:Wf(s.bG,fe,_e),u_color_ramp:ue,u_texture_offset:[Fe/(Le+2*Fe),Le/(Le+2*Fe)],u_texture_res:[Le+2*Fe,Le+2*Fe],u_emissive_strength:Be});function es(m){m*=Math.PI/180;const r=Math.sin(m),h=Math.cos(m);return[(2*h+1)/3,(-Math.sqrt(3)*r-h+1)/3,(Math.sqrt(3)*r-h+1)/3]}const On=.05,Ta=(m,r,h,y,b,T,E,I,k,N,H,X)=>({u_matrix:m,u_normalize_matrix:r,u_globe_matrix:h,u_merc_matrix:y,u_grid_matrix:b,u_tl_parent:T,u_scale_parent:N,u_fade_t:H.mix,u_opacity:H.opacity,u_image0:0,u_image1:1,u_raster_elevation:X,u_zoom_transition:E,u_merc_center:I,u_cutoff_params:k}),wp=(m,r,h,y,b,T,E,I,k,N)=>({u_particle_texture:m,u_particle_texture_side_len:r,u_tile_offset:h,u_velocity:y,u_color_ramp:T,u_velocity_res:b,u_max_speed:E,u_uv_offset:I,u_data_scale:[255*k[0],255*k[1]],u_data_offset:N,u_particle_pos_scale:1.1,u_particle_pos_offset:[On,On]}),Mp=(m,r,h,y,b,T,E,I,k,N)=>({u_particle_texture:m,u_particle_texture_side_len:r,u_velocity:h,u_velocity_res:y,u_max_speed:b,u_speed_factor:T,u_reset_rate:E,u_rand_seed:Math.random(),u_uv_offset:I,u_data_scale:[255*k[0],255*k[1]],u_data_offset:N,u_particle_pos_scale:1.1,u_particle_pos_offset:[On,On]}),qf=s.ad.create(),nl=(m,r,h,y,b,T,E,I,k,N,H,X,ee,ie,ue,pe,fe,_e)=>{const Le=b.transform,Fe={u_is_size_zoom_constant:+(m==="constant"||m==="source"),u_is_size_feature_constant:+(m==="constant"||m==="camera"),u_size_t:r?r.uSizeT:0,u_size:r?r.uSize:0,u_camera_to_center_distance:Le.getCameraToCenterDistance(pe),u_rotate_symbol:+h,u_aspect_ratio:Le.width/Le.height,u_fade_change:b.options.fadeDuration?b.symbolFadeChange:1,u_matrix:T,u_label_plane_matrix:E,u_coord_matrix:I,u_is_text:+k,u_pitch_with_map:+y,u_texsize:N,u_texture:0,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:qf,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:qf,u_up_vector:[0,-1,0],u_color_adj_mat:fe,u_icon_transition:_e||0};return pe.name==="globe"&&(Fe.u_tile_id=[H.canonical.x,H.canonical.y,1<<H.canonical.z],Fe.u_zoom_transition=X,Fe.u_inv_rot_matrix=ie,Fe.u_merc_center=ee,Fe.u_camera_forward=Le._camera.forward(),Fe.u_ecef_origin=s.bH(Le.globeMatrix,H.toUnwrapped()),Fe.u_tile_matrix=Float32Array.from(Le.globeMatrix),Fe.u_up_vector=ue),Fe},ch=(m,r,h,y,b,T,E,I,k,N,H,X,ee,ie,ue,pe,fe)=>s.W(nl(m,r,h,y,b,T,E,I,k,N,X,ee,ie,ue,pe,fe),{u_gamma_scale:y?b.transform.getCameraToCenterDistance(fe)*Math.cos(b.terrain?0:b.transform._pitch):1,u_device_pixel_ratio:s.e.devicePixelRatio,u_is_halo:+H,undefined:void 0}),Zf=(m,r,h,y,b,T,E,I,k,N,H,X,ee,ie,ue,pe)=>s.W(ch(m,r,h,y,b,T,E,I,!0,k,!0,H,X,ee,ie,ue,pe),{u_texsize_icon:N,u_texture_icon:1}),Hh=(m,r,h,y)=>({u_matrix:m,u_emissive_strength:r,u_opacity:h,u_color:y}),Ll=(m,r,h,y,b,T,E,I)=>s.W(function(k,N,H,X,ee){const{width:ie,height:ue}=X.imageManager.getPixelSize(N),pe=Math.pow(2,ee.tileID.overscaledZ),fe=ee.tileSize*Math.pow(2,X.transform.tileZoom)/pe,_e=fe*(ee.tileID.canonical.x+ee.tileID.wrap*pe),Le=fe*ee.tileID.canonical.y;return{u_image:0,u_pattern_tl:H.tl,u_pattern_br:H.br,u_texsize:[ie,ue],u_pattern_size:H.displaySize,u_tile_units_to_pixels:1/s.bB(ee,1,X.transform.tileZoom),u_pixel_coord_upper:[_e>>16,Le>>16],u_pixel_coord_lower:[65535&_e,65535&Le]}}(0,T,E,y,I),{u_matrix:m,u_emissive_strength:r,u_opacity:h}),Sa=new Float32Array(s.ad.identity([])),Sd=(m,r,h,y,b,T,E,I,k,N,H,X,ee,ie=[0,0,0],ue)=>{const pe=b.style.light,fe=pe.properties.get("position"),_e=[-fe.x,-fe.y,fe.z],Le=s.bC.create();pe.properties.get("anchor")==="viewport"&&(s.bC.fromRotation(Le,-b.transform.angle),s._.transformMat3(_e,_e,Le));const Fe=H.alphaMode==="MASK",Be=pe.properties.get("color").toRenderColor(null),$e=ee.paint.get("model-ambient-occlusion-intensity"),Ze=ee.paint.get("model-color").constantOr(s.C.white).toRenderColor(null),rt=ee.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:m,u_lighting_matrix:r,u_normal_matrix:h,u_node_matrix:y||Sa,u_lightpos:_e,u_lightintensity:pe.properties.get("intensity"),u_lightcolor:[Be.r,Be.g,Be.b],u_camera_pos:ie,u_opacity:T,u_baseTextureIsAlpha:0,u_alphaMask:+Fe,u_alphaCutoff:H.alphaCutoff,u_baseColorFactor:[E.r,E.g,E.b,E.a],u_emissiveFactor:[I[0],I[1],I[2],1],u_metallicFactor:k,u_roughnessFactor:N,u_baseColorTexture:gs.BaseColor,u_metallicRoughnessTexture:gs.MetallicRoughness,u_normalTexture:gs.Normal,u_occlusionTexture:gs.Occlusion,u_emissionTexture:gs.Emission,u_lutTexture:gs.LUT,u_color_mix:[Ze.r,Ze.g,Ze.b,rt],u_aoIntensity:$e,u_emissive_strength:X,u_occlusionTextureTransform:ue||[0,0,0,0]}},Ru=(m,r=Sa,h=Sa)=>({u_matrix:m,u_instance:r,u_node_matrix:h}),Ed=(m,r,h,y,b)=>({u_matrix:Float32Array.from(m),u_anchorPos:r,u_screenSizePx:h,u_occluderSizePx:y,u_color:b}),rl={fillExtrusion:m=>({u_matrix:new s.a6(m),u_lightpos:new s.aq(m),u_lightintensity:new s.aa(m),u_lightcolor:new s.aq(m),u_vertical_gradient:new s.aa(m),u_opacity:new s.aa(m),u_edge_radius:new s.aa(m),u_ao:new s.a8(m),u_tile_id:new s.aq(m),u_zoom_transition:new s.aa(m),u_inv_rot_matrix:new s.a6(m),u_merc_center:new s.a8(m),u_up_dir:new s.aq(m),u_height_lift:new s.aa(m),u_flood_light_color:new s.aq(m),u_vertical_scale:new s.aa(m),u_flood_light_intensity:new s.aa(m),u_ground_shadow_factor:new s.aq(m),u_emissive_strength:new s.aa(m)}),fillExtrusionDepth:m=>({u_matrix:new s.a6(m),u_edge_radius:new s.aa(m),u_vertical_scale:new s.aa(m)}),fillExtrusionPattern:m=>({u_matrix:new s.a6(m),u_lightpos:new s.aq(m),u_lightintensity:new s.aa(m),u_lightcolor:new s.aq(m),u_vertical_gradient:new s.aa(m),u_height_factor:new s.aa(m),u_edge_radius:new s.aa(m),u_ao:new s.a8(m),u_tile_id:new s.aq(m),u_zoom_transition:new s.aa(m),u_inv_rot_matrix:new s.a6(m),u_merc_center:new s.a8(m),u_up_dir:new s.aq(m),u_height_lift:new s.aa(m),u_image:new s.a7(m),u_texsize:new s.a8(m),u_pixel_coord_upper:new s.a8(m),u_pixel_coord_lower:new s.a8(m),u_tile_units_to_pixels:new s.aa(m),u_opacity:new s.aa(m)}),fillExtrusionGroundEffect:m=>({u_matrix:new s.a6(m),u_opacity:new s.aa(m),u_ao_pass:new s.aa(m),u_meter_to_tile:new s.aa(m),u_ao:new s.a8(m),u_flood_light_intensity:new s.aa(m),u_flood_light_color:new s.aq(m),u_attenuation:new s.aa(m),u_edge_radius:new s.aa(m),u_fb:new s.a7(m),u_fb_size:new s.aa(m)}),fill:m=>({u_matrix:new s.a6(m),u_emissive_strength:new s.aa(m)}),fillPattern:m=>({u_matrix:new s.a6(m),u_emissive_strength:new s.aa(m),u_image:new s.a7(m),u_texsize:new s.a8(m),u_pixel_coord_upper:new s.a8(m),u_pixel_coord_lower:new s.a8(m),u_tile_units_to_pixels:new s.aa(m)}),fillOutline:m=>({u_matrix:new s.a6(m),u_emissive_strength:new s.aa(m),u_world:new s.a8(m)}),fillOutlinePattern:m=>({u_matrix:new s.a6(m),u_emissive_strength:new s.aa(m),u_world:new s.a8(m),u_image:new s.a7(m),u_texsize:new s.a8(m),u_pixel_coord_upper:new s.a8(m),u_pixel_coord_lower:new s.a8(m),u_tile_units_to_pixels:new s.aa(m)}),circle:s.bI,collisionBox:m=>({u_matrix:new s.a6(m),u_camera_to_center_distance:new s.aa(m),u_extrude_scale:new s.a8(m)}),collisionCircle:m=>({u_matrix:new s.a6(m),u_inv_matrix:new s.a6(m),u_camera_to_center_distance:new s.aa(m),u_viewport_size:new s.a8(m)}),debug:m=>({u_color:new s.a9(m),u_matrix:new s.a6(m),u_overlay:new s.a7(m),u_overlay_scale:new s.aa(m)}),clippingMask:m=>({u_matrix:new s.a6(m)}),heatmap:m=>({u_extrude_scale:new s.aa(m),u_intensity:new s.aa(m),u_matrix:new s.a6(m),u_inv_rot_matrix:new s.a6(m),u_merc_center:new s.a8(m),u_tile_id:new s.aq(m),u_zoom_transition:new s.aa(m),u_up_dir:new s.aq(m)}),heatmapTexture:m=>({u_image:new s.a7(m),u_color_ramp:new s.a7(m),u_opacity:new s.aa(m)}),hillshade:m=>({u_matrix:new s.a6(m),u_image:new s.a7(m),u_latrange:new s.a8(m),u_light:new s.a8(m),u_shadow:new s.a9(m),u_highlight:new s.a9(m),u_emissive_strength:new s.aa(m),u_accent:new s.a9(m)}),hillshadePrepare:m=>({u_matrix:new s.a6(m),u_image:new s.a7(m),u_dimension:new s.a8(m),u_zoom:new s.aa(m)}),line:s.bJ,linePattern:s.bK,raster:m=>({u_matrix:new s.a6(m),u_normalize_matrix:new s.a6(m),u_globe_matrix:new s.a6(m),u_merc_matrix:new s.a6(m),u_grid_matrix:new s.ar(m),u_tl_parent:new s.a8(m),u_scale_parent:new s.aa(m),u_fade_t:new s.aa(m),u_opacity:new s.aa(m),u_image0:new s.a7(m),u_image1:new s.a7(m),u_brightness_low:new s.aa(m),u_brightness_high:new s.aa(m),u_saturation_factor:new s.aa(m),u_contrast_factor:new s.aa(m),u_spin_weights:new s.aq(m),u_perspective_transform:new s.a8(m),u_raster_elevation:new s.aa(m),u_zoom_transition:new s.aa(m),u_merc_center:new s.a8(m),u_cutoff_params:new s.as(m),u_colorization_mix:new s.as(m),u_colorization_offset:new s.aa(m),u_color_ramp:new s.a7(m),u_texture_offset:new s.a8(m),u_texture_res:new s.a8(m),u_emissive_strength:new s.aa(m)}),rasterParticle:m=>({u_matrix:new s.a6(m),u_normalize_matrix:new s.a6(m),u_globe_matrix:new s.a6(m),u_merc_matrix:new s.a6(m),u_grid_matrix:new s.ar(m),u_tl_parent:new s.a8(m),u_scale_parent:new s.aa(m),u_fade_t:new s.aa(m),u_opacity:new s.aa(m),u_image0:new s.a7(m),u_image1:new s.a7(m),u_raster_elevation:new s.aa(m),u_zoom_transition:new s.aa(m),u_merc_center:new s.a8(m),u_cutoff_params:new s.as(m)}),rasterParticleTexture:m=>({u_texture:new s.a7(m),u_opacity:new s.aa(m)}),rasterParticleDraw:m=>({u_particle_texture:new s.a7(m),u_particle_texture_side_len:new s.aa(m),u_tile_offset:new s.a8(m),u_velocity:new s.a7(m),u_color_ramp:new s.a7(m),u_velocity_res:new s.a8(m),u_max_speed:new s.aa(m),u_uv_offset:new s.a8(m),u_data_scale:new s.a8(m),u_data_offset:new s.aa(m),u_particle_pos_scale:new s.aa(m),u_particle_pos_offset:new s.a8(m)}),rasterParticleUpdate:m=>({u_particle_texture:new s.a7(m),u_particle_texture_side_len:new s.aa(m),u_velocity:new s.a7(m),u_velocity_res:new s.a8(m),u_max_speed:new s.aa(m),u_speed_factor:new s.aa(m),u_reset_rate:new s.aa(m),u_rand_seed:new s.aa(m),u_uv_offset:new s.a8(m),u_data_scale:new s.a8(m),u_data_offset:new s.aa(m),u_particle_pos_scale:new s.aa(m),u_particle_pos_offset:new s.a8(m)}),symbolIcon:m=>({u_is_size_zoom_constant:new s.a7(m),u_is_size_feature_constant:new s.a7(m),u_size_t:new s.aa(m),u_size:new s.aa(m),u_camera_to_center_distance:new s.aa(m),u_rotate_symbol:new s.a7(m),u_aspect_ratio:new s.aa(m),u_fade_change:new s.aa(m),u_matrix:new s.a6(m),u_label_plane_matrix:new s.a6(m),u_coord_matrix:new s.a6(m),u_is_text:new s.a7(m),u_pitch_with_map:new s.a7(m),u_texsize:new s.a8(m),u_tile_id:new s.aq(m),u_zoom_transition:new s.aa(m),u_inv_rot_matrix:new s.a6(m),u_merc_center:new s.a8(m),u_camera_forward:new s.aq(m),u_tile_matrix:new s.a6(m),u_up_vector:new s.aq(m),u_ecef_origin:new s.aq(m),u_texture:new s.a7(m),u_icon_transition:new s.aa(m),u_color_adj_mat:new s.a6(m)}),symbolSDF:m=>({u_is_size_zoom_constant:new s.a7(m),u_is_size_feature_constant:new s.a7(m),u_size_t:new s.aa(m),u_size:new s.aa(m),u_camera_to_center_distance:new s.aa(m),u_rotate_symbol:new s.a7(m),u_aspect_ratio:new s.aa(m),u_fade_change:new s.aa(m),u_matrix:new s.a6(m),u_label_plane_matrix:new s.a6(m),u_coord_matrix:new s.a6(m),u_is_text:new s.a7(m),u_pitch_with_map:new s.a7(m),u_texsize:new s.a8(m),u_texture:new s.a7(m),u_gamma_scale:new s.aa(m),u_device_pixel_ratio:new s.aa(m),u_tile_id:new s.aq(m),u_zoom_transition:new s.aa(m),u_inv_rot_matrix:new s.a6(m),u_merc_center:new s.a8(m),u_camera_forward:new s.aq(m),u_tile_matrix:new s.a6(m),u_up_vector:new s.aq(m),u_ecef_origin:new s.aq(m),u_is_halo:new s.a7(m)}),symbolTextAndIcon:m=>({u_is_size_zoom_constant:new s.a7(m),u_is_size_feature_constant:new s.a7(m),u_size_t:new s.aa(m),u_size:new s.aa(m),u_camera_to_center_distance:new s.aa(m),u_rotate_symbol:new s.a7(m),u_aspect_ratio:new s.aa(m),u_fade_change:new s.aa(m),u_matrix:new s.a6(m),u_label_plane_matrix:new s.a6(m),u_coord_matrix:new s.a6(m),u_is_text:new s.a7(m),u_pitch_with_map:new s.a7(m),u_texsize:new s.a8(m),u_texsize_icon:new s.a8(m),u_texture:new s.a7(m),u_texture_icon:new s.a7(m),u_gamma_scale:new s.aa(m),u_device_pixel_ratio:new s.aa(m),u_is_halo:new s.a7(m)}),background:m=>({u_matrix:new s.a6(m),u_emissive_strength:new s.aa(m),u_opacity:new s.aa(m),u_color:new s.a9(m)}),backgroundPattern:m=>({u_matrix:new s.a6(m),u_emissive_strength:new s.aa(m),u_opacity:new s.aa(m),u_image:new s.a7(m),u_pattern_tl:new s.a8(m),u_pattern_br:new s.a8(m),u_texsize:new s.a8(m),u_pattern_size:new s.a8(m),u_pixel_coord_upper:new s.a8(m),u_pixel_coord_lower:new s.a8(m),u_tile_units_to_pixels:new s.aa(m)}),terrainRaster:m=>({u_matrix:new s.a6(m),u_image0:new s.a7(m),u_skirt_height:new s.aa(m),u_ground_shadow_factor:new s.aq(m)}),skybox:m=>({u_matrix:new s.a6(m),u_sun_direction:new s.aq(m),u_cubemap:new s.a7(m),u_opacity:new s.aa(m),u_temporal_offset:new s.aa(m)}),skyboxGradient:m=>({u_matrix:new s.a6(m),u_color_ramp:new s.a7(m),u_center_direction:new s.aq(m),u_radius:new s.aa(m),u_opacity:new s.aa(m),u_temporal_offset:new s.aa(m)}),skyboxCapture:m=>({u_matrix_3f:new s.ar(m),u_sun_direction:new s.aq(m),u_sun_intensity:new s.aa(m),u_color_tint_r:new s.as(m),u_color_tint_m:new s.as(m),u_luminance:new s.aa(m)}),globeRaster:m=>({u_proj_matrix:new s.a6(m),u_globe_matrix:new s.a6(m),u_normalize_matrix:new s.a6(m),u_merc_matrix:new s.a6(m),u_zoom_transition:new s.aa(m),u_merc_center:new s.a8(m),u_image0:new s.a7(m),u_grid_matrix:new s.ar(m),u_skirt_height:new s.aa(m),u_far_z_cutoff:new s.aa(m),u_frustum_tl:new s.aq(m),u_frustum_tr:new s.aq(m),u_frustum_br:new s.aq(m),u_frustum_bl:new s.aq(m),u_globe_pos:new s.aq(m),u_globe_radius:new s.aa(m),u_viewport:new s.a8(m)}),globeAtmosphere:m=>({u_frustum_tl:new s.aq(m),u_frustum_tr:new s.aq(m),u_frustum_br:new s.aq(m),u_frustum_bl:new s.aq(m),u_horizon:new s.aa(m),u_transition:new s.aa(m),u_fadeout_range:new s.aa(m),u_color:new s.as(m),u_high_color:new s.as(m),u_space_color:new s.as(m),u_temporal_offset:new s.aa(m),u_horizon_angle:new s.aa(m)}),model:m=>({u_matrix:new s.a6(m),u_lighting_matrix:new s.a6(m),u_normal_matrix:new s.a6(m),u_node_matrix:new s.a6(m),u_lightpos:new s.aq(m),u_lightintensity:new s.aa(m),u_lightcolor:new s.aq(m),u_camera_pos:new s.aq(m),u_opacity:new s.aa(m),u_baseColorFactor:new s.as(m),u_emissiveFactor:new s.as(m),u_metallicFactor:new s.aa(m),u_roughnessFactor:new s.aa(m),u_baseTextureIsAlpha:new s.a7(m),u_alphaMask:new s.a7(m),u_alphaCutoff:new s.aa(m),u_baseColorTexture:new s.a7(m),u_metallicRoughnessTexture:new s.a7(m),u_normalTexture:new s.a7(m),u_occlusionTexture:new s.a7(m),u_emissionTexture:new s.a7(m),u_lutTexture:new s.a7(m),u_color_mix:new s.as(m),u_aoIntensity:new s.aa(m),u_emissive_strength:new s.aa(m),u_occlusionTextureTransform:new s.as(m)}),modelDepth:m=>({u_matrix:new s.a6(m),u_instance:new s.a6(m),u_node_matrix:new s.a6(m)}),groundShadow:m=>({u_matrix:new s.a6(m),u_ground_shadow_factor:new s.aq(m)}),stars:m=>({u_matrix:new s.a6(m),u_up:new s.aq(m),u_right:new s.aq(m),u_intensity_multiplier:new s.aa(m)}),occlusion:m=>({u_matrix:new s.a6(m),u_anchorPos:new s.aq(m),u_screenSizePx:new s.a8(m),u_occluderSizePx:new s.a8(m),u_color:new s.as(m)})};function Du(m,r,h){const y=r.createTileMatrix(m,m.worldSize,h.toUnwrapped());return s.ad.multiply(new Float32Array(16),m.projMatrix,y)}function jh(m,r,h){if(r.projection.name===h.projection.name)return m.projMatrix;const y=h.clone();return y.setProjection(r.projection),Du(y,r.getProjection(),m)}function zu(m,r,h){return r.name===h.projection.name?m.projMatrix:Du(h,r,m)}let rc;function Tp(m,r,h,y,b,T,E){const I=m.context,k=I.gl,N=m.transform,H=m.getOrCreateProgram("collisionBox"),X=[];let ee=0,ie=0;for(let Be=0;Be<y.length;Be++){const $e=y[Be],Ze=r.getTile($e),rt=Ze.getBucket(h);if(!rt)continue;const xe=jh($e,rt,N);let Ne=xe;b[0]===0&&b[1]===0||(Ne=m.translatePosMatrix(xe,Ze,b,T));const ct=E?rt.textCollisionBox:rt.iconCollisionBox,Ot=rt.collisionCircleArray;if(Ot.length>0){const mt=s.ad.create(),it=Ne;s.ad.mul(mt,rt.placementInvProjMatrix,N.glCoordMatrix),s.ad.mul(mt,mt,rt.placementViewportMatrix),X.push({circleArray:Ot,circleOffset:ie,transform:it,invTransform:mt,projection:rt.getProjection()}),ee+=Ot.length/4,ie=ee}ct&&(m.terrain&&m.terrain.setupElevationDraw(Ze,H),H.draw(m,k.LINES,s.ae.disabled,s.ag.disabled,m.colorModeForRenderPass(),s.af.disabled,Ma(Ne,N,Ze,rt.getProjection()),h.id,ct.layoutVertexBuffer,ct.indexBuffer,ct.segments,null,N.zoom,null,[ct.collisionVertexBuffer,ct.collisionVertexBufferExt]))}if(!E||!X.length)return;const ue=m.getOrCreateProgram("collisionCircle"),pe=new s.bL;pe.resize(4*ee),pe._trim();let fe=0;for(const Be of X)for(let $e=0;$e<Be.circleArray.length/4;$e++){const Ze=4*$e,rt=Be.circleArray[Ze+0],xe=Be.circleArray[Ze+1],Ne=Be.circleArray[Ze+2],ct=Be.circleArray[Ze+3];pe.emplace(fe++,rt,xe,Ne,ct,0),pe.emplace(fe++,rt,xe,Ne,ct,1),pe.emplace(fe++,rt,xe,Ne,ct,2),pe.emplace(fe++,rt,xe,Ne,ct,3)}(!rc||rc.length<2*ee)&&(rc=function(Be){const $e=2*Be,Ze=new s.bu;Ze.resize($e),Ze._trim();for(let rt=0;rt<$e;rt++){const xe=6*rt;Ze.uint16[xe+0]=4*rt+0,Ze.uint16[xe+1]=4*rt+1,Ze.uint16[xe+2]=4*rt+2,Ze.uint16[xe+3]=4*rt+2,Ze.uint16[xe+4]=4*rt+3,Ze.uint16[xe+5]=4*rt+0}return Ze}(ee));const _e=I.createIndexBuffer(rc,!0),Le=I.createVertexBuffer(pe,s.bM.members,!0);for(const Be of X){const $e={u_matrix:Be.transform,u_inv_matrix:Be.invTransform,u_camera_to_center_distance:(Fe=N).getCameraToCenterDistance(Be.projection),u_viewport_size:[Fe.width,Fe.height]};ue.draw(m,k.TRIANGLES,s.ae.disabled,s.ag.disabled,m.colorModeForRenderPass(),s.af.disabled,$e,h.id,Le,_e,s.b.simpleSegment(0,2*Be.circleOffset,Be.circleArray.length,Be.circleArray.length/2),null,N.zoom)}var Fe;Le.destroy(),_e.destroy()}const sc=s.ad.create();function sl(m){const r=m._camera.getWorldToCamera(m.worldSize,1),h=s.ad.multiply([],r,m.globeMatrix);s.ad.invert(h,h);const y=[0,0,0],b=[0,1,0,0];return s.aA.transformMat4(b,b,h),y[0]=b[0],y[1]=b[1],y[2]=b[2],s._.normalize(y,y),y}function Wh({width:m,height:r,anchor:h,textOffset:y,textScale:b},T){const{horizontalAlign:E,verticalAlign:I}=s.bQ(h),k=-(E-.5)*m,N=-(I-.5)*r,H=s.bP(h,y);return new s.P((k/b+H[0])*T,(N/b+H[1])*T)}function Xf(m,r,h,y,b,T,E,I,k,N,H){const X=m.text.placedSymbolArray,ee=m.text.dynamicLayoutVertexArray,ie=m.icon.dynamicLayoutVertexArray,ue={},pe=m.getProjection(),fe=zu(I,pe,T),_e=T.elevation,Le=pe.upVectorScale(I.canonical,T.center.lat,T.worldSize).metersToTile;ee.clear();for(let Fe=0;Fe<X.length;Fe++){const Be=X.get(Fe),{tileAnchorX:$e,tileAnchorY:Ze,numGlyphs:rt}=Be,xe=Be.hidden||!Be.crossTileID||m.allowVerticalPlacement&&!Be.placedOrientation?null:y[Be.crossTileID];if(xe){let Ne=0,ct=0,Ot=0;if(_e){const ri=_e?_e.getAtTileOffset(I,$e,Ze):0,[$i,Yi,hn]=pe.upVector(I.canonical,$e,Ze);Ne=ri*$i*Le,ct=ri*Yi*Le,Ot=ri*hn*Le}let[mt,it,Nt,mi]=Ds(Be.projectedAnchorX+Ne,Be.projectedAnchorY+ct,Be.projectedAnchorZ+Ot,h?fe:E);const _i=ua(T.getCameraToCenterDistance(pe),mi);let hi=b.evaluateSizeForFeature(m.textSizeData,N,Be)*_i/s.bN;h&&(hi*=m.tilePixelRatio/k);const vt=Wh(xe,hi);h?({x:mt,y:it,z:Nt}=pe.projectTilePoint($e+vt.x,Ze+vt.y,I.canonical),[mt,it,Nt]=Ds(mt+Ne,it+ct,Nt+Ot,E)):(r&&vt._rotate(-T.angle),mt+=vt.x,it+=vt.y,Nt=0);const Gt=m.allowVerticalPlacement&&Be.placedOrientation===s.aE.vertical?Math.PI/2:0;for(let ri=0;ri<rt;ri++)s.aH(ee,mt,it,Nt,Gt);H&&Be.associatedIconIndex>=0&&(ue[Be.associatedIconIndex]={x:mt,y:it,z:Nt,angle:Gt})}else qo(rt,ee)}if(H){ie.clear();const Fe=m.icon.placedSymbolArray;for(let Be=0;Be<Fe.length;Be++){const $e=Fe.get(Be),{numGlyphs:Ze}=$e,rt=ue[Be];if($e.hidden||!rt)qo(Ze,ie);else{const{x:xe,y:Ne,z:ct,angle:Ot}=rt;for(let mt=0;mt<Ze;mt++)s.aH(ie,xe,Ne,ct,Ot)}}m.icon.dynamicLayoutVertexBuffer.updateData(ie)}m.text.dynamicLayoutVertexBuffer.updateData(ee)}function Ou(m,r,h,y,b,T,E={}){const I=h.paint.get("icon-translate"),k=h.paint.get("text-translate"),N=h.paint.get("icon-translate-anchor"),H=h.paint.get("text-translate-anchor"),X=h.layout.get("icon-rotation-alignment"),ee=h.layout.get("text-rotation-alignment"),ie=h.layout.get("icon-pitch-alignment"),ue=h.layout.get("text-pitch-alignment"),pe=h.layout.get("icon-keep-upright"),fe=h.layout.get("text-keep-upright"),_e=h.paint.get("icon-color-saturation"),Le=h.paint.get("icon-color-contrast"),Fe=h.paint.get("icon-color-brightness-min"),Be=h.paint.get("icon-color-brightness-max"),$e=h.paint.get("icon-occlusion-opacity").constantOr(0),Ze=h.paint.get("text-occlusion-opacity").constantOr(0),rt=m.context,xe=rt.gl,Ne=m.transform,ct=X==="map",Ot=ee==="map",mt=ie==="map",it=ue==="map",Nt=$e!==1,mi=Ze!==1,_i=h.layout.get("symbol-sort-key").constantOr(1)!==void 0;let hi=!1;const vt=m.depthModeForSublayer(0,s.ae.ReadOnly),Gt=[s.aj(Ne.center.lng),s.ak(Ne.center.lat)],ri=h.layout.get("text-variable-anchor"),$i=Ne.projection.name==="globe",Yi=[],hn=[0,-1,0];for(const Ji of y){const Gi=r.getTile(Ji),Qt=Gi.getBucket(h);if(!Qt||Qt.projection.name==="mercator"&&$i||Qt.fullyClipped)continue;const xn=Qt.projection.name==="globe",Tr=xn?s.a1(Ne.zoom):0,Wn=zu(Ji,Qt.getProjection(),Ne),cr=Ne.calculatePixelsToTileUnitsMatrix(Gi),er=ri&&Qt.hasTextData(),xs=Qt.hasIconTextFit()&&er&&Qt.hasIconData(),zr=Qt.getProjection().createInversionMatrix(Ne,Ji.canonical),ir=()=>{const vs=ct&&h.layout.get("symbol-placement")!=="point",oi=[];h.hasInitialOcclusionOpacityProperties&&Nt&&m.symbolParams.useOcclusionQueries&&!xn&&!$i&&oi.push("OCCLUSION_QUERIES"),h.hasInitialOcclusionOpacityProperties||oi.push("SYMBOL_OCCLUSION_BY_TERRAIN_DEPTH");const on=vs||xs,Eo=h.paint.get("icon-image-cross-fade").constantOr(0);m.terrainRenderModeElevated()&&mt&&oi.push("PITCH_WITH_MAP_TERRAIN"),xn&&(oi.push("PROJECTION_GLOBE_VIEW"),on&&oi.push("PROJECTED_POS_ON_VIEWPORT")),Eo>0&&oi.push("ICON_TRANSITION"),Qt.icon.zOffsetVertexBuffer&&oi.push("Z_OFFSET"),oi.push("TERRAIN_DEPTH_D24"),_e===0&&Le===0&&Fe===0&&Be===1||oi.push("COLOR_ADJUSTMENT");const Br=Qt.icon.programConfigurations.get(h.id),Pt=m.getOrCreateProgram(Qt.sdfIcons?"symbolSDF":"symbolIcon",{config:Br,defines:oi});let ao;const yo=Gi.imageAtlasTexture?Gi.imageAtlasTexture.size:[0,0],Ys=Qt.iconSizeData,io=s.aD(Ys,Ne.zoom),Uo=mt||Ne.pitch!==0,ga=pn(Wn,Gi.tileID.canonical,mt,ct,Ne,Qt.getProjection(),cr),Yo=To(Wn,Gi.tileID.canonical,mt,ct,Ne,Qt.getProjection(),cr),Ia=m.translatePosMatrix(Yo,Gi,I,N,!0),Pa=m.translatePosMatrix(Wn,Gi,I,N),Ra=on?sc:ga,qa=ct&&!mt&&!vs;let kc=hn;!$i&&!Ne.mercatorFromTransition||ct||(kc=sl(Ne));const Mh=xn?kc:hn;if(Qt.sdfIcons&&!Qt.iconsInText)ao=ch(Ys.kind,io,qa,mt,m,Pa,Ra,Ia,!1,yo,!0,Ji,Tr,Gt,zr,Mh,Qt.getProjection());else{const dc=h.getColorAdjustmentMatrix(_e,Le,Fe,Be);ao=nl(Ys.kind,io,qa,mt,m,Pa,Ra,Ia,!1,yo,Ji,Tr,Gt,zr,Mh,Qt.getProjection(),dc,Eo)}const Th=Gi.imageAtlasTexture?Gi.imageAtlasTexture:null,uc=h.layout.get("icon-size").constantOr(0)!==1||Qt.iconsNeedLinear,Bc=Qt.sdfIcons||m.options.rotating||m.options.zooming||uc||Uo?xe.LINEAR:xe.NEAREST,lu=Qt.sdfIcons&&h.paint.get("icon-halo-width").constantOr(1)!==0,cu=m.terrain&&mt&&vs?s.ad.invert(s.ad.create(),ga):sc;if(vs&&Qt.icon){const dc=Ne.elevation,Ao=dc?dc.getAtTileOffsetFunc(Ji,Ne.center.lat,Ne.worldSize,Qt.getProjection()):null,rd=Mo(Wn,Gi.tileID.canonical,mt,ct,Ne,Qt.getProjection(),cr);Do(Qt,Wn,m,!1,rd,Yo,mt,pe,Ao,Ji)}return{program:Pt,buffers:Qt.icon,uniformValues:ao,atlasTexture:Th,atlasTextureIcon:null,atlasInterpolation:Bc,atlasInterpolationIcon:null,isSDF:Qt.sdfIcons,hasHalo:lu,tile:Gi,labelPlaneMatrixInv:cu}},ls=()=>{const vs=Ot&&h.layout.get("symbol-placement")!=="point",oi=[],on=vs||ri||xs;h.hasInitialOcclusionOpacityProperties&&mi&&m.symbolParams.useOcclusionQueries&&!xn&&!$i&&oi.push("OCCLUSION_QUERIES"),h.hasInitialOcclusionOpacityProperties||oi.push("SYMBOL_OCCLUSION_BY_TERRAIN_DEPTH"),m.terrainRenderModeElevated()&&it&&oi.push("PITCH_WITH_MAP_TERRAIN"),xn&&(oi.push("PROJECTION_GLOBE_VIEW"),on&&oi.push("PROJECTED_POS_ON_VIEWPORT")),Qt.text.zOffsetVertexBuffer&&oi.push("Z_OFFSET"),oi.push("TERRAIN_DEPTH_D24");const Eo=Qt.text.programConfigurations.get(h.id),Br=m.getOrCreateProgram(Qt.iconsInText?"symbolTextAndIcon":"symbolSDF",{config:Eo,defines:oi});let Pt,ao=[0,0],yo=null;const Ys=Qt.textSizeData;Qt.iconsInText&&(ao=Gi.imageAtlasTexture?Gi.imageAtlasTexture.size:[0,0],yo=Gi.imageAtlasTexture?Gi.imageAtlasTexture:null,Pt=it||Ne.pitch!==0||m.options.rotating||m.options.zooming||Ys.kind==="composite"||Ys.kind==="camera"?xe.LINEAR:xe.NEAREST);const io=Gi.glyphAtlasTexture?Gi.glyphAtlasTexture.size:[0,0],Uo=s.aD(Ys,Ne.zoom),ga=pn(Wn,Gi.tileID.canonical,it,Ot,Ne,Qt.getProjection(),cr),Yo=To(Wn,Gi.tileID.canonical,it,Ot,Ne,Qt.getProjection(),cr),Ia=m.translatePosMatrix(Yo,Gi,k,H,!0),Pa=m.translatePosMatrix(Wn,Gi,k,H),Ra=on?sc:ga,qa=Ot&&!it&&!vs;let kc=hn;!$i&&!Ne.mercatorFromTransition||Ot||(kc=sl(Ne));const Mh=xn?kc:hn;let Th;Th=Qt.iconsInText?Zf(Ys.kind,Uo,qa,it,m,Pa,Ra,Ia,io,ao,Ji,Tr,Gt,zr,Mh,Qt.getProjection()):ch(Ys.kind,Uo,qa,it,m,Pa,Ra,Ia,!0,io,!0,Ji,Tr,Gt,zr,Mh,Qt.getProjection());const uc=Gi.glyphAtlasTexture?Gi.glyphAtlasTexture:null,Bc=xe.LINEAR,lu=h.paint.get("text-halo-width").constantOr(1)!==0,cu=m.terrain&&it&&vs?s.ad.invert(s.ad.create(),ga):sc;if(vs&&Qt.text){const dc=Ne.elevation,Ao=dc?dc.getAtTileOffsetFunc(Ji,Ne.center.lat,Ne.worldSize,Qt.getProjection()):null,rd=Mo(Wn,Gi.tileID.canonical,it,Ot,Ne,Qt.getProjection(),cr);Do(Qt,Wn,m,!0,rd,Yo,it,fe,Ao,Ji)}return{program:Br,buffers:Qt.text,uniformValues:Th,atlasTexture:uc,atlasTextureIcon:yo,atlasInterpolation:Bc,atlasInterpolationIcon:Pt,isSDF:!0,hasHalo:lu,tile:Gi,labelPlaneMatrixInv:cu}},Zr=Qt.icon.segments.get().length,Or=Qt.text.segments.get().length,dr=Zr&&!E.onlyText?ir():null,hs=Or&&!E.onlyIcons?ls():null,ks=h.paint.get("icon-opacity").constantOr(1),Ur=h.paint.get("text-opacity").constantOr(1);if(_i&&Qt.canOverlap){hi=!0;const vs=ks&&!E.onlyText?Qt.icon.segments.get():[],oi=Ur&&!E.onlyIcons?Qt.text.segments.get():[];for(const on of vs)Yi.push({segments:new s.b([on]),sortKey:on.sortKey,state:dr});for(const on of oi)Yi.push({segments:new s.b([on]),sortKey:on.sortKey,state:hs})}else E.onlyText||Yi.push({segments:ks?Qt.icon.segments:new s.b([]),sortKey:0,state:dr}),E.onlyIcons||Yi.push({segments:Ur?Qt.text.segments:new s.b([]),sortKey:0,state:hs})}hi&&Yi.sort((Ji,Gi)=>Ji.sortKey-Gi.sortKey);for(const Ji of Yi){const Gi=Ji.state;if(Gi)if(m.terrain&&m.terrain.setupElevationDraw(Gi.tile,Gi.program,{useDepthForOcclusion:!h.hasInitialOcclusionOpacityProperties&&Ne.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:Gi.labelPlaneMatrixInv}),rt.activeTexture.set(xe.TEXTURE0),Gi.atlasTexture&&Gi.atlasTexture.bind(Gi.atlasInterpolation,xe.CLAMP_TO_EDGE,!0),Gi.atlasTextureIcon&&(rt.activeTexture.set(xe.TEXTURE1),Gi.atlasTextureIcon&&Gi.atlasTextureIcon.bind(Gi.atlasInterpolationIcon,xe.CLAMP_TO_EDGE,!0)),m.uploadCommonLightUniforms(m.context,Gi.program),Gi.hasHalo){const Qt=Gi.uniformValues;Qt.u_is_halo=1,Sp(Gi.buffers,Ji.segments,h,m,Gi.program,vt,b,T,Qt,2),Qt.u_is_halo=0}else{if(Gi.isSDF){const Qt=Gi.uniformValues;Gi.hasHalo&&(Qt.u_is_halo=1,Sp(Gi.buffers,Ji.segments,h,m,Gi.program,vt,b,T,Qt,1)),Qt.u_is_halo=0}Sp(Gi.buffers,Ji.segments,h,m,Gi.program,vt,b,T,Gi.uniformValues,1)}}}function Sp(m,r,h,y,b,T,E,I,k,N){const H=y.context.gl,X=[m.dynamicLayoutVertexBuffer,m.opacityVertexBuffer,m.iconTransitioningVertexBuffer,m.globeExtVertexBuffer,m.zOffsetVertexBuffer];m.occlusionQueryOpacityVertexBuffer.length>0&&X.push(m.occlusionQueryOpacityVertexBuffer),b.draw(y,H.TRIANGLES,T,E,I,s.af.disabled,k,h.id,m.layoutVertexBuffer,m.indexBuffer,r,h.paint,y.transform.zoom,m.programConfigurations.get(h.id),X,N)}function Fu(m,r,h,y,b,T,E){const I=m.context.gl,k=h.paint.get("fill-pattern"),N=k&&k.constantOr(1);let H,X,ee,ie,ue;E?(X=N&&!h.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",H=I.LINES):(X=N?"fillPattern":"fill",H=I.TRIANGLES);for(const pe of y){const fe=r.getTile(pe);if(N&&!fe.patternsLoaded())continue;const _e=fe.getBucket(h);if(!_e)continue;m.prepareDrawTile();const Le=_e.programConfigurations.get(h.id),Fe=m.isTileAffectedByFog(pe),Be=m.getOrCreateProgram(X,{config:Le,overrideFog:Fe});N&&(m.context.activeTexture.set(I.TEXTURE0),fe.imageAtlasTexture&&fe.imageAtlasTexture.bind(I.LINEAR,I.CLAMP_TO_EDGE),Le.updatePaintBuffers());const $e=k.constantOr(null);if($e&&fe.imageAtlas){const xe=fe.imageAtlas.patternPositions[$e.toString()];xe&&Le.setConstantPatternPositions(xe)}const Ze=m.translatePosMatrix(pe.projMatrix,fe,h.paint.get("fill-translate"),h.paint.get("fill-translate-anchor")),rt=h.paint.get("fill-emissive-strength");if(E){ie=_e.indexBuffer2,ue=_e.segments2;const xe=m.terrain&&m.terrain.renderingToTexture?m.terrain.drapeBufferSize:[I.drawingBufferWidth,I.drawingBufferHeight];ee=X==="fillOutlinePattern"&&N?jf(Ze,rt,m,fe,xe):Hf(Ze,rt,xe)}else ie=_e.indexBuffer,ue=_e.segments,ee=N?Pu(Ze,rt,m,fe):lh(Ze,rt);m.uploadCommonUniforms(m.context,Be,pe.toUnwrapped()),Be.draw(m,H,b,m.stencilModeForClipping(pe),T,s.af.disabled,ee,h.id,_e.layoutVertexBuffer,ie,ue,h.paint,m.transform.zoom,Le,void 0)}}function pa(m,r,h,y,b,T,E,I){h.resetLayerRenderingStats(m);const k=m.context,N=k.gl,H=m.transform,X=h.paint.get("fill-extrusion-pattern"),ee=X.constantOr(1),ie=h.paint.get("fill-extrusion-opacity"),ue=m.style.enable3dLights(),pe=h.paint.get(ue&&!ee?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),fe=[h.paint.get("fill-extrusion-ambient-occlusion-intensity"),pe],_e=h.layout.get("fill-extrusion-edge-radius"),Le=_e>0&&!h.paint.get("fill-extrusion-rounded-roof"),Fe=Le?0:_e,Be=H.projection.name==="globe"?s.bY():0,$e=H.projection.name==="globe",Ze=$e?s.a1(H.zoom):0,rt=[s.aj(H.center.lng),s.ak(H.center.lat)],xe=h.paint.get("fill-extrusion-flood-light-color").toRenderColor(h.lut).toArray01().slice(0,3),Ne=h.paint.get("fill-extrusion-flood-light-intensity"),ct=h.paint.get("fill-extrusion-vertical-scale"),Ot=Ka(m,h.paint.get("fill-extrusion-cutoff-fade-range")),mt=h.paint.get("fill-extrusion-emissive-strength"),it=[];let Nt;$e&&it.push("PROJECTION_GLOBE_VIEW"),fe[0]>0&&it.push("FAUX_AO"),Le&&it.push("ZERO_ROOF_RADIUS"),I&&it.push("HAS_CENTROID"),Ne>0&&it.push("FLOOD_LIGHT"),Ot.shouldRenderCutoff&&it.push("RENDER_CUTOFF");const mi=m.renderPass==="shadow",_i=m.shadowRenderer,hi=mi&&!!_i;m.shadowRenderer&&(m.shadowRenderer.useNormalOffset=!0);let vt=[0,0,0];if(_i){const $i=m.style.directionalLight,Yi=m.style.ambientLight;$i&&Yi&&(vt=wa(m.style,$i,Yi)),Nt=it.concat(["SHADOWS_SINGLE_CASCADE"])}const Gt=hi?"fillExtrusionDepth":ee?"fillExtrusionPattern":"fillExtrusion",ri=h.getLayerRenderingStats();for(const $i of y){const Yi=r.getTile($i),hn=Yi.getBucket(h);if(!hn||hn.projection.name!==H.projection.name)continue;let Ji=!1;_i&&(Ji=_i.getMaxCascadeForTile($i.toUnwrapped())===0);const Gi=m.isTileAffectedByFog($i),Qt=hn.programConfigurations.get(h.id),xn=m.getOrCreateProgram(Gt,{config:Qt,defines:Ji?Nt:it,overrideFog:Gi});if(m.terrain&&m.terrain.setupElevationDraw(Yi,xn,{useMeterToDem:!0}),!hn.centroidVertexBuffer){const zr=xn.attributes.a_centroid_pos;zr!==void 0&&N.vertexAttrib2f(zr,0,0)}!mi&&_i&&_i.setupShadows(Yi.tileID.toUnwrapped(),xn,"vector-tile",Yi.tileID.overscaledZ),ee&&(m.context.activeTexture.set(N.TEXTURE0),Yi.imageAtlasTexture&&Yi.imageAtlasTexture.bind(N.LINEAR,N.CLAMP_TO_EDGE),Qt.updatePaintBuffers());const Tr=X.constantOr(null);if(Tr&&Yi.imageAtlas){const zr=Yi.imageAtlas.patternPositions[Tr.toString()];zr&&Qt.setConstantPatternPositions(zr)}const Wn=h.paint.get("fill-extrusion-vertical-gradient");let cr;if(mi&&_i){if(Ld(Yi.tileID,hn,m))continue;const zr=_i.calculateShadowPassMatrixFromTile(Yi.tileID.toUnwrapped());cr=Tc(zr,Fe,ct)}else{const zr=m.translatePosMatrix($i.expandedProjMatrix,Yi,h.paint.get("fill-extrusion-translate"),h.paint.get("fill-extrusion-translate-anchor")),ir=H.projection.createInversionMatrix(H,$i.canonical);cr=ee?il(zr,m,Wn,ie,fe,Fe,$i,Yi,Be,Ze,rt,ir,xe,ct):Cl(zr,m,Wn,ie,fe,Fe,$i,Be,Ze,rt,ir,xe,ct,Ne,vt,mt)}m.uploadCommonUniforms(k,xn,$i.toUnwrapped(),null,Ot);let er=hn.segments;if(H.projection.name==="mercator"&&!mi&&(er=hn.getVisibleSegments(Yi.tileID,m.terrain,m.transform.getFrustum(0)),!er.get().length))continue;if(ri)if(mi)for(const zr of er.get())ri.numRenderedVerticesInShadowPass+=zr.primitiveLength;else for(const zr of er.get())ri.numRenderedVerticesInTransparentPass+=zr.primitiveLength;const xs=[];(m.terrain||I)&&xs.push(hn.centroidVertexBuffer),$e&&xs.push(hn.layoutVertexExtBuffer),xn.draw(m,k.gl.TRIANGLES,b,T,E,s.af.backCCW,cr,h.id,hn.layoutVertexBuffer,hn.indexBuffer,er,h.paint,m.transform.zoom,Qt,xs)}m.shadowRenderer&&(m.shadowRenderer.useNormalOffset=!1)}function Na(m,r,h,y,b,T,E,I,k,N,H,X,ee,ie,ue,pe,fe,_e,Le){const Fe=m.context,Be=Fe.gl,$e=m.transform,Ze=m.transform.zoom,rt=[],xe=Ka(m,h.paint.get("fill-extrusion-cutoff-fade-range"));N==="clear"?(rt.push("CLEAR_SUBPASS"),Le&&(rt.push("CLEAR_FROM_TEXTURE"),Fe.activeTexture.set(Be.TEXTURE0),Le.bind(Be.LINEAR,Be.CLAMP_TO_EDGE))):N==="sdf"&&rt.push("SDF_SUBPASS"),fe&&rt.push("HAS_CENTROID"),xe.shouldRenderCutoff&&rt.push("RENDER_CUTOFF");const Ne=h.layout.get("fill-extrusion-edge-radius"),ct=(Ot,mt,it,Nt,mi)=>{const _i=mt.programConfigurations.get(h.id),hi=m.isTileAffectedByFog(Ot),vt=m.getOrCreateProgram("fillExtrusionGroundEffect",{config:_i,defines:rt,overrideFog:hi}),Gt=(($i,Yi,hn,Ji,Gi,Qt,xn,Tr,Wn,cr,er)=>({u_matrix:Yi,u_opacity:hn,u_ao_pass:Ji?1:0,u_meter_to_tile:Gi,u_ao:Qt,u_flood_light_intensity:xn,u_flood_light_color:Tr,u_attenuation:Wn,u_edge_radius:cr,u_fb:0,u_fb_size:er}))(0,Nt,H,k,mi,[X,ee*mi],ie,ue,pe,Ze>=17?0:Ne*mi,Le?Le.size[0]:0),ri=[];fe&&ri.push(mt.hiddenByLandmarkVertexBuffer),m.uploadCommonUniforms(Fe,vt,Ot.toUnwrapped(),null,xe),vt.draw(m,Fe.gl.TRIANGLES,b,T,E,I,Gt,h.id,mt.vertexBuffer,mt.indexBuffer,it,h.paint,Ze,_i,ri)};for(const Ot of y){const mt=r.getTile(Ot),it=mt.getBucket(h);if(!it||it.projection.name!==$e.projection.name||!it.groundEffect||it.groundEffect&&!it.groundEffect.hasData())continue;const Nt=it.groundEffect,mi=1/it.tileToMeter;{const _i=m.translatePosMatrix(Ot.projMatrix,mt,h.paint.get("fill-extrusion-translate"),h.paint.get("fill-extrusion-translate-anchor")),hi=Nt.getDefaultSegment();ct(Ot,Nt,hi,_i,mi)}if(_e)for(let _i=0;_i<4;_i++){const hi=s.bZ[_i](Ot),vt=r.getTile(hi);if(!vt)continue;const Gt=vt.getBucket(h);if(!Gt||Gt.projection.name!==$e.projection.name||!Gt.groundEffect||Gt.groundEffect&&!Gt.groundEffect.hasData())continue;const ri=Gt.groundEffect;let $i,Yi;_i===0?($i=[-s.a3,0,0],Yi=1):_i===1?($i=[s.a3,0,0],Yi=0):_i===2?($i=[0,-s.a3,0],Yi=3):($i=[0,s.a3,0],Yi=2);const hn=ri.regionSegments[Yi];if(!hn)continue;const Ji=new Float32Array(16);s.ad.translate(Ji,Ot.projMatrix,$i),ct(Ot,ri,hn,m.translatePosMatrix(Ji,mt,h.paint.get("fill-extrusion-translate"),h.paint.get("fill-extrusion-translate-anchor")),mi)}}}function Ep(m,r,h,y,b,T,E){y.centroidVertexArray.length===0&&y.createCentroidsBuffer();const I=T?T.findDEMTileFor(h):null;if(!(I&&I.dem||E))return;const k=_e=>new s.P(Math.ceil((_e+s.c0)*s.c1),0),N=_e=>{const Le=r.getSource().minzoom,Fe=$e=>{const Ze=r.getTileByID($e);if(Ze&&Ze.hasData())return Ze.getBucket(b)},Be=[0,-1,1];for(const $e of Be){if(_e.overscaledZ+$e<Le)continue;const Ze=Fe(_e.calculateScaledKey(_e.overscaledZ+$e));if(Ze)return Ze}},H=[0,0,0],X=(_e,Le)=>(H[0]=Math.min(_e.min.y,Le.min.y),H[1]=Math.max(_e.max.y,Le.max.y),H[2]=s.a3-Le.min.x>_e.max.x?Le.min.x-s.a3:_e.max.x,H),ee=(_e,Le)=>(H[0]=Math.min(_e.min.x,Le.min.x),H[1]=Math.max(_e.max.x,Le.max.x),H[2]=s.a3-Le.min.y>_e.max.y?Le.min.y-s.a3:_e.max.y,H),ie=[(_e,Le)=>X(_e,Le),(_e,Le)=>X(Le,_e),(_e,Le)=>ee(_e,Le),(_e,Le)=>ee(Le,_e)],ue=(_e,Le,Fe,Be,$e,Ze,rt)=>{if(!T)return 0;const xe=[[Ze?Fe:_e,Ze?_e:Fe,0],[Ze?Fe:Le,Ze?Le:Fe,0]],Ne=rt<0?s.a3+rt:rt,ct=[Ze?Ne:(_e+Le)/2,Ze?(_e+Le)/2:Ne,0];return Fe===0&&rt<0||Fe!==0&&rt>0?T.getForTilePoints($e,[ct],!0,Be):xe.push(ct),T.getForTilePoints(h,xe,!0,I),Math.max(xe[0][2],xe[1][2],ct[2])/T.exaggeration()};for(let _e=0;_e<4;_e++){const Le=y.borderFeatureIndices[_e];if(Le.length===0)continue;const Fe=s.bZ[_e](h),Be=N(Fe);if(!(Be&&Be instanceof s.b_)||y.borderDoneWithNeighborZ[_e]===Be.canonical.z)continue;Be.centroidVertexArray.length===0&&Be.createCentroidsBuffer();const $e=T?T.findDEMTileFor(Fe):null;if(!($e&&$e.dem||E))continue;const Ze=(_e<2?1:5)-_e,rt=Be.borderDoneWithNeighborZ[Ze]!==y.canonical.z,xe=Be.borderFeatureIndices[Ze];let Ne=0;if(y.canonical.z!==Be.canonical.z){for(const ct of Le)y.showCentroid(y.featuresOnBorder[ct]);if(rt)for(const ct of xe)Be.showCentroid(Be.featuresOnBorder[ct]);y.borderDoneWithNeighborZ[_e]=Be.canonical.z,Be.borderDoneWithNeighborZ[Ze]=y.canonical.z}for(const ct of Le){const Ot=y.featuresOnBorder[ct],mt=y.centroidData[Ot.centroidDataIndex],it=Ot.borders[_e];let Nt;for(;Ne<xe.length;){Nt=Be.featuresOnBorder[xe[Ne]];const mi=Nt.borders[Ze];if(mi[1]>it[0]+3||mi[0]>it[0]-3)break;Be.showCentroid(Nt),Ne++}if(Nt&&Ne<xe.length){const mi=Ne;let _i=0;for(;!(Nt.borders[Ze][0]>it[1]-3)&&(_i++,++Ne!==xe.length);)Nt=Be.featuresOnBorder[xe[Ne]];if(Nt=Be.featuresOnBorder[xe[mi]],_i>1){const Gt=Nt.borders[Ze];Math.abs(it[0]-Gt[0])<3&&Math.abs(it[1]-Gt[1])<3&&(_i=1,Ne=mi+1)}else if(_i===0){y.showCentroid(Ot);continue}const hi=Be.centroidData[Nt.centroidDataIndex];E&&_i===1&&(((pe=mt).flags|(fe=hi).flags)&s.b$?(pe.flags|=s.b$,fe.flags|=s.b$):(pe.flags&=~s.b$,fe.flags&=~s.b$));const vt=Ot.intersectsCount()>1||Nt.intersectsCount()>1;if(_i>1)Ne=mi,mt.centroidXY=hi.centroidXY=new s.P(0,0);else if($e&&$e.dem&&!vt){const Gt=ie[_e](mt,hi),ri=_e%2?s.a3-1:0,$i=ue(Gt[0],Math.min(s.a3-1,Gt[1]),ri,$e,Fe,_e<2,Gt[2]);mt.centroidXY=hi.centroidXY=k($i)}else vt?mt.centroidXY=hi.centroidXY=new s.P(0,0):(mt.centroidXY=y.encodeBorderCentroid(Ot),hi.centroidXY=Be.encodeBorderCentroid(Nt));y.writeCentroidToBuffer(mt),Be.writeCentroidToBuffer(hi)}else y.showCentroid(Ot)}y.borderDoneWithNeighborZ[_e]=Be.canonical.z,Be.borderDoneWithNeighborZ[Ze]=y.canonical.z}var pe,fe;(y.needsCentroidUpdate||!y.centroidVertexBuffer&&y.centroidVertexArray.length!==0)&&y.uploadCentroid(m)}const Ad=[1,0,0],oc=[0,1,0],Cd=[0,0,1];function Ld(m,r,h){const y=h.transform,b=h.shadowRenderer;if(!b)return!0;const T=m.toUnwrapped(),E=y.tileSize*b._cascades[h.currentShadowCascade].scale;let I=r.maxHeight;if(y.elevation){const pe=y.elevation.getMinMaxForTile(m);pe&&(I+=pe.max)}const k=[...b.shadowDirection];k[2]=-k[2];const N=b.computeSimplifiedTileShadowVolume(T,I,E,k);if(!N)return!1;const H=[Ad,oc,Cd,k,[k[0],0,k[2]],[0,k[1],k[2]]],X=y.projection.name==="globe",ee=y.scaleZoom(E),ie=s.aM.fromInvProjectionMatrix(y.invProjMatrix,y.worldSize,ee,!X),ue=b.getCurrentCascadeFrustum();return ie.intersectsPrecise(N.vertices,N.planes,H)===0||ue.intersectsPrecise(N.vertices,N.planes,H)===0}function Id(m){return[m[0]*s.c2,m[1]*s.c2,m[2]*s.c2,0]}function qh(m,r,h,y,b,T,E,I,k){const N=y.getSource(),H=h.globeSharedBuffers;if(!H)return;let X,ee,ie;if(r&&(X=y.getTile(r)),N instanceof s.bm?(ee=N.texture,ie=s.bh(0,0,h.transform)):X&&r&&(ee=X.texture,ie=s.bh(r.canonical.z,r.canonical.x,h.transform)),!ee||!ie)return;m||(ie=s.ad.scale(s.ad.create(),ie,[1,-1,1]));const ue=h.context,pe=ue.gl,fe=b.paint.get("raster-resampling")==="nearest"?pe.NEAREST:pe.LINEAR,_e=h.colorModeForDrapableLayerRenderPass(T),Le=E.defines;Le.push("GLOBE_POLES");const Fe=new s.ae(pe.LEQUAL,s.ae.ReadWrite,h.depthRangeFor3D),Be=Float32Array.from(h.transform.expandedFarZProjMatrix),$e=Float32Array.from(s.bf(s.bg(new s.aO(0,0,0))));h.terrain&&h.terrain.prepareDrawTile(),ue.activeTexture.set(pe.TEXTURE0),ee.bind(fe,pe.CLAMP_TO_EDGE),ue.activeTexture.set(pe.TEXTURE1),ee.bind(fe,pe.CLAMP_TO_EDGE),ee.useMipmap&&ue.extTextureFilterAnisotropic&&h.transform.pitch>20&&pe.texParameterf(pe.TEXTURE_2D,ue.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,ue.extTextureFilterAnisotropicMax);const[Ze,rt,xe,Ne]=r?H.getPoleBuffers(r.canonical.z,!1):H.getPoleBuffers(0,!0),ct=b.paint.get("raster-elevation");let Ot;m?(Ot=Ze,h.renderDefaultNorthPole=ct!==0):(Ot=rt,h.renderDefaultSouthPole=ct!==0);const mt=Id(E.mix),it=((mi,_i,hi,vt,Gt,ri,$i,Yi,hn,Ji,Gi,Qt,xn)=>nc(mi,_i,hi,new Float32Array(16),new Float32Array(9),[0,0],vt,[0,0],[0,0,0,0],1,{opacity:1,mix:0},ri,[0,0],Yi,2,Ji,Gi,Qt,1,0,xn))(Be,$e,ie,s.a1(h.transform.zoom),0,b,0,ct,0,mt,E.offset,E.range,T),Nt=h.getOrCreateProgram("raster",{defines:Le});h.uploadCommonUniforms(ue,Nt,null),Nt.draw(h,pe.TRIANGLES,Fe,k,_e,I,it,b.id,Ot,xe,Ne)}function Ap(m){const r=m._nearZ,h=m.projection.farthestPixelDistance(m),y=h-r,b=.2*m.height,T=r+b;return[r,h,(T-b-r)/y,(T-r)/y]}function Yr(m,r,h,y){if(m)return r instanceof Kl&&m instanceof s.c3?r.getTextureDescriptor(m,h,!0):{texture:m.texture,mix:Id(y.mix),offset:y.offset,buffer:0,tileSize:1}}function dg(m,r,h){if(!m)return null;const y=r.getTextureDescriptor(m,h,!0);if(!y)return null;let{texture:b,mix:T,offset:E,tileSize:I,buffer:k,format:N}=y;if(!b||!N)return null;let H=!1;return N==="uint32"&&(H=!0,T[3]=0,T=ic(s.c4,T,[0,h.paint.get("raster-particle-max-speed")]),E=Wf(s.c4,E,[0,h.paint.get("raster-particle-max-speed")])),{texture:b,textureOffset:[k/(I+2*k),I/(I+2*k)],tileSize:I,scalarData:H,scale:T,offset:E,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[N]]}}function Qn(m){const r=m._nearZ,h=m.projection.farthestPixelDistance(m),y=h-r,b=.2*m.height,T=r+b;return[r,h,(T-b-r)/y,(T-r)/y]}const $f=new s.C(1,0,0,1),Pd=new s.C(0,1,0,1),ku=new s.C(0,0,1,1),Ua=new s.C(1,0,1,1),Rd=new s.C(0,1,1,1);function ol(m,r,h,y,b,T,E){const I=m.context,k=m.transform,N=I.gl,H=k.projection.name==="globe",X=H?["PROJECTION_GLOBE_VIEW"]:[];let ee=s.ad.clone(h.projMatrix);if(H&&s.a1(k.zoom)>0){const mt=s.c5(h.canonical,k),it=s.c6(mt);ee=s.ad.multiply(new Float32Array(16),k.globeMatrix,it),s.ad.multiply(ee,k.projMatrix,ee)}const ie=s.ad.create();ie[12]+=2*b/(s.e.devicePixelRatio*k.width),ie[13]+=2*T/(s.e.devicePixelRatio*k.height),s.ad.multiply(ee,ie,ee);const ue=m.getOrCreateProgram("debug",{defines:X}),pe=r.getTileByID(h.key);m.terrain&&m.terrain.setupElevationDraw(pe,ue);const fe=s.ae.disabled,_e=s.ag.disabled,Le=m.colorModeForRenderPass(),Fe="$debug";I.activeTexture.set(N.TEXTURE0),m.emptyTexture.bind(N.LINEAR,N.CLAMP_TO_EDGE),H?pe._makeGlobeTileDebugBuffers(m.context,k):pe._makeDebugTileBoundsBuffers(m.context,k.projection);const Be=pe._tileDebugBuffer||m.debugBuffer,$e=pe._tileDebugIndexBuffer||m.debugIndexBuffer,Ze=pe._tileDebugSegments||m.debugSegments;if(ue.draw(m,N.LINE_STRIP,fe,_e,Le,s.af.disabled,ec(ee,y),Fe,Be,$e,Ze,null,null,null,[pe._globeTileDebugBorderBuffer]),E){const mt=pe.latestRawTileData,it=Math.floor((mt&&mt.byteLength||0)/1024);let Nt=h.canonical.toString();h.overscaledZ!==h.canonical.z&&(Nt+=` => ${h.overscaledZ}`),Nt+=` ${pe.state}`,Nt+=` ${it}kb`,function(mi,_i){mi.initDebugOverlayCanvas();const hi=mi.debugOverlayCanvas,vt=mi.context.gl,Gt=mi.debugOverlayCanvas.getContext("2d");Gt.clearRect(0,0,hi.width,hi.height),Gt.shadowColor="white",Gt.shadowBlur=2,Gt.lineWidth=1.5,Gt.strokeStyle="white",Gt.textBaseline="top",Gt.font="bold 36px Open Sans, sans-serif",Gt.fillText(_i,5,5),Gt.strokeText(_i,5,5),mi.debugOverlayTexture.update(hi),mi.debugOverlayTexture.bind(vt.LINEAR,vt.CLAMP_TO_EDGE)}(m,Nt)}const rt=r.getTile(h).tileSize,xe=512/Math.min(rt,512)*(h.overscaledZ/k.zoom)*.5,Ne=pe._tileDebugTextBuffer||m.debugBuffer,ct=pe._tileDebugTextIndexBuffer||m.quadTriangleIndexBuffer,Ot=pe._tileDebugTextSegments||m.debugSegments;ue.draw(m,N.TRIANGLES,fe,_e,s.a.alphaBlended,s.af.disabled,ec(ee,s.C.transparent,xe),Fe,Ne,ct,Ot,null,null,null,[pe._globeTileDebugTextBuffer])}function yn(m,r,h,y){Nr(m,0,r+h/2,m.transform.width,h,y)}function qr(m,r,h,y){Nr(m,r-h/2,0,h,m.transform.height,y)}function Nr(m,r,h,y,b,T){const E=m.context,I=E.gl;I.enable(I.SCISSOR_TEST),I.scissor(r*s.e.devicePixelRatio,h*s.e.devicePixelRatio,y*s.e.devicePixelRatio,b*s.e.devicePixelRatio),E.clear({color:T}),I.disable(I.SCISSOR_TEST)}const Ea=s.c7([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:hh}=Ea;function Dr(m,r,h,y){m.emplaceBack(r,h,y)}class Zh{constructor(r){this.vertexArray=new s.c8,this.indices=new s.bu,Dr(this.vertexArray,-1,-1,1),Dr(this.vertexArray,1,-1,1),Dr(this.vertexArray,-1,1,1),Dr(this.vertexArray,1,1,1),Dr(this.vertexArray,-1,-1,-1),Dr(this.vertexArray,1,-1,-1),Dr(this.vertexArray,-1,1,-1),Dr(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=r.createVertexBuffer(this.vertexArray,hh),this.indexBuffer=r.createIndexBuffer(this.indices),this.segment=s.b.simpleSegment(0,0,36,12)}}function na(m,r,h,y,b,T){const E=m.context.gl,I=r.paint.get("sky-atmosphere-color"),k=r.paint.get("sky-atmosphere-halo-color"),N=r.paint.get("sky-atmosphere-sun-intensity"),H=((X,ee,ie,ue,pe)=>({u_matrix_3f:X,u_sun_direction:ee,u_sun_intensity:ie,u_color_tint_r:[ue.r,ue.g,ue.b,ue.a],u_color_tint_m:[pe.r,pe.g,pe.b,pe.a],u_luminance:5e-5}))(s.bC.fromMat4(s.bC.create(),y),b,N,I,k);E.framebufferTexture2D(E.FRAMEBUFFER,E.COLOR_ATTACHMENT0,E.TEXTURE_CUBE_MAP_POSITIVE_X+T,r.skyboxTexture,0),h.draw(m,E.TRIANGLES,s.ae.disabled,s.ag.disabled,s.a.unblended,s.af.frontCW,H,"skyboxCapture",r.skyboxGeometry.vertexBuffer,r.skyboxGeometry.indexBuffer,r.skyboxGeometry.segment)}const So=s.c7([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class zs{constructor(r){const h=new s.c9;h.emplaceBack(-1,1,1,0,0),h.emplaceBack(1,1,1,1,0),h.emplaceBack(1,-1,1,1,1),h.emplaceBack(-1,-1,1,0,1);const y=new s.bu;y.emplaceBack(0,1,2),y.emplaceBack(2,3,0),this.vertexBuffer=r.createVertexBuffer(h,So.members),this.indexBuffer=r.createIndexBuffer(y),this.segments=s.b.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const qs=s.c7([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class pg{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class Bu{constructor(r){this.colorModeAlphaBlendedWriteRGB=new s.a([s.ca,s.cb,s.ca,s.cb],s.C.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new s.a([s.ca,s.cc,s.ca,s.cc],s.C.transparent,[!1,!1,!1,!0]),this.params=new pg,this.updateNeeded=!0,r.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},()=>{this.updateNeeded=!0}),r.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),r.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0}),r.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0})}update(r){const h=r.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new zs(h);const y=this.params.sizeRange,b=this.params.intensityRange,T=function(H){const X=s.cf(30),ee=[];for(let ie=0;ie<H;++ie){const ue=2*Math.PI*X(),pe=Math.acos(1-2*X())-.5*Math.PI;ee.push(s._.fromValues(Math.cos(pe)*Math.cos(ue),Math.cos(pe)*Math.sin(ue),Math.sin(pe)))}return ee}(this.params.starsCount),E=s.cf(300),I=new s.cd,k=new s.bu;let N=0;for(let H=0;H<T.length;++H){const X=s._.scale([],T[H],200),ee=Math.max(0,1+.01*y*(1*E()-.5)),ie=Math.max(0,1+.01*b*(1*E()-.5));I.emplaceBack(X[0],X[1],X[2],-1,-1,ee,ie),I.emplaceBack(X[0],X[1],X[2],1,-1,ee,ie),I.emplaceBack(X[0],X[1],X[2],1,1,ee,ie),I.emplaceBack(X[0],X[1],X[2],-1,1,ee,ie),k.emplaceBack(N+0,N+1,N+2),k.emplaceBack(N+0,N+2,N+3),N+=4}this.starsVx=h.createVertexBuffer(I,qs.members),this.starsIdx=h.createIndexBuffer(k),this.starsSegments=s.b.simpleSegment(0,0,I.length,k.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(r,h){const y=r.context,b=y.gl,T=r.transform,E=new s.ae(b.LEQUAL,s.ae.ReadOnly,[0,1]),I=s.a1(T.zoom),k=r.style.getLut(h.scope),N=h.properties.get("color").toRenderColor(k).toArray01(),H=h.properties.get("high-color").toRenderColor(k).toArray01(),X=h.properties.get("space-color").toRenderColor(k).toArray01PremultipliedAlpha(),ee=5e-4,ie=s.ce(h.properties.get("horizon-blend"),0,1,ee,.25),ue=s.ba(r,y,T)&&ie===ee?T.worldSize/(2*Math.PI*1.025)-1:T.globeRadius,pe=r.frameCounter/1e3%1,fe=s._.length(T.globeCenterInViewSpace),_e=Math.sqrt(Math.pow(fe,2)-Math.pow(ue,2)),Le=Math.acos(_e/fe),Fe=Be=>{const $e=T.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];Be&&$e.push("ALPHA_PASS");const Ze=r.getOrCreateProgram("globeAtmosphere",{defines:$e}),rt=((Ne,ct,Ot,mt,it,Nt,mi,_i,hi,vt,Gt,ri)=>({u_frustum_tl:Ne,u_frustum_tr:ct,u_frustum_br:Ot,u_frustum_bl:mt,u_horizon:it,u_transition:Nt,u_fadeout_range:mi,u_color:_i,u_high_color:hi,u_space_color:vt,u_temporal_offset:Gt,u_horizon_angle:ri}))(T.frustumCorners.TL,T.frustumCorners.TR,T.frustumCorners.BR,T.frustumCorners.BL,T.frustumCorners.horizon,I,ie,N,H,X,pe,Le);r.uploadCommonUniforms(y,Ze);const xe=this.atmosphereBuffer;xe&&Ze.draw(r,b.TRIANGLES,E,s.ag.disabled,Be?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,s.af.backCW,rt,Be?"atmosphere_glow_alpha":"atmosphere_glow",xe.vertexBuffer,xe.indexBuffer,xe.segments)};Fe(!1),Fe(!0)}drawStars(r,h){const y=s.at(h.properties.get("star-intensity"),0,1);if(y===0)return;const b=r.context,T=b.gl,E=r.transform,I=r.getOrCreateProgram("stars"),k=s.av.identity([]);s.av.rotateX(k,k,-E._pitch),s.av.rotateZ(k,k,-E.angle),s.av.rotateX(k,k,s.ab(E._center.lat)),s.av.rotateY(k,k,-s.ab(E._center.lng));const N=s.ad.fromQuat(new Float32Array(16),k),H=s.ad.multiply([],E.starsProjMatrix,N),X=s.bC.fromMat4([],N),ee=s.bC.invert([],X),ie=[0,1,0];s._.transformMat3(ie,ie,ee),s._.scale(ie,ie,this.params.sizeMultiplier);const ue=[1,0,0];s._.transformMat3(ue,ue,ee),s._.scale(ue,ue,this.params.sizeMultiplier);const pe=(fe=ie,_e=ue,Le=y,{u_matrix:Float32Array.from(H),u_up:fe,u_right:_e,u_intensity_multiplier:Le});var fe,_e,Le;r.uploadCommonUniforms(b,I),this.starsVx&&this.starsIdx&&I.draw(r,T.TRIANGLES,s.ae.disabled,s.ag.disabled,this.colorModeAlphaBlendedWriteRGB,s.af.disabled,pe,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function Dd(m,r){const h=[...m],y=r.cameraWorldSizeForFog/r.worldSize,b=s.ad.identity([]);return s.ad.scale(b,b,[y,y,1]),s.ad.multiply(h,b,h),s.ad.multiply(h,r.worldToFogMatrix,h),h}function uh(m,r,h,y,b){const T=h.material,E=y.context,{baseColorTexture:I,metallicRoughnessTexture:k}=T.pbrMetallicRoughness,{normalTexture:N,occlusionTexture:H,emissionTexture:X}=T;function ee(ie,ue,pe){if(ie&&(m.push(ue),E.activeTexture.set(E.gl.TEXTURE0+pe),ie.gfxTexture)){const{minFilter:fe,magFilter:_e,wrapS:Le,wrapT:Fe}=ie.sampler;ie.gfxTexture.bindExtraParam(fe,_e,Le,Fe)}}ee(I,"HAS_TEXTURE_u_baseColorTexture",gs.BaseColor),ee(k,"HAS_TEXTURE_u_metallicRoughnessTexture",gs.MetallicRoughness),ee(N,"HAS_TEXTURE_u_normalTexture",gs.Normal),ee(H,"HAS_TEXTURE_u_occlusionTexture",gs.Occlusion),ee(X,"HAS_TEXTURE_u_emissionTexture",gs.Emission),b&&(b.texture||(b.texture=new s.ch(y.context,b.image,[b.image.height,b.image.height,b.image.height],E.gl.RGBA)),E.activeTexture.set(E.gl.TEXTURE0+gs.LUT),b.texture&&b.texture.bind(E.gl.LINEAR,E.gl.CLAMP_TO_EDGE),m.push("APPLY_LUT_ON_GPU")),h.texcoordBuffer&&(m.push("HAS_ATTRIBUTE_a_uv_2f"),r.push(h.texcoordBuffer)),h.colorBuffer&&(m.push(h.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),r.push(h.colorBuffer)),h.normalBuffer&&(m.push("HAS_ATTRIBUTE_a_normal_3f"),r.push(h.normalBuffer)),h.pbrBuffer&&(m.push("HAS_ATTRIBUTE_a_pbr"),m.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),r.push(h.pbrBuffer)),T.alphaMode!=="OPAQUE"&&T.alphaMode!=="MASK"||m.push("UNPREMULT_TEXTURE_IN_SHADER"),T.defined||m.push("DIFFUSE_SHADED"),m.push("USE_STANDARD_DERIVATIVES")}function Xh(m,r,h,y,b,T){const E=h.paint.get("model-opacity"),I=r.context,k=new s.ae(r.context.gl.LEQUAL,s.ae.ReadWrite,r.depthRangeFor3D),N=r.transform,H=m.mesh,X=H.material,ee=X.pbrMetallicRoughness,ie=r.style.fog;let ue;ue=r.transform.projection.zAxisUnit==="pixels"?[...m.nodeModelMatrix]:s.ad.multiply([],y.zScaleMatrix,m.nodeModelMatrix),s.ad.multiply(ue,y.negCameraPosMatrix,ue);const pe=s.ad.invert([],ue);s.ad.transpose(pe,pe);const fe=h.paint.get("model-emissive-strength").constantOr(0),_e=Sd(new Float32Array(m.worldViewProjection),new Float32Array(ue),new Float32Array(pe),null,r,E,ee.baseColorFactor.toRenderColor(null),X.emissiveFactor,ee.metallicFactor,ee.roughnessFactor,X,fe,h),Le={defines:[]},Fe=[];uh(Le.defines,Fe,H,r,h.lut);const Be=r.shadowRenderer;Be&&(Be.useNormalOffset=!1);let $e=null;if(ie){const xe=Dd(m.nodeModelMatrix,r.transform);if($e=new Float32Array(xe),N.projection.name!=="globe"){const Ne=H.aabb.min,ct=H.aabb.max,[Ot,mt]=ie.getOpacityForBounds(xe,Ne[0],Ne[1],ct[0],ct[1]);Le.overrideFog=Ot>=Wr||mt>=Wr}}const Ze=Ka(r,h.paint.get("model-cutoff-fade-range"));Ze.shouldRenderCutoff&&Le.defines.push("RENDER_CUTOFF");const rt=r.getOrCreateProgram("model",Le);r.uploadCommonUniforms(I,rt,null,$e,Ze),r.renderPass!=="shadow"&&Be&&Be.setupShadowsFromMatrix(m.nodeModelMatrix,rt),rt.draw(r,I.gl.TRIANGLES,k,b,T,H.material.doubleSided?s.af.disabled:s.af.backCCW,_e,h.id,H.vertexBuffer,H.indexBuffer,H.segments,h.paint,r.transform.zoom,void 0,Fe)}function Nu(m,r,h,y,b,T,E){let I;I=m.projection.name==="globe"?s.ci(h,m):[...h],s.ad.multiply(I,I,r.matrix);const k=s.ad.multiply([],y,I);if(r.meshes)for(const N of r.meshes){if(N.material.alphaMode!=="BLEND"){E.push({mesh:N,depth:0,modelIndex:b,worldViewProjection:k,nodeModelMatrix:I});continue}const H=s._.transformMat4([],N.centroid,k);H[2]>0&&T.push({mesh:N,depth:H[2],modelIndex:b,worldViewProjection:k,nodeModelMatrix:I})}if(r.children)for(const N of r.children)Nu(m,N,h,y,b,T,E)}function zo(m,r,h,y){const b=h.shadowRenderer;if(!b)return;const T=b.getShadowPassDepthMode(),E=b.getShadowPassColorMode(),I=b.calculateShadowPassMatrixFromMatrix(r),k=Ru(I);h.getOrCreateProgram("modelDepth",{defines:h._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(h,h.context.gl.TRIANGLES,T,s.ag.disabled,E,s.af.backCCW,k,y.id,m.vertexBuffer,m.indexBuffer,m.segments,y.paint,h.transform.zoom,void 0,void 0)}function Aa(m,r,h){const y=r.updateZoomBasedPaintProperties(),b=function(T,E,I){let k,N,H,X=T.terrain?T.terrain.exaggeration():0;if(T.terrain&&X>0){const ee=T.terrain,ie=ee.findDEMTileFor(I);ie&&ie.dem?k=s.ck.create(ee,I,ie):X=0}if(X===0&&(E.terrainElevationMin=0,E.terrainElevationMax=0),X===E.validForExaggeration&&(X===0||k&&k._demTile&&k._demTile.tileID===E.validForDEMTile.id&&k._dem._timestamp===E.validForDEMTile.timestamp))return!1;for(const ee in E.instancesPerModel){const ie=E.instancesPerModel[ee];for(let ue=0;ue<ie.instancedDataArray.length;++ue){const pe=(k?X*k.getElevationAt(0|ie.instancedDataArray.float32[16*ue],0|ie.instancedDataArray.float32[16*ue+1],!0,!0):0)+ie.instancesEvaluatedElevation[ue];ie.instancedDataArray.float32[16*ue+6]=pe,N=N?Math.min(E.terrainElevationMin,pe):pe,H=H?Math.max(E.terrainElevationMax,pe):pe}}return E.terrainElevationMin=N||0,E.terrainElevationMax=H||0,E.validForExaggeration=X,E.validForDEMTile=k&&k._demTile?{id:k._demTile.tileID,timestamp:k._dem._timestamp}:{id:void 0,timestamp:0},!0}(m,r,h);(y||b)&&(r.uploaded=!1,r.upload(m.context))}const al={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new s.b6([0,0,0],[s.a3,s.a3,0])};function $h(m,r){const h=1<<m.canonical.z,y=r.getFreeCameraOptions().position,b=r.elevation,T=m.canonical.x/h,E=(m.canonical.x+1)/h,I=m.canonical.y/h,k=(m.canonical.y+1)/h;let N=r._centerAltitude;if(b){const ie=b.getMinMaxForTile(m);ie&&ie.max>N&&(N=ie.max)}const H=s.at(y.x,T,E)-y.x,X=s.at(y.y,I,k)-y.y,ee=s.ax(N,r.center.lat)-y.z;return r._zoomFromMercatorZ(Math.sqrt(H*H+X*X+ee*ee))}function Qs(m,r,h,y,b,T,E){const I=m.context,k=m.renderPass==="shadow",N=m.shadowRenderer,H=k&&N?N.getShadowPassDepthMode():new s.ae(I.gl.LEQUAL,s.ae.ReadWrite,m.depthRangeFor3D),X=m.isTileAffectedByFog(T);if(h.meshes)for(const ee of h.meshes){const ie=["MODEL_POSITION_ON_GPU"],ue=[];let pe,fe,_e;y.instancedDataArray.length>20&&ie.push("INSTANCED_ARRAYS");const Le=Ka(m,r.paint.get("model-cutoff-fade-range"));if(Le.shouldRenderCutoff&&ie.push("RENDER_CUTOFF"),k&&N)pe=m.getOrCreateProgram("modelDepth",{defines:ie}),fe=Ru(E.shadowTileMatrix,E.shadowTileMatrix,Float32Array.from(h.matrix)),_e=N.getShadowPassColorMode();else{uh(ie,ue,ee,m,r.lut),pe=m.getOrCreateProgram("model",{defines:ie,overrideFog:X});const Be=ee.material,$e=Be.pbrMetallicRoughness,Ze=r.paint.get("model-opacity"),rt=r.paint.get("model-emissive-strength").constantOr(0);fe=Sd(T.expandedProjMatrix,Float32Array.from(h.matrix),new Float32Array(16),null,m,Ze,$e.baseColorFactor.toRenderColor(null),Be.emissiveFactor,$e.metallicFactor,$e.roughnessFactor,Be,rt,r,b),N&&(E.shadowUniformsInitialized?pe.setShadowUniformValues(I,N.getShadowUniformValues()):(N.setupShadows(T.toUnwrapped(),pe,"model-tile",T.overscaledZ),E.shadowUniformsInitialized=!0)),_e=Le.shouldRenderCutoff||Ze<1||Be.alphaMode!=="OPAQUE"?s.a.alphaBlended:s.a.unblended}m.uploadCommonUniforms(I,pe,T.toUnwrapped(),null,Le);const Fe=ee.material.doubleSided?s.af.disabled:s.af.backCCW;if(y.instancedDataArray.length>20)ue.push(y.instancedDataBuffer),pe.draw(m,I.gl.TRIANGLES,H,s.ag.disabled,_e,Fe,fe,r.id,ee.vertexBuffer,ee.indexBuffer,ee.segments,r.paint,m.transform.zoom,void 0,ue,y.instancedDataArray.length);else{const Be=k?"u_instance":"u_normal_matrix";for(let $e=0;$e<y.instancedDataArray.length;++$e)fe[Be]=new Float32Array(y.instancedDataArray.arrayBuffer,64*$e,16),pe.draw(m,I.gl.TRIANGLES,H,s.ag.disabled,_e,Fe,fe,r.id,ee.vertexBuffer,ee.indexBuffer,ee.segments,r.paint,m.transform.zoom,void 0,ue)}}if(h.children)for(const ee of h.children)Qs(m,r,ee,y,b,T,E)}const ll=[1,-1,1];function ac(m,r,h,y){if(!h.modelManager)return!0;const b=h.modelManager;if(!h.shadowRenderer)return!0;const T=h.shadowRenderer,E=r.aabb;let I=!0,k=m.maxHeight;if(k===0){let H=0;for(const X in m.instancesPerModel){const ee=b.getModel(X,y);ee?H=Math.max(H,Math.max(Math.max(ee.aabb.max[0],ee.aabb.max[1]),ee.aabb.max[2])):I=!1}k=m.maxScale*H*1.41+m.maxVerticalOffset,I&&(m.maxHeight=k)}E.max[2]=k,E.min[2]+=m.terrainElevationMin,E.max[2]+=m.terrainElevationMax,s._.transformMat4(E.min,E.min,r.tileMatrix),s._.transformMat4(E.max,E.max,r.tileMatrix);const N=E.intersects(T.getCurrentCascadeFrustum());return h.currentShadowCascade===0&&(m.isInsideFirstShadowMapFrustum=N===2),N===0}function _o(m,r){const h=m.uniformValues.u_cutoff_params[0],y=m.uniformValues.u_cutoff_params[1],b=m.uniformValues.u_cutoff_params[2],T=m.uniformValues.u_cutoff_params[3];return y===h||T===b?1:s.at(((r-h)/(y-h)-b)/(T-b),0,1)}function Cp(m,r,h,y){if(r.pitch<20)return 1;const b=r.getWorldToCameraMatrix(),T=s.ad.multiply([],b,m),E=[...h.min,1];let I=s.aA.transformMat4([],E,T),k=I,N=I;E[1]=h.max[1],I=s.aA.transformMat4([],E,T),k=I[1]<k[1]?I:k,N=I[1]>N[1]?I:N,E[0]=h.max[0],I=s.aA.transformMat4([],E,T),k=I[1]<k[1]?I:k,N=I[1]>N[1]?I:N,E[1]=h.min[1],I=s.aA.transformMat4([],E,T),k=I[1]<k[1]?I:k,N=I[1]>N[1]?I:N;const H=s.at(y[0],0,1),X=100*r.pixelsPerMeter*s.at(y[1],0,1),ee=s.at(y[2],0,1),ie=s._.lerp([],k,N,H),ue=Math.tan(.5*r.fovX),pe=-ie[2]*ue;if(X===0)return ie[1]<-Math.abs(pe)?ee:1;const fe=(-Math.abs(pe)-ie[1])/X,_e=(Fe,Be,$e)=>(1-$e)*Fe+$e*Be,Le=s.at(_e(1,ee,fe),ee,1);return _e(1,Le,s.at((r.pitch-20)/20,0,1))}class cl{}class Uu{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(r,h,y){{const X=this._storage.get(h.id);if(X)return X.lastUsedFrameIdx=r,X.buf}const b=y.gl,T=b.getBufferParameter(b.ELEMENT_ARRAY_BUFFER,b.BUFFER_SIZE),E=new ArrayBuffer(T),I=new Int16Array(E);b.getBufferSubData(b.ELEMENT_ARRAY_BUFFER,0,new Int16Array(E));const k=new s.cm;for(let X=0;X<T/2;X+=3){const ee=I[X],ie=I[X+1],ue=I[X+2];k.emplaceBack(ee,ie),k.emplaceBack(ie,ue),k.emplaceBack(ue,ee)}const N=y.bindVertexArrayOES.current,H=new cl;return H.buf=new s.I(y,k),H.lastUsedFrameIdx=r,this._storage.set(h.id,H),y.bindVertexArrayOES.set(N),H.buf}update(r){for(const[h,y]of this._storage)r-y.lastUsedFrameIdx>30&&(y.buf.destroy(),this._storage.delete(h))}destroy(){for(const[r,h]of this._storage)h.buf.destroy(),this._storage.delete(r)}}const Vu=s.c7([{type:"Float32",name:"a_offset_xy",components:2}]);class dh{constructor(r){const h=new s.cn,y=new s.bu;h.emplaceBack(-1,-1),h.emplaceBack(1,-1),h.emplaceBack(1,1),h.emplaceBack(-1,1),y.emplaceBack(0,1,2),y.emplaceBack(0,2,3),this.segments=s.b.simpleSegment(0,0,h.length,y.length),this.vx=r.createVertexBuffer(h,Vu.members),this.idx=r.createIndexBuffer(y)}destroy(){this.vx.destroy(),this.idx.destroy()}}const Lp={symbol:function(m,r,h,y,b){if(m.renderPass!=="translucent")return;const T=s.ag.disabled,E=m.colorModeForRenderPass();h.layout.get("text-variable-anchor")&&function(N,H,X,ee,ie,ue,pe){const fe=H.transform,_e=ie==="map",Le=ue==="map";for(const Fe of N){const Be=ee.getTile(Fe),$e=Be.getBucket(X);if(!$e||!$e.text||!$e.text.segments.get().length)continue;const Ze=s.aD($e.textSizeData,fe.zoom),rt=zu(Fe,$e.getProjection(),fe),xe=fe.calculatePixelsToTileUnitsMatrix(Be),Ne=pn(rt,Be.tileID.canonical,Le,_e,fe,$e.getProjection(),xe),ct=$e.hasIconTextFit()&&$e.hasIconData();if(Ze){const Ot=Math.pow(2,fe.zoom-Be.tileID.overscaledZ);Xf($e,_e,Le,pe,s.bO,fe,Ne,Fe,Ot,Ze,ct)}}}(y,m,h,r,h.layout.get("text-rotation-alignment"),h.layout.get("text-pitch-alignment"),b);const I=h.paint.get("icon-opacity").constantOr(1)!==0,k=h.paint.get("text-opacity").constantOr(1)!==0;h.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(I||k)?Ou(m,r,h,y,T,E):(I&&Ou(m,r,h,y,T,E,{onlyIcons:!0}),k&&Ou(m,r,h,y,T,E,{onlyText:!0}),function(N,H,X,ee){if(!N.symbolParams.useOcclusionQueries)return;const ie=N.context.gl,ue=N.transform,pe=X.paint,fe=pe.get("icon-occlusion-opacity").constantOr(0),_e=pe.get("text-occlusion-opacity").constantOr(0);if(!X.hasInitialOcclusionOpacityProperties||fe===1&&_e===1)return;const Le=ue.projection.name==="globe";for(const Fe of ee){const Be=H.getTile(Fe),$e=Be.getBucket(X);if(!$e||$e.projection.name==="mercator"&&Le||$e.fullyClipped)continue;if($e.projection.name==="globe"){s.w(`Occlusion not supported for globe mode. Layer: ${X.type}`);continue}const Ze=zu(Fe,$e.getProjection(),ue),rt=s.ad.fromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,N.symbolParams.depthOffset,1),xe=s.ad.multiply([],rt,Ze),Ne=N.symbolParams.visualizeOcclusions!=="none"?1:N.symbolParams.occlusionQueryFrameWindow;for(let ct=0;ct<$e.symbolInstances.length;ct++){const Ot=$e.symbolInstances.get(ct),mt=N.style.placement.opacities[Ot.crossTileID];if(mt&&mt.isHidden()||(N.frameCounter+ct)%Ne!=0)continue;const it=Ot.tileAnchorX,Nt=Ot.tileAnchorY,mi=Ot.zOffset;let _i;if(N.symbolParams.visualizeOcclusions==="none"){const $i=$e.queries.get(ct);if($i){if(!$i.isFree()){if(!$i.isResultAvailable())continue;const Yi=$i.consumeResult();Ot.occlusionState=Yi===0?0:1;continue}_i=$i}else _i=new Dn(N.context),$e.queries.set(ct,_i)}const hi=N.getOrCreateProgram("occlusion"),vt=N.symbolParams.occluderSize,Gt=Ed(xe,[it,Nt,mi],[ue.width,ue.height],[vt,vt],N.symbolParams.visualizeOcclusions==="zPass"?[1,0,0,.8]:[1,.4,.2,.9]);N.terrain&&N.terrain.setupElevationDraw(Be,hi,{useDepthForOcclusion:!1,labelPlaneMatrixInv:void 0}),N.symbolParams.visualizeOcclusions==="none"&&_i&&_i.begin();const ri=new s.ae(N.symbolParams.visualizeOcclusions==="zPass"?N.context.gl.ALWAYS:N.context.gl.LEQUAL,s.ae.ReadOnly,N.depthRangeFor3D);hi.draw(N,ie.TRIANGLES,ri,s.ag.disabled,N.symbolParams.visualizeOcclusions!=="none"?s.a.alphaBlendedNonPremultiplied:s.a.disabled,s.af.disabled,Gt,"occlusion",N.occlusionBuffers.vx,N.occlusionBuffers.idx,N.occlusionBuffers.segments),N.symbolParams.visualizeOcclusions==="none"&&_i&&_i.end()}}}(m,r,h,y)),r.map.showCollisionBoxes&&(Tp(m,r,h,y,h.paint.get("text-translate"),h.paint.get("text-translate-anchor"),!0),Tp(m,r,h,y,h.paint.get("icon-translate"),h.paint.get("icon-translate-anchor"),!1))},circle:function(m,r,h,y){if(m.renderPass!=="translucent")return;const b=h.paint.get("circle-opacity"),T=h.paint.get("circle-stroke-width"),E=h.paint.get("circle-stroke-opacity"),I=h.layout.get("circle-sort-key").constantOr(1)!==void 0,k=h.paint.get("circle-emissive-strength");if(b.constantOr(1)===0&&(T.constantOr(1)===0||E.constantOr(1)===0))return;const N=m.context,H=N.gl,X=m.transform,ee=m.depthModeForSublayer(0,s.ae.ReadOnly),ie=s.ag.disabled,ue=m.colorModeForDrapableLayerRenderPass(k),pe=X.projection.name==="globe",fe=[s.aj(X.center.lng),s.ak(X.center.lat)],_e=[];for(let Fe=0;Fe<y.length;Fe++){const Be=y[Fe],$e=r.getTile(Be),Ze=$e.getBucket(h);if(!Ze||Ze.projection.name!==X.projection.name)continue;const rt=Ze.programConfigurations.get(h.id),xe=s.bR(h),Ne=m.isTileAffectedByFog(Be);pe&&xe.push("PROJECTION_GLOBE_VIEW"),xe.push("TERRAIN_DEPTH_D24");const ct=m.getOrCreateProgram("circle",{config:rt,defines:xe,overrideFog:Ne}),Ot=Ze.layoutVertexBuffer,mt=Ze.globeExtVertexBuffer,it=Ze.indexBuffer,Nt=X.projection.createInversionMatrix(X,Be.canonical),mi={programConfiguration:rt,program:ct,layoutVertexBuffer:Ot,globeExtVertexBuffer:mt,indexBuffer:it,uniformValues:s.bS(m,Be,$e,Nt,fe,h),tile:$e};if(I){const _i=Ze.segments.get();for(const hi of _i)_e.push({segments:new s.b([hi]),sortKey:hi.sortKey,state:mi})}else _e.push({segments:Ze.segments,sortKey:0,state:mi})}I&&_e.sort((Fe,Be)=>Fe.sortKey-Be.sortKey);const Le={useDepthForOcclusion:X.depthOcclusionForSymbolsAndCircles};for(const Fe of _e){const{programConfiguration:Be,program:$e,layoutVertexBuffer:Ze,globeExtVertexBuffer:rt,indexBuffer:xe,uniformValues:Ne,tile:ct}=Fe.state,Ot=Fe.segments;m.terrain&&m.terrain.setupElevationDraw(ct,$e,Le),m.uploadCommonUniforms(N,$e,ct.tileID.toUnwrapped()),$e.draw(m,H.TRIANGLES,ee,ie,ue,s.af.disabled,Ne,h.id,Ze,xe,Ot,h.paint,X.zoom,Be,[rt])}},heatmap:function(m,r,h,y){if(h.paint.get("heatmap-opacity")!==0)if(m.renderPass==="offscreen"){const b=m.context,T=b.gl,E=s.ag.disabled,I=new s.a([T.ONE,T.ONE,T.ONE,T.ONE],s.C.transparent,[!0,!0,!0,!0]);(function(ie,ue,pe,fe){const _e=ie.gl,Le=ue.width*fe,Fe=ue.height*fe;ie.activeTexture.set(_e.TEXTURE1),ie.viewport.set([0,0,Le,Fe]);let Be=pe.heatmapFbo;if(!Be||Be&&(Be.width!==Le||Be.height!==Fe)){Be&&Be.destroy();const $e=_e.createTexture();_e.bindTexture(_e.TEXTURE_2D,$e),_e.texParameteri(_e.TEXTURE_2D,_e.TEXTURE_WRAP_S,_e.CLAMP_TO_EDGE),_e.texParameteri(_e.TEXTURE_2D,_e.TEXTURE_WRAP_T,_e.CLAMP_TO_EDGE),_e.texParameteri(_e.TEXTURE_2D,_e.TEXTURE_MIN_FILTER,_e.LINEAR),_e.texParameteri(_e.TEXTURE_2D,_e.TEXTURE_MAG_FILTER,_e.LINEAR),Be=pe.heatmapFbo=ie.createFramebuffer(Le,Fe,!0,null),function(Ze,rt,xe,Ne,ct,Ot){const mt=Ze.gl;mt.texImage2D(mt.TEXTURE_2D,0,Ze.extRenderToTextureHalfFloat?mt.RGBA16F:mt.RGBA,ct,Ot,0,mt.RGBA,Ze.extRenderToTextureHalfFloat?mt.HALF_FLOAT:mt.UNSIGNED_BYTE,null),Ne.colorAttachment.set(xe)}(ie,0,$e,Be,Le,Fe)}else _e.bindTexture(_e.TEXTURE_2D,Be.colorAttachment.get()),ie.bindFramebuffer.set(Be.framebuffer)})(b,m,h,m.transform.projection.name==="globe"?.5:.25),b.clear({color:s.C.transparent});const k=m.transform,N=k.projection.name==="globe",H=N?["PROJECTION_GLOBE_VIEW"]:[],X=N?s.af.frontCCW:s.af.disabled,ee=[s.aj(k.center.lng),s.ak(k.center.lat)];for(let ie=0;ie<y.length;ie++){const ue=y[ie];if(r.hasRenderableParent(ue))continue;const pe=r.getTile(ue),fe=pe.getBucket(h);if(!fe||fe.projection.name!==k.projection.name)continue;const _e=m.isTileAffectedByFog(ue),Le=fe.programConfigurations.get(h.id),Fe=m.getOrCreateProgram("heatmap",{config:Le,defines:H,overrideFog:_e}),{zoom:Be}=m.transform;m.terrain&&m.terrain.setupElevationDraw(pe,Fe),m.uploadCommonUniforms(b,Fe,ue.toUnwrapped());const $e=k.projection.createInversionMatrix(k,ue.canonical);Fe.draw(m,T.TRIANGLES,s.ae.disabled,E,I,X,tc(m,ue,pe,$e,ee,Be,h.paint.get("heatmap-intensity")),h.id,fe.layoutVertexBuffer,fe.indexBuffer,fe.segments,h.paint,m.transform.zoom,Le,N?[fe.globeExtVertexBuffer]:null)}b.viewport.set([0,0,m.width,m.height])}else m.renderPass==="translucent"&&(m.context.setColorMode(m.colorModeForRenderPass()),function(b,T){const E=b.context,I=E.gl,k=T.heatmapFbo;if(!k)return;E.activeTexture.set(I.TEXTURE0),I.bindTexture(I.TEXTURE_2D,k.colorAttachment.get()),E.activeTexture.set(I.TEXTURE1);let N=T.colorRampTexture;N||(N=T.colorRampTexture=new s.T(E,T.colorRamp,I.RGBA)),N.bind(I.LINEAR,I.CLAMP_TO_EDGE),b.getOrCreateProgram("heatmapTexture").draw(b,I.TRIANGLES,s.ae.disabled,s.ag.disabled,b.colorModeForRenderPass(),s.af.disabled,((H,X,ee,ie)=>({u_image:0,u_color_ramp:1,u_opacity:X.paint.get("heatmap-opacity")}))(0,T),T.id,b.viewportBuffer,b.quadTriangleIndexBuffer,b.viewportSegments,T.paint,b.transform.zoom)}(m,h))},line:function(m,r,h,y){if(m.renderPass!=="translucent")return;const b=h.paint.get("line-opacity"),T=h.paint.get("line-width");if(b.constantOr(1)===0||T.constantOr(1)===0)return;const E=h.paint.get("line-emissive-strength"),I=h.paint.get("line-occlusion-opacity"),k=m.context,N=k.gl,H=h.layout.get("line-z-offset"),X=!H.isConstant()||!!H.constantOr(0),ee=X?new s.ae(m.depthOcclusion?N.GREATER:N.LEQUAL,s.ae.ReadOnly,m.depthRangeFor3D):m.depthModeForSublayer(0,s.ae.ReadOnly),ie=m.colorModeForDrapableLayerRenderPass(E),ue=m.terrain&&m.terrain.renderingToTexture,pe=ue?1:s.e.devicePixelRatio,fe=h.paint.get("line-dasharray"),_e=fe.constantOr(1),Le=h.layout.get("line-cap"),Fe=fe.constantOr(null),Be=Le.constantOr(null),$e=h.paint.get("line-pattern"),Ze=$e.constantOr(1),rt=$e.constantOr(null),xe=h.paint.get("line-opacity").constantOr(1);let Ne=!Ze&&xe!==1||m.depthOcclusion&&I>0&&I<1;const ct=h.paint.get("line-gradient"),Ot=Ze?"linePattern":"line",mt=s.bT(h);let it;if(ue&&m.terrain&&m.terrain.clipOrMaskOverlapStencilType()&&(Ne=!1),I!==0&&m.depthOcclusion){const mi=h.paint._values["line-opacity"];mi&&mi.value&&mi.value.kind==="constant"?it=mi.value:s.w(`Occlusion opacity for layer ${h.id} is supported only when line-opacity isn't data-driven.`)}if(X&&(m.forceTerrainMode=!0),!X&&I!==0&&m.terrain&&!ue)return void s.w(`Occlusion opacity for layer ${h.id} is supported on terrain only if the layer has non-zero line-z-offset.`);const Nt=Ne&&X?m.stencilModeFor3D():s.ag.disabled;for(const mi of y){const _i=r.getTile(mi);if(Ze&&!_i.patternsLoaded())continue;const hi=_i.getBucket(h);if(!hi)continue;m.prepareDrawTile();const vt=hi.programConfigurations.get(h.id),Gt=m.isTileAffectedByFog(mi),ri=m.getOrCreateProgram(Ot,{config:vt,defines:X?[...mt,"ELEVATED"]:mt,overrideFog:Gt});if(rt&&_i.imageAtlas){const Qt=_i.imageAtlas.patternPositions[rt.toString()];Qt&&vt.setConstantPatternPositions(Qt)}if(!Ze&&Fe&&Be&&_i.lineAtlas){const Qt=_i.lineAtlas.getDash(Fe,Be);Qt&&vt.setConstantPatternPositions(Qt)}let[$i,Yi]=h.paint.get("line-trim-offset");(Be==="round"||Be==="square")&&$i!==Yi&&($i===0&&($i-=1),Yi===1&&(Yi+=1));const hn=ue?mi.projMatrix:null,Ji=Ze?s.bU(m,_i,h,hn,pe,[$i,Yi]):s.bV(m,_i,h,hn,hi.lineClipsArray.length,pe,[$i,Yi]);if(ct){const Qt=hi.gradients[h.id];let xn=Qt.texture;if(h.gradientVersion!==Qt.version){let Tr=256;if(h.stepInterpolant){const Wn=r.getSource().maxzoom,cr=mi.canonical.z===Wn?Math.ceil(1<<m.transform.maxZoom-mi.canonical.z):1;Tr=s.at(s.bW(hi.maxLineLength/s.a3*1024*cr),256,k.maxTextureSize)}Qt.gradient=s.bX({expression:h.gradientExpression(),evaluationKey:"lineProgress",resolution:Tr,image:Qt.gradient||void 0,clips:hi.lineClipsArray}),Qt.texture?Qt.texture.update(Qt.gradient):Qt.texture=new s.T(k,Qt.gradient,N.RGBA),Qt.version=h.gradientVersion,xn=Qt.texture}k.activeTexture.set(N.TEXTURE1),xn.bind(h.stepInterpolant?N.NEAREST:N.LINEAR,N.CLAMP_TO_EDGE)}_e&&(k.activeTexture.set(N.TEXTURE0),_i.lineAtlasTexture&&_i.lineAtlasTexture.bind(N.LINEAR,N.REPEAT),vt.updatePaintBuffers()),Ze&&(k.activeTexture.set(N.TEXTURE0),_i.imageAtlasTexture&&_i.imageAtlasTexture.bind(N.LINEAR,N.CLAMP_TO_EDGE),vt.updatePaintBuffers()),X&&m.terrain.setupElevationDraw(_i,ri),m.uploadCommonUniforms(k,ri,mi.toUnwrapped());const Gi=Qt=>{it!=null&&(it.value=xe*I),ri.draw(m,N.TRIANGLES,ee,Qt,ie,s.af.disabled,Ji,h.id,hi.layoutVertexBuffer,hi.indexBuffer,hi.segments,h.paint,m.transform.zoom,vt,[hi.layoutVertexBuffer2,hi.patternVertexBuffer,hi.zOffsetVertexBuffer]),it!=null&&(it.value=xe)};if(Ne&&!X){const Qt=m.stencilModeForClipping(mi).ref;Qt===0&&ue&&k.clear({stencil:0});const xn={func:N.EQUAL,mask:255};Ji.u_alpha_discard_threshold=.8,Gi(new s.ag(xn,Qt,255,N.KEEP,N.KEEP,N.INVERT)),Ji.u_alpha_discard_threshold=0,Gi(new s.ag(xn,Qt,255,N.KEEP,N.KEEP,N.KEEP))}else Ne&&X&&(Ji.u_alpha_discard_threshold=.001),Gi(X?Nt:m.stencilModeForClipping(mi))}Ne&&(m.resetStencilClippingMasks(),ue&&k.clear({stencil:0})),I===0||m.depthOcclusion||ue||m.layersWithOcclusionOpacity.push(m.currentLayer),X&&(m.forceTerrainMode=!1)},fill:function(m,r,h,y){const b=h.paint.get("fill-color"),T=h.paint.get("fill-opacity");if(T.constantOr(1)===0)return;const E=h.paint.get("fill-emissive-strength"),I=m.colorModeForDrapableLayerRenderPass(E),k=h.paint.get("fill-pattern"),N=m.opaquePassEnabledForLayer()&&!k.constantOr(1)&&b.constantOr(s.C.transparent).a===1&&T.constantOr(0)===1?"opaque":"translucent";if(m.renderPass===N){const H=m.depthModeForSublayer(1,m.renderPass==="opaque"?s.ae.ReadWrite:s.ae.ReadOnly);Fu(m,r,h,y,H,I,!1)}if(m.renderPass==="translucent"&&h.paint.get("fill-antialias")){const H=m.depthModeForSublayer(h.getPaintProperty("fill-outline-color")?2:0,s.ae.ReadOnly);Fu(m,r,h,y,H,I,!0)}},"fill-extrusion":function(m,r,h,y){const b=h.paint.get("fill-extrusion-opacity"),T=m.context,E=T.gl,I=m.terrain,k=I&&I.renderingToTexture;if(b===0)return;const N=m.conflationActive&&m.style.isLayerClipped(h,r.getSource()),H=m.style.order.indexOf(h.fqid);if(N&&function(X,ee,ie,ue,pe){for(const fe of ue){const _e=ee.getTile(fe).getBucket(ie);_e&&(_e.updateReplacement(fe,X.replacementSource,pe),_e.uploadCentroid(X.context))}}(m,r,h,y,H),I||N)for(const X of y){const ee=r.getTile(X).getBucket(h);ee&&Ep(m.context,r,X,ee,h,I,N)}if(m.renderPass==="shadow"&&m.shadowRenderer){const X=m.shadowRenderer;if(I&&b<.65&&h._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof s.Z)return;const ee=X.getShadowPassDepthMode(),ie=X.getShadowPassColorMode();pa(m,r,h,y,ee,s.ag.disabled,ie,N)}else if(m.renderPass==="translucent"){const X=!h.paint.get("fill-extrusion-pattern").constantOr(1),ee=h.paint.get("fill-extrusion-color").constantOr(s.C.white);if(!k&&ee.a!==0){const ie=new s.ae(m.context.gl.LEQUAL,s.ae.ReadWrite,m.depthRangeFor3D);b===1&&X?pa(m,r,h,y,ie,s.ag.disabled,s.a.unblended,N):(pa(m,r,h,y,ie,s.ag.disabled,s.a.disabled,N),pa(m,r,h,y,ie,m.stencilModeFor3D(),m.colorModeForRenderPass(),N),m.resetStencilClippingMasks())}if(m.style.enable3dLights()&&X&&(!I&&m.transform.projection.name!=="globe"||k)){const ie=h.paint.get("fill-extrusion-opacity"),ue=h.paint.get("fill-extrusion-ambient-occlusion-intensity"),pe=h.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),fe=h.paint.get("fill-extrusion-flood-light-intensity"),_e=h.paint.get("fill-extrusion-flood-light-color").toRenderColor(h.lut).toArray01().slice(0,3),Le=ue>0&&pe>0,Fe=fe>0,Be=(Ze,rt,xe)=>(1-xe)*Ze+xe*rt,$e=Ze=>{const rt=m.depthModeForSublayer(1,s.ae.ReadOnly,E.LEQUAL,!0),xe=h.paint.get(Ze?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Ne=Be(.1,3,xe),ct=m._showOverdrawInspector;if(!ct){const Ot=new s.ag({func:E.ALWAYS,mask:255},255,255,E.KEEP,E.KEEP,E.REPLACE),mt=new s.a([E.ONE,E.ONE,E.ONE,E.ONE],s.C.transparent,[!1,!1,!1,!0],E.MIN);Na(m,r,h,y,rt,Ot,mt,s.af.disabled,Ze,"sdf",ie,ue,pe,fe,_e,Ne,N,!1)}{const Ot=ct?s.ag.disabled:new s.ag({func:E.EQUAL,mask:255},255,255,E.KEEP,E.DECR,E.DECR),mt=ct?m.colorModeForRenderPass():new s.a([E.ONE_MINUS_DST_ALPHA,E.DST_ALPHA,E.ONE,E.ONE],s.C.transparent,[!0,!0,!0,!0]);Na(m,r,h,y,rt,Ot,mt,s.af.disabled,Ze,"color",ie,ue,pe,fe,_e,Ne,N,!1)}};if(k){const Ze=(rt,xe,Ne)=>{const ct=m.depthModeForSublayer(1,s.ae.ReadOnly,E.LEQUAL,!1),Ot=h.paint.get(rt?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),mt=Be(.1,3,Ot);{const it=new s.a([E.ONE,E.ONE,E.ONE,E.ONE],s.C.transparent,[!1,!1,!1,!0]);Na(m,r,h,y,ct,s.ag.disabled,it,s.af.disabled,rt,"clear",ie,ue,pe,fe,_e,mt,N,xe)}{const it=new s.ag({func:E.ALWAYS,mask:255},255,255,E.KEEP,E.KEEP,E.REPLACE),Nt=new s.a([E.ONE,E.ONE,E.ONE,E.ONE],s.C.transparent,[!1,!1,!1,!0],E.MIN);Na(m,r,h,y,ct,it,Nt,s.af.disabled,rt,"sdf",ie,ue,pe,fe,_e,mt,N,xe)}{const it=rt?E.ZERO:E.ONE_MINUS_DST_ALPHA,Nt=new s.ag({func:E.EQUAL,mask:255},255,255,E.KEEP,E.DECR,E.DECR),mi=new s.a([it,E.DST_ALPHA,E.ONE_MINUS_DST_ALPHA,E.ZERO],s.C.transparent,[!0,!0,!0,!0]);Na(m,r,h,y,ct,Nt,mi,s.af.disabled,rt,"color",ie,ue,pe,fe,_e,mt,N,xe)}{const it=new s.a([E.ONE,E.ONE,E.ONE,rt?E.ZERO:E.ONE],s.C.transparent,[!1,!1,!1,!0],rt?E.FUNC_ADD:E.MAX);Na(m,r,h,y,ct,s.ag.disabled,it,s.af.disabled,rt,"clear",ie,ue,pe,fe,_e,mt,N,xe,Ne)}};if(Le||Fe){let rt;if(m.prepareDrawTile(),I){const xe=I.drapeBufferSize[0],Ne=I.drapeBufferSize[1];rt=I.framebufferCopyTexture,rt&&(!rt||rt.size[0]===xe&&rt.size[1]===Ne)||(rt&&rt.destroy(),rt=I.framebufferCopyTexture=new s.T(T,new s.i({width:xe,height:Ne}),E.RGBA)),rt.bind(E.LINEAR,E.CLAMP_TO_EDGE),E.copyTexImage2D(E.TEXTURE_2D,0,E.RGBA,0,0,xe,Ne,0)}Le&&Ze(!0,!1,rt),Fe&&Ze(!1,!0,rt)}}else Le&&$e(!0),Fe&&$e(!1)}}},hillshade:function(m,r,h,y){if(m.renderPass!=="offscreen"&&m.renderPass!=="translucent"||m.style.disableElevatedTerrain)return;const b=m.context,T=m.terrain&&m.terrain.renderingToTexture,[E,I]=m.renderPass!=="translucent"||T?[{},y]:m.stencilConfigForOverlap(y);for(const k of I){const N=r.getTile(k);if(N.needsHillshadePrepare&&m.renderPass==="offscreen")yi(m,N,h);else if(m.renderPass==="translucent"){const H=m.depthModeForSublayer(0,s.ae.ReadOnly),X=h.paint.get("hillshade-emissive-strength"),ee=m.colorModeForDrapableLayerRenderPass(X),ie=T&&m.terrain?m.terrain.stencilModeForRTTOverlap(k):E[k.overscaledZ];Sn(m,k,N,h,H,ie,ee)}}b.viewport.set([0,0,m.width,m.height]),m.resetStencilClippingMasks()},raster:function(m,r,h,y,b,T){if(m.renderPass!=="translucent"||h.paint.get("raster-opacity")===0)return;const E=m.transform.projection.name==="globe",I=h.paint.get("raster-elevation")!==0,k=I&&E;if(m.renderElevatedRasterBackface&&!k)return;const N=m.context,H=N.gl,X=r.getSource(),ee=function(Ze,rt,xe,Ne){const ct=rt.paint.get("raster-color"),Ot=Ze.type==="raster-array",mt=[],it=rt.paint.get("raster-resampling"),Nt=rt.paint.get("raster-color-mix");let mi=rt.paint.get("raster-color-range");const _i=[Nt[0],Nt[1],Nt[2],0],hi=Nt[3];let vt=it==="nearest"?Ne.NEAREST:Ne.LINEAR;if(Ot&&(mt.push("RASTER_ARRAY"),ct||mt.push("RASTER_COLOR"),it==="linear"&&mt.push("RASTER_ARRAY_LINEAR"),vt=Ne.NEAREST,!mi&&Ze.rasterLayers)){const Gt=Ze.rasterLayers.find(({id:ri})=>ri===rt.sourceLayer);Gt&&Gt.fields&&Gt.fields.range&&(mi=Gt.fields.range)}if(mi=mi||[0,1],ct){mt.push("RASTER_COLOR"),xe.activeTexture.set(Ne.TEXTURE2),rt.updateColorRamp(mi);let Gt=rt.colorRampTexture;Gt||(Gt=rt.colorRampTexture=new s.T(xe,rt.colorRamp,Ne.RGBA)),Gt.bind(Ne.LINEAR,Ne.CLAMP_TO_EDGE)}return{mix:_i,range:mi,offset:hi,defines:mt,resampling:vt}}(X,h,N,H);if(X instanceof s.bm&&!y.length&&!E)return;const ie=h.paint.get("raster-emissive-strength"),ue=m.colorModeForDrapableLayerRenderPass(ie),pe=m.terrain&&m.terrain.renderingToTexture,fe=!m.options.moving,_e=h.paint.get("raster-resampling")==="nearest"?H.NEAREST:H.LINEAR;if(X instanceof s.bm&&!y.length&&(X.onNorthPole||X.onSouthPole)){const Ze=I?m.stencilModeFor3D():s.ag.disabled;return void qh(!!X.onNorthPole,null,m,r,h,ie,ee,s.af.disabled,Ze)}if(!y.length)return;const[Le,Fe]=X instanceof s.bm||pe?[{},y]:m.stencilConfigForOverlap(y),Be=Fe[Fe.length-1].overscaledZ;k&&ee.defines.push("PROJECTION_GLOBE_VIEW"),I&&ee.defines.push("RENDER_CUTOFF");const $e=(Ze,rt,xe)=>{for(const Ne of Ze){const ct=Ne.toUnwrapped(),Ot=r.getTile(Ne);if(pe&&(!Ot||!Ot.hasData()))continue;N.activeTexture.set(H.TEXTURE0);const mt=Yr(Ot,X,h,ee);if(!mt||!mt.texture)continue;const{texture:it,mix:Nt,offset:mi,tileSize:_i,buffer:hi}=mt;let vt,Gt;pe?(vt=s.ae.disabled,Gt=Ne.projMatrix):I?(vt=new s.ae(H.LEQUAL,s.ae.ReadWrite,m.depthRangeFor3D),Gt=E?Float32Array.from(m.transform.expandedFarZProjMatrix):m.transform.calculateProjMatrix(ct,fe)):(vt=m.depthModeForSublayer(Ne.overscaledZ-Be,h.paint.get("raster-opacity")===1?s.ae.ReadWrite:s.ae.ReadOnly,H.LESS),Gt=m.transform.calculateProjMatrix(ct,fe));const ri=m.terrain&&pe?m.terrain.stencilModeForRTTOverlap(Ne):Le[Ne.overscaledZ],$i=T?0:h.paint.get("raster-fade-duration");Ot.registerFadeDuration($i);const Yi=r.findLoadedParent(Ne,0),hn=sh(Ot,Yi,r,m.transform,$i);let Ji,Gi;m.terrain&&m.terrain.prepareDrawTile(),N.activeTexture.set(H.TEXTURE0),it.bind(_e,H.CLAMP_TO_EDGE),N.activeTexture.set(H.TEXTURE1),Yi?(Yi.texture&&Yi.texture.bind(_e,H.CLAMP_TO_EDGE),Ji=Math.pow(2,Yi.tileID.overscaledZ-Ot.tileID.overscaledZ),Gi=[Ot.tileID.canonical.x*Ji%1,Ot.tileID.canonical.y*Ji%1]):it.bind(_e,H.CLAMP_TO_EDGE),it.useMipmap&&N.extTextureFilterAnisotropic&&m.transform.pitch>20&&H.texParameterf(H.TEXTURE_2D,N.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,N.extTextureFilterAnisotropicMax);const Qt=m.transform;let xn;const Tr=I?Ap(Qt):[0,0,0,0];let Wn,cr,er,xs,zr,ir=0;if(k&&X instanceof s.bm&&X.coordinates.length>3)Wn=Float32Array.from(s.bf(s.bg(new s.aO(0,0,0)))),cr=Float32Array.from(Qt.globeMatrix),er=Float32Array.from(s.bb(Qt)),xs=[s.aj(Qt.center.lng),s.ak(Qt.center.lat)],xn=X.elevatedGlobePerspectiveTransform,zr=X.elevatedGlobeGridMatrix||new Float32Array(9);else if(k){const dr=s.bc(Ne.canonical);ir=s.bd(dr.getCenter().lat),Wn=Float32Array.from(s.bf(s.bg(Ne.canonical))),cr=Float32Array.from(Qt.globeMatrix),er=Float32Array.from(s.bb(Qt)),xs=[s.aj(Qt.center.lng),s.ak(Qt.center.lat)],xn=[0,0],zr=Float32Array.from(s.be(Ne.canonical,dr,ir,Qt.worldSize/Qt._pixelsPerMercatorPixel))}else xn=X instanceof s.bm?X.perspectiveTransform:[0,0],Wn=new Float32Array(16),cr=new Float32Array(9),er=new Float32Array(16),xs=[0,0],zr=new Float32Array(9);const ls=nc(Gt,Wn,cr,er,zr,Gi||[0,0],s.a1(m.transform.zoom),xs,Tr,Ji||1,hn,h,xn,I?h.paint.get("raster-elevation"):0,2,Nt,mi,ee.range,_i,hi,ie),Zr=m.isTileAffectedByFog(Ne),Or=m.getOrCreateProgram("raster",{defines:ee.defines,overrideFog:Zr});if(m.uploadCommonUniforms(N,Or,ct),X instanceof s.bm){const dr=X.elevatedGlobeVertexBuffer,hs=X.elevatedGlobeIndexBuffer;if(pe||!E)X.boundsBuffer&&X.boundsSegments&&Or.draw(m,H.TRIANGLES,vt,s.ag.disabled,ue,s.af.disabled,ls,h.id,X.boundsBuffer,m.quadTriangleIndexBuffer,X.boundsSegments);else if(dr&&hs){const ks=Qt.zoom<=s.b1?X.elevatedGlobeSegments:X.getSegmentsForLongitude(Qt.center.lng);ks&&Or.draw(m,H.TRIANGLES,vt,s.ag.disabled,ue,rt,ls,h.id,dr,hs,ks)}}else if(k){vt=new s.ae(H.LEQUAL,s.ae.ReadOnly,m.depthRangeFor3D);const dr=m.globeSharedBuffers;if(dr){const[hs,ks,Ur]=dr.getGridBuffers(ir,!1);Or.draw(m,H.TRIANGLES,vt,xe||ri,m.colorModeForRenderPass(),rt,ls,h.id,hs,ks,Ur)}}else{const{tileBoundsBuffer:dr,tileBoundsIndexBuffer:hs,tileBoundsSegments:ks}=m.getTileBoundsBuffers(Ot);Or.draw(m,H.TRIANGLES,vt,ri,ue,s.af.disabled,ls,h.id,dr,hs,ks)}}if(!(X instanceof s.bm)&&k)for(const Ne of Ze){const ct=Ne.canonical.y===(1<<Ne.canonical.z)-1;Ne.canonical.y===0&&qh(!0,Ne,m,r,h,ie,ee,rt,xe||s.ag.disabled),ct&&qh(!1,Ne,m,r,h,ie,ee,rt===s.af.frontCW?s.af.backCW:s.af.frontCW,xe||s.ag.disabled)}};k?$e(Fe,m.renderElevatedRasterBackface?s.af.backCW:s.af.frontCW,m.stencilModeFor3D()):$e(Fe,s.af.disabled,void 0),m.resetStencilClippingMasks()},"raster-particle":function(m,r,h,y,b,T){m.renderPass==="offscreen"&&function(E,I,k,N){if(!N.length)return;const H=E.context,X=H.gl,ee=I.getSource();if(!(ee instanceof Kl))return;const ie=Math.ceil(Math.sqrt(k.paint.get("raster-particle-count")));let ue=k.particlePositionRGBAImage;if(!ue||ue.width!==ie){const Fe=function(Be){const $e=Be*Be,Ze=new Uint8Array(4*$e),rt=function(Ne){return Ne|=0,Ne=Math.imul(2747636419^Ne,2654435769),Ne=Math.imul(Ne^Ne>>>16,2654435769),((Ne=Math.imul(Ne^Ne>>>16,2654435769))>>>0)/4294967296},xe=1/1.1;for(let Ne=0;Ne<$e;Ne++){const ct=xe*(rt(2*Ne+0)+On),Ot=xe*(rt(2*Ne+1)+On),mt=255*ct%1,it=255*Ot%1,Nt=mt,mi=Ot-it/255,_i=it;Ze[4*Ne+0]=255*(ct-mt/255),Ze[4*Ne+1]=255*Nt,Ze[4*Ne+2]=255*mi,Ze[4*Ne+3]=255*_i}return Ze}(ie);ue=k.particlePositionRGBAImage=new s.i({width:ie,height:ie},Fe)}let pe=k.particleFramebuffer;pe?pe.width!==ie&&(pe.destroy(),pe=k.particleFramebuffer=H.createFramebuffer(ie,ie,!0,null)):pe=k.particleFramebuffer=H.createFramebuffer(ie,ie,!0,null);const fe=[];for(const Fe of N){const Be=I.getTile(Fe);if(!(Be instanceof s.c3))continue;const $e=dg(Be,ee,k);if(!$e)continue;const Ze=[Be.tileSize,Be.tileSize];let rt=k.tileFramebuffer;rt||(rt=k.tileFramebuffer=H.createFramebuffer(Ze[0],Ze[1],!0,null));let xe=Be.rasterParticleState;xe||(xe=Be.rasterParticleState=new rs(H,Fe,Ze,ue));const Ne=xe.update(k.lastInvalidatedAt);xe.particleTextureDimension!==ie&&xe.updateParticleTexture(Fe,ue);const ct=xe.targetColorTexture;xe.targetColorTexture=xe.backgroundColorTexture,xe.backgroundColorTexture=ct;const Ot=xe.particleTexture0;xe.particleTexture0=xe.particleTexture1,xe.particleTexture1=Ot,fe.push([Fe,$e,xe,Ne])}if(fe.length===0)return;const _e=s.e.now(),Le=k.previousDrawTimestamp?.001*(_e-k.previousDrawTimestamp):.0167;if(k.previousDrawTimestamp=_e,k.hasColorMap()){H.activeTexture.set(X.TEXTURE0+2);let Fe=k.colorRampTexture;Fe||(Fe=k.colorRampTexture=new s.T(H,k.colorRamp,X.RGBA)),Fe.bind(X.LINEAR,X.CLAMP_TO_EDGE)}H.bindFramebuffer.set(k.tileFramebuffer.framebuffer),function(Fe,Be,$e){const Ze=Fe.context,rt=Ze.gl,xe=Be.tileFramebuffer;Ze.activeTexture.set(rt.TEXTURE0);const Ne={u_texture:0,u_opacity:1.05*(Ot=Be.paint.get("raster-particle-fade-opacity-factor"))/(Ot+.05)},ct=Fe.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var Ot;for(const mt of $e){const[,,it,Nt]=mt;xe.colorAttachment.set(it.targetColorTexture.texture),Ze.viewport.set([0,0,xe.width,xe.height]),Ze.clear({color:s.C.transparent}),Nt&&(it.backgroundColorTexture.bind(rt.NEAREST,rt.CLAMP_TO_EDGE),ct.draw(Fe,rt.TRIANGLES,s.ae.disabled,s.ag.disabled,s.a.alphaBlended,s.af.disabled,Ne,Be.id,Fe.viewportBuffer,Fe.quadTriangleIndexBuffer,Fe.viewportSegments))}}(E,k,fe),function(Fe,Be,$e,Ze){const rt=Fe.context,xe=rt.gl,Ne=$e.tileFramebuffer,ct=Fe.transform.projection.name==="globe",Ot=$e.paint.get("raster-particle-max-speed");for(const mt of Ze){const[it,Nt,mi]=mt;rt.activeTexture.set(xe.TEXTURE0+0),Nt.texture.bind(xe.LINEAR,xe.CLAMP_TO_EDGE),Ne.colorAttachment.set(mi.targetColorTexture.texture);const _i=Fe.getOrCreateProgram("rasterParticleDraw",{defines:Nt.defines,overrideFog:!1});rt.activeTexture.set(xe.TEXTURE0+1);const hi=Nt.scalarData?[]:[0,1,2,3].map(ri=>s.bZ[ri](it));hi.push(it);const vt=it.canonical.x,Gt=it.canonical.y;for(const ri of hi){const $i=Be.getTile(ct?ri.wrapped():ri);if(!$i)continue;const Yi=$i.rasterParticleState;if(!Yi)continue;const hn=ri.canonical.x+(1<<ri.canonical.z)*(ri.wrap-it.wrap),Ji=ri.canonical.y;Yi.particleTexture0.bind(xe.NEAREST,xe.CLAMP_TO_EDGE);const Gi=wp(1,Yi.particleTexture0.size[0],[hn-vt,Ji-Gt],0,Nt.texture.size,2,Ot,Nt.textureOffset,Nt.scale,Nt.offset);_i.draw(Fe,xe.POINTS,s.ae.disabled,s.ag.disabled,s.a.alphaBlended,s.af.disabled,Gi,$e.id,Yi.particleIndexBuffer,void 0,Yi.particleSegment)}}}(E,I,k,fe),H.bindFramebuffer.set(k.particleFramebuffer.framebuffer),function(Fe,Be,$e,Ze){const rt=Fe.context,xe=rt.gl,Ne=Be.paint.get("raster-particle-max-speed"),ct=Ze*Be.paint.get("raster-particle-speed-factor")*.15,Ot=function(it){return Math.pow(it,6)}(.01+1*Be.paint.get("raster-particle-reset-rate-factor")),mt=Be.particleFramebuffer;rt.viewport.set([0,0,mt.width,mt.height]);for(const it of $e){const[,Nt,mi]=it;rt.activeTexture.set(xe.TEXTURE0+0),Nt.texture.bind(xe.LINEAR,xe.CLAMP_TO_EDGE),rt.activeTexture.set(xe.TEXTURE0+1);const _i=mi.particleTexture0;_i.bind(xe.NEAREST,xe.CLAMP_TO_EDGE);const hi=Mp(1,_i.size[0],0,Nt.texture.size,Ne,ct,Ot,Nt.textureOffset,Nt.scale,Nt.offset);mt.colorAttachment.set(mi.particleTexture1.texture),rt.clear({color:s.C.transparent}),Fe.getOrCreateProgram("rasterParticleUpdate",{defines:Nt.defines}).draw(Fe,xe.TRIANGLES,s.ae.disabled,s.ag.disabled,s.a.unblended,s.af.disabled,hi,Be.id,Fe.viewportBuffer,Fe.quadTriangleIndexBuffer,Fe.viewportSegments)}}(E,k,fe,Le)}(m,r,h,y),m.renderPass==="translucent"&&(function(E,I,k,N,H){const X=E.context,ee=X.gl,ie=!E.options.moving,ue=E.transform.projection.name==="globe";if(!N.length)return;const[pe,fe]=E.stencilConfigForOverlap(N),_e=[];ue&&_e.push("PROJECTION_GLOBE_VIEW");const Le=E.stencilModeFor3D();for(const Fe of fe){const Be=Fe.toUnwrapped(),$e=I.getTile(Fe);if(!$e.rasterParticleState)continue;const Ze=$e.rasterParticleState,rt=100;$e.registerFadeDuration(rt);const xe=I.findLoadedParent(Fe,0),Ne=sh($e,xe,I,E.transform,rt);let ct,Ot;E.terrain&&E.terrain.prepareDrawTile(),X.activeTexture.set(ee.TEXTURE0),Ze.targetColorTexture.bind(ee.LINEAR,ee.CLAMP_TO_EDGE),X.activeTexture.set(ee.TEXTURE1),xe&&xe.rasterParticleState?(xe.rasterParticleState.targetColorTexture.bind(ee.LINEAR,ee.CLAMP_TO_EDGE),ct=Math.pow(2,xe.tileID.overscaledZ-$e.tileID.overscaledZ),Ot=[$e.tileID.canonical.x*ct%1,$e.tileID.canonical.y*ct%1]):Ze.targetColorTexture.bind(ee.LINEAR,ee.CLAMP_TO_EDGE);const mt=ue?Float32Array.from(E.transform.expandedFarZProjMatrix):E.transform.calculateProjMatrix(Be,ie),it=E.transform,Nt=Qn(it),mi=s.bc(Fe.canonical),_i=s.bd(mi.getCenter().lat);let hi,vt,Gt,ri,$i;ue?(hi=Float32Array.from(s.bf(s.bg(Fe.canonical))),vt=Float32Array.from(it.globeMatrix),Gt=Float32Array.from(s.bb(it)),ri=[s.aj(it.center.lng),s.ak(it.center.lat)],$i=Float32Array.from(s.be(Fe.canonical,mi,_i,it.worldSize/it._pixelsPerMercatorPixel))):(hi=new Float32Array(16),vt=new Float32Array(9),Gt=new Float32Array(16),ri=[0,0],$i=new Float32Array(9));const Yi=Ta(mt,hi,vt,Gt,$i,Ot||[0,0],s.a1(E.transform.zoom),ri,Nt,ct||1,Ne,250),hn=E.isTileAffectedByFog(Fe),Ji=E.getOrCreateProgram("rasterParticle",{defines:_e,overrideFog:hn});if(E.uploadCommonUniforms(X,Ji,Be),ue){const Gi=new s.ae(ee.LEQUAL,s.ae.ReadWrite,E.depthRangeFor3D),Qt=0,xn=E.globeSharedBuffers;if(xn){const[Tr,Wn,cr]=xn.getGridBuffers(_i,Qt!==0);Ji.draw(E,ee.TRIANGLES,Gi,Le,s.a.alphaBlended,s.af.backCCW,Yi,k.id,Tr,Wn,cr)}}else{const Gi=E.depthModeForSublayer(0,s.ae.ReadOnly),Qt=pe[Fe.overscaledZ],{tileBoundsBuffer:xn,tileBoundsIndexBuffer:Tr,tileBoundsSegments:Wn}=E.getTileBoundsBuffers($e);Ji.draw(E,ee.TRIANGLES,Gi,Qt,s.a.alphaBlended,s.af.disabled,Yi,k.id,xn,Tr,Wn)}}E.resetStencilClippingMasks()}(m,r,h,y),m.style.map.triggerRepaint())},background:function(m,r,h,y){const b=h.paint.get("background-color"),T=h.paint.get("background-opacity"),E=h.paint.get("background-emissive-strength");if(T===0)return;const I=m.context,k=I.gl,N=m.transform,H=N.tileSize,X=h.paint.get("background-pattern");let ee;if(X!==void 0&&(X===null||(ee=m.imageManager.getPattern(X.toString(),h.scope,m.style.getLut(h.scope)),!ee)))return;const ie=!X&&b.a===1&&T===1&&m.opaquePassEnabledForLayer()?"opaque":"translucent";if(m.renderPass!==ie)return;const ue=s.ag.disabled,pe=m.depthModeForSublayer(0,ie==="opaque"?s.ae.ReadWrite:s.ae.ReadOnly),fe=m.colorModeForDrapableLayerRenderPass(E),_e=X?"backgroundPattern":"background";let Le,Fe=y;Fe||(Le=m.getBackgroundTiles(),Fe=Object.values(Le).map(Be=>Be.tileID)),X&&(I.activeTexture.set(k.TEXTURE0),m.imageManager.bind(m.context,h.scope));for(const Be of Fe){const $e=m.isTileAffectedByFog(Be),Ze=m.getOrCreateProgram(_e,{overrideFog:$e}),rt=Be.toUnwrapped(),xe=y?Be.projMatrix:m.transform.calculateProjMatrix(rt);m.prepareDrawTile();const Ne=r?r.getTile(Be):Le?Le[Be.key]:new s.by(Be,H,N.zoom,m),ct=X?Ll(xe,E,T,m,0,h.scope,ee,{tileID:Be,tileSize:H}):Hh(xe,E,T,b.toRenderColor(h.lut));m.uploadCommonUniforms(I,Ze,rt);const{tileBoundsBuffer:Ot,tileBoundsIndexBuffer:mt,tileBoundsSegments:it}=m.getTileBoundsBuffers(Ne);Ze.draw(m,k.TRIANGLES,pe,ue,fe,s.af.disabled,ct,h.id,Ot,mt,it)}},sky:function(m,r,h){const y=m._atmosphere?s.a1(m.transform.zoom):1,b=h.paint.get("sky-opacity")*y;if(b===0)return;const T=m.context,E=h.paint.get("sky-type"),I=new s.ae(T.gl.LEQUAL,s.ae.ReadOnly,[0,1]),k=m.frameCounter/1e3%1;E==="atmosphere"?m.renderPass==="offscreen"?h.needsSkyboxCapture(m)&&(function(N,H,X,ee){const ie=N.context,ue=ie.gl;let pe=H.skyboxFbo;if(!pe){pe=H.skyboxFbo=ie.createFramebuffer(32,32,!0,null),H.skyboxGeometry=new Zh(ie),H.skyboxTexture=ie.gl.createTexture(),ue.bindTexture(ue.TEXTURE_CUBE_MAP,H.skyboxTexture),ue.texParameteri(ue.TEXTURE_CUBE_MAP,ue.TEXTURE_WRAP_S,ue.CLAMP_TO_EDGE),ue.texParameteri(ue.TEXTURE_CUBE_MAP,ue.TEXTURE_WRAP_T,ue.CLAMP_TO_EDGE),ue.texParameteri(ue.TEXTURE_CUBE_MAP,ue.TEXTURE_MIN_FILTER,ue.LINEAR),ue.texParameteri(ue.TEXTURE_CUBE_MAP,ue.TEXTURE_MAG_FILTER,ue.LINEAR);for(let Fe=0;Fe<6;++Fe)ue.texImage2D(ue.TEXTURE_CUBE_MAP_POSITIVE_X+Fe,0,ue.RGBA,32,32,0,ue.RGBA,ue.UNSIGNED_BYTE,null)}ie.bindFramebuffer.set(pe.framebuffer),ie.viewport.set([0,0,32,32]);const fe=H.getCenter(N,!0),_e=N.getOrCreateProgram("skyboxCapture"),Le=new Float64Array(16);s.ad.identity(Le),s.ad.rotateY(Le,Le,.5*-Math.PI),na(N,H,_e,Le,fe,0),s.ad.identity(Le),s.ad.rotateY(Le,Le,.5*Math.PI),na(N,H,_e,Le,fe,1),s.ad.identity(Le),s.ad.rotateX(Le,Le,.5*-Math.PI),na(N,H,_e,Le,fe,2),s.ad.identity(Le),s.ad.rotateX(Le,Le,.5*Math.PI),na(N,H,_e,Le,fe,3),s.ad.identity(Le),na(N,H,_e,Le,fe,4),s.ad.identity(Le),s.ad.rotateY(Le,Le,Math.PI),na(N,H,_e,Le,fe,5),ie.viewport.set([0,0,N.width,N.height])}(m,h),h.markSkyboxValid(m)):m.renderPass==="sky"&&function(N,H,X,ee,ie){const ue=N.context,pe=ue.gl,fe=N.transform,_e=N.getOrCreateProgram("skybox");ue.activeTexture.set(pe.TEXTURE0),pe.bindTexture(pe.TEXTURE_CUBE_MAP,H.skyboxTexture);const Le=((Fe,Be,$e,Ze,rt)=>({u_matrix:Fe,u_sun_direction:Be,u_cubemap:0,u_opacity:Ze,u_temporal_offset:rt}))(fe.skyboxMatrix,H.getCenter(N,!1),0,ee,ie);N.uploadCommonUniforms(ue,_e),_e.draw(N,pe.TRIANGLES,X,s.ag.disabled,N.colorModeForRenderPass(),s.af.backCW,Le,"skybox",H.skyboxGeometry.vertexBuffer,H.skyboxGeometry.indexBuffer,H.skyboxGeometry.segment)}(m,h,I,b,k):E==="gradient"&&m.renderPass==="sky"&&function(N,H,X,ee,ie){const ue=N.context,pe=ue.gl,fe=N.transform,_e=N.getOrCreateProgram("skyboxGradient");H.skyboxGeometry||(H.skyboxGeometry=new Zh(ue)),ue.activeTexture.set(pe.TEXTURE0);let Le=H.colorRampTexture;Le||(Le=H.colorRampTexture=new s.T(ue,H.colorRamp,pe.RGBA)),Le.bind(pe.LINEAR,pe.CLAMP_TO_EDGE);const Fe=((Be,$e,Ze,rt,xe)=>({u_matrix:Be,u_color_ramp:0,u_center_direction:$e,u_radius:s.ab(Ze),u_opacity:rt,u_temporal_offset:xe}))(fe.skyboxMatrix,H.getCenter(N,!1),H.paint.get("sky-gradient-radius"),ee,ie);N.uploadCommonUniforms(ue,_e),_e.draw(N,pe.TRIANGLES,X,s.ag.disabled,N.colorModeForRenderPass(),s.af.backCW,Fe,"skyboxGradient",H.skyboxGeometry.vertexBuffer,H.skyboxGeometry.indexBuffer,H.skyboxGeometry.segment)}(m,h,I,b,k)},debug:function(m,r,h,y,b,T){for(let E=0;E<h.length;E++)if(b){const N=new s.C(y.r*.8,y.g*.8,y.b*.8,1);ol(m,r,h[E],y,-1,-1,T),ol(m,r,h[E],y,-1,1,T),ol(m,r,h[E],y,1,1,T),ol(m,r,h[E],y,1,-1,T),ol(m,r,h[E],N,0,0,T)}else ol(m,r,h[E],y,0,0,T)},custom:function(m,r,h,y){const b=m.context,T=h.implementation;if(!m.transform.projection.unsupportedLayers||!m.transform.projection.unsupportedLayers.includes("custom")||m.terrain&&(m.terrain.renderingToTexture||m.renderPass==="offscreen")&&h.isDraped(r)){if(m.renderPass==="offscreen"){const E=T.prerender;if(E){if(m.setCustomLayerDefaults(),b.setColorMode(m.colorModeForRenderPass()),m.transform.projection.name==="globe"){const I=m.transform.pointMerc;E.call(T,b.gl,m.transform.customLayerMatrix(),m.transform.getProjection(),m.transform.globeToMercatorMatrix(),s.a1(m.transform.zoom),[I.x,I.y],m.transform.pixelsPerMeterRatio)}else E.call(T,b.gl,m.transform.customLayerMatrix());b.setDirty(),m.setBaseState()}}else if(m.renderPass==="translucent"){if(m.terrain&&m.terrain.renderingToTexture){const I=T.renderToTile;if(I){const k=y[0].canonical,N=new s.Y(k.x+y[0].wrap*(1<<k.z),k.y,k.z);b.setDepthMode(s.ae.disabled),b.setStencilMode(s.ag.disabled),b.setColorMode(m.colorModeForRenderPass()),m.setCustomLayerDefaults(),I.call(T,b.gl,N),b.setDirty(),m.setBaseState()}return}m.setCustomLayerDefaults(),b.setColorMode(m.colorModeForRenderPass()),b.setStencilMode(s.ag.disabled);const E=T.renderingMode==="3d"?new s.ae(m.context.gl.LEQUAL,s.ae.ReadWrite,m.depthRangeFor3D):m.depthModeForSublayer(0,s.ae.ReadOnly);if(b.setDepthMode(E),m.transform.projection.name==="globe"){const I=m.transform.pointMerc;T.render(b.gl,m.transform.customLayerMatrix(),m.transform.getProjection(),m.transform.globeToMercatorMatrix(),s.a1(m.transform.zoom),[I.x,I.y],m.transform.pixelsPerMeterRatio)}else T.render(b.gl,m.transform.customLayerMatrix());b.setDirty(),m.setBaseState(),b.bindFramebuffer.set(null)}}else s.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(m,r,h,y){if(m.renderPass==="opaque")return;const b=h.paint.get("model-opacity");if(b===0)return;const T=h.paint.get("model-cast-shadows");if(m.renderPass==="shadow"&&(!T||m.terrain&&b<.65&&h._transitionablePaint._values["model-opacity"].value.expression instanceof s.Z))return;const E=m.shadowRenderer,I=h.paint.get("model-receive-shadows");E&&(E.useNormalOffset=!0,I||(E.enabled=!1));const k=()=>{E&&(E.useNormalOffset=!0,I||(E.enabled=!0))},N=r.getSource();if(m.renderPass==="light-beam"&&N.type!=="batched-model")return;if(N.type==="vector"||N.type==="geojson")return function(_e,Le,Fe,Be,$e){const Ze=_e.transform;if(Ze.projection.name!=="mercator")return void s.w(`Drawing 3D models for ${Ze.projection.name} projection is not yet implemented`);const rt=Ze.getFreeCameraOptions().position;if(!_e.modelManager)return;const xe=_e.modelManager;Fe.modelManager=xe;const Ne=_e.shadowRenderer;if(!Fe._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const ct=Fe._unevaluatedLayout._values["model-id"],Ot={...Fe.layout.get("model-id").parameters},mt=_e.style.order.indexOf(Fe.fqid);for(const it of Be){const Nt=Le.getTile(it).getBucket(Fe);if(!Nt||Nt.projection.name!==Ze.projection.name)continue;const mi=Nt.getModelUris();mi&&!Nt.modelsRequested&&(xe.addModelsFromBucket(mi,$e),Nt.modelsRequested=!0);const _i=$h(it,Ze);Ot.zoom=_i;const hi=ct.possiblyEvaluate(Ot);if(Aa(_e,Nt,it),al.shadowUniformsInitialized=!1,al.useSingleShadowCascade=!!Ne&&Ne.getMaxCascadeForTile(it.toUnwrapped())===0,_e.renderPass==="shadow"&&Ne){if(_e.currentShadowCascade===1&&Nt.isInsideFirstShadowMapFrustum)continue;const ri=Ze.calculatePosMatrix(it.toUnwrapped(),Ze.worldSize);if(al.tileMatrix.set(ri),al.shadowTileMatrix=Float32Array.from(Ne.calculateShadowPassMatrixFromMatrix(ri)),al.aabb.min.fill(0),al.aabb.max[0]=al.aabb.max[1]=s.a3,al.aabb.max[2]=0,ac(Nt,al,_e,Fe.scope))continue}const vt=1<<it.canonical.z,Gt=[((rt.x-it.wrap)*vt-it.canonical.x)*s.a3,(rt.y*vt-it.canonical.y)*s.a3,rt.z*vt*s.a3];_e.conflationActive&&Object.keys(Nt.instancesPerModel).length>0&&_e.style.isLayerClipped(Fe,Le.getSource())&&Nt.updateReplacement(it,_e.replacementSource,mt)&&(Nt.uploaded=!1,Nt.upload(_e.context));for(let ri in Nt.instancesPerModel){const $i=Nt.instancesPerModel[ri];$i.features.length>0&&(ri=hi.evaluate($i.features[0].feature,{}));const Yi=xe.getModel(ri,$e);if(Yi&&Yi.uploaded)for(const hn of Yi.nodes)Qs(_e,Fe,hn,$i,Gt,it,al)}}}(m,r,h,y,N.type==="vector"?h.scope:""),void k();if(!N.loaded())return;if(N.type==="batched-model")return function(_e,Le,Fe,Be){Fe.resetLayerRenderingStats(_e);const $e=_e.context,Ze=_e.transform,rt=_e.style.fog,xe=_e.shadowRenderer;if(Ze.projection.name!=="mercator")return void s.w(`Drawing 3D landmark models for ${Ze.projection.name} projection is not yet implemented`);const Ne=_e.transform.getFreeCameraOptions().position,ct=s._.scale([],[Ne.x,Ne.y,Ne.z],_e.transform.worldSize);s._.negate(ct,ct);const Ot=s.ad.identity([]),mt=s.cg(Ze.center.lat,Ze.zoom),it=s.ad.fromScaling([],[1,1,1/mt]);s.ad.translate(Ot,Ot,ct);const Nt=Fe.paint.get("model-opacity"),mi=new s.ae($e.gl.LEQUAL,s.ae.ReadWrite,_e.depthRangeFor3D),_i=new s.ae($e.gl.LEQUAL,s.ae.ReadOnly,_e.depthRangeFor3D),hi=new s.b6([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),vt=_e.renderPass==="shadow",Gt=vt&&xe?xe.getCurrentCascadeFrustum():Ze.getFrustum(Ze.scaleZoom(Ze.worldSize)),ri=Fe.paint.get("model-front-cutoff"),$i=ri[2]<1,Yi=Ka(_e,Fe.paint.get("model-cutoff-fade-range")),hn=Fe.getLayerRenderingStats();(function(Ji,Gi,Qt,xn){const Tr=Ji.terrain?Ji.terrain.exaggeration():0,Wn=Ji.transform.zoom;for(const cr of xn){const er=Gi.getTile(cr).getBucket(Qt);er&&(Ji.conflationActive&&er.updateReplacement(cr,Ji.replacementSource),er.evaluateScale(Ji,Qt),Ji.terrain&&Tr>0&&er.elevationUpdate(Ji.terrain,Tr,cr,Qt.source),er.needsReEvaluation(Ji,Wn,Qt)&&er.evaluate(Qt))}})(_e,Le,Fe,Be),function(){let Ji,Gi,Qt;$i?(Ji=Be.length-1,Gi=-1,Qt=-1):(Ji=0,Gi=Be.length,Qt=1);for(let xn=Ji;xn!==Gi;xn+=Qt){const Tr=Be[xn],Wn=Le.getTile(Tr).getBucket(Fe);if(!Wn||!Wn.uploaded)continue;let cr=!1;xe&&(cr=xe.getMaxCascadeForTile(Tr.toUnwrapped())===0);const er=Ze.calculatePosMatrix(Tr.toUnwrapped(),Ze.worldSize),xs=Wn.modelTraits,zr=[];for(const ir of Wn.getNodesInfo()){if(ir.hiddenByReplacement||!ir.node.meshes)continue;const ls=ir.node;let Zr=0;_e.terrain&&ls.elevation&&(Zr=ls.elevation*_e.terrain.exaggeration());const Or=ir.evaluatedScale;if(Or[0]<=1&&Or[1]<=1&&Or[2]<=1&&(()=>{const Br=ir.aabb;return hi.min=[...Br.min],hi.max=[...Br.max],hi.min[2]+=Zr,hi.max[2]+=Zr,s._.transformMat4(hi.min,hi.min,er),s._.transformMat4(hi.max,hi.max,er),hi})().intersects(Gt)===0)continue;const dr=[...er],hs=ls.anchor?ls.anchor[0]:0,ks=ls.anchor?ls.anchor[1]:0;s.ad.translate(dr,dr,[hs*(Or[0]-1),ks*(Or[1]-1),Zr]),s._.exactEquals(Or,s.cj)||s.ad.scale(dr,dr,Or);const Ur=s.ad.multiply([],dr,ls.matrix),vs=s.ad.multiply([],Ze.expandedFarZProjMatrix,Ur),oi=s.ad.multiply([],Ze.expandedFarZProjMatrix,dr),on=s.aA.transformMat4([],[hs,ks,Zr,1],vs)[2];ls.hidden=!1;let Eo=Nt;vt||($i&&(Eo*=Cp(dr,Ze,ir.aabb,ri)),Eo*=_o(Yi,on)),Eo!==0?zr.push({nodeInfo:ir,depth:on,opacity:Eo,wvpForNode:vs,wvpForTile:oi,nodeModelMatrix:Ur,tileModelMatrix:dr}):ls.hidden=!0}vt||zr.sort((ir,ls)=>!$i||ir.opacity===1&&ls.opacity===1?ir.depth<ls.depth?-1:1:ir.opacity===1?-1:ls.opacity===1?1:ir.depth>ls.depth?-1:1);for(const ir of zr){const ls=ir.nodeInfo,Zr=ls.node;let Or=s.ad.multiply([],it,ir.tileModelMatrix);s.ad.multiply(Or,Ot,Or);const dr=s.ad.invert([],Or);s.ad.transpose(dr,dr),s.ad.scale(dr,dr,ll),Or=s.ad.multiply(Or,Or,Zr.matrix);const hs=_e.renderPass==="light-beam",ks=xs&s.cl.HasMapboxMeshFeatures,Ur=ks?0:ls.evaluatedRMEA[0][2];for(let vs=0;vs<Zr.meshes.length;++vs){const oi=Zr.meshes[vs],on=vs===Zr.lightMeshIndex;let Eo=ir.wvpForNode;if(on){if(!hs&&!_e.terrain&&_e.shadowRenderer){_e.currentLayer<_e.firstLightBeamLayer&&(_e.firstLightBeamLayer=_e.currentLayer);continue}Eo=ir.wvpForTile}else if(hs)continue;const Br={defines:[]},Pt=[];if(uh(Br.defines,Pt,oi,_e,Fe.lut),ks||Br.defines.push("DIFFUSE_SHADED"),cr&&Br.defines.push("SHADOWS_SINGLE_CASCADE"),hn&&(vt?hn.numRenderedVerticesInShadowPass+=oi.vertexArray.length:hn.numRenderedVerticesInTransparentPass+=oi.vertexArray.length),vt){zo(oi,ir.nodeModelMatrix,_e,Fe);continue}let ao=null;if(rt){const Yo=Dd(ir.nodeModelMatrix,_e.transform);if(ao=new Float32Array(Yo),Ze.projection.name!=="globe"){const Ia=oi.aabb.min,Pa=oi.aabb.max,[Ra,qa]=rt.getOpacityForBounds(Yo,Ia[0],Ia[1],Pa[0],Pa[1]);Br.overrideFog=Ra>=Wr||qa>=Wr}}const yo=oi.material;let Ys;yo.occlusionTexture&&yo.occlusionTexture.offsetScale&&(Ys=yo.occlusionTexture.offsetScale,Br.defines.push("OCCLUSION_TEXTURE_TRANSFORM")),!vt&&xe&&(xe.useNormalOffset=!!oi.normalBuffer);const io=_e.getOrCreateProgram("model",Br);!vt&&xe&&xe.setupShadowsFromMatrix(ir.tileModelMatrix,io,xe.useNormalOffset),_e.uploadCommonUniforms($e,io,null,ao);const Uo=yo.pbrMetallicRoughness;Uo.metallicFactor=.9,Uo.roughnessFactor=.5;const ga=Sd(new Float32Array(Eo),new Float32Array(Or),new Float32Array(dr),new Float32Array(Zr.matrix),_e,ir.opacity,Uo.baseColorFactor.toRenderColor(null),yo.emissiveFactor,Uo.metallicFactor,Uo.roughnessFactor,yo,Ur,Fe,[0,0,0],Ys);!on&&(ls.hasTranslucentParts||ir.opacity<1)&&io.draw(_e,$e.gl.TRIANGLES,mi,s.ag.disabled,s.a.disabled,s.af.backCCW,ga,Fe.id,oi.vertexBuffer,oi.indexBuffer,oi.segments,Fe.paint,_e.transform.zoom,void 0,Pt),io.draw(_e,$e.gl.TRIANGLES,on?_i:mi,s.ag.disabled,on||ir.opacity<1||ls.hasTranslucentParts?s.a.alphaBlended:s.a.unblended,s.af.backCCW,ga,Fe.id,oi.vertexBuffer,oi.indexBuffer,oi.segments,Fe.paint,_e.transform.zoom,void 0,Pt)}}}}()}(m,r,h,y),void k();if(N.type!=="model")return;const H=N.getModels(),X=[],ee=m.transform.getFreeCameraOptions().position,ie=s._.scale([],[ee.x,ee.y,ee.z],m.transform.worldSize);s._.negate(ie,ie);const ue=[],pe=[];let fe=0;for(const _e of H){const Le=h.paint.get("model-rotation").constantOr(null),Fe=h.paint.get("model-scale").constantOr(null),Be=h.paint.get("model-translation").constantOr(null);_e.computeModelMatrix(m,Le,Fe,Be,!0,!0,!1);const $e=s.ad.identity([]),Ze=s.cg(_e.position.lat,m.transform.zoom),rt=s.ad.fromScaling([],[1,1,1/Ze]);s.ad.translate($e,$e,ie),X.push({zScaleMatrix:rt,negCameraPosMatrix:$e});for(const xe of _e.nodes)Nu(m.transform,xe,_e.matrix,m.transform.expandedFarZProjMatrix,fe,ue,pe);fe++}if(ue.sort((_e,Le)=>Le.depth-_e.depth),m.renderPass!=="shadow"){if(b===1)for(const _e of pe)Xh(_e,m,h,X[_e.modelIndex],s.ag.disabled,m.colorModeForRenderPass());else{for(const _e of pe)Xh(_e,m,h,X[_e.modelIndex],s.ag.disabled,s.a.disabled);for(const _e of pe)Xh(_e,m,h,X[_e.modelIndex],m.stencilModeFor3D(),m.colorModeForRenderPass());m.resetStencilClippingMasks()}for(const _e of ue)Xh(_e,m,h,X[_e.modelIndex],s.ag.disabled,m.colorModeForRenderPass());k()}else{for(const _e of pe)zo(_e.mesh,_e.nodeModelMatrix,m,h);for(const _e of ue)zo(_e.mesh,_e.nodeModelMatrix,m,h);k()}}},Il={model:function(m,r,h){const y=r.getSource();if(!y.loaded())return;if(y.type==="vector"||y.type==="geojson")return void(h.modelManager&&h.modelManager.upload(h,y.type==="vector"?m.scope:""));if(y.type==="batched-model"||y.type!=="model")return;const b=y.getModels();for(const T of b)T.upload(h.context)},raster:function(m,r,h){const y=r.getSource();if(!(y instanceof Kl&&y.loaded()))return;const b=m.sourceLayer||y.rasterLayerIds&&y.rasterLayerIds[0];if(!b)return;const T=m.paint.get("raster-array-band")||y.getInitialBand(b);if(T==null)return;const E=r.getIds().map(I=>r.getTileByID(I));for(const I of E)I.updateNeeded(b,T)&&y.prepareTile(I,b,T)},"raster-particle":function(m,r,h){const y=r.getSource();if(!(y instanceof Kl&&y.loaded()))return;const b=m.sourceLayer||y.rasterLayerIds&&y.rasterLayerIds[0];if(!b)return;const T=m.paint.get("raster-particle-array-band")||y.getInitialBand(b);if(T==null)return;const E=r.getIds().map(I=>r.getTileByID(I));for(const I of E)I.updateNeeded(b,T)&&y.prepareTile(I,b,T)}};class fg{constructor(r,h,y,b){this.context=new Jn(r,h),this.occlusionBuffers=new dh(this.context),this.transform=y,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=b,this._timeStamp=s.e.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const T=["fill","line","symbol","circle","heatmap","fill-extrusion","raster","raster-particle","hillshade","model","background","sky"];for(const E of T)this._debugParams.enabledLayers[E]=!0;b.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),b.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),b.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),b.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),b.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(const E of T)b.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],E);this.symbolParams=new ar(b),this.setup(),this.numSublayers=s.bv.maxUnderzooming+s.bv.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new s.co,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new bc(this),this._wireframeDebugCache=new Uu,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[]}updateTerrain(r,h){const y=!!r&&!!r.terrain&&this.transform.projection.supportsTerrain;if(!(y||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new el(this,r));const b=this._terrain;this.transform.elevation=y?b:null,b.update(r,this.transform,h),this.transform.elevation&&!b.enabled&&(this.transform.elevation=null)}_updateFog(r){const h=r.fog;if(!h||this.transform.projection.name==="globe"||h.getOpacity(this.transform.pitch)<1||h.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[y,b]=h.getFovAdjustedRange(this.transform._fov);if(y>b)return void(this.transform.fogCullDistSq=null);const T=y+.78*(b-y);this.transform.fogCullDistSq=T*T}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(r){r&&!this._terrain&&(this._terrain=new el(this,this.style)),this._forceTerrainMode=r}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(r,h){if(this.width=r*s.e.devicePixelRatio,this.height=h*s.e.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const y of this.style.order)this.style._mergedLayers[y].resize()}setup(){const r=this.context,h=new s.bt;h.emplaceBack(0,0),h.emplaceBack(s.a3,0),h.emplaceBack(0,s.a3),h.emplaceBack(s.a3,s.a3),this.tileExtentBuffer=r.createVertexBuffer(h,s.br.members),this.tileExtentSegments=s.b.simpleSegment(0,0,4,2);const y=new s.bt;y.emplaceBack(0,0),y.emplaceBack(s.a3,0),y.emplaceBack(0,s.a3),y.emplaceBack(s.a3,s.a3),this.debugBuffer=r.createVertexBuffer(y,s.br.members),this.debugSegments=s.b.simpleSegment(0,0,4,5);const b=new s.bt;b.emplaceBack(-1,-1),b.emplaceBack(1,-1),b.emplaceBack(-1,1),b.emplaceBack(1,1),this.viewportBuffer=r.createVertexBuffer(b,s.br.members),this.viewportSegments=s.b.simpleSegment(0,0,4,2);const T=new s.cp;T.emplaceBack(0,0,0,0),T.emplaceBack(s.a3,0,s.a3,0),T.emplaceBack(0,s.a3,0,s.a3),T.emplaceBack(s.a3,s.a3,s.a3,s.a3),this.mercatorBoundsBuffer=r.createVertexBuffer(T,s.cq.members),this.mercatorBoundsSegments=s.b.simpleSegment(0,0,4,2);const E=new s.bu;E.emplaceBack(0,1,2),E.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=r.createIndexBuffer(E);const I=new s.cr;for(const N of[0,1,3,2,0])I.emplaceBack(N);this.debugIndexBuffer=r.createIndexBuffer(I),this.emptyTexture=new s.T(r,new s.i({width:1,height:1},Uint8Array.of(0,0,0,0)),r.gl.RGBA),this.identityMat=s.ad.create();const k=this.context.gl;this.stencilClearMode=new s.ag({func:k.ALWAYS,mask:0},0,255,k.ZERO,k.ZERO,k.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(r){return r._makeTileBoundsBuffers(this.context,this.transform.projection),r._tileBoundsBuffer?{tileBoundsBuffer:r._tileBoundsBuffer,tileBoundsIndexBuffer:r._tileBoundsIndexBuffer,tileBoundsSegments:r._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const r=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,r.TRIANGLES,s.ae.disabled,this.stencilClearMode,s.a.disabled,s.af.disabled,rh(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(r,h,y){if(!h||this.currentStencilSource===h.id||!r.isTileClipped()||!y||y.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let I=!1;for(const k of y)if(this._tileClippingMaskIDs[k.key]===void 0){I=!0;break}if(!I)return}this.currentStencilSource=h.id;const b=this.context,T=b.gl;this.nextStencilID+y.length>256&&this.clearStencil(),b.setColorMode(s.a.disabled),b.setDepthMode(s.ae.disabled);const E=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const I of y){const k=h.getTile(I),N=this._tileClippingMaskIDs[I.key]=this.nextStencilID++,{tileBoundsBuffer:H,tileBoundsIndexBuffer:X,tileBoundsSegments:ee}=this.getTileBoundsBuffers(k);E.draw(this,T.TRIANGLES,s.ae.disabled,new s.ag({func:T.ALWAYS,mask:0},N,255,T.KEEP,T.KEEP,T.REPLACE),s.a.disabled,s.af.disabled,rh(I.projMatrix),"$clipping",H,X,ee)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const r=this.nextStencilID++,h=this.context.gl;return new s.ag({func:h.NOTEQUAL,mask:255},r,255,h.KEEP,h.KEEP,h.REPLACE)}stencilModeForClipping(r){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(r);const h=this.context.gl;return new s.ag({func:h.EQUAL,mask:255},this._tileClippingMaskIDs[r.key],0,h.KEEP,h.KEEP,h.REPLACE)}stencilConfigForOverlap(r){const h=this.context.gl,y=r.sort((E,I)=>I.overscaledZ-E.overscaledZ),b=y[y.length-1].overscaledZ,T=y[0].overscaledZ-b+1;if(T>1){this.currentStencilSource=void 0,this.nextStencilID+T>256&&this.clearStencil();const E={};for(let I=0;I<T;I++)E[I+b]=new s.ag({func:h.GEQUAL,mask:255},I+this.nextStencilID,255,h.KEEP,h.KEEP,h.REPLACE);return this.nextStencilID+=T,[E,y]}return[{[b]:s.ag.disabled},y]}colorModeForRenderPass(){const r=this.context.gl;return this._showOverdrawInspector?new s.a([r.CONSTANT_COLOR,r.ONE,r.CONSTANT_COLOR,r.ONE],new s.C(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?s.a.unblended:s.a.alphaBlended}colorModeForDrapableLayerRenderPass(r){const h=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?new s.a([h.ONE,h.ONE_MINUS_SRC_ALPHA,h.CONSTANT_ALPHA,h.ONE_MINUS_SRC_ALPHA],new s.C(0,0,0,r===void 0?0:r),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(r,h,y,b=!1){if(this.depthOcclusion)return new s.ae(this.context.gl.GREATER,s.ae.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!b)return s.ae.disabled;const T=1-((1+this.currentLayer)*this.numSublayers+r)*this.depthEpsilon;return new s.ae(y||this.context.gl.LEQUAL,h,[T,T])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const r=this.context.gl,h=Math.ceil(this.width),y=Math.ceil(this.height),b=this.context.bindFramebuffer.get(),T=r.getParameter(r.TEXTURE_BINDING_2D);this.terrainDepthFBO&&this.terrainDepthFBO.width===h&&this.terrainDepthFBO.height===y||(this.terrainDepthFBO&&(this.terrainDepthFBO.destroy(),this.terrainDepthFBO=void 0,this.terrainDepthTexture=void 0),h!==0&&y!==0&&(this.terrainDepthFBO=new Yn(this.context,h,y,!1,"texture"),this.terrainDepthTexture=new s.T(this.context,{width:h,height:y,data:null},r.DEPTH_STENCIL),this.terrainDepthFBO.depthAttachment.set(this.terrainDepthTexture.texture))),this.context.bindFramebuffer.set(b),r.bindTexture(r.TEXTURE_2D,T),this.terrainDepthFBO&&(r.bindFramebuffer(r.READ_FRAMEBUFFER,null),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,this.terrainDepthFBO.framebuffer),r.blitFramebuffer(0,0,h,y,0,0,h,y,r.DEPTH_BUFFER_BIT,r.NEAREST),r.bindFramebuffer(r.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(this._dt===0?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce((r,h)=>r+h/this._fpsHistory.length,0))}render(r,h){const y=s.e.now();this._dt=y-this._timeStamp,this._timeStamp=y,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=r.map.repaint,this.style=r,this.options=h;const b=this.style._mergedLayers,T=this.style.order.filter(xe=>{const Ne=b[xe];return!(Ne.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[Ne.type]}),E=T.map(xe=>b[xe]),I=this.style._mergedSourceCaches;this.imageManager=r.imageManager,this.modelManager=r.modelManager,this.symbolFadeChange=r.placement.symbolFadeChange(s.e.now()),this.imageManager.beginFrame();let k=0,N=!1;for(const xe in I){const Ne=I[xe];Ne.used&&(Ne.prepare(this.context),Ne.getSource().usedInConflation&&++k)}let H=!1;for(const xe of E)xe.isHidden(this.transform.zoom)||(xe.type==="clip"&&(H=!0),this.prepareLayer(xe));const X={},ee={},ie={},ue={},pe={};for(const xe in I){const Ne=I[xe];X[xe]=Ne.getVisibleCoordinates(),ee[xe]=X[xe].slice().reverse(),ie[xe]=Ne.getVisibleCoordinates(!0).reverse(),ue[xe]=Ne.getShadowCasterCoordinates(),pe[xe]=Ne.sortCoordinatesByDistance(X[xe])}const fe=xe=>{const Ne=this.style.getLayerSourceCache(xe);return Ne&&Ne.used?Ne.getSource():null};if(k||H){const xe=[],Ne=[];let ct=0;for(const Ot of E)this.isSourceForClippingOrConflation(Ot,fe(Ot))&&(xe.push(Ot),Ne.push(ct)),ct++;if(xe&&(H||xe.length>1)){const Ot=[];for(let mt=0;mt<xe.length;mt++){const it=xe[mt],Nt=Ne[mt],mi=this.style.getLayerSourceCache(it);if(!mi||!mi.used||!mi.getSource().usedInConflation&&it.type!=="clip")continue;let _i=1/0,hi=s.cu.None;if(it.type==="clip"){_i=Nt;for(const vt of it.layout.get("clip-layer-types"))hi|=vt==="model"?s.cu.Model:vt==="symbol"?s.cu.Symbol:s.cu.FillExtrusion}Ot.push({layer:it.fqid,cache:mi,order:_i,clipMask:hi})}this.replacementSource.setSources(Ot),N=!0}}N||this.replacementSource.clear(),this.conflationActive=N,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let xe=0;xe<E.length;xe++){const Ne=E[xe],ct=Ne.cutoffRange();if(this.longestCutoffRange=Math.max(ct,this.longestCutoffRange),ct>0){const Ot=fe(Ne);Ot&&(this.minCutoffZoom=Math.max(Ot.minzoom,this.minCutoffZoom)),Ne.minzoom&&(this.minCutoffZoom=Math.max(Ne.minzoom,this.minCutoffZoom))}Ne.is3D()&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=xe),this._lastOcclusionLayer=xe)}const _e=this.style&&this.style.fog;_e?(this._fogVisible=_e.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=_e.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(ie),this.opaquePassCutoff=0);const Le=this._shadowRenderer;if(Le){Le.updateShadowParameters(this.transform,this.style.directionalLight);for(const xe in I)for(const Ne of X[xe]){let ct={min:0,max:0};this.terrain&&(ct=this.terrain.getMinMaxForTile(Ne)||ct),Le.addShadowReceiver(Ne.toUnwrapped(),ct.min,ct.max)}}if(this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new s.cs(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new Bu(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),!s.ct(this.context.gl))return;this.renderPass="offscreen";for(const xe of E){const Ne=r.getLayerSourceCache(xe);if(!xe.hasOffscreenPass()||xe.isHidden(this.transform.zoom))continue;const ct=Ne?ee[Ne.id]:void 0;(xe.type==="custom"||xe.type==="raster"||xe.type==="raster-particle"||xe.isSky()||ct&&ct.length)&&this.renderLayer(this,Ne,xe,ct)}this.depthRangeFor3D=[0,1-(E.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,ue)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const Fe=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),Be=(()=>{if(h.showOverdrawInspector)return s.C.black;const xe=this.style.fog;if(xe&&this.transform.projection.supportsFog){const Ne=this.style.getLut(xe.scope);if(!Fe){const ct=xe.properties.get("color").toRenderColor(Ne).toArray01();return new s.C(...ct)}if(Fe){const ct=xe.properties.get("space-color").toRenderColor(Ne).toArray01();return new s.C(...ct)}}return s.C.transparent})();if(this.context.clear({color:Be,depth:1}),this.clearStencil(),this._showOverdrawInspector=h.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&Fe&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=T.length-1;this.currentLayer>=0;this.currentLayer--){const xe=E[this.currentLayer],Ne=r.getLayerSourceCache(xe);if(xe.isSky())continue;const ct=Ne?(xe.is3D()?pe:ee)[Ne.id]:void 0;this._renderTileClippingMasks(xe,Ne,ct),this.renderLayer(this,Ne,xe,ct)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&Fe&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||s.a1(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<T.length;this.currentLayer++){const xe=E[this.currentLayer],Ne=r.getLayerSourceCache(xe);xe.isSky()&&this.renderLayer(this,Ne,xe,Ne?ee[Ne.id]:void 0)}function $e(xe,Ne){let ct;return Ne&&(ct=(xe.type==="symbol"?ie:xe.is3D()?pe:ee)[Ne.id]),ct}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<T.length;){const xe=E[this.currentLayer];if(xe.type==="raster"){const Ne=r.getLayerSourceCache(xe);this.renderLayer(this,Ne,xe,$e(xe,Ne))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let Ze=0;Le&&(Ze=Le.getShadowCastingLayerCount());let rt=!1;for(;this.currentLayer<T.length;){const xe=E[this.currentLayer],Ne=r.getLayerSourceCache(xe);if(xe.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(xe)){if(xe.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(rt||!this.terrain||!this.style.hasSymbolLayers()&&!this.style.hasCircleLayers()||this.transform.isOrthographic||(rt=!0,this.blitDepth()),xe.is3D()||this.terrain||this._renderTileClippingMasks(xe,Ne,Ne?X[Ne.id]:void 0),this.renderLayer(this,Ne,xe,$e(xe,Ne)),!this.terrain&&Le&&Ze>0&&xe.hasShadowPass()&&--Ze==0&&(Le.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){const ct=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=ct;this.currentLayer++){const Ot=E[this.currentLayer];if(!Ot.hasLightBeamPass())continue;const mt=r.getLayerSourceCache(Ot);this.renderLayer(this,mt,Ot,mt?ee[mt.id]:void 0)}this.currentLayer=ct,this.renderPass="translucent"}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const ct=this.currentLayer;this.depthOcclusion=!0;for(const Ot of this.layersWithOcclusionOpacity){this.currentLayer=Ot;const mt=E[this.currentLayer],it=r.getLayerSourceCache(mt),Nt=it?ee[it.id]:void 0;mt.is3D()||this.terrain||this._renderTileClippingMasks(mt,it,it?X[it.id]:void 0),this.renderLayer(this,it,mt,Nt)}this.depthOcclusion=!1,this.currentLayer=ct,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let xe=null;E.forEach(Ne=>{const ct=r.getLayerSourceCache(Ne);ct&&!Ne.isHidden(this.transform.zoom)&&ct.getVisibleCoordinates().length&&(!xe||xe.getSource().maxzoom<ct.getSource().maxzoom)&&(xe=ct)}),xe&&this.options.showTileBoundaries&&Lp.debug(this,xe,xe.getVisibleCoordinates(),s.C.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&Lp.debug(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new s.C(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(xe){const Ne=xe.transform.padding;yn(xe,xe.transform.height-(Ne.top||0),3,$f),yn(xe,Ne.bottom||0,3,Pd),qr(xe,Ne.left||0,3,ku),qr(xe,xe.transform.width-(Ne.right||0),3,Ua);const ct=xe.transform.centerPoint;(function(Ot,mt,it,Nt){Nr(Ot,mt-1,it-10,2,20,Nt),Nr(Ot,mt-10,it-1,20,2,Nt)})(xe,ct.x,xe.transform.height-ct.y,Rd)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),N||(this.conflationActive=!1)}prepareLayer(r){this.gpuTimingStart(r);const{unsupportedLayers:h}=this.transform.projection,y=!h||!h.includes(r.type);if(Il[r.type]&&(y||this.terrain&&r.type==="custom")){const b=this.style.getLayerSourceCache(r);Il[r.type](r,b,this)}this.gpuTimingEnd()}renderLayer(r,h,y,b){y.isHidden(this.transform.zoom)||(y.type==="background"||y.type==="sky"||y.type==="custom"||y.type==="model"||y.type==="raster"||y.type==="raster-particle"||b&&b.length)&&(this.id=y.id,this.gpuTimingStart(y),r.transform.projection.unsupportedLayers&&r.transform.projection.unsupportedLayers.includes(y.type)&&(!r.terrain||y.type!=="custom")||y.type==="clip"||Lp[y.type](r,h,y,b,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(r){if(!this.options.gpuTiming)return;const h=this.context.extTimerQuery,y=this.context.gl;let b=this.gpuTimers[r.id];b||(b=this.gpuTimers[r.id]={calls:0,cpuTime:0,query:y.createQuery()}),b.calls++,y.beginQuery(h.TIME_ELAPSED_EXT,b.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const r=this.context.extTimerQuery,h=this.context.gl,y=h.createQuery();this.deferredRenderGpuTimeQueries.push(y),h.beginQuery(r.TIME_ELAPSED_EXT,y)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const r=this.gpuTimers;return this.gpuTimers={},r}collectDeferredRenderGpuQueries(){const r=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],r}queryGpuTimers(r){const h={};for(const y in r){const b=r[y],T=this.context.extTimerQuery,E=T.getQueryParameter(b.query,this.context.gl.QUERY_RESULT)/1e6;T.deleteQueryEXT(b.query),h[y]=E}return h}queryGpuTimeDeferredRender(r){if(!this.options.gpuTimingDeferredRender)return 0;const h=this.context.extTimerQuery,y=this.context.gl;let b=0;for(const T of r)b+=h.getQueryParameter(T,y.QUERY_RESULT)/1e6,h.deleteQueryEXT(T);return b}translatePosMatrix(r,h,y,b,T){if(!y[0]&&!y[1])return r;const E=T?b==="map"?this.transform.angle:0:b==="viewport"?-this.transform.angle:0;if(E){const N=Math.sin(E),H=Math.cos(E);y=[y[0]*H-y[1]*N,y[0]*N+y[1]*H]}const I=[T?y[0]:s.bB(h,y[0],this.transform.zoom),T?y[1]:s.bB(h,y[1],this.transform.zoom),0],k=new Float32Array(16);return s.ad.translate(k,r,I),k}saveTileTexture(r){const h=r.size[0],y=this._tileTextures[h];y?y.push(r):this._tileTextures[h]=[r]}getTileTexture(r){const h=this._tileTextures[r];return h&&h.length>0?h.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(r,h,y){const b=y===void 0?this.terrain&&this.terrain.renderingToTexture:y,T=[];return this.style&&this.style.enable3dLights()&&(r==="globeRaster"||r==="terrainRaster"?(T.push("LIGHTING_3D_MODE"),T.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):b||T.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"?this._shadowMapDebug||T.push("DEPTH_TEXTURE"):this.shadowRenderer&&(this.shadowRenderer.useNormalOffset?T.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"):T.push("RENDER_SHADOWS","DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(T.push("TERRAIN"),this.linearFloatFilteringSupported()&&T.push("TERRAIN_DEM_FLOAT_FORMAT")),this.transform.projection.name==="globe"&&T.push("GLOBE"),!this._fogVisible||b||h!==void 0&&!h||T.push("FOG","FOG_DITHERING"),b&&T.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&T.push("OVERDRAW_INSPECTOR"),T}getOrCreateProgram(r,h){this.cache=this.cache||{};const y=h&&h.defines||[],b=h&&h.config,T=this.currentGlobalDefines(r,h&&h.overrideFog,h&&h.overrideRtt).concat(y),E=tl.cacheKey(ze[r],r,T,b);return this.cache[E]||(this.cache[E]=new tl(this.context,r,ze[r],b,rl[r],T)),this.cache[E]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const r=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(r.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new s.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.terrainDepthFBO&&(this.terrainDepthFBO.destroy(),this.terrainDepthFBO=void 0,this.terrainDepthTexture=void 0)}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(r,h){if(this.style.enable3dLights()){const y=this.style.directionalLight,b=this.style.ambientLight;if(y&&b){const T=((E,I,k)=>{const N=E.properties.get("direction"),H=E.properties.get("color").toRenderColor(k.getLut(E.scope)).toArray01(),X=E.properties.get("intensity"),ee=I.properties.get("color").toRenderColor(k.getLut(I.scope)).toArray01(),ie=I.properties.get("intensity"),ue=[N.x,N.y,N.z],pe=s.bA(ee,ie),fe=s.bA(H,X);return{u_lighting_ambient_color:pe,u_lighting_directional_dir:ue,u_lighting_directional_color:fe,u_ground_radiance:ah(ue,fe,pe)}})(y,b,this.style);h.setLightsUniformValues(r,T)}}}uploadCommonUniforms(r,h,y,b,T){if(this.uploadCommonLightUniforms(r,h),this.terrain&&this.terrain.renderingToTexture)return;const E=this.style.fog;if(E){const I=E.getOpacity(this.transform.pitch),k=((N,H,X,ee,ie,ue,pe,fe,_e,Le,Fe,Be)=>{const $e=N.transform,Ze=H.properties.get("color").toRenderColor(N.style.getLut(H.scope)).toArray01();Ze[3]=ee;const rt=N.frameCounter/1e3%1,[xe,Ne]=H.properties.get("vertical-range");return{u_fog_matrix:X?$e.calculateFogTileMatrix(X):Be||N.identityMat,u_fog_range:H.getFovAdjustedRange($e._fov),u_fog_color:Ze,u_fog_horizon_blend:H.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(xe,Ne),Ne],u_fog_temporal_offset:rt,u_frustum_tl:ie,u_frustum_tr:ue,u_frustum_br:pe,u_frustum_bl:fe,u_globe_pos:_e,u_globe_radius:Le,u_viewport:Fe,u_globe_transition:s.a1($e.zoom),u_is_globe:+($e.projection.name==="globe")}})(this,E,y,I,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*s.e.devicePixelRatio,this.transform.height*s.e.devicePixelRatio],b);h.setFogUniformValues(r,k)}T&&h.setCutoffUniformValues(r,T.uniformValues)}setTileLoadedFlag(r){this.tileLoaded=r}saveCanvasCopy(){const r=this.canvasCopy();r&&(this.frameCopies.push(r),this.tileLoaded=!1)}canvasCopy(){const r=this.context.gl,h=r.createTexture();return r.bindTexture(r.TEXTURE_2D,h),r.copyTexImage2D(r.TEXTURE_2D,0,r.RGBA,0,0,r.drawingBufferWidth,r.drawingBufferHeight,0),h}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const r=this.style&&this.style.fog;return!!r&&r.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const r=this._backgroundTiles,h=this._backgroundTiles={},y=this.transform.coveringTiles({tileSize:512});for(const b of y)h[b.key]=r[b.key]||new s.by(b,512,this.transform.tileZoom,this);return h}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(r,h){return!(!r.is3D()||r.minzoom&&r.minzoom>this.transform.zoom||(this.style._clipLayerIndices.length||r.sourceLayer!=="building")&&r.type!=="clip"&&(!h||h.type!=="batched-model"))}isTileAffectedByFog(r){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let h=this._cachedTileFogOpacities[r.key];return h||(this._cachedTileFogOpacities[r.key]=h=this.style.fog.getOpacityForTile(r)),h[0]>=Wr||h[1]>=Wr}}class zd{constructor(r,h,y,b){this.screenBounds=r,this.cameraPoint=h,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=y,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,b)}static createFromScreenPoints(r,h){let y,b;if(r instanceof s.P||typeof r[0]=="number"){const T=s.P.convert(r);y=[T],b=h.isPointAboveHorizon(T)}else{const T=s.P.convert(r[0]),E=s.P.convert(r[1]);y=[T,E],b=s.cv(T,E).every(I=>h.isPointAboveHorizon(I))}return new zd(y,h.getCameraPoint(),b,h)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(r){return s.cv(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],r)}bufferedCameraGeometry(r){const h=this.screenBounds[0],y=this.screenBounds.length===1?this.screenBounds[0].add(new s.P(1,1)):this.screenBounds[1],b=s.cv(h,y,0,!1);return this.cameraPoint.y>y.y&&(this.cameraPoint.x>h.x&&this.cameraPoint.x<y.x?b.splice(3,0,this.cameraPoint):this.cameraPoint.x>=y.x?b[2]=this.cameraPoint:this.cameraPoint.x<=h.x&&(b[3]=this.cameraPoint)),s.cw(b,r)}bufferedCameraGeometryGlobe(r){const h=this.screenBounds[0],y=this.screenBounds.length===1?this.screenBounds[0].add(new s.P(1,1)):this.screenBounds[1],b=s.cv(h,y,r),T=this.cameraPoint.clone();switch(3*((T.y>h.y)+(T.y>y.y))+((T.x>h.x)+(T.x>y.x))){case 0:b[0]=T,b[4]=T.clone();break;case 1:b.splice(1,0,T);break;case 2:b[1]=T;break;case 3:b.splice(4,0,T);break;case 5:b.splice(2,0,T);break;case 6:b[3]=T;break;case 7:b.splice(3,0,T);break;case 8:b[2]=T}return b}containsTile(r,h,y,b=0){const T=r.queryPadding/h._pixelsPerMercatorPixel+1,E=y?this._bufferedCameraMercator(T,h):this._bufferedScreenMercator(T,h);let I=r.tileID.wrap+(E.unwrapped?b:0);const k=E.polygon.map(fe=>s.cx(r.tileTransform,fe,I));if(!s.cy(k,0,0,s.a3,s.a3))return;I=r.tileID.wrap+(this.screenGeometryMercator.unwrapped?b:0);const N=this.screenGeometryMercator.polygon.map(fe=>s.cz(r.tileTransform,fe,I)),H=N.map(fe=>new s.P(fe[0],fe[1])),X=h.getFreeCameraOptions().position||new s.Y(0,0,0),ee=s.cz(r.tileTransform,X,I),ie=N.map(fe=>{const _e=s._.sub(fe,fe,ee);return s._.normalize(_e,_e),new s.aT(ee,_e)}),ue=s.bB(r,1,h.zoom)*h._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:H,tilespaceRays:ie,bufferedTilespaceGeometry:k,bufferedTilespaceBounds:(pe=s.cA(k),pe.min.x=s.at(pe.min.x,0,s.a3),pe.min.y=s.at(pe.min.y,0,s.a3),pe.max.x=s.at(pe.max.x,0,s.a3),pe.max.y=s.at(pe.max.y,0,s.a3),pe),tile:r,tileID:r.tileID,pixelToTileUnitsFactor:ue};var pe}_bufferedScreenMercator(r,h){const y=Hu(r);if(this._screenRaycastCache[y])return this._screenRaycastCache[y];{let b;return b=h.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(r),h):{polygon:this.bufferedScreenGeometry(r).map(T=>h.pointCoordinate3D(T)),unwrapped:!0},this._screenRaycastCache[y]=b,b}}_bufferedCameraMercator(r,h){const y=Hu(r);if(this._cameraRaycastCache[y])return this._cameraRaycastCache[y];{let b;return b=h.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(r),h):{polygon:this.bufferedCameraGeometry(r).map(T=>h.pointCoordinate3D(T)),unwrapped:!0},this._cameraRaycastCache[y]=b,b}}_projectAndResample(r,h){const y=function(T,E){const I=s.ad.multiply([],E.pixelMatrix,E.globeMatrix),k=[0,-s.cD,0,1],N=[0,s.cD,0,1],H=[0,0,0,1];s.aA.transformMat4(k,k,I),s.aA.transformMat4(N,N,I),s.aA.transformMat4(H,H,I);const X=new s.P(k[0]/k[3],k[1]/k[3]),ee=new s.P(N[0]/N[3],N[1]/N[3]),ie=s.cB(T,X)&&k[3]<H[3],ue=s.cB(T,ee)&&N[3]<H[3];if(!ie&&!ue)return null;const pe=function(rt,xe,Ne){for(let ct=1;ct<rt.length;ct++){const Ot=Gu(xe.pointCoordinate3D(rt[ct-1]).x),mt=Gu(xe.pointCoordinate3D(rt[ct]).x);if(Ne<0){if(Ot<mt)return{idx:ct,t:-Ot/(mt-1-Ot)}}else if(mt<Ot)return{idx:ct,t:(1-Ot)/(mt+1-Ot)}}return null}(T,E,ie?-1:1);if(!pe)return null;const{idx:fe,t:_e}=pe;let Le=fe>1?Zo(T.slice(0,fe),E):[],Fe=fe<T.length?Zo(T.slice(fe),E):[];Le=Le.map(rt=>new s.P(Gu(rt.x),rt.y)),Fe=Fe.map(rt=>new s.P(Gu(rt.x),rt.y));const Be=[...Le];Be.length===0&&Be.push(Fe[Fe.length-1]);const $e=s.a2(Be[Be.length-1].y,(Fe.length===0?Le[0]:Fe[0]).y,_e);let Ze;return Ze=ie?[new s.P(0,$e),new s.P(0,0),new s.P(1,0),new s.P(1,$e)]:[new s.P(1,$e),new s.P(1,1),new s.P(0,1),new s.P(0,$e)],Be.push(...Ze),Fe.length===0?Be.push(Le[0]):Be.push(...Fe),{polygon:Be.map(rt=>new s.Y(rt.x,rt.y)),unwrapped:!1}}(r,h);if(y)return y;const b=function(T,E){let I=!1,k=-1/0,N=0;for(let X=0;X<T.length-1;X++)T[X].x>k&&(k=T[X].x,N=X);for(let X=0;X<T.length-1;X++){const ee=(N+X)%(T.length-1),ie=T[ee],ue=T[ee+1];Math.abs(ie.x-ue.x)>.5&&(ie.x<ue.x?(ie.x+=1,ee===0&&(T[T.length-1].x+=1)):(ue.x+=1,ee+1===T.length-1&&(T[0].x+=1)),I=!0)}const H=s.aj(E.center.lng);return I&&H<Math.abs(H-1)&&T.forEach(X=>{X.x-=1}),{polygon:T,unwrapped:I}}(Zo(r,h).map(T=>new s.P(Gu(T.x),T.y)),h);return{polygon:b.polygon.map(T=>new s.Y(T.x,T.y)),unwrapped:b.unwrapped}}}function Zo(m,r){return s.cC(m,h=>{const y=r.pointCoordinate3D(h);h.x=y.x,h.y=y.y},1/256)}function Gu(m){return m<0?1+m%1:m%1}function Hu(m){return 100*m|0}function Yf(m,r){const h=s.ad.identity([]);return s.ad.scale(h,h,[.5*m.width,.5*-m.height,1]),s.ad.translate(h,h,[1,-1,0]),s.ad.multiply(h,h,m.calculateProjMatrix(r.toUnwrapped())),Float32Array.from(h)}function ju(m,r,h,y,b,T,E,I=!1){const k=m.tilesIn(y,E,I);k.sort(Jf);const N=[];for(const X of k)N.push({wrappedTileID:X.tile.tileID.wrapped().key,queryResults:X.tile.queryRenderedFeatures(r,h,m._state,X,b,T,Yf(m.transform,X.tile.tileID),I)});const H=function(X){const ee={},ie={};for(const ue of X){const pe=ue.queryResults,fe=ue.wrappedTileID,_e=ie[fe]=ie[fe]||{};for(const Le in pe){const Fe=pe[Le],Be=_e[Le]=_e[Le]||{},$e=ee[Le]=ee[Le]||[];for(const Ze of Fe)Be[Ze.featureIndex]||(Be[Ze.featureIndex]=!0,$e.push(Ze))}}return ee}(N);for(const X in H)H[X].forEach(ee=>{const ie=ee.feature,ue=ie.layer;ue&&ue.type!=="background"&&ue.type!=="sky"&&ue.type!=="slot"&&(ie.source=ue.source,ue["source-layer"]&&(ie.sourceLayer=ue["source-layer"]),ie.state=ie.id!==void 0?m.getFeatureState(ue["source-layer"],ie.id):{})});return H}function mg(m,r){const h=m.getRenderableIds().map(T=>m.getTileByID(T)),y=[],b={};for(let T=0;T<h.length;T++){const E=h[T],I=E.tileID.canonical.key;b[I]||(b[I]=!0,E.querySourceFeatures(y,r))}return y}function Jf(m,r){const h=m.tileID,y=r.tileID;return h.overscaledZ-y.overscaledZ||h.canonical.y-y.canonical.y||h.wrap-y.wrap||h.canonical.x-y.canonical.x}class Wu{constructor(r){this.style=r,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const r=!1,h=!1;for(const y in this.style._mergedLayers){const b=this.style._mergedLayers[y];if(b.type==="fill-extrusion")this.layers.push({layer:b,visible:r,visibilityChanged:h});else if(b.type==="model"){const T=this.style.getLayerSource(b);T&&T.type==="batched-model"&&this.layers.push({layer:b,visible:r,visibilityChanged:h})}}}onNewFrame(r){this.layersGotHidden=!1;for(const h of this.layers){const y=h.layer;let b=!1;y.type==="fill-extrusion"?b=!y.isHidden(r)&&y.paint.get("fill-extrusion-opacity")>0:y.type==="model"&&(b=!y.isHidden(r)&&y.paint.get("model-opacity")>0),this.layersGotHidden=this.layersGotHidden||!b&&h.visible,h.visible=b}}updateZOffset(r,h){this.currentBuildingBuckets=[];for(const b of this.layers){const T=b.layer,E=this.style.getLayerSourceCache(T);let I=1;T.type==="fill-extrusion"&&(I=b.visible?T.paint.get("fill-extrusion-vertical-scale"):0);let k=E?E.getTile(h):null;if(!k&&E&&h.canonical.z>E.getSource().minzoom){let N=h.scaledTo(Math.min(E.getSource().maxzoom,h.overscaledZ-1));for(;N.overscaledZ>=E.getSource().minzoom&&(k=E.getTile(N),!k&&N.overscaledZ!==0);)N=N.scaledTo(N.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:k?k.getBucket(T):null,tileID:k?k.tileID:h,verticalScale:I})}r.hasAnyZOffset=!1;let y=!1;for(let b=0;b<r.symbolInstances.length;b++){const T=r.symbolInstances.get(b),E=T.zOffset,I=this._getHeightAtTileOffset(h,T.tileAnchorX,T.tileAnchorY);T.zOffset=I!==Number.NEGATIVE_INFINITY?I:E,y||E===T.zOffset||(y=!0),r.hasAnyZOffset||T.zOffset===0||(r.hasAnyZOffset=!0)}y&&(r.zOffsetBuffersNeedUpload=!0,r.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(r,h,y,b){let T=h,E=y;if(r.canonical.z!==b.canonical.z){const I=b.canonical,k=1/(1<<r.canonical.z-I.z);T=(h+r.canonical.x*s.a3)*k-I.x*s.a3|0,E=(y+r.canonical.y*s.a3)*k-I.y*s.a3|0}return{tileX:T,tileY:E}}_getHeightAtTileOffset(r,h,y){let b,T;for(let E=0;E<this.layers.length;++E){if(this.layers[E].layer.type!=="fill-extrusion")continue;const{bucket:I,tileID:k,verticalScale:N}=this.currentBuildingBuckets[E];if(!I)continue;const{tileX:H,tileY:X}=this._mapCoordToOverlappingTile(r,h,y,k),ee=I.getHeightAtTileCoord(H,X);ee&&ee.height!==void 0&&(ee.hidden?b=ee.height:T=Math.max(ee.height*N,T||0))}if(T!==void 0)return T;for(let E=0;E<this.layers.length;++E){const I=this.layers[E];if(I.layer.type!=="model"||!I.visible)continue;const{bucket:k,tileID:N}=this.currentBuildingBuckets[E];if(!k)continue;const{tileX:H,tileY:X}=this._mapCoordToOverlappingTile(r,h,y,N),ee=k.getHeightAtTileCoord(H,X);if(ee&&!ee.hidden)return ee.height===void 0&&b!==void 0?Math.min(ee.maxHeight,b)*ee.verticalScale:ee.height?ee.height*ee.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function qu(m,r){const h={};for(const y in m)y!=="ref"&&(h[y]=m[y]);return s.cE.forEach(y=>{y in r&&(h[y]=r[y])}),h}function Kf(m){m=m.slice();const r=Object.create(null);for(let h=0;h<m.length;h++)r[m[h].id]=m[h];for(let h=0;h<m.length;h++)"ref"in m[h]&&(m[h]=qu(m[h],r[m[h].ref]));return m}const kr={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport"};function Ip(m,r,h){h.push({command:kr.addSource,args:[m,r[m]]})}function Zu(m,r,h){r.push({command:kr.removeSource,args:[m]}),h[m]=!0}function Sc(m,r,h,y){Zu(m,h,y),Ip(m,r,h)}function Qf(m,r,h){let y;for(y in m[h])if(m[h].hasOwnProperty(y)&&y!=="data"&&!Z(m[h][y],r[h][y]))return!1;for(y in r[h])if(r[h].hasOwnProperty(y)&&y!=="data"&&!Z(m[h][y],r[h][y]))return!1;return!0}function Xu(m,r,h,y,b,T){let E;for(E in r=r||{},m=m||{})m.hasOwnProperty(E)&&(Z(m[E],r[E])||h.push({command:T,args:[y,E,r[E],b]}));for(E in r)r.hasOwnProperty(E)&&!m.hasOwnProperty(E)&&(Z(m[E],r[E])||h.push({command:T,args:[y,E,r[E],b]}))}function Yh(m){return m.id}function Jh(m,r){return m[r.id]=r,m}class gg{constructor(r,h){this.reset(r,h)}reset(r,h){this.points=r||[],this._distances=[0];for(let y=1;y<this.points.length;y++)this._distances[y]=this._distances[y-1]+this.points[y].dist(this.points[y-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(h||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(r){if(this.points.length===1)return this.points[0];r=s.at(r,0,1);let h=1,y=this._distances[h];const b=r*this.paddedLength+this.padding;for(;y<b&&h<this._distances.length;)y=this._distances[++h];const T=h-1,E=this._distances[T],I=y-E,k=I>0?(b-E)/I:0;return this.points[T].mult(1-k).add(this.points[h].mult(k))}}class hl{constructor(r,h,y){const b=this.boxCells=[],T=this.circleCells=[];this.xCellCount=Math.ceil(r/y),this.yCellCount=Math.ceil(h/y);for(let E=0;E<this.xCellCount*this.yCellCount;E++)b.push([]),T.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=r,this.height=h,this.xScale=this.xCellCount/r,this.yScale=this.yCellCount/h,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(r,h,y,b,T){this._forEachCell(h,y,b,T,this._insertBoxCell,this.boxUid++),this.boxKeys.push(r),this.bboxes.push(h),this.bboxes.push(y),this.bboxes.push(b),this.bboxes.push(T)}insertCircle(r,h,y,b){this._forEachCell(h-b,y-b,h+b,y+b,this._insertCircleCell,this.circleUid++),this.circleKeys.push(r),this.circles.push(h),this.circles.push(y),this.circles.push(b)}_insertBoxCell(r,h,y,b,T,E){this.boxCells[T].push(E)}_insertCircleCell(r,h,y,b,T,E){this.circleCells[T].push(E)}_query(r,h,y,b,T,E){if(y<0||r>this.width||b<0||h>this.height)return!T&&[];const I=[];if(r<=0&&h<=0&&this.width<=y&&this.height<=b){if(T)return!0;for(let k=0;k<this.boxKeys.length;k++)I.push({key:this.boxKeys[k],x1:this.bboxes[4*k],y1:this.bboxes[4*k+1],x2:this.bboxes[4*k+2],y2:this.bboxes[4*k+3]});for(let k=0;k<this.circleKeys.length;k++){const N=this.circles[3*k],H=this.circles[3*k+1],X=this.circles[3*k+2];I.push({key:this.circleKeys[k],x1:N-X,y1:H-X,x2:N+X,y2:H+X})}return E?I.filter(E):I}return this._forEachCell(r,h,y,b,this._queryCell,I,{hitTest:T,seenUids:{box:{},circle:{}}},E),T?I.length>0:I}_queryCircle(r,h,y,b,T){const E=r-y,I=r+y,k=h-y,N=h+y;if(I<0||E>this.width||N<0||k>this.height)return!b&&[];const H=[];return this._forEachCell(E,k,I,N,this._queryCellCircle,H,{hitTest:b,circle:{x:r,y:h,radius:y},seenUids:{box:{},circle:{}}},T),b?H.length>0:H}query(r,h,y,b,T){return this._query(r,h,y,b,!1,T)}hitTest(r,h,y,b,T){return this._query(r,h,y,b,!0,T)}hitTestCircle(r,h,y,b){return this._queryCircle(r,h,y,!0,b)}_queryCell(r,h,y,b,T,E,I,k){const N=I.seenUids,H=this.boxCells[T];if(H!==null){const ee=this.bboxes;for(const ie of H)if(!N.box[ie]){N.box[ie]=!0;const ue=4*ie;if(r<=ee[ue+2]&&h<=ee[ue+3]&&y>=ee[ue+0]&&b>=ee[ue+1]&&(!k||k(this.boxKeys[ie]))){if(I.hitTest)return E.push(!0),!0;E.push({key:this.boxKeys[ie],x1:ee[ue],y1:ee[ue+1],x2:ee[ue+2],y2:ee[ue+3]})}}}const X=this.circleCells[T];if(X!==null){const ee=this.circles;for(const ie of X)if(!N.circle[ie]){N.circle[ie]=!0;const ue=3*ie;if(this._circleAndRectCollide(ee[ue],ee[ue+1],ee[ue+2],r,h,y,b)&&(!k||k(this.circleKeys[ie]))){if(I.hitTest)return E.push(!0),!0;{const pe=ee[ue],fe=ee[ue+1],_e=ee[ue+2];E.push({key:this.circleKeys[ie],x1:pe-_e,y1:fe-_e,x2:pe+_e,y2:fe+_e})}}}}}_queryCellCircle(r,h,y,b,T,E,I,k){const N=I.circle,H=I.seenUids,X=this.boxCells[T];if(X!==null){const ie=this.bboxes;for(const ue of X)if(!H.box[ue]){H.box[ue]=!0;const pe=4*ue;if(this._circleAndRectCollide(N.x,N.y,N.radius,ie[pe+0],ie[pe+1],ie[pe+2],ie[pe+3])&&(!k||k(this.boxKeys[ue])))return E.push(!0),!0}}const ee=this.circleCells[T];if(ee!==null){const ie=this.circles;for(const ue of ee)if(!H.circle[ue]){H.circle[ue]=!0;const pe=3*ue;if(this._circlesCollide(ie[pe],ie[pe+1],ie[pe+2],N.x,N.y,N.radius)&&(!k||k(this.circleKeys[ue])))return E.push(!0),!0}}}_forEachCell(r,h,y,b,T,E,I,k){const N=this._convertToXCellCoord(r),H=this._convertToYCellCoord(h),X=this._convertToXCellCoord(y),ee=this._convertToYCellCoord(b);for(let ie=N;ie<=X;ie++)for(let ue=H;ue<=ee;ue++)if(T.call(this,r,h,y,b,this.xCellCount*ue+ie,E,I,k))return}_convertToXCellCoord(r){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(r*this.xScale)))}_convertToYCellCoord(r){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(r*this.yScale)))}_circlesCollide(r,h,y,b,T,E){const I=b-r,k=T-h,N=y+E;return N*N>I*I+k*k}_circleAndRectCollide(r,h,y,b,T,E,I){const k=(E-b)/2,N=Math.abs(r-(b+k));if(N>k+y)return!1;const H=(I-T)/2,X=Math.abs(h-(T+H));if(X>H+y)return!1;if(N<=k||X<=H)return!0;const ee=N-k,ie=X-H;return ee*ee+ie*ie<=y*y}}const Va=100;class em{constructor(r,h,y=new hl(r.width+200,r.height+200,25),b=new hl(r.width+200,r.height+200,25)){this.transform=r,this.grid=y,this.ignoredGrid=b,this.pitchfactor=Math.cos(r._pitch)*r.cameraToCenterDistance,this.screenRightBoundary=r.width+Va,this.screenBottomBoundary=r.height+Va,this.gridRightBoundary=r.width+200,this.gridBottomBoundary=r.height+200,this.fogState=h}placeCollisionBox(r,h,y,b,T,E,I,k){let N=y.projectedAnchorX,H=y.projectedAnchorY,X=y.projectedAnchorZ;const ee=y.elevation,ie=y.tileID,ue=r.getProjection();if(ee&&ie){const[Ze,rt,xe]=ue.upVector(ie.canonical,y.tileAnchorX,y.tileAnchorY),Ne=ue.upVectorScale(ie.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;N+=Ze*ee*Ne,H+=rt*ee*Ne,X+=xe*ee*Ne}const pe=this.projectAndGetPerspectiveRatio(I,N,H,X,y.tileID,ue.name==="globe"||!!ee||this.transform.pitch>0,ue),fe=E*pe.perspectiveRatio,_e=(y.x1*h+b.x-y.padding)*fe+pe.point.x,Le=(y.y1*h+b.y-y.padding)*fe+pe.point.y,Fe=(y.x2*h+b.x+y.padding)*fe+pe.point.x,Be=(y.y2*h+b.y+y.padding)*fe+pe.point.y,$e=pe.perspectiveRatio<=.55||pe.occluded;return!this.isInsideGrid(_e,Le,Fe,Be)||!T&&this.grid.hitTest(_e,Le,Fe,Be,k)||$e?{box:[],offscreen:!1,occluded:pe.occluded}:{box:[_e,Le,Fe,Be],offscreen:this.isOffscreen(_e,Le,Fe,Be),occluded:!1}}placeCollisionCircles(r,h,y,b,T,E,I,k,N,H,X,ee,ie,ue,pe){const fe=[],_e=this.transform.elevation,Le=r.getProjection(),Fe=_e?_e.getAtTileOffsetFunc(pe,this.transform.center.lat,this.transform.worldSize,Le):null,Be=new s.P(y.tileAnchorX,y.tileAnchorY);let{x:$e,y:Ze,z:rt}=Le.projectTilePoint(Be.x,Be.y,pe.canonical);if(Fe){const[hi,vt,Gt]=Fe(Be);$e+=hi,Ze+=vt,rt+=Gt}const xe=Le.name==="globe",Ne=this.projectAndGetPerspectiveRatio(I,$e,Ze,rt,pe,xe||!!_e||this.transform.pitch>0,Le),{perspectiveRatio:ct}=Ne,Ot=(X?E/ct:E*ct)/s.bN,mt=Ds($e,Ze,rt,k),it=Ne.signedDistanceFromCamera>0?Xs(Ot,T,y.lineOffsetX*Ot,y.lineOffsetY*Ot,!1,mt,Be,y,b,k,{},_e&&!X?Fe:null,X&&!!_e,Le,pe,X):null;let Nt=!1,mi=!1,_i=!0;if(it&&!Ne.occluded){const hi=.5*ie*ct+ue,vt=new s.P(-100,-100),Gt=new s.P(this.screenRightBoundary,this.screenBottomBoundary),ri=new gg,{first:$i,last:Yi}=it,hn=$i.path.length;let Ji=[];for(let xn=hn-1;xn>=1;xn--)Ji.push($i.path[xn]);for(let xn=1;xn<Yi.path.length;xn++)Ji.push(Yi.path[xn]);const Gi=2.5*hi;N&&(Ji=Ji.map(([xn,Tr,Wn],cr)=>(Fe&&!xe&&(Wn=Fe(cr<hn-1?$i.tilePath[hn-1-cr]:Yi.tilePath[cr-hn+2])[2]),Ds(xn,Tr,Wn,N))),Ji.some(xn=>xn[3]<=0)&&(Ji=[]));let Qt=[];if(Ji.length>0){let xn=1/0,Tr=-1/0,Wn=1/0,cr=-1/0;for(const er of Ji)xn=Math.min(xn,er[0]),Wn=Math.min(Wn,er[1]),Tr=Math.max(Tr,er[0]),cr=Math.max(cr,er[1]);Tr>=vt.x&&xn<=Gt.x&&cr>=vt.y&&Wn<=Gt.y&&(Qt=[Ji.map(er=>new s.P(er[0],er[1]))],(xn<vt.x||Tr>Gt.x||Wn<vt.y||cr>Gt.y)&&(Qt=s.cF(Qt,vt.x,vt.y,Gt.x,Gt.y)))}for(const xn of Qt){ri.reset(xn,.25*hi);let Tr=0;Tr=ri.length<=.5*hi?1:Math.ceil(ri.paddedLength/Gi)+1;for(let Wn=0;Wn<Tr;Wn++){const cr=Wn/Math.max(Tr-1,1),er=ri.lerp(cr),xs=er.x+Va,zr=er.y+Va;fe.push(xs,zr,hi,0);const ir=xs-hi,ls=zr-hi,Zr=xs+hi,Or=zr+hi;if(_i=_i&&this.isOffscreen(ir,ls,Zr,Or),mi=mi||this.isInsideGrid(ir,ls,Zr,Or),!h&&this.grid.hitTestCircle(xs,zr,hi,ee)&&(Nt=!0,!H))return{circles:[],offscreen:!1,collisionDetected:Nt,occluded:!1}}}}return{circles:!H&&Nt||!mi?[]:fe,offscreen:_i,collisionDetected:Nt,occluded:Ne.occluded}}queryRenderedSymbols(r){if(r.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const h=[];let y=1/0,b=1/0,T=-1/0,E=-1/0;for(const H of r){const X=new s.P(H.x+Va,H.y+Va);y=Math.min(y,X.x),b=Math.min(b,X.y),T=Math.max(T,X.x),E=Math.max(E,X.y),h.push(X)}const I=this.grid.query(y,b,T,E).concat(this.ignoredGrid.query(y,b,T,E)),k={},N={};for(const H of I){const X=H.key;if(k[X.bucketInstanceId]===void 0&&(k[X.bucketInstanceId]={}),k[X.bucketInstanceId][X.featureIndex])continue;const ee=[new s.P(H.x1,H.y1),new s.P(H.x2,H.y1),new s.P(H.x2,H.y2),new s.P(H.x1,H.y2)];s.cG(h,ee)&&(k[X.bucketInstanceId][X.featureIndex]=!0,N[X.bucketInstanceId]===void 0&&(N[X.bucketInstanceId]=[]),N[X.bucketInstanceId].push(X.featureIndex))}return N}insertCollisionBox(r,h,y,b,T){(h?this.ignoredGrid:this.grid).insert({bucketInstanceId:y,featureIndex:b,collisionGroupID:T},r[0],r[1],r[2],r[3])}insertCollisionCircles(r,h,y,b,T){const E=h?this.ignoredGrid:this.grid,I={bucketInstanceId:y,featureIndex:b,collisionGroupID:T};for(let k=0;k<r.length;k+=4)E.insertCircle(I,r[k],r[k+1],r[k+2])}projectAndGetPerspectiveRatio(r,h,y,b,T,E,I){const k=[h,y,b,1];let N=!1;b||this.transform.pitch>0?(s.aA.transformMat4(k,k,r),this.fogState&&T&&I.name!=="globe"&&(N=function(ee,ie,ue,pe,fe,_e){const Le=_e.calculateFogTileMatrix(fe),Fe=[ie,ue,pe];return s._.transformMat4(Fe,Fe,Le),ss(ee,s._.length(Fe),_e.pitch,_e._fov)}(this.fogState,h,y,b,T.toUnwrapped(),this.transform)>.9)):nh(k,k,r);const H=k[3];return{point:new s.P((k[0]/H+1)/2*this.transform.width+Va,(-k[1]/H+1)/2*this.transform.height+Va),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(I)/H*.5,1.5),signedDistanceFromCamera:H,occluded:E&&k[2]>H||N}}isOffscreen(r,h,y,b){return y<Va||r>=this.screenRightBoundary||b<Va||h>this.screenBottomBoundary}isInsideGrid(r,h,y,b){return y>=0&&r<this.gridRightBoundary&&b>=0&&h<this.gridBottomBoundary}getViewportMatrix(){const r=s.ad.identity([]);return s.ad.translate(r,r,[-100,-100,0]),r}}class Od{constructor(r,h,y,b){this.opacity=r?Math.max(0,Math.min(1,r.opacity+(r.placed?h:-h))):b&&y?1:0,this.placed=y}isHidden(){return this.opacity===0&&!this.placed}}class ph{constructor(r,h,y,b,T,E=!1){this.text=new Od(r?r.text:null,h,y,T),this.icon=new Od(r?r.icon:null,h,b,T),this.clipped=E}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class fa{constructor(r,h,y,b=!1){this.text=r,this.icon=h,this.skipFade=y,this.clipped=b}}class Fd{constructor(){this.invProjMatrix=s.ad.create(),this.viewportMatrix=s.ad.create(),this.circles=[]}}class tm{constructor(r,h,y,b,T){this.bucketInstanceId=r,this.featureIndex=h,this.sourceLayerIndex=y,this.bucketIndex=b,this.tileID=T}}class Kh{constructor(r){this.crossSourceCollisions=r,this.maxGroupID=0,this.collisionGroups={}}get(r){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[r]){const h=++this.maxGroupID;this.collisionGroups[r]={ID:h,predicate:y=>y.collisionGroupID===h}}return this.collisionGroups[r]}}function fh(m,r,h,y,b){const{horizontalAlign:T,verticalAlign:E}=s.bQ(m),I=-(T-.5)*r,k=-(E-.5)*h,N=s.bP(m,y);return new s.P(I+N[0]*b,k+N[1]*b)}function Ec(m,r,h,y,b){const T=new s.P(m,r);return h&&T._rotate(y?b:-b),T}class im{constructor(r,h,y,b,T,E){this.transform=r.clone(),this.projection=r.projection.name,this.collisionIndex=new em(this.transform,T),this.buildingIndex=E,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=h,this.retainedQueryData={},this.collisionGroups=new Kh(y),this.collisionCircleArrays={},this.prevPlacement=b,b&&(b.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(r,h,y,b){const T=y.getBucket(h),E=y.latestFeatureIndex;if(!T||!E||h.fqid!==T.layerIds[0])return;const I=T.layers[0].layout,k=y.collisionBoxArray,N=Math.pow(2,this.transform.zoom-y.tileID.overscaledZ),H=y.tileSize/s.a3,X=y.tileID.toUnwrapped();this.transform.setProjection(T.projection);const ee=(ie=y.tileID,ue=T.getProjection(),pe=this.transform,ue.name===this.projection?pe.calculateProjMatrix(ie.toUnwrapped()):Du(pe,ue,ie));var ie,ue,pe;const fe=I.get("text-pitch-alignment")==="map",_e=I.get("text-rotation-alignment")==="map";h.compileFilter();const Le=h.dynamicFilter(),Fe=h.dynamicFilterNeedsFeature(),Be=this.transform.calculatePixelsToTileUnitsMatrix(y),$e=Mo(ee,y.tileID.canonical,fe,_e,this.transform,T.getProjection(),Be);let Ze=null;if(fe){const Ne=To(ee,y.tileID.canonical,fe,_e,this.transform,T.getProjection(),Be);Ze=s.ad.multiply([],this.transform.labelPlaneMatrix,Ne)}let rt=null;Le&&y.latestFeatureIndex&&(rt={unwrappedTileID:X,dynamicFilter:Le,dynamicFilterNeedsFeature:Fe,featureIndex:y.latestFeatureIndex}),this.retainedQueryData[T.bucketInstanceId]=new tm(T.bucketInstanceId,E,T.sourceLayerIndex,T.index,y.tileID);const xe={bucket:T,layout:I,posMatrix:ee,textLabelPlaneMatrix:$e,labelToScreenMatrix:Ze,clippingData:rt,scale:N,textPixelRatio:H,holdingForFade:y.holdingForFade(),collisionBoxArray:k,partiallyEvaluatedTextSize:s.aD(T.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:s.aD(T.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(T.sourceID)};if(b)for(const Ne of T.sortKeyRanges){const{sortKey:ct,symbolInstanceStart:Ot,symbolInstanceEnd:mt}=Ne;r.push({sortKey:ct,symbolInstanceStart:Ot,symbolInstanceEnd:mt,parameters:xe})}else r.push({symbolInstanceStart:0,symbolInstanceEnd:T.symbolInstances.length,parameters:xe})}attemptAnchorPlacement(r,h,y,b,T,E,I,k,N,H,X,ee,ie,ue,pe,fe,_e,Le){const{textOffset0:Fe,textOffset1:Be,crossTileID:$e}=ee,Ze=[Fe,Be],rt=fh(r,y,b,Ze,T),xe=this.collisionIndex.placeCollisionBox(ue,T,h,Ec(rt.x,rt.y,E,I,this.transform.angle),X,k,N,H.predicate);if(fe){const Ne=ue.getSymbolInstanceIconSize(Le,this.transform.zoom,ee.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(ue,Ne,fe,Ec(rt.x,rt.y,E,I,this.transform.angle),X,k,N,H.predicate).box.length===0)return}if(xe.box.length>0){let Ne;return this.prevPlacement&&this.prevPlacement.variableOffsets[$e]&&this.prevPlacement.placements[$e]&&this.prevPlacement.placements[$e].text&&(Ne=this.prevPlacement.variableOffsets[$e].anchor),this.variableOffsets[$e]={textOffset:Ze,width:y,height:b,anchor:r,textScale:T,prevAnchor:Ne},this.markUsedJustification(ue,r,ee,pe),ue.allowVerticalPlacement&&(this.markUsedOrientation(ue,pe,ee),this.placedOrientations[$e]=pe),{shift:rt,placedGlyphBoxes:xe}}}placeLayerBucketPart(r,h,y,b){const{bucket:T,layout:E,posMatrix:I,textLabelPlaneMatrix:k,labelToScreenMatrix:N,clippingData:H,textPixelRatio:X,holdingForFade:ee,collisionBoxArray:ie,partiallyEvaluatedTextSize:ue,partiallyEvaluatedIconSize:pe,collisionGroup:fe}=r.parameters,_e=E.get("text-optional"),Le=E.get("icon-optional"),Fe=E.get("text-allow-overlap"),Be=E.get("icon-allow-overlap"),$e=E.get("text-rotation-alignment")==="map",Ze=E.get("text-pitch-alignment")==="map",rt=E.get("symbol-z-order")==="viewport-y",xe=E.get("symbol-z-elevate");this.transform.setProjection(T.projection);let Ne=Fe&&(Be||!T.hasIconData()||Le),ct=Be&&(Fe||!T.hasTextData()||_e);!T.collisionArrays&&ie&&T.deserializeCollisionBoxes(ie),y&&b&&T.updateCollisionDebugBuffers(this.transform.zoom,ie);const Ot=(mt,it,Nt)=>{const{crossTileID:mi,numVerticalGlyphVertices:_i}=mt;if(H){const Zr={zoom:this.transform.zoom,pitch:this.transform.pitch};let Or=null;if(H.dynamicFilterNeedsFeature){const dr=this.retainedQueryData[T.bucketInstanceId];Or=H.featureIndex.loadFeature({featureIndex:mt.featureIndex,bucketIndex:dr.bucketIndex,sourceLayerIndex:dr.sourceLayerIndex,layoutVertexArrayOffset:0})}if(!(0,H.dynamicFilter)(Zr,Or,this.retainedQueryData[T.bucketInstanceId].tileID.canonical,new s.P(mt.tileAnchorX,mt.tileAnchorY),this.transform.calculateDistanceTileData(H.unwrappedTileID)))return this.placements[mi]=new fa(!1,!1,!1,!0),void h.add(mi)}if(h.has(mi))return;if(ee)return void(this.placements[mi]=new fa(!1,!1,!1));let hi=!1,vt=!1,Gt=!0,ri=!1,$i=!1,Yi=null,hn={box:null,offscreen:null,occluded:null},Ji={box:null,offscreen:null,occluded:null},Gi=null,Qt=null,xn=null,Tr=0,Wn=0,cr=0;Nt.textFeatureIndex?Tr=Nt.textFeatureIndex:mt.useRuntimeCollisionCircles&&(Tr=mt.featureIndex),Nt.verticalTextFeatureIndex&&(Wn=Nt.verticalTextFeatureIndex);const er=Zr=>{Zr.tileID=this.retainedQueryData[T.bucketInstanceId].tileID;const Or=this.transform.elevation;Zr.elevation=mt.zOffset+(Or?Or.getAtTileOffset(Zr.tileID,Zr.tileAnchorX,Zr.tileAnchorY):0)},xs=Nt.textBox;if(xs){er(xs);const Zr=dr=>{let hs=s.aE.horizontal;if(T.allowVerticalPlacement&&!dr&&this.prevPlacement){const ks=this.prevPlacement.placedOrientations[mi];ks&&(this.placedOrientations[mi]=ks,hs=ks,this.markUsedOrientation(T,hs,mt))}return hs},Or=(dr,hs)=>{if(T.allowVerticalPlacement&&_i>0&&Nt.verticalTextBox){for(const ks of T.writingModes)if(ks===s.aE.vertical?(hn=hs(),Ji=hn):hn=dr(),hn&&hn.box&&hn.box.length)break}else hn=dr()};if(E.get("text-variable-anchor")){let dr=E.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[mi]){const Ur=this.prevPlacement.variableOffsets[mi];dr.indexOf(Ur.anchor)>0&&(dr=dr.filter(vs=>vs!==Ur.anchor),dr.unshift(Ur.anchor))}const hs=(Ur,vs,oi)=>{const on=T.getSymbolInstanceTextSize(ue,mt,this.transform.zoom,it),Eo=(Ur.x2-Ur.x1)*on+2*Ur.padding,Br=(Ur.y2-Ur.y1)*on+2*Ur.padding,Pt=mt.hasIconTextFit&&!Be?vs:null;Pt&&er(Pt);let ao={box:[],offscreen:!1,occluded:!1};const yo=Fe?2*dr.length:dr.length;for(let Ys=0;Ys<yo;++Ys){const io=this.attemptAnchorPlacement(dr[Ys%dr.length],Ur,Eo,Br,on,$e,Ze,X,I,fe,Ys>=dr.length,mt,it,T,oi,Pt,ue,pe);if(io&&(ao=io.placedGlyphBoxes,ao&&ao.box&&ao.box.length)){hi=!0,Yi=io.shift;break}}return ao};Or(()=>hs(xs,Nt.iconBox,s.aE.horizontal),()=>{const Ur=Nt.verticalTextBox;return Ur&&er(Ur),T.allowVerticalPlacement&&!(hn&&hn.box&&hn.box.length)&&_i>0&&Ur?hs(Ur,Nt.verticalIconBox,s.aE.vertical):{box:null,offscreen:null,occluded:null}}),hn&&(hi=hn.box,Gt=hn.offscreen,ri=hn.occluded);const ks=Zr(!(!hn||!hn.box));if(!hi&&this.prevPlacement){const Ur=this.prevPlacement.variableOffsets[mi];Ur&&(this.variableOffsets[mi]=Ur,this.markUsedJustification(T,Ur.anchor,mt,ks))}}else{const dr=(hs,ks)=>{const Ur=T.getSymbolInstanceTextSize(ue,mt,this.transform.zoom,it),vs=this.collisionIndex.placeCollisionBox(T,Ur,hs,new s.P(0,0),Fe,X,I,fe.predicate);return vs&&vs.box&&vs.box.length&&(this.markUsedOrientation(T,ks,mt),this.placedOrientations[mi]=ks),vs};Or(()=>dr(xs,s.aE.horizontal),()=>{const hs=Nt.verticalTextBox;return T.allowVerticalPlacement&&_i>0&&hs?(er(hs),dr(hs,s.aE.vertical)):{box:null,offscreen:null,occluded:null}}),Zr(!!(hn&&hn.box&&hn.box.length))}}if(Gi=hn,hi=Gi&&Gi.box&&Gi.box.length>0,Gt=Gi&&Gi.offscreen,ri=Gi&&Gi.occluded,mt.useRuntimeCollisionCircles){const Zr=T.text.placedSymbolArray.get(mt.centerJustifiedTextSymbolIndex>=0?mt.centerJustifiedTextSymbolIndex:mt.verticalPlacedTextSymbolIndex),Or=s.aF(T.textSizeData,ue,Zr),dr=E.get("text-padding");Qt=this.collisionIndex.placeCollisionCircles(T,Fe,Zr,T.lineVertexArray,T.glyphOffsetArray,Or,I,k,N,y,Ze,fe.predicate,mt.collisionCircleDiameter*Or/s.bN,dr,this.retainedQueryData[T.bucketInstanceId].tileID),hi=Fe||Qt.circles.length>0&&!Qt.collisionDetected,Gt=Gt&&Qt.offscreen,ri=Qt.occluded}if(Nt.iconFeatureIndex&&(cr=Nt.iconFeatureIndex),Nt.iconBox){const Zr=Or=>{er(Or);const dr=mt.hasIconTextFit&&Yi?Ec(Yi.x,Yi.y,$e,Ze,this.transform.angle):new s.P(0,0),hs=T.getSymbolInstanceIconSize(pe,this.transform.zoom,mt.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(T,hs,Or,dr,Be,X,I,fe.predicate)};Ji&&Ji.box&&Ji.box.length&&Nt.verticalIconBox?(xn=Zr(Nt.verticalIconBox),vt=xn.box.length>0):(xn=Zr(Nt.iconBox),vt=xn.box.length>0),Gt=Gt&&xn.offscreen,$i=xn.occluded}const zr=_e||mt.numHorizontalGlyphVertices===0&&_i===0,ir=Le||mt.numIconVertices===0;if(zr||ir?ir?zr||(vt=vt&&hi):hi=vt&&hi:vt=hi=vt&&hi,hi&&Gi&&Gi.box&&this.collisionIndex.insertCollisionBox(Gi.box,E.get("text-ignore-placement"),T.bucketInstanceId,Ji&&Ji.box&&Wn?Wn:Tr,fe.ID),vt&&xn&&this.collisionIndex.insertCollisionBox(xn.box,E.get("icon-ignore-placement"),T.bucketInstanceId,cr,fe.ID),Qt&&(hi&&this.collisionIndex.insertCollisionCircles(Qt.circles,E.get("text-ignore-placement"),T.bucketInstanceId,Tr,fe.ID),y)){const Zr=T.bucketInstanceId;let Or=this.collisionCircleArrays[Zr];Or===void 0&&(Or=this.collisionCircleArrays[Zr]=new Fd);for(let dr=0;dr<Qt.circles.length;dr+=4)Or.circles.push(Qt.circles[dr+0]),Or.circles.push(Qt.circles[dr+1]),Or.circles.push(Qt.circles[dr+2]),Or.circles.push(Qt.collisionDetected?1:0)}const ls=T.projection.name!=="globe";Ne=Ne&&(ls||!ri),ct=ct&&(ls||!$i),this.placements[mi]=new fa(hi||Ne,vt||ct,Gt||T.justReloaded),h.add(mi)};if(xe&&this.buildingIndex&&(this.buildingIndex.updateZOffset(T,this.retainedQueryData[T.bucketInstanceId].tileID),T.updateZOffset()),rt){const mt=T.getSortedSymbolIndexes(this.transform.angle);for(let it=mt.length-1;it>=0;--it){const Nt=mt[it];Ot(T.symbolInstances.get(Nt),Nt,T.collisionArrays[Nt])}T.hasAnyZOffset&&s.w(`${T.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(T.hasAnyZOffset){const mt=T.getSortedIndexesByZOffset();for(let it=0;it<mt.length;++it){const Nt=mt[it];Ot(T.symbolInstances.get(Nt),Nt,T.collisionArrays[Nt])}}else for(let mt=r.symbolInstanceStart;mt<r.symbolInstanceEnd;mt++)Ot(T.symbolInstances.get(mt),mt,T.collisionArrays[mt]);if(y&&T.bucketInstanceId in this.collisionCircleArrays){const mt=this.collisionCircleArrays[T.bucketInstanceId];s.ad.invert(mt.invProjMatrix,I),mt.viewportMatrix=this.collisionIndex.getViewportMatrix()}T.justReloaded=!1}markUsedJustification(r,h,y,b){const{leftJustifiedTextSymbolIndex:T,centerJustifiedTextSymbolIndex:E,rightJustifiedTextSymbolIndex:I,verticalPlacedTextSymbolIndex:k,crossTileID:N}=y,H=s.cJ(h),X=b===s.aE.vertical?k:H==="left"?T:H==="center"?E:H==="right"?I:-1;T>=0&&(r.text.placedSymbolArray.get(T).crossTileID=X>=0&&T!==X?0:N),E>=0&&(r.text.placedSymbolArray.get(E).crossTileID=X>=0&&E!==X?0:N),I>=0&&(r.text.placedSymbolArray.get(I).crossTileID=X>=0&&I!==X?0:N),k>=0&&(r.text.placedSymbolArray.get(k).crossTileID=X>=0&&k!==X?0:N)}markUsedOrientation(r,h,y){const b=h===s.aE.horizontal||h===s.aE.horizontalOnly?h:0,T=h===s.aE.vertical?h:0,{leftJustifiedTextSymbolIndex:E,centerJustifiedTextSymbolIndex:I,rightJustifiedTextSymbolIndex:k,verticalPlacedTextSymbolIndex:N}=y,H=r.text.placedSymbolArray;E>=0&&(H.get(E).placedOrientation=b),I>=0&&(H.get(I).placedOrientation=b),k>=0&&(H.get(k).placedOrientation=b),N>=0&&(H.get(N).placedOrientation=T)}commit(r){this.commitTime=r,this.zoomAtLastRecencyCheck=this.transform.zoom;const h=this.prevPlacement;let y=!1;this.prevZoomAdjustment=h?h.zoomAdjustment(this.transform.zoom):0;const b=h?h.symbolFadeChange(r):1,T=h?h.opacities:{},E=h?h.variableOffsets:{},I=h?h.placedOrientations:{};for(const k in this.placements){const N=this.placements[k],H=T[k];H?(this.opacities[k]=new ph(H,b,N.text,N.icon,null,N.clipped),y=y||N.text!==H.text.placed||N.icon!==H.icon.placed):(this.opacities[k]=new ph(null,b,N.text,N.icon,N.skipFade,N.clipped),y=y||N.text||N.icon)}for(const k in T){const N=T[k];if(!this.opacities[k]){const H=new ph(N,b,!1,!1);H.isHidden()||(this.opacities[k]=H,y=y||N.text.placed||N.icon.placed)}}for(const k in E)this.variableOffsets[k]||!this.opacities[k]||this.opacities[k].isHidden()||(this.variableOffsets[k]=E[k]);for(const k in I)this.placedOrientations[k]||!this.opacities[k]||this.opacities[k].isHidden()||(this.placedOrientations[k]=I[k]);y?this.lastPlacementChangeTime=r:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=h?h.lastPlacementChangeTime:r)}updateLayerOpacities(r,h,y,b){const T=new Set;for(const E of h){const I=E.getBucket(r);I&&E.latestFeatureIndex&&r.fqid===I.layerIds[0]&&(this.updateBucketOpacities(I,T,E.collisionBoxArray,y,b,E.tileID),I.layers[0].layout.get("symbol-z-elevate")&&this.buildingIndex&&(this.buildingIndex.updateZOffset(I,E.tileID),I.updateZOffset()))}}updateBucketOpacities(r,h,y,b,T,E){r.hasTextData()&&r.text.opacityVertexArray.clear(),r.hasIconData()&&r.icon.opacityVertexArray.clear(),r.hasIconCollisionBoxData()&&r.iconCollisionBox.collisionVertexArray.clear(),r.hasTextCollisionBoxData()&&r.textCollisionBox.collisionVertexArray.clear();const I=r.layers[0].layout,k=!!r.layers[0].dynamicFilter(),N=new ph(null,0,!1,!1,!0),H=I.get("text-allow-overlap"),X=I.get("icon-allow-overlap"),ee=I.get("text-variable-anchor"),ie=I.get("text-rotation-alignment")==="map",ue=I.get("text-pitch-alignment")==="map",pe=new ph(null,0,H&&(X||!r.hasIconData()||I.get("icon-optional")),X&&(H||!r.hasTextData()||I.get("text-optional")),!0);!r.collisionArrays&&y&&(r.hasIconCollisionBoxData()||r.hasTextCollisionBoxData())&&r.deserializeCollisionBoxes(y);const fe=(Le,Fe,Be)=>{for(let $e=0;$e<Fe/4;$e++)Le.opacityVertexArray.emplaceBack(Be)};let _e=0;T&&r.updateReplacement(E,T);for(let Le=0;Le<r.symbolInstances.length;Le++){const Fe=r.symbolInstances.get(Le),{numHorizontalGlyphVertices:Be,numVerticalGlyphVertices:$e,crossTileID:Ze,numIconVertices:rt,tileAnchorX:xe,tileAnchorY:Ne}=Fe,ct=h.has(Ze);let Ot=this.opacities[Ze];ct?Ot=N:Ot||(Ot=pe,this.opacities[Ze]=Ot),h.add(Ze);const mt=Be>0||$e>0,it=rt>0,Nt=this.placedOrientations[Ze],mi=Nt===s.aE.vertical,_i=Nt===s.aE.horizontal||Nt===s.aE.horizontalOnly;!mt&&!it||Ot.isHidden()||_e++;let hi=!1;if((mt||it)&&T)for(const vt of r.activeReplacements){if(vt.order<b||vt.order===1/0||!(vt.clipMask&s.cu.Symbol)||vt.min.x>xe||xe>vt.max.x||vt.min.y>Ne||Ne>vt.max.y)continue;const Gt=s.cH(xe,Ne,E.canonical,vt.footprintTileId.canonical);if(hi=s.cI(Gt,vt),hi)break}if(mt){const vt=hi?ma:$u(Ot.text);fe(r.text,Be,mi?ma:vt),fe(r.text,$e,_i?ma:vt);const Gt=Ot.text.isHidden(),{leftJustifiedTextSymbolIndex:ri,centerJustifiedTextSymbolIndex:$i,rightJustifiedTextSymbolIndex:Yi,verticalPlacedTextSymbolIndex:hn}=Fe,Ji=r.text.placedSymbolArray,Gi=Gt||mi?1:0;ri>=0&&(Ji.get(ri).hidden=Gi),$i>=0&&(Ji.get($i).hidden=Gi),Yi>=0&&(Ji.get(Yi).hidden=Gi),hn>=0&&(Ji.get(hn).hidden=Gt||_i?1:0);const Qt=this.variableOffsets[Ze];Qt&&this.markUsedJustification(r,Qt.anchor,Fe,Nt);const xn=this.placedOrientations[Ze];xn&&(this.markUsedJustification(r,"left",Fe,xn),this.markUsedOrientation(r,xn,Fe))}if(it){const vt=hi?ma:$u(Ot.icon),{placedIconSymbolIndex:Gt,verticalPlacedIconSymbolIndex:ri}=Fe,$i=r.icon.placedSymbolArray,Yi=Ot.icon.isHidden()?1:0;Gt>=0&&(fe(r.icon,rt,mi?ma:vt),$i.get(Gt).hidden=Yi),ri>=0&&(fe(r.icon,Fe.numVerticalIconVertices,_i?ma:vt),$i.get(ri).hidden=Yi)}if(r.hasIconCollisionBoxData()||r.hasTextCollisionBoxData()){const vt=r.collisionArrays[Le];if(vt){let Gt=new s.P(0,0),ri=!0;if(vt.textBox||vt.verticalTextBox){if(ee){const Yi=this.variableOffsets[Ze];Yi?(Gt=fh(Yi.anchor,Yi.width,Yi.height,Yi.textOffset,Yi.textScale),ie&&Gt._rotate(ue?this.transform.angle:-this.transform.angle)):ri=!1}k&&(ri=!Ot.clipped),vt.textBox&&Ac(r.textCollisionBox.collisionVertexArray,Ot.text.placed,!ri||mi,Gt.x,Gt.y),vt.verticalTextBox&&Ac(r.textCollisionBox.collisionVertexArray,Ot.text.placed,!ri||_i,Gt.x,Gt.y)}const $i=ri&&!!(!_i&&vt.verticalIconBox);vt.iconBox&&Ac(r.iconCollisionBox.collisionVertexArray,Ot.icon.placed,$i,Fe.hasIconTextFit?Gt.x:0,Fe.hasIconTextFit?Gt.y:0),vt.verticalIconBox&&Ac(r.iconCollisionBox.collisionVertexArray,Ot.icon.placed,!$i,Fe.hasIconTextFit?Gt.x:0,Fe.hasIconTextFit?Gt.y:0)}}}if(r.fullyClipped=_e===0,r.sortFeatures(this.transform.angle),this.retainedQueryData[r.bucketInstanceId]&&(this.retainedQueryData[r.bucketInstanceId].featureSortOrder=r.featureSortOrder),r.hasTextData()&&r.text.opacityVertexBuffer&&r.text.opacityVertexBuffer.updateData(r.text.opacityVertexArray),r.hasIconData()&&r.icon.opacityVertexBuffer&&r.icon.opacityVertexBuffer.updateData(r.icon.opacityVertexArray),r.hasIconCollisionBoxData()&&r.iconCollisionBox.collisionVertexBuffer&&r.iconCollisionBox.collisionVertexBuffer.updateData(r.iconCollisionBox.collisionVertexArray),r.hasTextCollisionBoxData()&&r.textCollisionBox.collisionVertexBuffer&&r.textCollisionBox.collisionVertexBuffer.updateData(r.textCollisionBox.collisionVertexArray),r.bucketInstanceId in this.collisionCircleArrays){const Le=this.collisionCircleArrays[r.bucketInstanceId];r.placementInvProjMatrix=Le.invProjMatrix,r.placementViewportMatrix=Le.viewportMatrix,r.collisionCircleArray=Le.circles,delete this.collisionCircleArrays[r.bucketInstanceId]}}symbolFadeChange(r){return this.fadeDuration===0?1:(r-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(r){return Math.max(0,(this.transform.zoom-r)/1.5)}hasTransitions(r){return this.stale||r-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(r,h){const y=this.zoomAtLastRecencyCheck===h?1-this.zoomAdjustment(h):1;return this.zoomAtLastRecencyCheck=h,this.commitTime+this.fadeDuration*y>r}setStale(){this.stale=!0}}function Ac(m,r,h,y,b){m.emplaceBack(r?1:0,h?1:0,y||0,b||0),m.emplaceBack(r?1:0,h?1:0,y||0,b||0),m.emplaceBack(r?1:0,h?1:0,y||0,b||0),m.emplaceBack(r?1:0,h?1:0,y||0,b||0)}const Ga=Math.pow(2,25),Pp=Math.pow(2,24),ji=Math.pow(2,17),Rp=Math.pow(2,16),Dp=Math.pow(2,9),kd=Math.pow(2,8),zp=Math.pow(2,1);function $u(m){if(m.opacity===0&&!m.placed)return 0;if(m.opacity===1&&m.placed)return 4294967295;const r=m.placed?1:0,h=Math.floor(127*m.opacity);return h*Ga+r*Pp+h*ji+r*Rp+h*Dp+r*kd+h*zp+r}const ma=0;class Op{constructor(r){this._sortAcrossTiles=r.layout.get("symbol-z-order")!=="viewport-y"&&r.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(r,h,y,b,T){const E=this._bucketParts;for(;this._currentTileIndex<r.length;)if(h.getBucketParts(E,b,r[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,T())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,E.sort((I,k)=>I.sortKey-k.sortKey));this._currentPartIndex<E.length;){const I=E[this._currentPartIndex];if(h.placeLayerBucketPart(I,this._seenCrossTileIDs,y,I.symbolInstanceStart===0),this._currentPartIndex++,T())return!0}return!1}}class mh{constructor(r,h,y,b,T,E,I,k,N){this.placement=new im(r,T,E,I,k,N),this._currentPlacementIndex=h.length-1,this._forceFullPlacement=y,this._showCollisionBoxes=b,this._done=!1}isDone(){return this._done}continuePlacement(r,h,y,b){const T=s.e.now(),E=()=>{const I=s.e.now()-T;return!this._forceFullPlacement&&I>2};for(;this._currentPlacementIndex>=0;){const I=h[r[this._currentPlacementIndex]],k=this.placement.collisionIndex.transform.zoom;if(I.type==="symbol"&&(!I.minzoom||I.minzoom<=k)&&(!I.maxzoom||I.maxzoom>k)){const N=I,H=N.layout.get("symbol-z-elevate"),X=this._inProgressLayer=this._inProgressLayer||new Op(N),ee=s.al(I.source,I.scope);if(X.continuePlacement(H?b[ee]:y[ee],this.placement,this._showCollisionBoxes,I,E))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(r){return this.placement.commit(r),this.placement}}const gh=512/s.a3/2;class _h{constructor(r,h,y){this.tileID=r,this.bucketInstanceId=y,this.index=new s.cK(h.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const b=r.canonical.x*s.a3,T=r.canonical.y*s.a3;for(let E=0;E<h.length;E++){const{key:I,crossTileID:k,tileAnchorX:N,tileAnchorY:H}=h.get(E),X=Math.floor((b+N)*gh),ee=Math.floor((T+H)*gh);this.index.add(X,ee),this.keys.push(I),this.crossTileIDs.push(k)}this.index.finish()}findMatches(r,h,y){const b=this.tileID.canonical.z<h.canonical.z?1:Math.pow(2,this.tileID.canonical.z-h.canonical.z),T=gh/Math.pow(2,h.canonical.z-this.tileID.canonical.z),E=h.canonical.x*s.a3,I=h.canonical.y*s.a3;for(let k=0;k<r.length;k++){const N=r.get(k);if(N.crossTileID)continue;const{key:H,tileAnchorX:X,tileAnchorY:ee}=N,ie=Math.floor((E+X)*T),ue=Math.floor((I+ee)*T),pe=this.index.range(ie-b,ue-b,ie+b,ue+b);for(const fe of pe){const _e=this.crossTileIDs[fe];if(this.keys[fe]===H&&!y.has(_e)){y.add(_e),N.crossTileID=_e;break}}}}}class _g{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class yg{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(r){const h=Math.round((r-this.lng)/360);if(h!==0)for(const y in this.indexes){const b=this.indexes[y],T={};for(const E in b){const I=b[E];I.tileID=I.tileID.unwrapTo(I.tileID.wrap+h),T[I.tileID.key]=I}this.indexes[y]=T}this.lng=r}addBucket(r,h,y){if(this.indexes[r.overscaledZ]&&this.indexes[r.overscaledZ][r.key]){if(this.indexes[r.overscaledZ][r.key].bucketInstanceId===h.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(r.overscaledZ,this.indexes[r.overscaledZ][r.key])}for(let T=0;T<h.symbolInstances.length;T++)h.symbolInstances.get(T).crossTileID=0;this.usedCrossTileIDs[r.overscaledZ]||(this.usedCrossTileIDs[r.overscaledZ]=new Set);const b=this.usedCrossTileIDs[r.overscaledZ];for(const T in this.indexes){const E=this.indexes[T];if(Number(T)>r.overscaledZ)for(const I in E){const k=E[I];k.tileID.isChildOf(r)&&k.findMatches(h.symbolInstances,r,b)}else{const I=E[r.scaledTo(Number(T)).key];I&&I.findMatches(h.symbolInstances,r,b)}}for(let T=0;T<h.symbolInstances.length;T++){const E=h.symbolInstances.get(T);E.crossTileID||(E.crossTileID=y.generate(),b.add(E.crossTileID))}return this.indexes[r.overscaledZ]===void 0&&(this.indexes[r.overscaledZ]={}),this.indexes[r.overscaledZ][r.key]=new _h(r,h.symbolInstances,h.bucketInstanceId),!0}removeBucketCrossTileIDs(r,h){for(const y of h.crossTileIDs)this.usedCrossTileIDs[r].delete(y)}removeStaleBuckets(r){let h=!1;for(const y in this.indexes){const b=this.indexes[y];for(const T in b)r[b[T].bucketInstanceId]||(this.removeBucketCrossTileIDs(y,b[T]),delete b[T],h=!0)}return h}}class Fp{constructor(){this.layerIndexes={},this.crossTileIDs=new _g,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(r,h,y,b){let T=this.layerIndexes[r.fqid];T===void 0&&(T=this.layerIndexes[r.fqid]=new yg);let E=!1;const I={};b.name!=="globe"&&T.handleWrapJump(y);for(const k of h){const N=k.getBucket(r);N&&r.fqid===N.layerIds[0]&&(N.bucketInstanceId||(N.bucketInstanceId=++this.maxBucketInstanceId),T.addBucket(k.tileID,N,this.crossTileIDs)&&(E=!0),I[N.bucketInstanceId]=!0)}return T.removeStaleBuckets(I)&&(E=!0),E}pruneUnusedLayers(r){const h={};r.forEach(y=>{h[y]=!0});for(const y in this.layerIndexes)h[y]||delete this.layerIndexes[y]}}const xg=new s.N({data:new s.O(s.L.colorTheme.data)}),Cc=(m,r)=>jn(m,r&&r.filter(h=>h.identifier!=="source.canvas")),kp=s.ah(kr,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection","setCamera","addImport","removeImport","updateImport"]),Bp=s.ah(kr,["setCenter","setZoom","setBearing","setPitch"]),Yu={version:8,layers:[],sources:{}},Ju={duration:300,delay:0};class Ha extends s.E{constructor(r,h={}){super(),this.map=r,this.scope=h.scope||"",this.globalId=null,this.fragments=[],this.importDepth=h.importDepth||0,this.importsCache=h.importsCache||new Map,this.resolvedImports=h.resolvedImports||new Set,this.transition=s.W({},Ju),this._buildingIndex=new Wu(this),this.crossTileSymbolIndex=new Fp,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerIndices=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=h.styleChanges||new Ni,this.dispatcher=h.dispatcher?h.dispatcher:new s.bw(s.bx(),this),h.imageManager?this.imageManager=h.imageManager:(this.imageManager=new ho,this.imageManager.setEventedParent(this)),this.imageManager.createScope(this.scope),this.glyphManager=h.glyphManager?h.glyphManager:new s.cM(r._requestManager,h.localFontFamily?s.cN.all:h.localIdeographFontFamily?s.cN.ideographs:s.cN.none,h.localFontFamily||h.localIdeographFontFamily),h.modelManager?this.modelManager=h.modelManager:(this.modelManager=new ms(r._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._order=[],this._markersNeedUpdate=!1,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null},this._styleColorThemeForScope={},this.options=h.configOptions?h.configOptions:new Map,this._configDependentLayers=h.configDependentLayers?h.configDependentLayers:new Set,this._config=h.config,this._initialConfig=h.initialConfig,this.dispatcher.broadcast("setReferrer",s.cO());const y=this;this._rtlTextPluginCallback=Ha.registerForPluginStateChange(b=>{y.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:b.pluginStatus,pluginURL:b.pluginURL},(T,E)=>{if(s.cP(T),E&&E.every(I=>I))for(const I in y._sourceCaches){const k=y._sourceCaches[I],N=k.getSource().type;N!=="vector"&&N!=="geojson"||k.reload()}})}),this.on("data",b=>{if(b.dataType!=="source"||b.sourceDataType!=="metadata")return;const T=this.getOwnSource(b.sourceId);if(T&&T.vectorLayerIds)for(const E in this._layers){const I=this._layers[E];I.source===T.id&&this._validateLayer(I)}})}load(r){return r?(typeof r=="string"?this.loadURL(r):this.loadJSON(r),this):this}_getGlobalId(r){if(!r)return null;if(typeof r=="string"){if(s.cQ(r))return r;const h=s.cR(r);if(!h.startsWith("http"))try{return new URL(h,location.href).toString()}catch{return h}return h}return`json://${s.cS(JSON.stringify(r))}`}_diffStyle(r,h,y){this.globalId=this._getGlobalId(r);const b=(T,E)=>{try{E(null,this.setState(T,y))}catch(I){E(I,!1)}};if(typeof r=="string"){const T=this.map._requestManager.normalizeStyleURL(r),E=this.map._requestManager.transformRequest(T,s.R.Style);s.g(E,(I,k)=>{I?this.fire(new s.d(I)):k&&b(k,h)})}else typeof r=="object"&&b(r,h)}loadURL(r,h={}){this.fire(new s.f("dataloading",{dataType:"style"}));const y=typeof h.validate=="boolean"?h.validate:!s.cQ(r);this.globalId=this._getGlobalId(r),r=this.map._requestManager.normalizeStyleURL(r,h.accessToken),this.resolvedImports.add(r);const b=this.importsCache.get(r);if(b)return this._load(b,y);const T=this.map._requestManager.transformRequest(r,s.R.Style);this._request=s.g(T,(E,I)=>{if(this._request=null,E)this.fire(new s.d(E));else if(I)return this.importsCache.set(r,I),this._load(I,y)})}loadJSON(r,h={}){this.fire(new s.f("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(r),this._request=s.e.frame(()=>{this._request=null,this._load(r,h.validate!==!1)})}loadEmpty(){this.fire(new s.f("dataloading",{dataType:"style"})),this._load(Yu,!1)}_loadImports(r,h,y){if(this.importDepth>=4)return s.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const b=[];for(const T of r){const E=this._createFragmentStyle(T),I=new Promise(H=>{E.once("style.import.load",H),E.once("error",H)}).then(()=>this.mergeAll());if(b.push(I),this.resolvedImports.has(T.url)){E.loadEmpty();continue}const k=T.data||this.importsCache.get(T.url);k?(E.loadJSON(k,{validate:h}),this._isInternalStyle(k)&&(E.globalId=null)):T.url?E.loadURL(T.url,{validate:h}):E.loadEmpty();const N={style:E,id:T.id,config:T.config};if(y){const H=this.fragments.findIndex(({id:X})=>X===y);this.fragments=this.fragments.slice(0,H).concat(N).concat(this.fragments.slice(H))}else this.fragments.push(N)}return Promise.allSettled(b)}getImportGlobalIds(r=this,h=new Set){for(const y of r.fragments)y.style.globalId&&h.add(y.style.globalId),this.getImportGlobalIds(y.style,h);return[...h.values()]}_createFragmentStyle(r){const h=this.scope?s.al(r.id,this.scope):r.id;let y;const b=this._initialConfig&&this._initialConfig[h];(r.config||b)&&(y=s.W({},r.config,b));const T=new Ha(this.map,{scope:h,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:y,configOptions:this.options,configDependentLayers:this._configDependentLayers});return T.setEventedParent(this.map,{style:T}),T}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.isRootStyle()}_isInternalStyle(r){return this.isRootStyle()&&(r.fragment||!!r.schema&&r.fragment!==!1)}_load(r,h){const y=r.schema;if(this._isInternalStyle(r)){const E=s.W({},Yu,{imports:[{id:"basemap",data:r,url:""}]});return void this._load(E,h)}if(this.updateConfig(this._config,y),h&&Cc(this,Ke(r)))return;this._loaded=!0,this.stylesheet=s.cT(r);const b=()=>{for(const N in r.sources)this.addSource(N,r.sources[N],{validate:!1,isInitialLoad:!0});r.sprite?this._loadSprite(r.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.glyphManager.setURL(r.glyphs,this.scope);const E=Kf(this.stylesheet.layers);if(this._order=E.map(N=>N.id),this.stylesheet.light&&s.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){const N=this.stylesheet.lights[0];this.light=new bn(N.properties,N.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new bn(this.stylesheet.light)),this._layers={},this._serializedLayers={};for(const N of E){const H=s.cY(N,this.scope,this._styleColorTheme.lut,this.options);H.isConfigDependent&&this._configDependentLayers.add(H.fqid),H.setEventedParent(this,{layer:{id:H.id}}),this._layers[H.id]=H,this._serializedLayers[H.id]=H.serialize();const X=this.getOwnLayerSourceCache(H),ee=!!this.directionalLight&&this.directionalLight.shadowsEnabled();X&&H.canCastShadows()&&ee&&(X.castsShadows=!0)}this.stylesheet.models&&this.modelManager.addModels(this.stylesheet.models,this.scope);const I=this.stylesheet.terrain;I&&(this.checkCanvasFingerprintNoise(),this.terrainSetForDrapingOnly()||this._createTerrain(I,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new s.f("data",{dataType:"style"}));const k=this.isRootStyle();r.imports?this._loadImports(r.imports,h).then(()=>{this._reloadImports(),this.fire(new s.f(k?"style.load":"style.import.load"))}):(this._reloadImports(),this.fire(new s.f(k?"style.load":"style.import.load")))},T=this.stylesheet["color-theme"];if(this._styleColorTheme.colorTheme=T,T){const E=this._evaluateColorThemeData(T);this._loadColorTheme(E).then(()=>{b()}).catch(I=>{s.w(`Couldn't load color theme from the stylesheet: ${I}`),b()})}else this._styleColorTheme.lut=null,b()}isRootStyle(){return this.importDepth===0}mergeAll(){let r,h,y,b,T,E,I,k;const N={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(H=>{if(H.stylesheet){if(H.light!=null&&(r=H.light),H.stylesheet.lights)for(const X of H.stylesheet.lights)X.type==="ambient"&&H.ambientLight!=null&&(h=H.ambientLight),X.type==="directional"&&H.directionalLight!=null&&(y=H.directionalLight);b=this._prioritizeTerrain(b,H.terrain,H.stylesheet.terrain),H.stylesheet.fog&&H.fog!=null&&(T=H.fog),H.stylesheet.camera!=null&&(k=H.stylesheet.camera),H.stylesheet.projection!=null&&(E=H.stylesheet.projection),H.stylesheet.transition!=null&&(I=H.stylesheet.transition),N[H.scope]=H._styleColorTheme}}),this.light=r,this.ambientLight=h,this.directionalLight=y,this.fog=T,this._styleColorThemeForScope=N,b===null?delete this.terrain:this.terrain=b,this.camera=k||{"camera-projection":"perspective"},this.projection=E||{name:"mercator"},this.transition=s.W({},Ju,I),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(r){const h=y=>{for(const b of y.fragments)h(b.style);r(y)};h(this)}_prioritizeTerrain(r,h,y){const b=r&&r.drapeRenderMode===0;return y===null?h&&h.drapeRenderMode===0?h:b?r:null:h!=null&&(!r||b||h&&h.drapeRenderMode===1)?h:r}mergeTerrain(){let r;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(h=>{r=this._prioritizeTerrain(r,h.terrain,h.stylesheet.terrain)}),r===null?delete this.terrain:this.terrain=r}mergeProjection(){let r;this.forEachFragmentStyle(h=>{h.stylesheet.projection!=null&&(r=h.stylesheet.projection)}),this.projection=r||{name:"mercator"}}mergeSources(){const r={},h={},y={};this.forEachFragmentStyle(b=>{for(const T in b._sourceCaches){const E=s.al(T,b.scope);r[E]=b._sourceCaches[T]}for(const T in b._otherSourceCaches){const E=s.al(T,b.scope);h[E]=b._otherSourceCaches[T]}for(const T in b._symbolSourceCaches){const E=s.al(T,b.scope);y[E]=b._symbolSourceCaches[T]}}),this._mergedSourceCaches=r,this._mergedOtherSourceCaches=h,this._mergedSymbolSourceCaches=y}mergeLayers(){const r={},h=[],y={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(E=>{for(const I of E._order){const k=E._layers[I];if(k.type==="slot"){const N=s.cU(I);if(r[N])continue;r[N]=[]}k.slot&&r[k.slot]?r[k.slot].push(k):h.push(k)}}),this._mergedOrder=[],this._clipLayerIndices=[];let b=0;const T=(E=[])=>{for(const I of E)if(I.type==="slot"){const k=s.cU(I.id);r[k]&&T(r[k]),this._mergedSlots.push(k)}else{const k=s.al(I.id,I.scope);this._mergedOrder.push(k),y[k]=I,I.is3D()&&(this._has3DLayers=!0),I.type==="circle"&&(this._hasCircleLayers=!0),I.type==="symbol"&&(this._hasSymbolLayers=!0),I.type==="clip"&&this._clipLayerIndices.push(b),b++}};T(h),this._mergedLayers=y,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(r){return this.stylesheet.camera=s.W({},this.stylesheet.camera,r),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(r){return r.data?function(h,y,b){const T=s.W({},y);for(const I of Object.keys(s.L.colorTheme))T[I]===void 0&&(T[I]=s.L.colorTheme[I].default);const E=new s.U(xg,h,new Map(b));return E.setTransitionOrValue(T,b),E.untransitioned().possiblyEvaluate(new s.X(0))}(this.scope,r,this.options).get("data"):null}_loadColorTheme(r){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const h=this._styleColorTheme.lutLoadingCorrelationID;return new Promise((y,b)=>{const T="data:image/png;base64,";if(!r||r.length===0)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void y();let E=r;E.startsWith(T)||(E=T+E);const I="mapbox-reserved-lut",k=new Image;k.src=E,k.onerror=()=>{this._styleColorTheme.lutLoading=!1,b(new Error("Failed to load image data"))},k.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==h)return void y();this._styleColorTheme.lutLoading=!1;const{width:N,height:H,data:X}=s.e.getImageData(k);if(H>32)return void b(new Error("The height of the image must be less than or equal to 32 pixels."));if(N!==H*H)return void b(new Error("The width of the image must be equal to the height squared."));this.getImage(I)&&this.removeImage(I),this.addImage(I,{data:new s.i({width:N,height:H},X),pixelRatio:1,sdf:!1,version:0});const ee=this.imageManager.getImage(I,this.scope);ee?(this._styleColorTheme.lut={image:ee.data,data:r},y()):b(new Error("Missing LUT image."))}})}getLut(r){const h=this._styleColorThemeForScope[r];return h?h.lut:null}setProjection(r){r?this.stylesheet.projection=r:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(r){this._spriteRequest=function(h,y,b){let T,E,I;const k=s.e.devicePixelRatio>1?"@2x":"";let N=s.g(y.transformRequest(y.normalizeSpriteURL(h,k,".json"),s.R.SpriteJSON),(ee,ie)=>{N=null,I||(I=ee,T=ie,X())}),H=s.h(y.transformRequest(y.normalizeSpriteURL(h,k,".png"),s.R.SpriteImage),(ee,ie)=>{H=null,I||(I=ee,E=ie,X())});function X(){if(I)b(I);else if(T&&E){const ee=s.e.getImageData(E),ie={};for(const ue in T){const{width:pe,height:fe,x:_e,y:Le,sdf:Fe,pixelRatio:Be,stretchX:$e,stretchY:Ze,content:rt}=T[ue],xe=new s.i({width:pe,height:fe});s.i.copy(ee,xe,{x:_e,y:Le},{x:0,y:0},{width:pe,height:fe},null),ie[ue]={data:xe,pixelRatio:Be,sdf:Fe,stretchX:$e,stretchY:Ze,content:rt}}b(null,ie)}}return{cancel(){N&&(N.cancel(),N=null),H&&(H.cancel(),H=null)}}}(r,this.map._requestManager,(h,y)=>{if(this._spriteRequest=null,h)this.fire(new s.d(h));else if(y)for(const b in y)this.imageManager.addImage(b,this.scope,y[b]);this.imageManager.setLoaded(!0,this.scope),this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new s.f("data",{dataType:"style"}))})}_validateLayer(r){const h=this.getOwnSource(r.source);if(!h)return;const y=r.sourceLayer;y&&(h.type==="geojson"||h.vectorLayerIds&&h.vectorLayerIds.indexOf(y)===-1)&&this.fire(new s.d(new Error(`Source layer "${y}" does not exist on source "${h.id}" as specified by style layer "${r.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const r in this._sourceCaches)if(!this._sourceCaches[r].loaded())return!1;if(!this.imageManager.isLoaded()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(const{style:r}of this.fragments)if(!r.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((r,h)=>{const y=this.fragments[h];return y&&y.style&&(r.data=y.style.serialize()),r})}_serializeSources(){const r={};for(const h in this._sourceCaches){const y=this._sourceCaches[h].getSource();r[y.id]||(r[y.id]=y.serialize())}return r}_serializeLayers(r){const h=[];for(const y of r){const b=this._layers[y];b&&b.type!=="custom"&&h.push(b.serialize())}return h}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition())return!0;for(const r in this._sourceCaches)if(this._sourceCaches[r].hasTransition())return!0;for(const r in this._layers)if(this._layers[r].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}isLayerDraped(r){return!!this.terrain&&r.isDraped(this.getLayerSourceCache(r))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(r){const h=this.getOwnLayer(r);if(h)return h;this.fire(new s.d(new Error(`The layer '${r}' does not exist in the map's style.`)))}_checkSource(r){const h=this.getOwnSource(r);if(h)return h;this.fire(new s.d(new Error(`The source '${r}' does not exist in the map's style.`)))}update(r){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(r),this.directionalLight&&this.directionalLight.recalculate(r);const h=this.calculateLightsBrightness();r.brightness=h||0,h!==this._brightness&&(this._brightness=h,this.dispatcher.broadcast("setBrightness",h));const y=this._changes.isDirty();let b=!1;if(this._changes.isDirty()){const E=this._changes.getLayerUpdatesByScope();for(const I in E){const{updatedIds:k,removedIds:N}=E[I];(k||N)&&(this._updateWorkerLayers(I,k,N),b=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(r),this.light&&this.light.updateTransitions(r),this.ambientLight&&this.ambientLight.updateTransitions(r),this.directionalLight&&this.directionalLight.updateTransitions(r),this.fog&&this.fog.updateTransitions(r),this._changes.reset()}const T={};for(const E in this._mergedSourceCaches){const I=this._mergedSourceCaches[E];T[E]=I.used,I.used=!1,I.tileCoverLift=0}for(const E of this._mergedOrder){const I=this._mergedLayers[E];if(I.recalculate(r,this._availableImages),!I.isHidden(r.zoom)){const k=this.getLayerSourceCache(I);k&&(k.used=!0,k.tileCoverLift=Math.max(k.tileCoverLift,I.tileCoverLift()))}if(!this._precompileDone&&this._shouldPrecompile)for(let k=I.minzoom||0;k<(I.maxzoom||25.5);k++){const N=this.map.painter;if(N){const H=I.getProgramIds();if(!H)continue;for(const X of H){const ee=I.getDefaultProgramParams(X,r.zoom,this._styleColorTheme.lut);ee&&(N.style=this,this.fog&&(N._fogVisible=!0,ee.overrideFog=!0,N.getOrCreateProgram(X,ee)),N._fogVisible=!1,ee.overrideFog=!1,N.getOrCreateProgram(X,ee),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(ee.overrideRtt=!0,N.getOrCreateProgram(X,ee)))}}}}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&b&&this.mergeLayers();for(const E in T){const I=this._mergedSourceCaches[E];T[E]!==I.used&&I.getSource().fire(new s.f("data",{sourceDataType:"visibility",dataType:"source",sourceId:I.getSource().id}))}this.light&&this.light.recalculate(r),this.terrain&&this.terrain.recalculate(r),this.fog&&this.fog.recalculate(r),this.z=r.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),y&&this.fire(new s.f("data",{dataType:"style"}))}_updateTilesForChangedImages(){const r=this._changes.getUpdatedImages();if(r.length){for(const h in this._sourceCaches)this._sourceCaches[h].reloadTilesForDependencies(["icons","patterns"],r);this._changes.resetUpdatedImages()}}_updateWorkerLayers(r,h,y){const b=this.getFragmentStyle(r);b&&this.dispatcher.broadcast("updateLayers",{layers:h?b._serializeLayers(h):[],scope:r,removedIds:y||[],options:b.options})}setState(r,h){if(this._checkLoaded(),Cc(this,Ke(r)))return!1;(r=s.cT(r)).layers=Kf(r.layers);const y=function(E,I){if(!E)return[{command:kr.setStyle,args:[I]}];let k=[];try{if(!Z(E.version,I.version))return[{command:kr.setStyle,args:[I]}];if(Z(E.center,I.center)||k.push({command:kr.setCenter,args:[I.center]}),Z(E.zoom,I.zoom)||k.push({command:kr.setZoom,args:[I.zoom]}),Z(E.bearing,I.bearing)||k.push({command:kr.setBearing,args:[I.bearing]}),Z(E.pitch,I.pitch)||k.push({command:kr.setPitch,args:[I.pitch]}),Z(E.sprite,I.sprite)||k.push({command:kr.setSprite,args:[I.sprite]}),Z(E.glyphs,I.glyphs)||k.push({command:kr.setGlyphs,args:[I.glyphs]}),Z(E.imports,I.imports)||function(ie=[],ue=[],pe){ue=ue||[];const fe=(ie=ie||[]).map(Yh),_e=ue.map(Yh),Le=ie.reduce(Jh,{}),Fe=ue.reduce(Jh,{}),Be=fe.slice();let $e,Ze,rt,xe;for($e=0,Ze=0;$e<fe.length;$e++)rt=fe[$e],Fe.hasOwnProperty(rt)?Ze++:(pe.push({command:kr.removeImport,args:[rt]}),Be.splice(Be.indexOf(rt,Ze),1));for($e=0,Ze=0;$e<_e.length;$e++)rt=_e[_e.length-1-$e],Be[Be.length-1-$e]!==rt&&(Le.hasOwnProperty(rt)?(pe.push({command:kr.removeImport,args:[rt]}),Be.splice(Be.lastIndexOf(rt,Be.length-Ze),1)):Ze++,xe=Be[Be.length-$e],pe.push({command:kr.addImport,args:[Fe[rt],xe]}),Be.splice(Be.length-$e,0,rt));for(const Ne of ue){const ct=Le[Ne.id];ct&&!Z(ct,Ne)&&pe.push({command:kr.updateImport,args:[Ne.id,Ne]})}}(E.imports,I.imports,k),Z(E.transition,I.transition)||k.push({command:kr.setTransition,args:[I.transition]}),Z(E.light,I.light)||k.push({command:kr.setLight,args:[I.light]}),Z(E.fog,I.fog)||k.push({command:kr.setFog,args:[I.fog]}),Z(E.projection,I.projection)||k.push({command:kr.setProjection,args:[I.projection]}),Z(E.lights,I.lights)||k.push({command:kr.setLights,args:[I.lights]}),Z(E.camera,I.camera)||k.push({command:kr.setCamera,args:[I.camera]}),!Z(E["color-theme"],I["color-theme"]))return[{command:kr.setStyle,args:[I]}];const N={},H=[];(function(ie,ue,pe,fe){let _e;for(_e in ue=ue||{},ie=ie||{})ie.hasOwnProperty(_e)&&(ue.hasOwnProperty(_e)||Zu(_e,pe,fe));for(_e in ue){if(!ue.hasOwnProperty(_e))continue;const Le=ue[_e];ie.hasOwnProperty(_e)?Z(ie[_e],Le)||(ie[_e].type==="geojson"&&Le.type==="geojson"&&Qf(ie,ue,_e)?pe.push({command:kr.setGeoJSONSourceData,args:[_e,Le.data]}):Sc(_e,ue,pe,fe)):Ip(_e,ue,pe)}})(E.sources,I.sources,H,N);const X=[];E.layers&&E.layers.forEach(ie=>{ie.source&&N[ie.source]?k.push({command:kr.removeLayer,args:[ie.id]}):X.push(ie)});let ee=E.terrain;ee&&N[ee.source]&&(k.push({command:kr.setTerrain,args:[void 0]}),ee=void 0),k=k.concat(H),Z(ee,I.terrain)||k.push({command:kr.setTerrain,args:[I.terrain]}),function(ie,ue,pe){ue=ue||[];const fe=(ie=ie||[]).map(Yh),_e=ue.map(Yh),Le=ie.reduce(Jh,{}),Fe=ue.reduce(Jh,{}),Be=fe.slice(),$e=Object.create(null);let Ze,rt,xe,Ne,ct,Ot,mt;for(Ze=0,rt=0;Ze<fe.length;Ze++)xe=fe[Ze],Fe.hasOwnProperty(xe)?rt++:(pe.push({command:kr.removeLayer,args:[xe]}),Be.splice(Be.indexOf(xe,rt),1));for(Ze=0,rt=0;Ze<_e.length;Ze++)xe=_e[_e.length-1-Ze],Be[Be.length-1-Ze]!==xe&&(Le.hasOwnProperty(xe)?(pe.push({command:kr.removeLayer,args:[xe]}),Be.splice(Be.lastIndexOf(xe,Be.length-rt),1)):rt++,Ot=Be[Be.length-Ze],pe.push({command:kr.addLayer,args:[Fe[xe],Ot]}),Be.splice(Be.length-Ze,0,xe),$e[xe]=!0);for(Ze=0;Ze<_e.length;Ze++)if(xe=_e[Ze],Ne=Le[xe],ct=Fe[xe],!$e[xe]&&!Z(Ne,ct))if(Z(Ne.source,ct.source)&&Z(Ne["source-layer"],ct["source-layer"])&&Z(Ne.type,ct.type)){for(mt in Xu(Ne.layout,ct.layout,pe,xe,null,kr.setLayoutProperty),Xu(Ne.paint,ct.paint,pe,xe,null,kr.setPaintProperty),Z(Ne.slot,ct.slot)||pe.push({command:kr.setSlot,args:[xe,ct.slot]}),Z(Ne.filter,ct.filter)||pe.push({command:kr.setFilter,args:[xe,ct.filter]}),Z(Ne.minzoom,ct.minzoom)&&Z(Ne.maxzoom,ct.maxzoom)||pe.push({command:kr.setLayerZoomRange,args:[xe,ct.minzoom,ct.maxzoom]}),Ne)Ne.hasOwnProperty(mt)&&mt!=="layout"&&mt!=="paint"&&mt!=="filter"&&mt!=="metadata"&&mt!=="minzoom"&&mt!=="maxzoom"&&mt!=="slot"&&(mt.indexOf("paint.")===0?Xu(Ne[mt],ct[mt],pe,xe,mt.slice(6),kr.setPaintProperty):Z(Ne[mt],ct[mt])||pe.push({command:kr.setLayerProperty,args:[xe,mt,ct[mt]]}));for(mt in ct)ct.hasOwnProperty(mt)&&!Ne.hasOwnProperty(mt)&&mt!=="layout"&&mt!=="paint"&&mt!=="filter"&&mt!=="metadata"&&mt!=="minzoom"&&mt!=="maxzoom"&&mt!=="slot"&&(mt.indexOf("paint.")===0?Xu(Ne[mt],ct[mt],pe,xe,mt.slice(6),kr.setPaintProperty):Z(Ne[mt],ct[mt])||pe.push({command:kr.setLayerProperty,args:[xe,mt,ct[mt]]}))}else pe.push({command:kr.removeLayer,args:[xe]}),Ot=Be[Be.lastIndexOf(xe)+1],pe.push({command:kr.addLayer,args:[ct,Ot]})}(X,I.layers,k)}catch(N){console.warn("Unable to compute style diff:",N),k=[{command:kr.setStyle,args:[I]}]}return k}(this.serialize(),r).filter(E=>!(E.command in Bp));if(y.length===0)return!1;const b=y.filter(E=>!(E.command in kp));if(b.length>0)throw new Error(`Unimplemented: ${b.map(E=>E.command).join(", ")}.`);const T=[];return y.forEach(E=>{T.push(this[E.command].apply(this,E.args))}),h&&Promise.all(T).then(h),this.stylesheet=r,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}addImage(r,h){return this.getImage(r)?this.fire(new s.d(new Error("An image with this name already exists."))):(this.imageManager.addImage(r,this.scope,h),this._afterImageUpdated(r),this)}updateImage(r,h){this.imageManager.updateImage(r,this.scope,h)}getImage(r){return this.imageManager.getImage(r,this.scope)}removeImage(r){return this.getImage(r)?(this.imageManager.removeImage(r,this.scope),this._afterImageUpdated(r),this):this.fire(new s.d(new Error("No image with this name exists.")))}_afterImageUpdated(r){this._availableImages=this.imageManager.listImages(this.scope),this._changes.updateImage(r),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.fire(new s.f("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModel(r,h,y={}){return this._checkLoaded(),this._validate(Vn,`models.${r}`,h,null,y)||(this.modelManager.addModel(r,h,this.scope),this._changes.setDirty()),this}hasModel(r){return this.modelManager.hasModel(r,this.scope)}removeModel(r){return this.hasModel(r)?(this.modelManager.removeModel(r,this.scope),this):this.fire(new s.d(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(r,h,y={}){if(this._checkLoaded(),this.getOwnSource(r)!==void 0)throw new Error(`There is already a source with ID "${r}".`);if(!h.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(h).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(h.type)>=0&&this._validate(tt,`sources.${r}`,h,null,y))return;this.map&&this.map._collectResourceTiming&&(h.collectResourceTiming=!0);const b=mo(r,h,this.dispatcher,this);b.scope=this.scope,b.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(b.id),source:b.serialize(),sourceId:b.id}));const T=E=>{const I=(E?"symbol:":"other:")+b.id,k=s.al(I,this.scope),N=this._sourceCaches[I]=new s.bv(k,b,E);(E?this._symbolSourceCaches:this._otherSourceCaches)[b.id]=N,N.onAdd(this.map)};T(!1),h.type!=="vector"&&h.type!=="geojson"||T(!0),b.onAdd&&b.onAdd(this.map),y.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(r){this._checkLoaded();const h=this.getOwnSource(r);if(!h)throw new Error("There is no source with this ID");for(const b in this._layers)if(this._layers[b].source===r)return this.fire(new s.d(new Error(`Source "${r}" cannot be removed while layer "${b}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===r)return this.fire(new s.d(new Error(`Source "${r}" cannot be removed while terrain is using it.`)));const y=this.getOwnSourceCaches(r);for(const b of y){const T=s.cU(b.id);delete this._sourceCaches[T],this._changes.discardSourceCacheUpdate(b.id),b.fire(new s.f("data",{sourceDataType:"metadata",dataType:"source",sourceId:b.getSource().id})),b.setEventedParent(null),b.clearTiles()}return delete this._otherSourceCaches[r],delete this._symbolSourceCaches[r],this.mergeSources(),h.setEventedParent(null),h.onRemove&&h.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(r,h){this._checkLoaded(),this.getOwnSource(r).setData(h),this._changes.setDirty()}getOwnSource(r){const h=this.getOwnSourceCache(r);return h&&h.getSource()}getOwnSources(){const r=[];for(const h in this._otherSourceCaches){const y=this.getOwnSourceCache(h);y&&r.push(y.getSource())}return r}areTilesLoaded(){const r=this._mergedSourceCaches;for(const h in r){const y=r[h]._tiles;for(const b in y){const T=y[b];if(T.state!=="loaded"&&T.state!=="errored")return!1}}return!0}setLights(r){if(this._checkLoaded(),!r)return delete this.ambientLight,void delete this.directionalLight;const h=this._getTransitionParameters();for(const b of r){if(this._validate(Ft,"lights",b))return;switch(b.type){case"ambient":if(this.ambientLight){const T=this.ambientLight;T.set(b),T.updateTransitions(h)}else this.ambientLight=new Ml(b,ur,this.scope,this.options);break;case"directional":if(this.directionalLight){const T=this.directionalLight;T.set(b),T.updateTransitions(h)}else this.directionalLight=new Ml(b,ba,this.scope,this.options)}}const y=new s.X(this.z||0,h);this.ambientLight&&this.ambientLight.recalculate(y),this.directionalLight&&this.directionalLight.recalculate(y),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const r=this.directionalLight,h=this.ambientLight;if(!r||!h)return;const y=X=>.2126*(X[0]<=.03928?X[0]/12.92:Math.pow((X[0]+.055)/1.055,2.4))+.7152*(X[1]<=.03928?X[1]/12.92:Math.pow((X[1]+.055)/1.055,2.4))+.0722*(X[2]<=.03928?X[2]/12.92:Math.pow((X[2]+.055)/1.055,2.4)),b=r.properties.get("color").toRenderColor(null).toArray01(),T=r.properties.get("intensity"),E=r.properties.get("direction"),I=1-s.ac(E.x,E.y,E.z)[2]/90,k=y(b)*T*I,N=h.properties.get("color").toRenderColor(null).toArray01(),H=h.properties.get("intensity");return(k+y(N)*H)/2}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const r=[];return this.directionalLight&&r.push(this.directionalLight.get()),this.ambientLight&&r.push(this.ambientLight.get()),r}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(r){if(!r)return this;if(s.cV(r)){const h=s.cW(r),y=this.fragments.find(({id:T})=>T===h);if(!y)throw new Error(`Style import not found: ${r}`);const b=s.cU(r);return y.style.getFragmentStyle(b)}{const h=this.fragments.find(({id:y})=>y===r);if(!h)throw new Error(`Style import not found: ${r}`);return h.style}}getConfigProperty(r,h){const y=this.getFragmentStyle(r);if(!y)return null;const b=s.al(h,y.scope),T=y.options.get(b),E=T?T.value||T.default:null;return E?E.serialize():null}setConfigProperty(r,h,y){const b=this.getFragmentStyle(r);if(!b)return;const T=b.stylesheet.schema;if(!T||!T[h])return;const E=s.y(y);if(E.result!=="success")return void Cc(this,E.value);const I=E.value.expression,k=s.al(h,b.scope),N=b.options.get(k);if(!N)return;let H;const{minValue:X,maxValue:ee,stepValue:ie,type:ue,values:pe}=T[h],fe=s.y(T[h].default);fe.result==="success"&&(H=fe.value.expression),H?(this.options.set(k,{...N,value:I,default:H,minValue:X,maxValue:ee,stepValue:ie,type:ue,values:pe}),this.updateConfigDependencies()):this.fire(new s.d(new Error(`No schema defined for the config option "${h}" in the "${r}" fragment.`)))}getConfig(r){const h=this.getFragmentStyle(r);if(!h)return null;const y=h.stylesheet.schema;if(!y)return null;const b={};for(const T in y){const E=s.al(T,h.scope),I=h.options.get(E),k=I?I.value||I.default:null;b[T]=k?k.serialize():null}return b}setConfig(r,h){const y=this.getFragmentStyle(r);y&&(y.updateConfig(h,y.stylesheet.schema),this.updateConfigDependencies())}getSchema(r){const h=this.getFragmentStyle(r);return h?h.stylesheet.schema:null}setSchema(r,h){const y=this.getFragmentStyle(r);y&&(y.stylesheet.schema=h,y.updateConfig(y._config,h),this.updateConfigDependencies())}updateConfig(r,h){if(this._config=r,r||h)if(h)for(const y in h){let b,T;const E=s.y(h[y].default);if(E.result==="success"&&(b=E.value.expression),r&&r[y]!==void 0){const ee=s.y(r[y]);ee.result==="success"&&(T=ee.value.expression)}const{minValue:I,maxValue:k,stepValue:N,type:H,values:X}=h[y];if(b){const ee=s.al(y,this.scope);this.options.set(ee,{default:b,value:T,minValue:I,maxValue:k,stepValue:N,type:H,values:X})}else this.fire(new s.d(new Error(`No schema defined for config option "${y}".`)))}else this.fire(new s.d(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(){for(const r of this._configDependentLayers){const h=this.getLayer(r);h&&(h.possiblyEvaluateVisibility(),this._updateLayer(h))}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.forEachFragmentStyle(r=>{if(r._styleColorTheme.colorTheme){const h=r._evaluateColorThemeData(r._styleColorTheme.colorTheme);(!r._styleColorTheme.lut||r._styleColorTheme.lut&&h!==r._styleColorTheme.lut.data)&&r.setColorTheme(r._styleColorTheme.colorTheme)}}),this._changes.setDirty()}addLayer(r,h,y={}){this._checkLoaded();const b=r.id;if(this._layers[b])return void this.fire(new s.d(new Error(`Layer with id "${b}" already exists on this map`)));let T;if(r.type==="custom"){if(Cc(this,s.cX(r)))return;T=s.cY(r,this.scope,this._styleColorTheme.lut,this.options)}else{if(typeof r.source=="object"&&(this.addSource(b,r.source),r=s.cT(r),r=s.W(r,{source:b})),this._validate(Oi,`layers.${b}`,r,{arrayIndex:-1},y))return;T=s.cY(r,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(T),T.setEventedParent(this,{layer:{id:b}}),this._serializedLayers[T.id]=T.serialize()}T.isConfigDependent&&this._configDependentLayers.add(T.fqid);let E=this._order.length;if(h){const H=this._order.indexOf(h);if(H===-1)return void this.fire(new s.d(new Error(`Layer with id "${h}" does not exist on this map.`)));T.slot===this._layers[h].slot?E=H:s.w(`Layer with id "${h}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(E,0,b),this._layerOrderChanged=!0,this._layers[b]=T;const I=this.getOwnLayerSourceCache(T),k=!!this.directionalLight&&this.directionalLight.shadowsEnabled();I&&T.canCastShadows()&&k&&(I.castsShadows=!0);const N=this._changes.getRemovedLayer(T);if(N&&T.source&&I&&T.type!=="custom"){this._changes.discardLayerRemoval(T);const H=s.al(T.source,T.scope);N.type!==T.type?this._changes.updateSourceCache(H,"clear"):(this._changes.updateSourceCache(H,"reload"),I.pause())}this._updateLayer(T),T.onAdd&&T.onAdd(this.map),T.scope=this.scope,this.mergeLayers()}moveLayer(r,h){this._checkLoaded();const y=this._checkLayer(r);if(!y||r===h)return;const b=this._order.indexOf(r);this._order.splice(b,1);let T=this._order.length;if(h){const E=this._order.indexOf(h);if(E===-1)return void this.fire(new s.d(new Error(`Layer with id "${h}" does not exist on this map.`)));y.slot===this._layers[h].slot?T=E:s.w(`Layer with id "${h}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(T,0,r),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(r){this._checkLoaded();const h=this._checkLayer(r);if(!h)return;h.setEventedParent(null);const y=this._order.indexOf(r);this._order.splice(y,1),delete this._layers[r],delete this._serializedLayers[r],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(h.fqid),this._changes.removeLayer(h);const b=this.getOwnLayerSourceCache(h);if(b&&b.castsShadows){let T=!1;for(const E in this._layers)if(this._layers[E].source===h.source&&this._layers[E].canCastShadows()){T=!0;break}b.castsShadows=T}h.onRemove&&h.onRemove(this.map),this.mergeLayers()}getOwnLayer(r){return this._layers[r]}hasLayer(r){return r in this._mergedLayers}hasLayerType(r){for(const h in this._layers)if(this._layers[h].type===r)return!0;return!1}setLayerZoomRange(r,h,y){this._checkLoaded();const b=this._checkLayer(r);b&&(b.minzoom===h&&b.maxzoom===y||(h!=null&&(b.minzoom=h),y!=null&&(b.maxzoom=y),this._updateLayer(b)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(r,h){this._checkLoaded();const y=this._checkLayer(r);y&&y.slot!==h&&(y.slot=h,this._updateLayer(y))}setFilter(r,h,y={}){this._checkLoaded();const b=this._checkLayer(r);if(b&&!Z(b.filter,h))return h==null?(b.filter=void 0,void this._updateLayer(b)):void(this._validate(Mi,`layers.${b.id}.filter`,h,{layerType:b.type},y)||(b.filter=s.cT(h),this._updateLayer(b)))}getFilter(r){const h=this._checkLayer(r);if(h)return s.cT(h.filter)}setLayoutProperty(r,h,y,b={}){this._checkLoaded();const T=this._checkLayer(r);if(T&&!Z(T.getLayoutProperty(h),y)){if(y!=null&&(!b||b.validate!==!1)&&Cc(T,Bn.call(Ke,{key:`layers.${r}.layout.${h}`,layerType:T.type,objectKey:h,value:y,styleSpec:s.L,style:{glyphs:!0,sprite:!0}})))return;T.setLayoutProperty(h,y),T.isConfigDependent&&this._configDependentLayers.add(T.fqid),this._updateLayer(T)}}getLayoutProperty(r,h){const y=this._checkLayer(r);if(y)return y.getLayoutProperty(h)}setPaintProperty(r,h,y,b={}){this._checkLoaded();const T=this._checkLayer(r);if(!T||Z(T.getPaintProperty(h),y)||y!=null&&(!b||b.validate!==!1)&&Cc(T,wn.call(Ke,{key:`layers.${r}.paint.${h}`,layerType:T.type,objectKey:h,value:y,styleSpec:s.L})))return;const E=T.setPaintProperty(h,y);T.isConfigDependent&&this._configDependentLayers.add(T.fqid),E&&this._updateLayer(T),this._changes.updatePaintProperties(T)}getPaintProperty(r,h){const y=this._checkLayer(r);if(y)return y.getPaintProperty(h)}setFeatureState(r,h){this._checkLoaded();const y=r.source,b=r.sourceLayer,T=this._checkSource(y);if(!T)return;const E=T.type;if(E==="geojson"&&b)return void this.fire(new s.d(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(E==="vector"&&!b)return void this.fire(new s.d(new Error("The sourceLayer parameter must be provided for vector source types.")));r.id===void 0&&this.fire(new s.d(new Error("The feature id parameter must be provided.")));const I=this.getOwnSourceCaches(y);for(const k of I)k.setFeatureState(b,r.id,h)}removeFeatureState(r,h){this._checkLoaded();const y=r.source,b=this._checkSource(y);if(!b)return;const T=b.type,E=T==="vector"?r.sourceLayer:void 0;if(T==="vector"&&!E)return void this.fire(new s.d(new Error("The sourceLayer parameter must be provided for vector source types.")));if(h&&typeof r.id!="string"&&typeof r.id!="number")return void this.fire(new s.d(new Error("A feature id is required to remove its specific state property.")));const I=this.getOwnSourceCaches(y);for(const k of I)k.removeFeatureState(E,r.id,h)}getFeatureState(r){this._checkLoaded();const h=r.source,y=r.sourceLayer,b=this._checkSource(h);if(b){if(b.type!=="vector"||y)return r.id===void 0&&this.fire(new s.d(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(h)[0].getFeatureState(y,r.id);this.fire(new s.d(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(r){return this.stylesheet.transition=s.W({},this.stylesheet.transition,r),this.transition=this.stylesheet.transition,this}getTransition(){return s.W({},this.stylesheet.transition)}serialize(){this._checkLoaded();const r=this.getTerrain(),h=r&&this.terrain&&this.terrain.scope===this.scope?r:this.stylesheet.terrain;return s.cZ({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:h,fog:this.stylesheet.fog,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},y=>y!==void 0)}_updateLayer(r){this._changes.updateLayer(r);const h=this.getLayerSourceCache(r),y=s.al(r.source,r.scope),b=this._changes.getUpdatedSourceCaches();r.source&&!b[y]&&h&&h.getSource().type!=="raster"&&(this._changes.updateSourceCache(y,"reload"),h.pause()),r.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(r){const h=I=>this._mergedLayers[I].type==="fill-extrusion"||this._mergedLayers[I].type==="model",y=this.order,b={},T=[];for(let I=y.length-1;I>=0;I--){const k=y[I];if(h(k)){b[k]=I;for(const N of r){const H=N[k];if(H)for(const X of H)T.push(X)}}}T.sort((I,k)=>k.intersectionZ-I.intersectionZ);const E=[];for(let I=y.length-1;I>=0;I--){const k=y[I];if(h(k))for(let N=T.length-1;N>=0;N--){const H=T[N].feature;if(H.layer&&b[H.layer.id]<I)break;E.push(H),T.pop()}else for(const N of r){const H=N[k];if(H)for(const X of H)E.push(X.feature)}}return E}queryRenderedFeatures(r,h,y){h&&h.filter&&this._validate(Mi,"queryRenderedFeatures.filter",h.filter,null,h),h.scope=this.scope,h.availableImages=this._availableImages,h.serializedLayers=this._serializedLayers;const b={};if(h&&h.layers){if(!Array.isArray(h.layers))return this.fire(new s.d(new Error("parameters.layers must be an Array."))),[];for(const N of h.layers){const H=this._mergedLayers[N];if(!H)return this.fire(new s.d(new Error(`The layer '${N}' does not exist in the map's style and cannot be queried for features.`))),[];b[H.source]=!0}}const T=[],E=h.serializedLayers||{},I=h&&h.layers?h.layers.some(N=>{const H=this.getLayer(N);return H&&H.is3D()}):this.has3DLayers(),k=zd.createFromScreenPoints(r,y);for(const N in this._mergedSourceCaches){const H=this._mergedSourceCaches[N].getSource();if(!H||H.scope!==h.scope)continue;const X=this._mergedSourceCaches[N].getSource().id;h.layers&&!b[X]||T.push(ju(this._mergedSourceCaches[N],this._mergedLayers,E,k,h,y,I,!!this.map._showQueryGeometry))}return this.placement&&T.push(function(N,H,X,ee,ie,ue,pe){const fe={},_e=ue.queryRenderedSymbols(ee),Le=[];for(const Fe of Object.keys(_e).map(Number))Le.push(pe[Fe]);Le.sort(Jf);for(const Fe of Le){const Be=Fe.featureIndex.lookupSymbolFeatures(_e[Fe.bucketInstanceId],H,Fe.bucketIndex,Fe.sourceLayerIndex,ie.filter,ie.layers,ie.availableImages,N);for(const $e in Be){const Ze=fe[$e]=fe[$e]||[],rt=Be[$e];rt.sort((xe,Ne)=>{const ct=Fe.featureSortOrder;if(ct){const Ot=ct.indexOf(xe.featureIndex);return ct.indexOf(Ne.featureIndex)-Ot}return Ne.featureIndex-xe.featureIndex});for(const xe of rt)Ze.push(xe)}}for(const Fe in fe)fe[Fe].forEach(Be=>{const $e=Be.feature,Ze=X(N[Fe]);if(!Ze)return;const rt=Ze.getFeatureState($e.layer["source-layer"],$e.id);$e.source=$e.layer.source,$e.layer["source-layer"]&&($e.sourceLayer=$e.layer["source-layer"]),$e.state=rt});return fe}(this._mergedLayers,E,this.getLayerSourceCache.bind(this),k.screenGeometry,h,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(T)}querySourceFeatures(r,h){h&&h.filter&&this._validate(Mi,"querySourceFeatures.filter",h.filter,null,h);const y=this.getOwnSourceCaches(r);let b=[];for(const T of y)b=b.concat(mg(T,h));return b}addSourceType(r,h,y){return Ha.getSourceType(r)?y(new Error(`A source type called "${r}" already exists.`)):(Ha.setSourceType(r,h),h.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:r,url:h.workerSourceURL},y):y(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(r,h,y={}){this._checkLoaded();const b=this.light.getLight();let T=!1;for(const I in r)if(!Z(r[I],b[I])){T=!0;break}if(!T)return;const E=this._getTransitionParameters();this.light.setLight(r,h,y),this.light.updateTransitions(E)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=s.e.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&s.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(r,h=1){if(this._checkLoaded(),!r)return this.terrainSetForDrapingOnly()&&h!==0||delete this.terrain,r===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let y=r;const b=r.source==null;if(h===1){if(this.disableElevatedTerrain)return;if(typeof y.source=="object"){const I="terrain-dem-src";this.addSource(I,y.source),y=s.cT(y),y=s.W(y,{source:I})}const T=s.W({},y),E={};if(this.terrain&&b){T.source=this.terrain.get().source;const I=this.terrain?this.getFragmentStyle(this.terrain.scope):null;I&&(E.style=I.serialize())}if(this._validate(yt,"terrain",T,E))return}if(!this.terrain||this.terrain.scope!==this.scope&&!b||this.terrain&&h!==this.terrain.drapeRenderMode){if(!y)return;this._createTerrain(y,h),this.fire(new s.f("data",{dataType:"style"}))}else{const T=this.terrain,E=T.get();for(const I of Object.keys(s.L.terrain))!y.hasOwnProperty(I)&&s.L.terrain[I].default&&(y[I]=s.L.terrain[I].default);for(const I in r)if(!Z(r[I],E[I])){T.set(r,this.options),this.stylesheet.terrain=r;const k=this._getTransitionParameters({duration:0});T.updateTransitions(k),this.fire(new s.f("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(r){const h=this.fog=new wo(r,this.map.transform,this.scope,this.options);this.stylesheet.fog=h.get();const y=this._getTransitionParameters({duration:0});h.updateTransitions(y)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(const r of this.map._markers)r._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(r){if(this._checkLoaded(),!r)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const h=this.fog;if(!Z(h.get(),r)){h.set(r,this.options),this.stylesheet.fog=h.get();const y=this._getTransitionParameters({duration:0});h.updateTransitions(y)}}else this._createFog(r);this._markersNeedUpdate=!0}setColorTheme(r){this._checkLoaded();const h=()=>{for(const b in this._layers)this._layers[b].lut=this._styleColorTheme.lut;for(const b in this._sourceCaches)this._sourceCaches[b].clearTiles()};if(this._styleColorTheme.colorTheme=r,!r)return this._styleColorTheme.lut=null,void h();const y=this._evaluateColorThemeData(r);this._loadColorTheme(y).then(()=>{this.fire(new s.f("colorthemeset")),h()}).catch(b=>{s.w(`Couldn't set color theme: ${b}`)})}_getTransitionParameters(r){return{now:s.e.now(),transition:s.W(this.transition,r)}}updateDrapeFirstLayers(){if(!this.terrain)return;const r=[],h=[];for(const y in this._mergedLayers)this.isLayerDraped(this._mergedLayers[y])?r.push(y):h.push(y);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...r),this._drapedFirstOrder.push(...h)}_createTerrain(r,h){const y=this.terrain=new Vr(r,h,this.scope,this.options);h===1&&(this.stylesheet.terrain=r),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const b=this._getTransitionParameters({duration:0});y.updateTransitions(b)}_force3DLayerUpdate(){for(const r in this._layers){const h=this._layers[r];h.type==="fill-extrusion"&&this._updateLayer(h)}}_forceSymbolLayerUpdate(){for(const r in this._layers){const h=this._layers[r];h.type==="symbol"&&this._updateLayer(h)}}_validate(r,h,y,b,T={}){if(T&&T.validate===!1)return!1;const E=s.W({},this.serialize());return Cc(this,r.call(Ke,s.W({key:h,style:E,value:y,styleSpec:s.L},b)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),s.c_.off("pluginStateChange",this._rtlTextPluginCallback);for(const r in this._mergedLayers)this._mergedLayers[r].setEventedParent(null);for(const r in this._mergedSourceCaches)this._mergedSourceCaches[r].clearTiles(),this._mergedSourceCaches[r].setEventedParent(null);this.setEventedParent(null),delete this.fog,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.dispatcher.remove())}clearSource(r){const h=this.getSourceCaches(r);for(const y of h)y.clearTiles()}clearSources(){for(const r in this._mergedSourceCaches)this._mergedSourceCaches[r].clearTiles()}reloadSource(r){const h=this.getSourceCaches(r);for(const y of h)y.resume(),y.reload()}reloadSources(){for(const r of this.getSources())r.reload&&r.reload()}updateSources(r){let h;this.directionalLight&&(h=Qa(this.directionalLight));for(const y in this._mergedSourceCaches)this._mergedSourceCaches[y].update(r,void 0,void 0,h)}_generateCollisionBoxes(){for(const r in this._sourceCaches){const h=this._sourceCaches[r];h.resume(),h.reload()}}_updatePlacement(r,h,y,b,T,E,I=!1){let k=!1,N=!1;const H={},X={};for(const ie of this._mergedOrder){const ue=this._mergedLayers[ie];if(ue.type!=="symbol")continue;const pe=s.al(ue.source,ue.scope);let fe=H[pe];if(!fe){const Le=this.getLayerSourceCache(ue);if(!Le)continue;const Fe=Le.getRenderableIds(!0).map(Be=>Le.getTileByID(Be));X[pe]=Fe.slice(),fe=H[pe]=Fe.sort((Be,$e)=>$e.tileID.overscaledZ-Be.tileID.overscaledZ||(Be.tileID.isLessThan($e.tileID)?-1:1))}const _e=this.crossTileSymbolIndex.addLayer(ue,fe,h.center.lng,h.projection);k=k||_e}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),I=I||this._layerOrderChanged||b===0,this._layerOrderChanged&&this.fire(new s.f("neworder")),(I||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(s.e.now(),h.zoom))&&(this.pauseablePlacement=new mh(h,this._mergedOrder,I,y,b,T,this.placement,this.fog&&h.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,H,X),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(s.e.now()),N=!0),k&&this.pauseablePlacement.placement.setStale()),N||k){this._buildingIndex.onNewFrame(h.zoom);for(let ie=0;ie<this._mergedOrder.length;ie++){const ue=this._mergedLayers[this._mergedOrder[ie]];if(ue.type!=="symbol")continue;const pe=this.isLayerClipped(ue)&&this._clipLayerIndices.some(fe=>ie<fe);this.placement.updateLayerOpacities(ue,H[s.al(ue.source,ue.scope)],ie,pe?E:null)}}let ee=!1;for(const ie of this._mergedOrder){const ue=this._mergedLayers[ie];if(ue.type!=="symbol")continue;const pe=H[s.al(ue.source,ue.scope)];for(const fe of pe){const _e=fe.getBucket(ue);_e&&fe.latestFeatureIndex&&ue.fqid===_e.layerIds[0]&&(ee=_e.updateOcclusionOpacities(r.context,r.symbolParams,r._dt)||ee)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(s.e.now())||ee,occlusionQueryBasedOpacityChanged:ee}}_releaseSymbolFadeTiles(){for(const r in this._sourceCaches)this._sourceCaches[r].releaseSymbolFadeTiles()}addImport(r,h){this._checkLoaded();const y=this.stylesheet.imports=this.stylesheet.imports||[];if(y.findIndex(({id:T})=>T===r.id)!==-1)return void this.fire(new s.d(new Error(`Import with id '${r.id}' already exists in the map's style.`)));if(!h)return y.push(r),this._loadImports([r],!0);const b=y.findIndex(({id:T})=>T===h);return b===-1&&this.fire(new s.d(new Error(`Import with id "${h}" does not exist on this map.`))),this.stylesheet.imports=y.slice(0,b).concat(r).concat(y.slice(b)),this._loadImports([r],!0,h)}updateImport(r,h){this._checkLoaded();const y=this.stylesheet.imports||[],b=this.getImportIndex(r);return b===-1?this:typeof h=="string"?(this.setImportUrl(r,h),this):(h.url&&h.url!==y[b].url&&this.setImportUrl(r,h.url),Z(h.config,y[b].config)||this.setImportConfig(r,h.config),Z(h.data,y[b].data)||this.setImportData(r,h.data),this)}moveImport(r,h){this._checkLoaded();let y=this.stylesheet.imports||[];const b=this.getImportIndex(r);if(b===-1)return this;const T=this.getImportIndex(h);if(T===-1)return this;const E=y[b],I=this.fragments[b];return y=y.filter(({id:k})=>k!==r),this.fragments=this.fragments.filter(({id:k})=>k!==r),this.stylesheet.imports=y.slice(0,T).concat(E).concat(y.slice(T)),this.fragments=this.fragments.slice(0,T).concat(I).concat(this.fragments.slice(T)),this.mergeLayers(),this}setImportUrl(r,h){this._checkLoaded();const y=this.stylesheet.imports||[],b=this.getImportIndex(r);if(b===-1)return this;y[b].url=h;const T=this.fragments[b];return T.style=this._createFragmentStyle(y[b]),T.style.on("style.import.load",()=>this.mergeAll()),T.style.loadURL(h),this}setImportData(r,h){this._checkLoaded();const y=this.getImportIndex(r),b=this.stylesheet.imports||[];return y===-1?this:h?(this.fragments[y].style.setState(h),this._reloadImports(),this):(delete b[y].data,this.setImportUrl(r,b[y].url))}setImportConfig(r,h){this._checkLoaded();const y=this.getImportIndex(r),b=this.stylesheet.imports||[];if(y===-1)return this;h?b[y].config=h:delete b[y].config;const T=this.fragments[y],E=T.style.stylesheet&&T.style.stylesheet.schema;return T.config=h,T.style.updateConfig(h,E),this.updateConfigDependencies(),this}removeImport(r){this._checkLoaded();const h=this.stylesheet.imports||[],y=this.getImportIndex(r);y!==-1&&(h.splice(y,1),this.fragments[y].style._remove(),this.fragments.splice(y,1),this._reloadImports())}getImportIndex(r){const h=(this.stylesheet.imports||[]).findIndex(y=>y.id===r);return h===-1&&this.fire(new s.d(new Error(`Import '${r}' does not exist in the map's style and cannot be updated.`))),h}getLayer(r){return this._mergedLayers[r]}getSources(){const r=[];for(const h in this._mergedOtherSourceCaches){const y=this._mergedOtherSourceCaches[h];y&&r.push(y.getSource())}return r}getSource(r,h){const y=this.getSourceCache(r,h);return y&&y.getSource()}getLayerSource(r){const h=this.getLayerSourceCache(r);return h&&h.getSource()}getSourceCache(r,h){const y=s.al(r,h);return this._mergedOtherSourceCaches[y]}getLayerSourceCache(r){const h=s.al(r.source,r.scope);return r.type==="symbol"?this._mergedSymbolSourceCaches[h]:this._mergedOtherSourceCaches[h]}getSourceCaches(r){if(r==null)return Object.values(this._mergedSourceCaches);const h=[];return this._mergedOtherSourceCaches[r]&&h.push(this._mergedOtherSourceCaches[r]),this._mergedSymbolSourceCaches[r]&&h.push(this._mergedSymbolSourceCaches[r]),h}updateSourceCaches(){const r=this._changes.getUpdatedSourceCaches();for(const h in r){const y=r[h];y==="reload"?this.reloadSource(h):y==="clear"&&this.clearSource(h)}}updateLayers(r){const h=this._changes.getUpdatedPaintProperties();for(const y of h){const b=this.getLayer(y);b&&b.updateTransitions(r)}}getImages(r,h,y){this.imageManager.getImages(h.icons,h.scope,y),this._updateTilesForChangedImages();const b=T=>{T&&T.setDependencies(h.tileID.key,h.type,h.icons)};b(this._otherSourceCaches[h.source]),b(this._symbolSourceCaches[h.source])}getGlyphs(r,h,y){this.glyphManager.getGlyphs(h.stacks,h.scope,y)}getResource(r,h,y){return s.c$(h,y)}getOwnSourceCache(r){return this._otherSourceCaches[r]}getOwnLayerSourceCache(r){return r.type==="symbol"?this._symbolSourceCaches[r.source]:this._otherSourceCaches[r.source]}getOwnSourceCaches(r){const h=[];return this._otherSourceCaches[r]&&h.push(this._otherSourceCaches[r]),this._symbolSourceCaches[r]&&h.push(this._symbolSourceCaches[r]),h}_isSourceCacheLoaded(r){const h=this.getOwnSourceCaches(r);return h.length===0?(this.fire(new s.d(new Error(`There is no source with ID '${r}'`))),!1):h.every(y=>y.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(r,h){if(this._clipLayerIndices.length===0&&r.type!=="fill-extrusion")return!1;const y=r.type==="fill-extrusion"&&r.sourceLayer==="building";let b=0;if(r.is3D()){if(y||h&&h.type==="batched-model")return!0;r.type==="model"&&(b=s.cu.Model)}else r.type==="symbol"&&(b=s.cu.Symbol);for(const T of this._clipLayerIndices){const E=this._mergedLayers[this._mergedOrder[T]];if(!E)continue;const I=[];for(const k of E.layout.get("clip-layer-types"))I.push(k==="model"?s.cu.Model:k==="symbol"?s.cu.Symbol:s.cu.FillExtrusion);for(const k of I)if(b&k)return!0}return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(r=>{r.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}function nm(m,r){let h=!1,y=null;const b=()=>{y=null,h&&(m(),y=setTimeout(b,r),h=!1)};return()=>(h=!0,y||b(),y)}Ha.getSourceType=function(m){return oh[m]},Ha.setSourceType=function(m,r){oh[m]=r},Ha.registerForPluginStateChange=s.cL;class rm{constructor(r){this._hashName=r&&encodeURIComponent(r),s.bp(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=nm(this._updateHashUnthrottled.bind(this),300)}addTo(r){return this._map=r,window.addEventListener("hashchange",this._onHashChange,!1),r.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const r=this._map;if(!r)return"";const h=Np(r);if(this._hashName){const y=this._hashName;let b=!1;const T=location.hash.slice(1).split("&").map(E=>{const I=E.split("=")[0];return I===y?(b=!0,`${I}=${h}`):E}).filter(E=>E);return b||T.push(`${y}=${h}`),`#${T.join("&")}`}return`#${h}`}_getCurrentHash(){const r=location.hash.replace("#","");if(this._hashName){let h;return r.split("&").map(y=>y.split("=")).forEach(y=>{y[0]===this._hashName&&(h=y)}),(h&&h[1]||"").split("/")}return r.split("/")}_onHashChange(){const r=this._map;if(!r)return!1;const h=this._getCurrentHash();if(h.length>=3&&!h.some(y=>isNaN(y))){const y=r.dragRotate.isEnabled()&&r.touchZoomRotate.isEnabled()?+(h[3]||0):r.getBearing();return r.jumpTo({center:[+h[2],+h[1]],zoom:+h[0],bearing:y,pitch:+(h[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function Np(m,r){const h=m.getCenter(),y=Math.round(100*m.getZoom())/100,b=Math.ceil((y*Math.LN2+Math.log(512/360/.5))/Math.LN10),T=Math.pow(10,b),E=Math.round(h.lng*T)/T,I=Math.round(h.lat*T)/T,k=m.getBearing(),N=m.getPitch();let H=r?`/${E}/${I}/${y}`:`${y}/${I}/${E}`;return(k||N)&&(H+="/"+Math.round(10*k)/10),N&&(H+=`/${Math.round(N)}`),H}const lc={linearity:.3,easing:s.d0(0,0,.3,1)},yh=s.W({deceleration:2500,maxSpeed:1400},lc),sm=s.W({deceleration:20,maxSpeed:1400},lc),Ku=s.W({deceleration:1e3,maxSpeed:360},lc),Bd=s.W({deceleration:1e3,maxSpeed:90},lc);class Up{constructor(r){this._map=r,this.clear()}clear(){this._inertiaBuffer=[]}record(r){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:s.e.now(),settings:r})}_drainInertiaBuffer(){const r=this._inertiaBuffer,h=s.e.now();for(;r.length>0&&h-r[0].time>160;)r.shift()}_onMoveEnd(r){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const h={zoom:0,bearing:0,pitch:0,pan:new s.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:T}of this._inertiaBuffer)h.zoom+=T.zoomDelta||0,h.bearing+=T.bearingDelta||0,h.pitch+=T.pitchDelta||0,T.panDelta&&h.pan._add(T.panDelta),T.around&&(h.around=T.around),T.pinchAround&&(h.pinchAround=T.pinchAround);const y=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,b={};if(h.pan.mag()){const T=xh(h.pan.mag(),y,s.W({},yh,r||{}));b.offset=h.pan.mult(T.amount/h.pan.mag()),b.center=this._map.transform.center,cs(b,T)}if(h.zoom){const T=xh(h.zoom,y,sm);b.zoom=this._map.transform.zoom+T.amount,cs(b,T)}if(h.bearing){const T=xh(h.bearing,y,Ku);b.bearing=this._map.transform.bearing+s.at(T.amount,-179,179),cs(b,T)}if(h.pitch){const T=xh(h.pitch,y,Bd);b.pitch=this._map.transform.pitch+T.amount,cs(b,T)}if(b.zoom||b.bearing){const T=h.pinchAround===void 0?h.around:h.pinchAround;b.around=T?this._map.unproject(T):this._map.getCenter()}return this.clear(),b.noMoveStart=!0,b}}function cs(m,r){(!m.duration||m.duration<r.duration)&&(m.duration=r.duration,m.easing=r.easing)}function xh(m,r,h){const{maxSpeed:y,linearity:b,deceleration:T}=h,E=s.at(m*b/(r/1e3),-y,y),I=Math.abs(E)/(T*b);return{easing:h.easing,duration:1e3*I,amount:E*(I/2)}}class Oo extends s.f{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(r,h,y,b={}){const T=lt(h.getCanvasContainer(),y),E=h.unproject(T);super(r,s.W({point:T,lngLat:E,originalEvent:y},b)),this._defaultPrevented=!1,this.target=h}}class Ca extends s.f{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(r,h,y){const b=r==="touchend"?y.changedTouches:y.touches,T=Ct(h.getCanvasContainer(),b),E=T.map(k=>h.unproject(k)),I=T.reduce((k,N,H,X)=>k.add(N.div(X.length)),new s.P(0,0));super(r,{points:T,point:I,lngLats:E,lngLat:h.unproject(I),originalEvent:y}),this._defaultPrevented=!1}}class Lc extends s.f{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(r,h){super("wheel",{originalEvent:h}),this._defaultPrevented=!1}}class Pl{constructor(r,h){this._map=r,this._clickTolerance=h.clickTolerance}reset(){this._mousedownPos=void 0}wheel(r){return this._firePreventable(new Lc(this._map,r))}mousedown(r,h){return this._mousedownPos=h,this._firePreventable(new Oo(r.type,this._map,r))}mouseup(r){this._map.fire(new Oo(r.type,this._map,r))}preclick(r){const h=s.W({},r);h.type="preclick",this._map.fire(new Oo(h.type,this._map,h))}click(r,h){this._mousedownPos&&this._mousedownPos.dist(h)>=this._clickTolerance||(this.preclick(r),this._map.fire(new Oo(r.type,this._map,r)))}dblclick(r){return this._firePreventable(new Oo(r.type,this._map,r))}mouseover(r){this._map.fire(new Oo(r.type,this._map,r))}mouseout(r){this._map.fire(new Oo(r.type,this._map,r))}touchstart(r){return this._firePreventable(new Ca(r.type,this._map,r))}touchmove(r){this._map.fire(new Ca(r.type,this._map,r))}touchend(r){this._map.fire(new Ca(r.type,this._map,r))}touchcancel(r){this._map.fire(new Ca(r.type,this._map,r))}_firePreventable(r){if(this._map.fire(r),r.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class eo{constructor(r){this._map=r}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(r){this._map.fire(new Oo(r.type,this._map,r))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Oo("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(r){this._delayContextMenu?this._contextMenuEvent=r:this._map.fire(new Oo(r.type,this._map,r)),this._map.listens("contextmenu")&&r.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class ja{constructor(r,h){this._map=r,this._el=r.getCanvasContainer(),this._container=r.getContainer(),this._clickTolerance=h.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(r,h){this.isEnabled()&&r.shiftKey&&r.button===0&&(Mt(),this._startPos=this._lastPos=h,this._active=!0)}mousemoveWindow(r,h){if(!this._active)return;const y=h,b=this._startPos,T=this._lastPos;if(!b||!T||T.equals(y)||!this._box&&y.dist(b)<this._clickTolerance)return;this._lastPos=y,this._box||(this._box=ve("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",r));const E=Math.min(b.x,y.x),I=Math.max(b.x,y.x),k=Math.min(b.y,y.y),N=Math.max(b.y,y.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${E}px,${k}px)`,this._box.style.width=I-E+"px",this._box.style.height=N-k+"px")})}mouseupWindow(r,h){if(!this._active)return;const y=this._startPos,b=h;if(y&&r.button===0){if(this.reset(),Wt(),y.x!==b.x||y.y!==b.y)return this._map.fire(new s.f("boxzoomend",{originalEvent:r})),{cameraAnimation:T=>T.fitScreenCoordinates(y,b,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",r)}}keydown(r){this._active&&r.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",r))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),Lt(),delete this._startPos,delete this._lastPos}_fireEvent(r,h){return this._map.fire(new s.f(r,{originalEvent:h}))}}function cc(m,r){const h={};for(let y=0;y<m.length;y++)h[m[y].identifier]=r[y];return h}class Ic{constructor(r){this.reset(),this.numTouches=r.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(r,h,y){(this.centroid||y.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=r.timeStamp),y.length===this.numTouches&&(this.centroid=function(b){const T=new s.P(0,0);for(const E of b)T._add(E);return T.div(b.length)}(h),this.touches=cc(y,h)))}touchmove(r,h,y){if(this.aborted||!this.centroid)return;const b=cc(y,h);for(const T in this.touches){const E=b[T];(!E||E.dist(this.touches[T])>30)&&(this.aborted=!0)}}touchend(r,h,y){if((!this.centroid||r.timeStamp-this.startTime>500)&&(this.aborted=!0),y.length===0){const b=!this.aborted&&this.centroid;if(this.reset(),b)return b}}}class Pc{constructor(r){this.singleTap=new Ic(r),this.numTaps=r.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(r,h,y){this.singleTap.touchstart(r,h,y)}touchmove(r,h,y){this.singleTap.touchmove(r,h,y)}touchend(r,h,y){const b=this.singleTap.touchend(r,h,y);if(b){const T=r.timeStamp-this.lastTime<500,E=!this.lastTap||this.lastTap.dist(b)<30;if(T&&E||this.reset(),this.count++,this.lastTime=r.timeStamp,this.lastTap=b,this.count===this.numTaps)return this.reset(),b}}}class Rc{constructor(){this._zoomIn=new Pc({numTouches:1,numTaps:2}),this._zoomOut=new Pc({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(r,h,y){this._zoomIn.touchstart(r,h,y),this._zoomOut.touchstart(r,h,y)}touchmove(r,h,y){this._zoomIn.touchmove(r,h,y),this._zoomOut.touchmove(r,h,y)}touchend(r,h,y){const b=this._zoomIn.touchend(r,h,y),T=this._zoomOut.touchend(r,h,y);return b?(this._active=!0,r.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:E=>E.easeTo({duration:300,zoom:E.getZoom()+1,around:E.unproject(b)},{originalEvent:r})}):T?(this._active=!0,r.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:E=>E.easeTo({duration:300,zoom:E.getZoom()-1,around:E.unproject(T)},{originalEvent:r})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const hc={0:1,2:2};class Wa{constructor(r){this.reset(),this._clickTolerance=r.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(r,h){return!1}_move(r,h){return{}}mousedown(r,h){if(this._lastPoint)return;const y=qt(r);this._correctButton(r,y)&&(this._lastPoint=h,this._eventButton=y)}mousemoveWindow(r,h){const y=this._lastPoint;if(y){if(r.preventDefault(),this._eventButton!=null&&function(b,T){const E=hc[T];return b.buttons===void 0||(b.buttons&E)!==E}(r,this._eventButton))this.reset();else if(this._moved||!(h.dist(y)<this._clickTolerance))return this._moved=!0,this._lastPoint=h,this._move(y,h)}}mouseupWindow(r){this._lastPoint&&qt(r)===this._eventButton&&(this._moved&&Wt(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Qh extends Wa{mousedown(r,h){super.mousedown(r,h),this._lastPoint&&(this._active=!0)}_correctButton(r,h){return h===0&&!r.ctrlKey}_move(r,h){return{around:h,panDelta:h.sub(r)}}}class Nd extends Wa{_correctButton(r,h){return h===0&&r.ctrlKey||h===2}_move(r,h){const y=.8*(h.x-r.x);if(y)return this._active=!0,{bearingDelta:y}}contextmenu(r){r.preventDefault()}}class eu extends Wa{_correctButton(r,h){return h===0&&r.ctrlKey||h===2}_move(r,h){const y=-.5*(h.y-r.y);if(y)return this._active=!0,{pitchDelta:y}}contextmenu(r){r.preventDefault()}}class Rl{constructor(r,h){this._map=r,this._el=r.getCanvasContainer(),this._minTouches=1,this._clickTolerance=h.clickTolerance||1,this.reset(),s.bp(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new s.P(0,0)}touchstart(r,h,y){return this._calculateTransform(r,h,y)}touchmove(r,h,y){if(this._active&&!(y.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(y.length===1&&!s.d1())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return r.cancelable&&r.preventDefault(),this._calculateTransform(r,h,y)}}touchend(r,h,y){this._calculateTransform(r,h,y),this._active&&y.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(r,h,y){y.length>0&&(this._active=!0);const b=cc(y,h),T=new s.P(0,0),E=new s.P(0,0);let I=0;for(const N in b){const H=b[N],X=this._touches[N];X&&(T._add(H),E._add(H.sub(X)),I++,b[N]=H)}if(this._touches=b,I<this._minTouches||!E.mag())return;const k=E.div(I);return this._sum._add(k),this._sum.mag()<this._clickTolerance?void 0:{around:T.div(I),panDelta:k}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=ve("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class vh{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(r){}_move(r,h,y){return{}}touchstart(r,h,y){this._firstTwoTouches||y.length<2||(this._firstTwoTouches=[y[0].identifier,y[1].identifier],this._start([h[0],h[1]]))}touchmove(r,h,y){const b=this._firstTwoTouches;if(!b)return;r.preventDefault();const[T,E]=b,I=Qu(y,h,T),k=Qu(y,h,E);if(!I||!k)return;const N=this._aroundCenter?null:I.add(k).div(2);return this._move([I,k],N,r)}touchend(r,h,y){if(!this._firstTwoTouches)return;const[b,T]=this._firstTwoTouches,E=Qu(y,h,b),I=Qu(y,h,T);E&&I||(this._active&&Wt(),this.reset())}touchcancel(){this.reset()}enable(r){this._enabled=!0,this._aroundCenter=!!r&&r.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Qu(m,r,h){for(let y=0;y<m.length;y++)if(m[y].identifier===h)return r[y]}function Ud(m,r){return Math.log(m/r)/Math.LN2}class om extends vh{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(r){this._startDistance=this._distance=r[0].dist(r[1])}_move(r,h){const y=this._distance;if(this._distance=r[0].dist(r[1]),this._active||!(Math.abs(Ud(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:Ud(this._distance,y),pinchAround:h}}}function bh(m,r){return 180*m.angleWith(r)/Math.PI}class tu extends vh{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(r){this._startVector=this._vector=r[0].sub(r[1]),this._minDiameter=r[0].dist(r[1])}_move(r,h){const y=this._vector;if(this._vector=r[0].sub(r[1]),y&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:bh(this._vector,y),pinchAround:h}}_isBelowThreshold(r){this._minDiameter=Math.min(this._minDiameter,r.mag());const h=25/(Math.PI*this._minDiameter)*360,y=this._startVector;if(!y)return!1;const b=bh(r,y);return Math.abs(b)<h}}function Dc(m){return Math.abs(m.y)>Math.abs(m.x)}class Vd extends vh{constructor(r){super(),this._map=r}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(r){this._lastPoints=r,Dc(r[0].sub(r[1]))&&(this._valid=!1)}_move(r,h,y){const b=this._lastPoints;if(!b)return;const T=r[0].sub(b[0]),E=r[1].sub(b[1]);return this._map._cooperativeGestures&&!s.d1()&&y.touches.length<3||(this._valid=this.gestureBeginsVertically(T,E,y.timeStamp),!this._valid)?void 0:(this._lastPoints=r,this._active=!0,{pitchDelta:(T.y+E.y)/2*-.5})}gestureBeginsVertically(r,h,y){if(this._valid!==void 0)return this._valid;const b=r.mag()>=2,T=h.mag()>=2;if(!b&&!T)return;if(!b||!T)return this._firstMove==null&&(this._firstMove=y),y-this._firstMove<100&&void 0;const E=r.y>0==h.y>0;return Dc(r)&&Dc(h)&&E}}const Vp={panStep:100,bearingStep:15,pitchStep:10};class Gp{constructor(){const r=Vp;this._panStep=r.panStep,this._bearingStep=r.bearingStep,this._pitchStep=r.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(r){if(r.altKey||r.ctrlKey||r.metaKey)return;let h=0,y=0,b=0,T=0,E=0;switch(r.keyCode){case 61:case 107:case 171:case 187:h=1;break;case 189:case 109:case 173:h=-1;break;case 37:r.shiftKey?y=-1:(r.preventDefault(),T=-1);break;case 39:r.shiftKey?y=1:(r.preventDefault(),T=1);break;case 38:r.shiftKey?b=1:(r.preventDefault(),E=-1);break;case 40:r.shiftKey?b=-1:(r.preventDefault(),E=1);break;default:return}return this._rotationDisabled&&(y=0,b=0),{cameraAnimation:I=>{const k=I.getZoom();I.easeTo({duration:300,easeId:"keyboardHandler",easing:am,zoom:h?Math.round(k)+h*(r.shiftKey?2:1):k,bearing:I.getBearing()+y*this._bearingStep,pitch:I.getPitch()+b*this._pitchStep,offset:[-T*this._panStep,-E*this._panStep],center:I.getCenter()},{originalEvent:r})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function am(m){return m*(2-m)}const wh=4.000244140625,ed=1/450;class Hp{constructor(r,h){this._map=r,this._el=r.getCanvasContainer(),this._handler=h,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=ed,s.bp(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(r){this._defaultZoomRate=r}setWheelZoomRate(r){this._wheelZoomRate=r}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(r){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!r&&r.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(r){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(r.ctrlKey||r.metaKey||this.isZooming()||s.d1()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let h=r.deltaMode===WheelEvent.DOM_DELTA_LINE?40*r.deltaY:r.deltaY;const y=s.e.now(),b=y-(this._lastWheelEventTime||0);this._lastWheelEventTime=y,h!==0&&h%wh==0?this._type="wheel":h!==0&&Math.abs(h)<4?this._type="trackpad":b>400?(this._type=null,this._lastValue=h,this._timeout=setTimeout(this._onTimeout,40,r)):this._type||(this._type=Math.abs(b*h)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,h+=this._lastValue)),r.shiftKey&&h&&(h/=4),this._type&&(this._lastWheelEvent=r,this._delta-=h,this._active||this._start(r)),r.preventDefault()}_onTimeout(r){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(r)}_start(r){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const h=lt(this._el,r);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:h,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const r=this._map.transform;this._type==="wheel"&&r.projection.wrap&&(r._center.lng>=180||r._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const h=()=>r._terrainEnabled()&&this._aroundCoord?r.computeZoomRelativeTo(this._aroundCoord):r.zoom;if(this._delta!==0){const N=this._type==="wheel"&&Math.abs(this._delta)>wh?this._wheelZoomRate:this._defaultZoomRate;let H=2/(1+Math.exp(-Math.abs(this._delta*N)));this._delta<0&&H!==0&&(H=1/H);const X=h(),ee=Math.pow(2,X),ie=typeof this._targetZoom=="number"?r.zoomScale(this._targetZoom):ee;this._targetZoom=Math.min(r.maxZoom,Math.max(r.minZoom,r.scaleZoom(ie*H))),this._type==="wheel"&&(this._startZoom=X,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const y=typeof this._targetZoom=="number"?this._targetZoom:h(),b=this._startZoom,T=this._easing;let E,I=!1;if(this._type==="wheel"&&b&&T){const N=Math.min((s.e.now()-this._lastWheelEventTime)/200,1),H=T(N);E=s.a2(b,y,H),N<1?this._frameId||(this._frameId=!0):I=!0}else E=y,I=!0;this._active=!0,I&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let k=E-h();return k*this._lastDelta<0&&(k=0),{noInertia:!0,needsRenderFrame:!I,zoomDelta:k,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(r){let h=s.d2;if(this._prevEase){const y=this._prevEase,b=(s.e.now()-y.start)/y.duration,T=y.easing(b+.01)-y.easing(b),E=.27/Math.sqrt(T*T+1e-4)*.01,I=Math.sqrt(.0729-E*E);h=s.d0(E,I,.25,1)}return this._prevEase={start:s.e.now(),duration:r,easing:h},h}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=ve("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class Xo{constructor(r,h){this._clickZoom=r,this._tapZoom=h}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class iu{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(r,h){return r.preventDefault(),{cameraAnimation:y=>{y.easeTo({duration:300,zoom:y.getZoom()+(r.shiftKey?-1:1),around:y.unproject(h)},{originalEvent:r})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Dl{constructor(){this._tap=new Pc({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(r,h,y){this._swipePoint||(this._tapTime&&r.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?y.length>0&&(this._swipePoint=h[0],this._swipeTouch=y[0].identifier):this._tap.touchstart(r,h,y))}touchmove(r,h,y){if(this._tapTime){if(this._swipePoint){if(y[0].identifier!==this._swipeTouch)return;const b=h[0],T=b.y-this._swipePoint.y;return this._swipePoint=b,r.preventDefault(),this._active=!0,{zoomDelta:T/128}}}else this._tap.touchmove(r,h,y)}touchend(r,h,y){this._tapTime?this._swipePoint&&y.length===0&&this.reset():this._tap.touchend(r,h,y)&&(this._tapTime=r.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class td{constructor(r,h,y){this._el=r,this._mousePan=h,this._touchPan=y}enable(r){this._inertiaOptions=r||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class jp{constructor(r,h,y){this._pitchWithRotate=r.pitchWithRotate,this._mouseRotate=h,this._mousePitch=y}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class nu{constructor(r,h,y,b){this._el=r,this._touchZoom=h,this._touchRotate=y,this._tapDragZoom=b,this._rotationDisabled=!1,this._enabled=!0}enable(r){this._touchZoom.enable(r),this._rotationDisabled||this._touchRotate.enable(r),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const La=m=>m.zoom||m.drag||m.pitch||m.rotate;class Gd extends s.f{}class Hd{constructor(){this.constants=[1,1,.01],this.radius=0}setup(r,h){const y=s._.sub([],h,r);this.radius=s._.length(y[2]<0?s._.div([],y,this.constants):[y[0],y[1],0])}projectRay(r){s._.div(r,r,this.constants),s._.normalize(r,r),s._.mul(r,r,this.constants);const h=s._.scale([],r,this.radius);if(h[2]>0){const y=s._.scale([],[0,0,1],s._.dot(h,[0,0,1])),b=s._.scale([],s._.normalize([],[h[0],h[1],0]),this.radius),T=s._.add([],h,s._.scale([],s._.sub([],s._.add([],b,y),h),2));h[0]=T[0],h[1]=T[1]}return h}}function zl(m){return m.panDelta&&m.panDelta.mag()||m.zoomDelta||m.bearingDelta||m.pitchDelta}class ru{constructor(r,h){this._map=r,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Up(r),this._bearingSnap=h.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Hd,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(h),s.bp(["handleEvent","handleWindowEvent"],this);const y=this._el;this._listeners=[[y,"touchstart",{passive:!0}],[y,"touchmove",{passive:!1}],[y,"touchend",void 0],[y,"touchcancel",void 0],[y,"mousedown",void 0],[y,"mousemove",void 0],[y,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[y,"mouseover",void 0],[y,"mouseout",void 0],[y,"dblclick",void 0],[y,"click",void 0],[y,"keydown",{capture:!1}],[y,"keyup",void 0],[y,"wheel",{passive:!1}],[y,"contextmenu",void 0],[window,"blur",void 0]];for(const[b,T,E]of this._listeners){const I=b===document?this.handleWindowEvent:this.handleEvent;b.addEventListener(T,I,E)}}destroy(){for(const[r,h,y]of this._listeners){const b=r===document?this.handleWindowEvent:this.handleEvent;r.removeEventListener(h,b,y)}}_addDefaultHandlers(r){const h=this._map,y=h.getCanvasContainer();this._add("mapEvent",new Pl(h,r));const b=h.boxZoom=new ja(h,r);this._add("boxZoom",b);const T=new Rc,E=new iu;h.doubleClickZoom=new Xo(E,T),this._add("tapZoom",T),this._add("clickZoom",E);const I=new Dl;this._add("tapDragZoom",I);const k=h.touchPitch=new Vd(h);this._add("touchPitch",k);const N=new Nd(r),H=new eu(r);h.dragRotate=new jp(r,N,H),this._add("mouseRotate",N,["mousePitch"]),this._add("mousePitch",H,["mouseRotate"]);const X=new Qh(r),ee=new Rl(h,r);h.dragPan=new td(y,X,ee),this._add("mousePan",X),this._add("touchPan",ee,["touchZoom","touchRotate"]);const ie=new tu,ue=new om;h.touchZoomRotate=new nu(y,ue,ie,I),this._add("touchRotate",ie,["touchPan","touchZoom"]),this._add("touchZoom",ue,["touchPan","touchRotate"]),this._add("blockableMapEvent",new eo(h));const pe=h.scrollZoom=new Hp(h,this);this._add("scrollZoom",pe,["mousePan"]);const fe=h.keyboard=new Gp;this._add("keyboard",fe);for(const _e of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])r.interactive&&r[_e]&&h[_e].enable(r[_e])}_add(r,h,y){this._handlers.push({handlerName:r,handler:h,allowed:y}),this._handlersById[r]=h}stop(r){if(!this._updatingCamera){for(const{handler:h}of this._handlers)h.reset();this._inertia.clear(),this._fireEvents({},{},r),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:r}of this._handlers)if(r.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!La(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(r,h,y){for(const b in r)if(b!==y&&(!h||h.indexOf(b)<0))return!0;return!1}handleWindowEvent(r){this.handleEvent(r,`${r.type}Window`)}_getMapTouches(r){const h=[];for(const y of r)this._el.contains(y.target)&&h.push(y);return h}handleEvent(r,h){this._updatingCamera=!0;const y=r.type==="renderFrame",b=y?void 0:r,T={needsRenderFrame:!1},E={},I={},k=r.touches?this._getMapTouches(r.touches):void 0,N=k?Ct(this._el,k):y?void 0:lt(this._el,r);for(const{handlerName:ee,handler:ie,allowed:ue}of this._handlers){if(!ie.isEnabled())continue;let pe;this._blockedByActive(I,ue,ee)?ie.reset():ie[h||r.type]&&(pe=ie[h||r.type](r,N,k),this.mergeHandlerResult(T,E,pe,ee,b),pe&&pe.needsRenderFrame&&this._triggerRenderFrame()),(pe||ie.isActive())&&(I[ee]=ie)}const H={};for(const ee in this._previousActiveHandlers)I[ee]||(H[ee]=b);this._previousActiveHandlers=I,(Object.keys(H).length||zl(T))&&(this._changes.push([T,E,H]),this._triggerRenderFrame()),(Object.keys(I).length||zl(T))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:X}=T;X&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],X(this._map))}mergeHandlerResult(r,h,y,b,T){if(!y)return;s.W(r,y);const E={handlerName:b,originalEvent:y.originalEvent||T};y.zoomDelta!==void 0&&(h.zoom=E),y.panDelta!==void 0&&(h.drag=E),y.pitchDelta!==void 0&&(h.pitch=E),y.bearingDelta!==void 0&&(h.rotate=E)}_applyChanges(){const r={},h={},y={};for(const[b,T,E]of this._changes)b.panDelta&&(r.panDelta=(r.panDelta||new s.P(0,0))._add(b.panDelta)),b.zoomDelta&&(r.zoomDelta=(r.zoomDelta||0)+b.zoomDelta),b.bearingDelta&&(r.bearingDelta=(r.bearingDelta||0)+b.bearingDelta),b.pitchDelta&&(r.pitchDelta=(r.pitchDelta||0)+b.pitchDelta),b.around!==void 0&&(r.around=b.around),b.aroundCoord!==void 0&&(r.aroundCoord=b.aroundCoord),b.pinchAround!==void 0&&(r.pinchAround=b.pinchAround),b.noInertia&&(r.noInertia=b.noInertia),s.W(h,T),s.W(y,E);this._updateMapTransform(r,h,y),this._changes=[]}_updateMapTransform(r,h,y){const b=this._map,T=b.transform,E=Le=>[Le.x,Le.y,Le.z];if((Le=>{const Fe=this._eventsInProgress.drag;return Fe&&!this._handlersById[Fe.handlerName].isActive()})()&&!zl(r)){const Le=T.zoom;T.cameraElevationReference="sea",this._originalZoom!=null&&T._orthographicProjectionAtLowPitch&&T.projection.name!=="globe"&&T.pitch===0?(T.cameraElevationReference="ground",T.zoom=this._originalZoom):(T.recenterOnTerrain(),T.cameraElevationReference="ground"),Le!==T.zoom&&this._map._update(!0)}if(T._isCameraConstrained&&b._stop(!0),!zl(r))return void this._fireEvents(h,y,!0);let{panDelta:I,zoomDelta:k,bearingDelta:N,pitchDelta:H,around:X,aroundCoord:ee,pinchAround:ie}=r;T._isCameraConstrained&&(k>0&&(k=0),T._isCameraConstrained=!1),ie!==void 0&&(X=ie),(k||(Le=>h[Le]&&!this._eventsInProgress[Le])("drag"))&&X&&(this._dragOrigin=E(T.pointCoordinate3D(X)),this._originalZoom=T.zoom,this._trackingEllipsoid.setup(T._camera.position,this._dragOrigin)),T.cameraElevationReference="sea",b._stop(!0),X=X||b.transform.centerPoint,N&&(T.bearing+=N),H&&(T.pitch+=H),T._updateCameraState();const ue=[0,0,0];if(I)if(T.projection.name==="mercator"){const Le=this._trackingEllipsoid.projectRay(T.screenPointToMercatorRay(X).dir),Fe=this._trackingEllipsoid.projectRay(T.screenPointToMercatorRay(X.sub(I)).dir);ue[0]=Fe[0]-Le[0],ue[1]=Fe[1]-Le[1]}else{const Le=T.pointCoordinate(X);if(T.projection.name==="globe"){I=I.rotate(-T.angle);const Fe=T._pixelsPerMercatorPixel/T.worldSize;ue[0]=-I.x*s.d3(s.ay(Le.y))*Fe,ue[1]=-I.y*s.d3(T.center.lat)*Fe}else{const Fe=T.pointCoordinate(X.sub(I));Le&&Fe&&(ue[0]=Fe.x-Le.x,ue[1]=Fe.y-Le.y)}}const pe=T.zoom,fe=[0,0,0];if(k){const Le=E(ee||T.pointCoordinate3D(X)),Fe={dir:s._.normalize([],s._.sub([],Le,T._camera.position))};if(Fe.dir[2]<0){const Be=T.zoomDeltaToMovement(Le,k);s._.scale(fe,Fe.dir,Be)}}const _e=s._.add(ue,ue,fe);T._translateCameraConstrained(_e),k&&Math.abs(T.zoom-pe)>1e-4&&T.recenterOnTerrain(),T.cameraElevationReference="ground",this._map._update(),r.noInertia||this._inertia.record(r),this._fireEvents(h,y,!0)}_fireEvents(r,h,y){const b=La(this._eventsInProgress),T=La(r),E={};for(const H in r){const{originalEvent:X}=r[H];this._eventsInProgress[H]||(E[`${H}start`]=X),this._eventsInProgress[H]=r[H]}!b&&T&&this._fireEvent("movestart",T.originalEvent);for(const H in E)this._fireEvent(H,E[H]);T&&this._fireEvent("move",T.originalEvent);for(const H in r){const{originalEvent:X}=r[H];this._fireEvent(H,X)}const I={};let k;for(const H in this._eventsInProgress){const{handlerName:X,originalEvent:ee}=this._eventsInProgress[H];this._handlersById[X].isActive()||(delete this._eventsInProgress[H],k=h[X]||ee,I[`${H}end`]=k)}for(const H in I)this._fireEvent(H,I[H]);const N=La(this._eventsInProgress);if(y&&(b||T)&&!N){this._updatingCamera=!0;const H=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),X=ee=>ee!==0&&-this._bearingSnap<ee&&ee<this._bearingSnap;H?(X(H.bearing||this._map.getBearing())&&(H.bearing=0),this._map.easeTo(H,{originalEvent:k})):(this._map.fire(new s.f("moveend",{originalEvent:k})),X(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(r,h){this._map.fire(new s.f(r,h?{originalEvent:h}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(r=>{this._frameId=void 0,this.handleEvent(new Gd("renderFrame",{timeStamp:r})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const id="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class to extends s.E{constructor(r,h){super(),this._moving=!1,this._zooming=!1,this.transform=r,this._bearingSnap=h.bearingSnap,this._respectPrefersReducedMotion=h.respectPrefersReducedMotion!==!1,s.bp(["_renderFrameCallback"],this)}getCenter(){return new s.aI(this.transform.center.lng,this.transform.center.lat)}setCenter(r,h){return this.jumpTo({center:r},h)}panBy(r,h,y){return r=s.P.convert(r).mult(-1),this.panTo(this.transform.center,s.W({offset:r},h),y)}panTo(r,h,y){return this.easeTo(s.W({center:r},h),y)}getZoom(){return this.transform.zoom}setZoom(r,h){return this.jumpTo({zoom:r},h),this}zoomTo(r,h,y){return this.easeTo(s.W({zoom:r},h),y)}zoomIn(r,h){return this.zoomTo(this.getZoom()+1,r,h),this}zoomOut(r,h){return this.zoomTo(this.getZoom()-1,r,h),this}getBearing(){return this.transform.bearing}setBearing(r,h){return this.jumpTo({bearing:r},h),this}getPadding(){return this.transform.padding}setPadding(r,h){return this.jumpTo({padding:r},h),this}rotateTo(r,h,y){return this.easeTo(s.W({bearing:r},h),y)}resetNorth(r,h){return this.rotateTo(0,s.W({duration:1e3},r),h),this}resetNorthPitch(r,h){return this.easeTo(s.W({bearing:0,pitch:0,duration:1e3},r),h),this}snapToNorth(r,h){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(r,h):this}getPitch(){return this.transform.pitch}setPitch(r,h){return this.jumpTo({pitch:r},h),this}cameraForBounds(r,h){r=s.ai.convert(r);const y=h&&h.bearing||0,b=h&&h.pitch||0,T=r.getNorthWest(),E=r.getSouthEast();return this._cameraForBounds(this.transform,T,E,y,b,h)}_extendPadding(r){const h={top:0,right:0,bottom:0,left:0};return r==null?s.W({},h,this.transform.padding):typeof r=="number"?{top:r,bottom:r,right:r,left:r}:s.W({},h,r)}_extendCameraOptions(r){return(r=s.W({offset:[0,0],maxZoom:this.transform.maxZoom},r)).padding=this._extendPadding(r.padding),r}_minimumAABBFrustumDistance(r,h){const y=h.max[0]-h.min[0],b=h.max[1]-h.min[1];return y/b>r.aspect?y/(2*Math.tan(.5*r.fovX)*r.aspect):b/(2*Math.tan(.5*r.fovY)*r.aspect)}_cameraForBoundsOnGlobe(r,h,y,b,T,E){const I=r.clone(),k=this._extendCameraOptions(E);I.bearing=b,I.pitch=T;const N=s.aI.convert(h),H=s.aI.convert(y),X=.5*(N.lat+H.lat),ee=.5*(N.lng+H.lng),ie=s.d4(X,ee),ue=s._.normalize([],ie),pe=s._.normalize([],s._.cross([],ue,[0,1,0])),fe=s._.cross([],pe,ue),_e=[pe[0],pe[1],pe[2],0,fe[0],fe[1],fe[2],0,ue[0],ue[1],ue[2],0,0,0,0,1],Le=[ie,s.d4(N.lat,N.lng),s.d4(H.lat,N.lng),s.d4(H.lat,H.lng),s.d4(N.lat,H.lng),s.d4(X,N.lng),s.d4(X,H.lng),s.d4(N.lat,ee),s.d4(H.lat,ee)];let Fe=s.b6.fromPoints(Le.map(ri=>[s._.dot(pe,ri),s._.dot(fe,ri),s._.dot(ue,ri)]));const Be=s._.transformMat4([],Fe.center,_e);s._.squaredLength(Be)===0&&s._.set(Be,0,0,1),s._.normalize(Be,Be),s._.scale(Be,Be,s.cD),I.center=s.d5(Be);const $e=I.getWorldToCameraMatrix(),Ze=s.ad.invert(new Float64Array(16),$e);Fe=s.b6.applyTransform(Fe,s.ad.multiply([],$e,_e));const rt=this._extendAABB(Fe,I,k,b);if(!rt)return void s.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");Fe=rt,s._.transformMat4(Be,Be,$e);const xe=.5*(Fe.max[2]-Fe.min[2]),Ne=this._minimumAABBFrustumDistance(I,Fe),ct=s._.scale([],[0,0,1],xe),Ot=s._.add(ct,Be,ct),mt=Ne+(I.pitch===0?0:s._.distance(Be,Ot)),it=I.globeCenterInViewSpace,Nt=s._.sub([],Be,[it[0],it[1],it[2]]);s._.normalize(Nt,Nt),s._.scale(Nt,Nt,mt);const mi=s._.add([],Be,Nt);s._.transformMat4(mi,mi,Ze);const _i=s.d7/s.cD,hi=s._.length(mi),vt=s.ax(Math.max(hi*_i-s.d7,Number.EPSILON),0),Gt=Math.min(I.zoomFromMercatorZAdjusted(vt),k.maxZoom);return Gt>.5*(s.b1+s.aU)?(I.setProjection({name:"mercator"}),I.zoom=Gt,this._cameraForBounds(I,h,y,b,T,E)):{center:I.center,zoom:Gt,bearing:b,pitch:T}}_extendAABB(r,h,y,b){const T=.5*((y.padding.left||0)+(y.padding.right||0)),E=.5*((y.padding.top||0)+(y.padding.bottom||0)),I=E,k=T,N=T,H=E,X=h.width-(k+N),ee=h.height-(I+H),ie=s._.sub([],r.max,r.min),ue=Math.min(X/ie[0],ee/ie[1]),pe=Math.min(h.scaleZoom(h.scale*ue),y.maxZoom);if(isNaN(pe))return null;const fe=h.scale/h.zoomScale(pe),_e=new s.b6([r.min[0]-k*fe,r.min[1]-H*fe,r.min[2]],[r.max[0]+N*fe,r.max[1]+I*fe,r.max[2]]),Le=(typeof y.offset.x=="number"&&typeof y.offset.y=="number"?new s.P(y.offset.x,y.offset.y):s.P.convert(y.offset)).rotate(-s.ab(b));return _e.center[0]-=Le.x*fe,_e.center[1]+=Le.y*fe,_e}queryTerrainElevation(r,h){const y=this.transform.elevation;return y?(h=s.W({},{exaggerated:!0},h),y.getAtPoint(s.Y.fromLngLat(r),null,h.exaggerated)):null}_cameraForBounds(r,h,y,b,T,E){if(r.projection.name==="globe")return this._cameraForBoundsOnGlobe(r,h,y,b,T,E);const I=r.clone(),k=this._extendCameraOptions(E);I.bearing=b,I.pitch=T;const N=s.aI.convert(h),H=s.aI.convert(y),X=new s.aI(N.lng,H.lat),ee=new s.aI(H.lng,N.lat),ie=I.project(N),ue=I.project(H),pe=this.queryTerrainElevation(N),fe=this.queryTerrainElevation(H),_e=this.queryTerrainElevation(X),Le=this.queryTerrainElevation(ee),Fe=[[ie.x,ie.y,Math.min(pe||0,fe||0,_e||0,Le||0)],[ue.x,ue.y,Math.max(pe||0,fe||0,_e||0,Le||0)]];let Be=s.b6.fromPoints(Fe);const $e=I.getWorldToCameraMatrix(),Ze=s.ad.invert(new Float64Array(16),$e);Be=s.b6.applyTransform(Be,$e);const rt=this._extendAABB(Be,I,k,b);if(!rt)return void s.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");Be=rt;const xe=.5*s._.sub([],Be.max,Be.min)[2],Ne=this._minimumAABBFrustumDistance(I,Be),ct=[0,0,1,0];s.aA.transformMat4(ct,ct,$e),s.aA.normalize(ct,ct);const Ot=s._.scale([],ct,Ne+xe),mt=s._.add([],Be.center,Ot);s._.transformMat4(Be.center,Be.center,Ze),s._.transformMat4(mt,mt,Ze);const it=[Be.center[0],Be.center[1],mt[2]*I.pixelsPerMeter];s._.scale(it,it,1/I.worldSize);const Nt=s.d6(it[0]),mi=s.ay(it[1]),_i=Math.min(I._zoomFromMercatorZ(it[2]),k.maxZoom),hi=new s.aI(Nt,mi);return I.mercatorFromTransition&&_i<.5*(s.b1+s.aU)?(I.setProjection({name:"globe"}),I.zoom=_i,this._cameraForBounds(I,h,y,b,T,E)):{center:hi,zoom:_i,bearing:b,pitch:T}}fitBounds(r,h,y){const b=this.cameraForBounds(r,h);return this._fitInternal(b,h,y)}fitScreenCoordinates(r,h,y,b,T){const E=s.P.convert(r),I=s.P.convert(h),k=new s.P(Math.min(E.x,I.x),Math.min(E.y,I.y)),N=new s.P(Math.max(E.x,I.x),Math.max(E.y,I.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(E,I))return this;const H=this.transform.pointLocation3D(k),X=this.transform.pointLocation3D(N),ee=this.transform.pointLocation3D(new s.P(k.x,N.y)),ie=this.transform.pointLocation3D(new s.P(N.x,k.y)),ue=[Math.min(H.lng,X.lng,ee.lng,ie.lng),Math.min(H.lat,X.lat,ee.lat,ie.lat)],pe=[Math.max(H.lng,X.lng,ee.lng,ie.lng),Math.max(H.lat,X.lat,ee.lat,ie.lat)],fe=b&&b.pitch?b.pitch:this.getPitch(),_e=this._cameraForBounds(this.transform,ue,pe,y,fe,b);return this._fitInternal(_e,b,T)}_fitInternal(r,h,y){return r?(h=s.W(r,h)).linear?this.easeTo(h,y):this.flyTo(h,y):this}jumpTo(r,h){this.stop();const y=r.preloadOnly?this.transform.clone():this.transform;let b=!1,T=!1,E=!1;if("zoom"in r&&y.zoom!==+r.zoom&&(b=!0,y.zoom=+r.zoom),r.center!==void 0&&(y.center=s.aI.convert(r.center)),"bearing"in r&&y.bearing!==+r.bearing&&(T=!0,y.bearing=+r.bearing),"pitch"in r&&y.pitch!==+r.pitch&&(E=!0,y.pitch=+r.pitch),r.padding!=null){const I=typeof r.padding=="number"?this._extendPadding(r.padding):r.padding;y.isPaddingEqual(I)||(y.padding=I)}return r.preloadOnly?(this._preloadTiles(y),this):(this.fire(new s.f("movestart",h)).fire(new s.f("move",h)),b&&this.fire(new s.f("zoomstart",h)).fire(new s.f("zoom",h)).fire(new s.f("zoomend",h)),T&&this.fire(new s.f("rotatestart",h)).fire(new s.f("rotate",h)).fire(new s.f("rotateend",h)),E&&this.fire(new s.f("pitchstart",h)).fire(new s.f("pitch",h)).fire(new s.f("pitchend",h)),this.fire(new s.f("moveend",h)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||s.w(id),this.transform.getFreeCameraOptions()}setFreeCameraOptions(r,h){const y=this.transform;if(!y.projection.supportsFreeCamera)return s.w(id),this;this.stop();const b=y.zoom,T=y.pitch,E=y.bearing;y.setFreeCameraOptions(r);const I=b!==y.zoom,k=T!==y.pitch,N=E!==y.bearing;return this.fire(new s.f("movestart",h)).fire(new s.f("move",h)),I&&this.fire(new s.f("zoomstart",h)).fire(new s.f("zoom",h)).fire(new s.f("zoomend",h)),N&&this.fire(new s.f("rotatestart",h)).fire(new s.f("rotate",h)).fire(new s.f("rotateend",h)),k&&this.fire(new s.f("pitchstart",h)).fire(new s.f("pitch",h)).fire(new s.f("pitchend",h)),this.fire(new s.f("moveend",h)),this}easeTo(r,h){this._stop(!1,r.easeId),((r=s.W({offset:[0,0],duration:500,easing:s.d2},r)).animate===!1||this._prefersReducedMotion(r))&&(r.duration=0);const y=this.transform,b=this.getZoom(),T=this.getBearing(),E=this.getPitch(),I=this.getPadding(),k="zoom"in r?+r.zoom:b,N="bearing"in r?this._normalizeBearing(r.bearing,T):T,H="pitch"in r?+r.pitch:E,X=this._extendPadding(r.padding),ee=s.P.convert(r.offset);let ie,ue,pe;if(y.projection.name==="globe"){const Ne=s.Y.fromLngLat(y.center),ct=ee.rotate(-y.angle);Ne.x+=ct.x/y.worldSize,Ne.y+=ct.y/y.worldSize;const Ot=Ne.toLngLat(),mt=s.aI.convert(r.center||Ot);this._normalizeCenter(mt),ie=y.centerPoint.add(ct),ue=new s.P(Ne.x,Ne.y).mult(y.worldSize),pe=new s.P(s.aj(mt.lng),s.ak(mt.lat)).mult(y.worldSize).sub(ue)}else{ie=y.centerPoint.add(ee);const Ne=y.pointLocation(ie),ct=s.aI.convert(r.center||Ne);this._normalizeCenter(ct),ue=y.project(Ne),pe=y.project(ct).sub(ue)}const fe=y.zoomScale(k-b);let _e,Le;r.around&&(_e=s.aI.convert(r.around),Le=y.locationPoint(_e));const Fe=this._zooming||k!==b,Be=this._rotating||T!==N,$e=this._pitching||H!==E,Ze=!y.isPaddingEqual(X),rt=Ne=>ct=>{if(Fe&&(Ne.zoom=s.a2(b,k,ct)),Be&&(Ne.bearing=s.a2(T,N,ct)),$e&&(Ne.pitch=s.a2(E,H,ct)),Ze&&(Ne.interpolatePadding(I,X,ct),ie=Ne.centerPoint.add(ee)),_e)Ne.setLocationAtPoint(_e,Le);else{const Ot=Ne.zoomScale(Ne.zoom-b),mt=k>b?Math.min(2,fe):Math.max(.5,fe),it=Math.pow(mt,1-ct),Nt=Ne.unproject(ue.add(pe.mult(ct*it)).mult(Ot));Ne.setLocationAtPoint(Ne.renderWorldCopies?Nt.wrap():Nt,ie)}return r.preloadOnly||this._fireMoveEvents(h),Ne};if(r.preloadOnly){const Ne=this._emulate(rt,r.duration,y);return this._preloadTiles(Ne),this}const xe={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=Fe,this._rotating=Be,this._pitching=$e,this._padding=Ze,this._easeId=r.easeId,this._prepareEase(h,r.noMoveStart,xe),this._ease(rt(y),Ne=>{y.cameraElevationReference==="sea"&&y.recenterOnTerrain(),this._afterEase(h,Ne)},r),this}_prepareEase(r,h,y={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),h||y.moving||this.fire(new s.f("movestart",r)),this._zooming&&!y.zooming&&this.fire(new s.f("zoomstart",r)),this._rotating&&!y.rotating&&this.fire(new s.f("rotatestart",r)),this._pitching&&!y.pitching&&this.fire(new s.f("pitchstart",r))}_fireMoveEvents(r){this.fire(new s.f("move",r)),this._zooming&&this.fire(new s.f("zoom",r)),this._rotating&&this.fire(new s.f("rotate",r)),this._pitching&&this.fire(new s.f("pitch",r))}_afterEase(r,h){if(this._easeId&&h&&this._easeId===h)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const y=this._zooming,b=this._rotating,T=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,y&&this.fire(new s.f("zoomend",r)),b&&this.fire(new s.f("rotateend",r)),T&&this.fire(new s.f("pitchend",r)),this.fire(new s.f("moveend",r))}flyTo(r,h){if(this._prefersReducedMotion(r)){const Gt=s.ah(r,["center","zoom","bearing","pitch","around","padding"]);return this.jumpTo(Gt,h)}this.stop(),r=s.W({offset:[0,0],speed:1.2,curve:1.42,easing:s.d2},r);const y=this.transform,b=this.getZoom(),T=this.getBearing(),E=this.getPitch(),I=this.getPadding(),k="zoom"in r?s.at(+r.zoom,y.minZoom,y.maxZoom):b,N="bearing"in r?this._normalizeBearing(r.bearing,T):T,H="pitch"in r?+r.pitch:E,X=this._extendPadding(r.padding),ee=y.zoomScale(k-b),ie=s.P.convert(r.offset);let ue=y.centerPoint.add(ie);const pe=y.pointLocation(ue),fe=s.aI.convert(r.center||pe);this._normalizeCenter(fe);const _e=y.project(pe),Le=y.project(fe).sub(_e);let Fe=r.curve;const Be=Math.max(y.width,y.height),$e=Be/ee,Ze=Le.mag();if("minZoom"in r){const Gt=s.at(Math.min(r.minZoom,b,k),y.minZoom,y.maxZoom),ri=Be/y.zoomScale(Gt-b);Fe=Math.sqrt(ri/Ze*2)}const rt=Fe*Fe;function xe(Gt){const ri=($e*$e-Be*Be+(Gt?-1:1)*rt*rt*Ze*Ze)/(2*(Gt?$e:Be)*rt*Ze);return Math.log(Math.sqrt(ri*ri+1)-ri)}function Ne(Gt){return(Math.exp(Gt)-Math.exp(-Gt))/2}function ct(Gt){return(Math.exp(Gt)+Math.exp(-Gt))/2}const Ot=xe(0);let mt=function(Gt){return ct(Ot)/ct(Ot+Fe*Gt)},it=function(Gt){return Be*((ct(Ot)*(Ne(ri=Ot+Fe*Gt)/ct(ri))-Ne(Ot))/rt)/Ze;var ri},Nt=(xe(1)-Ot)/Fe;if(Math.abs(Ze)<1e-6||!isFinite(Nt)){if(Math.abs(Be-$e)<1e-6)return this.easeTo(r,h);const Gt=$e<Be?-1:1;Nt=Math.abs(Math.log($e/Be))/Fe,it=function(){return 0},mt=function(ri){return Math.exp(Gt*Fe*ri)}}r.duration="duration"in r?+r.duration:1e3*Nt/("screenSpeed"in r?+r.screenSpeed/Fe:+r.speed),r.maxDuration&&r.duration>r.maxDuration&&(r.duration=0);const mi=T!==N,_i=H!==E,hi=!y.isPaddingEqual(X),vt=Gt=>ri=>{const $i=ri*Nt,Yi=1/mt($i);Gt.zoom=ri===1?k:b+Gt.scaleZoom(Yi),mi&&(Gt.bearing=s.a2(T,N,ri)),_i&&(Gt.pitch=s.a2(E,H,ri)),hi&&(Gt.interpolatePadding(I,X,ri),ue=Gt.centerPoint.add(ie));const hn=ri===1?fe:Gt.unproject(_e.add(Le.mult(it($i))).mult(Yi));return Gt.setLocationAtPoint(Gt.renderWorldCopies?hn.wrap():hn,ue),Gt._updateCameraOnTerrain(),r.preloadOnly||this._fireMoveEvents(h),Gt};if(r.preloadOnly){const Gt=this._emulate(vt,r.duration,y);return this._preloadTiles(Gt),this}return this._zooming=!0,this._rotating=mi,this._pitching=_i,this._padding=hi,this._prepareEase(h,!1),this._ease(vt(y),()=>this._afterEase(h),r),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(r){}_cancelRenderFrame(r){}_stop(r,h){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const y=this._onEaseEnd;this._onEaseEnd=void 0,y.call(this,h)}if(!r){const y=this.handlers;y&&y.stop(!1)}return this}_ease(r,h,y){y.animate===!1||y.duration===0?(r(1),h()):(this._easeStart=s.e.now(),this._easeOptions=y,this._onEaseFrame=r,this._onEaseEnd=h,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const r=Math.min((s.e.now()-this._easeStart)/this._easeOptions.duration,1),h=this._onEaseFrame;h&&h(this._easeOptions.easing(r)),r<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(r,h){r=s.au(r,-180,180);const y=Math.abs(r-h);return Math.abs(r-360-h)<y&&(r-=360),Math.abs(r+360-h)<y&&(r+=360),r}_normalizeCenter(r){const h=this.transform;if(h.maxBounds||h.projection.name!=="globe"&&!h.renderWorldCopies)return;const y=r.lng-h.center.lng;r.lng+=y>180?-360:y<-180?360:0}_prefersReducedMotion(r){return this._respectPrefersReducedMotion&&s.e.prefersReducedMotion&&!(r&&r.essential)}_emulate(r,h,y){const b=Math.ceil(15*h/1e3),T=[],E=r(y.clone());for(let I=0;I<=b;I++){const k=E(I/b);T.push(k.clone())}return T}_preloadTiles(r,h){}}class Wp{constructor(r={}){this.options=r,s.bp(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(r){const h=this.options&&this.options.compact;return this._map=r,this._container=ve("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=ve("button","mapboxgl-ctrl-attrib-button",this._container),ve("span","mapboxgl-ctrl-icon",this._compactButton).setAttribute("aria-hidden","true"),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=ve("div","mapboxgl-ctrl-attrib-inner",this._container),h&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),h===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_setElementTitle(r,h){const y=this._map._getUIString(`AttributionControl.${h}`);r.removeAttribute("title"),r.firstElementChild&&r.firstElementChild.setAttribute("title",y)}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let r=this._editLink;r||(r=this._editLink=this._container.querySelector(".mapbox-improve-map"));const h=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||s.d8.ACCESS_TOKEN}];if(r){const y=h.reduce((b,T,E)=>(T.value&&(b+=`${T.key}=${T.value}${E<h.length-1?"&":""}`),b),"?");r.href=`${s.d8.FEEDBACK_URL}/${y}#${Np(this._map,!0)}`,r.rel="noopener nofollow",this._setElementTitle(r,"MapFeedback")}}_updateData(r){!r||r.sourceDataType!=="metadata"&&r.sourceDataType!=="visibility"&&r.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let r=[];if(this._map.style.stylesheet){const b=this._map.style.stylesheet;this.styleOwner=b.owner,this.styleId=b.id}const h=this._map.style._mergedSourceCaches;for(const b in h){const T=h[b];if(T.used){const E=T.getSource();E.attribution&&r.indexOf(E.attribution)<0&&r.push(E.attribution)}}r.sort((b,T)=>b.length-T.length),r=r.filter((b,T)=>{for(let E=T+1;E<r.length;E++)if(r[E].indexOf(b)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?r=[...this.options.customAttribution,...r]:r.unshift(this.options.customAttribution));const y=r.join(" | ");y!==this._attribHTML&&(this._attribHTML=y,r.length?(this._innerContainer.innerHTML=y,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class qp{constructor(){s.bp(["_updateLogo","_updateCompact"],this)}onAdd(r){this._map=r,this._container=ve("div","mapboxgl-ctrl");const h=ve("a","mapboxgl-ctrl-logo");return h.target="_blank",h.rel="noopener nofollow",h.href="https://www.mapbox.com/",h.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),h.setAttribute("rel","noopener nofollow"),this._container.appendChild(h),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(r){r&&r.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const r=this._map.style._sourceCaches;if(Object.entries(r).length===0)return!0;for(const h in r){const y=r[h].getSource();if(y.hasOwnProperty("mapbox_logo")&&!y.mapbox_logo)return!1}return!0}_updateCompact(){const r=this._container.children;if(r.length){const h=r[0];this._map.getCanvasContainer().offsetWidth<250?h.classList.add("mapboxgl-compact"):h.classList.remove("mapboxgl-compact")}}}class Zp{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(r){const h=++this._id;return this._queue.push({callback:r,id:h,cancelled:!1}),h}remove(r){const h=this._currentlyRunning,y=h?this._queue.concat(h):this._queue;for(const b of y)if(b.id===r)return void(b.cancelled=!0)}run(r=0){const h=this._currentlyRunning=this._queue;this._queue=[];for(const y of h)if(!y.cancelled&&(y.callback(r),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}function jd(m,r,h){if(m=new s.aI(m.lng,m.lat),r){const y=new s.aI(m.lng-360,m.lat),b=new s.aI(m.lng+360,m.lat),T=360*Math.ceil(Math.abs(m.lng-h.center.lng)/360),E=h.locationPoint(m).distSqr(r),I=r.x<0||r.y<0||r.x>h.width||r.y>h.height;h.locationPoint(y).distSqr(r)<E&&(I||Math.abs(y.lng-h.center.lng)<T)?m=y:h.locationPoint(b).distSqr(r)<E&&(I||Math.abs(b.lng-h.center.lng)<T)&&(m=b)}for(;Math.abs(m.lng-h.center.lng)>180;){const y=h.locationPoint(m);if(y.x>=0&&y.y>=0&&y.x<=h.width&&y.y<=h.height)break;m.lng>h.center.lng?m.lng-=360:m.lng+=360}return m}const su={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class ul extends s.E{constructor(r,h){if(super(),(r instanceof HTMLElement||h)&&(r=s.W({element:r},h)),s.bp(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=r&&r.anchor||"center",this._color=r&&r.color||"#3FB1CE",this._scale=r&&r.scale||1,this._draggable=r&&r.draggable||!1,this._clickTolerance=r&&r.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=r&&r.rotation||0,this._rotationAlignment=r&&r.rotationAlignment||"auto",this._pitchAlignment=r&&r.pitchAlignment&&r.pitchAlignment||"auto",this._updateMoving=()=>this._update(!0),this._occludedOpacity=r&&r.occludedOpacity||.2,r&&r.element)this._element=r.element,this._offset=s.P.convert(r&&r.offset||[0,0]);else{this._defaultMarker=!0,this._element=ve("div");const T=41,E=27,I=Ee("svg",{display:"block",height:T*this._scale+"px",width:E*this._scale+"px",viewBox:`0 0 ${E} ${T}`},this._element),k=Ee("radialGradient",{id:"shadowGradient"},Ee("defs",{},I));Ee("stop",{offset:"10%","stop-opacity":.4},k),Ee("stop",{offset:"100%","stop-opacity":.05},k),Ee("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},I),Ee("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},I),Ee("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},I),Ee("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},I),this._offset=s.P.convert(r&&r.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",T=>{T.preventDefault()}),this._element.addEventListener("mousedown",T=>{T.preventDefault()});const y=this._element.classList;for(const T in su)y.remove(`mapboxgl-marker-anchor-${T}`);y.add(`mapboxgl-marker-anchor-${this._anchor}`);const b=r&&r.className?r.className.trim().split(/\s+/):[];y.add(...b),this._popup=null}addTo(r){return r===this._map||(this.remove(),this._map=r,r.getCanvasContainer().appendChild(this._element),r.on("move",this._updateMoving),r.on("moveend",this._update),r.on("remove",this._clearFadeTimer),r._addMarker(this),this.setDraggable(this._draggable),this._update(),r.on("click",this._onMapClick)),this}remove(){const r=this._map;return r&&(r.off("click",this._onMapClick),r.off("move",this._updateMoving),r.off("moveend",this._update),r.off("mousedown",this._addDragHandler),r.off("touchstart",this._addDragHandler),r.off("mouseup",this._onUp),r.off("touchend",this._onUp),r.off("mousemove",this._onMove),r.off("touchmove",this._onMove),r.off("remove",this._clearFadeTimer),r._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(r){return this._lngLat=s.aI.convert(r),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(r){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),r){if(!("offset"in r.options)){const b=Math.sqrt(Math.pow(13.5,2)/2);r.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[b,-1*(38.1-13.5+b)],"bottom-right":[-b,-1*(38.1-13.5+b)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=r,r._marker=this,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(r){const h=r.code,y=r.charCode||r.keyCode;h!=="Space"&&h!=="Enter"&&y!==32&&y!==13||this.togglePopup()}_onMapClick(r){const h=r.originalEvent.target,y=this._element;this._popup&&(h===y||y.contains(h))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const r=this._popup;return r?(r.isOpen()?(r.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(r.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const r=this._map,h=this._pos;if(!r||!h)return!1;const y=r.unproject(h),b=r.getFreeCameraOptions();if(!b.position)return!1;const T=b.position.toLngLat();return T.distanceTo(y)<.9*T.distanceTo(this._lngLat)}_evaluateOpacity(){const r=this._map;if(!r)return;const h=this._pos;if(!h||h.x<0||h.x>r.transform.width||h.y<0||h.y>r.transform.height)return void this._clearFadeTimer();const y=r.unproject(h);let b;r._showingGlobe()&&s.d9(r.transform,this._lngLat)?b=0:(b=1-r._queryFogOpacity(y),r.transform._terrainEnabled()&&r.getTerrain()&&this._behindTerrain()&&(b*=this._occludedOpacity)),this._element.style.opacity=`${b}`,this._element.style.pointerEvents=b>0?"auto":"none",this._popup&&this._popup._setOpacity(b),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const r=this._pos;if(!r||!this._map)return;const h=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${r.x}px,${r.y}px)
            ${su[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${h.x}px,${h.y}px)
        `}_calculateXYTransform(){const r=this._pos,h=this._map,y=this.getPitchAlignment();if(!h||!r||y!=="map")return"";if(!h._showingGlobe()){const k=h.getPitch();return k?`rotateX(${k}deg)`:""}const b=s.b0(s.da(h.transform,this._lngLat)),T=r.sub(s.db(h.transform)),E=Math.abs(T.x)+Math.abs(T.y);if(E===0)return"";const I=b/E;return`rotateX(${-T.y*I}deg) rotateY(${T.x*I}deg)`}_calculateZTransform(){const r=this._pos,h=this._map;if(!h||!r)return"";let y=0;const b=this.getRotationAlignment();if(b==="map")if(h._showingGlobe()){const T=h.project(new s.aI(this._lngLat.lng,this._lngLat.lat+.001)),E=h.project(new s.aI(this._lngLat.lng,this._lngLat.lat-.001)).sub(T);y=s.b0(Math.atan2(E.y,E.x))-90}else y=-h.getBearing();else if(b==="horizon"){const T=s.$(4,6,h.getZoom()),E=s.db(h.transform);E.y+=T*h.transform.height;const I=r.sub(E),k=s.b0(Math.atan2(I.y,I.x));y=(k>90?k-270:k+90)*(1-T)}return y+=this._rotation,y?`rotateZ(${y}deg)`:""}_update(r){cancelAnimationFrame(this._updateFrameId);const h=this._map;h&&(h.transform.renderWorldCopies&&(this._lngLat=jd(this._lngLat,this._pos,h.transform)),this._pos=h.project(this._lngLat),r===!0?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),h._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(h._showingGlobe()||h.getTerrain()||h.getFog())&&!this._fadeTimer&&(this._fadeTimer=setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(r){return this._offset=s.P.convert(r),this._update(),this}addClassName(r){return this._element.classList.add(r),this}removeClassName(r){return this._element.classList.remove(r),this}toggleClassName(r){return this._element.classList.toggle(r)}_onMove(r){const h=this._map;if(!h)return;const y=this._pointerdownPos,b=this._positionDelta;if(y&&b){if(!this._isDragging){const T=this._clickTolerance||h._clickTolerance;if(r.point.dist(y)<T)return;this._isDragging=!0}this._pos=r.point.sub(b),this._lngLat=h.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new s.f("dragstart"))),this.fire(new s.f("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const r=this._map;r&&(r.off("mousemove",this._onMove),r.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new s.f("dragend")),this._state="inactive"}_addDragHandler(r){const h=this._map,y=this._pos;h&&y&&this._element.contains(r.originalEvent.target)&&(r.preventDefault(),this._positionDelta=r.point.sub(y),this._pointerdownPos=r.point,this._state="pending",h.on("mousemove",this._onMove),h.on("touchmove",this._onMove),h.once("mouseup",this._onUp),h.once("touchend",this._onUp))}setDraggable(r){this._draggable=!!r;const h=this._map;return h&&(r?(h.on("mousedown",this._addDragHandler),h.on("touchstart",this._addDragHandler)):(h.off("mousedown",this._addDragHandler),h.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(r){return this._rotation=r||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(r){return this._rotationAlignment=r||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(r){return this._pitchAlignment=r||"auto",this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(r){return this._occludedOpacity=r||.2,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const Wd={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},qd=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function $o(m=new s.P(0,0),r="bottom"){if(typeof m=="number"){const h=Math.round(Math.sqrt(.5*Math.pow(m,2)));switch(r){case"top":return new s.P(0,m);case"top-left":return new s.P(h,h);case"top-right":return new s.P(-h,h);case"bottom":return new s.P(0,-m);case"bottom-left":return new s.P(h,-h);case"bottom-right":return new s.P(-h,-h);case"left":return new s.P(m,0);case"right":return new s.P(-m,0)}return new s.P(0,0)}return m instanceof s.P||Array.isArray(m)?s.P.convert(m):s.P.convert(m[r]||[0,0])}class zc{constructor(r){this.jumpTo(r)}getValue(r){if(r<=this._startTime)return this._start;if(r>=this._endTime)return this._end;const h=s.b9((r-this._startTime)/(this._endTime-this._startTime));return this._start*(1-h)+this._end*h}isEasing(r){return r>=this._startTime&&r<=this._endTime}jumpTo(r){this._startTime=-1/0,this._endTime=-1/0,this._start=r,this._end=r}easeTo(r,h,y){this._start=this.getValue(h),this._end=r,this._startTime=h,this._endTime=h+y}}const Oc={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use  + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class Xp{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}const Zd={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1},ou={showCompass:!0,showZoom:!0,visualizePitch:!1};class Ol{constructor(r,h,y=!1){this._clickTolerance=10,this.element=h,this.mouseRotate=new Nd({clickTolerance:r.dragRotate._mouseRotate._clickTolerance}),this.map=r,y&&(this.mousePitch=new eu({clickTolerance:r.dragRotate._mousePitch._clickTolerance})),s.bp(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),h.addEventListener("mousedown",this.mousedown),h.addEventListener("touchstart",this.touchstart,{passive:!1}),h.addEventListener("touchmove",this.touchmove),h.addEventListener("touchend",this.touchend),h.addEventListener("touchcancel",this.reset)}down(r,h){this.mouseRotate.mousedown(r,h),this.mousePitch&&this.mousePitch.mousedown(r,h),Mt()}move(r,h){const y=this.map,b=this.mouseRotate.mousemoveWindow(r,h),T=b&&b.bearingDelta;if(T&&y.setBearing(y.getBearing()+T),this.mousePitch){const E=this.mousePitch.mousemoveWindow(r,h),I=E&&E.pitchDelta;I&&y.setPitch(y.getPitch()+I)}}off(){const r=this.element;r.removeEventListener("mousedown",this.mousedown),r.removeEventListener("touchstart",this.touchstart,{passive:!1}),r.removeEventListener("touchmove",this.touchmove),r.removeEventListener("touchend",this.touchend),r.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){Lt(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(r){this.down(s.W({},r,{ctrlKey:!0,preventDefault:()=>r.preventDefault()}),lt(this.element,r)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(r){this.move(r,lt(this.element,r))}mouseup(r){this.mouseRotate.mouseupWindow(r),this.mousePitch&&this.mousePitch.mouseupWindow(r),this.offTemp()}touchstart(r){r.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=Ct(this.element,r.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>r.preventDefault()},this._startPos))}touchmove(r){r.targetTouches.length!==1?this.reset():(this._lastPos=Ct(this.element,r.targetTouches)[0],this.move({preventDefault:()=>r.preventDefault()},this._lastPos))}touchend(r){r.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}const au={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},Fc={maxWidth:100,unit:"metric"},$p={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"};return{version:s.dt,supported:j,setRTLTextPlugin:s.dv,getRTLTextPluginStatus:s.dw,Map:class extends to{constructor(m){s.dc.mark(s.dd.create);const r=m;if((m=s.W({},Zd,m)).minZoom!=null&&m.maxZoom!=null&&m.minZoom>m.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(m.minPitch!=null&&m.maxPitch!=null&&m.minPitch>m.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(m.minPitch!=null&&m.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(m.maxPitch!=null&&m.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(m.antialias&&s.de(window)&&(m.antialias=!1,s.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Is(m.minZoom,m.maxZoom,m.minPitch,m.maxPitch,m.renderWorldCopies),m),this._repaint=!!m.repaint,this._interactive=m.interactive,this._minTileCacheSize=m.minTileCacheSize,this._maxTileCacheSize=m.maxTileCacheSize,this._failIfMajorPerformanceCaveat=m.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=m.preserveDrawingBuffer,this._antialias=m.antialias,this._trackResize=m.trackResize,this._bearingSnap=m.bearingSnap,this._refreshExpiredTiles=m.refreshExpiredTiles,this._fadeDuration=m.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=m.crossSourceCollisions,this._collectResourceTiming=m.collectResourceTiming,this._language=this._parseLanguage(m.language),this._worldview=m.worldview,this._renderTaskQueue=new Zp,this._domRenderTaskQueue=new Zp,this._controls=[],this._markers=[],this._popups=[],this._mapId=s.df(),this._locale=s.W({},Oc,m.locale),this._clickTolerance=m.clickTolerance,this._cooperativeGestures=m.cooperativeGestures,this._performanceMetricsCollection=m.performanceMetricsCollection,this._tessellationStep=m.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new zc(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._lastDirtyFrameId=0,this._requestManager=new s.dg(m.transformRequest,m.accessToken,m.testMode),this._silenceAuthErrors=!!m.testMode,this._contextCreateOptions=m.contextCreateOptions?{...m.contextCreateOptions}:{},typeof m.container=="string"){const h=document.getElementById(m.container);if(!h)throw new Error(`Container '${m.container.toString()}' not found.`);this._container=h}else{if(!(m.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=m.container}if(this._container.childNodes.length>0&&s.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),m.maxBounds&&this.setMaxBounds(m.maxBounds),s.bp(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new Xp),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},()=>{this._update()}),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new ru(this,m),this._localFontFamily=m.localFontFamily,this._localIdeographFontFamily=m.localIdeographFontFamily,(m.style||!m.testMode)&&this.setStyle(m.style||s.d8.DEFAULT_STYLE,{config:m.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),m.projection&&this.setProjection(m.projection),m.hash&&(this._hash=new rm(typeof m.hash=="string"&&m.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){r.center==null&&r.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:m.center,zoom:m.zoom,bearing:m.bearing,pitch:m.pitch});const h=m.bounds;h&&(this.resize(),this.fitBounds(h,s.W({},m.fitBoundsOptions,{duration:0})))}this.resize(),m.attributionControl&&this.addControl(new Wp({customAttribution:m.customAttribution})),this._logoControl=new qp,this.addControl(this._logoControl,m.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()}),this.on("data",h=>{this._update(h.dataType==="style"),this.fire(new s.f(`${h.dataType}data`,h))}),this.on("dataloading",h=>{this.fire(new s.f(`${h.dataType}dataloading`,h))})}_getMapId(){return this._mapId}addControl(m,r){if(r===void 0&&(r=m.getDefaultPosition?m.getDefaultPosition():"top-right"),!m||!m.onAdd)return this.fire(new s.d(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const h=m.onAdd(this);this._controls.push(m);const y=this._controlPositions[r];return r.indexOf("bottom")!==-1?y.insertBefore(h,y.firstChild):y.appendChild(h),this}removeControl(m){if(!m||!m.onRemove)return this.fire(new s.d(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const r=this._controls.indexOf(m);return r>-1&&this._controls.splice(r,1),m.onRemove(this),this}hasControl(m){return this._controls.indexOf(m)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(m){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const r=!this._moving;return r&&this.fire(new s.f("movestart",m)).fire(new s.f("move",m)),this.fire(new s.f("resize",m)),r&&this.fire(new s.f("moveend",m)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(m){return this.transform.setMaxBounds(s.ai.convert(m)),this._update()}setMinZoom(m){if((m=m??-2)>=-2&&m<=this.transform.maxZoom)return this.transform.minZoom=m,this._update(),this.getZoom()<m?this.setZoom(m):this.fire(new s.f("zoomstart")).fire(new s.f("zoom")).fire(new s.f("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(m){if((m=m??22)>=this.transform.minZoom)return this.transform.maxZoom=m,this._update(),this.getZoom()>m?this.setZoom(m):this.fire(new s.f("zoomstart")).fire(new s.f("zoom")).fire(new s.f("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(m){if((m=m??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(m>=0&&m<=this.transform.maxPitch)return this.transform.minPitch=m,this._update(),this.getPitch()<m?this.setPitch(m):this.fire(new s.f("pitchstart")).fire(new s.f("pitch")).fire(new s.f("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(m){if((m=m??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(m>=this.transform.minPitch)return this.transform.maxPitch=m,this._update(),this.getPitch()>m?this.setPitch(m):this.fire(new s.f("pitchstart")).fire(new s.f("pitch")).fire(new s.f("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(m){return this.transform.renderWorldCopies=m,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(m){return m==="auto"?navigator.language:Array.isArray(m)?m.length===0?void 0:m.map(r=>r==="auto"?navigator.language:r):m}setLanguage(m){const r=this._parseLanguage(m);if(!this.style||r===this._language)return this;this._language=r,this.style.reloadSources();for(const h of this._controls)h._setLanguage&&h._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(m){return this.style&&m!==this._worldview?(this._worldview=m,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(m){return this._lazyInitEmptyStyle(),m?typeof m=="string"&&(m={name:m}):m=null,this._useExplicitProjection=!!m,this._prioritizeAndUpdateProjection(m,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;const m=this.transform,r=m.projection.name;let h;r==="globe"&&m.zoom>=s.aU?(m.setMercatorFromTransition(),h=!0):r==="mercator"&&m.zoom<s.aU&&(m.setProjection({name:"globe"}),h=!0),h&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(m,r){return this._updateProjection(m||r||{name:"mercator"})}_updateProjection(m){let r;return r=m.name==="globe"&&this.transform.zoom>=s.aU?this.transform.setMercatorFromTransition():this.transform.setProjection(m),this.style.applyProjectionUpdate(),r&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(m){return this.transform.locationPoint3D(s.aI.convert(m))}unproject(m){return this.transform.pointLocation3D(s.P.convert(m))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(m,r,h){if(m==="mouseenter"||m==="mouseover"){let y=!1;const b=E=>{const I=r.filter(N=>this.getLayer(N)),k=I.length?this.queryRenderedFeatures(E.point,{layers:I}):[];k.length?y||(y=!0,h.call(this,new Oo(m,this,E.originalEvent,{features:k}))):y=!1},T=()=>{y=!1};return{layers:new Set(r),listener:h,delegates:{mousemove:b,mouseout:T}}}if(m==="mouseleave"||m==="mouseout"){let y=!1;const b=E=>{const I=r.filter(k=>this.getLayer(k));(I.length?this.queryRenderedFeatures(E.point,{layers:I}):[]).length?y=!0:y&&(y=!1,h.call(this,new Oo(m,this,E.originalEvent)))},T=E=>{y&&(y=!1,h.call(this,new Oo(m,this,E.originalEvent)))};return{layers:new Set(r),listener:h,delegates:{mousemove:b,mouseout:T}}}{const y=b=>{const T=r.filter(I=>this.getLayer(I)),E=T.length?this.queryRenderedFeatures(b.point,{layers:T}):[];E.length&&(b.features=E,h.call(this,b),delete b.features)};return{layers:new Set(r),listener:h,delegates:{[m]:y}}}}on(m,r,h){if(typeof r=="function"||h===void 0)return super.on(m,r);if(Array.isArray(r)||(r=[r]),r){for(const b of r)if(!this._isValidId(b))return this}const y=this._createDelegatedListener(m,r,h);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[m]=this._delegatedListeners[m]||[],this._delegatedListeners[m].push(y);for(const b in y.delegates)this.on(b,y.delegates[b]);return this}once(m,r,h){if(typeof r=="function"||h===void 0)return super.once(m,r);if(Array.isArray(r)||(r=[r]),r){for(const b of r)if(!this._isValidId(b))return this}const y=this._createDelegatedListener(m,r,h);for(const b in y.delegates)this.once(b,y.delegates[b]);return this}off(m,r,h){if(typeof r=="function"||h===void 0)return super.off(m,r);const y=new Set(Array.isArray(r)?r:[r]);for(const E of y)if(!this._isValidId(E))return this;const b=(E,I)=>{if(E.size!==I.size)return!1;for(const k of E)if(!I.has(k))return!1;return!0},T=this._delegatedListeners?this._delegatedListeners[m]:void 0;return T&&(E=>{for(let I=0;I<E.length;I++){const k=E[I];if(k.listener===h&&b(k.layers,y)){for(const N in k.delegates)this.off(N,k.delegates[N]);return E.splice(I,1),this}}})(T),this}queryRenderedFeatures(m,r){if(!this.style)return[];if(r!==void 0||m===void 0||m instanceof s.P||Array.isArray(m)||(r=m,m=void 0),m=m||[[0,0],[this.transform.width,this.transform.height]],(r=r||{}).layers&&Array.isArray(r.layers)){for(const h of r.layers)if(!this._isValidId(h))return[]}return this.style.queryRenderedFeatures(m,r,this.transform)}querySourceFeatures(m,r){return this._isValidId(m)?this.style.querySourceFeatures(m,r):[]}isPointOnSurface(m){const{name:r}=this.transform.projection;return r!=="globe"&&r!=="mercator"&&s.w(`${r} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(s.P.convert(m))}setStyle(m,r){return r=s.W({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},r),this.style&&m&&r.diff!==!1&&r.localFontFamily===this._localFontFamily&&r.localIdeographFontFamily===this._localIdeographFontFamily&&!r.config?(this.style._diffStyle(m,(h,y)=>{h?(s.w(`Unable to perform style diff: ${String(h.message||h.error||h)}. Rebuilding the style from scratch.`),this._updateStyle(m,r)):y&&this._update(!0)},()=>{this._postStyleLoadEvent()}),this):(this._localIdeographFontFamily=r.localIdeographFontFamily,this._localFontFamily=r.localFontFamily,this._updateStyle(m,r))}_getUIString(m){const r=this._locale[m];if(r==null)throw new Error(`Missing UI string '${m}'`);return r}_updateStyle(m,r){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),m){const h=s.W({},r);r&&r.config&&(h.initialConfig=r.config,delete h.config),this.style=new Ha(this,h).load(m),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Ha(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(s.w("There is no style added to the map."),!1)}_isValidId(m){return m==null?(this.fire(new s.d(new Error("IDs can't be empty."))),!1):!s.cV(m)||(this.fire(new s.d(new Error(`IDs can't contain special symbols: "${m}".`))),!1)}addSource(m,r){return this._isValidId(m)?(this._lazyInitEmptyStyle(),this.style.addSource(m,r),this._update(!0)):this}isSourceLoaded(m){return!!this._isValidId(m)&&!!this.style&&this.style._isSourceCacheLoaded(m)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(m,r,h){this._lazyInitEmptyStyle(),this.style.addSourceType(m,r,h)}removeSource(m){return this._isValidId(m)?(this.style.removeSource(m),this._updateTerrain(),this._update(!0)):this}getSource(m){return this._isValidId(m)?this.style.getOwnSource(m):null}addImage(m,r,{pixelRatio:h=1,sdf:y=!1,stretchX:b,stretchY:T,content:E}={}){if(this._lazyInitEmptyStyle(),r instanceof HTMLImageElement||ImageBitmap&&r instanceof ImageBitmap){const{width:I,height:k,data:N}=s.e.getImageData(r);this.style.addImage(m,{data:new s.i({width:I,height:k},N),pixelRatio:h,stretchX:b,stretchY:T,content:E,sdf:y,version:0})}else if(r.width===void 0||r.height===void 0)this.fire(new s.d(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:I,height:k}=r,N=r;this.style.addImage(m,{data:new s.i({width:I,height:k},new Uint8Array(N.data)),pixelRatio:h,stretchX:b,stretchY:T,content:E,sdf:y,version:0,userImage:N}),N.onAdd&&N.onAdd(this,m)}}updateImage(m,r){this._lazyInitEmptyStyle();const h=this.style.getImage(m);if(!h)return void this.fire(new s.d(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const y=r instanceof HTMLImageElement||ImageBitmap&&r instanceof ImageBitmap?s.e.getImageData(r):r,{width:b,height:T,data:E}=y;if(b===void 0||T===void 0)return void this.fire(new s.d(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(b!==h.data.width||T!==h.data.height)return void this.fire(new s.d(new Error(`The width and height of the updated image (${b}, ${T})
                must be that same as the previous version of the image
                (${h.data.width}, ${h.data.height})`)));const I=!(r instanceof HTMLImageElement||ImageBitmap&&r instanceof ImageBitmap);h.data.replace(E,I),this.style.updateImage(m,h)}hasImage(m){return m?!!this.style&&!!this.style.getImage(m):(this.fire(new s.d(new Error("Missing required image id"))),!1)}removeImage(m){this.style.removeImage(m)}loadImage(m,r){s.h(this._requestManager.transformRequest(m,s.R.Image),(h,y)=>{r(h,y instanceof HTMLImageElement?s.e.getImageData(y):y)})}listImages(){return this.style.listImages()}addModel(m,r){this._lazyInitEmptyStyle(),this.style.addModel(m,r)}hasModel(m){return m?this.style.hasModel(m):(this.fire(new s.d(new Error("Missing required model id"))),!1)}removeModel(m){this.style.removeModel(m)}listModels(){return this.style.listModels()}addLayer(m,r){return this._isValidId(m.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(m,r),this._update(!0)):this}getSlot(m){const r=this.getLayer(m);return r&&r.slot||null}setSlot(m,r){return this.style.setSlot(m,r),this.style.mergeLayers(),this._update(!0)}addImport(m,r){return this.style.addImport(m,r),this}updateImport(m,r){return typeof r!="string"&&r.id!==m?(this.removeImport(m),this.addImport(r)):(this.style.updateImport(m,r),this._update(!0))}removeImport(m){return this.style.removeImport(m),this}moveImport(m,r){return this.style.moveImport(m,r),this._update(!0)}moveLayer(m,r){return this._isValidId(m)?(this.style.moveLayer(m,r),this._update(!0)):this}removeLayer(m){return this._isValidId(m)?(this.style.removeLayer(m),this._update(!0)):this}getLayer(m){if(!this._isValidId(m))return null;const r=this.style.getOwnLayer(m);return r?r.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(m,r,h){return this._isValidId(m)?(this.style.setLayerZoomRange(m,r,h),this._update(!0)):this}setFilter(m,r,h={}){return this._isValidId(m)?(this.style.setFilter(m,r,h),this._update(!0)):this}getFilter(m){return this._isValidId(m)?this.style.getFilter(m):null}setPaintProperty(m,r,h,y={}){return this._isValidId(m)?(this.style.setPaintProperty(m,r,h,y),this._update(!0)):this}getPaintProperty(m,r){return this._isValidId(m)?this.style.getPaintProperty(m,r):null}setLayoutProperty(m,r,h,y={}){return this._isValidId(m)?(this.style.setLayoutProperty(m,r,h,y),this._update(!0)):this}getLayoutProperty(m,r){return this._isValidId(m)?this.style.getLayoutProperty(m,r):null}getSchema(m){return this.style.getSchema(m)}setSchema(m,r){return this.style.setSchema(m,r),this._update(!0)}getConfig(m){return this.style.getConfig(m)}setConfig(m,r){return this.style.setConfig(m,r),this._update(!0)}getConfigProperty(m,r){return this.style.getConfigProperty(m,r)}setConfigProperty(m,r,h){return this.style.setConfigProperty(m,r,h),this._update(!0)}setLights(m){if(this._lazyInitEmptyStyle(),m&&m.length===1&&m[0].type==="flat"){const r=m[0];r.properties?this.style.setFlatLight(r.properties,r.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(m),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const m=this.style.getLights()||[];return m.length===0&&m.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),m}setLight(m,r={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:m}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(m){return this._lazyInitEmptyStyle(),!m&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(m),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(m){return this._lazyInitEmptyStyle(),this.style.setFog(m),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setColorTheme(m){return this._lazyInitEmptyStyle(),this.style.setColorTheme(m),this._update(!0)}setCamera(m){return this.style.setCamera(m),this._triggerCameraUpdate(m)}_triggerCameraUpdate(m){return this._update(this.transform.setOrthographicProjectionAtLowPitch(m["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(m){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(s.aI.convert(m),this.transform):0}setFeatureState(m,r){return this._isValidId(m.source)?(this.style.setFeatureState(m,r),this._update()):this}removeFeatureState(m,r){return this._isValidId(m.source)?(this.style.removeFeatureState(m,r),this._update()):this}getFeatureState(m){return this._isValidId(m.source)?this.style.getFeatureState(m):null}_updateContainerDimensions(){if(!this._container)return;const m=this._container.getBoundingClientRect().width||400,r=this._container.getBoundingClientRect().height||300;let h,y,b,T=this._container;for(;T&&(!y||!b);){const E=window.getComputedStyle(T).transform;E&&E!=="none"&&(h=E.match(/matrix.*\((.+)\)/)[1].split(", "),h[0]&&h[0]!=="0"&&h[0]!=="1"&&(y=h[0]),h[3]&&h[3]!=="0"&&h[3]!=="1"&&(b=h[3])),T=T.parentElement}this._containerWidth=y?Math.abs(m/y):m,this._containerHeight=b?Math.abs(r/b):r}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&s.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const m=this._container;m.classList.add("mapboxgl-map"),(this._missingCSSCanary=ve("div","mapboxgl-canary",m)).style.visibility="hidden",this._detectMissingCSS();const r=this._canvasContainer=ve("div","mapboxgl-canvas-container",m);this._canvas=ve("canvas","mapboxgl-canvas",r),this._interactive&&(r.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const h=this._controlContainer=ve("div","mapboxgl-control-container",m),y=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(b=>{y[b]=ve("div",`mapboxgl-ctrl-${b}`,h)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(m,r){const h=s.e.devicePixelRatio||1;this._canvas.width=h*Math.ceil(m),this._canvas.height=h*Math.ceil(r),this._canvas.style.width=`${m}px`,this._canvas.style.height=`${r}px`}_addMarker(m){this._markers.push(m)}_removeMarker(m){const r=this._markers.indexOf(m);r!==-1&&this._markers.splice(r,1)}_addPopup(m){this._popups.push(m)}_removePopup(m){const r=this._popups.indexOf(m);r!==-1&&this._popups.splice(r,1)}_setupPainter(){const m=s.W({},j.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),r=this._canvas.getContext("webgl2",m);r?(s.dh(r,!0),this.painter=new fg(r,this._contextCreateOptions,this.transform,this._tp),this.on("data",h=>{h.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),s.di.testSupport(r)):this.fire(new s.d(new Error("Failed to initialize WebGL")))}_contextLost(m){m.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new s.f("webglcontextlost",{originalEvent:m}))}_contextRestored(m){this._setupPainter(),this.resize(),this._update(),this.fire(new s.f("webglcontextrestored",{originalEvent:m}))}_onMapScroll(m){if(m.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty&&!this._occlusionOpacityChanged&&this._occlusionCriteriaSatisfied()}_update(m){return this.style?(this._styleDirty=this._styleDirty||m,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(m){return this._update(),this._renderTaskQueue.add(m)}_cancelRenderFrame(m){this._renderTaskQueue.remove(m)}_requestDomTask(m){!this.loaded()||this.loaded()&&!this.isMoving()?m():this._domRenderTaskQueue.add(m)}_render(m){let r;this.fire(new s.f("renderstart")),++this._frameId;const h=this.painter.context.extTimerQuery,y=s.e.now(),b=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(r=b.createQuery(),b.beginQuery(h.TIME_ELAPSED_EXT,r)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(m),this._domRenderTaskQueue.run(m),this._removed)return;this._updateProjectionTransition();const T=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const N=this.transform.zoom,H=this.transform.pitch,X=s.e.now(),ee=new s.X(N,{now:X,fadeDuration:T,pitch:H,transition:this.style.transition});this.style.update(ee)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let E=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),E=this._updateAverageElevation(y),this.style.updateSources(this.transform),this._forceMarkerAndPopupUpdate()):E=this._updateAverageElevation(y);const I=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,T,this._crossSourceCollisions,this.painter.replacementSource);if(I&&(this._placementDirty=I.needsRerender,this._occlusionOpacityChanged=I.occlusionQueryBasedOpacityChanged),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:T,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new s.f("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,s.dc.mark(s.dd.load),this.fire(new s.f("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),r){const N=s.e.now()-y;b.endQuery(h.TIME_ELAPSED_EXT),setTimeout(()=>{const H=b.getQueryParameter(r,b.QUERY_RESULT)/1e6;b.deleteQuery(r),this.fire(new s.f("gpu-timing-frame",{cpuTime:N,gpuTime:H}))},50)}if(this.listens("gpu-timing-layer")){const N=this.painter.collectGpuTimers();setTimeout(()=>{const H=this.painter.queryGpuTimers(N);this.fire(new s.f("gpu-timing-layer",{layerTimes:H}))},50)}if(this.listens("gpu-timing-deferred-render")){const N=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{const H=this.painter.queryGpuTimeDeferredRender(N);this.fire(new s.f("gpu-timing-deferred-render",{gpuTime:H}))},50)}const k=this._sourcesDirty||this._styleDirty||this._placementDirty||this._occlusionOpacityChanged||E;if((this._sourcesDirty||this._styleDirty||E||this._occlusionOpacityChanged)&&(this._lastDirtyFrameId=this._frameId),k||this._repaint||!this._occlusionCriteriaSatisfied())this.triggerRepaint();else{const N=!this.isMoving()&&this.loaded();if(N&&(E=this._updateAverageElevation(y,!0)),E)this.triggerRepaint();else if(this._triggerFrame(!1),N&&(this.fire(new s.f("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const H=this._calculateSpeedIndex();this.fire(new s.f("speedindexcompleted",{speedIndex:H})),this.speedIndexTiming=!1}}this._loaded&&!this._fullyLoaded&&!k&&this._occlusionCriteriaSatisfied()&&(this._fullyLoaded=!0,s.dc.mark(s.dd.fullLoad),this._performanceMetricsCollection&&s.dj(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(m){for(const r of this._markers)m&&!this.getRenderWorldCopies()&&(r._lngLat=r._lngLat.wrap()),r._update();for(const r of this._popups)!m||this.getRenderWorldCopies()||r._trackPointer||(r._lngLat=r._lngLat.wrap()),r._update()}_updateAverageElevation(m,r=!1){const h=b=>(this.transform.averageElevation=b,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&h(0);const y=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(y||(r||m-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(m)){const b=this.transform.averageElevation;let T=this.transform.sampleAverageElevation();this.transform.elevation!=null&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(T)?T=0:this._averageElevationLastSampledAt=m;const E=Math.abs(b-T);if(E>1){if(this._isInitialLoad||y)return this._averageElevation.jumpTo(T),h(T);this._averageElevation.easeTo(T,m,300)}else if(E>1e-4)return this._averageElevation.jumpTo(T),h(T)}return!!this._averageElevation.isEasing(m)&&h(this._averageElevation.getValue(m))}_authenticate(){s.dk(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,m=>{if(m&&(m.message===s.dl||m.status===401)){const r=this.painter.context.gl;s.dh(r,!1),this._logoControl instanceof qp&&this._logoControl._updateLogo(),r&&r.clear(r.DEPTH_BUFFER_BIT|r.COLOR_BUFFER_BIT|r.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new s.d(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),s.dm(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_postStyleLoadEvent(){this.style.globalId&&s.dn(this._requestManager._customAccessToken,{map:this,skuToken:this._requestManager._skuToken,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){const m=this._isDragging();this.painter.updateTerrain(this.style,m)}_calculateSpeedIndex(){const m=this.painter.canvasCopy(),r=this.painter.getCanvasCopiesAndTimestamps();r.timeStamps.push(performance.now());const h=this.painter.context.gl,y=h.createFramebuffer();function b(T){h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_2D,T,0);const E=new Uint8Array(h.drawingBufferWidth*h.drawingBufferHeight*4);return h.readPixels(0,0,h.drawingBufferWidth,h.drawingBufferHeight,h.RGBA,h.UNSIGNED_BYTE,E),E}return h.bindFramebuffer(h.FRAMEBUFFER,y),this._canvasPixelComparison(b(m),r.canvasCopies.map(b),r.timeStamps)}_canvasPixelComparison(m,r,h){let y=h[1]-h[0];const b=m.length/4;for(let T=0;T<r.length;T++){const E=r[T];let I=0;for(let k=0;k<E.length;k+=4)E[k]===m[k]&&E[k+1]===m[k+1]&&E[k+2]===m[k+2]&&E[k+3]===m[k+3]&&(I+=1);y+=(h[T+2]-h[T+1])*(1-I/b)}return y}remove(){this._hash&&this._hash.remove();for(const r of this._controls)r.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const m=this.painter.context.gl.getExtension("WEBGL_lose_context");m&&m.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),s.dp(this.painter.context.gl),s.dq.remove(),s.dr.remove(),this._removed=!0,this.fire(new s.f("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(m){this._renderNextFrame=this._renderNextFrame||m,this.style&&!this._frame&&(this._frame=s.e.frame(r=>{const h=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,h&&this._render(r)}))}_preloadTiles(m){const r=this.style?this.style.getSourceCaches():[];return s.ds(r,(h,y)=>h._preloadTiles(m,y),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(m){this._trackResize&&this.resize({originalEvent:m})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(m){this._showTileBoundaries!==m&&(this._showTileBoundaries=m,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(m){this._showParseStatus!==m&&(this._showParseStatus=m,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(m){this._showTerrainWireframe!==m&&(this._showTerrainWireframe=m,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(m){this._showLayers2DWireframe!==m&&(this._showLayers2DWireframe=m,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(m){this._showLayers3DWireframe!==m&&(this._showLayers3DWireframe=m,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(m){this._speedIndexTiming!==m&&(this._speedIndexTiming=m,this._update())}get showPadding(){return!!this._showPadding}set showPadding(m){this._showPadding!==m&&(this._showPadding=m,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(m){this._showCollisionBoxes!==m&&(this._showCollisionBoxes=m,this._tp.refreshUI(),m?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(m){this._showOverdrawInspector!==m&&(this._showOverdrawInspector=m,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(m){this._repaint!==m&&(this._repaint=m,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(m){this._vertices=m,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(m){this._showTileAABBs!==m&&(this._showTileAABBs=m,this._tp.refreshUI(),m&&this._update())}_setCacheLimits(m,r){s.du(m,r)}_occlusionCriteriaSatisfied(){const m=this.style&&(this.style.has3DLayers()||this.style.terrain&&!this.style.disableElevatedTerrain);return!(this.style&&this.style.hasSymbolLayers()&&m&&this.painter)||this._frameId-this._lastDirtyFrameId>5+2*this.painter.symbolParams.occlusionQueryFrameWindow}get version(){return s.dt}},NavigationControl:class{constructor(m={}){this.options=s.W({},ou,m),this._container=ve("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",r=>r.preventDefault()),this.options.showZoom&&(s.bp(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",r=>{this._map&&this._map.zoomIn({},{originalEvent:r})}),ve("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",r=>{this._map&&this._map.zoomOut({},{originalEvent:r})}),ve("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(s.bp(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",r=>{const h=this._map;h&&(this.options.visualizePitch?h.resetNorthPitch({},{originalEvent:r}):h.resetNorth({},{originalEvent:r}))}),this._compassIcon=ve("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const m=this._map;if(!m)return;const r=m.getZoom(),h=r===m.getMaxZoom(),y=r===m.getMinZoom();this._zoomInButton.disabled=h,this._zoomOutButton.disabled=y,this._zoomInButton.setAttribute("aria-disabled",h.toString()),this._zoomOutButton.setAttribute("aria-disabled",y.toString())}_rotateCompassArrow(){const m=this._map;if(!m)return;const r=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(m.transform.pitch*(Math.PI/180)),.5)}) rotateX(${m.transform.pitch}deg) rotateZ(${m.transform.angle*(180/Math.PI)}deg)`:`rotate(${m.transform.angle*(180/Math.PI)}deg)`;m._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=r)})}onAdd(m){return this._map=m,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),m.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&m.on("pitch",this._rotateCompassArrow),m.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Ol(m,this._compass,this.options.visualizePitch)),this._container}onRemove(){const m=this._map;m&&(this._container.remove(),this.options.showZoom&&m.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&m.off("pitch",this._rotateCompassArrow),m.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(m,r){const h=ve("button",m,this._container);return h.type="button",h.addEventListener("click",r),h}_setButtonTitle(m,r){if(!this._map)return;const h=this._map._getUIString(`NavigationControl.${r}`);m.setAttribute("aria-label",h),m.firstElementChild&&m.firstElementChild.setAttribute("title",h)}},GeolocateControl:class extends s.E{constructor(m={}){super();const r=navigator.geolocation;this.options=s.W({geolocation:r},au,m),s.bp(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=nm(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(m){return this._map=m,this._container=ve("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(m){const r=(h=!!this.options.geolocation)=>{this._supportsGeolocation=h,m(h)};this._supportsGeolocation!==void 0?m(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then(h=>r(h.state!=="denied")).catch(()=>r()):r()}_isOutOfMapMaxBounds(m){const r=this._map.getMaxBounds(),h=m.coords;return!!r&&(h.longitude<r.getWest()||h.longitude>r.getEast()||h.latitude<r.getSouth()||h.latitude>r.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(m){if(this._map){if(this._isOutOfMapMaxBounds(m))return this._setErrorState(),this.fire(new s.f("outofmaxbounds",m)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=m,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(m),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(m),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new s.f("geolocate",m)),this._finish()}}_updateCamera(m){const r=new s.aI(m.coords.longitude,m.coords.latitude),h=m.coords.accuracy,y=this._map.getBearing(),b=s.W({bearing:y},this.options.fitBoundsOptions);this._map.fitBounds(r.toBounds(h),b,{geolocateSource:!0})}_updateMarker(m){if(m){const r=new s.aI(m.coords.longitude,m.coords.latitude);this._accuracyCircleMarker.setLngLat(r).addTo(this._map),this._userLocationDotMarker.setLngLat(r).addTo(this._map),this._accuracy=m.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const m=this._map.transform,r=s.ax(1,m._center.lat)*m.worldSize,h=Math.ceil(2*this._accuracy*r);this._circleElement.style.width=`${h}px`,this._circleElement.style.height=`${h}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(m){if(this._map){if(this.options.trackUserLocation)if(m.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const r=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",r),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",r),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(m.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new s.f("error",m)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(m){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",r=>r.preventDefault()),this._geolocateButton=ve("button","mapboxgl-ctrl-geolocate",this._container),ve("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",m===!1){s.w("Geolocation support is not available so the GeolocateControl will be disabled.");const r=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",r),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",r)}else{const r=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",r),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",r)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=ve("div","mapboxgl-user-location"),this._dotElement.appendChild(ve("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(ve("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new ul({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=ve("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new ul({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",r=>{r.geolocateSource||this._watchState!=="ACTIVE_LOCK"||r.originalEvent&&r.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new s.f("trackuserlocationend")))})}}_onDeviceOrientation(m){this._userLocationDotMarker&&(m.webkitCompassHeading?this._heading=m.webkitCompassHeading:m.absolute===!0&&(this._heading=-1*m.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return s.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new s.f("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new s.f("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new s.f("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let m;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(m={maximumAge:6e5,timeout:0},this._noTimeout=!0):(m=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,m),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const m=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(r=>{r==="granted"&&m()}).catch(console.error):m()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Wp,ScaleControl:class{constructor(m={}){this.options=s.W({},Fc,m),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),s.bp(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const m=this.options.maxWidth||100,r=this._map,h=r._containerHeight/2,y=r._containerWidth/2-m/2,b=r.unproject([y,h]),T=r.unproject([y+m,h]),E=b.distanceTo(T);if(this.options.unit==="imperial"){const I=3.2808*E;I>5280?this._setScale(m,I/5280,"mile"):this._setScale(m,I,"foot")}else this.options.unit==="nautical"?this._setScale(m,E/1852,"nautical-mile"):E>=1e3?this._setScale(m,E/1e3,"kilometer"):this._setScale(m,E,"meter")}_setScale(m,r,h){this._map._requestDomTask(()=>{const y=function(T){const E=Math.pow(10,`${Math.floor(T)}`.length-1);let I=T/E;return I=I>=10?10:I>=5?5:I>=3?3:I>=2?2:I>=1?1:function(k){const N=Math.pow(10,Math.ceil(-Math.log(k)/Math.LN10));return Math.round(k*N)/N}(I),E*I}(r),b=y/r;this._container.innerHTML=this._isNumberFormatSupported&&h!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:h}).format(y):`${y}&nbsp;${$p[h]}`,this._container.style.width=m*b+"px"})}onAdd(m){return this._map=m,this._language=m.getLanguage(),this._container=ve("div","mapboxgl-ctrl mapboxgl-ctrl-scale",m.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(m){this._language=m,this._update()}setUnit(m){this.options.unit=m,this._update()}},FullscreenControl:class{constructor(m={}){this._fullscreen=!1,m&&m.container&&(m.container instanceof HTMLElement?this._container=m.container:s.w("Full screen control 'container' must be a DOM element.")),s.bp(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(m){return this._map=m,this._container||(this._container=this._map.getContainer()),this._controlContainer=ve("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",s.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const m=this._fullscreenButton=ve("button","mapboxgl-ctrl-fullscreen",this._controlContainer);ve("span","mapboxgl-ctrl-icon",m).setAttribute("aria-hidden","true"),m.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const m=this._getTitle();this._fullscreenButton.setAttribute("aria-label",m),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",m)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends s.E{constructor(m){super(),this.options=s.W(Object.create(Wd),m),s.bp(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(m&&m.className?m.className.trim().split(/\s+/):[])}addTo(m){return this._map&&this.remove(),this._map=m,this.options.closeOnClick&&m.on("preclick",this._onClose),this.options.closeOnMove&&m.on("move",this._onClose),m.on("remove",this.remove),this._update(),m._addPopup(this),this._focusFirstElement(),this._trackPointer?(m.on("mousemove",this._onMouseEvent),m.on("mouseup",this._onMouseEvent),m._canvasContainer.classList.add("mapboxgl-track-pointer")):m.on("move",this._update),this.fire(new s.f("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const m=this._map;return m&&(m.off("move",this._update),m.off("move",this._onClose),m.off("preclick",this._onClose),m.off("click",this._onClose),m.off("remove",this.remove),m.off("mousemove",this._onMouseEvent),m.off("mouseup",this._onMouseEvent),m.off("drag",this._onMouseEvent),m._canvasContainer&&m._canvasContainer.classList.remove("mapboxgl-track-pointer"),m._removePopup(this),this._map=void 0),this.fire(new s.f("close")),this}getLngLat(){return this._lngLat}setLngLat(m){this._lngLat=s.aI.convert(m),this._pos=null,this._trackPointer=!1,this._update();const r=this._map;return r&&(r.on("move",this._update),r.off("mousemove",this._onMouseEvent),r._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const m=this._map;return m&&(m.off("move",this._update),m.on("mousemove",this._onMouseEvent),m.on("drag",this._onMouseEvent),m._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(m){return this.setDOMContent(document.createTextNode(m))}setHTML(m){const r=document.createDocumentFragment(),h=document.createElement("body");let y;for(h.innerHTML=m;y=h.firstChild,y;)r.appendChild(y);return this.setDOMContent(r)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(m){return this.options.maxWidth=m,this._update(),this}setDOMContent(m){let r=this._content;if(r)for(;r.hasChildNodes();)r.firstChild&&r.removeChild(r.firstChild);else r=this._content=ve("div","mapboxgl-popup-content",this._container||void 0);if(r.appendChild(m),this.options.closeButton){const h=this._closeButton=ve("button","mapboxgl-popup-close-button",r);h.type="button",h.setAttribute("aria-label","Close popup"),h.setAttribute("aria-hidden","true"),h.innerHTML="&#215;",h.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(m){return this._classList.add(m),this._updateClassList(),this}removeClassName(m){return this._classList.delete(m),this._updateClassList(),this}setOffset(m){return this.options.offset=m,this._update(),this}toggleClassName(m){let r;return this._classList.delete(m)?r=!1:(this._classList.add(m),r=!0),this._updateClassList(),r}_onMouseEvent(m){this._update(m.point)}_getAnchor(m){if(this.options.anchor)return this.options.anchor;const r=this._map,h=this._container,y=this._pos;if(!r||!h||!y)return"bottom";const b=h.offsetWidth,T=h.offsetHeight,E=y.x<b/2,I=y.x>r.transform.width-b/2;if(y.y+m<T)return E?"top-left":I?"top-right":"top";if(y.y>r.transform.height-T){if(E)return"bottom-left";if(I)return"bottom-right"}return E?"left":I?"right":"bottom"}_updateClassList(){const m=this._container;if(!m)return;const r=[...this._classList];r.push("mapboxgl-popup"),this._anchor&&r.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&r.push("mapboxgl-popup-track-pointer"),m.className=r.join(" ")}_update(m){const r=this._map,h=this._content;if(!r||!this._lngLat&&!this._trackPointer||!h)return;let y=this._container;if(y||(y=this._container=ve("div","mapboxgl-popup",r.getContainer()),this._tip=ve("div","mapboxgl-popup-tip",y),y.appendChild(h)),this.options.maxWidth&&y.style.maxWidth!==this.options.maxWidth&&(y.style.maxWidth=this.options.maxWidth),r.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=jd(this._lngLat,this._pos,r.transform)),!this._trackPointer||m){const b=this._pos=this._trackPointer&&m instanceof s.P?m:r.project(this._lngLat),T=$o(this.options.offset),E=this._anchor=this._getAnchor(T.y),I=$o(this.options.offset,E),k=b.add(I).round();r._requestDomTask(()=>{this._container&&E&&(this._container.style.transform=`${su[E]} translate(${k.x}px,${k.y}px)`)})}if(!this._marker&&r._showingGlobe()){const b=s.d9(r.transform,this._lngLat)?0:1;this._setOpacity(b)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const m=this._container.querySelector(qd);m&&m.focus()}_onClose(){this.remove()}_setOpacity(m){this._container&&(this._container.style.opacity=`${m}`),this._content&&(this._content.style.pointerEvents=m?"auto":"none")}},Marker:ul,Style:Ha,LngLat:s.aI,LngLatBounds:s.ai,Point:s.P,MercatorCoordinate:s.Y,FreeCameraOptions:un,Evented:s.E,config:s.d8,prewarm:s.dx,clearPrewarmedResources:s.dy,get accessToken(){return s.d8.ACCESS_TOKEN},set accessToken(m){s.d8.ACCESS_TOKEN=m},get baseApiUrl(){return s.d8.API_URL},set baseApiUrl(m){s.d8.API_URL=m},get workerCount(){return s.dz.workerCount},set workerCount(m){s.dz.workerCount=m},get maxParallelImageRequests(){return s.d8.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(m){s.d8.MAX_PARALLEL_IMAGE_REQUESTS=m},clearStorage(m){s.dA(m)},get workerUrl(){return s.dB.workerUrl},set workerUrl(m){s.dB.workerUrl=m},get workerClass(){return s.dB.workerClass},set workerClass(m){s.dB.workerClass=m},get workerParams(){return s.dB.workerParams},set workerParams(m){s.dB.workerParams=m},get dracoUrl(){return s.dC()},set dracoUrl(m){s.dD(m)},get meshoptUrl(){return s.dE()},set meshoptUrl(m){s.dF(m)},setNow:s.e.setNow,restoreNow:s.e.restoreNow}});var B=D;return B})})(tv);var N2=tv.exports;const iv=h_(N2);let U2=class extends Xm{removeMap(p){const f=document.getElementById(p);for(;f&&f.firstChild;)f.lastChild&&f.removeChild(f.lastChild)}};const V2="pk.eyJ1Ijoic2NhcmJhbGxvMjAyMSIsImEiOiJja3RvcXE1NzEwOHk0MnZxc3FobXo4bDE4In0.gX8dCNsJN9wN94P_hLSywg",G2=12,H2=17.5,j2=60,W2=0,q2=8;class Z2 extends U2{constructor(p,f,C,D){super(f),super.validateToken(),this.elementId=p,this.lng=C,this.lat=D}init(){console.log("init"),iv.accessToken=V2;const p={container:this.elementId,style:"mapbox://styles/mapbox/outdoors-v12",center:[this.lng,this.lat],zoom:H2,minZoom:G2,pitch:j2,heading:W2,antialias:!0},f=new iv.Map(p);f.transform.fov=q2,window.mapboxMap=f;const C=document.querySelector(".mapboxgl-control-container");C&&(C.style.display="none")}mapResize(){window.mapboxMap.resize()}addEventListeners(){}}/**
 * @license
 * Copyright 2010-2024 Three.js Authors
 * SPDX-License-Identifier: MIT
 */const nv="166",o0=0,X2=1,$2=2,rv=1,sv=100,ov=204,av=205,lv=3,cv=0,hv=300,uv=1e3,m_=1001,dv=1002,Y2=1006,J2=1008,K2=1009,Q2=1015,eE=1023,tE=0,pv="",gd="srgb",a0="srgb-linear",iE="display-p3",fv="display-p3-linear",l0="linear",mv="srgb",gv="rec709",_v="p3",bf=7680,yv=519,xv=35044,g_=2e3,vv=2001;class __{addEventListener(p,f){this._listeners===void 0&&(this._listeners={});const C=this._listeners;C[p]===void 0&&(C[p]=[]),C[p].indexOf(f)===-1&&C[p].push(f)}hasEventListener(p,f){if(this._listeners===void 0)return!1;const C=this._listeners;return C[p]!==void 0&&C[p].indexOf(f)!==-1}removeEventListener(p,f){if(this._listeners===void 0)return;const D=this._listeners[p];if(D!==void 0){const U=D.indexOf(f);U!==-1&&D.splice(U,1)}}dispatchEvent(p){if(this._listeners===void 0)return;const C=this._listeners[p.type];if(C!==void 0){p.target=this;const D=C.slice(0);for(let U=0,B=D.length;U<B;U++)D[U].call(this,p);p.target=null}}}const Oa=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"],nE=Math.PI/180;function wf(){const te=Math.random()*4294967295|0,p=Math.random()*4294967295|0,f=Math.random()*4294967295|0,C=Math.random()*4294967295|0;return(Oa[te&255]+Oa[te>>8&255]+Oa[te>>16&255]+Oa[te>>24&255]+"-"+Oa[p&255]+Oa[p>>8&255]+"-"+Oa[p>>16&15|64]+Oa[p>>24&255]+"-"+Oa[f&63|128]+Oa[f>>8&255]+"-"+Oa[f>>16&255]+Oa[f>>24&255]+Oa[C&255]+Oa[C>>8&255]+Oa[C>>16&255]+Oa[C>>24&255]).toLowerCase()}function Fa(te,p,f){return Math.max(p,Math.min(f,te))}function rE(te,p){return(te%p+p)%p}function c0(te,p,f){return(1-f)*te+f*p}function Ym(te,p){switch(p.constructor){case Float32Array:return te;case Uint32Array:return te/4294967295;case Uint16Array:return te/65535;case Uint8Array:return te/255;case Int32Array:return Math.max(te/2147483647,-1);case Int16Array:return Math.max(te/32767,-1);case Int8Array:return Math.max(te/127,-1);default:throw new Error("Invalid component type.")}}function vl(te,p){switch(p.constructor){case Float32Array:return te;case Uint32Array:return Math.round(te*4294967295);case Uint16Array:return Math.round(te*65535);case Uint8Array:return Math.round(te*255);case Int32Array:return Math.round(te*2147483647);case Int16Array:return Math.round(te*32767);case Int8Array:return Math.round(te*127);default:throw new Error("Invalid component type.")}}class Rr{constructor(p=0,f=0){Rr.prototype.isVector2=!0,this.x=p,this.y=f}get width(){return this.x}set width(p){this.x=p}get height(){return this.y}set height(p){this.y=p}set(p,f){return this.x=p,this.y=f,this}setScalar(p){return this.x=p,this.y=p,this}setX(p){return this.x=p,this}setY(p){return this.y=p,this}setComponent(p,f){switch(p){case 0:this.x=f;break;case 1:this.y=f;break;default:throw new Error("index is out of range: "+p)}return this}getComponent(p){switch(p){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+p)}}clone(){return new this.constructor(this.x,this.y)}copy(p){return this.x=p.x,this.y=p.y,this}add(p){return this.x+=p.x,this.y+=p.y,this}addScalar(p){return this.x+=p,this.y+=p,this}addVectors(p,f){return this.x=p.x+f.x,this.y=p.y+f.y,this}addScaledVector(p,f){return this.x+=p.x*f,this.y+=p.y*f,this}sub(p){return this.x-=p.x,this.y-=p.y,this}subScalar(p){return this.x-=p,this.y-=p,this}subVectors(p,f){return this.x=p.x-f.x,this.y=p.y-f.y,this}multiply(p){return this.x*=p.x,this.y*=p.y,this}multiplyScalar(p){return this.x*=p,this.y*=p,this}divide(p){return this.x/=p.x,this.y/=p.y,this}divideScalar(p){return this.multiplyScalar(1/p)}applyMatrix3(p){const f=this.x,C=this.y,D=p.elements;return this.x=D[0]*f+D[3]*C+D[6],this.y=D[1]*f+D[4]*C+D[7],this}min(p){return this.x=Math.min(this.x,p.x),this.y=Math.min(this.y,p.y),this}max(p){return this.x=Math.max(this.x,p.x),this.y=Math.max(this.y,p.y),this}clamp(p,f){return this.x=Math.max(p.x,Math.min(f.x,this.x)),this.y=Math.max(p.y,Math.min(f.y,this.y)),this}clampScalar(p,f){return this.x=Math.max(p,Math.min(f,this.x)),this.y=Math.max(p,Math.min(f,this.y)),this}clampLength(p,f){const C=this.length();return this.divideScalar(C||1).multiplyScalar(Math.max(p,Math.min(f,C)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(p){return this.x*p.x+this.y*p.y}cross(p){return this.x*p.y-this.y*p.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(p){const f=Math.sqrt(this.lengthSq()*p.lengthSq());if(f===0)return Math.PI/2;const C=this.dot(p)/f;return Math.acos(Fa(C,-1,1))}distanceTo(p){return Math.sqrt(this.distanceToSquared(p))}distanceToSquared(p){const f=this.x-p.x,C=this.y-p.y;return f*f+C*C}manhattanDistanceTo(p){return Math.abs(this.x-p.x)+Math.abs(this.y-p.y)}setLength(p){return this.normalize().multiplyScalar(p)}lerp(p,f){return this.x+=(p.x-this.x)*f,this.y+=(p.y-this.y)*f,this}lerpVectors(p,f,C){return this.x=p.x+(f.x-p.x)*C,this.y=p.y+(f.y-p.y)*C,this}equals(p){return p.x===this.x&&p.y===this.y}fromArray(p,f=0){return this.x=p[f],this.y=p[f+1],this}toArray(p=[],f=0){return p[f]=this.x,p[f+1]=this.y,p}fromBufferAttribute(p,f){return this.x=p.getX(f),this.y=p.getY(f),this}rotateAround(p,f){const C=Math.cos(f),D=Math.sin(f),U=this.x-p.x,B=this.y-p.y;return this.x=U*C-B*D+p.x,this.y=U*D+B*C+p.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class _d{constructor(p,f,C,D,U,B,s,Z,j){_d.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],p!==void 0&&this.set(p,f,C,D,U,B,s,Z,j)}set(p,f,C,D,U,B,s,Z,j){const Q=this.elements;return Q[0]=p,Q[1]=D,Q[2]=s,Q[3]=f,Q[4]=U,Q[5]=Z,Q[6]=C,Q[7]=B,Q[8]=j,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(p){const f=this.elements,C=p.elements;return f[0]=C[0],f[1]=C[1],f[2]=C[2],f[3]=C[3],f[4]=C[4],f[5]=C[5],f[6]=C[6],f[7]=C[7],f[8]=C[8],this}extractBasis(p,f,C){return p.setFromMatrix3Column(this,0),f.setFromMatrix3Column(this,1),C.setFromMatrix3Column(this,2),this}setFromMatrix4(p){const f=p.elements;return this.set(f[0],f[4],f[8],f[1],f[5],f[9],f[2],f[6],f[10]),this}multiply(p){return this.multiplyMatrices(this,p)}premultiply(p){return this.multiplyMatrices(p,this)}multiplyMatrices(p,f){const C=p.elements,D=f.elements,U=this.elements,B=C[0],s=C[3],Z=C[6],j=C[1],Q=C[4],oe=C[7],ve=C[2],Ee=C[5],We=C[8],Re=D[0],He=D[3],Mt=D[6],Lt=D[1],Ut=D[4],Wt=D[7],lt=D[2],Ct=D[5],qt=D[8];return U[0]=B*Re+s*Lt+Z*lt,U[3]=B*He+s*Ut+Z*Ct,U[6]=B*Mt+s*Wt+Z*qt,U[1]=j*Re+Q*Lt+oe*lt,U[4]=j*He+Q*Ut+oe*Ct,U[7]=j*Mt+Q*Wt+oe*qt,U[2]=ve*Re+Ee*Lt+We*lt,U[5]=ve*He+Ee*Ut+We*Ct,U[8]=ve*Mt+Ee*Wt+We*qt,this}multiplyScalar(p){const f=this.elements;return f[0]*=p,f[3]*=p,f[6]*=p,f[1]*=p,f[4]*=p,f[7]*=p,f[2]*=p,f[5]*=p,f[8]*=p,this}determinant(){const p=this.elements,f=p[0],C=p[1],D=p[2],U=p[3],B=p[4],s=p[5],Z=p[6],j=p[7],Q=p[8];return f*B*Q-f*s*j-C*U*Q+C*s*Z+D*U*j-D*B*Z}invert(){const p=this.elements,f=p[0],C=p[1],D=p[2],U=p[3],B=p[4],s=p[5],Z=p[6],j=p[7],Q=p[8],oe=Q*B-s*j,ve=s*Z-Q*U,Ee=j*U-B*Z,We=f*oe+C*ve+D*Ee;if(We===0)return this.set(0,0,0,0,0,0,0,0,0);const Re=1/We;return p[0]=oe*Re,p[1]=(D*j-Q*C)*Re,p[2]=(s*C-D*B)*Re,p[3]=ve*Re,p[4]=(Q*f-D*Z)*Re,p[5]=(D*U-s*f)*Re,p[6]=Ee*Re,p[7]=(C*Z-j*f)*Re,p[8]=(B*f-C*U)*Re,this}transpose(){let p;const f=this.elements;return p=f[1],f[1]=f[3],f[3]=p,p=f[2],f[2]=f[6],f[6]=p,p=f[5],f[5]=f[7],f[7]=p,this}getNormalMatrix(p){return this.setFromMatrix4(p).invert().transpose()}transposeIntoArray(p){const f=this.elements;return p[0]=f[0],p[1]=f[3],p[2]=f[6],p[3]=f[1],p[4]=f[4],p[5]=f[7],p[6]=f[2],p[7]=f[5],p[8]=f[8],this}setUvTransform(p,f,C,D,U,B,s){const Z=Math.cos(U),j=Math.sin(U);return this.set(C*Z,C*j,-C*(Z*B+j*s)+B+p,-D*j,D*Z,-D*(-j*B+Z*s)+s+f,0,0,1),this}scale(p,f){return this.premultiply(h0.makeScale(p,f)),this}rotate(p){return this.premultiply(h0.makeRotation(-p)),this}translate(p,f){return this.premultiply(h0.makeTranslation(p,f)),this}makeTranslation(p,f){return p.isVector2?this.set(1,0,p.x,0,1,p.y,0,0,1):this.set(1,0,p,0,1,f,0,0,1),this}makeRotation(p){const f=Math.cos(p),C=Math.sin(p);return this.set(f,-C,0,C,f,0,0,0,1),this}makeScale(p,f){return this.set(p,0,0,0,f,0,0,0,1),this}equals(p){const f=this.elements,C=p.elements;for(let D=0;D<9;D++)if(f[D]!==C[D])return!1;return!0}fromArray(p,f=0){for(let C=0;C<9;C++)this.elements[C]=p[C+f];return this}toArray(p=[],f=0){const C=this.elements;return p[f]=C[0],p[f+1]=C[1],p[f+2]=C[2],p[f+3]=C[3],p[f+4]=C[4],p[f+5]=C[5],p[f+6]=C[6],p[f+7]=C[7],p[f+8]=C[8],p}clone(){return new this.constructor().fromArray(this.elements)}}const h0=new _d;function sE(te){for(let p=te.length-1;p>=0;--p)if(te[p]>=65535)return!0;return!1}function bv(te){return document.createElementNS("http://www.w3.org/1999/xhtml",te)}const wv={};function oE(te){te in wv||(wv[te]=!0,console.warn(te))}const Mv=new _d().set(.8224621,.177538,0,.0331941,.9668058,0,.0170827,.0723974,.9105199),Tv=new _d().set(1.2249401,-.2249404,0,-.0420569,1.0420571,0,-.0196376,-.0786361,1.0982735),y_={[a0]:{transfer:l0,primaries:gv,toReference:te=>te,fromReference:te=>te},[gd]:{transfer:mv,primaries:gv,toReference:te=>te.convertSRGBToLinear(),fromReference:te=>te.convertLinearToSRGB()},[fv]:{transfer:l0,primaries:_v,toReference:te=>te.applyMatrix3(Tv),fromReference:te=>te.applyMatrix3(Mv)},[iE]:{transfer:mv,primaries:_v,toReference:te=>te.convertSRGBToLinear().applyMatrix3(Tv),fromReference:te=>te.applyMatrix3(Mv).convertLinearToSRGB()}},aE=new Set([a0,fv]),Kc={enabled:!0,_workingColorSpace:a0,get workingColorSpace(){return this._workingColorSpace},set workingColorSpace(te){if(!aE.has(te))throw new Error(`Unsupported working color space, "${te}".`);this._workingColorSpace=te},convert:function(te,p,f){if(this.enabled===!1||p===f||!p||!f)return te;const C=y_[p].toReference,D=y_[f].fromReference;return D(C(te))},fromWorkingColorSpace:function(te,p){return this.convert(te,this._workingColorSpace,p)},toWorkingColorSpace:function(te,p){return this.convert(te,p,this._workingColorSpace)},getPrimaries:function(te){return y_[te].primaries},getTransfer:function(te){return te===pv?l0:y_[te].transfer}};function Mf(te){return te<.04045?te*.0773993808:Math.pow(te*.9478672986+.0521327014,2.4)}function u0(te){return te<.0031308?te*12.92:1.055*Math.pow(te,.41666)-.055}let Tf;class lE{static getDataURL(p){if(/^data:/i.test(p.src)||typeof HTMLCanvasElement>"u")return p.src;let f;if(p instanceof HTMLCanvasElement)f=p;else{Tf===void 0&&(Tf=bv("canvas")),Tf.width=p.width,Tf.height=p.height;const C=Tf.getContext("2d");p instanceof ImageData?C.putImageData(p,0,0):C.drawImage(p,0,0,p.width,p.height),f=Tf}return f.width>2048||f.height>2048?(console.warn("THREE.ImageUtils.getDataURL: Image converted to jpg for performance reasons",p),f.toDataURL("image/jpeg",.6)):f.toDataURL("image/png")}static sRGBToLinear(p){if(typeof HTMLImageElement<"u"&&p instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&p instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&p instanceof ImageBitmap){const f=bv("canvas");f.width=p.width,f.height=p.height;const C=f.getContext("2d");C.drawImage(p,0,0,p.width,p.height);const D=C.getImageData(0,0,p.width,p.height),U=D.data;for(let B=0;B<U.length;B++)U[B]=Mf(U[B]/255)*255;return C.putImageData(D,0,0),f}else if(p.data){const f=p.data.slice(0);for(let C=0;C<f.length;C++)f instanceof Uint8Array||f instanceof Uint8ClampedArray?f[C]=Math.floor(Mf(f[C]/255)*255):f[C]=Mf(f[C]);return{data:f,width:p.width,height:p.height}}else return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),p}}let cE=0;class hE{constructor(p=null){this.isSource=!0,Object.defineProperty(this,"id",{value:cE++}),this.uuid=wf(),this.data=p,this.dataReady=!0,this.version=0}set needsUpdate(p){p===!0&&this.version++}toJSON(p){const f=p===void 0||typeof p=="string";if(!f&&p.images[this.uuid]!==void 0)return p.images[this.uuid];const C={uuid:this.uuid,url:""},D=this.data;if(D!==null){let U;if(Array.isArray(D)){U=[];for(let B=0,s=D.length;B<s;B++)D[B].isDataTexture?U.push(d0(D[B].image)):U.push(d0(D[B]))}else U=d0(D);C.url=U}return f||(p.images[this.uuid]=C),C}}function d0(te){return typeof HTMLImageElement<"u"&&te instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&te instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&te instanceof ImageBitmap?lE.getDataURL(te):te.data?{data:Array.from(te.data),width:te.width,height:te.height,type:te.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}let uE=0;class _p extends __{constructor(p=_p.DEFAULT_IMAGE,f=_p.DEFAULT_MAPPING,C=m_,D=m_,U=Y2,B=J2,s=eE,Z=K2,j=_p.DEFAULT_ANISOTROPY,Q=pv){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:uE++}),this.uuid=wf(),this.name="",this.source=new hE(p),this.mipmaps=[],this.mapping=f,this.channel=0,this.wrapS=C,this.wrapT=D,this.magFilter=U,this.minFilter=B,this.anisotropy=j,this.format=s,this.internalFormat=null,this.type=Z,this.offset=new Rr(0,0),this.repeat=new Rr(1,1),this.center=new Rr(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new _d,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=Q,this.userData={},this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1,this.pmremVersion=0}get image(){return this.source.data}set image(p=null){this.source.data=p}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return new this.constructor().copy(this)}copy(p){return this.name=p.name,this.source=p.source,this.mipmaps=p.mipmaps.slice(0),this.mapping=p.mapping,this.channel=p.channel,this.wrapS=p.wrapS,this.wrapT=p.wrapT,this.magFilter=p.magFilter,this.minFilter=p.minFilter,this.anisotropy=p.anisotropy,this.format=p.format,this.internalFormat=p.internalFormat,this.type=p.type,this.offset.copy(p.offset),this.repeat.copy(p.repeat),this.center.copy(p.center),this.rotation=p.rotation,this.matrixAutoUpdate=p.matrixAutoUpdate,this.matrix.copy(p.matrix),this.generateMipmaps=p.generateMipmaps,this.premultiplyAlpha=p.premultiplyAlpha,this.flipY=p.flipY,this.unpackAlignment=p.unpackAlignment,this.colorSpace=p.colorSpace,this.userData=JSON.parse(JSON.stringify(p.userData)),this.needsUpdate=!0,this}toJSON(p){const f=p===void 0||typeof p=="string";if(!f&&p.textures[this.uuid]!==void 0)return p.textures[this.uuid];const C={metadata:{version:4.6,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(p).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(C.userData=this.userData),f||(p.textures[this.uuid]=C),C}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(p){if(this.mapping!==hv)return p;if(p.applyMatrix3(this.matrix),p.x<0||p.x>1)switch(this.wrapS){case uv:p.x=p.x-Math.floor(p.x);break;case m_:p.x=p.x<0?0:1;break;case dv:Math.abs(Math.floor(p.x)%2)===1?p.x=Math.ceil(p.x)-p.x:p.x=p.x-Math.floor(p.x);break}if(p.y<0||p.y>1)switch(this.wrapT){case uv:p.y=p.y-Math.floor(p.y);break;case m_:p.y=p.y<0?0:1;break;case dv:Math.abs(Math.floor(p.y)%2)===1?p.y=Math.ceil(p.y)-p.y:p.y=p.y-Math.floor(p.y);break}return this.flipY&&(p.y=1-p.y),p}set needsUpdate(p){p===!0&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(p){p===!0&&this.pmremVersion++}}_p.DEFAULT_IMAGE=null,_p.DEFAULT_MAPPING=hv,_p.DEFAULT_ANISOTROPY=1;class Jm{constructor(p=0,f=0,C=0,D=1){this.isQuaternion=!0,this._x=p,this._y=f,this._z=C,this._w=D}static slerpFlat(p,f,C,D,U,B,s){let Z=C[D+0],j=C[D+1],Q=C[D+2],oe=C[D+3];const ve=U[B+0],Ee=U[B+1],We=U[B+2],Re=U[B+3];if(s===0){p[f+0]=Z,p[f+1]=j,p[f+2]=Q,p[f+3]=oe;return}if(s===1){p[f+0]=ve,p[f+1]=Ee,p[f+2]=We,p[f+3]=Re;return}if(oe!==Re||Z!==ve||j!==Ee||Q!==We){let He=1-s;const Mt=Z*ve+j*Ee+Q*We+oe*Re,Lt=Mt>=0?1:-1,Ut=1-Mt*Mt;if(Ut>Number.EPSILON){const lt=Math.sqrt(Ut),Ct=Math.atan2(lt,Mt*Lt);He=Math.sin(He*Ct)/lt,s=Math.sin(s*Ct)/lt}const Wt=s*Lt;if(Z=Z*He+ve*Wt,j=j*He+Ee*Wt,Q=Q*He+We*Wt,oe=oe*He+Re*Wt,He===1-s){const lt=1/Math.sqrt(Z*Z+j*j+Q*Q+oe*oe);Z*=lt,j*=lt,Q*=lt,oe*=lt}}p[f]=Z,p[f+1]=j,p[f+2]=Q,p[f+3]=oe}static multiplyQuaternionsFlat(p,f,C,D,U,B){const s=C[D],Z=C[D+1],j=C[D+2],Q=C[D+3],oe=U[B],ve=U[B+1],Ee=U[B+2],We=U[B+3];return p[f]=s*We+Q*oe+Z*Ee-j*ve,p[f+1]=Z*We+Q*ve+j*oe-s*Ee,p[f+2]=j*We+Q*Ee+s*ve-Z*oe,p[f+3]=Q*We-s*oe-Z*ve-j*Ee,p}get x(){return this._x}set x(p){this._x=p,this._onChangeCallback()}get y(){return this._y}set y(p){this._y=p,this._onChangeCallback()}get z(){return this._z}set z(p){this._z=p,this._onChangeCallback()}get w(){return this._w}set w(p){this._w=p,this._onChangeCallback()}set(p,f,C,D){return this._x=p,this._y=f,this._z=C,this._w=D,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(p){return this._x=p.x,this._y=p.y,this._z=p.z,this._w=p.w,this._onChangeCallback(),this}setFromEuler(p,f=!0){const C=p._x,D=p._y,U=p._z,B=p._order,s=Math.cos,Z=Math.sin,j=s(C/2),Q=s(D/2),oe=s(U/2),ve=Z(C/2),Ee=Z(D/2),We=Z(U/2);switch(B){case"XYZ":this._x=ve*Q*oe+j*Ee*We,this._y=j*Ee*oe-ve*Q*We,this._z=j*Q*We+ve*Ee*oe,this._w=j*Q*oe-ve*Ee*We;break;case"YXZ":this._x=ve*Q*oe+j*Ee*We,this._y=j*Ee*oe-ve*Q*We,this._z=j*Q*We-ve*Ee*oe,this._w=j*Q*oe+ve*Ee*We;break;case"ZXY":this._x=ve*Q*oe-j*Ee*We,this._y=j*Ee*oe+ve*Q*We,this._z=j*Q*We+ve*Ee*oe,this._w=j*Q*oe-ve*Ee*We;break;case"ZYX":this._x=ve*Q*oe-j*Ee*We,this._y=j*Ee*oe+ve*Q*We,this._z=j*Q*We-ve*Ee*oe,this._w=j*Q*oe+ve*Ee*We;break;case"YZX":this._x=ve*Q*oe+j*Ee*We,this._y=j*Ee*oe+ve*Q*We,this._z=j*Q*We-ve*Ee*oe,this._w=j*Q*oe-ve*Ee*We;break;case"XZY":this._x=ve*Q*oe-j*Ee*We,this._y=j*Ee*oe-ve*Q*We,this._z=j*Q*We+ve*Ee*oe,this._w=j*Q*oe+ve*Ee*We;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+B)}return f===!0&&this._onChangeCallback(),this}setFromAxisAngle(p,f){const C=f/2,D=Math.sin(C);return this._x=p.x*D,this._y=p.y*D,this._z=p.z*D,this._w=Math.cos(C),this._onChangeCallback(),this}setFromRotationMatrix(p){const f=p.elements,C=f[0],D=f[4],U=f[8],B=f[1],s=f[5],Z=f[9],j=f[2],Q=f[6],oe=f[10],ve=C+s+oe;if(ve>0){const Ee=.5/Math.sqrt(ve+1);this._w=.25/Ee,this._x=(Q-Z)*Ee,this._y=(U-j)*Ee,this._z=(B-D)*Ee}else if(C>s&&C>oe){const Ee=2*Math.sqrt(1+C-s-oe);this._w=(Q-Z)/Ee,this._x=.25*Ee,this._y=(D+B)/Ee,this._z=(U+j)/Ee}else if(s>oe){const Ee=2*Math.sqrt(1+s-C-oe);this._w=(U-j)/Ee,this._x=(D+B)/Ee,this._y=.25*Ee,this._z=(Z+Q)/Ee}else{const Ee=2*Math.sqrt(1+oe-C-s);this._w=(B-D)/Ee,this._x=(U+j)/Ee,this._y=(Z+Q)/Ee,this._z=.25*Ee}return this._onChangeCallback(),this}setFromUnitVectors(p,f){let C=p.dot(f)+1;return C<Number.EPSILON?(C=0,Math.abs(p.x)>Math.abs(p.z)?(this._x=-p.y,this._y=p.x,this._z=0,this._w=C):(this._x=0,this._y=-p.z,this._z=p.y,this._w=C)):(this._x=p.y*f.z-p.z*f.y,this._y=p.z*f.x-p.x*f.z,this._z=p.x*f.y-p.y*f.x,this._w=C),this.normalize()}angleTo(p){return 2*Math.acos(Math.abs(Fa(this.dot(p),-1,1)))}rotateTowards(p,f){const C=this.angleTo(p);if(C===0)return this;const D=Math.min(1,f/C);return this.slerp(p,D),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(p){return this._x*p._x+this._y*p._y+this._z*p._z+this._w*p._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let p=this.length();return p===0?(this._x=0,this._y=0,this._z=0,this._w=1):(p=1/p,this._x=this._x*p,this._y=this._y*p,this._z=this._z*p,this._w=this._w*p),this._onChangeCallback(),this}multiply(p){return this.multiplyQuaternions(this,p)}premultiply(p){return this.multiplyQuaternions(p,this)}multiplyQuaternions(p,f){const C=p._x,D=p._y,U=p._z,B=p._w,s=f._x,Z=f._y,j=f._z,Q=f._w;return this._x=C*Q+B*s+D*j-U*Z,this._y=D*Q+B*Z+U*s-C*j,this._z=U*Q+B*j+C*Z-D*s,this._w=B*Q-C*s-D*Z-U*j,this._onChangeCallback(),this}slerp(p,f){if(f===0)return this;if(f===1)return this.copy(p);const C=this._x,D=this._y,U=this._z,B=this._w;let s=B*p._w+C*p._x+D*p._y+U*p._z;if(s<0?(this._w=-p._w,this._x=-p._x,this._y=-p._y,this._z=-p._z,s=-s):this.copy(p),s>=1)return this._w=B,this._x=C,this._y=D,this._z=U,this;const Z=1-s*s;if(Z<=Number.EPSILON){const Ee=1-f;return this._w=Ee*B+f*this._w,this._x=Ee*C+f*this._x,this._y=Ee*D+f*this._y,this._z=Ee*U+f*this._z,this.normalize(),this}const j=Math.sqrt(Z),Q=Math.atan2(j,s),oe=Math.sin((1-f)*Q)/j,ve=Math.sin(f*Q)/j;return this._w=B*oe+this._w*ve,this._x=C*oe+this._x*ve,this._y=D*oe+this._y*ve,this._z=U*oe+this._z*ve,this._onChangeCallback(),this}slerpQuaternions(p,f,C){return this.copy(p).slerp(f,C)}random(){const p=2*Math.PI*Math.random(),f=2*Math.PI*Math.random(),C=Math.random(),D=Math.sqrt(1-C),U=Math.sqrt(C);return this.set(D*Math.sin(p),D*Math.cos(p),U*Math.sin(f),U*Math.cos(f))}equals(p){return p._x===this._x&&p._y===this._y&&p._z===this._z&&p._w===this._w}fromArray(p,f=0){return this._x=p[f],this._y=p[f+1],this._z=p[f+2],this._w=p[f+3],this._onChangeCallback(),this}toArray(p=[],f=0){return p[f]=this._x,p[f+1]=this._y,p[f+2]=this._z,p[f+3]=this._w,p}fromBufferAttribute(p,f){return this._x=p.getX(f),this._y=p.getY(f),this._z=p.getZ(f),this._w=p.getW(f),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(p){return this._onChangeCallback=p,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class Pi{constructor(p=0,f=0,C=0){Pi.prototype.isVector3=!0,this.x=p,this.y=f,this.z=C}set(p,f,C){return C===void 0&&(C=this.z),this.x=p,this.y=f,this.z=C,this}setScalar(p){return this.x=p,this.y=p,this.z=p,this}setX(p){return this.x=p,this}setY(p){return this.y=p,this}setZ(p){return this.z=p,this}setComponent(p,f){switch(p){case 0:this.x=f;break;case 1:this.y=f;break;case 2:this.z=f;break;default:throw new Error("index is out of range: "+p)}return this}getComponent(p){switch(p){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+p)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(p){return this.x=p.x,this.y=p.y,this.z=p.z,this}add(p){return this.x+=p.x,this.y+=p.y,this.z+=p.z,this}addScalar(p){return this.x+=p,this.y+=p,this.z+=p,this}addVectors(p,f){return this.x=p.x+f.x,this.y=p.y+f.y,this.z=p.z+f.z,this}addScaledVector(p,f){return this.x+=p.x*f,this.y+=p.y*f,this.z+=p.z*f,this}sub(p){return this.x-=p.x,this.y-=p.y,this.z-=p.z,this}subScalar(p){return this.x-=p,this.y-=p,this.z-=p,this}subVectors(p,f){return this.x=p.x-f.x,this.y=p.y-f.y,this.z=p.z-f.z,this}multiply(p){return this.x*=p.x,this.y*=p.y,this.z*=p.z,this}multiplyScalar(p){return this.x*=p,this.y*=p,this.z*=p,this}multiplyVectors(p,f){return this.x=p.x*f.x,this.y=p.y*f.y,this.z=p.z*f.z,this}applyEuler(p){return this.applyQuaternion(Sv.setFromEuler(p))}applyAxisAngle(p,f){return this.applyQuaternion(Sv.setFromAxisAngle(p,f))}applyMatrix3(p){const f=this.x,C=this.y,D=this.z,U=p.elements;return this.x=U[0]*f+U[3]*C+U[6]*D,this.y=U[1]*f+U[4]*C+U[7]*D,this.z=U[2]*f+U[5]*C+U[8]*D,this}applyNormalMatrix(p){return this.applyMatrix3(p).normalize()}applyMatrix4(p){const f=this.x,C=this.y,D=this.z,U=p.elements,B=1/(U[3]*f+U[7]*C+U[11]*D+U[15]);return this.x=(U[0]*f+U[4]*C+U[8]*D+U[12])*B,this.y=(U[1]*f+U[5]*C+U[9]*D+U[13])*B,this.z=(U[2]*f+U[6]*C+U[10]*D+U[14])*B,this}applyQuaternion(p){const f=this.x,C=this.y,D=this.z,U=p.x,B=p.y,s=p.z,Z=p.w,j=2*(B*D-s*C),Q=2*(s*f-U*D),oe=2*(U*C-B*f);return this.x=f+Z*j+B*oe-s*Q,this.y=C+Z*Q+s*j-U*oe,this.z=D+Z*oe+U*Q-B*j,this}project(p){return this.applyMatrix4(p.matrixWorldInverse).applyMatrix4(p.projectionMatrix)}unproject(p){return this.applyMatrix4(p.projectionMatrixInverse).applyMatrix4(p.matrixWorld)}transformDirection(p){const f=this.x,C=this.y,D=this.z,U=p.elements;return this.x=U[0]*f+U[4]*C+U[8]*D,this.y=U[1]*f+U[5]*C+U[9]*D,this.z=U[2]*f+U[6]*C+U[10]*D,this.normalize()}divide(p){return this.x/=p.x,this.y/=p.y,this.z/=p.z,this}divideScalar(p){return this.multiplyScalar(1/p)}min(p){return this.x=Math.min(this.x,p.x),this.y=Math.min(this.y,p.y),this.z=Math.min(this.z,p.z),this}max(p){return this.x=Math.max(this.x,p.x),this.y=Math.max(this.y,p.y),this.z=Math.max(this.z,p.z),this}clamp(p,f){return this.x=Math.max(p.x,Math.min(f.x,this.x)),this.y=Math.max(p.y,Math.min(f.y,this.y)),this.z=Math.max(p.z,Math.min(f.z,this.z)),this}clampScalar(p,f){return this.x=Math.max(p,Math.min(f,this.x)),this.y=Math.max(p,Math.min(f,this.y)),this.z=Math.max(p,Math.min(f,this.z)),this}clampLength(p,f){const C=this.length();return this.divideScalar(C||1).multiplyScalar(Math.max(p,Math.min(f,C)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(p){return this.x*p.x+this.y*p.y+this.z*p.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(p){return this.normalize().multiplyScalar(p)}lerp(p,f){return this.x+=(p.x-this.x)*f,this.y+=(p.y-this.y)*f,this.z+=(p.z-this.z)*f,this}lerpVectors(p,f,C){return this.x=p.x+(f.x-p.x)*C,this.y=p.y+(f.y-p.y)*C,this.z=p.z+(f.z-p.z)*C,this}cross(p){return this.crossVectors(this,p)}crossVectors(p,f){const C=p.x,D=p.y,U=p.z,B=f.x,s=f.y,Z=f.z;return this.x=D*Z-U*s,this.y=U*B-C*Z,this.z=C*s-D*B,this}projectOnVector(p){const f=p.lengthSq();if(f===0)return this.set(0,0,0);const C=p.dot(this)/f;return this.copy(p).multiplyScalar(C)}projectOnPlane(p){return p0.copy(this).projectOnVector(p),this.sub(p0)}reflect(p){return this.sub(p0.copy(p).multiplyScalar(2*this.dot(p)))}angleTo(p){const f=Math.sqrt(this.lengthSq()*p.lengthSq());if(f===0)return Math.PI/2;const C=this.dot(p)/f;return Math.acos(Fa(C,-1,1))}distanceTo(p){return Math.sqrt(this.distanceToSquared(p))}distanceToSquared(p){const f=this.x-p.x,C=this.y-p.y,D=this.z-p.z;return f*f+C*C+D*D}manhattanDistanceTo(p){return Math.abs(this.x-p.x)+Math.abs(this.y-p.y)+Math.abs(this.z-p.z)}setFromSpherical(p){return this.setFromSphericalCoords(p.radius,p.phi,p.theta)}setFromSphericalCoords(p,f,C){const D=Math.sin(f)*p;return this.x=D*Math.sin(C),this.y=Math.cos(f)*p,this.z=D*Math.cos(C),this}setFromCylindrical(p){return this.setFromCylindricalCoords(p.radius,p.theta,p.y)}setFromCylindricalCoords(p,f,C){return this.x=p*Math.sin(f),this.y=C,this.z=p*Math.cos(f),this}setFromMatrixPosition(p){const f=p.elements;return this.x=f[12],this.y=f[13],this.z=f[14],this}setFromMatrixScale(p){const f=this.setFromMatrixColumn(p,0).length(),C=this.setFromMatrixColumn(p,1).length(),D=this.setFromMatrixColumn(p,2).length();return this.x=f,this.y=C,this.z=D,this}setFromMatrixColumn(p,f){return this.fromArray(p.elements,f*4)}setFromMatrix3Column(p,f){return this.fromArray(p.elements,f*3)}setFromEuler(p){return this.x=p._x,this.y=p._y,this.z=p._z,this}setFromColor(p){return this.x=p.r,this.y=p.g,this.z=p.b,this}equals(p){return p.x===this.x&&p.y===this.y&&p.z===this.z}fromArray(p,f=0){return this.x=p[f],this.y=p[f+1],this.z=p[f+2],this}toArray(p=[],f=0){return p[f]=this.x,p[f+1]=this.y,p[f+2]=this.z,p}fromBufferAttribute(p,f){return this.x=p.getX(f),this.y=p.getY(f),this.z=p.getZ(f),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const p=Math.random()*Math.PI*2,f=Math.random()*2-1,C=Math.sqrt(1-f*f);return this.x=C*Math.cos(p),this.y=f,this.z=C*Math.sin(p),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const p0=new Pi,Sv=new Jm;class Km{constructor(p=new Pi(1/0,1/0,1/0),f=new Pi(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=p,this.max=f}set(p,f){return this.min.copy(p),this.max.copy(f),this}setFromArray(p){this.makeEmpty();for(let f=0,C=p.length;f<C;f+=3)this.expandByPoint(Qc.fromArray(p,f));return this}setFromBufferAttribute(p){this.makeEmpty();for(let f=0,C=p.count;f<C;f++)this.expandByPoint(Qc.fromBufferAttribute(p,f));return this}setFromPoints(p){this.makeEmpty();for(let f=0,C=p.length;f<C;f++)this.expandByPoint(p[f]);return this}setFromCenterAndSize(p,f){const C=Qc.copy(f).multiplyScalar(.5);return this.min.copy(p).sub(C),this.max.copy(p).add(C),this}setFromObject(p,f=!1){return this.makeEmpty(),this.expandByObject(p,f)}clone(){return new this.constructor().copy(this)}copy(p){return this.min.copy(p.min),this.max.copy(p.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(p){return this.isEmpty()?p.set(0,0,0):p.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(p){return this.isEmpty()?p.set(0,0,0):p.subVectors(this.max,this.min)}expandByPoint(p){return this.min.min(p),this.max.max(p),this}expandByVector(p){return this.min.sub(p),this.max.add(p),this}expandByScalar(p){return this.min.addScalar(-p),this.max.addScalar(p),this}expandByObject(p,f=!1){p.updateWorldMatrix(!1,!1);const C=p.geometry;if(C!==void 0){const U=C.getAttribute("position");if(f===!0&&U!==void 0&&p.isInstancedMesh!==!0)for(let B=0,s=U.count;B<s;B++)p.isMesh===!0?p.getVertexPosition(B,Qc):Qc.fromBufferAttribute(U,B),Qc.applyMatrix4(p.matrixWorld),this.expandByPoint(Qc);else p.boundingBox!==void 0?(p.boundingBox===null&&p.computeBoundingBox(),x_.copy(p.boundingBox)):(C.boundingBox===null&&C.computeBoundingBox(),x_.copy(C.boundingBox)),x_.applyMatrix4(p.matrixWorld),this.union(x_)}const D=p.children;for(let U=0,B=D.length;U<B;U++)this.expandByObject(D[U],f);return this}containsPoint(p){return!(p.x<this.min.x||p.x>this.max.x||p.y<this.min.y||p.y>this.max.y||p.z<this.min.z||p.z>this.max.z)}containsBox(p){return this.min.x<=p.min.x&&p.max.x<=this.max.x&&this.min.y<=p.min.y&&p.max.y<=this.max.y&&this.min.z<=p.min.z&&p.max.z<=this.max.z}getParameter(p,f){return f.set((p.x-this.min.x)/(this.max.x-this.min.x),(p.y-this.min.y)/(this.max.y-this.min.y),(p.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(p){return!(p.max.x<this.min.x||p.min.x>this.max.x||p.max.y<this.min.y||p.min.y>this.max.y||p.max.z<this.min.z||p.min.z>this.max.z)}intersectsSphere(p){return this.clampPoint(p.center,Qc),Qc.distanceToSquared(p.center)<=p.radius*p.radius}intersectsPlane(p){let f,C;return p.normal.x>0?(f=p.normal.x*this.min.x,C=p.normal.x*this.max.x):(f=p.normal.x*this.max.x,C=p.normal.x*this.min.x),p.normal.y>0?(f+=p.normal.y*this.min.y,C+=p.normal.y*this.max.y):(f+=p.normal.y*this.max.y,C+=p.normal.y*this.min.y),p.normal.z>0?(f+=p.normal.z*this.min.z,C+=p.normal.z*this.max.z):(f+=p.normal.z*this.max.z,C+=p.normal.z*this.min.z),f<=-p.constant&&C>=-p.constant}intersectsTriangle(p){if(this.isEmpty())return!1;this.getCenter(Qm),v_.subVectors(this.max,Qm),Sf.subVectors(p.a,Qm),Ef.subVectors(p.b,Qm),Af.subVectors(p.c,Qm),yd.subVectors(Ef,Sf),xd.subVectors(Af,Ef),yp.subVectors(Sf,Af);let f=[0,-yd.z,yd.y,0,-xd.z,xd.y,0,-yp.z,yp.y,yd.z,0,-yd.x,xd.z,0,-xd.x,yp.z,0,-yp.x,-yd.y,yd.x,0,-xd.y,xd.x,0,-yp.y,yp.x,0];return!f0(f,Sf,Ef,Af,v_)||(f=[1,0,0,0,1,0,0,0,1],!f0(f,Sf,Ef,Af,v_))?!1:(b_.crossVectors(yd,xd),f=[b_.x,b_.y,b_.z],f0(f,Sf,Ef,Af,v_))}clampPoint(p,f){return f.copy(p).clamp(this.min,this.max)}distanceToPoint(p){return this.clampPoint(p,Qc).distanceTo(p)}getBoundingSphere(p){return this.isEmpty()?p.makeEmpty():(this.getCenter(p.center),p.radius=this.getSize(Qc).length()*.5),p}intersect(p){return this.min.max(p.min),this.max.min(p.max),this.isEmpty()&&this.makeEmpty(),this}union(p){return this.min.min(p.min),this.max.max(p.max),this}applyMatrix4(p){return this.isEmpty()?this:(vu[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(p),vu[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(p),vu[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(p),vu[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(p),vu[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(p),vu[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(p),vu[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(p),vu[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(p),this.setFromPoints(vu),this)}translate(p){return this.min.add(p),this.max.add(p),this}equals(p){return p.min.equals(this.min)&&p.max.equals(this.max)}}const vu=[new Pi,new Pi,new Pi,new Pi,new Pi,new Pi,new Pi,new Pi],Qc=new Pi,x_=new Km,Sf=new Pi,Ef=new Pi,Af=new Pi,yd=new Pi,xd=new Pi,yp=new Pi,Qm=new Pi,v_=new Pi,b_=new Pi,xp=new Pi;function f0(te,p,f,C,D){for(let U=0,B=te.length-3;U<=B;U+=3){xp.fromArray(te,U);const s=D.x*Math.abs(xp.x)+D.y*Math.abs(xp.y)+D.z*Math.abs(xp.z),Z=p.dot(xp),j=f.dot(xp),Q=C.dot(xp);if(Math.max(-Math.max(Z,j,Q),Math.min(Z,j,Q))>s)return!1}return!0}const dE=new Km,eg=new Pi,m0=new Pi;class g0{constructor(p=new Pi,f=-1){this.isSphere=!0,this.center=p,this.radius=f}set(p,f){return this.center.copy(p),this.radius=f,this}setFromPoints(p,f){const C=this.center;f!==void 0?C.copy(f):dE.setFromPoints(p).getCenter(C);let D=0;for(let U=0,B=p.length;U<B;U++)D=Math.max(D,C.distanceToSquared(p[U]));return this.radius=Math.sqrt(D),this}copy(p){return this.center.copy(p.center),this.radius=p.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(p){return p.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(p){return p.distanceTo(this.center)-this.radius}intersectsSphere(p){const f=this.radius+p.radius;return p.center.distanceToSquared(this.center)<=f*f}intersectsBox(p){return p.intersectsSphere(this)}intersectsPlane(p){return Math.abs(p.distanceToPoint(this.center))<=this.radius}clampPoint(p,f){const C=this.center.distanceToSquared(p);return f.copy(p),C>this.radius*this.radius&&(f.sub(this.center).normalize(),f.multiplyScalar(this.radius).add(this.center)),f}getBoundingBox(p){return this.isEmpty()?(p.makeEmpty(),p):(p.set(this.center,this.center),p.expandByScalar(this.radius),p)}applyMatrix4(p){return this.center.applyMatrix4(p),this.radius=this.radius*p.getMaxScaleOnAxis(),this}translate(p){return this.center.add(p),this}expandByPoint(p){if(this.isEmpty())return this.center.copy(p),this.radius=0,this;eg.subVectors(p,this.center);const f=eg.lengthSq();if(f>this.radius*this.radius){const C=Math.sqrt(f),D=(C-this.radius)*.5;this.center.addScaledVector(eg,D/C),this.radius+=D}return this}union(p){return p.isEmpty()?this:this.isEmpty()?(this.copy(p),this):(this.center.equals(p.center)===!0?this.radius=Math.max(this.radius,p.radius):(m0.subVectors(p.center,this.center).setLength(p.radius),this.expandByPoint(eg.copy(p.center).add(m0)),this.expandByPoint(eg.copy(p.center).sub(m0))),this)}equals(p){return p.center.equals(this.center)&&p.radius===this.radius}clone(){return new this.constructor().copy(this)}}const bu=new Pi,_0=new Pi,w_=new Pi,vd=new Pi,y0=new Pi,M_=new Pi,x0=new Pi;class Ev{constructor(p=new Pi,f=new Pi(0,0,-1)){this.origin=p,this.direction=f}set(p,f){return this.origin.copy(p),this.direction.copy(f),this}copy(p){return this.origin.copy(p.origin),this.direction.copy(p.direction),this}at(p,f){return f.copy(this.origin).addScaledVector(this.direction,p)}lookAt(p){return this.direction.copy(p).sub(this.origin).normalize(),this}recast(p){return this.origin.copy(this.at(p,bu)),this}closestPointToPoint(p,f){f.subVectors(p,this.origin);const C=f.dot(this.direction);return C<0?f.copy(this.origin):f.copy(this.origin).addScaledVector(this.direction,C)}distanceToPoint(p){return Math.sqrt(this.distanceSqToPoint(p))}distanceSqToPoint(p){const f=bu.subVectors(p,this.origin).dot(this.direction);return f<0?this.origin.distanceToSquared(p):(bu.copy(this.origin).addScaledVector(this.direction,f),bu.distanceToSquared(p))}distanceSqToSegment(p,f,C,D){_0.copy(p).add(f).multiplyScalar(.5),w_.copy(f).sub(p).normalize(),vd.copy(this.origin).sub(_0);const U=p.distanceTo(f)*.5,B=-this.direction.dot(w_),s=vd.dot(this.direction),Z=-vd.dot(w_),j=vd.lengthSq(),Q=Math.abs(1-B*B);let oe,ve,Ee,We;if(Q>0)if(oe=B*Z-s,ve=B*s-Z,We=U*Q,oe>=0)if(ve>=-We)if(ve<=We){const Re=1/Q;oe*=Re,ve*=Re,Ee=oe*(oe+B*ve+2*s)+ve*(B*oe+ve+2*Z)+j}else ve=U,oe=Math.max(0,-(B*ve+s)),Ee=-oe*oe+ve*(ve+2*Z)+j;else ve=-U,oe=Math.max(0,-(B*ve+s)),Ee=-oe*oe+ve*(ve+2*Z)+j;else ve<=-We?(oe=Math.max(0,-(-B*U+s)),ve=oe>0?-U:Math.min(Math.max(-U,-Z),U),Ee=-oe*oe+ve*(ve+2*Z)+j):ve<=We?(oe=0,ve=Math.min(Math.max(-U,-Z),U),Ee=ve*(ve+2*Z)+j):(oe=Math.max(0,-(B*U+s)),ve=oe>0?U:Math.min(Math.max(-U,-Z),U),Ee=-oe*oe+ve*(ve+2*Z)+j);else ve=B>0?-U:U,oe=Math.max(0,-(B*ve+s)),Ee=-oe*oe+ve*(ve+2*Z)+j;return C&&C.copy(this.origin).addScaledVector(this.direction,oe),D&&D.copy(_0).addScaledVector(w_,ve),Ee}intersectSphere(p,f){bu.subVectors(p.center,this.origin);const C=bu.dot(this.direction),D=bu.dot(bu)-C*C,U=p.radius*p.radius;if(D>U)return null;const B=Math.sqrt(U-D),s=C-B,Z=C+B;return Z<0?null:s<0?this.at(Z,f):this.at(s,f)}intersectsSphere(p){return this.distanceSqToPoint(p.center)<=p.radius*p.radius}distanceToPlane(p){const f=p.normal.dot(this.direction);if(f===0)return p.distanceToPoint(this.origin)===0?0:null;const C=-(this.origin.dot(p.normal)+p.constant)/f;return C>=0?C:null}intersectPlane(p,f){const C=this.distanceToPlane(p);return C===null?null:this.at(C,f)}intersectsPlane(p){const f=p.distanceToPoint(this.origin);return f===0||p.normal.dot(this.direction)*f<0}intersectBox(p,f){let C,D,U,B,s,Z;const j=1/this.direction.x,Q=1/this.direction.y,oe=1/this.direction.z,ve=this.origin;return j>=0?(C=(p.min.x-ve.x)*j,D=(p.max.x-ve.x)*j):(C=(p.max.x-ve.x)*j,D=(p.min.x-ve.x)*j),Q>=0?(U=(p.min.y-ve.y)*Q,B=(p.max.y-ve.y)*Q):(U=(p.max.y-ve.y)*Q,B=(p.min.y-ve.y)*Q),C>B||U>D||((U>C||isNaN(C))&&(C=U),(B<D||isNaN(D))&&(D=B),oe>=0?(s=(p.min.z-ve.z)*oe,Z=(p.max.z-ve.z)*oe):(s=(p.max.z-ve.z)*oe,Z=(p.min.z-ve.z)*oe),C>Z||s>D)||((s>C||C!==C)&&(C=s),(Z<D||D!==D)&&(D=Z),D<0)?null:this.at(C>=0?C:D,f)}intersectsBox(p){return this.intersectBox(p,bu)!==null}intersectTriangle(p,f,C,D,U){y0.subVectors(f,p),M_.subVectors(C,p),x0.crossVectors(y0,M_);let B=this.direction.dot(x0),s;if(B>0){if(D)return null;s=1}else if(B<0)s=-1,B=-B;else return null;vd.subVectors(this.origin,p);const Z=s*this.direction.dot(M_.crossVectors(vd,M_));if(Z<0)return null;const j=s*this.direction.dot(y0.cross(vd));if(j<0||Z+j>B)return null;const Q=-s*vd.dot(x0);return Q<0?null:this.at(Q/B,U)}applyMatrix4(p){return this.origin.applyMatrix4(p),this.direction.transformDirection(p),this}equals(p){return p.origin.equals(this.origin)&&p.direction.equals(this.direction)}clone(){return new this.constructor().copy(this)}}class Xl{constructor(p,f,C,D,U,B,s,Z,j,Q,oe,ve,Ee,We,Re,He){Xl.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],p!==void 0&&this.set(p,f,C,D,U,B,s,Z,j,Q,oe,ve,Ee,We,Re,He)}set(p,f,C,D,U,B,s,Z,j,Q,oe,ve,Ee,We,Re,He){const Mt=this.elements;return Mt[0]=p,Mt[4]=f,Mt[8]=C,Mt[12]=D,Mt[1]=U,Mt[5]=B,Mt[9]=s,Mt[13]=Z,Mt[2]=j,Mt[6]=Q,Mt[10]=oe,Mt[14]=ve,Mt[3]=Ee,Mt[7]=We,Mt[11]=Re,Mt[15]=He,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return new Xl().fromArray(this.elements)}copy(p){const f=this.elements,C=p.elements;return f[0]=C[0],f[1]=C[1],f[2]=C[2],f[3]=C[3],f[4]=C[4],f[5]=C[5],f[6]=C[6],f[7]=C[7],f[8]=C[8],f[9]=C[9],f[10]=C[10],f[11]=C[11],f[12]=C[12],f[13]=C[13],f[14]=C[14],f[15]=C[15],this}copyPosition(p){const f=this.elements,C=p.elements;return f[12]=C[12],f[13]=C[13],f[14]=C[14],this}setFromMatrix3(p){const f=p.elements;return this.set(f[0],f[3],f[6],0,f[1],f[4],f[7],0,f[2],f[5],f[8],0,0,0,0,1),this}extractBasis(p,f,C){return p.setFromMatrixColumn(this,0),f.setFromMatrixColumn(this,1),C.setFromMatrixColumn(this,2),this}makeBasis(p,f,C){return this.set(p.x,f.x,C.x,0,p.y,f.y,C.y,0,p.z,f.z,C.z,0,0,0,0,1),this}extractRotation(p){const f=this.elements,C=p.elements,D=1/Cf.setFromMatrixColumn(p,0).length(),U=1/Cf.setFromMatrixColumn(p,1).length(),B=1/Cf.setFromMatrixColumn(p,2).length();return f[0]=C[0]*D,f[1]=C[1]*D,f[2]=C[2]*D,f[3]=0,f[4]=C[4]*U,f[5]=C[5]*U,f[6]=C[6]*U,f[7]=0,f[8]=C[8]*B,f[9]=C[9]*B,f[10]=C[10]*B,f[11]=0,f[12]=0,f[13]=0,f[14]=0,f[15]=1,this}makeRotationFromEuler(p){const f=this.elements,C=p.x,D=p.y,U=p.z,B=Math.cos(C),s=Math.sin(C),Z=Math.cos(D),j=Math.sin(D),Q=Math.cos(U),oe=Math.sin(U);if(p.order==="XYZ"){const ve=B*Q,Ee=B*oe,We=s*Q,Re=s*oe;f[0]=Z*Q,f[4]=-Z*oe,f[8]=j,f[1]=Ee+We*j,f[5]=ve-Re*j,f[9]=-s*Z,f[2]=Re-ve*j,f[6]=We+Ee*j,f[10]=B*Z}else if(p.order==="YXZ"){const ve=Z*Q,Ee=Z*oe,We=j*Q,Re=j*oe;f[0]=ve+Re*s,f[4]=We*s-Ee,f[8]=B*j,f[1]=B*oe,f[5]=B*Q,f[9]=-s,f[2]=Ee*s-We,f[6]=Re+ve*s,f[10]=B*Z}else if(p.order==="ZXY"){const ve=Z*Q,Ee=Z*oe,We=j*Q,Re=j*oe;f[0]=ve-Re*s,f[4]=-B*oe,f[8]=We+Ee*s,f[1]=Ee+We*s,f[5]=B*Q,f[9]=Re-ve*s,f[2]=-B*j,f[6]=s,f[10]=B*Z}else if(p.order==="ZYX"){const ve=B*Q,Ee=B*oe,We=s*Q,Re=s*oe;f[0]=Z*Q,f[4]=We*j-Ee,f[8]=ve*j+Re,f[1]=Z*oe,f[5]=Re*j+ve,f[9]=Ee*j-We,f[2]=-j,f[6]=s*Z,f[10]=B*Z}else if(p.order==="YZX"){const ve=B*Z,Ee=B*j,We=s*Z,Re=s*j;f[0]=Z*Q,f[4]=Re-ve*oe,f[8]=We*oe+Ee,f[1]=oe,f[5]=B*Q,f[9]=-s*Q,f[2]=-j*Q,f[6]=Ee*oe+We,f[10]=ve-Re*oe}else if(p.order==="XZY"){const ve=B*Z,Ee=B*j,We=s*Z,Re=s*j;f[0]=Z*Q,f[4]=-oe,f[8]=j*Q,f[1]=ve*oe+Re,f[5]=B*Q,f[9]=Ee*oe-We,f[2]=We*oe-Ee,f[6]=s*Q,f[10]=Re*oe+ve}return f[3]=0,f[7]=0,f[11]=0,f[12]=0,f[13]=0,f[14]=0,f[15]=1,this}makeRotationFromQuaternion(p){return this.compose(pE,p,fE)}lookAt(p,f,C){const D=this.elements;return $l.subVectors(p,f),$l.lengthSq()===0&&($l.z=1),$l.normalize(),bd.crossVectors(C,$l),bd.lengthSq()===0&&(Math.abs(C.z)===1?$l.x+=1e-4:$l.z+=1e-4,$l.normalize(),bd.crossVectors(C,$l)),bd.normalize(),T_.crossVectors($l,bd),D[0]=bd.x,D[4]=T_.x,D[8]=$l.x,D[1]=bd.y,D[5]=T_.y,D[9]=$l.y,D[2]=bd.z,D[6]=T_.z,D[10]=$l.z,this}multiply(p){return this.multiplyMatrices(this,p)}premultiply(p){return this.multiplyMatrices(p,this)}multiplyMatrices(p,f){const C=p.elements,D=f.elements,U=this.elements,B=C[0],s=C[4],Z=C[8],j=C[12],Q=C[1],oe=C[5],ve=C[9],Ee=C[13],We=C[2],Re=C[6],He=C[10],Mt=C[14],Lt=C[3],Ut=C[7],Wt=C[11],lt=C[15],Ct=D[0],qt=D[4],Ai=D[8],Ni=D[12],Qe=D[1],st=D[5],Ht=D[9],en=D[13],ci=D[2],ae=D[6],ye=D[10],Se=D[14],Pe=D[3],je=D[7],Et=D[11],_t=D[15];return U[0]=B*Ct+s*Qe+Z*ci+j*Pe,U[4]=B*qt+s*st+Z*ae+j*je,U[8]=B*Ai+s*Ht+Z*ye+j*Et,U[12]=B*Ni+s*en+Z*Se+j*_t,U[1]=Q*Ct+oe*Qe+ve*ci+Ee*Pe,U[5]=Q*qt+oe*st+ve*ae+Ee*je,U[9]=Q*Ai+oe*Ht+ve*ye+Ee*Et,U[13]=Q*Ni+oe*en+ve*Se+Ee*_t,U[2]=We*Ct+Re*Qe+He*ci+Mt*Pe,U[6]=We*qt+Re*st+He*ae+Mt*je,U[10]=We*Ai+Re*Ht+He*ye+Mt*Et,U[14]=We*Ni+Re*en+He*Se+Mt*_t,U[3]=Lt*Ct+Ut*Qe+Wt*ci+lt*Pe,U[7]=Lt*qt+Ut*st+Wt*ae+lt*je,U[11]=Lt*Ai+Ut*Ht+Wt*ye+lt*Et,U[15]=Lt*Ni+Ut*en+Wt*Se+lt*_t,this}multiplyScalar(p){const f=this.elements;return f[0]*=p,f[4]*=p,f[8]*=p,f[12]*=p,f[1]*=p,f[5]*=p,f[9]*=p,f[13]*=p,f[2]*=p,f[6]*=p,f[10]*=p,f[14]*=p,f[3]*=p,f[7]*=p,f[11]*=p,f[15]*=p,this}determinant(){const p=this.elements,f=p[0],C=p[4],D=p[8],U=p[12],B=p[1],s=p[5],Z=p[9],j=p[13],Q=p[2],oe=p[6],ve=p[10],Ee=p[14],We=p[3],Re=p[7],He=p[11],Mt=p[15];return We*(+U*Z*oe-D*j*oe-U*s*ve+C*j*ve+D*s*Ee-C*Z*Ee)+Re*(+f*Z*Ee-f*j*ve+U*B*ve-D*B*Ee+D*j*Q-U*Z*Q)+He*(+f*j*oe-f*s*Ee-U*B*oe+C*B*Ee+U*s*Q-C*j*Q)+Mt*(-D*s*Q-f*Z*oe+f*s*ve+D*B*oe-C*B*ve+C*Z*Q)}transpose(){const p=this.elements;let f;return f=p[1],p[1]=p[4],p[4]=f,f=p[2],p[2]=p[8],p[8]=f,f=p[6],p[6]=p[9],p[9]=f,f=p[3],p[3]=p[12],p[12]=f,f=p[7],p[7]=p[13],p[13]=f,f=p[11],p[11]=p[14],p[14]=f,this}setPosition(p,f,C){const D=this.elements;return p.isVector3?(D[12]=p.x,D[13]=p.y,D[14]=p.z):(D[12]=p,D[13]=f,D[14]=C),this}invert(){const p=this.elements,f=p[0],C=p[1],D=p[2],U=p[3],B=p[4],s=p[5],Z=p[6],j=p[7],Q=p[8],oe=p[9],ve=p[10],Ee=p[11],We=p[12],Re=p[13],He=p[14],Mt=p[15],Lt=oe*He*j-Re*ve*j+Re*Z*Ee-s*He*Ee-oe*Z*Mt+s*ve*Mt,Ut=We*ve*j-Q*He*j-We*Z*Ee+B*He*Ee+Q*Z*Mt-B*ve*Mt,Wt=Q*Re*j-We*oe*j+We*s*Ee-B*Re*Ee-Q*s*Mt+B*oe*Mt,lt=We*oe*Z-Q*Re*Z-We*s*ve+B*Re*ve+Q*s*He-B*oe*He,Ct=f*Lt+C*Ut+D*Wt+U*lt;if(Ct===0)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const qt=1/Ct;return p[0]=Lt*qt,p[1]=(Re*ve*U-oe*He*U-Re*D*Ee+C*He*Ee+oe*D*Mt-C*ve*Mt)*qt,p[2]=(s*He*U-Re*Z*U+Re*D*j-C*He*j-s*D*Mt+C*Z*Mt)*qt,p[3]=(oe*Z*U-s*ve*U-oe*D*j+C*ve*j+s*D*Ee-C*Z*Ee)*qt,p[4]=Ut*qt,p[5]=(Q*He*U-We*ve*U+We*D*Ee-f*He*Ee-Q*D*Mt+f*ve*Mt)*qt,p[6]=(We*Z*U-B*He*U-We*D*j+f*He*j+B*D*Mt-f*Z*Mt)*qt,p[7]=(B*ve*U-Q*Z*U+Q*D*j-f*ve*j-B*D*Ee+f*Z*Ee)*qt,p[8]=Wt*qt,p[9]=(We*oe*U-Q*Re*U-We*C*Ee+f*Re*Ee+Q*C*Mt-f*oe*Mt)*qt,p[10]=(B*Re*U-We*s*U+We*C*j-f*Re*j-B*C*Mt+f*s*Mt)*qt,p[11]=(Q*s*U-B*oe*U-Q*C*j+f*oe*j+B*C*Ee-f*s*Ee)*qt,p[12]=lt*qt,p[13]=(Q*Re*D-We*oe*D+We*C*ve-f*Re*ve-Q*C*He+f*oe*He)*qt,p[14]=(We*s*D-B*Re*D-We*C*Z+f*Re*Z+B*C*He-f*s*He)*qt,p[15]=(B*oe*D-Q*s*D+Q*C*Z-f*oe*Z-B*C*ve+f*s*ve)*qt,this}scale(p){const f=this.elements,C=p.x,D=p.y,U=p.z;return f[0]*=C,f[4]*=D,f[8]*=U,f[1]*=C,f[5]*=D,f[9]*=U,f[2]*=C,f[6]*=D,f[10]*=U,f[3]*=C,f[7]*=D,f[11]*=U,this}getMaxScaleOnAxis(){const p=this.elements,f=p[0]*p[0]+p[1]*p[1]+p[2]*p[2],C=p[4]*p[4]+p[5]*p[5]+p[6]*p[6],D=p[8]*p[8]+p[9]*p[9]+p[10]*p[10];return Math.sqrt(Math.max(f,C,D))}makeTranslation(p,f,C){return p.isVector3?this.set(1,0,0,p.x,0,1,0,p.y,0,0,1,p.z,0,0,0,1):this.set(1,0,0,p,0,1,0,f,0,0,1,C,0,0,0,1),this}makeRotationX(p){const f=Math.cos(p),C=Math.sin(p);return this.set(1,0,0,0,0,f,-C,0,0,C,f,0,0,0,0,1),this}makeRotationY(p){const f=Math.cos(p),C=Math.sin(p);return this.set(f,0,C,0,0,1,0,0,-C,0,f,0,0,0,0,1),this}makeRotationZ(p){const f=Math.cos(p),C=Math.sin(p);return this.set(f,-C,0,0,C,f,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(p,f){const C=Math.cos(f),D=Math.sin(f),U=1-C,B=p.x,s=p.y,Z=p.z,j=U*B,Q=U*s;return this.set(j*B+C,j*s-D*Z,j*Z+D*s,0,j*s+D*Z,Q*s+C,Q*Z-D*B,0,j*Z-D*s,Q*Z+D*B,U*Z*Z+C,0,0,0,0,1),this}makeScale(p,f,C){return this.set(p,0,0,0,0,f,0,0,0,0,C,0,0,0,0,1),this}makeShear(p,f,C,D,U,B){return this.set(1,C,U,0,p,1,B,0,f,D,1,0,0,0,0,1),this}compose(p,f,C){const D=this.elements,U=f._x,B=f._y,s=f._z,Z=f._w,j=U+U,Q=B+B,oe=s+s,ve=U*j,Ee=U*Q,We=U*oe,Re=B*Q,He=B*oe,Mt=s*oe,Lt=Z*j,Ut=Z*Q,Wt=Z*oe,lt=C.x,Ct=C.y,qt=C.z;return D[0]=(1-(Re+Mt))*lt,D[1]=(Ee+Wt)*lt,D[2]=(We-Ut)*lt,D[3]=0,D[4]=(Ee-Wt)*Ct,D[5]=(1-(ve+Mt))*Ct,D[6]=(He+Lt)*Ct,D[7]=0,D[8]=(We+Ut)*qt,D[9]=(He-Lt)*qt,D[10]=(1-(ve+Re))*qt,D[11]=0,D[12]=p.x,D[13]=p.y,D[14]=p.z,D[15]=1,this}decompose(p,f,C){const D=this.elements;let U=Cf.set(D[0],D[1],D[2]).length();const B=Cf.set(D[4],D[5],D[6]).length(),s=Cf.set(D[8],D[9],D[10]).length();this.determinant()<0&&(U=-U),p.x=D[12],p.y=D[13],p.z=D[14],eh.copy(this);const j=1/U,Q=1/B,oe=1/s;return eh.elements[0]*=j,eh.elements[1]*=j,eh.elements[2]*=j,eh.elements[4]*=Q,eh.elements[5]*=Q,eh.elements[6]*=Q,eh.elements[8]*=oe,eh.elements[9]*=oe,eh.elements[10]*=oe,f.setFromRotationMatrix(eh),C.x=U,C.y=B,C.z=s,this}makePerspective(p,f,C,D,U,B,s=g_){const Z=this.elements,j=2*U/(f-p),Q=2*U/(C-D),oe=(f+p)/(f-p),ve=(C+D)/(C-D);let Ee,We;if(s===g_)Ee=-(B+U)/(B-U),We=-2*B*U/(B-U);else if(s===vv)Ee=-B/(B-U),We=-B*U/(B-U);else throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+s);return Z[0]=j,Z[4]=0,Z[8]=oe,Z[12]=0,Z[1]=0,Z[5]=Q,Z[9]=ve,Z[13]=0,Z[2]=0,Z[6]=0,Z[10]=Ee,Z[14]=We,Z[3]=0,Z[7]=0,Z[11]=-1,Z[15]=0,this}makeOrthographic(p,f,C,D,U,B,s=g_){const Z=this.elements,j=1/(f-p),Q=1/(C-D),oe=1/(B-U),ve=(f+p)*j,Ee=(C+D)*Q;let We,Re;if(s===g_)We=(B+U)*oe,Re=-2*oe;else if(s===vv)We=U*oe,Re=-1*oe;else throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+s);return Z[0]=2*j,Z[4]=0,Z[8]=0,Z[12]=-ve,Z[1]=0,Z[5]=2*Q,Z[9]=0,Z[13]=-Ee,Z[2]=0,Z[6]=0,Z[10]=Re,Z[14]=-We,Z[3]=0,Z[7]=0,Z[11]=0,Z[15]=1,this}equals(p){const f=this.elements,C=p.elements;for(let D=0;D<16;D++)if(f[D]!==C[D])return!1;return!0}fromArray(p,f=0){for(let C=0;C<16;C++)this.elements[C]=p[C+f];return this}toArray(p=[],f=0){const C=this.elements;return p[f]=C[0],p[f+1]=C[1],p[f+2]=C[2],p[f+3]=C[3],p[f+4]=C[4],p[f+5]=C[5],p[f+6]=C[6],p[f+7]=C[7],p[f+8]=C[8],p[f+9]=C[9],p[f+10]=C[10],p[f+11]=C[11],p[f+12]=C[12],p[f+13]=C[13],p[f+14]=C[14],p[f+15]=C[15],p}}const Cf=new Pi,eh=new Xl,pE=new Pi(0,0,0),fE=new Pi(1,1,1),bd=new Pi,T_=new Pi,$l=new Pi,Av=new Xl,Cv=new Jm;class Lf{constructor(p=0,f=0,C=0,D=Lf.DEFAULT_ORDER){this.isEuler=!0,this._x=p,this._y=f,this._z=C,this._order=D}get x(){return this._x}set x(p){this._x=p,this._onChangeCallback()}get y(){return this._y}set y(p){this._y=p,this._onChangeCallback()}get z(){return this._z}set z(p){this._z=p,this._onChangeCallback()}get order(){return this._order}set order(p){this._order=p,this._onChangeCallback()}set(p,f,C,D=this._order){return this._x=p,this._y=f,this._z=C,this._order=D,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(p){return this._x=p._x,this._y=p._y,this._z=p._z,this._order=p._order,this._onChangeCallback(),this}setFromRotationMatrix(p,f=this._order,C=!0){const D=p.elements,U=D[0],B=D[4],s=D[8],Z=D[1],j=D[5],Q=D[9],oe=D[2],ve=D[6],Ee=D[10];switch(f){case"XYZ":this._y=Math.asin(Fa(s,-1,1)),Math.abs(s)<.9999999?(this._x=Math.atan2(-Q,Ee),this._z=Math.atan2(-B,U)):(this._x=Math.atan2(ve,j),this._z=0);break;case"YXZ":this._x=Math.asin(-Fa(Q,-1,1)),Math.abs(Q)<.9999999?(this._y=Math.atan2(s,Ee),this._z=Math.atan2(Z,j)):(this._y=Math.atan2(-oe,U),this._z=0);break;case"ZXY":this._x=Math.asin(Fa(ve,-1,1)),Math.abs(ve)<.9999999?(this._y=Math.atan2(-oe,Ee),this._z=Math.atan2(-B,j)):(this._y=0,this._z=Math.atan2(Z,U));break;case"ZYX":this._y=Math.asin(-Fa(oe,-1,1)),Math.abs(oe)<.9999999?(this._x=Math.atan2(ve,Ee),this._z=Math.atan2(Z,U)):(this._x=0,this._z=Math.atan2(-B,j));break;case"YZX":this._z=Math.asin(Fa(Z,-1,1)),Math.abs(Z)<.9999999?(this._x=Math.atan2(-Q,j),this._y=Math.atan2(-oe,U)):(this._x=0,this._y=Math.atan2(s,Ee));break;case"XZY":this._z=Math.asin(-Fa(B,-1,1)),Math.abs(B)<.9999999?(this._x=Math.atan2(ve,j),this._y=Math.atan2(s,U)):(this._x=Math.atan2(-Q,Ee),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+f)}return this._order=f,C===!0&&this._onChangeCallback(),this}setFromQuaternion(p,f,C){return Av.makeRotationFromQuaternion(p),this.setFromRotationMatrix(Av,f,C)}setFromVector3(p,f=this._order){return this.set(p.x,p.y,p.z,f)}reorder(p){return Cv.setFromEuler(this),this.setFromQuaternion(Cv,p)}equals(p){return p._x===this._x&&p._y===this._y&&p._z===this._z&&p._order===this._order}fromArray(p){return this._x=p[0],this._y=p[1],this._z=p[2],p[3]!==void 0&&(this._order=p[3]),this._onChangeCallback(),this}toArray(p=[],f=0){return p[f]=this._x,p[f+1]=this._y,p[f+2]=this._z,p[f+3]=this._order,p}_onChange(p){return this._onChangeCallback=p,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}Lf.DEFAULT_ORDER="XYZ";class mE{constructor(){this.mask=1}set(p){this.mask=(1<<p|0)>>>0}enable(p){this.mask|=1<<p|0}enableAll(){this.mask=-1}toggle(p){this.mask^=1<<p|0}disable(p){this.mask&=~(1<<p|0)}disableAll(){this.mask=0}test(p){return(this.mask&p.mask)!==0}isEnabled(p){return(this.mask&(1<<p|0))!==0}}let gE=0;const Lv=new Pi,If=new Jm,wu=new Xl,S_=new Pi,tg=new Pi,_E=new Pi,yE=new Jm,Iv=new Pi(1,0,0),Pv=new Pi(0,1,0),Rv=new Pi(0,0,1),Dv={type:"added"},xE={type:"removed"},Pf={type:"childadded",child:null},v0={type:"childremoved",child:null};let Rf=class Qy extends __{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:gE++}),this.uuid=wf(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Qy.DEFAULT_UP.clone();const p=new Pi,f=new Lf,C=new Jm,D=new Pi(1,1,1);function U(){C.setFromEuler(f,!1)}function B(){f.setFromQuaternion(C,void 0,!1)}f._onChange(U),C._onChange(B),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:p},rotation:{configurable:!0,enumerable:!0,value:f},quaternion:{configurable:!0,enumerable:!0,value:C},scale:{configurable:!0,enumerable:!0,value:D},modelViewMatrix:{value:new Xl},normalMatrix:{value:new _d}}),this.matrix=new Xl,this.matrixWorld=new Xl,this.matrixAutoUpdate=Qy.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=Qy.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new mE,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(p){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(p),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(p){return this.quaternion.premultiply(p),this}setRotationFromAxisAngle(p,f){this.quaternion.setFromAxisAngle(p,f)}setRotationFromEuler(p){this.quaternion.setFromEuler(p,!0)}setRotationFromMatrix(p){this.quaternion.setFromRotationMatrix(p)}setRotationFromQuaternion(p){this.quaternion.copy(p)}rotateOnAxis(p,f){return If.setFromAxisAngle(p,f),this.quaternion.multiply(If),this}rotateOnWorldAxis(p,f){return If.setFromAxisAngle(p,f),this.quaternion.premultiply(If),this}rotateX(p){return this.rotateOnAxis(Iv,p)}rotateY(p){return this.rotateOnAxis(Pv,p)}rotateZ(p){return this.rotateOnAxis(Rv,p)}translateOnAxis(p,f){return Lv.copy(p).applyQuaternion(this.quaternion),this.position.add(Lv.multiplyScalar(f)),this}translateX(p){return this.translateOnAxis(Iv,p)}translateY(p){return this.translateOnAxis(Pv,p)}translateZ(p){return this.translateOnAxis(Rv,p)}localToWorld(p){return this.updateWorldMatrix(!0,!1),p.applyMatrix4(this.matrixWorld)}worldToLocal(p){return this.updateWorldMatrix(!0,!1),p.applyMatrix4(wu.copy(this.matrixWorld).invert())}lookAt(p,f,C){p.isVector3?S_.copy(p):S_.set(p,f,C);const D=this.parent;this.updateWorldMatrix(!0,!1),tg.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?wu.lookAt(tg,S_,this.up):wu.lookAt(S_,tg,this.up),this.quaternion.setFromRotationMatrix(wu),D&&(wu.extractRotation(D.matrixWorld),If.setFromRotationMatrix(wu),this.quaternion.premultiply(If.invert()))}add(p){if(arguments.length>1){for(let f=0;f<arguments.length;f++)this.add(arguments[f]);return this}return p===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",p),this):(p&&p.isObject3D?(p.removeFromParent(),p.parent=this,this.children.push(p),p.dispatchEvent(Dv),Pf.child=p,this.dispatchEvent(Pf),Pf.child=null):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",p),this)}remove(p){if(arguments.length>1){for(let C=0;C<arguments.length;C++)this.remove(arguments[C]);return this}const f=this.children.indexOf(p);return f!==-1&&(p.parent=null,this.children.splice(f,1),p.dispatchEvent(xE),v0.child=p,this.dispatchEvent(v0),v0.child=null),this}removeFromParent(){const p=this.parent;return p!==null&&p.remove(this),this}clear(){return this.remove(...this.children)}attach(p){return this.updateWorldMatrix(!0,!1),wu.copy(this.matrixWorld).invert(),p.parent!==null&&(p.parent.updateWorldMatrix(!0,!1),wu.multiply(p.parent.matrixWorld)),p.applyMatrix4(wu),p.removeFromParent(),p.parent=this,this.children.push(p),p.updateWorldMatrix(!1,!0),p.dispatchEvent(Dv),Pf.child=p,this.dispatchEvent(Pf),Pf.child=null,this}getObjectById(p){return this.getObjectByProperty("id",p)}getObjectByName(p){return this.getObjectByProperty("name",p)}getObjectByProperty(p,f){if(this[p]===f)return this;for(let C=0,D=this.children.length;C<D;C++){const B=this.children[C].getObjectByProperty(p,f);if(B!==void 0)return B}}getObjectsByProperty(p,f,C=[]){this[p]===f&&C.push(this);const D=this.children;for(let U=0,B=D.length;U<B;U++)D[U].getObjectsByProperty(p,f,C);return C}getWorldPosition(p){return this.updateWorldMatrix(!0,!1),p.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(p){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(tg,p,_E),p}getWorldScale(p){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(tg,yE,p),p}getWorldDirection(p){this.updateWorldMatrix(!0,!1);const f=this.matrixWorld.elements;return p.set(f[8],f[9],f[10]).normalize()}raycast(){}traverse(p){p(this);const f=this.children;for(let C=0,D=f.length;C<D;C++)f[C].traverse(p)}traverseVisible(p){if(this.visible===!1)return;p(this);const f=this.children;for(let C=0,D=f.length;C<D;C++)f[C].traverseVisible(p)}traverseAncestors(p){const f=this.parent;f!==null&&(p(f),f.traverseAncestors(p))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(p){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||p)&&(this.matrixWorldAutoUpdate===!0&&(this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,p=!0);const f=this.children;for(let C=0,D=f.length;C<D;C++)f[C].updateMatrixWorld(p)}updateWorldMatrix(p,f){const C=this.parent;if(p===!0&&C!==null&&C.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldAutoUpdate===!0&&(this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),f===!0){const D=this.children;for(let U=0,B=D.length;U<B;U++)D[U].updateWorldMatrix(!1,!0)}}toJSON(p){const f=p===void 0||typeof p=="string",C={};f&&(p={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},C.metadata={version:4.6,type:"Object",generator:"Object3D.toJSON"});const D={};D.uuid=this.uuid,D.type=this.type,this.name!==""&&(D.name=this.name),this.castShadow===!0&&(D.castShadow=!0),this.receiveShadow===!0&&(D.receiveShadow=!0),this.visible===!1&&(D.visible=!1),this.frustumCulled===!1&&(D.frustumCulled=!1),this.renderOrder!==0&&(D.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(D.userData=this.userData),D.layers=this.layers.mask,D.matrix=this.matrix.toArray(),D.up=this.up.toArray(),this.matrixAutoUpdate===!1&&(D.matrixAutoUpdate=!1),this.isInstancedMesh&&(D.type="InstancedMesh",D.count=this.count,D.instanceMatrix=this.instanceMatrix.toJSON(),this.instanceColor!==null&&(D.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(D.type="BatchedMesh",D.perObjectFrustumCulled=this.perObjectFrustumCulled,D.sortObjects=this.sortObjects,D.drawRanges=this._drawRanges,D.reservedRanges=this._reservedRanges,D.visibility=this._visibility,D.active=this._active,D.bounds=this._bounds.map(s=>({boxInitialized:s.boxInitialized,boxMin:s.box.min.toArray(),boxMax:s.box.max.toArray(),sphereInitialized:s.sphereInitialized,sphereRadius:s.sphere.radius,sphereCenter:s.sphere.center.toArray()})),D.maxInstanceCount=this._maxInstanceCount,D.maxVertexCount=this._maxVertexCount,D.maxIndexCount=this._maxIndexCount,D.geometryInitialized=this._geometryInitialized,D.geometryCount=this._geometryCount,D.matricesTexture=this._matricesTexture.toJSON(p),this._colorsTexture!==null&&(D.colorsTexture=this._colorsTexture.toJSON(p)),this.boundingSphere!==null&&(D.boundingSphere={center:D.boundingSphere.center.toArray(),radius:D.boundingSphere.radius}),this.boundingBox!==null&&(D.boundingBox={min:D.boundingBox.min.toArray(),max:D.boundingBox.max.toArray()}));function U(s,Z){return s[Z.uuid]===void 0&&(s[Z.uuid]=Z.toJSON(p)),Z.uuid}if(this.isScene)this.background&&(this.background.isColor?D.background=this.background.toJSON():this.background.isTexture&&(D.background=this.background.toJSON(p).uuid)),this.environment&&this.environment.isTexture&&this.environment.isRenderTargetTexture!==!0&&(D.environment=this.environment.toJSON(p).uuid);else if(this.isMesh||this.isLine||this.isPoints){D.geometry=U(p.geometries,this.geometry);const s=this.geometry.parameters;if(s!==void 0&&s.shapes!==void 0){const Z=s.shapes;if(Array.isArray(Z))for(let j=0,Q=Z.length;j<Q;j++){const oe=Z[j];U(p.shapes,oe)}else U(p.shapes,Z)}}if(this.isSkinnedMesh&&(D.bindMode=this.bindMode,D.bindMatrix=this.bindMatrix.toArray(),this.skeleton!==void 0&&(U(p.skeletons,this.skeleton),D.skeleton=this.skeleton.uuid)),this.material!==void 0)if(Array.isArray(this.material)){const s=[];for(let Z=0,j=this.material.length;Z<j;Z++)s.push(U(p.materials,this.material[Z]));D.material=s}else D.material=U(p.materials,this.material);if(this.children.length>0){D.children=[];for(let s=0;s<this.children.length;s++)D.children.push(this.children[s].toJSON(p).object)}if(this.animations.length>0){D.animations=[];for(let s=0;s<this.animations.length;s++){const Z=this.animations[s];D.animations.push(U(p.animations,Z))}}if(f){const s=B(p.geometries),Z=B(p.materials),j=B(p.textures),Q=B(p.images),oe=B(p.shapes),ve=B(p.skeletons),Ee=B(p.animations),We=B(p.nodes);s.length>0&&(C.geometries=s),Z.length>0&&(C.materials=Z),j.length>0&&(C.textures=j),Q.length>0&&(C.images=Q),oe.length>0&&(C.shapes=oe),ve.length>0&&(C.skeletons=ve),Ee.length>0&&(C.animations=Ee),We.length>0&&(C.nodes=We)}return C.object=D,C;function B(s){const Z=[];for(const j in s){const Q=s[j];delete Q.metadata,Z.push(Q)}return Z}}clone(p){return new this.constructor().copy(this,p)}copy(p,f=!0){if(this.name=p.name,this.up.copy(p.up),this.position.copy(p.position),this.rotation.order=p.rotation.order,this.quaternion.copy(p.quaternion),this.scale.copy(p.scale),this.matrix.copy(p.matrix),this.matrixWorld.copy(p.matrixWorld),this.matrixAutoUpdate=p.matrixAutoUpdate,this.matrixWorldAutoUpdate=p.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=p.matrixWorldNeedsUpdate,this.layers.mask=p.layers.mask,this.visible=p.visible,this.castShadow=p.castShadow,this.receiveShadow=p.receiveShadow,this.frustumCulled=p.frustumCulled,this.renderOrder=p.renderOrder,this.animations=p.animations.slice(),this.userData=JSON.parse(JSON.stringify(p.userData)),f===!0)for(let C=0;C<p.children.length;C++){const D=p.children[C];this.add(D.clone())}return this}};Rf.DEFAULT_UP=new Pi(0,1,0),Rf.DEFAULT_MATRIX_AUTO_UPDATE=!0,Rf.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const th=new Pi,Mu=new Pi,b0=new Pi,Tu=new Pi,Df=new Pi,zf=new Pi,zv=new Pi,w0=new Pi,M0=new Pi,T0=new Pi;class ih{constructor(p=new Pi,f=new Pi,C=new Pi){this.a=p,this.b=f,this.c=C}static getNormal(p,f,C,D){D.subVectors(C,f),th.subVectors(p,f),D.cross(th);const U=D.lengthSq();return U>0?D.multiplyScalar(1/Math.sqrt(U)):D.set(0,0,0)}static getBarycoord(p,f,C,D,U){th.subVectors(D,f),Mu.subVectors(C,f),b0.subVectors(p,f);const B=th.dot(th),s=th.dot(Mu),Z=th.dot(b0),j=Mu.dot(Mu),Q=Mu.dot(b0),oe=B*j-s*s;if(oe===0)return U.set(0,0,0),null;const ve=1/oe,Ee=(j*Z-s*Q)*ve,We=(B*Q-s*Z)*ve;return U.set(1-Ee-We,We,Ee)}static containsPoint(p,f,C,D){return this.getBarycoord(p,f,C,D,Tu)===null?!1:Tu.x>=0&&Tu.y>=0&&Tu.x+Tu.y<=1}static getInterpolation(p,f,C,D,U,B,s,Z){return this.getBarycoord(p,f,C,D,Tu)===null?(Z.x=0,Z.y=0,"z"in Z&&(Z.z=0),"w"in Z&&(Z.w=0),null):(Z.setScalar(0),Z.addScaledVector(U,Tu.x),Z.addScaledVector(B,Tu.y),Z.addScaledVector(s,Tu.z),Z)}static isFrontFacing(p,f,C,D){return th.subVectors(C,f),Mu.subVectors(p,f),th.cross(Mu).dot(D)<0}set(p,f,C){return this.a.copy(p),this.b.copy(f),this.c.copy(C),this}setFromPointsAndIndices(p,f,C,D){return this.a.copy(p[f]),this.b.copy(p[C]),this.c.copy(p[D]),this}setFromAttributeAndIndices(p,f,C,D){return this.a.fromBufferAttribute(p,f),this.b.fromBufferAttribute(p,C),this.c.fromBufferAttribute(p,D),this}clone(){return new this.constructor().copy(this)}copy(p){return this.a.copy(p.a),this.b.copy(p.b),this.c.copy(p.c),this}getArea(){return th.subVectors(this.c,this.b),Mu.subVectors(this.a,this.b),th.cross(Mu).length()*.5}getMidpoint(p){return p.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(p){return ih.getNormal(this.a,this.b,this.c,p)}getPlane(p){return p.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(p,f){return ih.getBarycoord(p,this.a,this.b,this.c,f)}getInterpolation(p,f,C,D,U){return ih.getInterpolation(p,this.a,this.b,this.c,f,C,D,U)}containsPoint(p){return ih.containsPoint(p,this.a,this.b,this.c)}isFrontFacing(p){return ih.isFrontFacing(this.a,this.b,this.c,p)}intersectsBox(p){return p.intersectsTriangle(this)}closestPointToPoint(p,f){const C=this.a,D=this.b,U=this.c;let B,s;Df.subVectors(D,C),zf.subVectors(U,C),w0.subVectors(p,C);const Z=Df.dot(w0),j=zf.dot(w0);if(Z<=0&&j<=0)return f.copy(C);M0.subVectors(p,D);const Q=Df.dot(M0),oe=zf.dot(M0);if(Q>=0&&oe<=Q)return f.copy(D);const ve=Z*oe-Q*j;if(ve<=0&&Z>=0&&Q<=0)return B=Z/(Z-Q),f.copy(C).addScaledVector(Df,B);T0.subVectors(p,U);const Ee=Df.dot(T0),We=zf.dot(T0);if(We>=0&&Ee<=We)return f.copy(U);const Re=Ee*j-Z*We;if(Re<=0&&j>=0&&We<=0)return s=j/(j-We),f.copy(C).addScaledVector(zf,s);const He=Q*We-Ee*oe;if(He<=0&&oe-Q>=0&&Ee-We>=0)return zv.subVectors(U,D),s=(oe-Q)/(oe-Q+(Ee-We)),f.copy(D).addScaledVector(zv,s);const Mt=1/(He+Re+ve);return B=Re*Mt,s=ve*Mt,f.copy(C).addScaledVector(Df,B).addScaledVector(zf,s)}equals(p){return p.a.equals(this.a)&&p.b.equals(this.b)&&p.c.equals(this.c)}}const Ov={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},wd={h:0,s:0,l:0},E_={h:0,s:0,l:0};function S0(te,p,f){return f<0&&(f+=1),f>1&&(f-=1),f<1/6?te+(p-te)*6*f:f<1/2?p:f<2/3?te+(p-te)*6*(2/3-f):te}class Md{constructor(p,f,C){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(p,f,C)}set(p,f,C){if(f===void 0&&C===void 0){const D=p;D&&D.isColor?this.copy(D):typeof D=="number"?this.setHex(D):typeof D=="string"&&this.setStyle(D)}else this.setRGB(p,f,C);return this}setScalar(p){return this.r=p,this.g=p,this.b=p,this}setHex(p,f=gd){return p=Math.floor(p),this.r=(p>>16&255)/255,this.g=(p>>8&255)/255,this.b=(p&255)/255,Kc.toWorkingColorSpace(this,f),this}setRGB(p,f,C,D=Kc.workingColorSpace){return this.r=p,this.g=f,this.b=C,Kc.toWorkingColorSpace(this,D),this}setHSL(p,f,C,D=Kc.workingColorSpace){if(p=rE(p,1),f=Fa(f,0,1),C=Fa(C,0,1),f===0)this.r=this.g=this.b=C;else{const U=C<=.5?C*(1+f):C+f-C*f,B=2*C-U;this.r=S0(B,U,p+1/3),this.g=S0(B,U,p),this.b=S0(B,U,p-1/3)}return Kc.toWorkingColorSpace(this,D),this}setStyle(p,f=gd){function C(U){U!==void 0&&parseFloat(U)<1&&console.warn("THREE.Color: Alpha component of "+p+" will be ignored.")}let D;if(D=/^(\w+)\(([^\)]*)\)/.exec(p)){let U;const B=D[1],s=D[2];switch(B){case"rgb":case"rgba":if(U=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(s))return C(U[4]),this.setRGB(Math.min(255,parseInt(U[1],10))/255,Math.min(255,parseInt(U[2],10))/255,Math.min(255,parseInt(U[3],10))/255,f);if(U=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(s))return C(U[4]),this.setRGB(Math.min(100,parseInt(U[1],10))/100,Math.min(100,parseInt(U[2],10))/100,Math.min(100,parseInt(U[3],10))/100,f);break;case"hsl":case"hsla":if(U=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(s))return C(U[4]),this.setHSL(parseFloat(U[1])/360,parseFloat(U[2])/100,parseFloat(U[3])/100,f);break;default:console.warn("THREE.Color: Unknown color model "+p)}}else if(D=/^\#([A-Fa-f\d]+)$/.exec(p)){const U=D[1],B=U.length;if(B===3)return this.setRGB(parseInt(U.charAt(0),16)/15,parseInt(U.charAt(1),16)/15,parseInt(U.charAt(2),16)/15,f);if(B===6)return this.setHex(parseInt(U,16),f);console.warn("THREE.Color: Invalid hex color "+p)}else if(p&&p.length>0)return this.setColorName(p,f);return this}setColorName(p,f=gd){const C=Ov[p.toLowerCase()];return C!==void 0?this.setHex(C,f):console.warn("THREE.Color: Unknown color "+p),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(p){return this.r=p.r,this.g=p.g,this.b=p.b,this}copySRGBToLinear(p){return this.r=Mf(p.r),this.g=Mf(p.g),this.b=Mf(p.b),this}copyLinearToSRGB(p){return this.r=u0(p.r),this.g=u0(p.g),this.b=u0(p.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(p=gd){return Kc.fromWorkingColorSpace(ka.copy(this),p),Math.round(Fa(ka.r*255,0,255))*65536+Math.round(Fa(ka.g*255,0,255))*256+Math.round(Fa(ka.b*255,0,255))}getHexString(p=gd){return("000000"+this.getHex(p).toString(16)).slice(-6)}getHSL(p,f=Kc.workingColorSpace){Kc.fromWorkingColorSpace(ka.copy(this),f);const C=ka.r,D=ka.g,U=ka.b,B=Math.max(C,D,U),s=Math.min(C,D,U);let Z,j;const Q=(s+B)/2;if(s===B)Z=0,j=0;else{const oe=B-s;switch(j=Q<=.5?oe/(B+s):oe/(2-B-s),B){case C:Z=(D-U)/oe+(D<U?6:0);break;case D:Z=(U-C)/oe+2;break;case U:Z=(C-D)/oe+4;break}Z/=6}return p.h=Z,p.s=j,p.l=Q,p}getRGB(p,f=Kc.workingColorSpace){return Kc.fromWorkingColorSpace(ka.copy(this),f),p.r=ka.r,p.g=ka.g,p.b=ka.b,p}getStyle(p=gd){Kc.fromWorkingColorSpace(ka.copy(this),p);const f=ka.r,C=ka.g,D=ka.b;return p!==gd?`color(${p} ${f.toFixed(3)} ${C.toFixed(3)} ${D.toFixed(3)})`:`rgb(${Math.round(f*255)},${Math.round(C*255)},${Math.round(D*255)})`}offsetHSL(p,f,C){return this.getHSL(wd),this.setHSL(wd.h+p,wd.s+f,wd.l+C)}add(p){return this.r+=p.r,this.g+=p.g,this.b+=p.b,this}addColors(p,f){return this.r=p.r+f.r,this.g=p.g+f.g,this.b=p.b+f.b,this}addScalar(p){return this.r+=p,this.g+=p,this.b+=p,this}sub(p){return this.r=Math.max(0,this.r-p.r),this.g=Math.max(0,this.g-p.g),this.b=Math.max(0,this.b-p.b),this}multiply(p){return this.r*=p.r,this.g*=p.g,this.b*=p.b,this}multiplyScalar(p){return this.r*=p,this.g*=p,this.b*=p,this}lerp(p,f){return this.r+=(p.r-this.r)*f,this.g+=(p.g-this.g)*f,this.b+=(p.b-this.b)*f,this}lerpColors(p,f,C){return this.r=p.r+(f.r-p.r)*C,this.g=p.g+(f.g-p.g)*C,this.b=p.b+(f.b-p.b)*C,this}lerpHSL(p,f){this.getHSL(wd),p.getHSL(E_);const C=c0(wd.h,E_.h,f),D=c0(wd.s,E_.s,f),U=c0(wd.l,E_.l,f);return this.setHSL(C,D,U),this}setFromVector3(p){return this.r=p.x,this.g=p.y,this.b=p.z,this}applyMatrix3(p){const f=this.r,C=this.g,D=this.b,U=p.elements;return this.r=U[0]*f+U[3]*C+U[6]*D,this.g=U[1]*f+U[4]*C+U[7]*D,this.b=U[2]*f+U[5]*C+U[8]*D,this}equals(p){return p.r===this.r&&p.g===this.g&&p.b===this.b}fromArray(p,f=0){return this.r=p[f],this.g=p[f+1],this.b=p[f+2],this}toArray(p=[],f=0){return p[f]=this.r,p[f+1]=this.g,p[f+2]=this.b,p}fromBufferAttribute(p,f){return this.r=p.getX(f),this.g=p.getY(f),this.b=p.getZ(f),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const ka=new Md;Md.NAMES=Ov;let vE=0;class E0 extends __{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:vE++}),this.uuid=wf(),this.name="",this.type="Material",this.blending=rv,this.side=o0,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=ov,this.blendDst=av,this.blendEquation=sv,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new Md(0,0,0),this.blendAlpha=0,this.depthFunc=lv,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=yv,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=bf,this.stencilZFail=bf,this.stencilZPass=bf,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(p){this._alphaTest>0!=p>0&&this.version++,this._alphaTest=p}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(p){if(p!==void 0)for(const f in p){const C=p[f];if(C===void 0){console.warn(`THREE.Material: parameter '${f}' has value of undefined.`);continue}const D=this[f];if(D===void 0){console.warn(`THREE.Material: '${f}' is not a property of THREE.${this.type}.`);continue}D&&D.isColor?D.set(C):D&&D.isVector3&&C&&C.isVector3?D.copy(C):this[f]=C}}toJSON(p){const f=p===void 0||typeof p=="string";f&&(p={textures:{},images:{}});const C={metadata:{version:4.6,type:"Material",generator:"Material.toJSON"}};C.uuid=this.uuid,C.type=this.type,this.name!==""&&(C.name=this.name),this.color&&this.color.isColor&&(C.color=this.color.getHex()),this.roughness!==void 0&&(C.roughness=this.roughness),this.metalness!==void 0&&(C.metalness=this.metalness),this.sheen!==void 0&&(C.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(C.sheenColor=this.sheenColor.getHex()),this.sheenRoughness!==void 0&&(C.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(C.emissive=this.emissive.getHex()),this.emissiveIntensity!==void 0&&this.emissiveIntensity!==1&&(C.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(C.specular=this.specular.getHex()),this.specularIntensity!==void 0&&(C.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(C.specularColor=this.specularColor.getHex()),this.shininess!==void 0&&(C.shininess=this.shininess),this.clearcoat!==void 0&&(C.clearcoat=this.clearcoat),this.clearcoatRoughness!==void 0&&(C.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(C.clearcoatMap=this.clearcoatMap.toJSON(p).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(C.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(p).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(C.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(p).uuid,C.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),this.dispersion!==void 0&&(C.dispersion=this.dispersion),this.iridescence!==void 0&&(C.iridescence=this.iridescence),this.iridescenceIOR!==void 0&&(C.iridescenceIOR=this.iridescenceIOR),this.iridescenceThicknessRange!==void 0&&(C.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(C.iridescenceMap=this.iridescenceMap.toJSON(p).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(C.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(p).uuid),this.anisotropy!==void 0&&(C.anisotropy=this.anisotropy),this.anisotropyRotation!==void 0&&(C.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(C.anisotropyMap=this.anisotropyMap.toJSON(p).uuid),this.map&&this.map.isTexture&&(C.map=this.map.toJSON(p).uuid),this.matcap&&this.matcap.isTexture&&(C.matcap=this.matcap.toJSON(p).uuid),this.alphaMap&&this.alphaMap.isTexture&&(C.alphaMap=this.alphaMap.toJSON(p).uuid),this.lightMap&&this.lightMap.isTexture&&(C.lightMap=this.lightMap.toJSON(p).uuid,C.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(C.aoMap=this.aoMap.toJSON(p).uuid,C.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(C.bumpMap=this.bumpMap.toJSON(p).uuid,C.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(C.normalMap=this.normalMap.toJSON(p).uuid,C.normalMapType=this.normalMapType,C.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(C.displacementMap=this.displacementMap.toJSON(p).uuid,C.displacementScale=this.displacementScale,C.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(C.roughnessMap=this.roughnessMap.toJSON(p).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(C.metalnessMap=this.metalnessMap.toJSON(p).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(C.emissiveMap=this.emissiveMap.toJSON(p).uuid),this.specularMap&&this.specularMap.isTexture&&(C.specularMap=this.specularMap.toJSON(p).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(C.specularIntensityMap=this.specularIntensityMap.toJSON(p).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(C.specularColorMap=this.specularColorMap.toJSON(p).uuid),this.envMap&&this.envMap.isTexture&&(C.envMap=this.envMap.toJSON(p).uuid,this.combine!==void 0&&(C.combine=this.combine)),this.envMapRotation!==void 0&&(C.envMapRotation=this.envMapRotation.toArray()),this.envMapIntensity!==void 0&&(C.envMapIntensity=this.envMapIntensity),this.reflectivity!==void 0&&(C.reflectivity=this.reflectivity),this.refractionRatio!==void 0&&(C.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(C.gradientMap=this.gradientMap.toJSON(p).uuid),this.transmission!==void 0&&(C.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(C.transmissionMap=this.transmissionMap.toJSON(p).uuid),this.thickness!==void 0&&(C.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(C.thicknessMap=this.thicknessMap.toJSON(p).uuid),this.attenuationDistance!==void 0&&this.attenuationDistance!==1/0&&(C.attenuationDistance=this.attenuationDistance),this.attenuationColor!==void 0&&(C.attenuationColor=this.attenuationColor.getHex()),this.size!==void 0&&(C.size=this.size),this.shadowSide!==null&&(C.shadowSide=this.shadowSide),this.sizeAttenuation!==void 0&&(C.sizeAttenuation=this.sizeAttenuation),this.blending!==rv&&(C.blending=this.blending),this.side!==o0&&(C.side=this.side),this.vertexColors===!0&&(C.vertexColors=!0),this.opacity<1&&(C.opacity=this.opacity),this.transparent===!0&&(C.transparent=!0),this.blendSrc!==ov&&(C.blendSrc=this.blendSrc),this.blendDst!==av&&(C.blendDst=this.blendDst),this.blendEquation!==sv&&(C.blendEquation=this.blendEquation),this.blendSrcAlpha!==null&&(C.blendSrcAlpha=this.blendSrcAlpha),this.blendDstAlpha!==null&&(C.blendDstAlpha=this.blendDstAlpha),this.blendEquationAlpha!==null&&(C.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(C.blendColor=this.blendColor.getHex()),this.blendAlpha!==0&&(C.blendAlpha=this.blendAlpha),this.depthFunc!==lv&&(C.depthFunc=this.depthFunc),this.depthTest===!1&&(C.depthTest=this.depthTest),this.depthWrite===!1&&(C.depthWrite=this.depthWrite),this.colorWrite===!1&&(C.colorWrite=this.colorWrite),this.stencilWriteMask!==255&&(C.stencilWriteMask=this.stencilWriteMask),this.stencilFunc!==yv&&(C.stencilFunc=this.stencilFunc),this.stencilRef!==0&&(C.stencilRef=this.stencilRef),this.stencilFuncMask!==255&&(C.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==bf&&(C.stencilFail=this.stencilFail),this.stencilZFail!==bf&&(C.stencilZFail=this.stencilZFail),this.stencilZPass!==bf&&(C.stencilZPass=this.stencilZPass),this.stencilWrite===!0&&(C.stencilWrite=this.stencilWrite),this.rotation!==void 0&&this.rotation!==0&&(C.rotation=this.rotation),this.polygonOffset===!0&&(C.polygonOffset=!0),this.polygonOffsetFactor!==0&&(C.polygonOffsetFactor=this.polygonOffsetFactor),this.polygonOffsetUnits!==0&&(C.polygonOffsetUnits=this.polygonOffsetUnits),this.linewidth!==void 0&&this.linewidth!==1&&(C.linewidth=this.linewidth),this.dashSize!==void 0&&(C.dashSize=this.dashSize),this.gapSize!==void 0&&(C.gapSize=this.gapSize),this.scale!==void 0&&(C.scale=this.scale),this.dithering===!0&&(C.dithering=!0),this.alphaTest>0&&(C.alphaTest=this.alphaTest),this.alphaHash===!0&&(C.alphaHash=!0),this.alphaToCoverage===!0&&(C.alphaToCoverage=!0),this.premultipliedAlpha===!0&&(C.premultipliedAlpha=!0),this.forceSinglePass===!0&&(C.forceSinglePass=!0),this.wireframe===!0&&(C.wireframe=!0),this.wireframeLinewidth>1&&(C.wireframeLinewidth=this.wireframeLinewidth),this.wireframeLinecap!=="round"&&(C.wireframeLinecap=this.wireframeLinecap),this.wireframeLinejoin!=="round"&&(C.wireframeLinejoin=this.wireframeLinejoin),this.flatShading===!0&&(C.flatShading=!0),this.visible===!1&&(C.visible=!1),this.toneMapped===!1&&(C.toneMapped=!1),this.fog===!1&&(C.fog=!1),Object.keys(this.userData).length>0&&(C.userData=this.userData);function D(U){const B=[];for(const s in U){const Z=U[s];delete Z.metadata,B.push(Z)}return B}if(f){const U=D(p.textures),B=D(p.images);U.length>0&&(C.textures=U),B.length>0&&(C.images=B)}return C}clone(){return new this.constructor().copy(this)}copy(p){this.name=p.name,this.blending=p.blending,this.side=p.side,this.vertexColors=p.vertexColors,this.opacity=p.opacity,this.transparent=p.transparent,this.blendSrc=p.blendSrc,this.blendDst=p.blendDst,this.blendEquation=p.blendEquation,this.blendSrcAlpha=p.blendSrcAlpha,this.blendDstAlpha=p.blendDstAlpha,this.blendEquationAlpha=p.blendEquationAlpha,this.blendColor.copy(p.blendColor),this.blendAlpha=p.blendAlpha,this.depthFunc=p.depthFunc,this.depthTest=p.depthTest,this.depthWrite=p.depthWrite,this.stencilWriteMask=p.stencilWriteMask,this.stencilFunc=p.stencilFunc,this.stencilRef=p.stencilRef,this.stencilFuncMask=p.stencilFuncMask,this.stencilFail=p.stencilFail,this.stencilZFail=p.stencilZFail,this.stencilZPass=p.stencilZPass,this.stencilWrite=p.stencilWrite;const f=p.clippingPlanes;let C=null;if(f!==null){const D=f.length;C=new Array(D);for(let U=0;U!==D;++U)C[U]=f[U].clone()}return this.clippingPlanes=C,this.clipIntersection=p.clipIntersection,this.clipShadows=p.clipShadows,this.shadowSide=p.shadowSide,this.colorWrite=p.colorWrite,this.precision=p.precision,this.polygonOffset=p.polygonOffset,this.polygonOffsetFactor=p.polygonOffsetFactor,this.polygonOffsetUnits=p.polygonOffsetUnits,this.dithering=p.dithering,this.alphaTest=p.alphaTest,this.alphaHash=p.alphaHash,this.alphaToCoverage=p.alphaToCoverage,this.premultipliedAlpha=p.premultipliedAlpha,this.forceSinglePass=p.forceSinglePass,this.visible=p.visible,this.toneMapped=p.toneMapped,this.userData=JSON.parse(JSON.stringify(p.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(p){p===!0&&this.version++}onBuild(){console.warn("Material: onBuild() has been removed.")}onBeforeRender(){console.warn("Material: onBeforeRender() has been removed.")}}class bE extends E0{constructor(p){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new Md(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Lf,this.combine=cv,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(p)}copy(p){return super.copy(p),this.color.copy(p.color),this.map=p.map,this.lightMap=p.lightMap,this.lightMapIntensity=p.lightMapIntensity,this.aoMap=p.aoMap,this.aoMapIntensity=p.aoMapIntensity,this.specularMap=p.specularMap,this.alphaMap=p.alphaMap,this.envMap=p.envMap,this.envMapRotation.copy(p.envMapRotation),this.combine=p.combine,this.reflectivity=p.reflectivity,this.refractionRatio=p.refractionRatio,this.wireframe=p.wireframe,this.wireframeLinewidth=p.wireframeLinewidth,this.wireframeLinecap=p.wireframeLinecap,this.wireframeLinejoin=p.wireframeLinejoin,this.fog=p.fog,this}}const jo=new Pi,A_=new Rr;class Of{constructor(p,f,C=!1){if(Array.isArray(p))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,this.name="",this.array=p,this.itemSize=f,this.count=p!==void 0?p.length/f:0,this.normalized=C,this.usage=xv,this._updateRange={offset:0,count:-1},this.updateRanges=[],this.gpuType=Q2,this.version=0}onUploadCallback(){}set needsUpdate(p){p===!0&&this.version++}get updateRange(){return oE("THREE.BufferAttribute: updateRange() is deprecated and will be removed in r169. Use addUpdateRange() instead."),this._updateRange}setUsage(p){return this.usage=p,this}addUpdateRange(p,f){this.updateRanges.push({start:p,count:f})}clearUpdateRanges(){this.updateRanges.length=0}copy(p){return this.name=p.name,this.array=new p.array.constructor(p.array),this.itemSize=p.itemSize,this.count=p.count,this.normalized=p.normalized,this.usage=p.usage,this.gpuType=p.gpuType,this}copyAt(p,f,C){p*=this.itemSize,C*=f.itemSize;for(let D=0,U=this.itemSize;D<U;D++)this.array[p+D]=f.array[C+D];return this}copyArray(p){return this.array.set(p),this}applyMatrix3(p){if(this.itemSize===2)for(let f=0,C=this.count;f<C;f++)A_.fromBufferAttribute(this,f),A_.applyMatrix3(p),this.setXY(f,A_.x,A_.y);else if(this.itemSize===3)for(let f=0,C=this.count;f<C;f++)jo.fromBufferAttribute(this,f),jo.applyMatrix3(p),this.setXYZ(f,jo.x,jo.y,jo.z);return this}applyMatrix4(p){for(let f=0,C=this.count;f<C;f++)jo.fromBufferAttribute(this,f),jo.applyMatrix4(p),this.setXYZ(f,jo.x,jo.y,jo.z);return this}applyNormalMatrix(p){for(let f=0,C=this.count;f<C;f++)jo.fromBufferAttribute(this,f),jo.applyNormalMatrix(p),this.setXYZ(f,jo.x,jo.y,jo.z);return this}transformDirection(p){for(let f=0,C=this.count;f<C;f++)jo.fromBufferAttribute(this,f),jo.transformDirection(p),this.setXYZ(f,jo.x,jo.y,jo.z);return this}set(p,f=0){return this.array.set(p,f),this}getComponent(p,f){let C=this.array[p*this.itemSize+f];return this.normalized&&(C=Ym(C,this.array)),C}setComponent(p,f,C){return this.normalized&&(C=vl(C,this.array)),this.array[p*this.itemSize+f]=C,this}getX(p){let f=this.array[p*this.itemSize];return this.normalized&&(f=Ym(f,this.array)),f}setX(p,f){return this.normalized&&(f=vl(f,this.array)),this.array[p*this.itemSize]=f,this}getY(p){let f=this.array[p*this.itemSize+1];return this.normalized&&(f=Ym(f,this.array)),f}setY(p,f){return this.normalized&&(f=vl(f,this.array)),this.array[p*this.itemSize+1]=f,this}getZ(p){let f=this.array[p*this.itemSize+2];return this.normalized&&(f=Ym(f,this.array)),f}setZ(p,f){return this.normalized&&(f=vl(f,this.array)),this.array[p*this.itemSize+2]=f,this}getW(p){let f=this.array[p*this.itemSize+3];return this.normalized&&(f=Ym(f,this.array)),f}setW(p,f){return this.normalized&&(f=vl(f,this.array)),this.array[p*this.itemSize+3]=f,this}setXY(p,f,C){return p*=this.itemSize,this.normalized&&(f=vl(f,this.array),C=vl(C,this.array)),this.array[p+0]=f,this.array[p+1]=C,this}setXYZ(p,f,C,D){return p*=this.itemSize,this.normalized&&(f=vl(f,this.array),C=vl(C,this.array),D=vl(D,this.array)),this.array[p+0]=f,this.array[p+1]=C,this.array[p+2]=D,this}setXYZW(p,f,C,D,U){return p*=this.itemSize,this.normalized&&(f=vl(f,this.array),C=vl(C,this.array),D=vl(D,this.array),U=vl(U,this.array)),this.array[p+0]=f,this.array[p+1]=C,this.array[p+2]=D,this.array[p+3]=U,this}onUpload(p){return this.onUploadCallback=p,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const p={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return this.name!==""&&(p.name=this.name),this.usage!==xv&&(p.usage=this.usage),p}}class wE extends Of{constructor(p,f,C){super(new Uint16Array(p),f,C)}}class ME extends Of{constructor(p,f,C){super(new Uint32Array(p),f,C)}}class Ff extends Of{constructor(p,f,C){super(new Float32Array(p),f,C)}}let TE=0;const xc=new Xl,A0=new Rf,kf=new Pi,Yl=new Km,ig=new Km,la=new Pi;class Bf extends __{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:TE++}),this.uuid=wf(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(p){return Array.isArray(p)?this.index=new(sE(p)?ME:wE)(p,1):this.index=p,this}getAttribute(p){return this.attributes[p]}setAttribute(p,f){return this.attributes[p]=f,this}deleteAttribute(p){return delete this.attributes[p],this}hasAttribute(p){return this.attributes[p]!==void 0}addGroup(p,f,C=0){this.groups.push({start:p,count:f,materialIndex:C})}clearGroups(){this.groups=[]}setDrawRange(p,f){this.drawRange.start=p,this.drawRange.count=f}applyMatrix4(p){const f=this.attributes.position;f!==void 0&&(f.applyMatrix4(p),f.needsUpdate=!0);const C=this.attributes.normal;if(C!==void 0){const U=new _d().getNormalMatrix(p);C.applyNormalMatrix(U),C.needsUpdate=!0}const D=this.attributes.tangent;return D!==void 0&&(D.transformDirection(p),D.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}applyQuaternion(p){return xc.makeRotationFromQuaternion(p),this.applyMatrix4(xc),this}rotateX(p){return xc.makeRotationX(p),this.applyMatrix4(xc),this}rotateY(p){return xc.makeRotationY(p),this.applyMatrix4(xc),this}rotateZ(p){return xc.makeRotationZ(p),this.applyMatrix4(xc),this}translate(p,f,C){return xc.makeTranslation(p,f,C),this.applyMatrix4(xc),this}scale(p,f,C){return xc.makeScale(p,f,C),this.applyMatrix4(xc),this}lookAt(p){return A0.lookAt(p),A0.updateMatrix(),this.applyMatrix4(A0.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(kf).negate(),this.translate(kf.x,kf.y,kf.z),this}setFromPoints(p){const f=[];for(let C=0,D=p.length;C<D;C++){const U=p[C];f.push(U.x,U.y,U.z||0)}return this.setAttribute("position",new Ff(f,3)),this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new Km);const p=this.attributes.position,f=this.morphAttributes.position;if(p&&p.isGLBufferAttribute){console.error("THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box.",this),this.boundingBox.set(new Pi(-1/0,-1/0,-1/0),new Pi(1/0,1/0,1/0));return}if(p!==void 0){if(this.boundingBox.setFromBufferAttribute(p),f)for(let C=0,D=f.length;C<D;C++){const U=f[C];Yl.setFromBufferAttribute(U),this.morphTargetsRelative?(la.addVectors(this.boundingBox.min,Yl.min),this.boundingBox.expandByPoint(la),la.addVectors(this.boundingBox.max,Yl.max),this.boundingBox.expandByPoint(la)):(this.boundingBox.expandByPoint(Yl.min),this.boundingBox.expandByPoint(Yl.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new g0);const p=this.attributes.position,f=this.morphAttributes.position;if(p&&p.isGLBufferAttribute){console.error("THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere.",this),this.boundingSphere.set(new Pi,1/0);return}if(p){const C=this.boundingSphere.center;if(Yl.setFromBufferAttribute(p),f)for(let U=0,B=f.length;U<B;U++){const s=f[U];ig.setFromBufferAttribute(s),this.morphTargetsRelative?(la.addVectors(Yl.min,ig.min),Yl.expandByPoint(la),la.addVectors(Yl.max,ig.max),Yl.expandByPoint(la)):(Yl.expandByPoint(ig.min),Yl.expandByPoint(ig.max))}Yl.getCenter(C);let D=0;for(let U=0,B=p.count;U<B;U++)la.fromBufferAttribute(p,U),D=Math.max(D,C.distanceToSquared(la));if(f)for(let U=0,B=f.length;U<B;U++){const s=f[U],Z=this.morphTargetsRelative;for(let j=0,Q=s.count;j<Q;j++)la.fromBufferAttribute(s,j),Z&&(kf.fromBufferAttribute(p,j),la.add(kf)),D=Math.max(D,C.distanceToSquared(la))}this.boundingSphere.radius=Math.sqrt(D),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){const p=this.index,f=this.attributes;if(p===null||f.position===void 0||f.normal===void 0||f.uv===void 0){console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");return}const C=f.position,D=f.normal,U=f.uv;this.hasAttribute("tangent")===!1&&this.setAttribute("tangent",new Of(new Float32Array(4*C.count),4));const B=this.getAttribute("tangent"),s=[],Z=[];for(let Ai=0;Ai<C.count;Ai++)s[Ai]=new Pi,Z[Ai]=new Pi;const j=new Pi,Q=new Pi,oe=new Pi,ve=new Rr,Ee=new Rr,We=new Rr,Re=new Pi,He=new Pi;function Mt(Ai,Ni,Qe){j.fromBufferAttribute(C,Ai),Q.fromBufferAttribute(C,Ni),oe.fromBufferAttribute(C,Qe),ve.fromBufferAttribute(U,Ai),Ee.fromBufferAttribute(U,Ni),We.fromBufferAttribute(U,Qe),Q.sub(j),oe.sub(j),Ee.sub(ve),We.sub(ve);const st=1/(Ee.x*We.y-We.x*Ee.y);isFinite(st)&&(Re.copy(Q).multiplyScalar(We.y).addScaledVector(oe,-Ee.y).multiplyScalar(st),He.copy(oe).multiplyScalar(Ee.x).addScaledVector(Q,-We.x).multiplyScalar(st),s[Ai].add(Re),s[Ni].add(Re),s[Qe].add(Re),Z[Ai].add(He),Z[Ni].add(He),Z[Qe].add(He))}let Lt=this.groups;Lt.length===0&&(Lt=[{start:0,count:p.count}]);for(let Ai=0,Ni=Lt.length;Ai<Ni;++Ai){const Qe=Lt[Ai],st=Qe.start,Ht=Qe.count;for(let en=st,ci=st+Ht;en<ci;en+=3)Mt(p.getX(en+0),p.getX(en+1),p.getX(en+2))}const Ut=new Pi,Wt=new Pi,lt=new Pi,Ct=new Pi;function qt(Ai){lt.fromBufferAttribute(D,Ai),Ct.copy(lt);const Ni=s[Ai];Ut.copy(Ni),Ut.sub(lt.multiplyScalar(lt.dot(Ni))).normalize(),Wt.crossVectors(Ct,Ni);const st=Wt.dot(Z[Ai])<0?-1:1;B.setXYZW(Ai,Ut.x,Ut.y,Ut.z,st)}for(let Ai=0,Ni=Lt.length;Ai<Ni;++Ai){const Qe=Lt[Ai],st=Qe.start,Ht=Qe.count;for(let en=st,ci=st+Ht;en<ci;en+=3)qt(p.getX(en+0)),qt(p.getX(en+1)),qt(p.getX(en+2))}}computeVertexNormals(){const p=this.index,f=this.getAttribute("position");if(f!==void 0){let C=this.getAttribute("normal");if(C===void 0)C=new Of(new Float32Array(f.count*3),3),this.setAttribute("normal",C);else for(let ve=0,Ee=C.count;ve<Ee;ve++)C.setXYZ(ve,0,0,0);const D=new Pi,U=new Pi,B=new Pi,s=new Pi,Z=new Pi,j=new Pi,Q=new Pi,oe=new Pi;if(p)for(let ve=0,Ee=p.count;ve<Ee;ve+=3){const We=p.getX(ve+0),Re=p.getX(ve+1),He=p.getX(ve+2);D.fromBufferAttribute(f,We),U.fromBufferAttribute(f,Re),B.fromBufferAttribute(f,He),Q.subVectors(B,U),oe.subVectors(D,U),Q.cross(oe),s.fromBufferAttribute(C,We),Z.fromBufferAttribute(C,Re),j.fromBufferAttribute(C,He),s.add(Q),Z.add(Q),j.add(Q),C.setXYZ(We,s.x,s.y,s.z),C.setXYZ(Re,Z.x,Z.y,Z.z),C.setXYZ(He,j.x,j.y,j.z)}else for(let ve=0,Ee=f.count;ve<Ee;ve+=3)D.fromBufferAttribute(f,ve+0),U.fromBufferAttribute(f,ve+1),B.fromBufferAttribute(f,ve+2),Q.subVectors(B,U),oe.subVectors(D,U),Q.cross(oe),C.setXYZ(ve+0,Q.x,Q.y,Q.z),C.setXYZ(ve+1,Q.x,Q.y,Q.z),C.setXYZ(ve+2,Q.x,Q.y,Q.z);this.normalizeNormals(),C.needsUpdate=!0}}normalizeNormals(){const p=this.attributes.normal;for(let f=0,C=p.count;f<C;f++)la.fromBufferAttribute(p,f),la.normalize(),p.setXYZ(f,la.x,la.y,la.z)}toNonIndexed(){function p(s,Z){const j=s.array,Q=s.itemSize,oe=s.normalized,ve=new j.constructor(Z.length*Q);let Ee=0,We=0;for(let Re=0,He=Z.length;Re<He;Re++){s.isInterleavedBufferAttribute?Ee=Z[Re]*s.data.stride+s.offset:Ee=Z[Re]*Q;for(let Mt=0;Mt<Q;Mt++)ve[We++]=j[Ee++]}return new Of(ve,Q,oe)}if(this.index===null)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const f=new Bf,C=this.index.array,D=this.attributes;for(const s in D){const Z=D[s],j=p(Z,C);f.setAttribute(s,j)}const U=this.morphAttributes;for(const s in U){const Z=[],j=U[s];for(let Q=0,oe=j.length;Q<oe;Q++){const ve=j[Q],Ee=p(ve,C);Z.push(Ee)}f.morphAttributes[s]=Z}f.morphTargetsRelative=this.morphTargetsRelative;const B=this.groups;for(let s=0,Z=B.length;s<Z;s++){const j=B[s];f.addGroup(j.start,j.count,j.materialIndex)}return f}toJSON(){const p={metadata:{version:4.6,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(p.uuid=this.uuid,p.type=this.type,this.name!==""&&(p.name=this.name),Object.keys(this.userData).length>0&&(p.userData=this.userData),this.parameters!==void 0){const Z=this.parameters;for(const j in Z)Z[j]!==void 0&&(p[j]=Z[j]);return p}p.data={attributes:{}};const f=this.index;f!==null&&(p.data.index={type:f.array.constructor.name,array:Array.prototype.slice.call(f.array)});const C=this.attributes;for(const Z in C){const j=C[Z];p.data.attributes[Z]=j.toJSON(p.data)}const D={};let U=!1;for(const Z in this.morphAttributes){const j=this.morphAttributes[Z],Q=[];for(let oe=0,ve=j.length;oe<ve;oe++){const Ee=j[oe];Q.push(Ee.toJSON(p.data))}Q.length>0&&(D[Z]=Q,U=!0)}U&&(p.data.morphAttributes=D,p.data.morphTargetsRelative=this.morphTargetsRelative);const B=this.groups;B.length>0&&(p.data.groups=JSON.parse(JSON.stringify(B)));const s=this.boundingSphere;return s!==null&&(p.data.boundingSphere={center:s.center.toArray(),radius:s.radius}),p}clone(){return new this.constructor().copy(this)}copy(p){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const f={};this.name=p.name;const C=p.index;C!==null&&this.setIndex(C.clone(f));const D=p.attributes;for(const j in D){const Q=D[j];this.setAttribute(j,Q.clone(f))}const U=p.morphAttributes;for(const j in U){const Q=[],oe=U[j];for(let ve=0,Ee=oe.length;ve<Ee;ve++)Q.push(oe[ve].clone(f));this.morphAttributes[j]=Q}this.morphTargetsRelative=p.morphTargetsRelative;const B=p.groups;for(let j=0,Q=B.length;j<Q;j++){const oe=B[j];this.addGroup(oe.start,oe.count,oe.materialIndex)}const s=p.boundingBox;s!==null&&(this.boundingBox=s.clone());const Z=p.boundingSphere;return Z!==null&&(this.boundingSphere=Z.clone()),this.drawRange.start=p.drawRange.start,this.drawRange.count=p.drawRange.count,this.userData=p.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}const Fv=new Xl,vp=new Ev,C_=new g0,kv=new Pi,Nf=new Pi,Uf=new Pi,Vf=new Pi,C0=new Pi,L_=new Pi,I_=new Rr,P_=new Rr,R_=new Rr,Bv=new Pi,Nv=new Pi,Uv=new Pi,D_=new Pi,z_=new Pi;class SE extends Rf{constructor(p=new Bf,f=new bE){super(),this.isMesh=!0,this.type="Mesh",this.geometry=p,this.material=f,this.updateMorphTargets()}copy(p,f){return super.copy(p,f),p.morphTargetInfluences!==void 0&&(this.morphTargetInfluences=p.morphTargetInfluences.slice()),p.morphTargetDictionary!==void 0&&(this.morphTargetDictionary=Object.assign({},p.morphTargetDictionary)),this.material=Array.isArray(p.material)?p.material.slice():p.material,this.geometry=p.geometry,this}updateMorphTargets(){const f=this.geometry.morphAttributes,C=Object.keys(f);if(C.length>0){const D=f[C[0]];if(D!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let U=0,B=D.length;U<B;U++){const s=D[U].name||String(U);this.morphTargetInfluences.push(0),this.morphTargetDictionary[s]=U}}}}getVertexPosition(p,f){const C=this.geometry,D=C.attributes.position,U=C.morphAttributes.position,B=C.morphTargetsRelative;f.fromBufferAttribute(D,p);const s=this.morphTargetInfluences;if(U&&s){L_.set(0,0,0);for(let Z=0,j=U.length;Z<j;Z++){const Q=s[Z],oe=U[Z];Q!==0&&(C0.fromBufferAttribute(oe,p),B?L_.addScaledVector(C0,Q):L_.addScaledVector(C0.sub(f),Q))}f.add(L_)}return f}raycast(p,f){const C=this.geometry,D=this.material,U=this.matrixWorld;D!==void 0&&(C.boundingSphere===null&&C.computeBoundingSphere(),C_.copy(C.boundingSphere),C_.applyMatrix4(U),vp.copy(p.ray).recast(p.near),!(C_.containsPoint(vp.origin)===!1&&(vp.intersectSphere(C_,kv)===null||vp.origin.distanceToSquared(kv)>(p.far-p.near)**2))&&(Fv.copy(U).invert(),vp.copy(p.ray).applyMatrix4(Fv),!(C.boundingBox!==null&&vp.intersectsBox(C.boundingBox)===!1)&&this._computeIntersections(p,f,vp)))}_computeIntersections(p,f,C){let D;const U=this.geometry,B=this.material,s=U.index,Z=U.attributes.position,j=U.attributes.uv,Q=U.attributes.uv1,oe=U.attributes.normal,ve=U.groups,Ee=U.drawRange;if(s!==null)if(Array.isArray(B))for(let We=0,Re=ve.length;We<Re;We++){const He=ve[We],Mt=B[He.materialIndex],Lt=Math.max(He.start,Ee.start),Ut=Math.min(s.count,Math.min(He.start+He.count,Ee.start+Ee.count));for(let Wt=Lt,lt=Ut;Wt<lt;Wt+=3){const Ct=s.getX(Wt),qt=s.getX(Wt+1),Ai=s.getX(Wt+2);D=O_(this,Mt,p,C,j,Q,oe,Ct,qt,Ai),D&&(D.faceIndex=Math.floor(Wt/3),D.face.materialIndex=He.materialIndex,f.push(D))}}else{const We=Math.max(0,Ee.start),Re=Math.min(s.count,Ee.start+Ee.count);for(let He=We,Mt=Re;He<Mt;He+=3){const Lt=s.getX(He),Ut=s.getX(He+1),Wt=s.getX(He+2);D=O_(this,B,p,C,j,Q,oe,Lt,Ut,Wt),D&&(D.faceIndex=Math.floor(He/3),f.push(D))}}else if(Z!==void 0)if(Array.isArray(B))for(let We=0,Re=ve.length;We<Re;We++){const He=ve[We],Mt=B[He.materialIndex],Lt=Math.max(He.start,Ee.start),Ut=Math.min(Z.count,Math.min(He.start+He.count,Ee.start+Ee.count));for(let Wt=Lt,lt=Ut;Wt<lt;Wt+=3){const Ct=Wt,qt=Wt+1,Ai=Wt+2;D=O_(this,Mt,p,C,j,Q,oe,Ct,qt,Ai),D&&(D.faceIndex=Math.floor(Wt/3),D.face.materialIndex=He.materialIndex,f.push(D))}}else{const We=Math.max(0,Ee.start),Re=Math.min(Z.count,Ee.start+Ee.count);for(let He=We,Mt=Re;He<Mt;He+=3){const Lt=He,Ut=He+1,Wt=He+2;D=O_(this,B,p,C,j,Q,oe,Lt,Ut,Wt),D&&(D.faceIndex=Math.floor(He/3),f.push(D))}}}}function EE(te,p,f,C,D,U,B,s){let Z;if(p.side===X2?Z=C.intersectTriangle(B,U,D,!0,s):Z=C.intersectTriangle(D,U,B,p.side===o0,s),Z===null)return null;z_.copy(s),z_.applyMatrix4(te.matrixWorld);const j=f.ray.origin.distanceTo(z_);return j<f.near||j>f.far?null:{distance:j,point:z_.clone(),object:te}}function O_(te,p,f,C,D,U,B,s,Z,j){te.getVertexPosition(s,Nf),te.getVertexPosition(Z,Uf),te.getVertexPosition(j,Vf);const Q=EE(te,p,f,C,Nf,Uf,Vf,D_);if(Q){D&&(I_.fromBufferAttribute(D,s),P_.fromBufferAttribute(D,Z),R_.fromBufferAttribute(D,j),Q.uv=ih.getInterpolation(D_,Nf,Uf,Vf,I_,P_,R_,new Rr)),U&&(I_.fromBufferAttribute(U,s),P_.fromBufferAttribute(U,Z),R_.fromBufferAttribute(U,j),Q.uv1=ih.getInterpolation(D_,Nf,Uf,Vf,I_,P_,R_,new Rr)),B&&(Bv.fromBufferAttribute(B,s),Nv.fromBufferAttribute(B,Z),Uv.fromBufferAttribute(B,j),Q.normal=ih.getInterpolation(D_,Nf,Uf,Vf,Bv,Nv,Uv,new Pi),Q.normal.dot(C.direction)>0&&Q.normal.multiplyScalar(-1));const oe={a:s,b:Z,c:j,normal:new Pi,materialIndex:0};ih.getNormal(Nf,Uf,Vf,oe.normal),Q.face=oe}return Q}class Vv extends E0{constructor(p){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new Md(16777215),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(p)}copy(p){return super.copy(p),this.color.copy(p.color),this.map=p.map,this.linewidth=p.linewidth,this.linecap=p.linecap,this.linejoin=p.linejoin,this.fog=p.fog,this}}const F_=new Pi,k_=new Pi,Gv=new Xl,ng=new Ev,B_=new g0,L0=new Pi,Hv=new Pi;class AE extends Rf{constructor(p=new Bf,f=new Vv){super(),this.isLine=!0,this.type="Line",this.geometry=p,this.material=f,this.updateMorphTargets()}copy(p,f){return super.copy(p,f),this.material=Array.isArray(p.material)?p.material.slice():p.material,this.geometry=p.geometry,this}computeLineDistances(){const p=this.geometry;if(p.index===null){const f=p.attributes.position,C=[0];for(let D=1,U=f.count;D<U;D++)F_.fromBufferAttribute(f,D-1),k_.fromBufferAttribute(f,D),C[D]=C[D-1],C[D]+=F_.distanceTo(k_);p.setAttribute("lineDistance",new Ff(C,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}raycast(p,f){const C=this.geometry,D=this.matrixWorld,U=p.params.Line.threshold,B=C.drawRange;if(C.boundingSphere===null&&C.computeBoundingSphere(),B_.copy(C.boundingSphere),B_.applyMatrix4(D),B_.radius+=U,p.ray.intersectsSphere(B_)===!1)return;Gv.copy(D).invert(),ng.copy(p.ray).applyMatrix4(Gv);const s=U/((this.scale.x+this.scale.y+this.scale.z)/3),Z=s*s,j=this.isLineSegments?2:1,Q=C.index,ve=C.attributes.position;if(Q!==null){const Ee=Math.max(0,B.start),We=Math.min(Q.count,B.start+B.count);for(let Re=Ee,He=We-1;Re<He;Re+=j){const Mt=Q.getX(Re),Lt=Q.getX(Re+1),Ut=N_(this,p,ng,Z,Mt,Lt);Ut&&f.push(Ut)}if(this.isLineLoop){const Re=Q.getX(We-1),He=Q.getX(Ee),Mt=N_(this,p,ng,Z,Re,He);Mt&&f.push(Mt)}}else{const Ee=Math.max(0,B.start),We=Math.min(ve.count,B.start+B.count);for(let Re=Ee,He=We-1;Re<He;Re+=j){const Mt=N_(this,p,ng,Z,Re,Re+1);Mt&&f.push(Mt)}if(this.isLineLoop){const Re=N_(this,p,ng,Z,We-1,Ee);Re&&f.push(Re)}}}updateMorphTargets(){const f=this.geometry.morphAttributes,C=Object.keys(f);if(C.length>0){const D=f[C[0]];if(D!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let U=0,B=D.length;U<B;U++){const s=D[U].name||String(U);this.morphTargetInfluences.push(0),this.morphTargetDictionary[s]=U}}}}}function N_(te,p,f,C,D,U){const B=te.geometry.attributes.position;if(F_.fromBufferAttribute(B,D),k_.fromBufferAttribute(B,U),f.distanceSqToSegment(F_,k_,L0,Hv)>C)return;L0.applyMatrix4(te.matrixWorld);const Z=p.ray.origin.distanceTo(L0);if(!(Z<p.near||Z>p.far))return{distance:Z,point:Hv.clone().applyMatrix4(te.matrixWorld),index:D,face:null,faceIndex:null,object:te}}const jv=new Pi,Wv=new Pi;class CE extends AE{constructor(p,f){super(p,f),this.isLineSegments=!0,this.type="LineSegments"}computeLineDistances(){const p=this.geometry;if(p.index===null){const f=p.attributes.position,C=[];for(let D=0,U=f.count;D<U;D+=2)jv.fromBufferAttribute(f,D),Wv.fromBufferAttribute(f,D+1),C[D]=D===0?0:C[D-1],C[D+1]=C[D]+jv.distanceTo(Wv);p.setAttribute("lineDistance",new Ff(C,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}}class Uh{constructor(){this.type="Curve",this.arcLengthDivisions=200}getPoint(){return console.warn("THREE.Curve: .getPoint() not implemented."),null}getPointAt(p,f){const C=this.getUtoTmapping(p);return this.getPoint(C,f)}getPoints(p=5){const f=[];for(let C=0;C<=p;C++)f.push(this.getPoint(C/p));return f}getSpacedPoints(p=5){const f=[];for(let C=0;C<=p;C++)f.push(this.getPointAt(C/p));return f}getLength(){const p=this.getLengths();return p[p.length-1]}getLengths(p=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===p+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const f=[];let C,D=this.getPoint(0),U=0;f.push(0);for(let B=1;B<=p;B++)C=this.getPoint(B/p),U+=C.distanceTo(D),f.push(U),D=C;return this.cacheArcLengths=f,f}updateArcLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(p,f){const C=this.getLengths();let D=0;const U=C.length;let B;f?B=f:B=p*C[U-1];let s=0,Z=U-1,j;for(;s<=Z;)if(D=Math.floor(s+(Z-s)/2),j=C[D]-B,j<0)s=D+1;else if(j>0)Z=D-1;else{Z=D;break}if(D=Z,C[D]===B)return D/(U-1);const Q=C[D],ve=C[D+1]-Q,Ee=(B-Q)/ve;return(D+Ee)/(U-1)}getTangent(p,f){let D=p-1e-4,U=p+1e-4;D<0&&(D=0),U>1&&(U=1);const B=this.getPoint(D),s=this.getPoint(U),Z=f||(B.isVector2?new Rr:new Pi);return Z.copy(s).sub(B).normalize(),Z}getTangentAt(p,f){const C=this.getUtoTmapping(p);return this.getTangent(C,f)}computeFrenetFrames(p,f){const C=new Pi,D=[],U=[],B=[],s=new Pi,Z=new Xl;for(let Ee=0;Ee<=p;Ee++){const We=Ee/p;D[Ee]=this.getTangentAt(We,new Pi)}U[0]=new Pi,B[0]=new Pi;let j=Number.MAX_VALUE;const Q=Math.abs(D[0].x),oe=Math.abs(D[0].y),ve=Math.abs(D[0].z);Q<=j&&(j=Q,C.set(1,0,0)),oe<=j&&(j=oe,C.set(0,1,0)),ve<=j&&C.set(0,0,1),s.crossVectors(D[0],C).normalize(),U[0].crossVectors(D[0],s),B[0].crossVectors(D[0],U[0]);for(let Ee=1;Ee<=p;Ee++){if(U[Ee]=U[Ee-1].clone(),B[Ee]=B[Ee-1].clone(),s.crossVectors(D[Ee-1],D[Ee]),s.length()>Number.EPSILON){s.normalize();const We=Math.acos(Fa(D[Ee-1].dot(D[Ee]),-1,1));U[Ee].applyMatrix4(Z.makeRotationAxis(s,We))}B[Ee].crossVectors(D[Ee],U[Ee])}if(f===!0){let Ee=Math.acos(Fa(U[0].dot(U[p]),-1,1));Ee/=p,D[0].dot(s.crossVectors(U[0],U[p]))>0&&(Ee=-Ee);for(let We=1;We<=p;We++)U[We].applyMatrix4(Z.makeRotationAxis(D[We],Ee*We)),B[We].crossVectors(D[We],U[We])}return{tangents:D,normals:U,binormals:B}}clone(){return new this.constructor().copy(this)}copy(p){return this.arcLengthDivisions=p.arcLengthDivisions,this}toJSON(){const p={metadata:{version:4.6,type:"Curve",generator:"Curve.toJSON"}};return p.arcLengthDivisions=this.arcLengthDivisions,p.type=this.type,p}fromJSON(p){return this.arcLengthDivisions=p.arcLengthDivisions,this}}class I0 extends Uh{constructor(p=0,f=0,C=1,D=1,U=0,B=Math.PI*2,s=!1,Z=0){super(),this.isEllipseCurve=!0,this.type="EllipseCurve",this.aX=p,this.aY=f,this.xRadius=C,this.yRadius=D,this.aStartAngle=U,this.aEndAngle=B,this.aClockwise=s,this.aRotation=Z}getPoint(p,f=new Rr){const C=f,D=Math.PI*2;let U=this.aEndAngle-this.aStartAngle;const B=Math.abs(U)<Number.EPSILON;for(;U<0;)U+=D;for(;U>D;)U-=D;U<Number.EPSILON&&(B?U=0:U=D),this.aClockwise===!0&&!B&&(U===D?U=-D:U=U-D);const s=this.aStartAngle+p*U;let Z=this.aX+this.xRadius*Math.cos(s),j=this.aY+this.yRadius*Math.sin(s);if(this.aRotation!==0){const Q=Math.cos(this.aRotation),oe=Math.sin(this.aRotation),ve=Z-this.aX,Ee=j-this.aY;Z=ve*Q-Ee*oe+this.aX,j=ve*oe+Ee*Q+this.aY}return C.set(Z,j)}copy(p){return super.copy(p),this.aX=p.aX,this.aY=p.aY,this.xRadius=p.xRadius,this.yRadius=p.yRadius,this.aStartAngle=p.aStartAngle,this.aEndAngle=p.aEndAngle,this.aClockwise=p.aClockwise,this.aRotation=p.aRotation,this}toJSON(){const p=super.toJSON();return p.aX=this.aX,p.aY=this.aY,p.xRadius=this.xRadius,p.yRadius=this.yRadius,p.aStartAngle=this.aStartAngle,p.aEndAngle=this.aEndAngle,p.aClockwise=this.aClockwise,p.aRotation=this.aRotation,p}fromJSON(p){return super.fromJSON(p),this.aX=p.aX,this.aY=p.aY,this.xRadius=p.xRadius,this.yRadius=p.yRadius,this.aStartAngle=p.aStartAngle,this.aEndAngle=p.aEndAngle,this.aClockwise=p.aClockwise,this.aRotation=p.aRotation,this}}class LE extends I0{constructor(p,f,C,D,U,B){super(p,f,C,C,D,U,B),this.isArcCurve=!0,this.type="ArcCurve"}}function P0(){let te=0,p=0,f=0,C=0;function D(U,B,s,Z){te=U,p=s,f=-3*U+3*B-2*s-Z,C=2*U-2*B+s+Z}return{initCatmullRom:function(U,B,s,Z,j){D(B,s,j*(s-U),j*(Z-B))},initNonuniformCatmullRom:function(U,B,s,Z,j,Q,oe){let ve=(B-U)/j-(s-U)/(j+Q)+(s-B)/Q,Ee=(s-B)/Q-(Z-B)/(Q+oe)+(Z-s)/oe;ve*=Q,Ee*=Q,D(B,s,ve,Ee)},calc:function(U){const B=U*U,s=B*U;return te+p*U+f*B+C*s}}}const U_=new Pi,R0=new P0,D0=new P0,z0=new P0;class IE extends Uh{constructor(p=[],f=!1,C="centripetal",D=.5){super(),this.isCatmullRomCurve3=!0,this.type="CatmullRomCurve3",this.points=p,this.closed=f,this.curveType=C,this.tension=D}getPoint(p,f=new Pi){const C=f,D=this.points,U=D.length,B=(U-(this.closed?0:1))*p;let s=Math.floor(B),Z=B-s;this.closed?s+=s>0?0:(Math.floor(Math.abs(s)/U)+1)*U:Z===0&&s===U-1&&(s=U-2,Z=1);let j,Q;this.closed||s>0?j=D[(s-1)%U]:(U_.subVectors(D[0],D[1]).add(D[0]),j=U_);const oe=D[s%U],ve=D[(s+1)%U];if(this.closed||s+2<U?Q=D[(s+2)%U]:(U_.subVectors(D[U-1],D[U-2]).add(D[U-1]),Q=U_),this.curveType==="centripetal"||this.curveType==="chordal"){const Ee=this.curveType==="chordal"?.5:.25;let We=Math.pow(j.distanceToSquared(oe),Ee),Re=Math.pow(oe.distanceToSquared(ve),Ee),He=Math.pow(ve.distanceToSquared(Q),Ee);Re<1e-4&&(Re=1),We<1e-4&&(We=Re),He<1e-4&&(He=Re),R0.initNonuniformCatmullRom(j.x,oe.x,ve.x,Q.x,We,Re,He),D0.initNonuniformCatmullRom(j.y,oe.y,ve.y,Q.y,We,Re,He),z0.initNonuniformCatmullRom(j.z,oe.z,ve.z,Q.z,We,Re,He)}else this.curveType==="catmullrom"&&(R0.initCatmullRom(j.x,oe.x,ve.x,Q.x,this.tension),D0.initCatmullRom(j.y,oe.y,ve.y,Q.y,this.tension),z0.initCatmullRom(j.z,oe.z,ve.z,Q.z,this.tension));return C.set(R0.calc(Z),D0.calc(Z),z0.calc(Z)),C}copy(p){super.copy(p),this.points=[];for(let f=0,C=p.points.length;f<C;f++){const D=p.points[f];this.points.push(D.clone())}return this.closed=p.closed,this.curveType=p.curveType,this.tension=p.tension,this}toJSON(){const p=super.toJSON();p.points=[];for(let f=0,C=this.points.length;f<C;f++){const D=this.points[f];p.points.push(D.toArray())}return p.closed=this.closed,p.curveType=this.curveType,p.tension=this.tension,p}fromJSON(p){super.fromJSON(p),this.points=[];for(let f=0,C=p.points.length;f<C;f++){const D=p.points[f];this.points.push(new Pi().fromArray(D))}return this.closed=p.closed,this.curveType=p.curveType,this.tension=p.tension,this}}function qv(te,p,f,C,D){const U=(C-p)*.5,B=(D-f)*.5,s=te*te,Z=te*s;return(2*f-2*C+U+B)*Z+(-3*f+3*C-2*U-B)*s+U*te+f}function PE(te,p){const f=1-te;return f*f*p}function RE(te,p){return 2*(1-te)*te*p}function DE(te,p){return te*te*p}function rg(te,p,f,C){return PE(te,p)+RE(te,f)+DE(te,C)}function zE(te,p){const f=1-te;return f*f*f*p}function OE(te,p){const f=1-te;return 3*f*f*te*p}function FE(te,p){return 3*(1-te)*te*te*p}function kE(te,p){return te*te*te*p}function sg(te,p,f,C,D){return zE(te,p)+OE(te,f)+FE(te,C)+kE(te,D)}class Zv extends Uh{constructor(p=new Rr,f=new Rr,C=new Rr,D=new Rr){super(),this.isCubicBezierCurve=!0,this.type="CubicBezierCurve",this.v0=p,this.v1=f,this.v2=C,this.v3=D}getPoint(p,f=new Rr){const C=f,D=this.v0,U=this.v1,B=this.v2,s=this.v3;return C.set(sg(p,D.x,U.x,B.x,s.x),sg(p,D.y,U.y,B.y,s.y)),C}copy(p){return super.copy(p),this.v0.copy(p.v0),this.v1.copy(p.v1),this.v2.copy(p.v2),this.v3.copy(p.v3),this}toJSON(){const p=super.toJSON();return p.v0=this.v0.toArray(),p.v1=this.v1.toArray(),p.v2=this.v2.toArray(),p.v3=this.v3.toArray(),p}fromJSON(p){return super.fromJSON(p),this.v0.fromArray(p.v0),this.v1.fromArray(p.v1),this.v2.fromArray(p.v2),this.v3.fromArray(p.v3),this}}class BE extends Uh{constructor(p=new Pi,f=new Pi,C=new Pi,D=new Pi){super(),this.isCubicBezierCurve3=!0,this.type="CubicBezierCurve3",this.v0=p,this.v1=f,this.v2=C,this.v3=D}getPoint(p,f=new Pi){const C=f,D=this.v0,U=this.v1,B=this.v2,s=this.v3;return C.set(sg(p,D.x,U.x,B.x,s.x),sg(p,D.y,U.y,B.y,s.y),sg(p,D.z,U.z,B.z,s.z)),C}copy(p){return super.copy(p),this.v0.copy(p.v0),this.v1.copy(p.v1),this.v2.copy(p.v2),this.v3.copy(p.v3),this}toJSON(){const p=super.toJSON();return p.v0=this.v0.toArray(),p.v1=this.v1.toArray(),p.v2=this.v2.toArray(),p.v3=this.v3.toArray(),p}fromJSON(p){return super.fromJSON(p),this.v0.fromArray(p.v0),this.v1.fromArray(p.v1),this.v2.fromArray(p.v2),this.v3.fromArray(p.v3),this}}class Xv extends Uh{constructor(p=new Rr,f=new Rr){super(),this.isLineCurve=!0,this.type="LineCurve",this.v1=p,this.v2=f}getPoint(p,f=new Rr){const C=f;return p===1?C.copy(this.v2):(C.copy(this.v2).sub(this.v1),C.multiplyScalar(p).add(this.v1)),C}getPointAt(p,f){return this.getPoint(p,f)}getTangent(p,f=new Rr){return f.subVectors(this.v2,this.v1).normalize()}getTangentAt(p,f){return this.getTangent(p,f)}copy(p){return super.copy(p),this.v1.copy(p.v1),this.v2.copy(p.v2),this}toJSON(){const p=super.toJSON();return p.v1=this.v1.toArray(),p.v2=this.v2.toArray(),p}fromJSON(p){return super.fromJSON(p),this.v1.fromArray(p.v1),this.v2.fromArray(p.v2),this}}class NE extends Uh{constructor(p=new Pi,f=new Pi){super(),this.isLineCurve3=!0,this.type="LineCurve3",this.v1=p,this.v2=f}getPoint(p,f=new Pi){const C=f;return p===1?C.copy(this.v2):(C.copy(this.v2).sub(this.v1),C.multiplyScalar(p).add(this.v1)),C}getPointAt(p,f){return this.getPoint(p,f)}getTangent(p,f=new Pi){return f.subVectors(this.v2,this.v1).normalize()}getTangentAt(p,f){return this.getTangent(p,f)}copy(p){return super.copy(p),this.v1.copy(p.v1),this.v2.copy(p.v2),this}toJSON(){const p=super.toJSON();return p.v1=this.v1.toArray(),p.v2=this.v2.toArray(),p}fromJSON(p){return super.fromJSON(p),this.v1.fromArray(p.v1),this.v2.fromArray(p.v2),this}}class $v extends Uh{constructor(p=new Rr,f=new Rr,C=new Rr){super(),this.isQuadraticBezierCurve=!0,this.type="QuadraticBezierCurve",this.v0=p,this.v1=f,this.v2=C}getPoint(p,f=new Rr){const C=f,D=this.v0,U=this.v1,B=this.v2;return C.set(rg(p,D.x,U.x,B.x),rg(p,D.y,U.y,B.y)),C}copy(p){return super.copy(p),this.v0.copy(p.v0),this.v1.copy(p.v1),this.v2.copy(p.v2),this}toJSON(){const p=super.toJSON();return p.v0=this.v0.toArray(),p.v1=this.v1.toArray(),p.v2=this.v2.toArray(),p}fromJSON(p){return super.fromJSON(p),this.v0.fromArray(p.v0),this.v1.fromArray(p.v1),this.v2.fromArray(p.v2),this}}class UE extends Uh{constructor(p=new Pi,f=new Pi,C=new Pi){super(),this.isQuadraticBezierCurve3=!0,this.type="QuadraticBezierCurve3",this.v0=p,this.v1=f,this.v2=C}getPoint(p,f=new Pi){const C=f,D=this.v0,U=this.v1,B=this.v2;return C.set(rg(p,D.x,U.x,B.x),rg(p,D.y,U.y,B.y),rg(p,D.z,U.z,B.z)),C}copy(p){return super.copy(p),this.v0.copy(p.v0),this.v1.copy(p.v1),this.v2.copy(p.v2),this}toJSON(){const p=super.toJSON();return p.v0=this.v0.toArray(),p.v1=this.v1.toArray(),p.v2=this.v2.toArray(),p}fromJSON(p){return super.fromJSON(p),this.v0.fromArray(p.v0),this.v1.fromArray(p.v1),this.v2.fromArray(p.v2),this}}class Yv extends Uh{constructor(p=[]){super(),this.isSplineCurve=!0,this.type="SplineCurve",this.points=p}getPoint(p,f=new Rr){const C=f,D=this.points,U=(D.length-1)*p,B=Math.floor(U),s=U-B,Z=D[B===0?B:B-1],j=D[B],Q=D[B>D.length-2?D.length-1:B+1],oe=D[B>D.length-3?D.length-1:B+2];return C.set(qv(s,Z.x,j.x,Q.x,oe.x),qv(s,Z.y,j.y,Q.y,oe.y)),C}copy(p){super.copy(p),this.points=[];for(let f=0,C=p.points.length;f<C;f++){const D=p.points[f];this.points.push(D.clone())}return this}toJSON(){const p=super.toJSON();p.points=[];for(let f=0,C=this.points.length;f<C;f++){const D=this.points[f];p.points.push(D.toArray())}return p}fromJSON(p){super.fromJSON(p),this.points=[];for(let f=0,C=p.points.length;f<C;f++){const D=p.points[f];this.points.push(new Rr().fromArray(D))}return this}}var O0=Object.freeze({__proto__:null,ArcCurve:LE,CatmullRomCurve3:IE,CubicBezierCurve:Zv,CubicBezierCurve3:BE,EllipseCurve:I0,LineCurve:Xv,LineCurve3:NE,QuadraticBezierCurve:$v,QuadraticBezierCurve3:UE,SplineCurve:Yv});class VE extends Uh{constructor(){super(),this.type="CurvePath",this.curves=[],this.autoClose=!1}add(p){this.curves.push(p)}closePath(){const p=this.curves[0].getPoint(0),f=this.curves[this.curves.length-1].getPoint(1);if(!p.equals(f)){const C=p.isVector2===!0?"LineCurve":"LineCurve3";this.curves.push(new O0[C](f,p))}return this}getPoint(p,f){const C=p*this.getLength(),D=this.getCurveLengths();let U=0;for(;U<D.length;){if(D[U]>=C){const B=D[U]-C,s=this.curves[U],Z=s.getLength(),j=Z===0?0:1-B/Z;return s.getPointAt(j,f)}U++}return null}getLength(){const p=this.getCurveLengths();return p[p.length-1]}updateArcLengths(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()}getCurveLengths(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;const p=[];let f=0;for(let C=0,D=this.curves.length;C<D;C++)f+=this.curves[C].getLength(),p.push(f);return this.cacheLengths=p,p}getSpacedPoints(p=40){const f=[];for(let C=0;C<=p;C++)f.push(this.getPoint(C/p));return this.autoClose&&f.push(f[0]),f}getPoints(p=12){const f=[];let C;for(let D=0,U=this.curves;D<U.length;D++){const B=U[D],s=B.isEllipseCurve?p*2:B.isLineCurve||B.isLineCurve3?1:B.isSplineCurve?p*B.points.length:p,Z=B.getPoints(s);for(let j=0;j<Z.length;j++){const Q=Z[j];C&&C.equals(Q)||(f.push(Q),C=Q)}}return this.autoClose&&f.length>1&&!f[f.length-1].equals(f[0])&&f.push(f[0]),f}copy(p){super.copy(p),this.curves=[];for(let f=0,C=p.curves.length;f<C;f++){const D=p.curves[f];this.curves.push(D.clone())}return this.autoClose=p.autoClose,this}toJSON(){const p=super.toJSON();p.autoClose=this.autoClose,p.curves=[];for(let f=0,C=this.curves.length;f<C;f++){const D=this.curves[f];p.curves.push(D.toJSON())}return p}fromJSON(p){super.fromJSON(p),this.autoClose=p.autoClose,this.curves=[];for(let f=0,C=p.curves.length;f<C;f++){const D=p.curves[f];this.curves.push(new O0[D.type]().fromJSON(D))}return this}}class Jv extends VE{constructor(p){super(),this.type="Path",this.currentPoint=new Rr,p&&this.setFromPoints(p)}setFromPoints(p){this.moveTo(p[0].x,p[0].y);for(let f=1,C=p.length;f<C;f++)this.lineTo(p[f].x,p[f].y);return this}moveTo(p,f){return this.currentPoint.set(p,f),this}lineTo(p,f){const C=new Xv(this.currentPoint.clone(),new Rr(p,f));return this.curves.push(C),this.currentPoint.set(p,f),this}quadraticCurveTo(p,f,C,D){const U=new $v(this.currentPoint.clone(),new Rr(p,f),new Rr(C,D));return this.curves.push(U),this.currentPoint.set(C,D),this}bezierCurveTo(p,f,C,D,U,B){const s=new Zv(this.currentPoint.clone(),new Rr(p,f),new Rr(C,D),new Rr(U,B));return this.curves.push(s),this.currentPoint.set(U,B),this}splineThru(p){const f=[this.currentPoint.clone()].concat(p),C=new Yv(f);return this.curves.push(C),this.currentPoint.copy(p[p.length-1]),this}arc(p,f,C,D,U,B){const s=this.currentPoint.x,Z=this.currentPoint.y;return this.absarc(p+s,f+Z,C,D,U,B),this}absarc(p,f,C,D,U,B){return this.absellipse(p,f,C,C,D,U,B),this}ellipse(p,f,C,D,U,B,s,Z){const j=this.currentPoint.x,Q=this.currentPoint.y;return this.absellipse(p+j,f+Q,C,D,U,B,s,Z),this}absellipse(p,f,C,D,U,B,s,Z){const j=new I0(p,f,C,D,U,B,s,Z);if(this.curves.length>0){const oe=j.getPoint(0);oe.equals(this.currentPoint)||this.lineTo(oe.x,oe.y)}this.curves.push(j);const Q=j.getPoint(1);return this.currentPoint.copy(Q),this}copy(p){return super.copy(p),this.currentPoint.copy(p.currentPoint),this}toJSON(){const p=super.toJSON();return p.currentPoint=this.currentPoint.toArray(),p}fromJSON(p){return super.fromJSON(p),this.currentPoint.fromArray(p.currentPoint),this}}const V_=new Pi,G_=new Pi,F0=new Pi,H_=new ih;class GE extends Bf{constructor(p=null,f=1){if(super(),this.type="EdgesGeometry",this.parameters={geometry:p,thresholdAngle:f},p!==null){const D=Math.pow(10,4),U=Math.cos(nE*f),B=p.getIndex(),s=p.getAttribute("position"),Z=B?B.count:s.count,j=[0,0,0],Q=["a","b","c"],oe=new Array(3),ve={},Ee=[];for(let We=0;We<Z;We+=3){B?(j[0]=B.getX(We),j[1]=B.getX(We+1),j[2]=B.getX(We+2)):(j[0]=We,j[1]=We+1,j[2]=We+2);const{a:Re,b:He,c:Mt}=H_;if(Re.fromBufferAttribute(s,j[0]),He.fromBufferAttribute(s,j[1]),Mt.fromBufferAttribute(s,j[2]),H_.getNormal(F0),oe[0]=`${Math.round(Re.x*D)},${Math.round(Re.y*D)},${Math.round(Re.z*D)}`,oe[1]=`${Math.round(He.x*D)},${Math.round(He.y*D)},${Math.round(He.z*D)}`,oe[2]=`${Math.round(Mt.x*D)},${Math.round(Mt.y*D)},${Math.round(Mt.z*D)}`,!(oe[0]===oe[1]||oe[1]===oe[2]||oe[2]===oe[0]))for(let Lt=0;Lt<3;Lt++){const Ut=(Lt+1)%3,Wt=oe[Lt],lt=oe[Ut],Ct=H_[Q[Lt]],qt=H_[Q[Ut]],Ai=`${Wt}_${lt}`,Ni=`${lt}_${Wt}`;Ni in ve&&ve[Ni]?(F0.dot(ve[Ni].normal)<=U&&(Ee.push(Ct.x,Ct.y,Ct.z),Ee.push(qt.x,qt.y,qt.z)),ve[Ni]=null):Ai in ve||(ve[Ai]={index0:j[Lt],index1:j[Ut],normal:F0.clone()})}}for(const We in ve)if(ve[We]){const{index0:Re,index1:He}=ve[We];V_.fromBufferAttribute(s,Re),G_.fromBufferAttribute(s,He),Ee.push(V_.x,V_.y,V_.z),Ee.push(G_.x,G_.y,G_.z)}this.setAttribute("position",new Ff(Ee,3))}}copy(p){return super.copy(p),this.parameters=Object.assign({},p.parameters),this}}class Kv extends Jv{constructor(p){super(p),this.uuid=wf(),this.type="Shape",this.holes=[]}getPointsHoles(p){const f=[];for(let C=0,D=this.holes.length;C<D;C++)f[C]=this.holes[C].getPoints(p);return f}extractPoints(p){return{shape:this.getPoints(p),holes:this.getPointsHoles(p)}}copy(p){super.copy(p),this.holes=[];for(let f=0,C=p.holes.length;f<C;f++){const D=p.holes[f];this.holes.push(D.clone())}return this}toJSON(){const p=super.toJSON();p.uuid=this.uuid,p.holes=[];for(let f=0,C=this.holes.length;f<C;f++){const D=this.holes[f];p.holes.push(D.toJSON())}return p}fromJSON(p){super.fromJSON(p),this.uuid=p.uuid,this.holes=[];for(let f=0,C=p.holes.length;f<C;f++){const D=p.holes[f];this.holes.push(new Jv().fromJSON(D))}return this}}const HE={triangulate:function(te,p,f=2){const C=p&&p.length,D=C?p[0]*f:te.length;let U=Qv(te,0,D,f,!0);const B=[];if(!U||U.next===U.prev)return B;let s,Z,j,Q,oe,ve,Ee;if(C&&(U=XE(te,p,U,f)),te.length>80*f){s=j=te[0],Z=Q=te[1];for(let We=f;We<D;We+=f)oe=te[We],ve=te[We+1],oe<s&&(s=oe),ve<Z&&(Z=ve),oe>j&&(j=oe),ve>Q&&(Q=ve);Ee=Math.max(j-s,Q-Z),Ee=Ee!==0?32767/Ee:0}return og(U,B,f,s,Z,Ee,0),B}};function Qv(te,p,f,C,D){let U,B;if(D===sA(te,p,f,C)>0)for(U=p;U<f;U+=C)B=i1(U,te[U],te[U+1],B);else for(U=f-C;U>=p;U-=C)B=i1(U,te[U],te[U+1],B);return B&&j_(B,B.next)&&(lg(B),B=B.next),B}function bp(te,p){if(!te)return te;p||(p=te);let f=te,C;do if(C=!1,!f.steiner&&(j_(f,f.next)||vo(f.prev,f,f.next)===0)){if(lg(f),f=p=f.prev,f===f.next)break;C=!0}else f=f.next;while(C||f!==p);return p}function og(te,p,f,C,D,U,B){if(!te)return;!B&&U&&QE(te,C,D,U);let s=te,Z,j;for(;te.prev!==te.next;){if(Z=te.prev,j=te.next,U?WE(te,C,D,U):jE(te)){p.push(Z.i/f|0),p.push(te.i/f|0),p.push(j.i/f|0),lg(te),te=j.next,s=j.next;continue}if(te=j,te===s){B?B===1?(te=qE(bp(te),p,f),og(te,p,f,C,D,U,2)):B===2&&ZE(te,p,f,C,D,U):og(bp(te),p,f,C,D,U,1);break}}}function jE(te){const p=te.prev,f=te,C=te.next;if(vo(p,f,C)>=0)return!1;const D=p.x,U=f.x,B=C.x,s=p.y,Z=f.y,j=C.y,Q=D<U?D<B?D:B:U<B?U:B,oe=s<Z?s<j?s:j:Z<j?Z:j,ve=D>U?D>B?D:B:U>B?U:B,Ee=s>Z?s>j?s:j:Z>j?Z:j;let We=C.next;for(;We!==p;){if(We.x>=Q&&We.x<=ve&&We.y>=oe&&We.y<=Ee&&Gf(D,s,U,Z,B,j,We.x,We.y)&&vo(We.prev,We,We.next)>=0)return!1;We=We.next}return!0}function WE(te,p,f,C){const D=te.prev,U=te,B=te.next;if(vo(D,U,B)>=0)return!1;const s=D.x,Z=U.x,j=B.x,Q=D.y,oe=U.y,ve=B.y,Ee=s<Z?s<j?s:j:Z<j?Z:j,We=Q<oe?Q<ve?Q:ve:oe<ve?oe:ve,Re=s>Z?s>j?s:j:Z>j?Z:j,He=Q>oe?Q>ve?Q:ve:oe>ve?oe:ve,Mt=k0(Ee,We,p,f,C),Lt=k0(Re,He,p,f,C);let Ut=te.prevZ,Wt=te.nextZ;for(;Ut&&Ut.z>=Mt&&Wt&&Wt.z<=Lt;){if(Ut.x>=Ee&&Ut.x<=Re&&Ut.y>=We&&Ut.y<=He&&Ut!==D&&Ut!==B&&Gf(s,Q,Z,oe,j,ve,Ut.x,Ut.y)&&vo(Ut.prev,Ut,Ut.next)>=0||(Ut=Ut.prevZ,Wt.x>=Ee&&Wt.x<=Re&&Wt.y>=We&&Wt.y<=He&&Wt!==D&&Wt!==B&&Gf(s,Q,Z,oe,j,ve,Wt.x,Wt.y)&&vo(Wt.prev,Wt,Wt.next)>=0))return!1;Wt=Wt.nextZ}for(;Ut&&Ut.z>=Mt;){if(Ut.x>=Ee&&Ut.x<=Re&&Ut.y>=We&&Ut.y<=He&&Ut!==D&&Ut!==B&&Gf(s,Q,Z,oe,j,ve,Ut.x,Ut.y)&&vo(Ut.prev,Ut,Ut.next)>=0)return!1;Ut=Ut.prevZ}for(;Wt&&Wt.z<=Lt;){if(Wt.x>=Ee&&Wt.x<=Re&&Wt.y>=We&&Wt.y<=He&&Wt!==D&&Wt!==B&&Gf(s,Q,Z,oe,j,ve,Wt.x,Wt.y)&&vo(Wt.prev,Wt,Wt.next)>=0)return!1;Wt=Wt.nextZ}return!0}function qE(te,p,f){let C=te;do{const D=C.prev,U=C.next.next;!j_(D,U)&&e1(D,C,C.next,U)&&ag(D,U)&&ag(U,D)&&(p.push(D.i/f|0),p.push(C.i/f|0),p.push(U.i/f|0),lg(C),lg(C.next),C=te=U),C=C.next}while(C!==te);return bp(C)}function ZE(te,p,f,C,D,U){let B=te;do{let s=B.next.next;for(;s!==B.prev;){if(B.i!==s.i&&iA(B,s)){let Z=t1(B,s);B=bp(B,B.next),Z=bp(Z,Z.next),og(B,p,f,C,D,U,0),og(Z,p,f,C,D,U,0);return}s=s.next}B=B.next}while(B!==te)}function XE(te,p,f,C){const D=[];let U,B,s,Z,j;for(U=0,B=p.length;U<B;U++)s=p[U]*C,Z=U<B-1?p[U+1]*C:te.length,j=Qv(te,s,Z,C,!1),j===j.next&&(j.steiner=!0),D.push(tA(j));for(D.sort($E),U=0;U<D.length;U++)f=YE(D[U],f);return f}function $E(te,p){return te.x-p.x}function YE(te,p){const f=JE(te,p);if(!f)return p;const C=t1(f,te);return bp(C,C.next),bp(f,f.next)}function JE(te,p){let f=p,C=-1/0,D;const U=te.x,B=te.y;do{if(B<=f.y&&B>=f.next.y&&f.next.y!==f.y){const ve=f.x+(B-f.y)*(f.next.x-f.x)/(f.next.y-f.y);if(ve<=U&&ve>C&&(C=ve,D=f.x<f.next.x?f:f.next,ve===U))return D}f=f.next}while(f!==p);if(!D)return null;const s=D,Z=D.x,j=D.y;let Q=1/0,oe;f=D;do U>=f.x&&f.x>=Z&&U!==f.x&&Gf(B<j?U:C,B,Z,j,B<j?C:U,B,f.x,f.y)&&(oe=Math.abs(B-f.y)/(U-f.x),ag(f,te)&&(oe<Q||oe===Q&&(f.x>D.x||f.x===D.x&&KE(D,f)))&&(D=f,Q=oe)),f=f.next;while(f!==s);return D}function KE(te,p){return vo(te.prev,te,p.prev)<0&&vo(p.next,te,te.next)<0}function QE(te,p,f,C){let D=te;do D.z===0&&(D.z=k0(D.x,D.y,p,f,C)),D.prevZ=D.prev,D.nextZ=D.next,D=D.next;while(D!==te);D.prevZ.nextZ=null,D.prevZ=null,eA(D)}function eA(te){let p,f,C,D,U,B,s,Z,j=1;do{for(f=te,te=null,U=null,B=0;f;){for(B++,C=f,s=0,p=0;p<j&&(s++,C=C.nextZ,!!C);p++);for(Z=j;s>0||Z>0&&C;)s!==0&&(Z===0||!C||f.z<=C.z)?(D=f,f=f.nextZ,s--):(D=C,C=C.nextZ,Z--),U?U.nextZ=D:te=D,D.prevZ=U,U=D;f=C}U.nextZ=null,j*=2}while(B>1);return te}function k0(te,p,f,C,D){return te=(te-f)*D|0,p=(p-C)*D|0,te=(te|te<<8)&16711935,te=(te|te<<4)&252645135,te=(te|te<<2)&858993459,te=(te|te<<1)&1431655765,p=(p|p<<8)&16711935,p=(p|p<<4)&252645135,p=(p|p<<2)&858993459,p=(p|p<<1)&1431655765,te|p<<1}function tA(te){let p=te,f=te;do(p.x<f.x||p.x===f.x&&p.y<f.y)&&(f=p),p=p.next;while(p!==te);return f}function Gf(te,p,f,C,D,U,B,s){return(D-B)*(p-s)>=(te-B)*(U-s)&&(te-B)*(C-s)>=(f-B)*(p-s)&&(f-B)*(U-s)>=(D-B)*(C-s)}function iA(te,p){return te.next.i!==p.i&&te.prev.i!==p.i&&!nA(te,p)&&(ag(te,p)&&ag(p,te)&&rA(te,p)&&(vo(te.prev,te,p.prev)||vo(te,p.prev,p))||j_(te,p)&&vo(te.prev,te,te.next)>0&&vo(p.prev,p,p.next)>0)}function vo(te,p,f){return(p.y-te.y)*(f.x-p.x)-(p.x-te.x)*(f.y-p.y)}function j_(te,p){return te.x===p.x&&te.y===p.y}function e1(te,p,f,C){const D=q_(vo(te,p,f)),U=q_(vo(te,p,C)),B=q_(vo(f,C,te)),s=q_(vo(f,C,p));return!!(D!==U&&B!==s||D===0&&W_(te,f,p)||U===0&&W_(te,C,p)||B===0&&W_(f,te,C)||s===0&&W_(f,p,C))}function W_(te,p,f){return p.x<=Math.max(te.x,f.x)&&p.x>=Math.min(te.x,f.x)&&p.y<=Math.max(te.y,f.y)&&p.y>=Math.min(te.y,f.y)}function q_(te){return te>0?1:te<0?-1:0}function nA(te,p){let f=te;do{if(f.i!==te.i&&f.next.i!==te.i&&f.i!==p.i&&f.next.i!==p.i&&e1(f,f.next,te,p))return!0;f=f.next}while(f!==te);return!1}function ag(te,p){return vo(te.prev,te,te.next)<0?vo(te,p,te.next)>=0&&vo(te,te.prev,p)>=0:vo(te,p,te.prev)<0||vo(te,te.next,p)<0}function rA(te,p){let f=te,C=!1;const D=(te.x+p.x)/2,U=(te.y+p.y)/2;do f.y>U!=f.next.y>U&&f.next.y!==f.y&&D<(f.next.x-f.x)*(U-f.y)/(f.next.y-f.y)+f.x&&(C=!C),f=f.next;while(f!==te);return C}function t1(te,p){const f=new B0(te.i,te.x,te.y),C=new B0(p.i,p.x,p.y),D=te.next,U=p.prev;return te.next=p,p.prev=te,f.next=D,D.prev=f,C.next=f,f.prev=C,U.next=C,C.prev=U,C}function i1(te,p,f,C){const D=new B0(te,p,f);return C?(D.next=C.next,D.prev=C,C.next.prev=D,C.next=D):(D.prev=D,D.next=D),D}function lg(te){te.next.prev=te.prev,te.prev.next=te.next,te.prevZ&&(te.prevZ.nextZ=te.nextZ),te.nextZ&&(te.nextZ.prevZ=te.prevZ)}function B0(te,p,f){this.i=te,this.x=p,this.y=f,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function sA(te,p,f,C){let D=0;for(let U=p,B=f-C;U<f;U+=C)D+=(te[B]-te[U])*(te[U+1]+te[B+1]),B=U;return D}class cg{static area(p){const f=p.length;let C=0;for(let D=f-1,U=0;U<f;D=U++)C+=p[D].x*p[U].y-p[U].x*p[D].y;return C*.5}static isClockWise(p){return cg.area(p)<0}static triangulateShape(p,f){const C=[],D=[],U=[];n1(p),r1(C,p);let B=p.length;f.forEach(n1);for(let Z=0;Z<f.length;Z++)D.push(B),B+=f[Z].length,r1(C,f[Z]);const s=HE.triangulate(C,D);for(let Z=0;Z<s.length;Z+=3)U.push(s.slice(Z,Z+3));return U}}function n1(te){const p=te.length;p>2&&te[p-1].equals(te[0])&&te.pop()}function r1(te,p){for(let f=0;f<p.length;f++)te.push(p[f].x),te.push(p[f].y)}class N0 extends Bf{constructor(p=new Kv([new Rr(.5,.5),new Rr(-.5,.5),new Rr(-.5,-.5),new Rr(.5,-.5)]),f={}){super(),this.type="ExtrudeGeometry",this.parameters={shapes:p,options:f},p=Array.isArray(p)?p:[p];const C=this,D=[],U=[];for(let s=0,Z=p.length;s<Z;s++){const j=p[s];B(j)}this.setAttribute("position",new Ff(D,3)),this.setAttribute("uv",new Ff(U,2)),this.computeVertexNormals();function B(s){const Z=[],j=f.curveSegments!==void 0?f.curveSegments:12,Q=f.steps!==void 0?f.steps:1,oe=f.depth!==void 0?f.depth:1;let ve=f.bevelEnabled!==void 0?f.bevelEnabled:!0,Ee=f.bevelThickness!==void 0?f.bevelThickness:.2,We=f.bevelSize!==void 0?f.bevelSize:Ee-.1,Re=f.bevelOffset!==void 0?f.bevelOffset:0,He=f.bevelSegments!==void 0?f.bevelSegments:3;const Mt=f.extrudePath,Lt=f.UVGenerator!==void 0?f.UVGenerator:oA;let Ut,Wt=!1,lt,Ct,qt,Ai;Mt&&(Ut=Mt.getSpacedPoints(Q),Wt=!0,ve=!1,lt=Mt.computeFrenetFrames(Q,!1),Ct=new Pi,qt=new Pi,Ai=new Pi),ve||(He=0,Ee=0,We=0,Re=0);const Ni=s.extractPoints(j);let Qe=Ni.shape;const st=Ni.holes;if(!cg.isClockWise(Qe)){Qe=Qe.reverse();for(let dn=0,ln=st.length;dn<ln;dn++){const _n=st[dn];cg.isClockWise(_n)&&(st[dn]=_n.reverse())}}const en=cg.triangulateShape(Qe,st),ci=Qe;for(let dn=0,ln=st.length;dn<ln;dn++){const _n=st[dn];Qe=Qe.concat(_n)}function ae(dn,ln,_n){return ln||console.error("THREE.ExtrudeGeometry: vec does not exist"),dn.clone().addScaledVector(ln,_n)}const ye=Qe.length,Se=en.length;function Pe(dn,ln,_n){let li,Ie,ke;const ht=dn.x-ln.x,Ue=dn.y-ln.y,Ye=_n.x-dn.x,xt=_n.y-dn.y,zt=ht*ht+Ue*Ue,It=ht*xt-Ue*Ye;if(Math.abs(It)>Number.EPSILON){const si=Math.sqrt(zt),Qi=Math.sqrt(Ye*Ye+xt*xt),tn=ln.x-Ue/si,kn=ln.y+ht/si,Gn=_n.x-xt/Qi,Yn=_n.y+Ye/Qi,Jn=((Gn-tn)*xt-(Yn-kn)*Ye)/(ht*xt-Ue*Ye);li=tn+ht*Jn-dn.x,Ie=kn+Ue*Jn-dn.y;const Dn=li*li+Ie*Ie;if(Dn<=2)return new Rr(li,Ie);ke=Math.sqrt(Dn/2)}else{let si=!1;ht>Number.EPSILON?Ye>Number.EPSILON&&(si=!0):ht<-Number.EPSILON?Ye<-Number.EPSILON&&(si=!0):Math.sign(Ue)===Math.sign(xt)&&(si=!0),si?(li=-Ue,Ie=ht,ke=Math.sqrt(zt)):(li=ht,Ie=Ue,ke=Math.sqrt(zt/2))}return new Rr(li/ke,Ie/ke)}const je=[];for(let dn=0,ln=ci.length,_n=ln-1,li=dn+1;dn<ln;dn++,_n++,li++)_n===ln&&(_n=0),li===ln&&(li=0),je[dn]=Pe(ci[dn],ci[_n],ci[li]);const Et=[];let _t,ft=je.concat();for(let dn=0,ln=st.length;dn<ln;dn++){const _n=st[dn];_t=[];for(let li=0,Ie=_n.length,ke=Ie-1,ht=li+1;li<Ie;li++,ke++,ht++)ke===Ie&&(ke=0),ht===Ie&&(ht=0),_t[li]=Pe(_n[li],_n[ke],_n[ht]);Et.push(_t),ft=ft.concat(_t)}for(let dn=0;dn<He;dn++){const ln=dn/He,_n=Ee*Math.cos(ln*Math.PI/2),li=We*Math.sin(ln*Math.PI/2)+Re;for(let Ie=0,ke=ci.length;Ie<ke;Ie++){const ht=ae(ci[Ie],je[Ie],li);Ki(ht.x,ht.y,-_n)}for(let Ie=0,ke=st.length;Ie<ke;Ie++){const ht=st[Ie];_t=Et[Ie];for(let Ue=0,Ye=ht.length;Ue<Ye;Ue++){const xt=ae(ht[Ue],_t[Ue],li);Ki(xt.x,xt.y,-_n)}}}const ii=We+Re;for(let dn=0;dn<ye;dn++){const ln=ve?ae(Qe[dn],ft[dn],ii):Qe[dn];Wt?(qt.copy(lt.normals[0]).multiplyScalar(ln.x),Ct.copy(lt.binormals[0]).multiplyScalar(ln.y),Ai.copy(Ut[0]).add(qt).add(Ct),Ki(Ai.x,Ai.y,Ai.z)):Ki(ln.x,ln.y,0)}for(let dn=1;dn<=Q;dn++)for(let ln=0;ln<ye;ln++){const _n=ve?ae(Qe[ln],ft[ln],ii):Qe[ln];Wt?(qt.copy(lt.normals[dn]).multiplyScalar(_n.x),Ct.copy(lt.binormals[dn]).multiplyScalar(_n.y),Ai.copy(Ut[dn]).add(qt).add(Ct),Ki(Ai.x,Ai.y,Ai.z)):Ki(_n.x,_n.y,oe/Q*dn)}for(let dn=He-1;dn>=0;dn--){const ln=dn/He,_n=Ee*Math.cos(ln*Math.PI/2),li=We*Math.sin(ln*Math.PI/2)+Re;for(let Ie=0,ke=ci.length;Ie<ke;Ie++){const ht=ae(ci[Ie],je[Ie],li);Ki(ht.x,ht.y,oe+_n)}for(let Ie=0,ke=st.length;Ie<ke;Ie++){const ht=st[Ie];_t=Et[Ie];for(let Ue=0,Ye=ht.length;Ue<Ye;Ue++){const xt=ae(ht[Ue],_t[Ue],li);Wt?Ki(xt.x,xt.y+Ut[Q-1].y,Ut[Q-1].x+_n):Ki(xt.x,xt.y,oe+_n)}}}St(),Jt();function St(){const dn=D.length/3;if(ve){let ln=0,_n=ye*ln;for(let li=0;li<Se;li++){const Ie=en[li];fi(Ie[2]+_n,Ie[1]+_n,Ie[0]+_n)}ln=Q+He*2,_n=ye*ln;for(let li=0;li<Se;li++){const Ie=en[li];fi(Ie[0]+_n,Ie[1]+_n,Ie[2]+_n)}}else{for(let ln=0;ln<Se;ln++){const _n=en[ln];fi(_n[2],_n[1],_n[0])}for(let ln=0;ln<Se;ln++){const _n=en[ln];fi(_n[0]+ye*Q,_n[1]+ye*Q,_n[2]+ye*Q)}}C.addGroup(dn,D.length/3-dn,0)}function Jt(){const dn=D.length/3;let ln=0;sn(ci,ln),ln+=ci.length;for(let _n=0,li=st.length;_n<li;_n++){const Ie=st[_n];sn(Ie,ln),ln+=Ie.length}C.addGroup(dn,D.length/3-dn,1)}function sn(dn,ln){let _n=dn.length;for(;--_n>=0;){const li=_n;let Ie=_n-1;Ie<0&&(Ie=dn.length-1);for(let ke=0,ht=Q+He*2;ke<ht;ke++){const Ue=ye*ke,Ye=ye*(ke+1),xt=ln+li+Ue,zt=ln+Ie+Ue,It=ln+Ie+Ye,si=ln+li+Ye;pr(xt,zt,It,si)}}}function Ki(dn,ln,_n){Z.push(dn),Z.push(ln),Z.push(_n)}function fi(dn,ln,_n){Xn(dn),Xn(ln),Xn(_n);const li=D.length/3,Ie=Lt.generateTopUV(C,D,li-3,li-2,li-1);wr(Ie[0]),wr(Ie[1]),wr(Ie[2])}function pr(dn,ln,_n,li){Xn(dn),Xn(ln),Xn(li),Xn(ln),Xn(_n),Xn(li);const Ie=D.length/3,ke=Lt.generateSideWallUV(C,D,Ie-6,Ie-3,Ie-2,Ie-1);wr(ke[0]),wr(ke[1]),wr(ke[3]),wr(ke[1]),wr(ke[2]),wr(ke[3])}function Xn(dn){D.push(Z[dn*3+0]),D.push(Z[dn*3+1]),D.push(Z[dn*3+2])}function wr(dn){U.push(dn.x),U.push(dn.y)}}}copy(p){return super.copy(p),this.parameters=Object.assign({},p.parameters),this}toJSON(){const p=super.toJSON(),f=this.parameters.shapes,C=this.parameters.options;return aA(f,C,p)}static fromJSON(p,f){const C=[];for(let U=0,B=p.shapes.length;U<B;U++){const s=f[p.shapes[U]];C.push(s)}const D=p.options.extrudePath;return D!==void 0&&(p.options.extrudePath=new O0[D.type]().fromJSON(D)),new N0(C,p.options)}}const oA={generateTopUV:function(te,p,f,C,D){const U=p[f*3],B=p[f*3+1],s=p[C*3],Z=p[C*3+1],j=p[D*3],Q=p[D*3+1];return[new Rr(U,B),new Rr(s,Z),new Rr(j,Q)]},generateSideWallUV:function(te,p,f,C,D,U){const B=p[f*3],s=p[f*3+1],Z=p[f*3+2],j=p[C*3],Q=p[C*3+1],oe=p[C*3+2],ve=p[D*3],Ee=p[D*3+1],We=p[D*3+2],Re=p[U*3],He=p[U*3+1],Mt=p[U*3+2];return Math.abs(s-Q)<Math.abs(B-j)?[new Rr(B,1-Z),new Rr(j,1-oe),new Rr(ve,1-We),new Rr(Re,1-Mt)]:[new Rr(s,1-Z),new Rr(Q,1-oe),new Rr(Ee,1-We),new Rr(He,1-Mt)]}};function aA(te,p,f){if(f.shapes=[],Array.isArray(te))for(let C=0,D=te.length;C<D;C++){const U=te[C];f.shapes.push(U.uuid)}else f.shapes.push(te.uuid);return f.options=Object.assign({},p),p.extrudePath!==void 0&&(f.options.extrudePath=p.extrudePath.toJSON()),f}class lA extends E0{constructor(p){super(),this.isMeshPhongMaterial=!0,this.type="MeshPhongMaterial",this.color=new Md(16777215),this.specular=new Md(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Md(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=tE,this.normalScale=new Rr(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Lf,this.combine=cv,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(p)}copy(p){return super.copy(p),this.color.copy(p.color),this.specular.copy(p.specular),this.shininess=p.shininess,this.map=p.map,this.lightMap=p.lightMap,this.lightMapIntensity=p.lightMapIntensity,this.aoMap=p.aoMap,this.aoMapIntensity=p.aoMapIntensity,this.emissive.copy(p.emissive),this.emissiveMap=p.emissiveMap,this.emissiveIntensity=p.emissiveIntensity,this.bumpMap=p.bumpMap,this.bumpScale=p.bumpScale,this.normalMap=p.normalMap,this.normalMapType=p.normalMapType,this.normalScale.copy(p.normalScale),this.displacementMap=p.displacementMap,this.displacementScale=p.displacementScale,this.displacementBias=p.displacementBias,this.specularMap=p.specularMap,this.alphaMap=p.alphaMap,this.envMap=p.envMap,this.envMapRotation.copy(p.envMapRotation),this.combine=p.combine,this.reflectivity=p.reflectivity,this.refractionRatio=p.refractionRatio,this.wireframe=p.wireframe,this.wireframeLinewidth=p.wireframeLinewidth,this.wireframeLinecap=p.wireframeLinecap,this.wireframeLinejoin=p.wireframeLinejoin,this.flatShading=p.flatShading,this.fog=p.fog,this}}typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:nv}})),typeof window<"u"&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=nv);var s1={exports:{}},U0={exports:{}};/**
 * @license
 * Copyright 2010-2021 Three.js Authors
 * SPDX-License-Identifier: MIT
 */(function(te,p){(function(f,C){C(p)})(_f,function(f){const C="132",It="300 es";class si{addEventListener(i,c){this._listeners===void 0&&(this._listeners={});const g=this._listeners;g[i]===void 0&&(g[i]=[]),g[i].indexOf(c)===-1&&g[i].push(c)}hasEventListener(i,c){if(this._listeners===void 0)return!1;const g=this._listeners;return g[i]!==void 0&&g[i].indexOf(c)!==-1}removeEventListener(i,c){if(this._listeners===void 0)return;const g=this._listeners[i];if(g!==void 0){const _=g.indexOf(c);_!==-1&&g.splice(_,1)}}dispatchEvent(i){if(this._listeners===void 0)return;const c=this._listeners[i.type];if(c!==void 0){i.target=this;const g=c.slice(0);for(let _=0,w=g.length;_<w;_++)g[_].call(this,i);i.target=null}}}const Qi=[];for(let M=0;M<256;M++)Qi[M]=(M<16?"0":"")+M.toString(16);let tn=1234567;const kn=Math.PI/180,Gn=180/Math.PI;function Yn(){const M=4294967295*Math.random()|0,i=4294967295*Math.random()|0,c=4294967295*Math.random()|0,g=4294967295*Math.random()|0;return(Qi[255&M]+Qi[M>>8&255]+Qi[M>>16&255]+Qi[M>>24&255]+"-"+Qi[255&i]+Qi[i>>8&255]+"-"+Qi[i>>16&15|64]+Qi[i>>24&255]+"-"+Qi[63&c|128]+Qi[c>>8&255]+"-"+Qi[c>>16&255]+Qi[c>>24&255]+Qi[255&g]+Qi[g>>8&255]+Qi[g>>16&255]+Qi[g>>24&255]).toUpperCase()}function Jn(M,i,c){return Math.max(i,Math.min(c,M))}function Dn(M,i){return(M%i+i)%i}function ar(M,i,c){return(1-c)*M+c*i}function rs(M){return(M&M-1)==0&&M!==0}function ms(M){return Math.pow(2,Math.ceil(Math.log(M)/Math.LN2))}function Un(M){return Math.pow(2,Math.floor(Math.log(M)/Math.LN2))}var ho=Object.freeze({__proto__:null,DEG2RAD:kn,RAD2DEG:Gn,generateUUID:Yn,clamp:Jn,euclideanModulo:Dn,mapLinear:function(M,i,c,g,_){return g+(M-i)*(_-g)/(c-i)},inverseLerp:function(M,i,c){return M!==i?(c-M)/(i-M):0},lerp:ar,damp:function(M,i,c,g){return ar(M,i,1-Math.exp(-c*g))},pingpong:function(M,i=1){return i-Math.abs(Dn(M,2*i)-i)},smoothstep:function(M,i,c){return M<=i?0:M>=c?1:(M=(M-i)/(c-i))*M*(3-2*M)},smootherstep:function(M,i,c){return M<=i?0:M>=c?1:(M=(M-i)/(c-i))*M*M*(M*(6*M-15)+10)},randInt:function(M,i){return M+Math.floor(Math.random()*(i-M+1))},randFloat:function(M,i){return M+Math.random()*(i-M)},randFloatSpread:function(M){return M*(.5-Math.random())},seededRandom:function(M){return M!==void 0&&(tn=M%2147483647),tn=16807*tn%2147483647,(tn-1)/2147483646},degToRad:function(M){return M*kn},radToDeg:function(M){return M*Gn},isPowerOfTwo:rs,ceilPowerOfTwo:ms,floorPowerOfTwo:Un,setQuaternionFromProperEuler:function(M,i,c,g,_){const w=Math.cos,A=Math.sin,R=w(c/2),z=A(c/2),F=w((i+g)/2),W=A((i+g)/2),q=w((i-g)/2),J=A((i-g)/2),K=w((g-i)/2),re=A((g-i)/2);switch(_){case"XYX":M.set(R*W,z*q,z*J,R*F);break;case"YZY":M.set(z*J,R*W,z*q,R*F);break;case"ZXZ":M.set(z*q,z*J,R*W,R*F);break;case"XZX":M.set(R*W,z*re,z*K,R*F);break;case"YXY":M.set(z*K,R*W,z*re,R*F);break;case"ZYZ":M.set(z*re,z*K,R*W,R*F);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+_)}}});class Ri{constructor(i=0,c=0){this.x=i,this.y=c}get width(){return this.x}set width(i){this.x=i}get height(){return this.y}set height(i){this.y=i}set(i,c){return this.x=i,this.y=c,this}setScalar(i){return this.x=i,this.y=i,this}setX(i){return this.x=i,this}setY(i){return this.y=i,this}setComponent(i,c){switch(i){case 0:this.x=c;break;case 1:this.y=c;break;default:throw new Error("index is out of range: "+i)}return this}getComponent(i){switch(i){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+i)}}clone(){return new this.constructor(this.x,this.y)}copy(i){return this.x=i.x,this.y=i.y,this}add(i,c){return c!==void 0?(console.warn("THREE.Vector2: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(i,c)):(this.x+=i.x,this.y+=i.y,this)}addScalar(i){return this.x+=i,this.y+=i,this}addVectors(i,c){return this.x=i.x+c.x,this.y=i.y+c.y,this}addScaledVector(i,c){return this.x+=i.x*c,this.y+=i.y*c,this}sub(i,c){return c!==void 0?(console.warn("THREE.Vector2: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(i,c)):(this.x-=i.x,this.y-=i.y,this)}subScalar(i){return this.x-=i,this.y-=i,this}subVectors(i,c){return this.x=i.x-c.x,this.y=i.y-c.y,this}multiply(i){return this.x*=i.x,this.y*=i.y,this}multiplyScalar(i){return this.x*=i,this.y*=i,this}divide(i){return this.x/=i.x,this.y/=i.y,this}divideScalar(i){return this.multiplyScalar(1/i)}applyMatrix3(i){const c=this.x,g=this.y,_=i.elements;return this.x=_[0]*c+_[3]*g+_[6],this.y=_[1]*c+_[4]*g+_[7],this}min(i){return this.x=Math.min(this.x,i.x),this.y=Math.min(this.y,i.y),this}max(i){return this.x=Math.max(this.x,i.x),this.y=Math.max(this.y,i.y),this}clamp(i,c){return this.x=Math.max(i.x,Math.min(c.x,this.x)),this.y=Math.max(i.y,Math.min(c.y,this.y)),this}clampScalar(i,c){return this.x=Math.max(i,Math.min(c,this.x)),this.y=Math.max(i,Math.min(c,this.y)),this}clampLength(i,c){const g=this.length();return this.divideScalar(g||1).multiplyScalar(Math.max(i,Math.min(c,g)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(i){return this.x*i.x+this.y*i.y}cross(i){return this.x*i.y-this.y*i.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}distanceTo(i){return Math.sqrt(this.distanceToSquared(i))}distanceToSquared(i){const c=this.x-i.x,g=this.y-i.y;return c*c+g*g}manhattanDistanceTo(i){return Math.abs(this.x-i.x)+Math.abs(this.y-i.y)}setLength(i){return this.normalize().multiplyScalar(i)}lerp(i,c){return this.x+=(i.x-this.x)*c,this.y+=(i.y-this.y)*c,this}lerpVectors(i,c,g){return this.x=i.x+(c.x-i.x)*g,this.y=i.y+(c.y-i.y)*g,this}equals(i){return i.x===this.x&&i.y===this.y}fromArray(i,c=0){return this.x=i[c],this.y=i[c+1],this}toArray(i=[],c=0){return i[c]=this.x,i[c+1]=this.y,i}fromBufferAttribute(i,c,g){return g!==void 0&&console.warn("THREE.Vector2: offset has been removed from .fromBufferAttribute()."),this.x=i.getX(c),this.y=i.getY(c),this}rotateAround(i,c){const g=Math.cos(c),_=Math.sin(c),w=this.x-i.x,A=this.y-i.y;return this.x=w*g-A*_+i.x,this.y=w*_+A*g+i.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}}Ri.prototype.isVector2=!0;class jr{constructor(){this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}set(i,c,g,_,w,A,R,z,F){const W=this.elements;return W[0]=i,W[1]=_,W[2]=R,W[3]=c,W[4]=w,W[5]=z,W[6]=g,W[7]=A,W[8]=F,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(i){const c=this.elements,g=i.elements;return c[0]=g[0],c[1]=g[1],c[2]=g[2],c[3]=g[3],c[4]=g[4],c[5]=g[5],c[6]=g[6],c[7]=g[7],c[8]=g[8],this}extractBasis(i,c,g){return i.setFromMatrix3Column(this,0),c.setFromMatrix3Column(this,1),g.setFromMatrix3Column(this,2),this}setFromMatrix4(i){const c=i.elements;return this.set(c[0],c[4],c[8],c[1],c[5],c[9],c[2],c[6],c[10]),this}multiply(i){return this.multiplyMatrices(this,i)}premultiply(i){return this.multiplyMatrices(i,this)}multiplyMatrices(i,c){const g=i.elements,_=c.elements,w=this.elements,A=g[0],R=g[3],z=g[6],F=g[1],W=g[4],q=g[7],J=g[2],K=g[5],re=g[8],ce=_[0],Me=_[3],de=_[6],Xe=_[1],nt=_[4],Je=_[7],gt=_[2],Tt=_[5],Zt=_[8];return w[0]=A*ce+R*Xe+z*gt,w[3]=A*Me+R*nt+z*Tt,w[6]=A*de+R*Je+z*Zt,w[1]=F*ce+W*Xe+q*gt,w[4]=F*Me+W*nt+q*Tt,w[7]=F*de+W*Je+q*Zt,w[2]=J*ce+K*Xe+re*gt,w[5]=J*Me+K*nt+re*Tt,w[8]=J*de+K*Je+re*Zt,this}multiplyScalar(i){const c=this.elements;return c[0]*=i,c[3]*=i,c[6]*=i,c[1]*=i,c[4]*=i,c[7]*=i,c[2]*=i,c[5]*=i,c[8]*=i,this}determinant(){const i=this.elements,c=i[0],g=i[1],_=i[2],w=i[3],A=i[4],R=i[5],z=i[6],F=i[7],W=i[8];return c*A*W-c*R*F-g*w*W+g*R*z+_*w*F-_*A*z}invert(){const i=this.elements,c=i[0],g=i[1],_=i[2],w=i[3],A=i[4],R=i[5],z=i[6],F=i[7],W=i[8],q=W*A-R*F,J=R*z-W*w,K=F*w-A*z,re=c*q+g*J+_*K;if(re===0)return this.set(0,0,0,0,0,0,0,0,0);const ce=1/re;return i[0]=q*ce,i[1]=(_*F-W*g)*ce,i[2]=(R*g-_*A)*ce,i[3]=J*ce,i[4]=(W*c-_*z)*ce,i[5]=(_*w-R*c)*ce,i[6]=K*ce,i[7]=(g*z-F*c)*ce,i[8]=(A*c-g*w)*ce,this}transpose(){let i;const c=this.elements;return i=c[1],c[1]=c[3],c[3]=i,i=c[2],c[2]=c[6],c[6]=i,i=c[5],c[5]=c[7],c[7]=i,this}getNormalMatrix(i){return this.setFromMatrix4(i).invert().transpose()}transposeIntoArray(i){const c=this.elements;return i[0]=c[0],i[1]=c[3],i[2]=c[6],i[3]=c[1],i[4]=c[4],i[5]=c[7],i[6]=c[2],i[7]=c[5],i[8]=c[8],this}setUvTransform(i,c,g,_,w,A,R){const z=Math.cos(w),F=Math.sin(w);return this.set(g*z,g*F,-g*(z*A+F*R)+A+i,-_*F,_*z,-_*(-F*A+z*R)+R+c,0,0,1),this}scale(i,c){const g=this.elements;return g[0]*=i,g[3]*=i,g[6]*=i,g[1]*=c,g[4]*=c,g[7]*=c,this}rotate(i){const c=Math.cos(i),g=Math.sin(i),_=this.elements,w=_[0],A=_[3],R=_[6],z=_[1],F=_[4],W=_[7];return _[0]=c*w+g*z,_[3]=c*A+g*F,_[6]=c*R+g*W,_[1]=-g*w+c*z,_[4]=-g*A+c*F,_[7]=-g*R+c*W,this}translate(i,c){const g=this.elements;return g[0]+=i*g[2],g[3]+=i*g[5],g[6]+=i*g[8],g[1]+=c*g[2],g[4]+=c*g[5],g[7]+=c*g[8],this}equals(i){const c=this.elements,g=i.elements;for(let _=0;_<9;_++)if(c[_]!==g[_])return!1;return!0}fromArray(i,c=0){for(let g=0;g<9;g++)this.elements[g]=i[g+c];return this}toArray(i=[],c=0){const g=this.elements;return i[c]=g[0],i[c+1]=g[1],i[c+2]=g[2],i[c+3]=g[3],i[c+4]=g[4],i[c+5]=g[5],i[c+6]=g[6],i[c+7]=g[7],i[c+8]=g[8],i}clone(){return new this.constructor().fromArray(this.elements)}}let Ms;jr.prototype.isMatrix3=!0;class Fs{static getDataURL(i){if(/^data:/i.test(i.src)||typeof HTMLCanvasElement>"u")return i.src;let c;if(i instanceof HTMLCanvasElement)c=i;else{Ms===void 0&&(Ms=document.createElementNS("http://www.w3.org/1999/xhtml","canvas")),Ms.width=i.width,Ms.height=i.height;const g=Ms.getContext("2d");i instanceof ImageData?g.putImageData(i,0,0):g.drawImage(i,0,0,i.width,i.height),c=Ms}return c.width>2048||c.height>2048?(console.warn("THREE.ImageUtils.getDataURL: Image converted to jpg for performance reasons",i),c.toDataURL("image/jpeg",.6)):c.toDataURL("image/png")}}let Po=0;class ds extends si{constructor(i=ds.DEFAULT_IMAGE,c=ds.DEFAULT_MAPPING,g=1001,_=1001,w=1006,A=1008,R=1023,z=1009,F=1,W=3e3){super(),Object.defineProperty(this,"id",{value:Po++}),this.uuid=Yn(),this.name="",this.image=i,this.mipmaps=[],this.mapping=c,this.wrapS=g,this.wrapT=_,this.magFilter=w,this.minFilter=A,this.anisotropy=F,this.format=R,this.internalFormat=null,this.type=z,this.offset=new Ri(0,0),this.repeat=new Ri(1,1),this.center=new Ri(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new jr,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.encoding=W,this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return new this.constructor().copy(this)}copy(i){return this.name=i.name,this.image=i.image,this.mipmaps=i.mipmaps.slice(0),this.mapping=i.mapping,this.wrapS=i.wrapS,this.wrapT=i.wrapT,this.magFilter=i.magFilter,this.minFilter=i.minFilter,this.anisotropy=i.anisotropy,this.format=i.format,this.internalFormat=i.internalFormat,this.type=i.type,this.offset.copy(i.offset),this.repeat.copy(i.repeat),this.center.copy(i.center),this.rotation=i.rotation,this.matrixAutoUpdate=i.matrixAutoUpdate,this.matrix.copy(i.matrix),this.generateMipmaps=i.generateMipmaps,this.premultiplyAlpha=i.premultiplyAlpha,this.flipY=i.flipY,this.unpackAlignment=i.unpackAlignment,this.encoding=i.encoding,this}toJSON(i){const c=i===void 0||typeof i=="string";if(!c&&i.textures[this.uuid]!==void 0)return i.textures[this.uuid];const g={metadata:{version:4.5,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,type:this.type,encoding:this.encoding,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};if(this.image!==void 0){const _=this.image;if(_.uuid===void 0&&(_.uuid=Yn()),!c&&i.images[_.uuid]===void 0){let w;if(Array.isArray(_)){w=[];for(let A=0,R=_.length;A<R;A++)_[A].isDataTexture?w.push(ys(_[A].image)):w.push(ys(_[A]))}else w=ys(_);i.images[_.uuid]={uuid:_.uuid,url:w}}g.image=_.uuid}return c||(i.textures[this.uuid]=g),g}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(i){if(this.mapping!==300)return i;if(i.applyMatrix3(this.matrix),i.x<0||i.x>1)switch(this.wrapS){case 1e3:i.x=i.x-Math.floor(i.x);break;case 1001:i.x=i.x<0?0:1;break;case 1002:Math.abs(Math.floor(i.x)%2)===1?i.x=Math.ceil(i.x)-i.x:i.x=i.x-Math.floor(i.x)}if(i.y<0||i.y>1)switch(this.wrapT){case 1e3:i.y=i.y-Math.floor(i.y);break;case 1001:i.y=i.y<0?0:1;break;case 1002:Math.abs(Math.floor(i.y)%2)===1?i.y=Math.ceil(i.y)-i.y:i.y=i.y-Math.floor(i.y)}return this.flipY&&(i.y=1-i.y),i}set needsUpdate(i){i===!0&&this.version++}}function ys(M){return typeof HTMLImageElement<"u"&&M instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&M instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&M instanceof ImageBitmap?Fs.getDataURL(M):M.data?{data:Array.prototype.slice.call(M.data),width:M.width,height:M.height,type:M.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}ds.DEFAULT_IMAGE=void 0,ds.DEFAULT_MAPPING=300,ds.prototype.isTexture=!0;class Mr{constructor(i=0,c=0,g=0,_=1){this.x=i,this.y=c,this.z=g,this.w=_}get width(){return this.z}set width(i){this.z=i}get height(){return this.w}set height(i){this.w=i}set(i,c,g,_){return this.x=i,this.y=c,this.z=g,this.w=_,this}setScalar(i){return this.x=i,this.y=i,this.z=i,this.w=i,this}setX(i){return this.x=i,this}setY(i){return this.y=i,this}setZ(i){return this.z=i,this}setW(i){return this.w=i,this}setComponent(i,c){switch(i){case 0:this.x=c;break;case 1:this.y=c;break;case 2:this.z=c;break;case 3:this.w=c;break;default:throw new Error("index is out of range: "+i)}return this}getComponent(i){switch(i){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+i)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(i){return this.x=i.x,this.y=i.y,this.z=i.z,this.w=i.w!==void 0?i.w:1,this}add(i,c){return c!==void 0?(console.warn("THREE.Vector4: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(i,c)):(this.x+=i.x,this.y+=i.y,this.z+=i.z,this.w+=i.w,this)}addScalar(i){return this.x+=i,this.y+=i,this.z+=i,this.w+=i,this}addVectors(i,c){return this.x=i.x+c.x,this.y=i.y+c.y,this.z=i.z+c.z,this.w=i.w+c.w,this}addScaledVector(i,c){return this.x+=i.x*c,this.y+=i.y*c,this.z+=i.z*c,this.w+=i.w*c,this}sub(i,c){return c!==void 0?(console.warn("THREE.Vector4: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(i,c)):(this.x-=i.x,this.y-=i.y,this.z-=i.z,this.w-=i.w,this)}subScalar(i){return this.x-=i,this.y-=i,this.z-=i,this.w-=i,this}subVectors(i,c){return this.x=i.x-c.x,this.y=i.y-c.y,this.z=i.z-c.z,this.w=i.w-c.w,this}multiply(i){return this.x*=i.x,this.y*=i.y,this.z*=i.z,this.w*=i.w,this}multiplyScalar(i){return this.x*=i,this.y*=i,this.z*=i,this.w*=i,this}applyMatrix4(i){const c=this.x,g=this.y,_=this.z,w=this.w,A=i.elements;return this.x=A[0]*c+A[4]*g+A[8]*_+A[12]*w,this.y=A[1]*c+A[5]*g+A[9]*_+A[13]*w,this.z=A[2]*c+A[6]*g+A[10]*_+A[14]*w,this.w=A[3]*c+A[7]*g+A[11]*_+A[15]*w,this}divideScalar(i){return this.multiplyScalar(1/i)}setAxisAngleFromQuaternion(i){this.w=2*Math.acos(i.w);const c=Math.sqrt(1-i.w*i.w);return c<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=i.x/c,this.y=i.y/c,this.z=i.z/c),this}setAxisAngleFromRotationMatrix(i){let c,g,_,w;const z=i.elements,F=z[0],W=z[4],q=z[8],J=z[1],K=z[5],re=z[9],ce=z[2],Me=z[6],de=z[10];if(Math.abs(W-J)<.01&&Math.abs(q-ce)<.01&&Math.abs(re-Me)<.01){if(Math.abs(W+J)<.1&&Math.abs(q+ce)<.1&&Math.abs(re+Me)<.1&&Math.abs(F+K+de-3)<.1)return this.set(1,0,0,0),this;c=Math.PI;const nt=(F+1)/2,Je=(K+1)/2,gt=(de+1)/2,Tt=(W+J)/4,Zt=(q+ce)/4,ei=(re+Me)/4;return nt>Je&&nt>gt?nt<.01?(g=0,_=.707106781,w=.707106781):(g=Math.sqrt(nt),_=Tt/g,w=Zt/g):Je>gt?Je<.01?(g=.707106781,_=0,w=.707106781):(_=Math.sqrt(Je),g=Tt/_,w=ei/_):gt<.01?(g=.707106781,_=.707106781,w=0):(w=Math.sqrt(gt),g=Zt/w,_=ei/w),this.set(g,_,w,c),this}let Xe=Math.sqrt((Me-re)*(Me-re)+(q-ce)*(q-ce)+(J-W)*(J-W));return Math.abs(Xe)<.001&&(Xe=1),this.x=(Me-re)/Xe,this.y=(q-ce)/Xe,this.z=(J-W)/Xe,this.w=Math.acos((F+K+de-1)/2),this}min(i){return this.x=Math.min(this.x,i.x),this.y=Math.min(this.y,i.y),this.z=Math.min(this.z,i.z),this.w=Math.min(this.w,i.w),this}max(i){return this.x=Math.max(this.x,i.x),this.y=Math.max(this.y,i.y),this.z=Math.max(this.z,i.z),this.w=Math.max(this.w,i.w),this}clamp(i,c){return this.x=Math.max(i.x,Math.min(c.x,this.x)),this.y=Math.max(i.y,Math.min(c.y,this.y)),this.z=Math.max(i.z,Math.min(c.z,this.z)),this.w=Math.max(i.w,Math.min(c.w,this.w)),this}clampScalar(i,c){return this.x=Math.max(i,Math.min(c,this.x)),this.y=Math.max(i,Math.min(c,this.y)),this.z=Math.max(i,Math.min(c,this.z)),this.w=Math.max(i,Math.min(c,this.w)),this}clampLength(i,c){const g=this.length();return this.divideScalar(g||1).multiplyScalar(Math.max(i,Math.min(c,g)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(i){return this.x*i.x+this.y*i.y+this.z*i.z+this.w*i.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(i){return this.normalize().multiplyScalar(i)}lerp(i,c){return this.x+=(i.x-this.x)*c,this.y+=(i.y-this.y)*c,this.z+=(i.z-this.z)*c,this.w+=(i.w-this.w)*c,this}lerpVectors(i,c,g){return this.x=i.x+(c.x-i.x)*g,this.y=i.y+(c.y-i.y)*g,this.z=i.z+(c.z-i.z)*g,this.w=i.w+(c.w-i.w)*g,this}equals(i){return i.x===this.x&&i.y===this.y&&i.z===this.z&&i.w===this.w}fromArray(i,c=0){return this.x=i[c],this.y=i[c+1],this.z=i[c+2],this.w=i[c+3],this}toArray(i=[],c=0){return i[c]=this.x,i[c+1]=this.y,i[c+2]=this.z,i[c+3]=this.w,i}fromBufferAttribute(i,c,g){return g!==void 0&&console.warn("THREE.Vector4: offset has been removed from .fromBufferAttribute()."),this.x=i.getX(c),this.y=i.getY(c),this.z=i.getZ(c),this.w=i.getW(c),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}}Mr.prototype.isVector4=!0;class Bs extends si{constructor(i,c,g={}){super(),this.width=i,this.height=c,this.depth=1,this.scissor=new Mr(0,0,i,c),this.scissorTest=!1,this.viewport=new Mr(0,0,i,c),this.texture=new ds(void 0,g.mapping,g.wrapS,g.wrapT,g.magFilter,g.minFilter,g.format,g.type,g.anisotropy,g.encoding),this.texture.isRenderTargetTexture=!0,this.texture.image={width:i,height:c,depth:1},this.texture.generateMipmaps=g.generateMipmaps!==void 0&&g.generateMipmaps,this.texture.internalFormat=g.internalFormat!==void 0?g.internalFormat:null,this.texture.minFilter=g.minFilter!==void 0?g.minFilter:1006,this.depthBuffer=g.depthBuffer===void 0||g.depthBuffer,this.stencilBuffer=g.stencilBuffer!==void 0&&g.stencilBuffer,this.depthTexture=g.depthTexture!==void 0?g.depthTexture:null}setTexture(i){i.image={width:this.width,height:this.height,depth:this.depth},this.texture=i}setSize(i,c,g=1){this.width===i&&this.height===c&&this.depth===g||(this.width=i,this.height=c,this.depth=g,this.texture.image.width=i,this.texture.image.height=c,this.texture.image.depth=g,this.dispose()),this.viewport.set(0,0,i,c),this.scissor.set(0,0,i,c)}clone(){return new this.constructor().copy(this)}copy(i){return this.width=i.width,this.height=i.height,this.depth=i.depth,this.viewport.copy(i.viewport),this.texture=i.texture.clone(),this.texture.image={...this.texture.image},this.depthBuffer=i.depthBuffer,this.stencilBuffer=i.stencilBuffer,this.depthTexture=i.depthTexture,this}dispose(){this.dispatchEvent({type:"dispose"})}}Bs.prototype.isWebGLRenderTarget=!0;class js extends Bs{constructor(i,c,g){super(i,c);const _=this.texture;this.texture=[];for(let w=0;w<g;w++)this.texture[w]=_.clone()}setSize(i,c,g=1){if(this.width!==i||this.height!==c||this.depth!==g){this.width=i,this.height=c,this.depth=g;for(let _=0,w=this.texture.length;_<w;_++)this.texture[_].image.width=i,this.texture[_].image.height=c,this.texture[_].image.depth=g;this.dispose()}return this.viewport.set(0,0,i,c),this.scissor.set(0,0,i,c),this}copy(i){this.dispose(),this.width=i.width,this.height=i.height,this.depth=i.depth,this.viewport.set(0,0,this.width,this.height),this.scissor.set(0,0,this.width,this.height),this.depthBuffer=i.depthBuffer,this.stencilBuffer=i.stencilBuffer,this.depthTexture=i.depthTexture,this.texture.length=0;for(let c=0,g=i.texture.length;c<g;c++)this.texture[c]=i.texture[c].clone();return this}}js.prototype.isWebGLMultipleRenderTargets=!0;class Wo extends Bs{constructor(i,c,g){super(i,c,g),this.samples=4}copy(i){return super.copy.call(this,i),this.samples=i.samples,this}}Wo.prototype.isWebGLMultisampleRenderTarget=!0;class Rs{constructor(i=0,c=0,g=0,_=1){this._x=i,this._y=c,this._z=g,this._w=_}static slerp(i,c,g,_){return console.warn("THREE.Quaternion: Static .slerp() has been deprecated. Use qm.slerpQuaternions( qa, qb, t ) instead."),g.slerpQuaternions(i,c,_)}static slerpFlat(i,c,g,_,w,A,R){let z=g[_+0],F=g[_+1],W=g[_+2],q=g[_+3];const J=w[A+0],K=w[A+1],re=w[A+2],ce=w[A+3];if(R===0)return i[c+0]=z,i[c+1]=F,i[c+2]=W,void(i[c+3]=q);if(R===1)return i[c+0]=J,i[c+1]=K,i[c+2]=re,void(i[c+3]=ce);if(q!==ce||z!==J||F!==K||W!==re){let Me=1-R;const de=z*J+F*K+W*re+q*ce,Xe=de>=0?1:-1,nt=1-de*de;if(nt>Number.EPSILON){const gt=Math.sqrt(nt),Tt=Math.atan2(gt,de*Xe);Me=Math.sin(Me*Tt)/gt,R=Math.sin(R*Tt)/gt}const Je=R*Xe;if(z=z*Me+J*Je,F=F*Me+K*Je,W=W*Me+re*Je,q=q*Me+ce*Je,Me===1-R){const gt=1/Math.sqrt(z*z+F*F+W*W+q*q);z*=gt,F*=gt,W*=gt,q*=gt}}i[c]=z,i[c+1]=F,i[c+2]=W,i[c+3]=q}static multiplyQuaternionsFlat(i,c,g,_,w,A){const R=g[_],z=g[_+1],F=g[_+2],W=g[_+3],q=w[A],J=w[A+1],K=w[A+2],re=w[A+3];return i[c]=R*re+W*q+z*K-F*J,i[c+1]=z*re+W*J+F*q-R*K,i[c+2]=F*re+W*K+R*J-z*q,i[c+3]=W*re-R*q-z*J-F*K,i}get x(){return this._x}set x(i){this._x=i,this._onChangeCallback()}get y(){return this._y}set y(i){this._y=i,this._onChangeCallback()}get z(){return this._z}set z(i){this._z=i,this._onChangeCallback()}get w(){return this._w}set w(i){this._w=i,this._onChangeCallback()}set(i,c,g,_){return this._x=i,this._y=c,this._z=g,this._w=_,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(i){return this._x=i.x,this._y=i.y,this._z=i.z,this._w=i.w,this._onChangeCallback(),this}setFromEuler(i,c){if(!i||!i.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");const g=i._x,_=i._y,w=i._z,A=i._order,R=Math.cos,z=Math.sin,F=R(g/2),W=R(_/2),q=R(w/2),J=z(g/2),K=z(_/2),re=z(w/2);switch(A){case"XYZ":this._x=J*W*q+F*K*re,this._y=F*K*q-J*W*re,this._z=F*W*re+J*K*q,this._w=F*W*q-J*K*re;break;case"YXZ":this._x=J*W*q+F*K*re,this._y=F*K*q-J*W*re,this._z=F*W*re-J*K*q,this._w=F*W*q+J*K*re;break;case"ZXY":this._x=J*W*q-F*K*re,this._y=F*K*q+J*W*re,this._z=F*W*re+J*K*q,this._w=F*W*q-J*K*re;break;case"ZYX":this._x=J*W*q-F*K*re,this._y=F*K*q+J*W*re,this._z=F*W*re-J*K*q,this._w=F*W*q+J*K*re;break;case"YZX":this._x=J*W*q+F*K*re,this._y=F*K*q+J*W*re,this._z=F*W*re-J*K*q,this._w=F*W*q-J*K*re;break;case"XZY":this._x=J*W*q-F*K*re,this._y=F*K*q-J*W*re,this._z=F*W*re+J*K*q,this._w=F*W*q+J*K*re;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+A)}return c!==!1&&this._onChangeCallback(),this}setFromAxisAngle(i,c){const g=c/2,_=Math.sin(g);return this._x=i.x*_,this._y=i.y*_,this._z=i.z*_,this._w=Math.cos(g),this._onChangeCallback(),this}setFromRotationMatrix(i){const c=i.elements,g=c[0],_=c[4],w=c[8],A=c[1],R=c[5],z=c[9],F=c[2],W=c[6],q=c[10],J=g+R+q;if(J>0){const K=.5/Math.sqrt(J+1);this._w=.25/K,this._x=(W-z)*K,this._y=(w-F)*K,this._z=(A-_)*K}else if(g>R&&g>q){const K=2*Math.sqrt(1+g-R-q);this._w=(W-z)/K,this._x=.25*K,this._y=(_+A)/K,this._z=(w+F)/K}else if(R>q){const K=2*Math.sqrt(1+R-g-q);this._w=(w-F)/K,this._x=(_+A)/K,this._y=.25*K,this._z=(z+W)/K}else{const K=2*Math.sqrt(1+q-g-R);this._w=(A-_)/K,this._x=(w+F)/K,this._y=(z+W)/K,this._z=.25*K}return this._onChangeCallback(),this}setFromUnitVectors(i,c){let g=i.dot(c)+1;return g<Number.EPSILON?(g=0,Math.abs(i.x)>Math.abs(i.z)?(this._x=-i.y,this._y=i.x,this._z=0,this._w=g):(this._x=0,this._y=-i.z,this._z=i.y,this._w=g)):(this._x=i.y*c.z-i.z*c.y,this._y=i.z*c.x-i.x*c.z,this._z=i.x*c.y-i.y*c.x,this._w=g),this.normalize()}angleTo(i){return 2*Math.acos(Math.abs(Jn(this.dot(i),-1,1)))}rotateTowards(i,c){const g=this.angleTo(i);if(g===0)return this;const _=Math.min(1,c/g);return this.slerp(i,_),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(i){return this._x*i._x+this._y*i._y+this._z*i._z+this._w*i._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let i=this.length();return i===0?(this._x=0,this._y=0,this._z=0,this._w=1):(i=1/i,this._x=this._x*i,this._y=this._y*i,this._z=this._z*i,this._w=this._w*i),this._onChangeCallback(),this}multiply(i,c){return c!==void 0?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(i,c)):this.multiplyQuaternions(this,i)}premultiply(i){return this.multiplyQuaternions(i,this)}multiplyQuaternions(i,c){const g=i._x,_=i._y,w=i._z,A=i._w,R=c._x,z=c._y,F=c._z,W=c._w;return this._x=g*W+A*R+_*F-w*z,this._y=_*W+A*z+w*R-g*F,this._z=w*W+A*F+g*z-_*R,this._w=A*W-g*R-_*z-w*F,this._onChangeCallback(),this}slerp(i,c){if(c===0)return this;if(c===1)return this.copy(i);const g=this._x,_=this._y,w=this._z,A=this._w;let R=A*i._w+g*i._x+_*i._y+w*i._z;if(R<0?(this._w=-i._w,this._x=-i._x,this._y=-i._y,this._z=-i._z,R=-R):this.copy(i),R>=1)return this._w=A,this._x=g,this._y=_,this._z=w,this;const z=1-R*R;if(z<=Number.EPSILON){const K=1-c;return this._w=K*A+c*this._w,this._x=K*g+c*this._x,this._y=K*_+c*this._y,this._z=K*w+c*this._z,this.normalize(),this._onChangeCallback(),this}const F=Math.sqrt(z),W=Math.atan2(F,R),q=Math.sin((1-c)*W)/F,J=Math.sin(c*W)/F;return this._w=A*q+this._w*J,this._x=g*q+this._x*J,this._y=_*q+this._y*J,this._z=w*q+this._z*J,this._onChangeCallback(),this}slerpQuaternions(i,c,g){this.copy(i).slerp(c,g)}equals(i){return i._x===this._x&&i._y===this._y&&i._z===this._z&&i._w===this._w}fromArray(i,c=0){return this._x=i[c],this._y=i[c+1],this._z=i[c+2],this._w=i[c+3],this._onChangeCallback(),this}toArray(i=[],c=0){return i[c]=this._x,i[c+1]=this._y,i[c+2]=this._z,i[c+3]=this._w,i}fromBufferAttribute(i,c){return this._x=i.getX(c),this._y=i.getY(c),this._z=i.getZ(c),this._w=i.getW(c),this}_onChange(i){return this._onChangeCallback=i,this}_onChangeCallback(){}}Rs.prototype.isQuaternion=!0;class et{constructor(i=0,c=0,g=0){this.x=i,this.y=c,this.z=g}set(i,c,g){return g===void 0&&(g=this.z),this.x=i,this.y=c,this.z=g,this}setScalar(i){return this.x=i,this.y=i,this.z=i,this}setX(i){return this.x=i,this}setY(i){return this.y=i,this}setZ(i){return this.z=i,this}setComponent(i,c){switch(i){case 0:this.x=c;break;case 1:this.y=c;break;case 2:this.z=c;break;default:throw new Error("index is out of range: "+i)}return this}getComponent(i){switch(i){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+i)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(i){return this.x=i.x,this.y=i.y,this.z=i.z,this}add(i,c){return c!==void 0?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(i,c)):(this.x+=i.x,this.y+=i.y,this.z+=i.z,this)}addScalar(i){return this.x+=i,this.y+=i,this.z+=i,this}addVectors(i,c){return this.x=i.x+c.x,this.y=i.y+c.y,this.z=i.z+c.z,this}addScaledVector(i,c){return this.x+=i.x*c,this.y+=i.y*c,this.z+=i.z*c,this}sub(i,c){return c!==void 0?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(i,c)):(this.x-=i.x,this.y-=i.y,this.z-=i.z,this)}subScalar(i){return this.x-=i,this.y-=i,this.z-=i,this}subVectors(i,c){return this.x=i.x-c.x,this.y=i.y-c.y,this.z=i.z-c.z,this}multiply(i,c){return c!==void 0?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(i,c)):(this.x*=i.x,this.y*=i.y,this.z*=i.z,this)}multiplyScalar(i){return this.x*=i,this.y*=i,this.z*=i,this}multiplyVectors(i,c){return this.x=i.x*c.x,this.y=i.y*c.y,this.z=i.z*c.z,this}applyEuler(i){return i&&i.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(As.setFromEuler(i))}applyAxisAngle(i,c){return this.applyQuaternion(As.setFromAxisAngle(i,c))}applyMatrix3(i){const c=this.x,g=this.y,_=this.z,w=i.elements;return this.x=w[0]*c+w[3]*g+w[6]*_,this.y=w[1]*c+w[4]*g+w[7]*_,this.z=w[2]*c+w[5]*g+w[8]*_,this}applyNormalMatrix(i){return this.applyMatrix3(i).normalize()}applyMatrix4(i){const c=this.x,g=this.y,_=this.z,w=i.elements,A=1/(w[3]*c+w[7]*g+w[11]*_+w[15]);return this.x=(w[0]*c+w[4]*g+w[8]*_+w[12])*A,this.y=(w[1]*c+w[5]*g+w[9]*_+w[13])*A,this.z=(w[2]*c+w[6]*g+w[10]*_+w[14])*A,this}applyQuaternion(i){const c=this.x,g=this.y,_=this.z,w=i.x,A=i.y,R=i.z,z=i.w,F=z*c+A*_-R*g,W=z*g+R*c-w*_,q=z*_+w*g-A*c,J=-w*c-A*g-R*_;return this.x=F*z+J*-w+W*-R-q*-A,this.y=W*z+J*-A+q*-w-F*-R,this.z=q*z+J*-R+F*-A-W*-w,this}project(i){return this.applyMatrix4(i.matrixWorldInverse).applyMatrix4(i.projectionMatrix)}unproject(i){return this.applyMatrix4(i.projectionMatrixInverse).applyMatrix4(i.matrixWorld)}transformDirection(i){const c=this.x,g=this.y,_=this.z,w=i.elements;return this.x=w[0]*c+w[4]*g+w[8]*_,this.y=w[1]*c+w[5]*g+w[9]*_,this.z=w[2]*c+w[6]*g+w[10]*_,this.normalize()}divide(i){return this.x/=i.x,this.y/=i.y,this.z/=i.z,this}divideScalar(i){return this.multiplyScalar(1/i)}min(i){return this.x=Math.min(this.x,i.x),this.y=Math.min(this.y,i.y),this.z=Math.min(this.z,i.z),this}max(i){return this.x=Math.max(this.x,i.x),this.y=Math.max(this.y,i.y),this.z=Math.max(this.z,i.z),this}clamp(i,c){return this.x=Math.max(i.x,Math.min(c.x,this.x)),this.y=Math.max(i.y,Math.min(c.y,this.y)),this.z=Math.max(i.z,Math.min(c.z,this.z)),this}clampScalar(i,c){return this.x=Math.max(i,Math.min(c,this.x)),this.y=Math.max(i,Math.min(c,this.y)),this.z=Math.max(i,Math.min(c,this.z)),this}clampLength(i,c){const g=this.length();return this.divideScalar(g||1).multiplyScalar(Math.max(i,Math.min(c,g)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(i){return this.x*i.x+this.y*i.y+this.z*i.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(i){return this.normalize().multiplyScalar(i)}lerp(i,c){return this.x+=(i.x-this.x)*c,this.y+=(i.y-this.y)*c,this.z+=(i.z-this.z)*c,this}lerpVectors(i,c,g){return this.x=i.x+(c.x-i.x)*g,this.y=i.y+(c.y-i.y)*g,this.z=i.z+(c.z-i.z)*g,this}cross(i,c){return c!==void 0?(console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(i,c)):this.crossVectors(this,i)}crossVectors(i,c){const g=i.x,_=i.y,w=i.z,A=c.x,R=c.y,z=c.z;return this.x=_*z-w*R,this.y=w*A-g*z,this.z=g*R-_*A,this}projectOnVector(i){const c=i.lengthSq();if(c===0)return this.set(0,0,0);const g=i.dot(this)/c;return this.copy(i).multiplyScalar(g)}projectOnPlane(i){return Bo.copy(this).projectOnVector(i),this.sub(Bo)}reflect(i){return this.sub(Bo.copy(i).multiplyScalar(2*this.dot(i)))}angleTo(i){const c=Math.sqrt(this.lengthSq()*i.lengthSq());if(c===0)return Math.PI/2;const g=this.dot(i)/c;return Math.acos(Jn(g,-1,1))}distanceTo(i){return Math.sqrt(this.distanceToSquared(i))}distanceToSquared(i){const c=this.x-i.x,g=this.y-i.y,_=this.z-i.z;return c*c+g*g+_*_}manhattanDistanceTo(i){return Math.abs(this.x-i.x)+Math.abs(this.y-i.y)+Math.abs(this.z-i.z)}setFromSpherical(i){return this.setFromSphericalCoords(i.radius,i.phi,i.theta)}setFromSphericalCoords(i,c,g){const _=Math.sin(c)*i;return this.x=_*Math.sin(g),this.y=Math.cos(c)*i,this.z=_*Math.cos(g),this}setFromCylindrical(i){return this.setFromCylindricalCoords(i.radius,i.theta,i.y)}setFromCylindricalCoords(i,c,g){return this.x=i*Math.sin(c),this.y=g,this.z=i*Math.cos(c),this}setFromMatrixPosition(i){const c=i.elements;return this.x=c[12],this.y=c[13],this.z=c[14],this}setFromMatrixScale(i){const c=this.setFromMatrixColumn(i,0).length(),g=this.setFromMatrixColumn(i,1).length(),_=this.setFromMatrixColumn(i,2).length();return this.x=c,this.y=g,this.z=_,this}setFromMatrixColumn(i,c){return this.fromArray(i.elements,4*c)}setFromMatrix3Column(i,c){return this.fromArray(i.elements,3*c)}equals(i){return i.x===this.x&&i.y===this.y&&i.z===this.z}fromArray(i,c=0){return this.x=i[c],this.y=i[c+1],this.z=i[c+2],this}toArray(i=[],c=0){return i[c]=this.x,i[c+1]=this.y,i[c+2]=this.z,i}fromBufferAttribute(i,c,g){return g!==void 0&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=i.getX(c),this.y=i.getY(c),this.z=i.getZ(c),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}}et.prototype.isVector3=!0;const Bo=new et,As=new Rs;class ps{constructor(i=new et(1/0,1/0,1/0),c=new et(-1/0,-1/0,-1/0)){this.min=i,this.max=c}set(i,c){return this.min.copy(i),this.max.copy(c),this}setFromArray(i){let c=1/0,g=1/0,_=1/0,w=-1/0,A=-1/0,R=-1/0;for(let z=0,F=i.length;z<F;z+=3){const W=i[z],q=i[z+1],J=i[z+2];W<c&&(c=W),q<g&&(g=q),J<_&&(_=J),W>w&&(w=W),q>A&&(A=q),J>R&&(R=J)}return this.min.set(c,g,_),this.max.set(w,A,R),this}setFromBufferAttribute(i){let c=1/0,g=1/0,_=1/0,w=-1/0,A=-1/0,R=-1/0;for(let z=0,F=i.count;z<F;z++){const W=i.getX(z),q=i.getY(z),J=i.getZ(z);W<c&&(c=W),q<g&&(g=q),J<_&&(_=J),W>w&&(w=W),q>A&&(A=q),J>R&&(R=J)}return this.min.set(c,g,_),this.max.set(w,A,R),this}setFromPoints(i){this.makeEmpty();for(let c=0,g=i.length;c<g;c++)this.expandByPoint(i[c]);return this}setFromCenterAndSize(i,c){const g=Ro.copy(c).multiplyScalar(.5);return this.min.copy(i).sub(g),this.max.copy(i).add(g),this}setFromObject(i){return this.makeEmpty(),this.expandByObject(i)}clone(){return new this.constructor().copy(this)}copy(i){return this.min.copy(i.min),this.max.copy(i.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(i){return this.isEmpty()?i.set(0,0,0):i.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(i){return this.isEmpty()?i.set(0,0,0):i.subVectors(this.max,this.min)}expandByPoint(i){return this.min.min(i),this.max.max(i),this}expandByVector(i){return this.min.sub(i),this.max.add(i),this}expandByScalar(i){return this.min.addScalar(-i),this.max.addScalar(i),this}expandByObject(i){i.updateWorldMatrix(!1,!1);const c=i.geometry;c!==void 0&&(c.boundingBox===null&&c.computeBoundingBox(),ca.copy(c.boundingBox),ca.applyMatrix4(i.matrixWorld),this.union(ca));const g=i.children;for(let _=0,w=g.length;_<w;_++)this.expandByObject(g[_]);return this}containsPoint(i){return!(i.x<this.min.x||i.x>this.max.x||i.y<this.min.y||i.y>this.max.y||i.z<this.min.z||i.z>this.max.z)}containsBox(i){return this.min.x<=i.min.x&&i.max.x<=this.max.x&&this.min.y<=i.min.y&&i.max.y<=this.max.y&&this.min.z<=i.min.z&&i.max.z<=this.max.z}getParameter(i,c){return c.set((i.x-this.min.x)/(this.max.x-this.min.x),(i.y-this.min.y)/(this.max.y-this.min.y),(i.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(i){return!(i.max.x<this.min.x||i.min.x>this.max.x||i.max.y<this.min.y||i.min.y>this.max.y||i.max.z<this.min.z||i.min.z>this.max.z)}intersectsSphere(i){return this.clampPoint(i.center,Ro),Ro.distanceToSquared(i.center)<=i.radius*i.radius}intersectsPlane(i){let c,g;return i.normal.x>0?(c=i.normal.x*this.min.x,g=i.normal.x*this.max.x):(c=i.normal.x*this.max.x,g=i.normal.x*this.min.x),i.normal.y>0?(c+=i.normal.y*this.min.y,g+=i.normal.y*this.max.y):(c+=i.normal.y*this.max.y,g+=i.normal.y*this.min.y),i.normal.z>0?(c+=i.normal.z*this.min.z,g+=i.normal.z*this.max.z):(c+=i.normal.z*this.max.z,g+=i.normal.z*this.min.z),c<=-i.constant&&g>=-i.constant}intersectsTriangle(i){if(this.isEmpty())return!1;this.getCenter(Ke),tt.subVectors(this.max,Ke),ha.subVectors(i.a,Ke),ta.subVectors(i.b,Ke),at.subVectors(i.c,Ke),se.subVectors(ta,ha),me.subVectors(at,ta),Oe.subVectors(ha,at);let c=[0,-se.z,se.y,0,-me.z,me.y,0,-Oe.z,Oe.y,se.z,0,-se.x,me.z,0,-me.x,Oe.z,0,-Oe.x,-se.y,se.x,0,-me.y,me.x,0,-Oe.y,Oe.x,0];return!!yt(c,ha,ta,at,tt)&&(c=[1,0,0,0,1,0,0,0,1],!!yt(c,ha,ta,at,tt)&&(At.crossVectors(se,me),c=[At.x,At.y,At.z],yt(c,ha,ta,at,tt)))}clampPoint(i,c){return c.copy(i).clamp(this.min,this.max)}distanceToPoint(i){return Ro.copy(i).clamp(this.min,this.max).sub(i).length()}getBoundingSphere(i){return this.getCenter(i.center),i.radius=.5*this.getSize(Ro).length(),i}intersect(i){return this.min.max(i.min),this.max.min(i.max),this.isEmpty()&&this.makeEmpty(),this}union(i){return this.min.min(i.min),this.max.max(i.max),this}applyMatrix4(i){return this.isEmpty()||(No[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(i),No[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(i),No[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(i),No[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(i),No[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(i),No[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(i),No[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(i),No[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(i),this.setFromPoints(No)),this}translate(i){return this.min.add(i),this.max.add(i),this}equals(i){return i.min.equals(this.min)&&i.max.equals(this.max)}}ps.prototype.isBox3=!0;const No=[new et,new et,new et,new et,new et,new et,new et,new et],Ro=new et,ca=new ps,ha=new et,ta=new et,at=new et,se=new et,me=new et,Oe=new et,Ke=new et,tt=new et,At=new et,Ft=new et;function yt(M,i,c,g,_){for(let w=0,A=M.length-3;w<=A;w+=3){Ft.fromArray(M,w);const R=_.x*Math.abs(Ft.x)+_.y*Math.abs(Ft.y)+_.z*Math.abs(Ft.z),z=i.dot(Ft),F=c.dot(Ft),W=g.dot(Ft);if(Math.max(-Math.max(z,F,W),Math.min(z,F,W))>R)return!1}return!0}const jt=new ps,Oi=new et,Mi=new et,wn=new et;class Bn{constructor(i=new et,c=-1){this.center=i,this.radius=c}set(i,c){return this.center.copy(i),this.radius=c,this}setFromPoints(i,c){const g=this.center;c!==void 0?g.copy(c):jt.setFromPoints(i).getCenter(g);let _=0;for(let w=0,A=i.length;w<A;w++)_=Math.max(_,g.distanceToSquared(i[w]));return this.radius=Math.sqrt(_),this}copy(i){return this.center.copy(i.center),this.radius=i.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(i){return i.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(i){return i.distanceTo(this.center)-this.radius}intersectsSphere(i){const c=this.radius+i.radius;return i.center.distanceToSquared(this.center)<=c*c}intersectsBox(i){return i.intersectsSphere(this)}intersectsPlane(i){return Math.abs(i.distanceToPoint(this.center))<=this.radius}clampPoint(i,c){const g=this.center.distanceToSquared(i);return c.copy(i),g>this.radius*this.radius&&(c.sub(this.center).normalize(),c.multiplyScalar(this.radius).add(this.center)),c}getBoundingBox(i){return this.isEmpty()?(i.makeEmpty(),i):(i.set(this.center,this.center),i.expandByScalar(this.radius),i)}applyMatrix4(i){return this.center.applyMatrix4(i),this.radius=this.radius*i.getMaxScaleOnAxis(),this}translate(i){return this.center.add(i),this}expandByPoint(i){wn.subVectors(i,this.center);const c=wn.lengthSq();if(c>this.radius*this.radius){const g=Math.sqrt(c),_=.5*(g-this.radius);this.center.add(wn.multiplyScalar(_/g)),this.radius+=_}return this}union(i){return Mi.subVectors(i.center,this.center).normalize().multiplyScalar(i.radius),this.expandByPoint(Oi.copy(i.center).add(Mi)),this.expandByPoint(Oi.copy(i.center).sub(Mi)),this}equals(i){return i.center.equals(this.center)&&i.radius===this.radius}clone(){return new this.constructor().copy(this)}}const Vn=new et,lr=new et,jn=new et,fr=new et,bn=new et,as=new et,Vr=new et;class br{constructor(i=new et,c=new et(0,0,-1)){this.origin=i,this.direction=c}set(i,c){return this.origin.copy(i),this.direction.copy(c),this}copy(i){return this.origin.copy(i.origin),this.direction.copy(i.direction),this}at(i,c){return c.copy(this.direction).multiplyScalar(i).add(this.origin)}lookAt(i){return this.direction.copy(i).sub(this.origin).normalize(),this}recast(i){return this.origin.copy(this.at(i,Vn)),this}closestPointToPoint(i,c){c.subVectors(i,this.origin);const g=c.dot(this.direction);return g<0?c.copy(this.origin):c.copy(this.direction).multiplyScalar(g).add(this.origin)}distanceToPoint(i){return Math.sqrt(this.distanceSqToPoint(i))}distanceSqToPoint(i){const c=Vn.subVectors(i,this.origin).dot(this.direction);return c<0?this.origin.distanceToSquared(i):(Vn.copy(this.direction).multiplyScalar(c).add(this.origin),Vn.distanceToSquared(i))}distanceSqToSegment(i,c,g,_){lr.copy(i).add(c).multiplyScalar(.5),jn.copy(c).sub(i).normalize(),fr.copy(this.origin).sub(lr);const w=.5*i.distanceTo(c),A=-this.direction.dot(jn),R=fr.dot(this.direction),z=-fr.dot(jn),F=fr.lengthSq(),W=Math.abs(1-A*A);let q,J,K,re;if(W>0)if(q=A*z-R,J=A*R-z,re=w*W,q>=0)if(J>=-re)if(J<=re){const ce=1/W;q*=ce,J*=ce,K=q*(q+A*J+2*R)+J*(A*q+J+2*z)+F}else J=w,q=Math.max(0,-(A*J+R)),K=-q*q+J*(J+2*z)+F;else J=-w,q=Math.max(0,-(A*J+R)),K=-q*q+J*(J+2*z)+F;else J<=-re?(q=Math.max(0,-(-A*w+R)),J=q>0?-w:Math.min(Math.max(-w,-z),w),K=-q*q+J*(J+2*z)+F):J<=re?(q=0,J=Math.min(Math.max(-w,-z),w),K=J*(J+2*z)+F):(q=Math.max(0,-(A*w+R)),J=q>0?w:Math.min(Math.max(-w,-z),w),K=-q*q+J*(J+2*z)+F);else J=A>0?-w:w,q=Math.max(0,-(A*J+R)),K=-q*q+J*(J+2*z)+F;return g&&g.copy(this.direction).multiplyScalar(q).add(this.origin),_&&_.copy(jn).multiplyScalar(J).add(lr),K}intersectSphere(i,c){Vn.subVectors(i.center,this.origin);const g=Vn.dot(this.direction),_=Vn.dot(Vn)-g*g,w=i.radius*i.radius;if(_>w)return null;const A=Math.sqrt(w-_),R=g-A,z=g+A;return R<0&&z<0?null:R<0?this.at(z,c):this.at(R,c)}intersectsSphere(i){return this.distanceSqToPoint(i.center)<=i.radius*i.radius}distanceToPlane(i){const c=i.normal.dot(this.direction);if(c===0)return i.distanceToPoint(this.origin)===0?0:null;const g=-(this.origin.dot(i.normal)+i.constant)/c;return g>=0?g:null}intersectPlane(i,c){const g=this.distanceToPlane(i);return g===null?null:this.at(g,c)}intersectsPlane(i){const c=i.distanceToPoint(this.origin);return c===0?!0:i.normal.dot(this.direction)*c<0}intersectBox(i,c){let g,_,w,A,R,z;const F=1/this.direction.x,W=1/this.direction.y,q=1/this.direction.z,J=this.origin;return F>=0?(g=(i.min.x-J.x)*F,_=(i.max.x-J.x)*F):(g=(i.max.x-J.x)*F,_=(i.min.x-J.x)*F),W>=0?(w=(i.min.y-J.y)*W,A=(i.max.y-J.y)*W):(w=(i.max.y-J.y)*W,A=(i.min.y-J.y)*W),g>A||w>_?null:((w>g||g!=g)&&(g=w),(A<_||_!=_)&&(_=A),q>=0?(R=(i.min.z-J.z)*q,z=(i.max.z-J.z)*q):(R=(i.max.z-J.z)*q,z=(i.min.z-J.z)*q),g>z||R>_?null:((R>g||g!=g)&&(g=R),(z<_||_!=_)&&(_=z),_<0?null:this.at(g>=0?g:_,c)))}intersectsBox(i){return this.intersectBox(i,Vn)!==null}intersectTriangle(i,c,g,_,w){bn.subVectors(c,i),as.subVectors(g,i),Vr.crossVectors(bn,as);let A,R=this.direction.dot(Vr);if(R>0){if(_)return null;A=1}else{if(!(R<0))return null;A=-1,R=-R}fr.subVectors(this.origin,i);const z=A*this.direction.dot(as.crossVectors(fr,as));if(z<0)return null;const F=A*this.direction.dot(bn.cross(fr));if(F<0||z+F>R)return null;const W=-A*fr.dot(Vr);return W<0?null:this.at(W/R,w)}applyMatrix4(i){return this.origin.applyMatrix4(i),this.direction.transformDirection(i),this}equals(i){return i.origin.equals(this.origin)&&i.direction.equals(this.direction)}clone(){return new this.constructor().copy(this)}}class Mn{constructor(){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}set(i,c,g,_,w,A,R,z,F,W,q,J,K,re,ce,Me){const de=this.elements;return de[0]=i,de[4]=c,de[8]=g,de[12]=_,de[1]=w,de[5]=A,de[9]=R,de[13]=z,de[2]=F,de[6]=W,de[10]=q,de[14]=J,de[3]=K,de[7]=re,de[11]=ce,de[15]=Me,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return new Mn().fromArray(this.elements)}copy(i){const c=this.elements,g=i.elements;return c[0]=g[0],c[1]=g[1],c[2]=g[2],c[3]=g[3],c[4]=g[4],c[5]=g[5],c[6]=g[6],c[7]=g[7],c[8]=g[8],c[9]=g[9],c[10]=g[10],c[11]=g[11],c[12]=g[12],c[13]=g[13],c[14]=g[14],c[15]=g[15],this}copyPosition(i){const c=this.elements,g=i.elements;return c[12]=g[12],c[13]=g[13],c[14]=g[14],this}setFromMatrix3(i){const c=i.elements;return this.set(c[0],c[3],c[6],0,c[1],c[4],c[7],0,c[2],c[5],c[8],0,0,0,0,1),this}extractBasis(i,c,g){return i.setFromMatrixColumn(this,0),c.setFromMatrixColumn(this,1),g.setFromMatrixColumn(this,2),this}makeBasis(i,c,g){return this.set(i.x,c.x,g.x,0,i.y,c.y,g.y,0,i.z,c.z,g.z,0,0,0,0,1),this}extractRotation(i){const c=this.elements,g=i.elements,_=1/Wr.setFromMatrixColumn(i,0).length(),w=1/Wr.setFromMatrixColumn(i,1).length(),A=1/Wr.setFromMatrixColumn(i,2).length();return c[0]=g[0]*_,c[1]=g[1]*_,c[2]=g[2]*_,c[3]=0,c[4]=g[4]*w,c[5]=g[5]*w,c[6]=g[6]*w,c[7]=0,c[8]=g[8]*A,c[9]=g[9]*A,c[10]=g[10]*A,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,this}makeRotationFromEuler(i){i&&i.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");const c=this.elements,g=i.x,_=i.y,w=i.z,A=Math.cos(g),R=Math.sin(g),z=Math.cos(_),F=Math.sin(_),W=Math.cos(w),q=Math.sin(w);if(i.order==="XYZ"){const J=A*W,K=A*q,re=R*W,ce=R*q;c[0]=z*W,c[4]=-z*q,c[8]=F,c[1]=K+re*F,c[5]=J-ce*F,c[9]=-R*z,c[2]=ce-J*F,c[6]=re+K*F,c[10]=A*z}else if(i.order==="YXZ"){const J=z*W,K=z*q,re=F*W,ce=F*q;c[0]=J+ce*R,c[4]=re*R-K,c[8]=A*F,c[1]=A*q,c[5]=A*W,c[9]=-R,c[2]=K*R-re,c[6]=ce+J*R,c[10]=A*z}else if(i.order==="ZXY"){const J=z*W,K=z*q,re=F*W,ce=F*q;c[0]=J-ce*R,c[4]=-A*q,c[8]=re+K*R,c[1]=K+re*R,c[5]=A*W,c[9]=ce-J*R,c[2]=-A*F,c[6]=R,c[10]=A*z}else if(i.order==="ZYX"){const J=A*W,K=A*q,re=R*W,ce=R*q;c[0]=z*W,c[4]=re*F-K,c[8]=J*F+ce,c[1]=z*q,c[5]=ce*F+J,c[9]=K*F-re,c[2]=-F,c[6]=R*z,c[10]=A*z}else if(i.order==="YZX"){const J=A*z,K=A*F,re=R*z,ce=R*F;c[0]=z*W,c[4]=ce-J*q,c[8]=re*q+K,c[1]=q,c[5]=A*W,c[9]=-R*W,c[2]=-F*W,c[6]=K*q+re,c[10]=J-ce*q}else if(i.order==="XZY"){const J=A*z,K=A*F,re=R*z,ce=R*F;c[0]=z*W,c[4]=-q,c[8]=F*W,c[1]=J*q+ce,c[5]=A*W,c[9]=K*q-re,c[2]=re*q-K,c[6]=R*W,c[10]=ce*q+J}return c[3]=0,c[7]=0,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,this}makeRotationFromQuaternion(i){return this.compose(Cs,i,uo)}lookAt(i,c,g){const _=this.elements;return wo.subVectors(i,c),wo.lengthSq()===0&&(wo.z=1),wo.normalize(),bo.crossVectors(g,wo),bo.lengthSq()===0&&(Math.abs(g.z)===1?wo.x+=1e-4:wo.z+=1e-4,wo.normalize(),bo.crossVectors(g,wo)),bo.normalize(),wl.crossVectors(wo,bo),_[0]=bo.x,_[4]=wl.x,_[8]=wo.x,_[1]=bo.y,_[5]=wl.y,_[9]=wo.y,_[2]=bo.z,_[6]=wl.z,_[10]=wo.z,this}multiply(i,c){return c!==void 0?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(i,c)):this.multiplyMatrices(this,i)}premultiply(i){return this.multiplyMatrices(i,this)}multiplyMatrices(i,c){const g=i.elements,_=c.elements,w=this.elements,A=g[0],R=g[4],z=g[8],F=g[12],W=g[1],q=g[5],J=g[9],K=g[13],re=g[2],ce=g[6],Me=g[10],de=g[14],Xe=g[3],nt=g[7],Je=g[11],gt=g[15],Tt=_[0],Zt=_[4],ei=_[8],vi=_[12],Xt=_[1],xi=_[5],In=_[9],gn=_[13],Vi=_[2],vn=_[6],$n=_[10],tr=_[14],mr=_[3],Ar=_[7],hr=_[11],mn=_[15];return w[0]=A*Tt+R*Xt+z*Vi+F*mr,w[4]=A*Zt+R*xi+z*vn+F*Ar,w[8]=A*ei+R*In+z*$n+F*hr,w[12]=A*vi+R*gn+z*tr+F*mn,w[1]=W*Tt+q*Xt+J*Vi+K*mr,w[5]=W*Zt+q*xi+J*vn+K*Ar,w[9]=W*ei+q*In+J*$n+K*hr,w[13]=W*vi+q*gn+J*tr+K*mn,w[2]=re*Tt+ce*Xt+Me*Vi+de*mr,w[6]=re*Zt+ce*xi+Me*vn+de*Ar,w[10]=re*ei+ce*In+Me*$n+de*hr,w[14]=re*vi+ce*gn+Me*tr+de*mn,w[3]=Xe*Tt+nt*Xt+Je*Vi+gt*mr,w[7]=Xe*Zt+nt*xi+Je*vn+gt*Ar,w[11]=Xe*ei+nt*In+Je*$n+gt*hr,w[15]=Xe*vi+nt*gn+Je*tr+gt*mn,this}multiplyScalar(i){const c=this.elements;return c[0]*=i,c[4]*=i,c[8]*=i,c[12]*=i,c[1]*=i,c[5]*=i,c[9]*=i,c[13]*=i,c[2]*=i,c[6]*=i,c[10]*=i,c[14]*=i,c[3]*=i,c[7]*=i,c[11]*=i,c[15]*=i,this}determinant(){const i=this.elements,c=i[0],g=i[4],_=i[8],w=i[12],A=i[1],R=i[5],z=i[9],F=i[13],W=i[2],q=i[6],J=i[10],K=i[14];return i[3]*(+w*z*q-_*F*q-w*R*J+g*F*J+_*R*K-g*z*K)+i[7]*(+c*z*K-c*F*J+w*A*J-_*A*K+_*F*W-w*z*W)+i[11]*(+c*F*q-c*R*K-w*A*q+g*A*K+w*R*W-g*F*W)+i[15]*(-_*R*W-c*z*q+c*R*J+_*A*q-g*A*J+g*z*W)}transpose(){const i=this.elements;let c;return c=i[1],i[1]=i[4],i[4]=c,c=i[2],i[2]=i[8],i[8]=c,c=i[6],i[6]=i[9],i[9]=c,c=i[3],i[3]=i[12],i[12]=c,c=i[7],i[7]=i[13],i[13]=c,c=i[11],i[11]=i[14],i[14]=c,this}setPosition(i,c,g){const _=this.elements;return i.isVector3?(_[12]=i.x,_[13]=i.y,_[14]=i.z):(_[12]=i,_[13]=c,_[14]=g),this}invert(){const i=this.elements,c=i[0],g=i[1],_=i[2],w=i[3],A=i[4],R=i[5],z=i[6],F=i[7],W=i[8],q=i[9],J=i[10],K=i[11],re=i[12],ce=i[13],Me=i[14],de=i[15],Xe=q*Me*F-ce*J*F+ce*z*K-R*Me*K-q*z*de+R*J*de,nt=re*J*F-W*Me*F-re*z*K+A*Me*K+W*z*de-A*J*de,Je=W*ce*F-re*q*F+re*R*K-A*ce*K-W*R*de+A*q*de,gt=re*q*z-W*ce*z-re*R*J+A*ce*J+W*R*Me-A*q*Me,Tt=c*Xe+g*nt+_*Je+w*gt;if(Tt===0)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const Zt=1/Tt;return i[0]=Xe*Zt,i[1]=(ce*J*w-q*Me*w-ce*_*K+g*Me*K+q*_*de-g*J*de)*Zt,i[2]=(R*Me*w-ce*z*w+ce*_*F-g*Me*F-R*_*de+g*z*de)*Zt,i[3]=(q*z*w-R*J*w-q*_*F+g*J*F+R*_*K-g*z*K)*Zt,i[4]=nt*Zt,i[5]=(W*Me*w-re*J*w+re*_*K-c*Me*K-W*_*de+c*J*de)*Zt,i[6]=(re*z*w-A*Me*w-re*_*F+c*Me*F+A*_*de-c*z*de)*Zt,i[7]=(A*J*w-W*z*w+W*_*F-c*J*F-A*_*K+c*z*K)*Zt,i[8]=Je*Zt,i[9]=(re*q*w-W*ce*w-re*g*K+c*ce*K+W*g*de-c*q*de)*Zt,i[10]=(A*ce*w-re*R*w+re*g*F-c*ce*F-A*g*de+c*R*de)*Zt,i[11]=(W*R*w-A*q*w-W*g*F+c*q*F+A*g*K-c*R*K)*Zt,i[12]=gt*Zt,i[13]=(W*ce*_-re*q*_+re*g*J-c*ce*J-W*g*Me+c*q*Me)*Zt,i[14]=(re*R*_-A*ce*_-re*g*z+c*ce*z+A*g*Me-c*R*Me)*Zt,i[15]=(A*q*_-W*R*_+W*g*z-c*q*z-A*g*J+c*R*J)*Zt,this}scale(i){const c=this.elements,g=i.x,_=i.y,w=i.z;return c[0]*=g,c[4]*=_,c[8]*=w,c[1]*=g,c[5]*=_,c[9]*=w,c[2]*=g,c[6]*=_,c[10]*=w,c[3]*=g,c[7]*=_,c[11]*=w,this}getMaxScaleOnAxis(){const i=this.elements,c=i[0]*i[0]+i[1]*i[1]+i[2]*i[2],g=i[4]*i[4]+i[5]*i[5]+i[6]*i[6],_=i[8]*i[8]+i[9]*i[9]+i[10]*i[10];return Math.sqrt(Math.max(c,g,_))}makeTranslation(i,c,g){return this.set(1,0,0,i,0,1,0,c,0,0,1,g,0,0,0,1),this}makeRotationX(i){const c=Math.cos(i),g=Math.sin(i);return this.set(1,0,0,0,0,c,-g,0,0,g,c,0,0,0,0,1),this}makeRotationY(i){const c=Math.cos(i),g=Math.sin(i);return this.set(c,0,g,0,0,1,0,0,-g,0,c,0,0,0,0,1),this}makeRotationZ(i){const c=Math.cos(i),g=Math.sin(i);return this.set(c,-g,0,0,g,c,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(i,c){const g=Math.cos(c),_=Math.sin(c),w=1-g,A=i.x,R=i.y,z=i.z,F=w*A,W=w*R;return this.set(F*A+g,F*R-_*z,F*z+_*R,0,F*R+_*z,W*R+g,W*z-_*A,0,F*z-_*R,W*z+_*A,w*z*z+g,0,0,0,0,1),this}makeScale(i,c,g){return this.set(i,0,0,0,0,c,0,0,0,0,g,0,0,0,0,1),this}makeShear(i,c,g,_,w,A){return this.set(1,g,w,0,i,1,A,0,c,_,1,0,0,0,0,1),this}compose(i,c,g){const _=this.elements,w=c._x,A=c._y,R=c._z,z=c._w,F=w+w,W=A+A,q=R+R,J=w*F,K=w*W,re=w*q,ce=A*W,Me=A*q,de=R*q,Xe=z*F,nt=z*W,Je=z*q,gt=g.x,Tt=g.y,Zt=g.z;return _[0]=(1-(ce+de))*gt,_[1]=(K+Je)*gt,_[2]=(re-nt)*gt,_[3]=0,_[4]=(K-Je)*Tt,_[5]=(1-(J+de))*Tt,_[6]=(Me+Xe)*Tt,_[7]=0,_[8]=(re+nt)*Zt,_[9]=(Me-Xe)*Zt,_[10]=(1-(J+ce))*Zt,_[11]=0,_[12]=i.x,_[13]=i.y,_[14]=i.z,_[15]=1,this}decompose(i,c,g){const _=this.elements;let w=Wr.set(_[0],_[1],_[2]).length();const A=Wr.set(_[4],_[5],_[6]).length(),R=Wr.set(_[8],_[9],_[10]).length();this.determinant()<0&&(w=-w),i.x=_[12],i.y=_[13],i.z=_[14],ss.copy(this);const z=1/w,F=1/A,W=1/R;return ss.elements[0]*=z,ss.elements[1]*=z,ss.elements[2]*=z,ss.elements[4]*=F,ss.elements[5]*=F,ss.elements[6]*=F,ss.elements[8]*=W,ss.elements[9]*=W,ss.elements[10]*=W,c.setFromRotationMatrix(ss),g.x=w,g.y=A,g.z=R,this}makePerspective(i,c,g,_,w,A){A===void 0&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");const R=this.elements,z=2*w/(c-i),F=2*w/(g-_),W=(c+i)/(c-i),q=(g+_)/(g-_),J=-(A+w)/(A-w),K=-2*A*w/(A-w);return R[0]=z,R[4]=0,R[8]=W,R[12]=0,R[1]=0,R[5]=F,R[9]=q,R[13]=0,R[2]=0,R[6]=0,R[10]=J,R[14]=K,R[3]=0,R[7]=0,R[11]=-1,R[15]=0,this}makeOrthographic(i,c,g,_,w,A){const R=this.elements,z=1/(c-i),F=1/(g-_),W=1/(A-w),q=(c+i)*z,J=(g+_)*F,K=(A+w)*W;return R[0]=2*z,R[4]=0,R[8]=0,R[12]=-q,R[1]=0,R[5]=2*F,R[9]=0,R[13]=-J,R[2]=0,R[6]=0,R[10]=-2*W,R[14]=-K,R[3]=0,R[7]=0,R[11]=0,R[15]=1,this}equals(i){const c=this.elements,g=i.elements;for(let _=0;_<16;_++)if(c[_]!==g[_])return!1;return!0}fromArray(i,c=0){for(let g=0;g<16;g++)this.elements[g]=i[g+c];return this}toArray(i=[],c=0){const g=this.elements;return i[c]=g[0],i[c+1]=g[1],i[c+2]=g[2],i[c+3]=g[3],i[c+4]=g[4],i[c+5]=g[5],i[c+6]=g[6],i[c+7]=g[7],i[c+8]=g[8],i[c+9]=g[9],i[c+10]=g[10],i[c+11]=g[11],i[c+12]=g[12],i[c+13]=g[13],i[c+14]=g[14],i[c+15]=g[15],i}}Mn.prototype.isMatrix4=!0;const Wr=new et,ss=new Mn,Cs=new et(0,0,0),uo=new et(1,1,1),bo=new et,wl=new et,wo=new et,Ml=new Mn,ur=new Rs;class ba{constructor(i=0,c=0,g=0,_=ba.DefaultOrder){this._x=i,this._y=c,this._z=g,this._order=_}get x(){return this._x}set x(i){this._x=i,this._onChangeCallback()}get y(){return this._y}set y(i){this._y=i,this._onChangeCallback()}get z(){return this._z}set z(i){this._z=i,this._onChangeCallback()}get order(){return this._order}set order(i){this._order=i,this._onChangeCallback()}set(i,c,g,_=this._order){return this._x=i,this._y=c,this._z=g,this._order=_,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(i){return this._x=i._x,this._y=i._y,this._z=i._z,this._order=i._order,this._onChangeCallback(),this}setFromRotationMatrix(i,c=this._order,g=!0){const _=i.elements,w=_[0],A=_[4],R=_[8],z=_[1],F=_[5],W=_[9],q=_[2],J=_[6],K=_[10];switch(c){case"XYZ":this._y=Math.asin(Jn(R,-1,1)),Math.abs(R)<.9999999?(this._x=Math.atan2(-W,K),this._z=Math.atan2(-A,w)):(this._x=Math.atan2(J,F),this._z=0);break;case"YXZ":this._x=Math.asin(-Jn(W,-1,1)),Math.abs(W)<.9999999?(this._y=Math.atan2(R,K),this._z=Math.atan2(z,F)):(this._y=Math.atan2(-q,w),this._z=0);break;case"ZXY":this._x=Math.asin(Jn(J,-1,1)),Math.abs(J)<.9999999?(this._y=Math.atan2(-q,K),this._z=Math.atan2(-A,F)):(this._y=0,this._z=Math.atan2(z,w));break;case"ZYX":this._y=Math.asin(-Jn(q,-1,1)),Math.abs(q)<.9999999?(this._x=Math.atan2(J,K),this._z=Math.atan2(z,w)):(this._x=0,this._z=Math.atan2(-A,F));break;case"YZX":this._z=Math.asin(Jn(z,-1,1)),Math.abs(z)<.9999999?(this._x=Math.atan2(-W,F),this._y=Math.atan2(-q,w)):(this._x=0,this._y=Math.atan2(R,K));break;case"XZY":this._z=Math.asin(-Jn(A,-1,1)),Math.abs(A)<.9999999?(this._x=Math.atan2(J,F),this._y=Math.atan2(R,w)):(this._x=Math.atan2(-W,K),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+c)}return this._order=c,g===!0&&this._onChangeCallback(),this}setFromQuaternion(i,c,g){return Ml.makeRotationFromQuaternion(i),this.setFromRotationMatrix(Ml,c,g)}setFromVector3(i,c=this._order){return this.set(i.x,i.y,i.z,c)}reorder(i){return ur.setFromEuler(this),this.setFromQuaternion(ur,i)}equals(i){return i._x===this._x&&i._y===this._y&&i._z===this._z&&i._order===this._order}fromArray(i){return this._x=i[0],this._y=i[1],this._z=i[2],i[3]!==void 0&&(this._order=i[3]),this._onChangeCallback(),this}toArray(i=[],c=0){return i[c]=this._x,i[c+1]=this._y,i[c+2]=this._z,i[c+3]=this._order,i}toVector3(i){return i?i.set(this._x,this._y,this._z):new et(this._x,this._y,this._z)}_onChange(i){return this._onChangeCallback=i,this}_onChangeCallback(){}}ba.prototype.isEuler=!0,ba.DefaultOrder="XYZ",ba.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"];class ia{constructor(){this.mask=1}set(i){this.mask=1<<i|0}enable(i){this.mask|=1<<i|0}enableAll(){this.mask=-1}toggle(i){this.mask^=1<<i|0}disable(i){this.mask&=~(1<<i|0)}disableAll(){this.mask=0}test(i){return(this.mask&i.mask)!=0}}let Ws=0;const Tl=new et,Ba=new Rs,be=new Mn,ge=new et,De=new et,ut=new et,ui=new Rs,Ei=new et(1,0,0),ni=new et(0,1,0),ki=new et(0,0,1),he={type:"added"},le={type:"removed"};class we extends si{constructor(){super(),Object.defineProperty(this,"id",{value:Ws++}),this.uuid=Yn(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=we.DefaultUp.clone();const i=new et,c=new ba,g=new Rs,_=new et(1,1,1);c._onChange(function(){g.setFromEuler(c,!1)}),g._onChange(function(){c.setFromQuaternion(g,void 0,!1)}),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:i},rotation:{configurable:!0,enumerable:!0,value:c},quaternion:{configurable:!0,enumerable:!0,value:g},scale:{configurable:!0,enumerable:!0,value:_},modelViewMatrix:{value:new Mn},normalMatrix:{value:new jr}}),this.matrix=new Mn,this.matrixWorld=new Mn,this.matrixAutoUpdate=we.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new ia,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeRender(){}onAfterRender(){}applyMatrix4(i){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(i),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(i){return this.quaternion.premultiply(i),this}setRotationFromAxisAngle(i,c){this.quaternion.setFromAxisAngle(i,c)}setRotationFromEuler(i){this.quaternion.setFromEuler(i,!0)}setRotationFromMatrix(i){this.quaternion.setFromRotationMatrix(i)}setRotationFromQuaternion(i){this.quaternion.copy(i)}rotateOnAxis(i,c){return Ba.setFromAxisAngle(i,c),this.quaternion.multiply(Ba),this}rotateOnWorldAxis(i,c){return Ba.setFromAxisAngle(i,c),this.quaternion.premultiply(Ba),this}rotateX(i){return this.rotateOnAxis(Ei,i)}rotateY(i){return this.rotateOnAxis(ni,i)}rotateZ(i){return this.rotateOnAxis(ki,i)}translateOnAxis(i,c){return Tl.copy(i).applyQuaternion(this.quaternion),this.position.add(Tl.multiplyScalar(c)),this}translateX(i){return this.translateOnAxis(Ei,i)}translateY(i){return this.translateOnAxis(ni,i)}translateZ(i){return this.translateOnAxis(ki,i)}localToWorld(i){return i.applyMatrix4(this.matrixWorld)}worldToLocal(i){return i.applyMatrix4(be.copy(this.matrixWorld).invert())}lookAt(i,c,g){i.isVector3?ge.copy(i):ge.set(i,c,g);const _=this.parent;this.updateWorldMatrix(!0,!1),De.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?be.lookAt(De,ge,this.up):be.lookAt(ge,De,this.up),this.quaternion.setFromRotationMatrix(be),_&&(be.extractRotation(_.matrixWorld),Ba.setFromRotationMatrix(be),this.quaternion.premultiply(Ba.invert()))}add(i){if(arguments.length>1){for(let c=0;c<arguments.length;c++)this.add(arguments[c]);return this}return i===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",i),this):(i&&i.isObject3D?(i.parent!==null&&i.parent.remove(i),i.parent=this,this.children.push(i),i.dispatchEvent(he)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",i),this)}remove(i){if(arguments.length>1){for(let g=0;g<arguments.length;g++)this.remove(arguments[g]);return this}const c=this.children.indexOf(i);return c!==-1&&(i.parent=null,this.children.splice(c,1),i.dispatchEvent(le)),this}removeFromParent(){const i=this.parent;return i!==null&&i.remove(this),this}clear(){for(let i=0;i<this.children.length;i++){const c=this.children[i];c.parent=null,c.dispatchEvent(le)}return this.children.length=0,this}attach(i){return this.updateWorldMatrix(!0,!1),be.copy(this.matrixWorld).invert(),i.parent!==null&&(i.parent.updateWorldMatrix(!0,!1),be.multiply(i.parent.matrixWorld)),i.applyMatrix4(be),this.add(i),i.updateWorldMatrix(!1,!0),this}getObjectById(i){return this.getObjectByProperty("id",i)}getObjectByName(i){return this.getObjectByProperty("name",i)}getObjectByProperty(i,c){if(this[i]===c)return this;for(let g=0,_=this.children.length;g<_;g++){const w=this.children[g].getObjectByProperty(i,c);if(w!==void 0)return w}}getWorldPosition(i){return this.updateWorldMatrix(!0,!1),i.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(i){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(De,i,ut),i}getWorldScale(i){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(De,ui,i),i}getWorldDirection(i){this.updateWorldMatrix(!0,!1);const c=this.matrixWorld.elements;return i.set(c[8],c[9],c[10]).normalize()}raycast(){}traverse(i){i(this);const c=this.children;for(let g=0,_=c.length;g<_;g++)c[g].traverse(i)}traverseVisible(i){if(this.visible===!1)return;i(this);const c=this.children;for(let g=0,_=c.length;g<_;g++)c[g].traverseVisible(i)}traverseAncestors(i){const c=this.parent;c!==null&&(i(c),c.traverseAncestors(i))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(i){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||i)&&(this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,i=!0);const c=this.children;for(let g=0,_=c.length;g<_;g++)c[g].updateMatrixWorld(i)}updateWorldMatrix(i,c){const g=this.parent;if(i===!0&&g!==null&&g.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),c===!0){const _=this.children;for(let w=0,A=_.length;w<A;w++)_[w].updateWorldMatrix(!1,!0)}}toJSON(i){const c=i===void 0||typeof i=="string",g={};c&&(i={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{}},g.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});const _={};function w(R,z){return R[z.uuid]===void 0&&(R[z.uuid]=z.toJSON(i)),z.uuid}if(_.uuid=this.uuid,_.type=this.type,this.name!==""&&(_.name=this.name),this.castShadow===!0&&(_.castShadow=!0),this.receiveShadow===!0&&(_.receiveShadow=!0),this.visible===!1&&(_.visible=!1),this.frustumCulled===!1&&(_.frustumCulled=!1),this.renderOrder!==0&&(_.renderOrder=this.renderOrder),JSON.stringify(this.userData)!=="{}"&&(_.userData=this.userData),_.layers=this.layers.mask,_.matrix=this.matrix.toArray(),this.matrixAutoUpdate===!1&&(_.matrixAutoUpdate=!1),this.isInstancedMesh&&(_.type="InstancedMesh",_.count=this.count,_.instanceMatrix=this.instanceMatrix.toJSON(),this.instanceColor!==null&&(_.instanceColor=this.instanceColor.toJSON())),this.isScene)this.background&&(this.background.isColor?_.background=this.background.toJSON():this.background.isTexture&&(_.background=this.background.toJSON(i).uuid)),this.environment&&this.environment.isTexture&&(_.environment=this.environment.toJSON(i).uuid);else if(this.isMesh||this.isLine||this.isPoints){_.geometry=w(i.geometries,this.geometry);const R=this.geometry.parameters;if(R!==void 0&&R.shapes!==void 0){const z=R.shapes;if(Array.isArray(z))for(let F=0,W=z.length;F<W;F++){const q=z[F];w(i.shapes,q)}else w(i.shapes,z)}}if(this.isSkinnedMesh&&(_.bindMode=this.bindMode,_.bindMatrix=this.bindMatrix.toArray(),this.skeleton!==void 0&&(w(i.skeletons,this.skeleton),_.skeleton=this.skeleton.uuid)),this.material!==void 0)if(Array.isArray(this.material)){const R=[];for(let z=0,F=this.material.length;z<F;z++)R.push(w(i.materials,this.material[z]));_.material=R}else _.material=w(i.materials,this.material);if(this.children.length>0){_.children=[];for(let R=0;R<this.children.length;R++)_.children.push(this.children[R].toJSON(i).object)}if(this.animations.length>0){_.animations=[];for(let R=0;R<this.animations.length;R++){const z=this.animations[R];_.animations.push(w(i.animations,z))}}if(c){const R=A(i.geometries),z=A(i.materials),F=A(i.textures),W=A(i.images),q=A(i.shapes),J=A(i.skeletons),K=A(i.animations);R.length>0&&(g.geometries=R),z.length>0&&(g.materials=z),F.length>0&&(g.textures=F),W.length>0&&(g.images=W),q.length>0&&(g.shapes=q),J.length>0&&(g.skeletons=J),K.length>0&&(g.animations=K)}return g.object=_,g;function A(R){const z=[];for(const F in R){const W=R[F];delete W.metadata,z.push(W)}return z}}clone(i){return new this.constructor().copy(this,i)}copy(i,c=!0){if(this.name=i.name,this.up.copy(i.up),this.position.copy(i.position),this.rotation.order=i.rotation.order,this.quaternion.copy(i.quaternion),this.scale.copy(i.scale),this.matrix.copy(i.matrix),this.matrixWorld.copy(i.matrixWorld),this.matrixAutoUpdate=i.matrixAutoUpdate,this.matrixWorldNeedsUpdate=i.matrixWorldNeedsUpdate,this.layers.mask=i.layers.mask,this.visible=i.visible,this.castShadow=i.castShadow,this.receiveShadow=i.receiveShadow,this.frustumCulled=i.frustumCulled,this.renderOrder=i.renderOrder,this.userData=JSON.parse(JSON.stringify(i.userData)),c===!0)for(let g=0;g<i.children.length;g++){const _=i.children[g];this.add(_.clone())}return this}}we.DefaultUp=new et(0,1,0),we.DefaultMatrixAutoUpdate=!0,we.prototype.isObject3D=!0;const Ve=new et,ze=new et,Bt=new et,kt=new et,Di=new et,cn=new et,Sn=new et,Hi=new et,yi=new et,zn=new et;class Zi{constructor(i=new et,c=new et,g=new et){this.a=i,this.b=c,this.c=g}static getNormal(i,c,g,_){_.subVectors(g,c),Ve.subVectors(i,c),_.cross(Ve);const w=_.lengthSq();return w>0?_.multiplyScalar(1/Math.sqrt(w)):_.set(0,0,0)}static getBarycoord(i,c,g,_,w){Ve.subVectors(_,c),ze.subVectors(g,c),Bt.subVectors(i,c);const A=Ve.dot(Ve),R=Ve.dot(ze),z=Ve.dot(Bt),F=ze.dot(ze),W=ze.dot(Bt),q=A*F-R*R;if(q===0)return w.set(-2,-1,-1);const J=1/q,K=(F*z-R*W)*J,re=(A*W-R*z)*J;return w.set(1-K-re,re,K)}static containsPoint(i,c,g,_){return this.getBarycoord(i,c,g,_,kt),kt.x>=0&&kt.y>=0&&kt.x+kt.y<=1}static getUV(i,c,g,_,w,A,R,z){return this.getBarycoord(i,c,g,_,kt),z.set(0,0),z.addScaledVector(w,kt.x),z.addScaledVector(A,kt.y),z.addScaledVector(R,kt.z),z}static isFrontFacing(i,c,g,_){return Ve.subVectors(g,c),ze.subVectors(i,c),Ve.cross(ze).dot(_)<0}set(i,c,g){return this.a.copy(i),this.b.copy(c),this.c.copy(g),this}setFromPointsAndIndices(i,c,g,_){return this.a.copy(i[c]),this.b.copy(i[g]),this.c.copy(i[_]),this}clone(){return new this.constructor().copy(this)}copy(i){return this.a.copy(i.a),this.b.copy(i.b),this.c.copy(i.c),this}getArea(){return Ve.subVectors(this.c,this.b),ze.subVectors(this.a,this.b),.5*Ve.cross(ze).length()}getMidpoint(i){return i.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(i){return Zi.getNormal(this.a,this.b,this.c,i)}getPlane(i){return i.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(i,c){return Zi.getBarycoord(i,this.a,this.b,this.c,c)}getUV(i,c,g,_,w){return Zi.getUV(i,this.a,this.b,this.c,c,g,_,w)}containsPoint(i){return Zi.containsPoint(i,this.a,this.b,this.c)}isFrontFacing(i){return Zi.isFrontFacing(this.a,this.b,this.c,i)}intersectsBox(i){return i.intersectsTriangle(this)}closestPointToPoint(i,c){const g=this.a,_=this.b,w=this.c;let A,R;Di.subVectors(_,g),cn.subVectors(w,g),Hi.subVectors(i,g);const z=Di.dot(Hi),F=cn.dot(Hi);if(z<=0&&F<=0)return c.copy(g);yi.subVectors(i,_);const W=Di.dot(yi),q=cn.dot(yi);if(W>=0&&q<=W)return c.copy(_);const J=z*q-W*F;if(J<=0&&z>=0&&W<=0)return A=z/(z-W),c.copy(g).addScaledVector(Di,A);zn.subVectors(i,w);const K=Di.dot(zn),re=cn.dot(zn);if(re>=0&&K<=re)return c.copy(w);const ce=K*F-z*re;if(ce<=0&&F>=0&&re<=0)return R=F/(F-re),c.copy(g).addScaledVector(cn,R);const Me=W*re-K*q;if(Me<=0&&q-W>=0&&K-re>=0)return Sn.subVectors(w,_),R=(q-W)/(q-W+(K-re)),c.copy(_).addScaledVector(Sn,R);const de=1/(Me+ce+J);return A=ce*de,R=J*de,c.copy(g).addScaledVector(Di,A).addScaledVector(cn,R)}equals(i){return i.a.equals(this.a)&&i.b.equals(this.b)&&i.c.equals(this.c)}}let Ln=0;class Bi extends si{constructor(){super(),Object.defineProperty(this,"id",{value:Ln++}),this.uuid=Yn(),this.name="",this.type="Material",this.fog=!0,this.blending=1,this.side=0,this.vertexColors=!1,this.opacity=1,this.format=1023,this.transparent=!1,this.blendSrc=204,this.blendDst=205,this.blendEquation=100,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=3,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=7680,this.stencilZFail=7680,this.stencilZPass=7680,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(i){this._alphaTest>0!=i>0&&this.version++,this._alphaTest=i}onBuild(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(i){if(i!==void 0)for(const c in i){const g=i[c];if(g===void 0){console.warn("THREE.Material: '"+c+"' parameter is undefined.");continue}if(c==="shading"){console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=g===1;continue}const _=this[c];_!==void 0?_&&_.isColor?_.set(g):_&&_.isVector3&&g&&g.isVector3?_.copy(g):this[c]=g:console.warn("THREE."+this.type+": '"+c+"' is not a property of this material.")}}toJSON(i){const c=i===void 0||typeof i=="string";c&&(i={textures:{},images:{}});const g={metadata:{version:4.5,type:"Material",generator:"Material.toJSON"}};function _(w){const A=[];for(const R in w){const z=w[R];delete z.metadata,A.push(z)}return A}if(g.uuid=this.uuid,g.type=this.type,this.name!==""&&(g.name=this.name),this.color&&this.color.isColor&&(g.color=this.color.getHex()),this.roughness!==void 0&&(g.roughness=this.roughness),this.metalness!==void 0&&(g.metalness=this.metalness),this.sheenTint&&this.sheenTint.isColor&&(g.sheenTint=this.sheenTint.getHex()),this.emissive&&this.emissive.isColor&&(g.emissive=this.emissive.getHex()),this.emissiveIntensity&&this.emissiveIntensity!==1&&(g.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(g.specular=this.specular.getHex()),this.specularIntensity!==void 0&&(g.specularIntensity=this.specularIntensity),this.specularTint&&this.specularTint.isColor&&(g.specularTint=this.specularTint.getHex()),this.shininess!==void 0&&(g.shininess=this.shininess),this.clearcoat!==void 0&&(g.clearcoat=this.clearcoat),this.clearcoatRoughness!==void 0&&(g.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(g.clearcoatMap=this.clearcoatMap.toJSON(i).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(g.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(i).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(g.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(i).uuid,g.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),this.map&&this.map.isTexture&&(g.map=this.map.toJSON(i).uuid),this.matcap&&this.matcap.isTexture&&(g.matcap=this.matcap.toJSON(i).uuid),this.alphaMap&&this.alphaMap.isTexture&&(g.alphaMap=this.alphaMap.toJSON(i).uuid),this.lightMap&&this.lightMap.isTexture&&(g.lightMap=this.lightMap.toJSON(i).uuid,g.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(g.aoMap=this.aoMap.toJSON(i).uuid,g.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(g.bumpMap=this.bumpMap.toJSON(i).uuid,g.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(g.normalMap=this.normalMap.toJSON(i).uuid,g.normalMapType=this.normalMapType,g.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(g.displacementMap=this.displacementMap.toJSON(i).uuid,g.displacementScale=this.displacementScale,g.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(g.roughnessMap=this.roughnessMap.toJSON(i).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(g.metalnessMap=this.metalnessMap.toJSON(i).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(g.emissiveMap=this.emissiveMap.toJSON(i).uuid),this.specularMap&&this.specularMap.isTexture&&(g.specularMap=this.specularMap.toJSON(i).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(g.specularIntensityMap=this.specularIntensityMap.toJSON(i).uuid),this.specularTintMap&&this.specularTintMap.isTexture&&(g.specularTintMap=this.specularTintMap.toJSON(i).uuid),this.envMap&&this.envMap.isTexture&&(g.envMap=this.envMap.toJSON(i).uuid,this.combine!==void 0&&(g.combine=this.combine)),this.envMapIntensity!==void 0&&(g.envMapIntensity=this.envMapIntensity),this.reflectivity!==void 0&&(g.reflectivity=this.reflectivity),this.refractionRatio!==void 0&&(g.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(g.gradientMap=this.gradientMap.toJSON(i).uuid),this.transmission!==void 0&&(g.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(g.transmissionMap=this.transmissionMap.toJSON(i).uuid),this.thickness!==void 0&&(g.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(g.thicknessMap=this.thicknessMap.toJSON(i).uuid),this.attenuationDistance!==void 0&&(g.attenuationDistance=this.attenuationDistance),this.attenuationTint!==void 0&&(g.attenuationTint=this.attenuationTint.getHex()),this.size!==void 0&&(g.size=this.size),this.shadowSide!==null&&(g.shadowSide=this.shadowSide),this.sizeAttenuation!==void 0&&(g.sizeAttenuation=this.sizeAttenuation),this.blending!==1&&(g.blending=this.blending),this.side!==0&&(g.side=this.side),this.vertexColors&&(g.vertexColors=!0),this.opacity<1&&(g.opacity=this.opacity),this.format!==1023&&(g.format=this.format),this.transparent===!0&&(g.transparent=this.transparent),g.depthFunc=this.depthFunc,g.depthTest=this.depthTest,g.depthWrite=this.depthWrite,g.colorWrite=this.colorWrite,g.stencilWrite=this.stencilWrite,g.stencilWriteMask=this.stencilWriteMask,g.stencilFunc=this.stencilFunc,g.stencilRef=this.stencilRef,g.stencilFuncMask=this.stencilFuncMask,g.stencilFail=this.stencilFail,g.stencilZFail=this.stencilZFail,g.stencilZPass=this.stencilZPass,this.rotation&&this.rotation!==0&&(g.rotation=this.rotation),this.polygonOffset===!0&&(g.polygonOffset=!0),this.polygonOffsetFactor!==0&&(g.polygonOffsetFactor=this.polygonOffsetFactor),this.polygonOffsetUnits!==0&&(g.polygonOffsetUnits=this.polygonOffsetUnits),this.linewidth&&this.linewidth!==1&&(g.linewidth=this.linewidth),this.dashSize!==void 0&&(g.dashSize=this.dashSize),this.gapSize!==void 0&&(g.gapSize=this.gapSize),this.scale!==void 0&&(g.scale=this.scale),this.dithering===!0&&(g.dithering=!0),this.alphaTest>0&&(g.alphaTest=this.alphaTest),this.alphaToCoverage===!0&&(g.alphaToCoverage=this.alphaToCoverage),this.premultipliedAlpha===!0&&(g.premultipliedAlpha=this.premultipliedAlpha),this.wireframe===!0&&(g.wireframe=this.wireframe),this.wireframeLinewidth>1&&(g.wireframeLinewidth=this.wireframeLinewidth),this.wireframeLinecap!=="round"&&(g.wireframeLinecap=this.wireframeLinecap),this.wireframeLinejoin!=="round"&&(g.wireframeLinejoin=this.wireframeLinejoin),this.flatShading===!0&&(g.flatShading=this.flatShading),this.visible===!1&&(g.visible=!1),this.toneMapped===!1&&(g.toneMapped=!1),JSON.stringify(this.userData)!=="{}"&&(g.userData=this.userData),c){const w=_(i.textures),A=_(i.images);w.length>0&&(g.textures=w),A.length>0&&(g.images=A)}return g}clone(){return new this.constructor().copy(this)}copy(i){this.name=i.name,this.fog=i.fog,this.blending=i.blending,this.side=i.side,this.vertexColors=i.vertexColors,this.opacity=i.opacity,this.format=i.format,this.transparent=i.transparent,this.blendSrc=i.blendSrc,this.blendDst=i.blendDst,this.blendEquation=i.blendEquation,this.blendSrcAlpha=i.blendSrcAlpha,this.blendDstAlpha=i.blendDstAlpha,this.blendEquationAlpha=i.blendEquationAlpha,this.depthFunc=i.depthFunc,this.depthTest=i.depthTest,this.depthWrite=i.depthWrite,this.stencilWriteMask=i.stencilWriteMask,this.stencilFunc=i.stencilFunc,this.stencilRef=i.stencilRef,this.stencilFuncMask=i.stencilFuncMask,this.stencilFail=i.stencilFail,this.stencilZFail=i.stencilZFail,this.stencilZPass=i.stencilZPass,this.stencilWrite=i.stencilWrite;const c=i.clippingPlanes;let g=null;if(c!==null){const _=c.length;g=new Array(_);for(let w=0;w!==_;++w)g[w]=c[w].clone()}return this.clippingPlanes=g,this.clipIntersection=i.clipIntersection,this.clipShadows=i.clipShadows,this.shadowSide=i.shadowSide,this.colorWrite=i.colorWrite,this.precision=i.precision,this.polygonOffset=i.polygonOffset,this.polygonOffsetFactor=i.polygonOffsetFactor,this.polygonOffsetUnits=i.polygonOffsetUnits,this.dithering=i.dithering,this.alphaTest=i.alphaTest,this.alphaToCoverage=i.alphaToCoverage,this.premultipliedAlpha=i.premultipliedAlpha,this.visible=i.visible,this.toneMapped=i.toneMapped,this.userData=JSON.parse(JSON.stringify(i.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(i){i===!0&&this.version++}}Bi.prototype.isMaterial=!0;const Nn={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},Kt={h:0,s:0,l:0},xr={h:0,s:0,l:0};function gr(M,i,c){return c<0&&(c+=1),c>1&&(c-=1),c<1/6?M+6*(i-M)*c:c<.5?i:c<2/3?M+6*(i-M)*(2/3-c):M}function Pn(M){return M<.04045?.0773993808*M:Math.pow(.9478672986*M+.0521327014,2.4)}function _r(M){return M<.0031308?12.92*M:1.055*Math.pow(M,.41666)-.055}class un{constructor(i,c,g){return c===void 0&&g===void 0?this.set(i):this.setRGB(i,c,g)}set(i){return i&&i.isColor?this.copy(i):typeof i=="number"?this.setHex(i):typeof i=="string"&&this.setStyle(i),this}setScalar(i){return this.r=i,this.g=i,this.b=i,this}setHex(i){return i=Math.floor(i),this.r=(i>>16&255)/255,this.g=(i>>8&255)/255,this.b=(255&i)/255,this}setRGB(i,c,g){return this.r=i,this.g=c,this.b=g,this}setHSL(i,c,g){if(i=Dn(i,1),c=Jn(c,0,1),g=Jn(g,0,1),c===0)this.r=this.g=this.b=g;else{const _=g<=.5?g*(1+c):g+c-g*c,w=2*g-_;this.r=gr(w,_,i+1/3),this.g=gr(w,_,i),this.b=gr(w,_,i-1/3)}return this}setStyle(i){function c(_){_!==void 0&&parseFloat(_)<1&&console.warn("THREE.Color: Alpha component of "+i+" will be ignored.")}let g;if(g=/^((?:rgb|hsl)a?)\(([^\)]*)\)/.exec(i)){let _;const w=g[1],A=g[2];switch(w){case"rgb":case"rgba":if(_=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(A))return this.r=Math.min(255,parseInt(_[1],10))/255,this.g=Math.min(255,parseInt(_[2],10))/255,this.b=Math.min(255,parseInt(_[3],10))/255,c(_[4]),this;if(_=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(A))return this.r=Math.min(100,parseInt(_[1],10))/100,this.g=Math.min(100,parseInt(_[2],10))/100,this.b=Math.min(100,parseInt(_[3],10))/100,c(_[4]),this;break;case"hsl":case"hsla":if(_=/^\s*(\d*\.?\d+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(A)){const R=parseFloat(_[1])/360,z=parseInt(_[2],10)/100,F=parseInt(_[3],10)/100;return c(_[4]),this.setHSL(R,z,F)}}}else if(g=/^\#([A-Fa-f\d]+)$/.exec(i)){const _=g[1],w=_.length;if(w===3)return this.r=parseInt(_.charAt(0)+_.charAt(0),16)/255,this.g=parseInt(_.charAt(1)+_.charAt(1),16)/255,this.b=parseInt(_.charAt(2)+_.charAt(2),16)/255,this;if(w===6)return this.r=parseInt(_.charAt(0)+_.charAt(1),16)/255,this.g=parseInt(_.charAt(2)+_.charAt(3),16)/255,this.b=parseInt(_.charAt(4)+_.charAt(5),16)/255,this}return i&&i.length>0?this.setColorName(i):this}setColorName(i){const c=Nn[i.toLowerCase()];return c!==void 0?this.setHex(c):console.warn("THREE.Color: Unknown color "+i),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(i){return this.r=i.r,this.g=i.g,this.b=i.b,this}copyGammaToLinear(i,c=2){return this.r=Math.pow(i.r,c),this.g=Math.pow(i.g,c),this.b=Math.pow(i.b,c),this}copyLinearToGamma(i,c=2){const g=c>0?1/c:1;return this.r=Math.pow(i.r,g),this.g=Math.pow(i.g,g),this.b=Math.pow(i.b,g),this}convertGammaToLinear(i){return this.copyGammaToLinear(this,i),this}convertLinearToGamma(i){return this.copyLinearToGamma(this,i),this}copySRGBToLinear(i){return this.r=Pn(i.r),this.g=Pn(i.g),this.b=Pn(i.b),this}copyLinearToSRGB(i){return this.r=_r(i.r),this.g=_r(i.g),this.b=_r(i.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0}getHexString(){return("000000"+this.getHex().toString(16)).slice(-6)}getHSL(i){const c=this.r,g=this.g,_=this.b,w=Math.max(c,g,_),A=Math.min(c,g,_);let R,z;const F=(A+w)/2;if(A===w)R=0,z=0;else{const W=w-A;switch(z=F<=.5?W/(w+A):W/(2-w-A),w){case c:R=(g-_)/W+(g<_?6:0);break;case g:R=(_-c)/W+2;break;case _:R=(c-g)/W+4}R/=6}return i.h=R,i.s=z,i.l=F,i}getStyle(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"}offsetHSL(i,c,g){return this.getHSL(Kt),Kt.h+=i,Kt.s+=c,Kt.l+=g,this.setHSL(Kt.h,Kt.s,Kt.l),this}add(i){return this.r+=i.r,this.g+=i.g,this.b+=i.b,this}addColors(i,c){return this.r=i.r+c.r,this.g=i.g+c.g,this.b=i.b+c.b,this}addScalar(i){return this.r+=i,this.g+=i,this.b+=i,this}sub(i){return this.r=Math.max(0,this.r-i.r),this.g=Math.max(0,this.g-i.g),this.b=Math.max(0,this.b-i.b),this}multiply(i){return this.r*=i.r,this.g*=i.g,this.b*=i.b,this}multiplyScalar(i){return this.r*=i,this.g*=i,this.b*=i,this}lerp(i,c){return this.r+=(i.r-this.r)*c,this.g+=(i.g-this.g)*c,this.b+=(i.b-this.b)*c,this}lerpColors(i,c,g){return this.r=i.r+(c.r-i.r)*g,this.g=i.g+(c.g-i.g)*g,this.b=i.b+(c.b-i.b)*g,this}lerpHSL(i,c){this.getHSL(Kt),i.getHSL(xr);const g=ar(Kt.h,xr.h,c),_=ar(Kt.s,xr.s,c),w=ar(Kt.l,xr.l,c);return this.setHSL(g,_,w),this}equals(i){return i.r===this.r&&i.g===this.g&&i.b===this.b}fromArray(i,c=0){return this.r=i[c],this.g=i[c+1],this.b=i[c+2],this}toArray(i=[],c=0){return i[c]=this.r,i[c+1]=this.g,i[c+2]=this.b,i}fromBufferAttribute(i,c){return this.r=i.getX(c),this.g=i.getY(c),this.b=i.getZ(c),i.normalized===!0&&(this.r/=255,this.g/=255,this.b/=255),this}toJSON(){return this.getHex()}}un.NAMES=Nn,un.prototype.isColor=!0,un.prototype.r=1,un.prototype.g=1,un.prototype.b=1;class fs extends Bi{constructor(i){super(),this.type="MeshBasicMaterial",this.color=new un(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.setValues(i)}copy(i){return super.copy(i),this.color.copy(i.color),this.map=i.map,this.lightMap=i.lightMap,this.lightMapIntensity=i.lightMapIntensity,this.aoMap=i.aoMap,this.aoMapIntensity=i.aoMapIntensity,this.specularMap=i.specularMap,this.alphaMap=i.alphaMap,this.envMap=i.envMap,this.combine=i.combine,this.reflectivity=i.reflectivity,this.refractionRatio=i.refractionRatio,this.wireframe=i.wireframe,this.wireframeLinewidth=i.wireframeLinewidth,this.wireframeLinecap=i.wireframeLinecap,this.wireframeLinejoin=i.wireframeLinejoin,this}}fs.prototype.isMeshBasicMaterial=!0;const yr=new et,Ks=new Ri;class pn{constructor(i,c,g){if(Array.isArray(i))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.name="",this.array=i,this.itemSize=c,this.count=i!==void 0?i.length/c:0,this.normalized=g===!0,this.usage=35044,this.updateRange={offset:0,count:-1},this.version=0}onUploadCallback(){}set needsUpdate(i){i===!0&&this.version++}setUsage(i){return this.usage=i,this}copy(i){return this.name=i.name,this.array=new i.array.constructor(i.array),this.itemSize=i.itemSize,this.count=i.count,this.normalized=i.normalized,this.usage=i.usage,this}copyAt(i,c,g){i*=this.itemSize,g*=c.itemSize;for(let _=0,w=this.itemSize;_<w;_++)this.array[i+_]=c.array[g+_];return this}copyArray(i){return this.array.set(i),this}copyColorsArray(i){const c=this.array;let g=0;for(let _=0,w=i.length;_<w;_++){let A=i[_];A===void 0&&(console.warn("THREE.BufferAttribute.copyColorsArray(): color is undefined",_),A=new un),c[g++]=A.r,c[g++]=A.g,c[g++]=A.b}return this}copyVector2sArray(i){const c=this.array;let g=0;for(let _=0,w=i.length;_<w;_++){let A=i[_];A===void 0&&(console.warn("THREE.BufferAttribute.copyVector2sArray(): vector is undefined",_),A=new Ri),c[g++]=A.x,c[g++]=A.y}return this}copyVector3sArray(i){const c=this.array;let g=0;for(let _=0,w=i.length;_<w;_++){let A=i[_];A===void 0&&(console.warn("THREE.BufferAttribute.copyVector3sArray(): vector is undefined",_),A=new et),c[g++]=A.x,c[g++]=A.y,c[g++]=A.z}return this}copyVector4sArray(i){const c=this.array;let g=0;for(let _=0,w=i.length;_<w;_++){let A=i[_];A===void 0&&(console.warn("THREE.BufferAttribute.copyVector4sArray(): vector is undefined",_),A=new Mr),c[g++]=A.x,c[g++]=A.y,c[g++]=A.z,c[g++]=A.w}return this}applyMatrix3(i){if(this.itemSize===2)for(let c=0,g=this.count;c<g;c++)Ks.fromBufferAttribute(this,c),Ks.applyMatrix3(i),this.setXY(c,Ks.x,Ks.y);else if(this.itemSize===3)for(let c=0,g=this.count;c<g;c++)yr.fromBufferAttribute(this,c),yr.applyMatrix3(i),this.setXYZ(c,yr.x,yr.y,yr.z);return this}applyMatrix4(i){for(let c=0,g=this.count;c<g;c++)yr.x=this.getX(c),yr.y=this.getY(c),yr.z=this.getZ(c),yr.applyMatrix4(i),this.setXYZ(c,yr.x,yr.y,yr.z);return this}applyNormalMatrix(i){for(let c=0,g=this.count;c<g;c++)yr.x=this.getX(c),yr.y=this.getY(c),yr.z=this.getZ(c),yr.applyNormalMatrix(i),this.setXYZ(c,yr.x,yr.y,yr.z);return this}transformDirection(i){for(let c=0,g=this.count;c<g;c++)yr.x=this.getX(c),yr.y=this.getY(c),yr.z=this.getZ(c),yr.transformDirection(i),this.setXYZ(c,yr.x,yr.y,yr.z);return this}set(i,c=0){return this.array.set(i,c),this}getX(i){return this.array[i*this.itemSize]}setX(i,c){return this.array[i*this.itemSize]=c,this}getY(i){return this.array[i*this.itemSize+1]}setY(i,c){return this.array[i*this.itemSize+1]=c,this}getZ(i){return this.array[i*this.itemSize+2]}setZ(i,c){return this.array[i*this.itemSize+2]=c,this}getW(i){return this.array[i*this.itemSize+3]}setW(i,c){return this.array[i*this.itemSize+3]=c,this}setXY(i,c,g){return i*=this.itemSize,this.array[i+0]=c,this.array[i+1]=g,this}setXYZ(i,c,g,_){return i*=this.itemSize,this.array[i+0]=c,this.array[i+1]=g,this.array[i+2]=_,this}setXYZW(i,c,g,_,w){return i*=this.itemSize,this.array[i+0]=c,this.array[i+1]=g,this.array[i+2]=_,this.array[i+3]=w,this}onUpload(i){return this.onUploadCallback=i,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const i={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.prototype.slice.call(this.array),normalized:this.normalized};return this.name!==""&&(i.name=this.name),this.usage!==35044&&(i.usage=this.usage),this.updateRange.offset===0&&this.updateRange.count===-1||(i.updateRange=this.updateRange),i}}pn.prototype.isBufferAttribute=!0;class Mo extends pn{constructor(i,c,g){super(new Int8Array(i),c,g)}}class To extends pn{constructor(i,c,g){super(new Uint8Array(i),c,g)}}class Ds extends pn{constructor(i,c,g){super(new Uint8ClampedArray(i),c,g)}}class ua extends pn{constructor(i,c,g){super(new Int16Array(i),c,g)}}class Ls extends pn{constructor(i,c,g){super(new Uint16Array(i),c,g)}}class Do extends pn{constructor(i,c,g){super(new Int32Array(i),c,g)}}class Xs extends pn{constructor(i,c,g){super(new Uint32Array(i),c,g)}}class Sl extends pn{constructor(i,c,g){super(new Uint16Array(i),c,g)}}Sl.prototype.isFloat16BufferAttribute=!0;class Kn extends pn{constructor(i,c,g){super(new Float32Array(i),c,g)}}class Ja extends pn{constructor(i,c,g){super(new Float64Array(i),c,g)}}function vc(M){if(M.length===0)return-1/0;let i=M[0];for(let c=1,g=M.length;c<g;++c)M[c]>i&&(i=M[c]);return i}const El={Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array};function qo(M,i){return new El[M](i)}let nh=0;const po=new Mn,Eu=new we,Is=new et,gs=new ps,Ka=new ps,ws=new et;class Er extends si{constructor(){super(),Object.defineProperty(this,"id",{value:nh++}),this.uuid=Yn(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(i){return Array.isArray(i)?this.index=new(vc(i)>65535?Xs:Ls)(i,1):this.index=i,this}getAttribute(i){return this.attributes[i]}setAttribute(i,c){return this.attributes[i]=c,this}deleteAttribute(i){return delete this.attributes[i],this}hasAttribute(i){return this.attributes[i]!==void 0}addGroup(i,c,g=0){this.groups.push({start:i,count:c,materialIndex:g})}clearGroups(){this.groups=[]}setDrawRange(i,c){this.drawRange.start=i,this.drawRange.count=c}applyMatrix4(i){const c=this.attributes.position;c!==void 0&&(c.applyMatrix4(i),c.needsUpdate=!0);const g=this.attributes.normal;if(g!==void 0){const w=new jr().getNormalMatrix(i);g.applyNormalMatrix(w),g.needsUpdate=!0}const _=this.attributes.tangent;return _!==void 0&&(_.transformDirection(i),_.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}applyQuaternion(i){return po.makeRotationFromQuaternion(i),this.applyMatrix4(po),this}rotateX(i){return po.makeRotationX(i),this.applyMatrix4(po),this}rotateY(i){return po.makeRotationY(i),this.applyMatrix4(po),this}rotateZ(i){return po.makeRotationZ(i),this.applyMatrix4(po),this}translate(i,c,g){return po.makeTranslation(i,c,g),this.applyMatrix4(po),this}scale(i,c,g){return po.makeScale(i,c,g),this.applyMatrix4(po),this}lookAt(i){return Eu.lookAt(i),Eu.updateMatrix(),this.applyMatrix4(Eu.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(Is).negate(),this.translate(Is.x,Is.y,Is.z),this}setFromPoints(i){const c=[];for(let g=0,_=i.length;g<_;g++){const w=i[g];c.push(w.x,w.y,w.z||0)}return this.setAttribute("position",new Kn(c,3)),this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new ps);const i=this.attributes.position,c=this.morphAttributes.position;if(i&&i.isGLBufferAttribute)return console.error('THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box. Alternatively set "mesh.frustumCulled" to "false".',this),void this.boundingBox.set(new et(-1/0,-1/0,-1/0),new et(1/0,1/0,1/0));if(i!==void 0){if(this.boundingBox.setFromBufferAttribute(i),c)for(let g=0,_=c.length;g<_;g++){const w=c[g];gs.setFromBufferAttribute(w),this.morphTargetsRelative?(ws.addVectors(this.boundingBox.min,gs.min),this.boundingBox.expandByPoint(ws),ws.addVectors(this.boundingBox.max,gs.max),this.boundingBox.expandByPoint(ws)):(this.boundingBox.expandByPoint(gs.min),this.boundingBox.expandByPoint(gs.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new Bn);const i=this.attributes.position,c=this.morphAttributes.position;if(i&&i.isGLBufferAttribute)return console.error('THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere. Alternatively set "mesh.frustumCulled" to "false".',this),void this.boundingSphere.set(new et,1/0);if(i){const g=this.boundingSphere.center;if(gs.setFromBufferAttribute(i),c)for(let w=0,A=c.length;w<A;w++){const R=c[w];Ka.setFromBufferAttribute(R),this.morphTargetsRelative?(ws.addVectors(gs.min,Ka.min),gs.expandByPoint(ws),ws.addVectors(gs.max,Ka.max),gs.expandByPoint(ws)):(gs.expandByPoint(Ka.min),gs.expandByPoint(Ka.max))}gs.getCenter(g);let _=0;for(let w=0,A=i.count;w<A;w++)ws.fromBufferAttribute(i,w),_=Math.max(_,g.distanceToSquared(ws));if(c)for(let w=0,A=c.length;w<A;w++){const R=c[w],z=this.morphTargetsRelative;for(let F=0,W=R.count;F<W;F++)ws.fromBufferAttribute(R,F),z&&(Is.fromBufferAttribute(i,F),ws.add(Is)),_=Math.max(_,g.distanceToSquared(ws))}this.boundingSphere.radius=Math.sqrt(_),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){const i=this.index,c=this.attributes;if(i===null||c.position===void 0||c.normal===void 0||c.uv===void 0)return void console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");const g=i.array,_=c.position.array,w=c.normal.array,A=c.uv.array,R=_.length/3;c.tangent===void 0&&this.setAttribute("tangent",new pn(new Float32Array(4*R),4));const z=c.tangent.array,F=[],W=[];for(let Xt=0;Xt<R;Xt++)F[Xt]=new et,W[Xt]=new et;const q=new et,J=new et,K=new et,re=new Ri,ce=new Ri,Me=new Ri,de=new et,Xe=new et;function nt(Xt,xi,In){q.fromArray(_,3*Xt),J.fromArray(_,3*xi),K.fromArray(_,3*In),re.fromArray(A,2*Xt),ce.fromArray(A,2*xi),Me.fromArray(A,2*In),J.sub(q),K.sub(q),ce.sub(re),Me.sub(re);const gn=1/(ce.x*Me.y-Me.x*ce.y);isFinite(gn)&&(de.copy(J).multiplyScalar(Me.y).addScaledVector(K,-ce.y).multiplyScalar(gn),Xe.copy(K).multiplyScalar(ce.x).addScaledVector(J,-Me.x).multiplyScalar(gn),F[Xt].add(de),F[xi].add(de),F[In].add(de),W[Xt].add(Xe),W[xi].add(Xe),W[In].add(Xe))}let Je=this.groups;Je.length===0&&(Je=[{start:0,count:g.length}]);for(let Xt=0,xi=Je.length;Xt<xi;++Xt){const In=Je[Xt],gn=In.start;for(let Vi=gn,vn=gn+In.count;Vi<vn;Vi+=3)nt(g[Vi+0],g[Vi+1],g[Vi+2])}const gt=new et,Tt=new et,Zt=new et,ei=new et;function vi(Xt){Zt.fromArray(w,3*Xt),ei.copy(Zt);const xi=F[Xt];gt.copy(xi),gt.sub(Zt.multiplyScalar(Zt.dot(xi))).normalize(),Tt.crossVectors(ei,xi);const In=Tt.dot(W[Xt])<0?-1:1;z[4*Xt]=gt.x,z[4*Xt+1]=gt.y,z[4*Xt+2]=gt.z,z[4*Xt+3]=In}for(let Xt=0,xi=Je.length;Xt<xi;++Xt){const In=Je[Xt],gn=In.start;for(let Vi=gn,vn=gn+In.count;Vi<vn;Vi+=3)vi(g[Vi+0]),vi(g[Vi+1]),vi(g[Vi+2])}}computeVertexNormals(){const i=this.index,c=this.getAttribute("position");if(c!==void 0){let g=this.getAttribute("normal");if(g===void 0)g=new pn(new Float32Array(3*c.count),3),this.setAttribute("normal",g);else for(let J=0,K=g.count;J<K;J++)g.setXYZ(J,0,0,0);const _=new et,w=new et,A=new et,R=new et,z=new et,F=new et,W=new et,q=new et;if(i)for(let J=0,K=i.count;J<K;J+=3){const re=i.getX(J+0),ce=i.getX(J+1),Me=i.getX(J+2);_.fromBufferAttribute(c,re),w.fromBufferAttribute(c,ce),A.fromBufferAttribute(c,Me),W.subVectors(A,w),q.subVectors(_,w),W.cross(q),R.fromBufferAttribute(g,re),z.fromBufferAttribute(g,ce),F.fromBufferAttribute(g,Me),R.add(W),z.add(W),F.add(W),g.setXYZ(re,R.x,R.y,R.z),g.setXYZ(ce,z.x,z.y,z.z),g.setXYZ(Me,F.x,F.y,F.z)}else for(let J=0,K=c.count;J<K;J+=3)_.fromBufferAttribute(c,J+0),w.fromBufferAttribute(c,J+1),A.fromBufferAttribute(c,J+2),W.subVectors(A,w),q.subVectors(_,w),W.cross(q),g.setXYZ(J+0,W.x,W.y,W.z),g.setXYZ(J+1,W.x,W.y,W.z),g.setXYZ(J+2,W.x,W.y,W.z);this.normalizeNormals(),g.needsUpdate=!0}}merge(i,c){if(!i||!i.isBufferGeometry)return void console.error("THREE.BufferGeometry.merge(): geometry not an instance of THREE.BufferGeometry.",i);c===void 0&&(c=0,console.warn("THREE.BufferGeometry.merge(): Overwriting original geometry, starting at offset=0. Use BufferGeometryUtils.mergeBufferGeometries() for lossless merge."));const g=this.attributes;for(const _ in g){if(i.attributes[_]===void 0)continue;const w=g[_].array,A=i.attributes[_],R=A.array,z=A.itemSize*c,F=Math.min(R.length,w.length-z);for(let W=0,q=z;W<F;W++,q++)w[q]=R[W]}return this}normalizeNormals(){const i=this.attributes.normal;for(let c=0,g=i.count;c<g;c++)ws.fromBufferAttribute(i,c),ws.normalize(),i.setXYZ(c,ws.x,ws.y,ws.z)}toNonIndexed(){function i(R,z){const F=R.array,W=R.itemSize,q=R.normalized,J=new F.constructor(z.length*W);let K=0,re=0;for(let ce=0,Me=z.length;ce<Me;ce++){K=R.isInterleavedBufferAttribute?z[ce]*R.data.stride+R.offset:z[ce]*W;for(let de=0;de<W;de++)J[re++]=F[K++]}return new pn(J,W,q)}if(this.index===null)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const c=new Er,g=this.index.array,_=this.attributes;for(const R in _){const z=i(_[R],g);c.setAttribute(R,z)}const w=this.morphAttributes;for(const R in w){const z=[],F=w[R];for(let W=0,q=F.length;W<q;W++){const J=i(F[W],g);z.push(J)}c.morphAttributes[R]=z}c.morphTargetsRelative=this.morphTargetsRelative;const A=this.groups;for(let R=0,z=A.length;R<z;R++){const F=A[R];c.addGroup(F.start,F.count,F.materialIndex)}return c}toJSON(){const i={metadata:{version:4.5,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(i.uuid=this.uuid,i.type=this.type,this.name!==""&&(i.name=this.name),Object.keys(this.userData).length>0&&(i.userData=this.userData),this.parameters!==void 0){const z=this.parameters;for(const F in z)z[F]!==void 0&&(i[F]=z[F]);return i}i.data={attributes:{}};const c=this.index;c!==null&&(i.data.index={type:c.array.constructor.name,array:Array.prototype.slice.call(c.array)});const g=this.attributes;for(const z in g){const F=g[z];i.data.attributes[z]=F.toJSON(i.data)}const _={};let w=!1;for(const z in this.morphAttributes){const F=this.morphAttributes[z],W=[];for(let q=0,J=F.length;q<J;q++){const K=F[q];W.push(K.toJSON(i.data))}W.length>0&&(_[z]=W,w=!0)}w&&(i.data.morphAttributes=_,i.data.morphTargetsRelative=this.morphTargetsRelative);const A=this.groups;A.length>0&&(i.data.groups=JSON.parse(JSON.stringify(A)));const R=this.boundingSphere;return R!==null&&(i.data.boundingSphere={center:R.center.toArray(),radius:R.radius}),i}clone(){return new Er().copy(this)}copy(i){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const c={};this.name=i.name;const g=i.index;g!==null&&this.setIndex(g.clone(c));const _=i.attributes;for(const F in _){const W=_[F];this.setAttribute(F,W.clone(c))}const w=i.morphAttributes;for(const F in w){const W=[],q=w[F];for(let J=0,K=q.length;J<K;J++)W.push(q[J].clone(c));this.morphAttributes[F]=W}this.morphTargetsRelative=i.morphTargetsRelative;const A=i.groups;for(let F=0,W=A.length;F<W;F++){const q=A[F];this.addGroup(q.start,q.count,q.materialIndex)}const R=i.boundingBox;R!==null&&(this.boundingBox=R.clone());const z=i.boundingSphere;return z!==null&&(this.boundingSphere=z.clone()),this.drawRange.start=i.drawRange.start,this.drawRange.count=i.drawRange.count,this.userData=i.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}Er.prototype.isBufferGeometry=!0;const Td=new Mn,bc=new br,Jl=new Bn,Qa=new et,wa=new et,da=new et,wc=new et,Al=new et,Au=new et,Mc=new et,Cu=new et,rh=new et,sh=new Ri,Kl=new Ri,oh=new Ri,mo=new et,Lu=new et;class oo extends we{constructor(i=new Er,c=new fs){super(),this.type="Mesh",this.geometry=i,this.material=c,this.updateMorphTargets()}copy(i){return super.copy(i),i.morphTargetInfluences!==void 0&&(this.morphTargetInfluences=i.morphTargetInfluences.slice()),i.morphTargetDictionary!==void 0&&(this.morphTargetDictionary=Object.assign({},i.morphTargetDictionary)),this.material=i.material,this.geometry=i.geometry,this}updateMorphTargets(){const i=this.geometry;if(i.isBufferGeometry){const c=i.morphAttributes,g=Object.keys(c);if(g.length>0){const _=c[g[0]];if(_!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let w=0,A=_.length;w<A;w++){const R=_[w].name||String(w);this.morphTargetInfluences.push(0),this.morphTargetDictionary[R]=w}}}}else{const c=i.morphTargets;c!==void 0&&c.length>0&&console.error("THREE.Mesh.updateMorphTargets() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}}raycast(i,c){const g=this.geometry,_=this.material,w=this.matrixWorld;if(_===void 0||(g.boundingSphere===null&&g.computeBoundingSphere(),Jl.copy(g.boundingSphere),Jl.applyMatrix4(w),i.ray.intersectsSphere(Jl)===!1)||(Td.copy(w).invert(),bc.copy(i.ray).applyMatrix4(Td),g.boundingBox!==null&&bc.intersectsBox(g.boundingBox)===!1))return;let A;if(g.isBufferGeometry){const R=g.index,z=g.attributes.position,F=g.morphAttributes.position,W=g.morphTargetsRelative,q=g.attributes.uv,J=g.attributes.uv2,K=g.groups,re=g.drawRange;if(R!==null)if(Array.isArray(_))for(let ce=0,Me=K.length;ce<Me;ce++){const de=K[ce],Xe=_[de.materialIndex];for(let nt=Math.max(de.start,re.start),Je=Math.min(de.start+de.count,re.start+re.count);nt<Je;nt+=3){const gt=R.getX(nt),Tt=R.getX(nt+1),Zt=R.getX(nt+2);A=Vh(this,Xe,i,bc,z,F,W,q,J,gt,Tt,Zt),A&&(A.faceIndex=Math.floor(nt/3),A.face.materialIndex=de.materialIndex,c.push(A))}}else for(let ce=Math.max(0,re.start),Me=Math.min(R.count,re.start+re.count);ce<Me;ce+=3){const de=R.getX(ce),Xe=R.getX(ce+1),nt=R.getX(ce+2);A=Vh(this,_,i,bc,z,F,W,q,J,de,Xe,nt),A&&(A.faceIndex=Math.floor(ce/3),c.push(A))}else if(z!==void 0)if(Array.isArray(_))for(let ce=0,Me=K.length;ce<Me;ce++){const de=K[ce],Xe=_[de.materialIndex];for(let nt=Math.max(de.start,re.start),Je=Math.min(de.start+de.count,re.start+re.count);nt<Je;nt+=3)A=Vh(this,Xe,i,bc,z,F,W,q,J,nt,nt+1,nt+2),A&&(A.faceIndex=Math.floor(nt/3),A.face.materialIndex=de.materialIndex,c.push(A))}else for(let ce=Math.max(0,re.start),Me=Math.min(z.count,re.start+re.count);ce<Me;ce+=3)A=Vh(this,_,i,bc,z,F,W,q,J,ce,ce+1,ce+2),A&&(A.faceIndex=Math.floor(ce/3),c.push(A))}else g.isGeometry&&console.error("THREE.Mesh.raycast() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}}function Vh(M,i,c,g,_,w,A,R,z,F,W,q){Qa.fromBufferAttribute(_,F),wa.fromBufferAttribute(_,W),da.fromBufferAttribute(_,q);const J=M.morphTargetInfluences;if(w&&J){Mc.set(0,0,0),Cu.set(0,0,0),rh.set(0,0,0);for(let re=0,ce=w.length;re<ce;re++){const Me=J[re],de=w[re];Me!==0&&(wc.fromBufferAttribute(de,F),Al.fromBufferAttribute(de,W),Au.fromBufferAttribute(de,q),A?(Mc.addScaledVector(wc,Me),Cu.addScaledVector(Al,Me),rh.addScaledVector(Au,Me)):(Mc.addScaledVector(wc.sub(Qa),Me),Cu.addScaledVector(Al.sub(wa),Me),rh.addScaledVector(Au.sub(da),Me)))}Qa.add(Mc),wa.add(Cu),da.add(rh)}M.isSkinnedMesh&&(M.boneTransform(F,Qa),M.boneTransform(W,wa),M.boneTransform(q,da));const K=function(re,ce,Me,de,Xe,nt,Je,gt){let Tt;if(Tt=ce.side===1?de.intersectTriangle(Je,nt,Xe,!0,gt):de.intersectTriangle(Xe,nt,Je,ce.side!==2,gt),Tt===null)return null;Lu.copy(gt),Lu.applyMatrix4(re.matrixWorld);const Zt=Me.ray.origin.distanceTo(Lu);return Zt<Me.near||Zt>Me.far?null:{distance:Zt,point:Lu.clone(),object:re}}(M,i,c,g,Qa,wa,da,mo);if(K){R&&(sh.fromBufferAttribute(R,F),Kl.fromBufferAttribute(R,W),oh.fromBufferAttribute(R,q),K.uv=Zi.getUV(mo,Qa,wa,da,sh,Kl,oh,new Ri)),z&&(sh.fromBufferAttribute(z,F),Kl.fromBufferAttribute(z,W),oh.fromBufferAttribute(z,q),K.uv2=Zi.getUV(mo,Qa,wa,da,sh,Kl,oh,new Ri));const re={a:F,b:W,c:q,normal:new et,materialIndex:0};Zi.getNormal(Qa,wa,da,re.normal),K.face=re}return K}oo.prototype.isMesh=!0;class el extends Er{constructor(i=1,c=1,g=1,_=1,w=1,A=1){super(),this.type="BoxGeometry",this.parameters={width:i,height:c,depth:g,widthSegments:_,heightSegments:w,depthSegments:A};const R=this;_=Math.floor(_),w=Math.floor(w),A=Math.floor(A);const z=[],F=[],W=[],q=[];let J=0,K=0;function re(ce,Me,de,Xe,nt,Je,gt,Tt,Zt,ei,vi){const Xt=Je/Zt,xi=gt/ei,In=Je/2,gn=gt/2,Vi=Tt/2,vn=Zt+1,$n=ei+1;let tr=0,mr=0;const Ar=new et;for(let hr=0;hr<$n;hr++){const mn=hr*xi-gn;for(let wt=0;wt<vn;wt++){const Dt=wt*Xt-In;Ar[ce]=Dt*Xe,Ar[Me]=mn*nt,Ar[de]=Vi,F.push(Ar.x,Ar.y,Ar.z),Ar[ce]=0,Ar[Me]=0,Ar[de]=Tt>0?1:-1,W.push(Ar.x,Ar.y,Ar.z),q.push(wt/Zt),q.push(1-hr/ei),tr+=1}}for(let hr=0;hr<ei;hr++)for(let mn=0;mn<Zt;mn++){const wt=J+mn+vn*hr,Dt=J+mn+vn*(hr+1),Xi=J+(mn+1)+vn*(hr+1),Li=J+(mn+1)+vn*hr;z.push(wt,Dt,Li),z.push(Dt,Xi,Li),mr+=6}R.addGroup(K,mr,vi),K+=mr,J+=tr}re("z","y","x",-1,-1,g,c,i,A,w,0),re("z","y","x",1,-1,g,c,-i,A,w,1),re("x","z","y",1,1,i,g,c,_,A,2),re("x","z","y",1,-1,i,g,-c,_,A,3),re("x","y","z",1,-1,i,c,g,_,w,4),re("x","y","z",-1,-1,i,c,-g,_,w,5),this.setIndex(z),this.setAttribute("position",new Kn(F,3)),this.setAttribute("normal",new Kn(W,3)),this.setAttribute("uv",new Kn(q,2))}static fromJSON(i){return new el(i.width,i.height,i.depth,i.widthSegments,i.heightSegments,i.depthSegments)}}function ah(M){const i={};for(const c in M){i[c]={};for(const g in M[c]){const _=M[c][g];_&&(_.isColor||_.isMatrix3||_.isMatrix4||_.isVector2||_.isVector3||_.isVector4||_.isTexture||_.isQuaternion)?i[c][g]=_.clone():Array.isArray(_)?i[c][g]=_.slice():i[c][g]=_}}return i}function $s(M){const i={};for(let c=0;c<M.length;c++){const g=ah(M[c]);for(const _ in g)i[_]=g[_]}return i}const Iu={clone:ah,merge:$s};class tl extends Bi{constructor(i){super(),this.type="ShaderMaterial",this.defines={},this.uniforms={},this.vertexShader=`void main() {
	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
}`,this.fragmentShader=`void main() {
	gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );
}`,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,i!==void 0&&(i.attributes!==void 0&&console.error("THREE.ShaderMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(i))}copy(i){return super.copy(i),this.fragmentShader=i.fragmentShader,this.vertexShader=i.vertexShader,this.uniforms=ah(i.uniforms),this.defines=Object.assign({},i.defines),this.wireframe=i.wireframe,this.wireframeLinewidth=i.wireframeLinewidth,this.lights=i.lights,this.clipping=i.clipping,this.extensions=Object.assign({},i.extensions),this.glslVersion=i.glslVersion,this}toJSON(i){const c=super.toJSON(i);c.glslVersion=this.glslVersion,c.uniforms={};for(const _ in this.uniforms){const w=this.uniforms[_].value;w&&w.isTexture?c.uniforms[_]={type:"t",value:w.toJSON(i).uuid}:w&&w.isColor?c.uniforms[_]={type:"c",value:w.getHex()}:w&&w.isVector2?c.uniforms[_]={type:"v2",value:w.toArray()}:w&&w.isVector3?c.uniforms[_]={type:"v3",value:w.toArray()}:w&&w.isVector4?c.uniforms[_]={type:"v4",value:w.toArray()}:w&&w.isMatrix3?c.uniforms[_]={type:"m3",value:w.toArray()}:w&&w.isMatrix4?c.uniforms[_]={type:"m4",value:w.toArray()}:c.uniforms[_]={value:w}}Object.keys(this.defines).length>0&&(c.defines=this.defines),c.vertexShader=this.vertexShader,c.fragmentShader=this.fragmentShader;const g={};for(const _ in this.extensions)this.extensions[_]===!0&&(g[_]=!0);return Object.keys(g).length>0&&(c.extensions=g),c}}tl.prototype.isShaderMaterial=!0;class Ql extends we{constructor(){super(),this.type="Camera",this.matrixWorldInverse=new Mn,this.projectionMatrix=new Mn,this.projectionMatrixInverse=new Mn}copy(i,c){return super.copy(i,c),this.matrixWorldInverse.copy(i.matrixWorldInverse),this.projectionMatrix.copy(i.projectionMatrix),this.projectionMatrixInverse.copy(i.projectionMatrixInverse),this}getWorldDirection(i){this.updateWorldMatrix(!0,!1);const c=this.matrixWorld.elements;return i.set(-c[8],-c[9],-c[10]).normalize()}updateMatrixWorld(i){super.updateMatrixWorld(i),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(i,c){super.updateWorldMatrix(i,c),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return new this.constructor().copy(this)}}Ql.prototype.isCamera=!0;class go extends Ql{constructor(i=50,c=1,g=.1,_=2e3){super(),this.type="PerspectiveCamera",this.fov=i,this.zoom=1,this.near=g,this.far=_,this.focus=10,this.aspect=c,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(i,c){return super.copy(i,c),this.fov=i.fov,this.zoom=i.zoom,this.near=i.near,this.far=i.far,this.focus=i.focus,this.aspect=i.aspect,this.view=i.view===null?null:Object.assign({},i.view),this.filmGauge=i.filmGauge,this.filmOffset=i.filmOffset,this}setFocalLength(i){const c=.5*this.getFilmHeight()/i;this.fov=2*Gn*Math.atan(c),this.updateProjectionMatrix()}getFocalLength(){const i=Math.tan(.5*kn*this.fov);return .5*this.getFilmHeight()/i}getEffectiveFOV(){return 2*Gn*Math.atan(Math.tan(.5*kn*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}setViewOffset(i,c,g,_,w,A){this.aspect=i/c,this.view===null&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=i,this.view.fullHeight=c,this.view.offsetX=g,this.view.offsetY=_,this.view.width=w,this.view.height=A,this.updateProjectionMatrix()}clearViewOffset(){this.view!==null&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const i=this.near;let c=i*Math.tan(.5*kn*this.fov)/this.zoom,g=2*c,_=this.aspect*g,w=-.5*_;const A=this.view;if(this.view!==null&&this.view.enabled){const z=A.fullWidth,F=A.fullHeight;w+=A.offsetX*_/z,c-=A.offsetY*g/F,_*=A.width/z,g*=A.height/F}const R=this.filmOffset;R!==0&&(w+=i*R/this.getFilmWidth()),this.projectionMatrix.makePerspective(w,w+_,c,c-g,i,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(i){const c=super.toJSON(i);return c.object.fov=this.fov,c.object.zoom=this.zoom,c.object.near=this.near,c.object.far=this.far,c.object.focus=this.focus,c.object.aspect=this.aspect,this.view!==null&&(c.object.view=Object.assign({},this.view)),c.object.filmGauge=this.filmGauge,c.object.filmOffset=this.filmOffset,c}}go.prototype.isPerspectiveCamera=!0;const Cl=90;class Tc extends we{constructor(i,c,g){if(super(),this.type="CubeCamera",g.isWebGLCubeRenderTarget!==!0)return void console.error("THREE.CubeCamera: The constructor now expects an instance of WebGLCubeRenderTarget as third parameter.");this.renderTarget=g;const _=new go(Cl,1,i,c);_.layers=this.layers,_.up.set(0,-1,0),_.lookAt(new et(1,0,0)),this.add(_);const w=new go(Cl,1,i,c);w.layers=this.layers,w.up.set(0,-1,0),w.lookAt(new et(-1,0,0)),this.add(w);const A=new go(Cl,1,i,c);A.layers=this.layers,A.up.set(0,0,1),A.lookAt(new et(0,1,0)),this.add(A);const R=new go(Cl,1,i,c);R.layers=this.layers,R.up.set(0,0,-1),R.lookAt(new et(0,-1,0)),this.add(R);const z=new go(Cl,1,i,c);z.layers=this.layers,z.up.set(0,-1,0),z.lookAt(new et(0,0,1)),this.add(z);const F=new go(Cl,1,i,c);F.layers=this.layers,F.up.set(0,-1,0),F.lookAt(new et(0,0,-1)),this.add(F)}update(i,c){this.parent===null&&this.updateMatrixWorld();const g=this.renderTarget,[_,w,A,R,z,F]=this.children,W=i.xr.enabled,q=i.getRenderTarget();i.xr.enabled=!1;const J=g.texture.generateMipmaps;g.texture.generateMipmaps=!1,i.setRenderTarget(g,0),i.render(c,_),i.setRenderTarget(g,1),i.render(c,w),i.setRenderTarget(g,2),i.render(c,A),i.setRenderTarget(g,3),i.render(c,R),i.setRenderTarget(g,4),i.render(c,z),g.texture.generateMipmaps=J,i.setRenderTarget(g,5),i.render(c,F),i.setRenderTarget(q),i.xr.enabled=W}}class il extends ds{constructor(i,c,g,_,w,A,R,z,F,W){super(i=i!==void 0?i:[],c=c!==void 0?c:301,g,_,w,A,R=R!==void 0?R:1022,z,F,W),this.flipY=!1}get images(){return this.image}set images(i){this.image=i}}il.prototype.isCubeTexture=!0;class lh extends Bs{constructor(i,c,g){Number.isInteger(c)&&(console.warn("THREE.WebGLCubeRenderTarget: constructor signature is now WebGLCubeRenderTarget( size, options )"),c=g),super(i,i,c),c=c||{},this.texture=new il(void 0,c.mapping,c.wrapS,c.wrapT,c.magFilter,c.minFilter,c.format,c.type,c.anisotropy,c.encoding),this.texture.isRenderTargetTexture=!0,this.texture.generateMipmaps=c.generateMipmaps!==void 0&&c.generateMipmaps,this.texture.minFilter=c.minFilter!==void 0?c.minFilter:1006,this.texture._needsFlipEnvMap=!1}fromEquirectangularTexture(i,c){this.texture.type=c.type,this.texture.format=1023,this.texture.encoding=c.encoding,this.texture.generateMipmaps=c.generateMipmaps,this.texture.minFilter=c.minFilter,this.texture.magFilter=c.magFilter;const g={uniforms:{tEquirect:{value:null}},vertexShader:`

				varying vec3 vWorldDirection;

				vec3 transformDirection( in vec3 dir, in mat4 matrix ) {

					return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );

				}

				void main() {

					vWorldDirection = transformDirection( position, modelMatrix );

					#include <begin_vertex>
					#include <project_vertex>

				}
			`,fragmentShader:`

				uniform sampler2D tEquirect;

				varying vec3 vWorldDirection;

				#include <common>

				void main() {

					vec3 direction = normalize( vWorldDirection );

					vec2 sampleUV = equirectUv( direction );

					gl_FragColor = texture2D( tEquirect, sampleUV );

				}
			`},_=new el(5,5,5),w=new tl({name:"CubemapFromEquirect",uniforms:ah(g.uniforms),vertexShader:g.vertexShader,fragmentShader:g.fragmentShader,side:1,blending:0});w.uniforms.tEquirect.value=c;const A=new oo(_,w),R=c.minFilter;return c.minFilter===1008&&(c.minFilter=1006),new Tc(1,10,this).update(i,A),c.minFilter=R,A.geometry.dispose(),A.material.dispose(),this}clear(i,c,g,_){const w=i.getRenderTarget();for(let A=0;A<6;A++)i.setRenderTarget(this,A),i.clear(c,g,_);i.setRenderTarget(w)}}lh.prototype.isWebGLCubeRenderTarget=!0;const Pu=new et,Hf=new et,jf=new jr;class Ma{constructor(i=new et(1,0,0),c=0){this.normal=i,this.constant=c}set(i,c){return this.normal.copy(i),this.constant=c,this}setComponents(i,c,g,_){return this.normal.set(i,c,g),this.constant=_,this}setFromNormalAndCoplanarPoint(i,c){return this.normal.copy(i),this.constant=-c.dot(this.normal),this}setFromCoplanarPoints(i,c,g){const _=Pu.subVectors(g,c).cross(Hf.subVectors(i,c)).normalize();return this.setFromNormalAndCoplanarPoint(_,i),this}copy(i){return this.normal.copy(i.normal),this.constant=i.constant,this}normalize(){const i=1/this.normal.length();return this.normal.multiplyScalar(i),this.constant*=i,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(i){return this.normal.dot(i)+this.constant}distanceToSphere(i){return this.distanceToPoint(i.center)-i.radius}projectPoint(i,c){return c.copy(this.normal).multiplyScalar(-this.distanceToPoint(i)).add(i)}intersectLine(i,c){const g=i.delta(Pu),_=this.normal.dot(g);if(_===0)return this.distanceToPoint(i.start)===0?c.copy(i.start):null;const w=-(i.start.dot(this.normal)+this.constant)/_;return w<0||w>1?null:c.copy(g).multiplyScalar(w).add(i.start)}intersectsLine(i){const c=this.distanceToPoint(i.start),g=this.distanceToPoint(i.end);return c<0&&g>0||g<0&&c>0}intersectsBox(i){return i.intersectsPlane(this)}intersectsSphere(i){return i.intersectsPlane(this)}coplanarPoint(i){return i.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(i,c){const g=c||jf.getNormalMatrix(i),_=this.coplanarPoint(Pu).applyMatrix4(i),w=this.normal.applyMatrix3(g).normalize();return this.constant=-_.dot(w),this}translate(i){return this.constant-=i.dot(this.normal),this}equals(i){return i.normal.equals(this.normal)&&i.constant===this.constant}clone(){return new this.constructor().copy(this)}}Ma.prototype.isPlane=!0;const ec=new Bn,Gh=new et;class tc{constructor(i=new Ma,c=new Ma,g=new Ma,_=new Ma,w=new Ma,A=new Ma){this.planes=[i,c,g,_,w,A]}set(i,c,g,_,w,A){const R=this.planes;return R[0].copy(i),R[1].copy(c),R[2].copy(g),R[3].copy(_),R[4].copy(w),R[5].copy(A),this}copy(i){const c=this.planes;for(let g=0;g<6;g++)c[g].copy(i.planes[g]);return this}setFromProjectionMatrix(i){const c=this.planes,g=i.elements,_=g[0],w=g[1],A=g[2],R=g[3],z=g[4],F=g[5],W=g[6],q=g[7],J=g[8],K=g[9],re=g[10],ce=g[11],Me=g[12],de=g[13],Xe=g[14],nt=g[15];return c[0].setComponents(R-_,q-z,ce-J,nt-Me).normalize(),c[1].setComponents(R+_,q+z,ce+J,nt+Me).normalize(),c[2].setComponents(R+w,q+F,ce+K,nt+de).normalize(),c[3].setComponents(R-w,q-F,ce-K,nt-de).normalize(),c[4].setComponents(R-A,q-W,ce-re,nt-Xe).normalize(),c[5].setComponents(R+A,q+W,ce+re,nt+Xe).normalize(),this}intersectsObject(i){const c=i.geometry;return c.boundingSphere===null&&c.computeBoundingSphere(),ec.copy(c.boundingSphere).applyMatrix4(i.matrixWorld),this.intersectsSphere(ec)}intersectsSprite(i){return ec.center.set(0,0,0),ec.radius=.7071067811865476,ec.applyMatrix4(i.matrixWorld),this.intersectsSphere(ec)}intersectsSphere(i){const c=this.planes,g=i.center,_=-i.radius;for(let w=0;w<6;w++)if(c[w].distanceToPoint(g)<_)return!1;return!0}intersectsBox(i){const c=this.planes;for(let g=0;g<6;g++){const _=c[g];if(Gh.x=_.normal.x>0?i.max.x:i.min.x,Gh.y=_.normal.y>0?i.max.y:i.min.y,Gh.z=_.normal.z>0?i.max.z:i.min.z,_.distanceToPoint(Gh)<0)return!1}return!0}containsPoint(i){const c=this.planes;for(let g=0;g<6;g++)if(c[g].distanceToPoint(i)<0)return!1;return!0}clone(){return new this.constructor().copy(this)}}function ic(){let M=null,i=!1,c=null,g=null;function _(w,A){c(w,A),g=M.requestAnimationFrame(_)}return{start:function(){i!==!0&&c!==null&&(g=M.requestAnimationFrame(_),i=!0)},stop:function(){M.cancelAnimationFrame(g),i=!1},setAnimationLoop:function(w){c=w},setContext:function(w){M=w}}}function Wf(M,i){const c=i.isWebGL2,g=new WeakMap;return{get:function(_){return _.isInterleavedBufferAttribute&&(_=_.data),g.get(_)},remove:function(_){_.isInterleavedBufferAttribute&&(_=_.data);const w=g.get(_);w&&(M.deleteBuffer(w.buffer),g.delete(_))},update:function(_,w){if(_.isGLBufferAttribute){const R=g.get(_);return void((!R||R.version<_.version)&&g.set(_,{buffer:_.buffer,type:_.type,bytesPerElement:_.elementSize,version:_.version}))}_.isInterleavedBufferAttribute&&(_=_.data);const A=g.get(_);A===void 0?g.set(_,function(R,z){const F=R.array,W=R.usage,q=M.createBuffer();M.bindBuffer(z,q),M.bufferData(z,F,W),R.onUploadCallback();let J=5126;return F instanceof Float32Array?J=5126:F instanceof Float64Array?console.warn("THREE.WebGLAttributes: Unsupported data buffer format: Float64Array."):F instanceof Uint16Array?R.isFloat16BufferAttribute?c?J=5131:console.warn("THREE.WebGLAttributes: Usage of Float16BufferAttribute requires WebGL2."):J=5123:F instanceof Int16Array?J=5122:F instanceof Uint32Array?J=5125:F instanceof Int32Array?J=5124:F instanceof Int8Array?J=5120:(F instanceof Uint8Array||F instanceof Uint8ClampedArray)&&(J=5121),{buffer:q,type:J,bytesPerElement:F.BYTES_PER_ELEMENT,version:R.version}}(_,w)):A.version<_.version&&(function(R,z,F){const W=z.array,q=z.updateRange;M.bindBuffer(F,R),q.count===-1?M.bufferSubData(F,0,W):(c?M.bufferSubData(F,q.offset*W.BYTES_PER_ELEMENT,W,q.offset,q.count):M.bufferSubData(F,q.offset*W.BYTES_PER_ELEMENT,W.subarray(q.offset,q.offset+q.count)),q.count=-1)}(A.buffer,_,w),A.version=_.version)}}}class nc extends Er{constructor(i=1,c=1,g=1,_=1){super(),this.type="PlaneGeometry",this.parameters={width:i,height:c,widthSegments:g,heightSegments:_};const w=i/2,A=c/2,R=Math.floor(g),z=Math.floor(_),F=R+1,W=z+1,q=i/R,J=c/z,K=[],re=[],ce=[],Me=[];for(let de=0;de<W;de++){const Xe=de*J-A;for(let nt=0;nt<F;nt++){const Je=nt*q-w;re.push(Je,-Xe,0),ce.push(0,0,1),Me.push(nt/R),Me.push(1-de/z)}}for(let de=0;de<z;de++)for(let Xe=0;Xe<R;Xe++){const nt=Xe+F*de,Je=Xe+F*(de+1),gt=Xe+1+F*(de+1),Tt=Xe+1+F*de;K.push(nt,Je,Tt),K.push(Je,gt,Tt)}this.setIndex(K),this.setAttribute("position",new Kn(re,3)),this.setAttribute("normal",new Kn(ce,3)),this.setAttribute("uv",new Kn(Me,2))}static fromJSON(i){return new nc(i.width,i.height,i.widthSegments,i.heightSegments)}}const es={alphamap_fragment:`#ifdef USE_ALPHAMAP
	diffuseColor.a *= texture2D( alphaMap, vUv ).g;
#endif`,alphamap_pars_fragment:`#ifdef USE_ALPHAMAP
	uniform sampler2D alphaMap;
#endif`,alphatest_fragment:`#ifdef USE_ALPHATEST
	if ( diffuseColor.a < alphaTest ) discard;
#endif`,alphatest_pars_fragment:`#ifdef USE_ALPHATEST
	uniform float alphaTest;
#endif`,aomap_fragment:`#ifdef USE_AOMAP
	float ambientOcclusion = ( texture2D( aoMap, vUv2 ).r - 1.0 ) * aoMapIntensity + 1.0;
	reflectedLight.indirectDiffuse *= ambientOcclusion;
	#if defined( USE_ENVMAP ) && defined( STANDARD )
		float dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );
		reflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.roughness );
	#endif
#endif`,aomap_pars_fragment:`#ifdef USE_AOMAP
	uniform sampler2D aoMap;
	uniform float aoMapIntensity;
#endif`,begin_vertex:"vec3 transformed = vec3( position );",beginnormal_vertex:`vec3 objectNormal = vec3( normal );
#ifdef USE_TANGENT
	vec3 objectTangent = vec3( tangent.xyz );
#endif`,bsdfs:`vec3 BRDF_Lambert( const in vec3 diffuseColor ) {
	return RECIPROCAL_PI * diffuseColor;
}
vec3 F_Schlick( const in vec3 f0, const in float f90, const in float dotVH ) {
	float fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );
	return f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );
}
float V_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {
	float a2 = pow2( alpha );
	float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );
	float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );
	return 0.5 / max( gv + gl, EPSILON );
}
float D_GGX( const in float alpha, const in float dotNH ) {
	float a2 = pow2( alpha );
	float denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;
	return RECIPROCAL_PI * a2 / pow2( denom );
}
vec3 BRDF_GGX( const in IncidentLight incidentLight, const in vec3 viewDir, const in vec3 normal, const in vec3 f0, const in float f90, const in float roughness ) {
	float alpha = pow2( roughness );
	vec3 halfDir = normalize( incidentLight.direction + viewDir );
	float dotNL = saturate( dot( normal, incidentLight.direction ) );
	float dotNV = saturate( dot( normal, viewDir ) );
	float dotNH = saturate( dot( normal, halfDir ) );
	float dotVH = saturate( dot( viewDir, halfDir ) );
	vec3 F = F_Schlick( f0, f90, dotVH );
	float V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );
	float D = D_GGX( alpha, dotNH );
	return F * ( V * D );
}
vec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {
	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;
	float dotNV = saturate( dot( N, V ) );
	vec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );
	uv = uv * LUT_SCALE + LUT_BIAS;
	return uv;
}
float LTC_ClippedSphereFormFactor( const in vec3 f ) {
	float l = length( f );
	return max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );
}
vec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {
	float x = dot( v1, v2 );
	float y = abs( x );
	float a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;
	float b = 3.4175940 + ( 4.1616724 + y ) * y;
	float v = a / b;
	float theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;
	return cross( v1, v2 ) * theta_sintheta;
}
vec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {
	vec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];
	vec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];
	vec3 lightNormal = cross( v1, v2 );
	if( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );
	vec3 T1, T2;
	T1 = normalize( V - N * dot( V, N ) );
	T2 = - cross( N, T1 );
	mat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );
	vec3 coords[ 4 ];
	coords[ 0 ] = mat * ( rectCoords[ 0 ] - P );
	coords[ 1 ] = mat * ( rectCoords[ 1 ] - P );
	coords[ 2 ] = mat * ( rectCoords[ 2 ] - P );
	coords[ 3 ] = mat * ( rectCoords[ 3 ] - P );
	coords[ 0 ] = normalize( coords[ 0 ] );
	coords[ 1 ] = normalize( coords[ 1 ] );
	coords[ 2 ] = normalize( coords[ 2 ] );
	coords[ 3 ] = normalize( coords[ 3 ] );
	vec3 vectorFormFactor = vec3( 0.0 );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );
	float result = LTC_ClippedSphereFormFactor( vectorFormFactor );
	return vec3( result );
}
float G_BlinnPhong_Implicit( ) {
	return 0.25;
}
float D_BlinnPhong( const in float shininess, const in float dotNH ) {
	return RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );
}
vec3 BRDF_BlinnPhong( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {
	vec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );
	float dotNH = saturate( dot( geometry.normal, halfDir ) );
	float dotVH = saturate( dot( geometry.viewDir, halfDir ) );
	vec3 F = F_Schlick( specularColor, 1.0, dotVH );
	float G = G_BlinnPhong_Implicit( );
	float D = D_BlinnPhong( shininess, dotNH );
	return F * ( G * D );
}
#if defined( USE_SHEEN )
float D_Charlie( float roughness, float NoH ) {
	float invAlpha = 1.0 / roughness;
	float cos2h = NoH * NoH;
	float sin2h = max( 1.0 - cos2h, 0.0078125 );
	return ( 2.0 + invAlpha ) * pow( sin2h, invAlpha * 0.5 ) / ( 2.0 * PI );
}
float V_Neubelt( float NoV, float NoL ) {
	return saturate( 1.0 / ( 4.0 * ( NoL + NoV - NoL * NoV ) ) );
}
vec3 BRDF_Sheen( const in float roughness, const in vec3 L, const in GeometricContext geometry, vec3 specularColor ) {
	vec3 N = geometry.normal;
	vec3 V = geometry.viewDir;
	vec3 H = normalize( V + L );
	float dotNH = saturate( dot( N, H ) );
	return specularColor * D_Charlie( roughness, dotNH ) * V_Neubelt( dot(N, V), dot(N, L) );
}
#endif`,bumpmap_pars_fragment:`#ifdef USE_BUMPMAP
	uniform sampler2D bumpMap;
	uniform float bumpScale;
	vec2 dHdxy_fwd() {
		vec2 dSTdx = dFdx( vUv );
		vec2 dSTdy = dFdy( vUv );
		float Hll = bumpScale * texture2D( bumpMap, vUv ).x;
		float dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;
		float dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;
		return vec2( dBx, dBy );
	}
	vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {
		vec3 vSigmaX = vec3( dFdx( surf_pos.x ), dFdx( surf_pos.y ), dFdx( surf_pos.z ) );
		vec3 vSigmaY = vec3( dFdy( surf_pos.x ), dFdy( surf_pos.y ), dFdy( surf_pos.z ) );
		vec3 vN = surf_norm;
		vec3 R1 = cross( vSigmaY, vN );
		vec3 R2 = cross( vN, vSigmaX );
		float fDet = dot( vSigmaX, R1 ) * faceDirection;
		vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );
		return normalize( abs( fDet ) * surf_norm - vGrad );
	}
#endif`,clipping_planes_fragment:`#if NUM_CLIPPING_PLANES > 0
	vec4 plane;
	#pragma unroll_loop_start
	for ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {
		plane = clippingPlanes[ i ];
		if ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;
	}
	#pragma unroll_loop_end
	#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES
		bool clipped = true;
		#pragma unroll_loop_start
		for ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {
			plane = clippingPlanes[ i ];
			clipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;
		}
		#pragma unroll_loop_end
		if ( clipped ) discard;
	#endif
#endif`,clipping_planes_pars_fragment:`#if NUM_CLIPPING_PLANES > 0
	varying vec3 vClipPosition;
	uniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];
#endif`,clipping_planes_pars_vertex:`#if NUM_CLIPPING_PLANES > 0
	varying vec3 vClipPosition;
#endif`,clipping_planes_vertex:`#if NUM_CLIPPING_PLANES > 0
	vClipPosition = - mvPosition.xyz;
#endif`,color_fragment:`#if defined( USE_COLOR_ALPHA )
	diffuseColor *= vColor;
#elif defined( USE_COLOR )
	diffuseColor.rgb *= vColor;
#endif`,color_pars_fragment:`#if defined( USE_COLOR_ALPHA )
	varying vec4 vColor;
#elif defined( USE_COLOR )
	varying vec3 vColor;
#endif`,color_pars_vertex:`#if defined( USE_COLOR_ALPHA )
	varying vec4 vColor;
#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )
	varying vec3 vColor;
#endif`,color_vertex:`#if defined( USE_COLOR_ALPHA )
	vColor = vec4( 1.0 );
#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )
	vColor = vec3( 1.0 );
#endif
#ifdef USE_COLOR
	vColor *= color;
#endif
#ifdef USE_INSTANCING_COLOR
	vColor.xyz *= instanceColor.xyz;
#endif`,common:`#define PI 3.141592653589793
#define PI2 6.283185307179586
#define PI_HALF 1.5707963267948966
#define RECIPROCAL_PI 0.3183098861837907
#define RECIPROCAL_PI2 0.15915494309189535
#define EPSILON 1e-6
#ifndef saturate
#define saturate( a ) clamp( a, 0.0, 1.0 )
#endif
#define whiteComplement( a ) ( 1.0 - saturate( a ) )
float pow2( const in float x ) { return x*x; }
float pow3( const in float x ) { return x*x*x; }
float pow4( const in float x ) { float x2 = x*x; return x2*x2; }
float max3( const in vec3 v ) { return max( max( v.x, v.y ), v.z ); }
float average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }
highp float rand( const in vec2 uv ) {
	const highp float a = 12.9898, b = 78.233, c = 43758.5453;
	highp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );
	return fract( sin( sn ) * c );
}
#ifdef HIGH_PRECISION
	float precisionSafeLength( vec3 v ) { return length( v ); }
#else
	float precisionSafeLength( vec3 v ) {
		float maxComponent = max3( abs( v ) );
		return length( v / maxComponent ) * maxComponent;
	}
#endif
struct IncidentLight {
	vec3 color;
	vec3 direction;
	bool visible;
};
struct ReflectedLight {
	vec3 directDiffuse;
	vec3 directSpecular;
	vec3 indirectDiffuse;
	vec3 indirectSpecular;
};
struct GeometricContext {
	vec3 position;
	vec3 normal;
	vec3 viewDir;
#ifdef USE_CLEARCOAT
	vec3 clearcoatNormal;
#endif
};
vec3 transformDirection( in vec3 dir, in mat4 matrix ) {
	return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );
}
vec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {
	return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );
}
mat3 transposeMat3( const in mat3 m ) {
	mat3 tmp;
	tmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );
	tmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );
	tmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );
	return tmp;
}
float linearToRelativeLuminance( const in vec3 color ) {
	vec3 weights = vec3( 0.2126, 0.7152, 0.0722 );
	return dot( weights, color.rgb );
}
bool isPerspectiveMatrix( mat4 m ) {
	return m[ 2 ][ 3 ] == - 1.0;
}
vec2 equirectUv( in vec3 dir ) {
	float u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;
	float v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;
	return vec2( u, v );
}`,cube_uv_reflection_fragment:`#ifdef ENVMAP_TYPE_CUBE_UV
	#define cubeUV_maxMipLevel 8.0
	#define cubeUV_minMipLevel 4.0
	#define cubeUV_maxTileSize 256.0
	#define cubeUV_minTileSize 16.0
	float getFace( vec3 direction ) {
		vec3 absDirection = abs( direction );
		float face = - 1.0;
		if ( absDirection.x > absDirection.z ) {
			if ( absDirection.x > absDirection.y )
				face = direction.x > 0.0 ? 0.0 : 3.0;
			else
				face = direction.y > 0.0 ? 1.0 : 4.0;
		} else {
			if ( absDirection.z > absDirection.y )
				face = direction.z > 0.0 ? 2.0 : 5.0;
			else
				face = direction.y > 0.0 ? 1.0 : 4.0;
		}
		return face;
	}
	vec2 getUV( vec3 direction, float face ) {
		vec2 uv;
		if ( face == 0.0 ) {
			uv = vec2( direction.z, direction.y ) / abs( direction.x );
		} else if ( face == 1.0 ) {
			uv = vec2( - direction.x, - direction.z ) / abs( direction.y );
		} else if ( face == 2.0 ) {
			uv = vec2( - direction.x, direction.y ) / abs( direction.z );
		} else if ( face == 3.0 ) {
			uv = vec2( - direction.z, direction.y ) / abs( direction.x );
		} else if ( face == 4.0 ) {
			uv = vec2( - direction.x, direction.z ) / abs( direction.y );
		} else {
			uv = vec2( direction.x, direction.y ) / abs( direction.z );
		}
		return 0.5 * ( uv + 1.0 );
	}
	vec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {
		float face = getFace( direction );
		float filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );
		mipInt = max( mipInt, cubeUV_minMipLevel );
		float faceSize = exp2( mipInt );
		float texelSize = 1.0 / ( 3.0 * cubeUV_maxTileSize );
		vec2 uv = getUV( direction, face ) * ( faceSize - 1.0 );
		vec2 f = fract( uv );
		uv += 0.5 - f;
		if ( face > 2.0 ) {
			uv.y += faceSize;
			face -= 3.0;
		}
		uv.x += face * faceSize;
		if ( mipInt < cubeUV_maxMipLevel ) {
			uv.y += 2.0 * cubeUV_maxTileSize;
		}
		uv.y += filterInt * 2.0 * cubeUV_minTileSize;
		uv.x += 3.0 * max( 0.0, cubeUV_maxTileSize - 2.0 * faceSize );
		uv *= texelSize;
		vec3 tl = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;
		uv.x += texelSize;
		vec3 tr = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;
		uv.y += texelSize;
		vec3 br = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;
		uv.x -= texelSize;
		vec3 bl = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;
		vec3 tm = mix( tl, tr, f.x );
		vec3 bm = mix( bl, br, f.x );
		return mix( tm, bm, f.y );
	}
	#define r0 1.0
	#define v0 0.339
	#define m0 - 2.0
	#define r1 0.8
	#define v1 0.276
	#define m1 - 1.0
	#define r4 0.4
	#define v4 0.046
	#define m4 2.0
	#define r5 0.305
	#define v5 0.016
	#define m5 3.0
	#define r6 0.21
	#define v6 0.0038
	#define m6 4.0
	float roughnessToMip( float roughness ) {
		float mip = 0.0;
		if ( roughness >= r1 ) {
			mip = ( r0 - roughness ) * ( m1 - m0 ) / ( r0 - r1 ) + m0;
		} else if ( roughness >= r4 ) {
			mip = ( r1 - roughness ) * ( m4 - m1 ) / ( r1 - r4 ) + m1;
		} else if ( roughness >= r5 ) {
			mip = ( r4 - roughness ) * ( m5 - m4 ) / ( r4 - r5 ) + m4;
		} else if ( roughness >= r6 ) {
			mip = ( r5 - roughness ) * ( m6 - m5 ) / ( r5 - r6 ) + m5;
		} else {
			mip = - 2.0 * log2( 1.16 * roughness );		}
		return mip;
	}
	vec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {
		float mip = clamp( roughnessToMip( roughness ), m0, cubeUV_maxMipLevel );
		float mipF = fract( mip );
		float mipInt = floor( mip );
		vec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );
		if ( mipF == 0.0 ) {
			return vec4( color0, 1.0 );
		} else {
			vec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );
			return vec4( mix( color0, color1, mipF ), 1.0 );
		}
	}
#endif`,defaultnormal_vertex:`vec3 transformedNormal = objectNormal;
#ifdef USE_INSTANCING
	mat3 m = mat3( instanceMatrix );
	transformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );
	transformedNormal = m * transformedNormal;
#endif
transformedNormal = normalMatrix * transformedNormal;
#ifdef FLIP_SIDED
	transformedNormal = - transformedNormal;
#endif
#ifdef USE_TANGENT
	vec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;
	#ifdef FLIP_SIDED
		transformedTangent = - transformedTangent;
	#endif
#endif`,displacementmap_pars_vertex:`#ifdef USE_DISPLACEMENTMAP
	uniform sampler2D displacementMap;
	uniform float displacementScale;
	uniform float displacementBias;
#endif`,displacementmap_vertex:`#ifdef USE_DISPLACEMENTMAP
	transformed += normalize( objectNormal ) * ( texture2D( displacementMap, vUv ).x * displacementScale + displacementBias );
#endif`,emissivemap_fragment:`#ifdef USE_EMISSIVEMAP
	vec4 emissiveColor = texture2D( emissiveMap, vUv );
	emissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;
	totalEmissiveRadiance *= emissiveColor.rgb;
#endif`,emissivemap_pars_fragment:`#ifdef USE_EMISSIVEMAP
	uniform sampler2D emissiveMap;
#endif`,encodings_fragment:"gl_FragColor = linearToOutputTexel( gl_FragColor );",encodings_pars_fragment:`
vec4 LinearToLinear( in vec4 value ) {
	return value;
}
vec4 GammaToLinear( in vec4 value, in float gammaFactor ) {
	return vec4( pow( value.rgb, vec3( gammaFactor ) ), value.a );
}
vec4 LinearToGamma( in vec4 value, in float gammaFactor ) {
	return vec4( pow( value.rgb, vec3( 1.0 / gammaFactor ) ), value.a );
}
vec4 sRGBToLinear( in vec4 value ) {
	return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
}
vec4 LinearTosRGB( in vec4 value ) {
	return vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );
}
vec4 RGBEToLinear( in vec4 value ) {
	return vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );
}
vec4 LinearToRGBE( in vec4 value ) {
	float maxComponent = max( max( value.r, value.g ), value.b );
	float fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );
	return vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );
}
vec4 RGBMToLinear( in vec4 value, in float maxRange ) {
	return vec4( value.rgb * value.a * maxRange, 1.0 );
}
vec4 LinearToRGBM( in vec4 value, in float maxRange ) {
	float maxRGB = max( value.r, max( value.g, value.b ) );
	float M = clamp( maxRGB / maxRange, 0.0, 1.0 );
	M = ceil( M * 255.0 ) / 255.0;
	return vec4( value.rgb / ( M * maxRange ), M );
}
vec4 RGBDToLinear( in vec4 value, in float maxRange ) {
	return vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );
}
vec4 LinearToRGBD( in vec4 value, in float maxRange ) {
	float maxRGB = max( value.r, max( value.g, value.b ) );
	float D = max( maxRange / maxRGB, 1.0 );
	D = clamp( floor( D ) / 255.0, 0.0, 1.0 );
	return vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );
}
const mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );
vec4 LinearToLogLuv( in vec4 value ) {
	vec3 Xp_Y_XYZp = cLogLuvM * value.rgb;
	Xp_Y_XYZp = max( Xp_Y_XYZp, vec3( 1e-6, 1e-6, 1e-6 ) );
	vec4 vResult;
	vResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;
	float Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;
	vResult.w = fract( Le );
	vResult.z = ( Le - ( floor( vResult.w * 255.0 ) ) / 255.0 ) / 255.0;
	return vResult;
}
const mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );
vec4 LogLuvToLinear( in vec4 value ) {
	float Le = value.z * 255.0 + value.w;
	vec3 Xp_Y_XYZp;
	Xp_Y_XYZp.y = exp2( ( Le - 127.0 ) / 2.0 );
	Xp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;
	Xp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;
	vec3 vRGB = cLogLuvInverseM * Xp_Y_XYZp.rgb;
	return vec4( max( vRGB, 0.0 ), 1.0 );
}`,envmap_fragment:`#ifdef USE_ENVMAP
	#ifdef ENV_WORLDPOS
		vec3 cameraToFrag;
		if ( isOrthographic ) {
			cameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );
		} else {
			cameraToFrag = normalize( vWorldPosition - cameraPosition );
		}
		vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
		#ifdef ENVMAP_MODE_REFLECTION
			vec3 reflectVec = reflect( cameraToFrag, worldNormal );
		#else
			vec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );
		#endif
	#else
		vec3 reflectVec = vReflect;
	#endif
	#ifdef ENVMAP_TYPE_CUBE
		vec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );
		envColor = envMapTexelToLinear( envColor );
	#elif defined( ENVMAP_TYPE_CUBE_UV )
		vec4 envColor = textureCubeUV( envMap, reflectVec, 0.0 );
	#else
		vec4 envColor = vec4( 0.0 );
	#endif
	#ifdef ENVMAP_BLENDING_MULTIPLY
		outgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );
	#elif defined( ENVMAP_BLENDING_MIX )
		outgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );
	#elif defined( ENVMAP_BLENDING_ADD )
		outgoingLight += envColor.xyz * specularStrength * reflectivity;
	#endif
#endif`,envmap_common_pars_fragment:`#ifdef USE_ENVMAP
	uniform float envMapIntensity;
	uniform float flipEnvMap;
	uniform int maxMipLevel;
	#ifdef ENVMAP_TYPE_CUBE
		uniform samplerCube envMap;
	#else
		uniform sampler2D envMap;
	#endif
	
#endif`,envmap_pars_fragment:`#ifdef USE_ENVMAP
	uniform float reflectivity;
	#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )
		#define ENV_WORLDPOS
	#endif
	#ifdef ENV_WORLDPOS
		varying vec3 vWorldPosition;
		uniform float refractionRatio;
	#else
		varying vec3 vReflect;
	#endif
#endif`,envmap_pars_vertex:`#ifdef USE_ENVMAP
	#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) ||defined( PHONG )
		#define ENV_WORLDPOS
	#endif
	#ifdef ENV_WORLDPOS
		
		varying vec3 vWorldPosition;
	#else
		varying vec3 vReflect;
		uniform float refractionRatio;
	#endif
#endif`,envmap_physical_pars_fragment:`#if defined( USE_ENVMAP )
	#ifdef ENVMAP_MODE_REFRACTION
		uniform float refractionRatio;
	#endif
	vec3 getIBLIrradiance( const in GeometricContext geometry ) {
		#if defined( ENVMAP_TYPE_CUBE_UV )
			vec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );
			vec4 envMapColor = textureCubeUV( envMap, worldNormal, 1.0 );
			return PI * envMapColor.rgb * envMapIntensity;
		#else
			return vec3( 0.0 );
		#endif
	}
	vec3 getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness ) {
		#if defined( ENVMAP_TYPE_CUBE_UV )
			vec3 reflectVec;
			#ifdef ENVMAP_MODE_REFLECTION
				reflectVec = reflect( - viewDir, normal );
				reflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );
			#else
				reflectVec = refract( - viewDir, normal, refractionRatio );
			#endif
			reflectVec = inverseTransformDirection( reflectVec, viewMatrix );
			vec4 envMapColor = textureCubeUV( envMap, reflectVec, roughness );
			return envMapColor.rgb * envMapIntensity;
		#else
			return vec3( 0.0 );
		#endif
	}
#endif`,envmap_vertex:`#ifdef USE_ENVMAP
	#ifdef ENV_WORLDPOS
		vWorldPosition = worldPosition.xyz;
	#else
		vec3 cameraToVertex;
		if ( isOrthographic ) {
			cameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );
		} else {
			cameraToVertex = normalize( worldPosition.xyz - cameraPosition );
		}
		vec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );
		#ifdef ENVMAP_MODE_REFLECTION
			vReflect = reflect( cameraToVertex, worldNormal );
		#else
			vReflect = refract( cameraToVertex, worldNormal, refractionRatio );
		#endif
	#endif
#endif`,fog_vertex:`#ifdef USE_FOG
	vFogDepth = - mvPosition.z;
#endif`,fog_pars_vertex:`#ifdef USE_FOG
	varying float vFogDepth;
#endif`,fog_fragment:`#ifdef USE_FOG
	#ifdef FOG_EXP2
		float fogFactor = 1.0 - exp( - fogDensity * fogDensity * vFogDepth * vFogDepth );
	#else
		float fogFactor = smoothstep( fogNear, fogFar, vFogDepth );
	#endif
	gl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );
#endif`,fog_pars_fragment:`#ifdef USE_FOG
	uniform vec3 fogColor;
	varying float vFogDepth;
	#ifdef FOG_EXP2
		uniform float fogDensity;
	#else
		uniform float fogNear;
		uniform float fogFar;
	#endif
#endif`,gradientmap_pars_fragment:`#ifdef USE_GRADIENTMAP
	uniform sampler2D gradientMap;
#endif
vec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {
	float dotNL = dot( normal, lightDirection );
	vec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );
	#ifdef USE_GRADIENTMAP
		return texture2D( gradientMap, coord ).rgb;
	#else
		return ( coord.x < 0.7 ) ? vec3( 0.7 ) : vec3( 1.0 );
	#endif
}`,lightmap_fragment:`#ifdef USE_LIGHTMAP
	vec4 lightMapTexel = texture2D( lightMap, vUv2 );
	vec3 lightMapIrradiance = lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;
	#ifndef PHYSICALLY_CORRECT_LIGHTS
		lightMapIrradiance *= PI;
	#endif
	reflectedLight.indirectDiffuse += lightMapIrradiance;
#endif`,lightmap_pars_fragment:`#ifdef USE_LIGHTMAP
	uniform sampler2D lightMap;
	uniform float lightMapIntensity;
#endif`,lights_lambert_vertex:`vec3 diffuse = vec3( 1.0 );
GeometricContext geometry;
geometry.position = mvPosition.xyz;
geometry.normal = normalize( transformedNormal );
geometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( -mvPosition.xyz );
GeometricContext backGeometry;
backGeometry.position = geometry.position;
backGeometry.normal = -geometry.normal;
backGeometry.viewDir = geometry.viewDir;
vLightFront = vec3( 0.0 );
vIndirectFront = vec3( 0.0 );
#ifdef DOUBLE_SIDED
	vLightBack = vec3( 0.0 );
	vIndirectBack = vec3( 0.0 );
#endif
IncidentLight directLight;
float dotNL;
vec3 directLightColor_Diffuse;
vIndirectFront += getAmbientLightIrradiance( ambientLightColor );
vIndirectFront += getLightProbeIrradiance( lightProbe, geometry );
#ifdef DOUBLE_SIDED
	vIndirectBack += getAmbientLightIrradiance( ambientLightColor );
	vIndirectBack += getLightProbeIrradiance( lightProbe, backGeometry );
#endif
#if NUM_POINT_LIGHTS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {
		getPointLightInfo( pointLights[ i ], geometry, directLight );
		dotNL = dot( geometry.normal, directLight.direction );
		directLightColor_Diffuse = directLight.color;
		vLightFront += saturate( dotNL ) * directLightColor_Diffuse;
		#ifdef DOUBLE_SIDED
			vLightBack += saturate( - dotNL ) * directLightColor_Diffuse;
		#endif
	}
	#pragma unroll_loop_end
#endif
#if NUM_SPOT_LIGHTS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {
		getSpotLightInfo( spotLights[ i ], geometry, directLight );
		dotNL = dot( geometry.normal, directLight.direction );
		directLightColor_Diffuse = directLight.color;
		vLightFront += saturate( dotNL ) * directLightColor_Diffuse;
		#ifdef DOUBLE_SIDED
			vLightBack += saturate( - dotNL ) * directLightColor_Diffuse;
		#endif
	}
	#pragma unroll_loop_end
#endif
#if NUM_DIR_LIGHTS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {
		getDirectionalLightInfo( directionalLights[ i ], geometry, directLight );
		dotNL = dot( geometry.normal, directLight.direction );
		directLightColor_Diffuse = directLight.color;
		vLightFront += saturate( dotNL ) * directLightColor_Diffuse;
		#ifdef DOUBLE_SIDED
			vLightBack += saturate( - dotNL ) * directLightColor_Diffuse;
		#endif
	}
	#pragma unroll_loop_end
#endif
#if NUM_HEMI_LIGHTS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {
		vIndirectFront += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );
		#ifdef DOUBLE_SIDED
			vIndirectBack += getHemisphereLightIrradiance( hemisphereLights[ i ], backGeometry );
		#endif
	}
	#pragma unroll_loop_end
#endif`,lights_pars_begin:`uniform bool receiveShadow;
uniform vec3 ambientLightColor;
uniform vec3 lightProbe[ 9 ];
vec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {
	float x = normal.x, y = normal.y, z = normal.z;
	vec3 result = shCoefficients[ 0 ] * 0.886227;
	result += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;
	result += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;
	result += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;
	result += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;
	result += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;
	result += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );
	result += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;
	result += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );
	return result;
}
vec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in GeometricContext geometry ) {
	vec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );
	vec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );
	return irradiance;
}
vec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {
	vec3 irradiance = ambientLightColor;
	return irradiance;
}
float getDistanceAttenuation( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {
	#if defined ( PHYSICALLY_CORRECT_LIGHTS )
		float distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );
		if ( cutoffDistance > 0.0 ) {
			distanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );
		}
		return distanceFalloff;
	#else
		if ( cutoffDistance > 0.0 && decayExponent > 0.0 ) {
			return pow( saturate( - lightDistance / cutoffDistance + 1.0 ), decayExponent );
		}
		return 1.0;
	#endif
}
float getSpotAttenuation( const in float coneCosine, const in float penumbraCosine, const in float angleCosine ) {
	return smoothstep( coneCosine, penumbraCosine, angleCosine );
}
#if NUM_DIR_LIGHTS > 0
	struct DirectionalLight {
		vec3 direction;
		vec3 color;
	};
	uniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];
	void getDirectionalLightInfo( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight light ) {
		light.color = directionalLight.color;
		light.direction = directionalLight.direction;
		light.visible = true;
	}
#endif
#if NUM_POINT_LIGHTS > 0
	struct PointLight {
		vec3 position;
		vec3 color;
		float distance;
		float decay;
	};
	uniform PointLight pointLights[ NUM_POINT_LIGHTS ];
	void getPointLightInfo( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight light ) {
		vec3 lVector = pointLight.position - geometry.position;
		light.direction = normalize( lVector );
		float lightDistance = length( lVector );
		light.color = pointLight.color;
		light.color *= getDistanceAttenuation( lightDistance, pointLight.distance, pointLight.decay );
		light.visible = ( light.color != vec3( 0.0 ) );
	}
#endif
#if NUM_SPOT_LIGHTS > 0
	struct SpotLight {
		vec3 position;
		vec3 direction;
		vec3 color;
		float distance;
		float decay;
		float coneCos;
		float penumbraCos;
	};
	uniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];
	void getSpotLightInfo( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight light ) {
		vec3 lVector = spotLight.position - geometry.position;
		light.direction = normalize( lVector );
		float angleCos = dot( light.direction, spotLight.direction );
		float spotAttenuation = getSpotAttenuation( spotLight.coneCos, spotLight.penumbraCos, angleCos );
		if ( spotAttenuation > 0.0 ) {
			float lightDistance = length( lVector );
			light.color = spotLight.color * spotAttenuation;
			light.color *= getDistanceAttenuation( lightDistance, spotLight.distance, spotLight.decay );
			light.visible = ( light.color != vec3( 0.0 ) );
		} else {
			light.color = vec3( 0.0 );
			light.visible = false;
		}
	}
#endif
#if NUM_RECT_AREA_LIGHTS > 0
	struct RectAreaLight {
		vec3 color;
		vec3 position;
		vec3 halfWidth;
		vec3 halfHeight;
	};
	uniform sampler2D ltc_1;	uniform sampler2D ltc_2;
	uniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];
#endif
#if NUM_HEMI_LIGHTS > 0
	struct HemisphereLight {
		vec3 direction;
		vec3 skyColor;
		vec3 groundColor;
	};
	uniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];
	vec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in GeometricContext geometry ) {
		float dotNL = dot( geometry.normal, hemiLight.direction );
		float hemiDiffuseWeight = 0.5 * dotNL + 0.5;
		vec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );
		return irradiance;
	}
#endif`,lights_toon_fragment:`ToonMaterial material;
material.diffuseColor = diffuseColor.rgb;`,lights_toon_pars_fragment:`varying vec3 vViewPosition;
struct ToonMaterial {
	vec3 diffuseColor;
};
void RE_Direct_Toon( const in IncidentLight directLight, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {
	vec3 irradiance = getGradientIrradiance( geometry.normal, directLight.direction ) * directLight.color;
	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
void RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
#define RE_Direct				RE_Direct_Toon
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Toon
#define Material_LightProbeLOD( material )	(0)`,lights_phong_fragment:`BlinnPhongMaterial material;
material.diffuseColor = diffuseColor.rgb;
material.specularColor = specular;
material.specularShininess = shininess;
material.specularStrength = specularStrength;`,lights_phong_pars_fragment:`varying vec3 vViewPosition;
struct BlinnPhongMaterial {
	vec3 diffuseColor;
	vec3 specularColor;
	float specularShininess;
	float specularStrength;
};
void RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {
	float dotNL = saturate( dot( geometry.normal, directLight.direction ) );
	vec3 irradiance = dotNL * directLight.color;
	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
	reflectedLight.directSpecular += irradiance * BRDF_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess ) * material.specularStrength;
}
void RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
#define RE_Direct				RE_Direct_BlinnPhong
#define RE_IndirectDiffuse		RE_IndirectDiffuse_BlinnPhong
#define Material_LightProbeLOD( material )	(0)`,lights_physical_fragment:`PhysicalMaterial material;
material.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );
vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );
float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );
material.roughness = max( roughnessFactor, 0.0525 );material.roughness += geometryRoughness;
material.roughness = min( material.roughness, 1.0 );
#ifdef IOR
	#ifdef SPECULAR
		float specularIntensityFactor = specularIntensity;
		vec3 specularTintFactor = specularTint;
		#ifdef USE_SPECULARINTENSITYMAP
			specularIntensityFactor *= texture2D( specularIntensityMap, vUv ).a;
		#endif
		#ifdef USE_SPECULARTINTMAP
			specularTintFactor *= specularTintMapTexelToLinear( texture2D( specularTintMap, vUv ) ).rgb;
		#endif
		material.specularF90 = mix( specularIntensityFactor, 1.0, metalnessFactor );
	#else
		float specularIntensityFactor = 1.0;
		vec3 specularTintFactor = vec3( 1.0 );
		material.specularF90 = 1.0;
	#endif
	material.specularColor = mix( min( pow2( ( ior - 1.0 ) / ( ior + 1.0 ) ) * specularTintFactor, vec3( 1.0 ) ) * specularIntensityFactor, diffuseColor.rgb, metalnessFactor );
#else
	material.specularColor = mix( vec3( 0.04 ), diffuseColor.rgb, metalnessFactor );
	material.specularF90 = 1.0;
#endif
#ifdef USE_CLEARCOAT
	material.clearcoat = clearcoat;
	material.clearcoatRoughness = clearcoatRoughness;
	material.clearcoatF0 = vec3( 0.04 );
	material.clearcoatF90 = 1.0;
	#ifdef USE_CLEARCOATMAP
		material.clearcoat *= texture2D( clearcoatMap, vUv ).x;
	#endif
	#ifdef USE_CLEARCOAT_ROUGHNESSMAP
		material.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vUv ).y;
	#endif
	material.clearcoat = saturate( material.clearcoat );	material.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );
	material.clearcoatRoughness += geometryRoughness;
	material.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );
#endif
#ifdef USE_SHEEN
	material.sheenTint = sheenTint;
#endif`,lights_physical_pars_fragment:`struct PhysicalMaterial {
	vec3 diffuseColor;
	float roughness;
	vec3 specularColor;
	float specularF90;
	#ifdef USE_CLEARCOAT
		float clearcoat;
		float clearcoatRoughness;
		vec3 clearcoatF0;
		float clearcoatF90;
	#endif
	#ifdef USE_SHEEN
		vec3 sheenTint;
	#endif
};
vec3 clearcoatSpecular = vec3( 0.0 );
vec2 DFGApprox( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {
	float dotNV = saturate( dot( normal, viewDir ) );
	const vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );
	const vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );
	vec4 r = roughness * c0 + c1;
	float a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;
	vec2 fab = vec2( - 1.04, 1.04 ) * a004 + r.zw;
	return fab;
}
vec3 EnvironmentBRDF( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness ) {
	vec2 fab = DFGApprox( normal, viewDir, roughness );
	return specularColor * fab.x + specularF90 * fab.y;
}
void computeMultiscattering( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {
	vec2 fab = DFGApprox( normal, viewDir, roughness );
	vec3 FssEss = specularColor * fab.x + specularF90 * fab.y;
	float Ess = fab.x + fab.y;
	float Ems = 1.0 - Ess;
	vec3 Favg = specularColor + ( 1.0 - specularColor ) * 0.047619;	vec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );
	singleScatter += FssEss;
	multiScatter += Fms * Ems;
}
#if NUM_RECT_AREA_LIGHTS > 0
	void RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {
		vec3 normal = geometry.normal;
		vec3 viewDir = geometry.viewDir;
		vec3 position = geometry.position;
		vec3 lightPos = rectAreaLight.position;
		vec3 halfWidth = rectAreaLight.halfWidth;
		vec3 halfHeight = rectAreaLight.halfHeight;
		vec3 lightColor = rectAreaLight.color;
		float roughness = material.roughness;
		vec3 rectCoords[ 4 ];
		rectCoords[ 0 ] = lightPos + halfWidth - halfHeight;		rectCoords[ 1 ] = lightPos - halfWidth - halfHeight;
		rectCoords[ 2 ] = lightPos - halfWidth + halfHeight;
		rectCoords[ 3 ] = lightPos + halfWidth + halfHeight;
		vec2 uv = LTC_Uv( normal, viewDir, roughness );
		vec4 t1 = texture2D( ltc_1, uv );
		vec4 t2 = texture2D( ltc_2, uv );
		mat3 mInv = mat3(
			vec3( t1.x, 0, t1.y ),
			vec3(		0, 1,		0 ),
			vec3( t1.z, 0, t1.w )
		);
		vec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );
		reflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );
		reflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );
	}
#endif
void RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {
	float dotNL = saturate( dot( geometry.normal, directLight.direction ) );
	vec3 irradiance = dotNL * directLight.color;
	#ifdef USE_CLEARCOAT
		float dotNLcc = saturate( dot( geometry.clearcoatNormal, directLight.direction ) );
		vec3 ccIrradiance = dotNLcc * directLight.color;
		clearcoatSpecular += ccIrradiance * BRDF_GGX( directLight, geometry.viewDir, geometry.clearcoatNormal, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );
	#endif
	#ifdef USE_SHEEN
		reflectedLight.directSpecular += irradiance * BRDF_Sheen( material.roughness, directLight.direction, geometry, material.sheenTint );
	#else
		reflectedLight.directSpecular += irradiance * BRDF_GGX( directLight, geometry.viewDir, geometry.normal, material.specularColor, material.specularF90, material.roughness );
	#endif
	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
void RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
void RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {
	#ifdef USE_CLEARCOAT
		clearcoatSpecular += clearcoatRadiance * EnvironmentBRDF( geometry.clearcoatNormal, geometry.viewDir, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );
	#endif
	vec3 singleScattering = vec3( 0.0 );
	vec3 multiScattering = vec3( 0.0 );
	vec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;
	computeMultiscattering( geometry.normal, geometry.viewDir, material.specularColor, material.specularF90, material.roughness, singleScattering, multiScattering );
	vec3 diffuse = material.diffuseColor * ( 1.0 - ( singleScattering + multiScattering ) );
	reflectedLight.indirectSpecular += radiance * singleScattering;
	reflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;
	reflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;
}
#define RE_Direct				RE_Direct_Physical
#define RE_Direct_RectArea		RE_Direct_RectArea_Physical
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Physical
#define RE_IndirectSpecular		RE_IndirectSpecular_Physical
float computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {
	return saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );
}`,lights_fragment_begin:`
GeometricContext geometry;
geometry.position = - vViewPosition;
geometry.normal = normal;
geometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );
#ifdef USE_CLEARCOAT
	geometry.clearcoatNormal = clearcoatNormal;
#endif
IncidentLight directLight;
#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )
	PointLight pointLight;
	#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0
	PointLightShadow pointLightShadow;
	#endif
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {
		pointLight = pointLights[ i ];
		getPointLightInfo( pointLight, geometry, directLight );
		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )
		pointLightShadow = pointLightShadows[ i ];
		directLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;
		#endif
		RE_Direct( directLight, geometry, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )
	SpotLight spotLight;
	#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0
	SpotLightShadow spotLightShadow;
	#endif
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {
		spotLight = spotLights[ i ];
		getSpotLightInfo( spotLight, geometry, directLight );
		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )
		spotLightShadow = spotLightShadows[ i ];
		directLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;
		#endif
		RE_Direct( directLight, geometry, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )
	DirectionalLight directionalLight;
	#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0
	DirectionalLightShadow directionalLightShadow;
	#endif
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {
		directionalLight = directionalLights[ i ];
		getDirectionalLightInfo( directionalLight, geometry, directLight );
		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )
		directionalLightShadow = directionalLightShadows[ i ];
		directLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;
		#endif
		RE_Direct( directLight, geometry, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )
	RectAreaLight rectAreaLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {
		rectAreaLight = rectAreaLights[ i ];
		RE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if defined( RE_IndirectDiffuse )
	vec3 iblIrradiance = vec3( 0.0 );
	vec3 irradiance = getAmbientLightIrradiance( ambientLightColor );
	irradiance += getLightProbeIrradiance( lightProbe, geometry );
	#if ( NUM_HEMI_LIGHTS > 0 )
		#pragma unroll_loop_start
		for ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {
			irradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );
		}
		#pragma unroll_loop_end
	#endif
#endif
#if defined( RE_IndirectSpecular )
	vec3 radiance = vec3( 0.0 );
	vec3 clearcoatRadiance = vec3( 0.0 );
#endif`,lights_fragment_maps:`#if defined( RE_IndirectDiffuse )
	#ifdef USE_LIGHTMAP
		vec4 lightMapTexel = texture2D( lightMap, vUv2 );
		vec3 lightMapIrradiance = lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;
		#ifndef PHYSICALLY_CORRECT_LIGHTS
			lightMapIrradiance *= PI;
		#endif
		irradiance += lightMapIrradiance;
	#endif
	#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )
		iblIrradiance += getIBLIrradiance( geometry );
	#endif
#endif
#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )
	radiance += getIBLRadiance( geometry.viewDir, geometry.normal, material.roughness );
	#ifdef USE_CLEARCOAT
		clearcoatRadiance += getIBLRadiance( geometry.viewDir, geometry.clearcoatNormal, material.clearcoatRoughness );
	#endif
#endif`,lights_fragment_end:`#if defined( RE_IndirectDiffuse )
	RE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );
#endif
#if defined( RE_IndirectSpecular )
	RE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometry, material, reflectedLight );
#endif`,logdepthbuf_fragment:`#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )
	gl_FragDepthEXT = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;
#endif`,logdepthbuf_pars_fragment:`#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )
	uniform float logDepthBufFC;
	varying float vFragDepth;
	varying float vIsPerspective;
#endif`,logdepthbuf_pars_vertex:`#ifdef USE_LOGDEPTHBUF
	#ifdef USE_LOGDEPTHBUF_EXT
		varying float vFragDepth;
		varying float vIsPerspective;
	#else
		uniform float logDepthBufFC;
	#endif
#endif`,logdepthbuf_vertex:`#ifdef USE_LOGDEPTHBUF
	#ifdef USE_LOGDEPTHBUF_EXT
		vFragDepth = 1.0 + gl_Position.w;
		vIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );
	#else
		if ( isPerspectiveMatrix( projectionMatrix ) ) {
			gl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;
			gl_Position.z *= gl_Position.w;
		}
	#endif
#endif`,map_fragment:`#ifdef USE_MAP
	vec4 texelColor = texture2D( map, vUv );
	texelColor = mapTexelToLinear( texelColor );
	diffuseColor *= texelColor;
#endif`,map_pars_fragment:`#ifdef USE_MAP
	uniform sampler2D map;
#endif`,map_particle_fragment:`#if defined( USE_MAP ) || defined( USE_ALPHAMAP )
	vec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;
#endif
#ifdef USE_MAP
	vec4 mapTexel = texture2D( map, uv );
	diffuseColor *= mapTexelToLinear( mapTexel );
#endif
#ifdef USE_ALPHAMAP
	diffuseColor.a *= texture2D( alphaMap, uv ).g;
#endif`,map_particle_pars_fragment:`#if defined( USE_MAP ) || defined( USE_ALPHAMAP )
	uniform mat3 uvTransform;
#endif
#ifdef USE_MAP
	uniform sampler2D map;
#endif
#ifdef USE_ALPHAMAP
	uniform sampler2D alphaMap;
#endif`,metalnessmap_fragment:`float metalnessFactor = metalness;
#ifdef USE_METALNESSMAP
	vec4 texelMetalness = texture2D( metalnessMap, vUv );
	metalnessFactor *= texelMetalness.b;
#endif`,metalnessmap_pars_fragment:`#ifdef USE_METALNESSMAP
	uniform sampler2D metalnessMap;
#endif`,morphnormal_vertex:`#ifdef USE_MORPHNORMALS
	objectNormal *= morphTargetBaseInfluence;
	objectNormal += morphNormal0 * morphTargetInfluences[ 0 ];
	objectNormal += morphNormal1 * morphTargetInfluences[ 1 ];
	objectNormal += morphNormal2 * morphTargetInfluences[ 2 ];
	objectNormal += morphNormal3 * morphTargetInfluences[ 3 ];
#endif`,morphtarget_pars_vertex:`#ifdef USE_MORPHTARGETS
	uniform float morphTargetBaseInfluence;
	#ifndef USE_MORPHNORMALS
		uniform float morphTargetInfluences[ 8 ];
	#else
		uniform float morphTargetInfluences[ 4 ];
	#endif
#endif`,morphtarget_vertex:`#ifdef USE_MORPHTARGETS
	transformed *= morphTargetBaseInfluence;
	transformed += morphTarget0 * morphTargetInfluences[ 0 ];
	transformed += morphTarget1 * morphTargetInfluences[ 1 ];
	transformed += morphTarget2 * morphTargetInfluences[ 2 ];
	transformed += morphTarget3 * morphTargetInfluences[ 3 ];
	#ifndef USE_MORPHNORMALS
		transformed += morphTarget4 * morphTargetInfluences[ 4 ];
		transformed += morphTarget5 * morphTargetInfluences[ 5 ];
		transformed += morphTarget6 * morphTargetInfluences[ 6 ];
		transformed += morphTarget7 * morphTargetInfluences[ 7 ];
	#endif
#endif`,normal_fragment_begin:`float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;
#ifdef FLAT_SHADED
	vec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );
	vec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );
	vec3 normal = normalize( cross( fdx, fdy ) );
#else
	vec3 normal = normalize( vNormal );
	#ifdef DOUBLE_SIDED
		normal = normal * faceDirection;
	#endif
	#ifdef USE_TANGENT
		vec3 tangent = normalize( vTangent );
		vec3 bitangent = normalize( vBitangent );
		#ifdef DOUBLE_SIDED
			tangent = tangent * faceDirection;
			bitangent = bitangent * faceDirection;
		#endif
		#if defined( TANGENTSPACE_NORMALMAP ) || defined( USE_CLEARCOAT_NORMALMAP )
			mat3 vTBN = mat3( tangent, bitangent, normal );
		#endif
	#endif
#endif
vec3 geometryNormal = normal;`,normal_fragment_maps:`#ifdef OBJECTSPACE_NORMALMAP
	normal = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;
	#ifdef FLIP_SIDED
		normal = - normal;
	#endif
	#ifdef DOUBLE_SIDED
		normal = normal * faceDirection;
	#endif
	normal = normalize( normalMatrix * normal );
#elif defined( TANGENTSPACE_NORMALMAP )
	vec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;
	mapN.xy *= normalScale;
	#ifdef USE_TANGENT
		normal = normalize( vTBN * mapN );
	#else
		normal = perturbNormal2Arb( - vViewPosition, normal, mapN, faceDirection );
	#endif
#elif defined( USE_BUMPMAP )
	normal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );
#endif`,normal_pars_fragment:`#ifndef FLAT_SHADED
	varying vec3 vNormal;
	#ifdef USE_TANGENT
		varying vec3 vTangent;
		varying vec3 vBitangent;
	#endif
#endif`,normal_pars_vertex:`#ifndef FLAT_SHADED
	varying vec3 vNormal;
	#ifdef USE_TANGENT
		varying vec3 vTangent;
		varying vec3 vBitangent;
	#endif
#endif`,normal_vertex:`#ifndef FLAT_SHADED
	vNormal = normalize( transformedNormal );
	#ifdef USE_TANGENT
		vTangent = normalize( transformedTangent );
		vBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );
	#endif
#endif`,normalmap_pars_fragment:`#ifdef USE_NORMALMAP
	uniform sampler2D normalMap;
	uniform vec2 normalScale;
#endif
#ifdef OBJECTSPACE_NORMALMAP
	uniform mat3 normalMatrix;
#endif
#if ! defined ( USE_TANGENT ) && ( defined ( TANGENTSPACE_NORMALMAP ) || defined ( USE_CLEARCOAT_NORMALMAP ) )
	vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec3 mapN, float faceDirection ) {
		vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );
		vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );
		vec2 st0 = dFdx( vUv.st );
		vec2 st1 = dFdy( vUv.st );
		vec3 N = surf_norm;
		vec3 q1perp = cross( q1, N );
		vec3 q0perp = cross( N, q0 );
		vec3 T = q1perp * st0.x + q0perp * st1.x;
		vec3 B = q1perp * st0.y + q0perp * st1.y;
		float det = max( dot( T, T ), dot( B, B ) );
		float scale = ( det == 0.0 ) ? 0.0 : faceDirection * inversesqrt( det );
		return normalize( T * ( mapN.x * scale ) + B * ( mapN.y * scale ) + N * mapN.z );
	}
#endif`,clearcoat_normal_fragment_begin:`#ifdef USE_CLEARCOAT
	vec3 clearcoatNormal = geometryNormal;
#endif`,clearcoat_normal_fragment_maps:`#ifdef USE_CLEARCOAT_NORMALMAP
	vec3 clearcoatMapN = texture2D( clearcoatNormalMap, vUv ).xyz * 2.0 - 1.0;
	clearcoatMapN.xy *= clearcoatNormalScale;
	#ifdef USE_TANGENT
		clearcoatNormal = normalize( vTBN * clearcoatMapN );
	#else
		clearcoatNormal = perturbNormal2Arb( - vViewPosition, clearcoatNormal, clearcoatMapN, faceDirection );
	#endif
#endif`,clearcoat_pars_fragment:`#ifdef USE_CLEARCOATMAP
	uniform sampler2D clearcoatMap;
#endif
#ifdef USE_CLEARCOAT_ROUGHNESSMAP
	uniform sampler2D clearcoatRoughnessMap;
#endif
#ifdef USE_CLEARCOAT_NORMALMAP
	uniform sampler2D clearcoatNormalMap;
	uniform vec2 clearcoatNormalScale;
#endif`,output_fragment:`#ifdef OPAQUE
diffuseColor.a = 1.0;
#endif
#ifdef USE_TRANSMISSION
diffuseColor.a *= transmissionAlpha + 0.1;
#endif
gl_FragColor = vec4( outgoingLight, diffuseColor.a );`,packing:`vec3 packNormalToRGB( const in vec3 normal ) {
	return normalize( normal ) * 0.5 + 0.5;
}
vec3 unpackRGBToNormal( const in vec3 rgb ) {
	return 2.0 * rgb.xyz - 1.0;
}
const float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;
const vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );
const vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );
const float ShiftRight8 = 1. / 256.;
vec4 packDepthToRGBA( const in float v ) {
	vec4 r = vec4( fract( v * PackFactors ), v );
	r.yzw -= r.xyz * ShiftRight8;	return r * PackUpscale;
}
float unpackRGBAToDepth( const in vec4 v ) {
	return dot( v, UnpackFactors );
}
vec4 pack2HalfToRGBA( vec2 v ) {
	vec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ) );
	return vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w );
}
vec2 unpackRGBATo2Half( vec4 v ) {
	return vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );
}
float viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {
	return ( viewZ + near ) / ( near - far );
}
float orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {
	return linearClipZ * ( near - far ) - near;
}
float viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {
	return ( ( near + viewZ ) * far ) / ( ( far - near ) * viewZ );
}
float perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {
	return ( near * far ) / ( ( far - near ) * invClipZ - far );
}`,premultiplied_alpha_fragment:`#ifdef PREMULTIPLIED_ALPHA
	gl_FragColor.rgb *= gl_FragColor.a;
#endif`,project_vertex:`vec4 mvPosition = vec4( transformed, 1.0 );
#ifdef USE_INSTANCING
	mvPosition = instanceMatrix * mvPosition;
#endif
mvPosition = modelViewMatrix * mvPosition;
gl_Position = projectionMatrix * mvPosition;`,dithering_fragment:`#ifdef DITHERING
	gl_FragColor.rgb = dithering( gl_FragColor.rgb );
#endif`,dithering_pars_fragment:`#ifdef DITHERING
	vec3 dithering( vec3 color ) {
		float grid_position = rand( gl_FragCoord.xy );
		vec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );
		dither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );
		return color + dither_shift_RGB;
	}
#endif`,roughnessmap_fragment:`float roughnessFactor = roughness;
#ifdef USE_ROUGHNESSMAP
	vec4 texelRoughness = texture2D( roughnessMap, vUv );
	roughnessFactor *= texelRoughness.g;
#endif`,roughnessmap_pars_fragment:`#ifdef USE_ROUGHNESSMAP
	uniform sampler2D roughnessMap;
#endif`,shadowmap_pars_fragment:`#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0
		uniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];
		varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];
		struct DirectionalLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
		uniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];
		varying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHT_SHADOWS ];
		struct SpotLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
		uniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];
		varying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];
		struct PointLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
			float shadowCameraNear;
			float shadowCameraFar;
		};
		uniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];
	#endif
	float texture2DCompare( sampler2D depths, vec2 uv, float compare ) {
		return step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );
	}
	vec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {
		return unpackRGBATo2Half( texture2D( shadow, uv ) );
	}
	float VSMShadow (sampler2D shadow, vec2 uv, float compare ){
		float occlusion = 1.0;
		vec2 distribution = texture2DDistribution( shadow, uv );
		float hard_shadow = step( compare , distribution.x );
		if (hard_shadow != 1.0 ) {
			float distance = compare - distribution.x ;
			float variance = max( 0.00000, distribution.y * distribution.y );
			float softness_probability = variance / (variance + distance * distance );			softness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );			occlusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );
		}
		return occlusion;
	}
	float getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {
		float shadow = 1.0;
		shadowCoord.xyz /= shadowCoord.w;
		shadowCoord.z += shadowBias;
		bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );
		bool inFrustum = all( inFrustumVec );
		bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );
		bool frustumTest = all( frustumTestVec );
		if ( frustumTest ) {
		#if defined( SHADOWMAP_TYPE_PCF )
			vec2 texelSize = vec2( 1.0 ) / shadowMapSize;
			float dx0 = - texelSize.x * shadowRadius;
			float dy0 = - texelSize.y * shadowRadius;
			float dx1 = + texelSize.x * shadowRadius;
			float dy1 = + texelSize.y * shadowRadius;
			float dx2 = dx0 / 2.0;
			float dy2 = dy0 / 2.0;
			float dx3 = dx1 / 2.0;
			float dy3 = dy1 / 2.0;
			shadow = (
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )
			) * ( 1.0 / 17.0 );
		#elif defined( SHADOWMAP_TYPE_PCF_SOFT )
			vec2 texelSize = vec2( 1.0 ) / shadowMapSize;
			float dx = texelSize.x;
			float dy = texelSize.y;
			vec2 uv = shadowCoord.xy;
			vec2 f = fract( uv * shadowMapSize + 0.5 );
			uv -= f * texelSize;
			shadow = (
				texture2DCompare( shadowMap, uv, shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +
				mix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ), 
					 texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),
					 f.x ) +
				mix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ), 
					 texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),
					 f.x ) +
				mix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ), 
					 texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),
					 f.y ) +
				mix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ), 
					 texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),
					 f.y ) +
				mix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ), 
							texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),
							f.x ),
					 mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ), 
							texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),
							f.x ),
					 f.y )
			) * ( 1.0 / 9.0 );
		#elif defined( SHADOWMAP_TYPE_VSM )
			shadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );
		#else
			shadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );
		#endif
		}
		return shadow;
	}
	vec2 cubeToUV( vec3 v, float texelSizeY ) {
		vec3 absV = abs( v );
		float scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );
		absV *= scaleToCube;
		v *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );
		vec2 planar = v.xy;
		float almostATexel = 1.5 * texelSizeY;
		float almostOne = 1.0 - almostATexel;
		if ( absV.z >= almostOne ) {
			if ( v.z > 0.0 )
				planar.x = 4.0 - v.x;
		} else if ( absV.x >= almostOne ) {
			float signX = sign( v.x );
			planar.x = v.z * signX + 2.0 * signX;
		} else if ( absV.y >= almostOne ) {
			float signY = sign( v.y );
			planar.x = v.x + 2.0 * signY + 2.0;
			planar.y = v.z * signY - 2.0;
		}
		return vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );
	}
	float getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {
		vec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );
		vec3 lightToPosition = shadowCoord.xyz;
		float dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );		dp += shadowBias;
		vec3 bd3D = normalize( lightToPosition );
		#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )
			vec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;
			return (
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )
			) * ( 1.0 / 9.0 );
		#else
			return texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );
		#endif
	}
#endif`,shadowmap_pars_vertex:`#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0
		uniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];
		varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];
		struct DirectionalLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
		uniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHT_SHADOWS ];
		varying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHT_SHADOWS ];
		struct SpotLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
		uniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];
		varying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];
		struct PointLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
			float shadowCameraNear;
			float shadowCameraFar;
		};
		uniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];
	#endif
#endif`,shadowmap_vertex:`#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0 || NUM_SPOT_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0
		vec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );
		vec4 shadowWorldPosition;
	#endif
	#if NUM_DIR_LIGHT_SHADOWS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {
		shadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );
		vDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;
	}
	#pragma unroll_loop_end
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {
		shadowWorldPosition = worldPosition + vec4( shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias, 0 );
		vSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * shadowWorldPosition;
	}
	#pragma unroll_loop_end
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {
		shadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );
		vPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;
	}
	#pragma unroll_loop_end
	#endif
#endif`,shadowmask_pars_fragment:`float getShadowMask() {
	float shadow = 1.0;
	#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0
	DirectionalLightShadow directionalLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {
		directionalLight = directionalLightShadows[ i ];
		shadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;
	}
	#pragma unroll_loop_end
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
	SpotLightShadow spotLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {
		spotLight = spotLightShadows[ i ];
		shadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;
	}
	#pragma unroll_loop_end
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
	PointLightShadow pointLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {
		pointLight = pointLightShadows[ i ];
		shadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;
	}
	#pragma unroll_loop_end
	#endif
	#endif
	return shadow;
}`,skinbase_vertex:`#ifdef USE_SKINNING
	mat4 boneMatX = getBoneMatrix( skinIndex.x );
	mat4 boneMatY = getBoneMatrix( skinIndex.y );
	mat4 boneMatZ = getBoneMatrix( skinIndex.z );
	mat4 boneMatW = getBoneMatrix( skinIndex.w );
#endif`,skinning_pars_vertex:`#ifdef USE_SKINNING
	uniform mat4 bindMatrix;
	uniform mat4 bindMatrixInverse;
	#ifdef BONE_TEXTURE
		uniform highp sampler2D boneTexture;
		uniform int boneTextureSize;
		mat4 getBoneMatrix( const in float i ) {
			float j = i * 4.0;
			float x = mod( j, float( boneTextureSize ) );
			float y = floor( j / float( boneTextureSize ) );
			float dx = 1.0 / float( boneTextureSize );
			float dy = 1.0 / float( boneTextureSize );
			y = dy * ( y + 0.5 );
			vec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );
			vec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );
			vec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );
			vec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );
			mat4 bone = mat4( v1, v2, v3, v4 );
			return bone;
		}
	#else
		uniform mat4 boneMatrices[ MAX_BONES ];
		mat4 getBoneMatrix( const in float i ) {
			mat4 bone = boneMatrices[ int(i) ];
			return bone;
		}
	#endif
#endif`,skinning_vertex:`#ifdef USE_SKINNING
	vec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );
	vec4 skinned = vec4( 0.0 );
	skinned += boneMatX * skinVertex * skinWeight.x;
	skinned += boneMatY * skinVertex * skinWeight.y;
	skinned += boneMatZ * skinVertex * skinWeight.z;
	skinned += boneMatW * skinVertex * skinWeight.w;
	transformed = ( bindMatrixInverse * skinned ).xyz;
#endif`,skinnormal_vertex:`#ifdef USE_SKINNING
	mat4 skinMatrix = mat4( 0.0 );
	skinMatrix += skinWeight.x * boneMatX;
	skinMatrix += skinWeight.y * boneMatY;
	skinMatrix += skinWeight.z * boneMatZ;
	skinMatrix += skinWeight.w * boneMatW;
	skinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;
	objectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;
	#ifdef USE_TANGENT
		objectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;
	#endif
#endif`,specularmap_fragment:`float specularStrength;
#ifdef USE_SPECULARMAP
	vec4 texelSpecular = texture2D( specularMap, vUv );
	specularStrength = texelSpecular.r;
#else
	specularStrength = 1.0;
#endif`,specularmap_pars_fragment:`#ifdef USE_SPECULARMAP
	uniform sampler2D specularMap;
#endif`,tonemapping_fragment:`#if defined( TONE_MAPPING )
	gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );
#endif`,tonemapping_pars_fragment:`#ifndef saturate
#define saturate( a ) clamp( a, 0.0, 1.0 )
#endif
uniform float toneMappingExposure;
vec3 LinearToneMapping( vec3 color ) {
	return toneMappingExposure * color;
}
vec3 ReinhardToneMapping( vec3 color ) {
	color *= toneMappingExposure;
	return saturate( color / ( vec3( 1.0 ) + color ) );
}
vec3 OptimizedCineonToneMapping( vec3 color ) {
	color *= toneMappingExposure;
	color = max( vec3( 0.0 ), color - 0.004 );
	return pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );
}
vec3 RRTAndODTFit( vec3 v ) {
	vec3 a = v * ( v + 0.0245786 ) - 0.000090537;
	vec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;
	return a / b;
}
vec3 ACESFilmicToneMapping( vec3 color ) {
	const mat3 ACESInputMat = mat3(
		vec3( 0.59719, 0.07600, 0.02840 ),		vec3( 0.35458, 0.90834, 0.13383 ),
		vec3( 0.04823, 0.01566, 0.83777 )
	);
	const mat3 ACESOutputMat = mat3(
		vec3(	1.60475, -0.10208, -0.00327 ),		vec3( -0.53108,	1.10813, -0.07276 ),
		vec3( -0.07367, -0.00605,	1.07602 )
	);
	color *= toneMappingExposure / 0.6;
	color = ACESInputMat * color;
	color = RRTAndODTFit( color );
	color = ACESOutputMat * color;
	return saturate( color );
}
vec3 CustomToneMapping( vec3 color ) { return color; }`,transmission_fragment:`#ifdef USE_TRANSMISSION
	float transmissionAlpha = 1.0;
	float transmissionFactor = transmission;
	float thicknessFactor = thickness;
	#ifdef USE_TRANSMISSIONMAP
		transmissionFactor *= texture2D( transmissionMap, vUv ).r;
	#endif
	#ifdef USE_THICKNESSMAP
		thicknessFactor *= texture2D( thicknessMap, vUv ).g;
	#endif
	vec3 pos = vWorldPosition;
	vec3 v = normalize( cameraPosition - pos );
	vec3 n = inverseTransformDirection( normal, viewMatrix );
	vec4 transmission = getIBLVolumeRefraction(
		n, v, roughnessFactor, material.diffuseColor, material.specularColor, material.specularF90,
		pos, modelMatrix, viewMatrix, projectionMatrix, ior, thicknessFactor,
		attenuationTint, attenuationDistance );
	totalDiffuse = mix( totalDiffuse, transmission.rgb, transmissionFactor );
	transmissionAlpha = transmission.a;
#endif`,transmission_pars_fragment:`#ifdef USE_TRANSMISSION
	uniform float transmission;
	uniform float thickness;
	uniform float attenuationDistance;
	uniform vec3 attenuationTint;
	#ifdef USE_TRANSMISSIONMAP
		uniform sampler2D transmissionMap;
	#endif
	#ifdef USE_THICKNESSMAP
		uniform sampler2D thicknessMap;
	#endif
	uniform vec2 transmissionSamplerSize;
	uniform sampler2D transmissionSamplerMap;
	uniform mat4 modelMatrix;
	uniform mat4 projectionMatrix;
	varying vec3 vWorldPosition;
	vec3 getVolumeTransmissionRay( vec3 n, vec3 v, float thickness, float ior, mat4 modelMatrix ) {
		vec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );
		vec3 modelScale;
		modelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );
		modelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );
		modelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );
		return normalize( refractionVector ) * thickness * modelScale;
	}
	float applyIorToRoughness( float roughness, float ior ) {
		return roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );
	}
	vec4 getTransmissionSample( vec2 fragCoord, float roughness, float ior ) {
		float framebufferLod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );
		#ifdef TEXTURE_LOD_EXT
			return texture2DLodEXT( transmissionSamplerMap, fragCoord.xy, framebufferLod );
		#else
			return texture2D( transmissionSamplerMap, fragCoord.xy, framebufferLod );
		#endif
	}
	vec3 applyVolumeAttenuation( vec3 radiance, float transmissionDistance, vec3 attenuationColor, float attenuationDistance ) {
		if ( attenuationDistance == 0.0 ) {
			return radiance;
		} else {
			vec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;
			vec3 transmittance = exp( - attenuationCoefficient * transmissionDistance );			return transmittance * radiance;
		}
	}
	vec4 getIBLVolumeRefraction( vec3 n, vec3 v, float roughness, vec3 diffuseColor, vec3 specularColor, float specularF90,
		vec3 position, mat4 modelMatrix, mat4 viewMatrix, mat4 projMatrix, float ior, float thickness,
		vec3 attenuationColor, float attenuationDistance ) {
		vec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );
		vec3 refractedRayExit = position + transmissionRay;
		vec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );
		vec2 refractionCoords = ndcPos.xy / ndcPos.w;
		refractionCoords += 1.0;
		refractionCoords /= 2.0;
		vec4 transmittedLight = getTransmissionSample( refractionCoords, roughness, ior );
		vec3 attenuatedColor = applyVolumeAttenuation( transmittedLight.rgb, length( transmissionRay ), attenuationColor, attenuationDistance );
		vec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );
		return vec4( ( 1.0 - F ) * attenuatedColor * diffuseColor, transmittedLight.a );
	}
#endif`,uv_pars_fragment:`#if ( defined( USE_UV ) && ! defined( UVS_VERTEX_ONLY ) )
	varying vec2 vUv;
#endif`,uv_pars_vertex:`#ifdef USE_UV
	#ifdef UVS_VERTEX_ONLY
		vec2 vUv;
	#else
		varying vec2 vUv;
	#endif
	uniform mat3 uvTransform;
#endif`,uv_vertex:`#ifdef USE_UV
	vUv = ( uvTransform * vec3( uv, 1 ) ).xy;
#endif`,uv2_pars_fragment:`#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )
	varying vec2 vUv2;
#endif`,uv2_pars_vertex:`#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )
	attribute vec2 uv2;
	varying vec2 vUv2;
	uniform mat3 uv2Transform;
#endif`,uv2_vertex:`#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )
	vUv2 = ( uv2Transform * vec3( uv2, 1 ) ).xy;
#endif`,worldpos_vertex:`#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION )
	vec4 worldPosition = vec4( transformed, 1.0 );
	#ifdef USE_INSTANCING
		worldPosition = instanceMatrix * worldPosition;
	#endif
	worldPosition = modelMatrix * worldPosition;
#endif`,background_frag:`uniform sampler2D t2D;
varying vec2 vUv;
void main() {
	vec4 texColor = texture2D( t2D, vUv );
	gl_FragColor = mapTexelToLinear( texColor );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
}`,background_vert:`varying vec2 vUv;
uniform mat3 uvTransform;
void main() {
	vUv = ( uvTransform * vec3( uv, 1 ) ).xy;
	gl_Position = vec4( position.xy, 1.0, 1.0 );
}`,cube_frag:`#include <envmap_common_pars_fragment>
uniform float opacity;
varying vec3 vWorldDirection;
#include <cube_uv_reflection_fragment>
void main() {
	vec3 vReflect = vWorldDirection;
	#include <envmap_fragment>
	gl_FragColor = envColor;
	gl_FragColor.a *= opacity;
	#include <tonemapping_fragment>
	#include <encodings_fragment>
}`,cube_vert:`varying vec3 vWorldDirection;
#include <common>
void main() {
	vWorldDirection = transformDirection( position, modelMatrix );
	#include <begin_vertex>
	#include <project_vertex>
	gl_Position.z = gl_Position.w;
}`,depth_frag:`#if DEPTH_PACKING == 3200
	uniform float opacity;
#endif
#include <common>
#include <packing>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
varying vec2 vHighPrecisionZW;
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( 1.0 );
	#if DEPTH_PACKING == 3200
		diffuseColor.a = opacity;
	#endif
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <logdepthbuf_fragment>
	float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;
	#if DEPTH_PACKING == 3200
		gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );
	#elif DEPTH_PACKING == 3201
		gl_FragColor = packDepthToRGBA( fragCoordZ );
	#endif
}`,depth_vert:`#include <common>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
varying vec2 vHighPrecisionZW;
void main() {
	#include <uv_vertex>
	#include <skinbase_vertex>
	#ifdef USE_DISPLACEMENTMAP
		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinnormal_vertex>
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vHighPrecisionZW = gl_Position.zw;
}`,distanceRGBA_frag:`#define DISTANCE
uniform vec3 referencePosition;
uniform float nearDistance;
uniform float farDistance;
varying vec3 vWorldPosition;
#include <common>
#include <packing>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <clipping_planes_pars_fragment>
void main () {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( 1.0 );
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	float dist = length( vWorldPosition - referencePosition );
	dist = ( dist - nearDistance ) / ( farDistance - nearDistance );
	dist = saturate( dist );
	gl_FragColor = packDepthToRGBA( dist );
}`,distanceRGBA_vert:`#define DISTANCE
varying vec3 vWorldPosition;
#include <common>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <skinbase_vertex>
	#ifdef USE_DISPLACEMENTMAP
		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinnormal_vertex>
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <worldpos_vertex>
	#include <clipping_planes_vertex>
	vWorldPosition = worldPosition.xyz;
}`,equirect_frag:`uniform sampler2D tEquirect;
varying vec3 vWorldDirection;
#include <common>
void main() {
	vec3 direction = normalize( vWorldDirection );
	vec2 sampleUV = equirectUv( direction );
	vec4 texColor = texture2D( tEquirect, sampleUV );
	gl_FragColor = mapTexelToLinear( texColor );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
}`,equirect_vert:`varying vec3 vWorldDirection;
#include <common>
void main() {
	vWorldDirection = transformDirection( position, modelMatrix );
	#include <begin_vertex>
	#include <project_vertex>
}`,linedashed_frag:`uniform vec3 diffuse;
uniform float opacity;
uniform float dashSize;
uniform float totalSize;
varying float vLineDistance;
#include <common>
#include <color_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	if ( mod( vLineDistance, totalSize ) > dashSize ) {
		discard;
	}
	vec3 outgoingLight = vec3( 0.0 );
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <color_fragment>
	outgoingLight = diffuseColor.rgb;
	#include <output_fragment>
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
}`,linedashed_vert:`uniform float scale;
attribute float lineDistance;
varying float vLineDistance;
#include <common>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	vLineDistance = scale * lineDistance;
	#include <color_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>
}`,meshbasic_frag:`uniform vec3 diffuse;
uniform float opacity;
#ifndef FLAT_SHADED
	varying vec3 vNormal;
#endif
#include <common>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <uv2_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <cube_uv_reflection_fragment>
#include <fog_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <specularmap_fragment>
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	#ifdef USE_LIGHTMAP
		vec4 lightMapTexel= texture2D( lightMap, vUv2 );
		reflectedLight.indirectDiffuse += lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;
	#else
		reflectedLight.indirectDiffuse += vec3( 1.0 );
	#endif
	#include <aomap_fragment>
	reflectedLight.indirectDiffuse *= diffuseColor.rgb;
	vec3 outgoingLight = reflectedLight.indirectDiffuse;
	#include <envmap_fragment>
	#include <output_fragment>
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,meshbasic_vert:`#include <common>
#include <uv_pars_vertex>
#include <uv2_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <uv2_vertex>
	#include <color_vertex>
	#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )
		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinbase_vertex>
		#include <skinnormal_vertex>
		#include <defaultnormal_vertex>
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <fog_vertex>
}`,meshlambert_frag:`uniform vec3 diffuse;
uniform vec3 emissive;
uniform float opacity;
varying vec3 vLightFront;
varying vec3 vIndirectFront;
#ifdef DOUBLE_SIDED
	varying vec3 vLightBack;
	varying vec3 vIndirectBack;
#endif
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <uv2_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <cube_uv_reflection_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <fog_pars_fragment>
#include <shadowmap_pars_fragment>
#include <shadowmask_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <specularmap_fragment>
	#include <emissivemap_fragment>
	#ifdef DOUBLE_SIDED
		reflectedLight.indirectDiffuse += ( gl_FrontFacing ) ? vIndirectFront : vIndirectBack;
	#else
		reflectedLight.indirectDiffuse += vIndirectFront;
	#endif
	#include <lightmap_fragment>
	reflectedLight.indirectDiffuse *= BRDF_Lambert( diffuseColor.rgb );
	#ifdef DOUBLE_SIDED
		reflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;
	#else
		reflectedLight.directDiffuse = vLightFront;
	#endif
	reflectedLight.directDiffuse *= BRDF_Lambert( diffuseColor.rgb ) * getShadowMask();
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;
	#include <envmap_fragment>
	#include <output_fragment>
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,meshlambert_vert:`#define LAMBERT
varying vec3 vLightFront;
varying vec3 vIndirectFront;
#ifdef DOUBLE_SIDED
	varying vec3 vLightBack;
	varying vec3 vIndirectBack;
#endif
#include <common>
#include <uv_pars_vertex>
#include <uv2_pars_vertex>
#include <envmap_pars_vertex>
#include <bsdfs>
#include <lights_pars_begin>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <uv2_vertex>
	#include <color_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <lights_lambert_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,meshmatcap_frag:`#define MATCAP
uniform vec3 diffuse;
uniform float opacity;
uniform sampler2D matcap;
varying vec3 vViewPosition;
#include <common>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <fog_pars_fragment>
#include <normal_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	vec3 viewDir = normalize( vViewPosition );
	vec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );
	vec3 y = cross( viewDir, x );
	vec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;
	#ifdef USE_MATCAP
		vec4 matcapColor = texture2D( matcap, uv );
		matcapColor = matcapTexelToLinear( matcapColor );
	#else
		vec4 matcapColor = vec4( 1.0 );
	#endif
	vec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;
	#include <output_fragment>
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,meshmatcap_vert:`#define MATCAP
varying vec3 vViewPosition;
#include <common>
#include <uv_pars_vertex>
#include <color_pars_vertex>
#include <displacementmap_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>
	vViewPosition = - mvPosition.xyz;
}`,meshnormal_frag:`#define NORMAL
uniform float opacity;
#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )
	varying vec3 vViewPosition;
#endif
#include <packing>
#include <uv_pars_fragment>
#include <normal_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	#include <logdepthbuf_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	gl_FragColor = vec4( packNormalToRGB( normal ), opacity );
}`,meshnormal_vert:`#define NORMAL
#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )
	varying vec3 vViewPosition;
#endif
#include <common>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )
	vViewPosition = - mvPosition.xyz;
#endif
}`,meshphong_frag:`#define PHONG
uniform vec3 diffuse;
uniform vec3 emissive;
uniform vec3 specular;
uniform float shininess;
uniform float opacity;
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <uv2_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <cube_uv_reflection_fragment>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_phong_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <specularmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_phong_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;
	#include <envmap_fragment>
	#include <output_fragment>
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,meshphong_vert:`#define PHONG
varying vec3 vViewPosition;
#include <common>
#include <uv_pars_vertex>
#include <uv2_pars_vertex>
#include <displacementmap_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <uv2_vertex>
	#include <color_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,meshphysical_frag:`#define STANDARD
#ifdef PHYSICAL
	#define IOR
	#define SPECULAR
#endif
uniform vec3 diffuse;
uniform vec3 emissive;
uniform float roughness;
uniform float metalness;
uniform float opacity;
#ifdef IOR
	uniform float ior;
#endif
#ifdef SPECULAR
	uniform float specularIntensity;
	uniform vec3 specularTint;
	#ifdef USE_SPECULARINTENSITYMAP
		uniform sampler2D specularIntensityMap;
	#endif
	#ifdef USE_SPECULARTINTMAP
		uniform sampler2D specularTintMap;
	#endif
#endif
#ifdef USE_CLEARCOAT
	uniform float clearcoat;
	uniform float clearcoatRoughness;
#endif
#ifdef USE_SHEEN
	uniform vec3 sheenTint;
#endif
varying vec3 vViewPosition;
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <uv2_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <bsdfs>
#include <cube_uv_reflection_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_physical_pars_fragment>
#include <fog_pars_fragment>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_physical_pars_fragment>
#include <transmission_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <clearcoat_pars_fragment>
#include <roughnessmap_pars_fragment>
#include <metalnessmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <roughnessmap_fragment>
	#include <metalnessmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <clearcoat_normal_fragment_begin>
	#include <clearcoat_normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_physical_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;
	vec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;
	#include <transmission_fragment>
	vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;
	#ifdef USE_CLEARCOAT
		float dotNVcc = saturate( dot( geometry.clearcoatNormal, geometry.viewDir ) );
		vec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );
		outgoingLight = outgoingLight * ( 1.0 - clearcoat * Fcc ) + clearcoatSpecular * clearcoat;
	#endif
	#include <output_fragment>
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,meshphysical_vert:`#define STANDARD
varying vec3 vViewPosition;
#ifdef USE_TRANSMISSION
	varying vec3 vWorldPosition;
#endif
#include <common>
#include <uv_pars_vertex>
#include <uv2_pars_vertex>
#include <displacementmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <uv2_vertex>
	#include <color_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
#ifdef USE_TRANSMISSION
	vWorldPosition = worldPosition.xyz;
#endif
}`,meshtoon_frag:`#define TOON
uniform vec3 diffuse;
uniform vec3 emissive;
uniform float opacity;
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <uv2_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <gradientmap_pars_fragment>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_toon_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_toon_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;
	#include <output_fragment>
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,meshtoon_vert:`#define TOON
varying vec3 vViewPosition;
#include <common>
#include <uv_pars_vertex>
#include <uv2_pars_vertex>
#include <displacementmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <uv2_vertex>
	#include <color_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,points_frag:`uniform vec3 diffuse;
uniform float opacity;
#include <common>
#include <color_pars_fragment>
#include <map_particle_pars_fragment>
#include <alphatest_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec3 outgoingLight = vec3( 0.0 );
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_particle_fragment>
	#include <color_fragment>
	#include <alphatest_fragment>
	outgoingLight = diffuseColor.rgb;
	#include <output_fragment>
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
}`,points_vert:`uniform float size;
uniform float scale;
#include <common>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <color_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <project_vertex>
	gl_PointSize = size;
	#ifdef USE_SIZEATTENUATION
		bool isPerspective = isPerspectiveMatrix( projectionMatrix );
		if ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );
	#endif
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <worldpos_vertex>
	#include <fog_vertex>
}`,shadow_frag:`uniform vec3 color;
uniform float opacity;
#include <common>
#include <packing>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <shadowmap_pars_fragment>
#include <shadowmask_pars_fragment>
void main() {
	gl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
}`,shadow_vert:`#include <common>
#include <fog_pars_vertex>
#include <shadowmap_pars_vertex>
void main() {
	#include <begin_vertex>
	#include <project_vertex>
	#include <worldpos_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,sprite_frag:`uniform vec3 diffuse;
uniform float opacity;
#include <common>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec3 outgoingLight = vec3( 0.0 );
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	outgoingLight = diffuseColor.rgb;
	#include <output_fragment>
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
}`,sprite_vert:`uniform float rotation;
uniform vec2 center;
#include <common>
#include <uv_pars_vertex>
#include <fog_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );
	vec2 scale;
	scale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );
	scale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );
	#ifndef USE_SIZEATTENUATION
		bool isPerspective = isPerspectiveMatrix( projectionMatrix );
		if ( isPerspective ) scale *= - mvPosition.z;
	#endif
	vec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;
	vec2 rotatedPosition;
	rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;
	rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;
	mvPosition.xy += rotatedPosition;
	gl_Position = projectionMatrix * mvPosition;
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>
}`},On={common:{diffuse:{value:new un(16777215)},opacity:{value:1},map:{value:null},uvTransform:{value:new jr},uv2Transform:{value:new jr},alphaMap:{value:null},alphaTest:{value:0}},specularmap:{specularMap:{value:null}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98},maxMipLevel:{value:0}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1}},emissivemap:{emissiveMap:{value:null}},bumpmap:{bumpMap:{value:null},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalScale:{value:new Ri(1,1)}},displacementmap:{displacementMap:{value:null},displacementScale:{value:1},displacementBias:{value:0}},roughnessmap:{roughnessMap:{value:null}},metalnessmap:{metalnessMap:{value:null}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new un(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotShadowMap:{value:[]},spotShadowMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new un(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaTest:{value:0},uvTransform:{value:new jr}},sprite:{diffuse:{value:new un(16777215)},opacity:{value:1},center:{value:new Ri(.5,.5)},rotation:{value:0},map:{value:null},alphaMap:{value:null},alphaTest:{value:0},uvTransform:{value:new jr}}},Ta={basic:{uniforms:$s([On.common,On.specularmap,On.envmap,On.aomap,On.lightmap,On.fog]),vertexShader:es.meshbasic_vert,fragmentShader:es.meshbasic_frag},lambert:{uniforms:$s([On.common,On.specularmap,On.envmap,On.aomap,On.lightmap,On.emissivemap,On.fog,On.lights,{emissive:{value:new un(0)}}]),vertexShader:es.meshlambert_vert,fragmentShader:es.meshlambert_frag},phong:{uniforms:$s([On.common,On.specularmap,On.envmap,On.aomap,On.lightmap,On.emissivemap,On.bumpmap,On.normalmap,On.displacementmap,On.fog,On.lights,{emissive:{value:new un(0)},specular:{value:new un(1118481)},shininess:{value:30}}]),vertexShader:es.meshphong_vert,fragmentShader:es.meshphong_frag},standard:{uniforms:$s([On.common,On.envmap,On.aomap,On.lightmap,On.emissivemap,On.bumpmap,On.normalmap,On.displacementmap,On.roughnessmap,On.metalnessmap,On.fog,On.lights,{emissive:{value:new un(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:es.meshphysical_vert,fragmentShader:es.meshphysical_frag},toon:{uniforms:$s([On.common,On.aomap,On.lightmap,On.emissivemap,On.bumpmap,On.normalmap,On.displacementmap,On.gradientmap,On.fog,On.lights,{emissive:{value:new un(0)}}]),vertexShader:es.meshtoon_vert,fragmentShader:es.meshtoon_frag},matcap:{uniforms:$s([On.common,On.bumpmap,On.normalmap,On.displacementmap,On.fog,{matcap:{value:null}}]),vertexShader:es.meshmatcap_vert,fragmentShader:es.meshmatcap_frag},points:{uniforms:$s([On.points,On.fog]),vertexShader:es.points_vert,fragmentShader:es.points_frag},dashed:{uniforms:$s([On.common,On.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:es.linedashed_vert,fragmentShader:es.linedashed_frag},depth:{uniforms:$s([On.common,On.displacementmap]),vertexShader:es.depth_vert,fragmentShader:es.depth_frag},normal:{uniforms:$s([On.common,On.bumpmap,On.normalmap,On.displacementmap,{opacity:{value:1}}]),vertexShader:es.meshnormal_vert,fragmentShader:es.meshnormal_frag},sprite:{uniforms:$s([On.sprite,On.fog]),vertexShader:es.sprite_vert,fragmentShader:es.sprite_frag},background:{uniforms:{uvTransform:{value:new jr},t2D:{value:null}},vertexShader:es.background_vert,fragmentShader:es.background_frag},cube:{uniforms:$s([On.envmap,{opacity:{value:1}}]),vertexShader:es.cube_vert,fragmentShader:es.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:es.equirect_vert,fragmentShader:es.equirect_frag},distanceRGBA:{uniforms:$s([On.common,On.displacementmap,{referencePosition:{value:new et},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:es.distanceRGBA_vert,fragmentShader:es.distanceRGBA_frag},shadow:{uniforms:$s([On.lights,On.fog,{color:{value:new un(0)},opacity:{value:1}}]),vertexShader:es.shadow_vert,fragmentShader:es.shadow_frag}};function wp(M,i,c,g,_){const w=new un(0);let A,R,z=0,F=null,W=0,q=null;function J(K,re){c.buffers.color.setClear(K.r,K.g,K.b,re,_)}return{getClearColor:function(){return w},setClearColor:function(K,re=1){w.set(K),z=re,J(w,z)},getClearAlpha:function(){return z},setClearAlpha:function(K){z=K,J(w,z)},render:function(K,re){let ce=!1,Me=re.isScene===!0?re.background:null;Me&&Me.isTexture&&(Me=i.get(Me));const de=M.xr,Xe=de.getSession&&de.getSession();Xe&&Xe.environmentBlendMode==="additive"&&(Me=null),Me===null?J(w,z):Me&&Me.isColor&&(J(Me,1),ce=!0),(M.autoClear||ce)&&M.clear(M.autoClearColor,M.autoClearDepth,M.autoClearStencil),Me&&(Me.isCubeTexture||Me.mapping===306)?(R===void 0&&(R=new oo(new el(1,1,1),new tl({name:"BackgroundCubeMaterial",uniforms:ah(Ta.cube.uniforms),vertexShader:Ta.cube.vertexShader,fragmentShader:Ta.cube.fragmentShader,side:1,depthTest:!1,depthWrite:!1,fog:!1})),R.geometry.deleteAttribute("normal"),R.geometry.deleteAttribute("uv"),R.onBeforeRender=function(nt,Je,gt){this.matrixWorld.copyPosition(gt.matrixWorld)},Object.defineProperty(R.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),g.update(R)),R.material.uniforms.envMap.value=Me,R.material.uniforms.flipEnvMap.value=Me.isCubeTexture&&Me.isRenderTargetTexture===!1?-1:1,F===Me&&W===Me.version&&q===M.toneMapping||(R.material.needsUpdate=!0,F=Me,W=Me.version,q=M.toneMapping),K.unshift(R,R.geometry,R.material,0,0,null)):Me&&Me.isTexture&&(A===void 0&&(A=new oo(new nc(2,2),new tl({name:"BackgroundMaterial",uniforms:ah(Ta.background.uniforms),vertexShader:Ta.background.vertexShader,fragmentShader:Ta.background.fragmentShader,side:0,depthTest:!1,depthWrite:!1,fog:!1})),A.geometry.deleteAttribute("normal"),Object.defineProperty(A.material,"map",{get:function(){return this.uniforms.t2D.value}}),g.update(A)),A.material.uniforms.t2D.value=Me,Me.matrixAutoUpdate===!0&&Me.updateMatrix(),A.material.uniforms.uvTransform.value.copy(Me.matrix),F===Me&&W===Me.version&&q===M.toneMapping||(A.material.needsUpdate=!0,F=Me,W=Me.version,q=M.toneMapping),K.unshift(A,A.geometry,A.material,0,0,null))}}}function Mp(M,i,c,g){const _=M.getParameter(34921),w=g.isWebGL2?null:i.get("OES_vertex_array_object"),A=g.isWebGL2||w!==null,R={},z=J(null);let F=z;function W(Je){return g.isWebGL2?M.bindVertexArray(Je):w.bindVertexArrayOES(Je)}function q(Je){return g.isWebGL2?M.deleteVertexArray(Je):w.deleteVertexArrayOES(Je)}function J(Je){const gt=[],Tt=[],Zt=[];for(let ei=0;ei<_;ei++)gt[ei]=0,Tt[ei]=0,Zt[ei]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:gt,enabledAttributes:Tt,attributeDivisors:Zt,object:Je,attributes:{},index:null}}function K(){const Je=F.newAttributes;for(let gt=0,Tt=Je.length;gt<Tt;gt++)Je[gt]=0}function re(Je){ce(Je,0)}function ce(Je,gt){const Tt=F.newAttributes,Zt=F.enabledAttributes,ei=F.attributeDivisors;Tt[Je]=1,Zt[Je]===0&&(M.enableVertexAttribArray(Je),Zt[Je]=1),ei[Je]!==gt&&((g.isWebGL2?M:i.get("ANGLE_instanced_arrays"))[g.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](Je,gt),ei[Je]=gt)}function Me(){const Je=F.newAttributes,gt=F.enabledAttributes;for(let Tt=0,Zt=gt.length;Tt<Zt;Tt++)gt[Tt]!==Je[Tt]&&(M.disableVertexAttribArray(Tt),gt[Tt]=0)}function de(Je,gt,Tt,Zt,ei,vi){g.isWebGL2!==!0||Tt!==5124&&Tt!==5125?M.vertexAttribPointer(Je,gt,Tt,Zt,ei,vi):M.vertexAttribIPointer(Je,gt,Tt,ei,vi)}function Xe(){nt(),F!==z&&(F=z,W(F.object))}function nt(){z.geometry=null,z.program=null,z.wireframe=!1}return{setup:function(Je,gt,Tt,Zt,ei){let vi=!1;if(A){const Xt=function(xi,In,gn){const Vi=gn.wireframe===!0;let vn=R[xi.id];vn===void 0&&(vn={},R[xi.id]=vn);let $n=vn[In.id];$n===void 0&&($n={},vn[In.id]=$n);let tr=$n[Vi];return tr===void 0&&(tr=J(g.isWebGL2?M.createVertexArray():w.createVertexArrayOES()),$n[Vi]=tr),tr}(Zt,Tt,gt);F!==Xt&&(F=Xt,W(F.object)),vi=function(xi,In){const gn=F.attributes,Vi=xi.attributes;let vn=0;for(const $n in Vi){const tr=gn[$n],mr=Vi[$n];if(tr===void 0||tr.attribute!==mr||tr.data!==mr.data)return!0;vn++}return F.attributesNum!==vn||F.index!==In}(Zt,ei),vi&&function(xi,In){const gn={},Vi=xi.attributes;let vn=0;for(const $n in Vi){const tr=Vi[$n],mr={};mr.attribute=tr,tr.data&&(mr.data=tr.data),gn[$n]=mr,vn++}F.attributes=gn,F.attributesNum=vn,F.index=In}(Zt,ei)}else{const Xt=gt.wireframe===!0;F.geometry===Zt.id&&F.program===Tt.id&&F.wireframe===Xt||(F.geometry=Zt.id,F.program=Tt.id,F.wireframe=Xt,vi=!0)}Je.isInstancedMesh===!0&&(vi=!0),ei!==null&&c.update(ei,34963),vi&&(function(Xt,xi,In,gn){if(g.isWebGL2===!1&&(Xt.isInstancedMesh||gn.isInstancedBufferGeometry)&&i.get("ANGLE_instanced_arrays")===null)return;K();const Vi=gn.attributes,vn=In.getAttributes(),$n=xi.defaultAttributeValues;for(const tr in vn){const mr=vn[tr];if(mr.location>=0){let Ar=Vi[tr];if(Ar===void 0&&(tr==="instanceMatrix"&&Xt.instanceMatrix&&(Ar=Xt.instanceMatrix),tr==="instanceColor"&&Xt.instanceColor&&(Ar=Xt.instanceColor)),Ar!==void 0){const hr=Ar.normalized,mn=Ar.itemSize,wt=c.get(Ar);if(wt===void 0)continue;const Dt=wt.buffer,Xi=wt.type,Li=wt.bytesPerElement;if(Ar.isInterleavedBufferAttribute){const gi=Ar.data,An=gi.stride,Cn=Ar.offset;if(gi&&gi.isInstancedInterleavedBuffer){for(let Ti=0;Ti<mr.locationSize;Ti++)ce(mr.location+Ti,gi.meshPerAttribute);Xt.isInstancedMesh!==!0&&gn._maxInstanceCount===void 0&&(gn._maxInstanceCount=gi.meshPerAttribute*gi.count)}else for(let Ti=0;Ti<mr.locationSize;Ti++)re(mr.location+Ti);M.bindBuffer(34962,Dt);for(let Ti=0;Ti<mr.locationSize;Ti++)de(mr.location+Ti,mn/mr.locationSize,Xi,hr,An*Li,(Cn+mn/mr.locationSize*Ti)*Li)}else{if(Ar.isInstancedBufferAttribute){for(let gi=0;gi<mr.locationSize;gi++)ce(mr.location+gi,Ar.meshPerAttribute);Xt.isInstancedMesh!==!0&&gn._maxInstanceCount===void 0&&(gn._maxInstanceCount=Ar.meshPerAttribute*Ar.count)}else for(let gi=0;gi<mr.locationSize;gi++)re(mr.location+gi);M.bindBuffer(34962,Dt);for(let gi=0;gi<mr.locationSize;gi++)de(mr.location+gi,mn/mr.locationSize,Xi,hr,mn*Li,mn/mr.locationSize*gi*Li)}}else if($n!==void 0){const hr=$n[tr];if(hr!==void 0)switch(hr.length){case 2:M.vertexAttrib2fv(mr.location,hr);break;case 3:M.vertexAttrib3fv(mr.location,hr);break;case 4:M.vertexAttrib4fv(mr.location,hr);break;default:M.vertexAttrib1fv(mr.location,hr)}}}}Me()}(Je,gt,Tt,Zt),ei!==null&&M.bindBuffer(34963,c.get(ei).buffer))},reset:Xe,resetDefaultState:nt,dispose:function(){Xe();for(const Je in R){const gt=R[Je];for(const Tt in gt){const Zt=gt[Tt];for(const ei in Zt)q(Zt[ei].object),delete Zt[ei];delete gt[Tt]}delete R[Je]}},releaseStatesOfGeometry:function(Je){if(R[Je.id]===void 0)return;const gt=R[Je.id];for(const Tt in gt){const Zt=gt[Tt];for(const ei in Zt)q(Zt[ei].object),delete Zt[ei];delete gt[Tt]}delete R[Je.id]},releaseStatesOfProgram:function(Je){for(const gt in R){const Tt=R[gt];if(Tt[Je.id]===void 0)continue;const Zt=Tt[Je.id];for(const ei in Zt)q(Zt[ei].object),delete Zt[ei];delete Tt[Je.id]}},initAttributes:K,enableAttribute:re,disableUnusedAttributes:Me}}function qf(M,i,c,g){const _=g.isWebGL2;let w;this.setMode=function(A){w=A},this.render=function(A,R){M.drawArrays(w,A,R),c.update(R,w,1)},this.renderInstances=function(A,R,z){if(z===0)return;let F,W;if(_)F=M,W="drawArraysInstanced";else if(F=i.get("ANGLE_instanced_arrays"),W="drawArraysInstancedANGLE",F===null)return void console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");F[W](w,A,R,z),c.update(R,w,z)}}function nl(M,i,c){let g;function _(Je){if(Je==="highp"){if(M.getShaderPrecisionFormat(35633,36338).precision>0&&M.getShaderPrecisionFormat(35632,36338).precision>0)return"highp";Je="mediump"}return Je==="mediump"&&M.getShaderPrecisionFormat(35633,36337).precision>0&&M.getShaderPrecisionFormat(35632,36337).precision>0?"mediump":"lowp"}const w=typeof WebGL2RenderingContext<"u"&&M instanceof WebGL2RenderingContext||typeof WebGL2ComputeRenderingContext<"u"&&M instanceof WebGL2ComputeRenderingContext;let A=c.precision!==void 0?c.precision:"highp";const R=_(A);R!==A&&(console.warn("THREE.WebGLRenderer:",A,"not supported, using",R,"instead."),A=R);const z=w||i.has("WEBGL_draw_buffers"),F=c.logarithmicDepthBuffer===!0,W=M.getParameter(34930),q=M.getParameter(35660),J=M.getParameter(3379),K=M.getParameter(34076),re=M.getParameter(34921),ce=M.getParameter(36347),Me=M.getParameter(36348),de=M.getParameter(36349),Xe=q>0,nt=w||i.has("OES_texture_float");return{isWebGL2:w,drawBuffers:z,getMaxAnisotropy:function(){if(g!==void 0)return g;if(i.has("EXT_texture_filter_anisotropic")===!0){const Je=i.get("EXT_texture_filter_anisotropic");g=M.getParameter(Je.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else g=0;return g},getMaxPrecision:_,precision:A,logarithmicDepthBuffer:F,maxTextures:W,maxVertexTextures:q,maxTextureSize:J,maxCubemapSize:K,maxAttributes:re,maxVertexUniforms:ce,maxVaryings:Me,maxFragmentUniforms:de,vertexTextures:Xe,floatFragmentTextures:nt,floatVertexTextures:Xe&&nt,maxSamples:w?M.getParameter(36183):0}}function ch(M){const i=this;let c=null,g=0,_=!1,w=!1;const A=new Ma,R=new jr,z={value:null,needsUpdate:!1};function F(){z.value!==c&&(z.value=c,z.needsUpdate=g>0),i.numPlanes=g,i.numIntersection=0}function W(q,J,K,re){const ce=q!==null?q.length:0;let Me=null;if(ce!==0){if(Me=z.value,re!==!0||Me===null){const de=K+4*ce,Xe=J.matrixWorldInverse;R.getNormalMatrix(Xe),(Me===null||Me.length<de)&&(Me=new Float32Array(de));for(let nt=0,Je=K;nt!==ce;++nt,Je+=4)A.copy(q[nt]).applyMatrix4(Xe,R),A.normal.toArray(Me,Je),Me[Je+3]=A.constant}z.value=Me,z.needsUpdate=!0}return i.numPlanes=ce,i.numIntersection=0,Me}this.uniform=z,this.numPlanes=0,this.numIntersection=0,this.init=function(q,J,K){const re=q.length!==0||J||g!==0||_;return _=J,c=W(q,K,0),g=q.length,re},this.beginShadows=function(){w=!0,W(null)},this.endShadows=function(){w=!1,F()},this.setState=function(q,J,K){const re=q.clippingPlanes,ce=q.clipIntersection,Me=q.clipShadows,de=M.get(q);if(!_||re===null||re.length===0||w&&!Me)w?W(null):F();else{const Xe=w?0:g,nt=4*Xe;let Je=de.clippingState||null;z.value=Je,Je=W(re,J,nt,K);for(let gt=0;gt!==nt;++gt)Je[gt]=c[gt];de.clippingState=Je,this.numIntersection=ce?this.numPlanes:0,this.numPlanes+=Xe}}}function Zf(M){let i=new WeakMap;function c(_,w){return w===303?_.mapping=301:w===304&&(_.mapping=302),_}function g(_){const w=_.target;w.removeEventListener("dispose",g);const A=i.get(w);A!==void 0&&(i.delete(w),A.dispose())}return{get:function(_){if(_&&_.isTexture&&_.isRenderTargetTexture===!1){const w=_.mapping;if(w===303||w===304){if(i.has(_))return c(i.get(_).texture,_.mapping);{const A=_.image;if(A&&A.height>0){const R=M.getRenderTarget(),z=new lh(A.height/2);return z.fromEquirectangularTexture(M,_),i.set(_,z),M.setRenderTarget(R),_.addEventListener("dispose",g),c(z.texture,_.mapping)}return null}}}return _},dispose:function(){i=new WeakMap}}}Ta.physical={uniforms:$s([Ta.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatNormalScale:{value:new Ri(1,1)},clearcoatNormalMap:{value:null},sheenTint:{value:new un(0)},transmission:{value:0},transmissionMap:{value:null},transmissionSamplerSize:{value:new Ri},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},attenuationDistance:{value:0},attenuationTint:{value:new un(0)},specularIntensity:{value:0},specularIntensityMap:{value:null},specularTint:{value:new un(1,1,1)},specularTintMap:{value:null}}]),vertexShader:es.meshphysical_vert,fragmentShader:es.meshphysical_frag};class Hh extends Ql{constructor(i=-1,c=1,g=1,_=-1,w=.1,A=2e3){super(),this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=i,this.right=c,this.top=g,this.bottom=_,this.near=w,this.far=A,this.updateProjectionMatrix()}copy(i,c){return super.copy(i,c),this.left=i.left,this.right=i.right,this.top=i.top,this.bottom=i.bottom,this.near=i.near,this.far=i.far,this.zoom=i.zoom,this.view=i.view===null?null:Object.assign({},i.view),this}setViewOffset(i,c,g,_,w,A){this.view===null&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=i,this.view.fullHeight=c,this.view.offsetX=g,this.view.offsetY=_,this.view.width=w,this.view.height=A,this.updateProjectionMatrix()}clearViewOffset(){this.view!==null&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const i=(this.right-this.left)/(2*this.zoom),c=(this.top-this.bottom)/(2*this.zoom),g=(this.right+this.left)/2,_=(this.top+this.bottom)/2;let w=g-i,A=g+i,R=_+c,z=_-c;if(this.view!==null&&this.view.enabled){const F=(this.right-this.left)/this.view.fullWidth/this.zoom,W=(this.top-this.bottom)/this.view.fullHeight/this.zoom;w+=F*this.view.offsetX,A=w+F*this.view.width,R-=W*this.view.offsetY,z=R-W*this.view.height}this.projectionMatrix.makeOrthographic(w,A,R,z,this.near,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(i){const c=super.toJSON(i);return c.object.zoom=this.zoom,c.object.left=this.left,c.object.right=this.right,c.object.top=this.top,c.object.bottom=this.bottom,c.object.near=this.near,c.object.far=this.far,this.view!==null&&(c.object.view=Object.assign({},this.view)),c}}Hh.prototype.isOrthographicCamera=!0;class Ll extends tl{constructor(i){super(i),this.type="RawShaderMaterial"}}Ll.prototype.isRawShaderMaterial=!0;const Sa=Math.pow(2,8),Sd=[.125,.215,.35,.446,.526,.582],Ru=5+Sd.length,Ed=20,rl={3e3:0,3001:1,3002:2,3004:3,3005:4,3006:5,3007:6},Du=new Hh,{_lodPlanes:jh,_sizeLods:zu,_sigmas:rc}=Fu(),Tp=new un;let sc=null;const sl=(1+Math.sqrt(5))/2,Wh=1/sl,Xf=[new et(1,1,1),new et(-1,1,1),new et(1,1,-1),new et(-1,1,-1),new et(0,sl,Wh),new et(0,sl,-Wh),new et(Wh,0,sl),new et(-Wh,0,sl),new et(sl,Wh,0),new et(-sl,Wh,0)];class Ou{constructor(i){this._renderer=i,this._pingPongRenderTarget=null,this._blurMaterial=function(c){const g=new Float32Array(c),_=new et(0,1,0);return new Ll({name:"SphericalGaussianBlur",defines:{n:c},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:g},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:_},inputEncoding:{value:rl[3e3]},outputEncoding:{value:rl[3e3]}},vertexShader:oc(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			varying vec3 vOutputDirection;

			uniform sampler2D envMap;
			uniform int samples;
			uniform float weights[ n ];
			uniform bool latitudinal;
			uniform float dTheta;
			uniform float mipInt;
			uniform vec3 poleAxis;

			${Cd()}

			#define ENVMAP_TYPE_CUBE_UV
			#include <cube_uv_reflection_fragment>

			vec3 getSample( float theta, vec3 axis ) {

				float cosTheta = cos( theta );
				// Rodrigues' axis-angle rotation
				vec3 sampleDirection = vOutputDirection * cosTheta
					+ cross( axis, vOutputDirection ) * sin( theta )
					+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );

				return bilinearCubeUV( envMap, sampleDirection, mipInt );

			}

			void main() {

				vec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );

				if ( all( equal( axis, vec3( 0.0 ) ) ) ) {

					axis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );

				}

				axis = normalize( axis );

				gl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );
				gl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );

				for ( int i = 1; i < n; i++ ) {

					if ( i >= samples ) {

						break;

					}

					float theta = dTheta * float( i );
					gl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );
					gl_FragColor.rgb += weights[ i ] * getSample( theta, axis );

				}

				gl_FragColor = linearToOutputTexel( gl_FragColor );

			}
		`,blending:0,depthTest:!1,depthWrite:!1})}(Ed),this._equirectShader=null,this._cubemapShader=null,this._compileMaterial(this._blurMaterial)}fromScene(i,c=0,g=.1,_=100){sc=this._renderer.getRenderTarget();const w=this._allocateTargets();return this._sceneToCubeUV(i,g,_,w),c>0&&this._blur(w,0,0,c),this._applyPMREM(w),this._cleanup(w),w}fromEquirectangular(i){return this._fromTexture(i)}fromCubemap(i){return this._fromTexture(i)}compileCubemapShader(){this._cubemapShader===null&&(this._cubemapShader=Ad(),this._compileMaterial(this._cubemapShader))}compileEquirectangularShader(){this._equirectShader===null&&(this._equirectShader=Ep(),this._compileMaterial(this._equirectShader))}dispose(){this._blurMaterial.dispose(),this._cubemapShader!==null&&this._cubemapShader.dispose(),this._equirectShader!==null&&this._equirectShader.dispose();for(let i=0;i<jh.length;i++)jh[i].dispose()}_cleanup(i){this._pingPongRenderTarget.dispose(),this._renderer.setRenderTarget(sc),i.scissorTest=!1,Na(i,0,0,i.width,i.height)}_fromTexture(i){sc=this._renderer.getRenderTarget();const c=this._allocateTargets(i);return this._textureToCubeUV(i,c),this._applyPMREM(c),this._cleanup(c),c}_allocateTargets(i){const c={magFilter:1003,minFilter:1003,generateMipmaps:!1,type:1009,format:1023,encoding:Sp(i)?i.encoding:3002,depthBuffer:!1},g=pa(c);return g.depthBuffer=!i,this._pingPongRenderTarget=pa(c),g}_compileMaterial(i){const c=new oo(jh[0],i);this._renderer.compile(c,Du)}_sceneToCubeUV(i,c,g,_){const w=new go(90,1,c,g),A=[1,-1,1,1,1,1],R=[1,1,1,-1,-1,-1],z=this._renderer,F=z.autoClear,W=z.outputEncoding,q=z.toneMapping;z.getClearColor(Tp),z.toneMapping=0,z.outputEncoding=3e3,z.autoClear=!1;const J=new fs({name:"PMREM.Background",side:1,depthWrite:!1,depthTest:!1}),K=new oo(new el,J);let re=!1;const ce=i.background;ce?ce.isColor&&(J.color.copy(ce),i.background=null,re=!0):(J.color.copy(Tp),re=!0);for(let Me=0;Me<6;Me++){const de=Me%3;de==0?(w.up.set(0,A[Me],0),w.lookAt(R[Me],0,0)):de==1?(w.up.set(0,0,A[Me]),w.lookAt(0,R[Me],0)):(w.up.set(0,A[Me],0),w.lookAt(0,0,R[Me])),Na(_,de*Sa,Me>2?Sa:0,Sa,Sa),z.setRenderTarget(_),re&&z.render(K,w),z.render(i,w)}K.geometry.dispose(),K.material.dispose(),z.toneMapping=q,z.outputEncoding=W,z.autoClear=F,i.background=ce}_textureToCubeUV(i,c){const g=this._renderer;i.isCubeTexture?this._cubemapShader==null&&(this._cubemapShader=Ad()):this._equirectShader==null&&(this._equirectShader=Ep());const _=i.isCubeTexture?this._cubemapShader:this._equirectShader,w=new oo(jh[0],_),A=_.uniforms;A.envMap.value=i,i.isCubeTexture||A.texelSize.value.set(1/i.image.width,1/i.image.height),A.inputEncoding.value=rl[i.encoding],A.outputEncoding.value=rl[c.texture.encoding],Na(c,0,0,3*Sa,2*Sa),g.setRenderTarget(c),g.render(w,Du)}_applyPMREM(i){const c=this._renderer,g=c.autoClear;c.autoClear=!1;for(let _=1;_<Ru;_++){const w=Math.sqrt(rc[_]*rc[_]-rc[_-1]*rc[_-1]),A=Xf[(_-1)%Xf.length];this._blur(i,_-1,_,w,A)}c.autoClear=g}_blur(i,c,g,_,w){const A=this._pingPongRenderTarget;this._halfBlur(i,A,c,g,_,"latitudinal",w),this._halfBlur(A,i,g,g,_,"longitudinal",w)}_halfBlur(i,c,g,_,w,A,R){const z=this._renderer,F=this._blurMaterial;A!=="latitudinal"&&A!=="longitudinal"&&console.error("blur direction must be either latitudinal or longitudinal!");const W=new oo(jh[_],F),q=F.uniforms,J=zu[g]-1,K=isFinite(w)?Math.PI/(2*J):2*Math.PI/39,re=w/K,ce=isFinite(w)?1+Math.floor(3*re):Ed;ce>Ed&&console.warn(`sigmaRadians, ${w}, is too large and will clip, as it requested ${ce} samples when the maximum is set to 20`);const Me=[];let de=0;for(let nt=0;nt<Ed;++nt){const Je=nt/re,gt=Math.exp(-Je*Je/2);Me.push(gt),nt==0?de+=gt:nt<ce&&(de+=2*gt)}for(let nt=0;nt<Me.length;nt++)Me[nt]=Me[nt]/de;q.envMap.value=i.texture,q.samples.value=ce,q.weights.value=Me,q.latitudinal.value=A==="latitudinal",R&&(q.poleAxis.value=R),q.dTheta.value=K,q.mipInt.value=8-g,q.inputEncoding.value=rl[i.texture.encoding],q.outputEncoding.value=rl[i.texture.encoding];const Xe=zu[_];Na(c,3*Math.max(0,Sa-2*Xe),(_===0?0:2*Sa)+2*Xe*(_>4?_-8+4:0),3*Xe,2*Xe),z.setRenderTarget(c),z.render(W,Du)}}function Sp(M){return M!==void 0&&M.type===1009&&(M.encoding===3e3||M.encoding===3001||M.encoding===3007)}function Fu(){const M=[],i=[],c=[];let g=8;for(let _=0;_<Ru;_++){const w=Math.pow(2,g);i.push(w);let A=1/w;_>4?A=Sd[_-8+4-1]:_==0&&(A=0),c.push(A);const R=1/(w-1),z=-R/2,F=1+R/2,W=[z,z,F,z,F,F,z,z,F,F,z,F],q=6,J=6,K=3,re=2,ce=1,Me=new Float32Array(K*J*q),de=new Float32Array(re*J*q),Xe=new Float32Array(ce*J*q);for(let Je=0;Je<q;Je++){const gt=Je%3*2/3-1,Tt=Je>2?0:-1,Zt=[gt,Tt,0,gt+2/3,Tt,0,gt+2/3,Tt+1,0,gt,Tt,0,gt+2/3,Tt+1,0,gt,Tt+1,0];Me.set(Zt,K*J*Je),de.set(W,re*J*Je);const ei=[Je,Je,Je,Je,Je,Je];Xe.set(ei,ce*J*Je)}const nt=new Er;nt.setAttribute("position",new pn(Me,K)),nt.setAttribute("uv",new pn(de,re)),nt.setAttribute("faceIndex",new pn(Xe,ce)),M.push(nt),g>4&&g--}return{_lodPlanes:M,_sizeLods:i,_sigmas:c}}function pa(M){const i=new Bs(3*Sa,3*Sa,M);return i.texture.mapping=306,i.texture.name="PMREM.cubeUv",i.scissorTest=!0,i}function Na(M,i,c,g,_){M.viewport.set(i,c,g,_),M.scissor.set(i,c,g,_)}function Ep(){const M=new Ri(1,1);return new Ll({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null},texelSize:{value:M},inputEncoding:{value:rl[3e3]},outputEncoding:{value:rl[3e3]}},vertexShader:oc(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			varying vec3 vOutputDirection;

			uniform sampler2D envMap;
			uniform vec2 texelSize;

			${Cd()}

			#include <common>

			void main() {

				gl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );

				vec3 outputDirection = normalize( vOutputDirection );
				vec2 uv = equirectUv( outputDirection );

				vec2 f = fract( uv / texelSize - 0.5 );
				uv -= f * texelSize;
				vec3 tl = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;
				uv.x += texelSize.x;
				vec3 tr = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;
				uv.y += texelSize.y;
				vec3 br = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;
				uv.x -= texelSize.x;
				vec3 bl = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;

				vec3 tm = mix( tl, tr, f.x );
				vec3 bm = mix( bl, br, f.x );
				gl_FragColor.rgb = mix( tm, bm, f.y );

				gl_FragColor = linearToOutputTexel( gl_FragColor );

			}
		`,blending:0,depthTest:!1,depthWrite:!1})}function Ad(){return new Ll({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},inputEncoding:{value:rl[3e3]},outputEncoding:{value:rl[3e3]}},vertexShader:oc(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			varying vec3 vOutputDirection;

			uniform samplerCube envMap;

			${Cd()}

			void main() {

				gl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );
				gl_FragColor.rgb = envMapTexelToLinear( textureCube( envMap, vec3( - vOutputDirection.x, vOutputDirection.yz ) ) ).rgb;
				gl_FragColor = linearToOutputTexel( gl_FragColor );

			}
		`,blending:0,depthTest:!1,depthWrite:!1})}function oc(){return`

		precision mediump float;
		precision mediump int;

		attribute vec3 position;
		attribute vec2 uv;
		attribute float faceIndex;

		varying vec3 vOutputDirection;

		// RH coordinate system; PMREM face-indexing convention
		vec3 getDirection( vec2 uv, float face ) {

			uv = 2.0 * uv - 1.0;

			vec3 direction = vec3( uv, 1.0 );

			if ( face == 0.0 ) {

				direction = direction.zyx; // ( 1, v, u ) pos x

			} else if ( face == 1.0 ) {

				direction = direction.xzy;
				direction.xz *= -1.0; // ( -u, 1, -v ) pos y

			} else if ( face == 2.0 ) {

				direction.x *= -1.0; // ( -u, v, 1 ) pos z

			} else if ( face == 3.0 ) {

				direction = direction.zyx;
				direction.xz *= -1.0; // ( -1, v, -u ) neg x

			} else if ( face == 4.0 ) {

				direction = direction.xzy;
				direction.xy *= -1.0; // ( -u, -1, v ) neg y

			} else if ( face == 5.0 ) {

				direction.z *= -1.0; // ( u, v, -1 ) neg z

			}

			return direction;

		}

		void main() {

			vOutputDirection = getDirection( uv, faceIndex );
			gl_Position = vec4( position, 1.0 );

		}
	`}function Cd(){return`

		uniform int inputEncoding;
		uniform int outputEncoding;

		#include <encodings_pars_fragment>

		vec4 inputTexelToLinear( vec4 value ) {

			if ( inputEncoding == 0 ) {

				return value;

			} else if ( inputEncoding == 1 ) {

				return sRGBToLinear( value );

			} else if ( inputEncoding == 2 ) {

				return RGBEToLinear( value );

			} else if ( inputEncoding == 3 ) {

				return RGBMToLinear( value, 7.0 );

			} else if ( inputEncoding == 4 ) {

				return RGBMToLinear( value, 16.0 );

			} else if ( inputEncoding == 5 ) {

				return RGBDToLinear( value, 256.0 );

			} else {

				return GammaToLinear( value, 2.2 );

			}

		}

		vec4 linearToOutputTexel( vec4 value ) {

			if ( outputEncoding == 0 ) {

				return value;

			} else if ( outputEncoding == 1 ) {

				return LinearTosRGB( value );

			} else if ( outputEncoding == 2 ) {

				return LinearToRGBE( value );

			} else if ( outputEncoding == 3 ) {

				return LinearToRGBM( value, 7.0 );

			} else if ( outputEncoding == 4 ) {

				return LinearToRGBM( value, 16.0 );

			} else if ( outputEncoding == 5 ) {

				return LinearToRGBD( value, 256.0 );

			} else {

				return LinearToGamma( value, 2.2 );

			}

		}

		vec4 envMapTexelToLinear( vec4 color ) {

			return inputTexelToLinear( color );

		}
	`}function Ld(M){let i=new WeakMap,c=null;function g(_){const w=_.target;w.removeEventListener("dispose",g);const A=i.get(w);A!==void 0&&(i.delete(w),A.dispose())}return{get:function(_){if(_&&_.isTexture&&_.isRenderTargetTexture===!1){const w=_.mapping,A=w===303||w===304,R=w===301||w===302;if(A||R){if(i.has(_))return i.get(_).texture;{const z=_.image;if(A&&z&&z.height>0||R&&z&&function(F){let W=0;const q=6;for(let J=0;J<q;J++)F[J]!==void 0&&W++;return W===q}(z)){const F=M.getRenderTarget();c===null&&(c=new Ou(M));const W=A?c.fromEquirectangular(_):c.fromCubemap(_);return i.set(_,W),M.setRenderTarget(F),_.addEventListener("dispose",g),W.texture}return null}}}return _},dispose:function(){i=new WeakMap,c!==null&&(c.dispose(),c=null)}}}function Id(M){const i={};function c(g){if(i[g]!==void 0)return i[g];let _;switch(g){case"WEBGL_depth_texture":_=M.getExtension("WEBGL_depth_texture")||M.getExtension("MOZ_WEBGL_depth_texture")||M.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":_=M.getExtension("EXT_texture_filter_anisotropic")||M.getExtension("MOZ_EXT_texture_filter_anisotropic")||M.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":_=M.getExtension("WEBGL_compressed_texture_s3tc")||M.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||M.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":_=M.getExtension("WEBGL_compressed_texture_pvrtc")||M.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:_=M.getExtension(g)}return i[g]=_,_}return{has:function(g){return c(g)!==null},init:function(g){g.isWebGL2?c("EXT_color_buffer_float"):(c("WEBGL_depth_texture"),c("OES_texture_float"),c("OES_texture_half_float"),c("OES_texture_half_float_linear"),c("OES_standard_derivatives"),c("OES_element_index_uint"),c("OES_vertex_array_object"),c("ANGLE_instanced_arrays")),c("OES_texture_float_linear"),c("EXT_color_buffer_half_float")},get:function(g){const _=c(g);return _===null&&console.warn("THREE.WebGLRenderer: "+g+" extension not supported."),_}}}function qh(M,i,c,g){const _={},w=new WeakMap;function A(z){const F=z.target;F.index!==null&&i.remove(F.index);for(const q in F.attributes)i.remove(F.attributes[q]);F.removeEventListener("dispose",A),delete _[F.id];const W=w.get(F);W&&(i.remove(W),w.delete(F)),g.releaseStatesOfGeometry(F),F.isInstancedBufferGeometry===!0&&delete F._maxInstanceCount,c.memory.geometries--}function R(z){const F=[],W=z.index,q=z.attributes.position;let J=0;if(W!==null){const ce=W.array;J=W.version;for(let Me=0,de=ce.length;Me<de;Me+=3){const Xe=ce[Me+0],nt=ce[Me+1],Je=ce[Me+2];F.push(Xe,nt,nt,Je,Je,Xe)}}else{const ce=q.array;J=q.version;for(let Me=0,de=ce.length/3-1;Me<de;Me+=3){const Xe=Me+0,nt=Me+1,Je=Me+2;F.push(Xe,nt,nt,Je,Je,Xe)}}const K=new(vc(F)>65535?Xs:Ls)(F,1);K.version=J;const re=w.get(z);re&&i.remove(re),w.set(z,K)}return{get:function(z,F){return _[F.id]===!0||(F.addEventListener("dispose",A),_[F.id]=!0,c.memory.geometries++),F},update:function(z){const F=z.attributes;for(const q in F)i.update(F[q],34962);const W=z.morphAttributes;for(const q in W){const J=W[q];for(let K=0,re=J.length;K<re;K++)i.update(J[K],34962)}},getWireframeAttribute:function(z){const F=w.get(z);if(F){const W=z.index;W!==null&&F.version<W.version&&R(z)}else R(z);return w.get(z)}}}function Ap(M,i,c,g){const _=g.isWebGL2;let w,A,R;this.setMode=function(z){w=z},this.setIndex=function(z){A=z.type,R=z.bytesPerElement},this.render=function(z,F){M.drawElements(w,F,A,z*R),c.update(F,w,1)},this.renderInstances=function(z,F,W){if(W===0)return;let q,J;if(_)q=M,J="drawElementsInstanced";else if(q=i.get("ANGLE_instanced_arrays"),J="drawElementsInstancedANGLE",q===null)return void console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");q[J](w,F,A,z*R,W),c.update(F,w,W)}}function Yr(M){const i={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:i,programs:null,autoReset:!0,reset:function(){i.frame++,i.calls=0,i.triangles=0,i.points=0,i.lines=0},update:function(c,g,_){switch(i.calls++,g){case 4:i.triangles+=_*(c/3);break;case 1:i.lines+=_*(c/2);break;case 3:i.lines+=_*(c-1);break;case 2:i.lines+=_*c;break;case 0:i.points+=_*c;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",g)}}}}function dg(M,i){return M[0]-i[0]}function Qn(M,i){return Math.abs(i[1])-Math.abs(M[1])}function $f(M){const i={},c=new Float32Array(8),g=[];for(let _=0;_<8;_++)g[_]=[_,0];return{update:function(_,w,A,R){const z=_.morphTargetInfluences,F=z===void 0?0:z.length;let W=i[w.id];if(W===void 0||W.length!==F){W=[];for(let ce=0;ce<F;ce++)W[ce]=[ce,0];i[w.id]=W}for(let ce=0;ce<F;ce++){const Me=W[ce];Me[0]=ce,Me[1]=z[ce]}W.sort(Qn);for(let ce=0;ce<8;ce++)ce<F&&W[ce][1]?(g[ce][0]=W[ce][0],g[ce][1]=W[ce][1]):(g[ce][0]=Number.MAX_SAFE_INTEGER,g[ce][1]=0);g.sort(dg);const q=w.morphAttributes.position,J=w.morphAttributes.normal;let K=0;for(let ce=0;ce<8;ce++){const Me=g[ce],de=Me[0],Xe=Me[1];de!==Number.MAX_SAFE_INTEGER&&Xe?(q&&w.getAttribute("morphTarget"+ce)!==q[de]&&w.setAttribute("morphTarget"+ce,q[de]),J&&w.getAttribute("morphNormal"+ce)!==J[de]&&w.setAttribute("morphNormal"+ce,J[de]),c[ce]=Xe,K+=Xe):(q&&w.hasAttribute("morphTarget"+ce)===!0&&w.deleteAttribute("morphTarget"+ce),J&&w.hasAttribute("morphNormal"+ce)===!0&&w.deleteAttribute("morphNormal"+ce),c[ce]=0)}const re=w.morphTargetsRelative?1:1-K;R.getUniforms().setValue(M,"morphTargetBaseInfluence",re),R.getUniforms().setValue(M,"morphTargetInfluences",c)}}}function Pd(M,i,c,g){let _=new WeakMap;function w(A){const R=A.target;R.removeEventListener("dispose",w),c.remove(R.instanceMatrix),R.instanceColor!==null&&c.remove(R.instanceColor)}return{update:function(A){const R=g.render.frame,z=A.geometry,F=i.get(A,z);return _.get(F)!==R&&(i.update(F),_.set(F,R)),A.isInstancedMesh&&(A.hasEventListener("dispose",w)===!1&&A.addEventListener("dispose",w),c.update(A.instanceMatrix,34962),A.instanceColor!==null&&c.update(A.instanceColor,34962)),F},dispose:function(){_=new WeakMap}}}class ku extends ds{constructor(i=null,c=1,g=1,_=1){super(null),this.image={data:i,width:c,height:g,depth:_},this.magFilter=1003,this.minFilter=1003,this.wrapR=1001,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.needsUpdate=!0}}ku.prototype.isDataTexture2DArray=!0;class Ua extends ds{constructor(i=null,c=1,g=1,_=1){super(null),this.image={data:i,width:c,height:g,depth:_},this.magFilter=1003,this.minFilter=1003,this.wrapR=1001,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.needsUpdate=!0}}Ua.prototype.isDataTexture3D=!0;const Rd=new ds,ol=new ku,yn=new Ua,qr=new il,Nr=[],Ea=[],hh=new Float32Array(16),Dr=new Float32Array(9),Zh=new Float32Array(4);function na(M,i,c){const g=M[0];if(g<=0||g>0)return M;const _=i*c;let w=Nr[_];if(w===void 0&&(w=new Float32Array(_),Nr[_]=w),i!==0){g.toArray(w,0);for(let A=1,R=0;A!==i;++A)R+=c,M[A].toArray(w,R)}return w}function So(M,i){if(M.length!==i.length)return!1;for(let c=0,g=M.length;c<g;c++)if(M[c]!==i[c])return!1;return!0}function zs(M,i){for(let c=0,g=i.length;c<g;c++)M[c]=i[c]}function qs(M,i){let c=Ea[i];c===void 0&&(c=new Int32Array(i),Ea[i]=c);for(let g=0;g!==i;++g)c[g]=M.allocateTextureUnit();return c}function pg(M,i){const c=this.cache;c[0]!==i&&(M.uniform1f(this.addr,i),c[0]=i)}function Bu(M,i){const c=this.cache;if(i.x!==void 0)c[0]===i.x&&c[1]===i.y||(M.uniform2f(this.addr,i.x,i.y),c[0]=i.x,c[1]=i.y);else{if(So(c,i))return;M.uniform2fv(this.addr,i),zs(c,i)}}function Dd(M,i){const c=this.cache;if(i.x!==void 0)c[0]===i.x&&c[1]===i.y&&c[2]===i.z||(M.uniform3f(this.addr,i.x,i.y,i.z),c[0]=i.x,c[1]=i.y,c[2]=i.z);else if(i.r!==void 0)c[0]===i.r&&c[1]===i.g&&c[2]===i.b||(M.uniform3f(this.addr,i.r,i.g,i.b),c[0]=i.r,c[1]=i.g,c[2]=i.b);else{if(So(c,i))return;M.uniform3fv(this.addr,i),zs(c,i)}}function uh(M,i){const c=this.cache;if(i.x!==void 0)c[0]===i.x&&c[1]===i.y&&c[2]===i.z&&c[3]===i.w||(M.uniform4f(this.addr,i.x,i.y,i.z,i.w),c[0]=i.x,c[1]=i.y,c[2]=i.z,c[3]=i.w);else{if(So(c,i))return;M.uniform4fv(this.addr,i),zs(c,i)}}function Xh(M,i){const c=this.cache,g=i.elements;if(g===void 0){if(So(c,i))return;M.uniformMatrix2fv(this.addr,!1,i),zs(c,i)}else{if(So(c,g))return;Zh.set(g),M.uniformMatrix2fv(this.addr,!1,Zh),zs(c,g)}}function Nu(M,i){const c=this.cache,g=i.elements;if(g===void 0){if(So(c,i))return;M.uniformMatrix3fv(this.addr,!1,i),zs(c,i)}else{if(So(c,g))return;Dr.set(g),M.uniformMatrix3fv(this.addr,!1,Dr),zs(c,g)}}function zo(M,i){const c=this.cache,g=i.elements;if(g===void 0){if(So(c,i))return;M.uniformMatrix4fv(this.addr,!1,i),zs(c,i)}else{if(So(c,g))return;hh.set(g),M.uniformMatrix4fv(this.addr,!1,hh),zs(c,g)}}function Aa(M,i){const c=this.cache;c[0]!==i&&(M.uniform1i(this.addr,i),c[0]=i)}function al(M,i){const c=this.cache;So(c,i)||(M.uniform2iv(this.addr,i),zs(c,i))}function $h(M,i){const c=this.cache;So(c,i)||(M.uniform3iv(this.addr,i),zs(c,i))}function Qs(M,i){const c=this.cache;So(c,i)||(M.uniform4iv(this.addr,i),zs(c,i))}function ll(M,i){const c=this.cache;c[0]!==i&&(M.uniform1ui(this.addr,i),c[0]=i)}function ac(M,i){const c=this.cache;So(c,i)||(M.uniform2uiv(this.addr,i),zs(c,i))}function _o(M,i){const c=this.cache;So(c,i)||(M.uniform3uiv(this.addr,i),zs(c,i))}function Cp(M,i){const c=this.cache;So(c,i)||(M.uniform4uiv(this.addr,i),zs(c,i))}function cl(M,i,c){const g=this.cache,_=c.allocateTextureUnit();g[0]!==_&&(M.uniform1i(this.addr,_),g[0]=_),c.safeSetTexture2D(i||Rd,_)}function Uu(M,i,c){const g=this.cache,_=c.allocateTextureUnit();g[0]!==_&&(M.uniform1i(this.addr,_),g[0]=_),c.setTexture3D(i||yn,_)}function Vu(M,i,c){const g=this.cache,_=c.allocateTextureUnit();g[0]!==_&&(M.uniform1i(this.addr,_),g[0]=_),c.safeSetTextureCube(i||qr,_)}function dh(M,i,c){const g=this.cache,_=c.allocateTextureUnit();g[0]!==_&&(M.uniform1i(this.addr,_),g[0]=_),c.setTexture2DArray(i||ol,_)}function Lp(M,i){M.uniform1fv(this.addr,i)}function Il(M,i){const c=na(i,this.size,2);M.uniform2fv(this.addr,c)}function fg(M,i){const c=na(i,this.size,3);M.uniform3fv(this.addr,c)}function zd(M,i){const c=na(i,this.size,4);M.uniform4fv(this.addr,c)}function Zo(M,i){const c=na(i,this.size,4);M.uniformMatrix2fv(this.addr,!1,c)}function Gu(M,i){const c=na(i,this.size,9);M.uniformMatrix3fv(this.addr,!1,c)}function Hu(M,i){const c=na(i,this.size,16);M.uniformMatrix4fv(this.addr,!1,c)}function Yf(M,i){M.uniform1iv(this.addr,i)}function ju(M,i){M.uniform2iv(this.addr,i)}function mg(M,i){M.uniform3iv(this.addr,i)}function Jf(M,i){M.uniform4iv(this.addr,i)}function Wu(M,i){M.uniform1uiv(this.addr,i)}function qu(M,i){M.uniform2uiv(this.addr,i)}function Kf(M,i){M.uniform3uiv(this.addr,i)}function kr(M,i){M.uniform4uiv(this.addr,i)}function Ip(M,i,c){const g=i.length,_=qs(c,g);M.uniform1iv(this.addr,_);for(let w=0;w!==g;++w)c.safeSetTexture2D(i[w]||Rd,_[w])}function Zu(M,i,c){const g=i.length,_=qs(c,g);M.uniform1iv(this.addr,_);for(let w=0;w!==g;++w)c.safeSetTextureCube(i[w]||qr,_[w])}function Sc(M,i,c){this.id=M,this.addr=c,this.cache=[],this.setValue=function(g){switch(g){case 5126:return pg;case 35664:return Bu;case 35665:return Dd;case 35666:return uh;case 35674:return Xh;case 35675:return Nu;case 35676:return zo;case 5124:case 35670:return Aa;case 35667:case 35671:return al;case 35668:case 35672:return $h;case 35669:case 35673:return Qs;case 5125:return ll;case 36294:return ac;case 36295:return _o;case 36296:return Cp;case 35678:case 36198:case 36298:case 36306:case 35682:return cl;case 35679:case 36299:case 36307:return Uu;case 35680:case 36300:case 36308:case 36293:return Vu;case 36289:case 36303:case 36311:case 36292:return dh}}(i.type)}function Qf(M,i,c){this.id=M,this.addr=c,this.cache=[],this.size=i.size,this.setValue=function(g){switch(g){case 5126:return Lp;case 35664:return Il;case 35665:return fg;case 35666:return zd;case 35674:return Zo;case 35675:return Gu;case 35676:return Hu;case 5124:case 35670:return Yf;case 35667:case 35671:return ju;case 35668:case 35672:return mg;case 35669:case 35673:return Jf;case 5125:return Wu;case 36294:return qu;case 36295:return Kf;case 36296:return kr;case 35678:case 36198:case 36298:case 36306:case 35682:return Ip;case 35680:case 36300:case 36308:case 36293:return Zu}}(i.type)}function Xu(M){this.id=M,this.seq=[],this.map={}}Qf.prototype.updateCache=function(M){const i=this.cache;M instanceof Float32Array&&i.length!==M.length&&(this.cache=new Float32Array(M.length)),zs(i,M)},Xu.prototype.setValue=function(M,i,c){const g=this.seq;for(let _=0,w=g.length;_!==w;++_){const A=g[_];A.setValue(M,i[A.id],c)}};const Yh=/(\w+)(\])?(\[|\.)?/g;function Jh(M,i){M.seq.push(i),M.map[i.id]=i}function gg(M,i,c){const g=M.name,_=g.length;for(Yh.lastIndex=0;;){const w=Yh.exec(g),A=Yh.lastIndex;let R=w[1];const z=w[2]==="]",F=w[3];if(z&&(R|=0),F===void 0||F==="["&&A+2===_){Jh(c,F===void 0?new Sc(R,M,i):new Qf(R,M,i));break}{let W=c.map[R];W===void 0&&(W=new Xu(R),Jh(c,W)),c=W}}}function hl(M,i){this.seq=[],this.map={};const c=M.getProgramParameter(i,35718);for(let g=0;g<c;++g){const _=M.getActiveUniform(i,g);gg(_,M.getUniformLocation(i,_.name),this)}}function Va(M,i,c){const g=M.createShader(i);return M.shaderSource(g,c),M.compileShader(g),g}hl.prototype.setValue=function(M,i,c,g){const _=this.map[i];_!==void 0&&_.setValue(M,c,g)},hl.prototype.setOptional=function(M,i,c){const g=i[c];g!==void 0&&this.setValue(M,c,g)},hl.upload=function(M,i,c,g){for(let _=0,w=i.length;_!==w;++_){const A=i[_],R=c[A.id];R.needsUpdate!==!1&&A.setValue(M,R.value,g)}},hl.seqWithValue=function(M,i){const c=[];for(let g=0,_=M.length;g!==_;++g){const w=M[g];w.id in i&&c.push(w)}return c};let em=0;function Od(M){switch(M){case 3e3:return["Linear","( value )"];case 3001:return["sRGB","( value )"];case 3002:return["RGBE","( value )"];case 3004:return["RGBM","( value, 7.0 )"];case 3005:return["RGBM","( value, 16.0 )"];case 3006:return["RGBD","( value, 256.0 )"];case 3007:return["Gamma","( value, float( GAMMA_FACTOR ) )"];case 3003:return["LogLuv","( value )"];default:return console.warn("THREE.WebGLProgram: Unsupported encoding:",M),["Linear","( value )"]}}function ph(M,i,c){const g=M.getShaderParameter(i,35713),_=M.getShaderInfoLog(i).trim();return g&&_===""?"":c.toUpperCase()+`

`+_+`

`+function(w){const A=w.split(`
`);for(let R=0;R<A.length;R++)A[R]=R+1+": "+A[R];return A.join(`
`)}(M.getShaderSource(i))}function fa(M,i){const c=Od(i);return"vec4 "+M+"( vec4 value ) { return "+c[0]+"ToLinear"+c[1]+"; }"}function Fd(M,i){const c=Od(i);return"vec4 "+M+"( vec4 value ) { return LinearTo"+c[0]+c[1]+"; }"}function tm(M,i){let c;switch(i){case 1:c="Linear";break;case 2:c="Reinhard";break;case 3:c="OptimizedCineon";break;case 4:c="ACESFilmic";break;case 5:c="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",i),c="Linear"}return"vec3 "+M+"( vec3 color ) { return "+c+"ToneMapping( color ); }"}function Kh(M){return M!==""}function fh(M,i){return M.replace(/NUM_DIR_LIGHTS/g,i.numDirLights).replace(/NUM_SPOT_LIGHTS/g,i.numSpotLights).replace(/NUM_RECT_AREA_LIGHTS/g,i.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,i.numPointLights).replace(/NUM_HEMI_LIGHTS/g,i.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,i.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS/g,i.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,i.numPointLightShadows)}function Ec(M,i){return M.replace(/NUM_CLIPPING_PLANES/g,i.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,i.numClippingPlanes-i.numClipIntersection)}const im=/^[ \t]*#include +<([\w\d./]+)>/gm;function Ac(M){return M.replace(im,Ga)}function Ga(M,i){const c=es[i];if(c===void 0)throw new Error("Can not resolve #include <"+i+">");return Ac(c)}const Pp=/#pragma unroll_loop[\s]+?for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g,ji=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function Rp(M){return M.replace(ji,kd).replace(Pp,Dp)}function Dp(M,i,c,g){return console.warn("WebGLProgram: #pragma unroll_loop shader syntax is deprecated. Please use #pragma unroll_loop_start syntax instead."),kd(M,i,c,g)}function kd(M,i,c,g){let _="";for(let w=parseInt(i);w<parseInt(c);w++)_+=g.replace(/\[\s*i\s*\]/g,"[ "+w+" ]").replace(/UNROLLED_LOOP_INDEX/g,w);return _}function zp(M){let i="precision "+M.precision+` float;
precision `+M.precision+" int;";return M.precision==="highp"?i+=`
#define HIGH_PRECISION`:M.precision==="mediump"?i+=`
#define MEDIUM_PRECISION`:M.precision==="lowp"&&(i+=`
#define LOW_PRECISION`),i}function $u(M,i,c,g){const _=M.getContext(),w=c.defines;let A=c.vertexShader,R=c.fragmentShader;const z=function(ei){let vi="SHADOWMAP_TYPE_BASIC";return ei.shadowMapType===1?vi="SHADOWMAP_TYPE_PCF":ei.shadowMapType===2?vi="SHADOWMAP_TYPE_PCF_SOFT":ei.shadowMapType===3&&(vi="SHADOWMAP_TYPE_VSM"),vi}(c),F=function(ei){let vi="ENVMAP_TYPE_CUBE";if(ei.envMap)switch(ei.envMapMode){case 301:case 302:vi="ENVMAP_TYPE_CUBE";break;case 306:case 307:vi="ENVMAP_TYPE_CUBE_UV"}return vi}(c),W=function(ei){let vi="ENVMAP_MODE_REFLECTION";if(ei.envMap)switch(ei.envMapMode){case 302:case 307:vi="ENVMAP_MODE_REFRACTION"}return vi}(c),q=function(ei){let vi="ENVMAP_BLENDING_NONE";if(ei.envMap)switch(ei.combine){case 0:vi="ENVMAP_BLENDING_MULTIPLY";break;case 1:vi="ENVMAP_BLENDING_MIX";break;case 2:vi="ENVMAP_BLENDING_ADD"}return vi}(c),J=M.gammaFactor>0?M.gammaFactor:1,K=c.isWebGL2?"":function(ei){return[ei.extensionDerivatives||ei.envMapCubeUV||ei.bumpMap||ei.tangentSpaceNormalMap||ei.clearcoatNormalMap||ei.flatShading||ei.shaderID==="physical"?"#extension GL_OES_standard_derivatives : enable":"",(ei.extensionFragDepth||ei.logarithmicDepthBuffer)&&ei.rendererExtensionFragDepth?"#extension GL_EXT_frag_depth : enable":"",ei.extensionDrawBuffers&&ei.rendererExtensionDrawBuffers?"#extension GL_EXT_draw_buffers : require":"",(ei.extensionShaderTextureLOD||ei.envMap||ei.transmission)&&ei.rendererExtensionShaderTextureLod?"#extension GL_EXT_shader_texture_lod : enable":""].filter(Kh).join(`
`)}(c),re=function(ei){const vi=[];for(const Xt in ei){const xi=ei[Xt];xi!==!1&&vi.push("#define "+Xt+" "+xi)}return vi.join(`
`)}(w),ce=_.createProgram();let Me,de,Xe=c.glslVersion?"#version "+c.glslVersion+`
`:"";c.isRawShaderMaterial?(Me=[re].filter(Kh).join(`
`),Me.length>0&&(Me+=`
`),de=[K,re].filter(Kh).join(`
`),de.length>0&&(de+=`
`)):(Me=[zp(c),"#define SHADER_NAME "+c.shaderName,re,c.instancing?"#define USE_INSTANCING":"",c.instancingColor?"#define USE_INSTANCING_COLOR":"",c.supportsVertexTextures?"#define VERTEX_TEXTURES":"","#define GAMMA_FACTOR "+J,"#define MAX_BONES "+c.maxBones,c.useFog&&c.fog?"#define USE_FOG":"",c.useFog&&c.fogExp2?"#define FOG_EXP2":"",c.map?"#define USE_MAP":"",c.envMap?"#define USE_ENVMAP":"",c.envMap?"#define "+W:"",c.lightMap?"#define USE_LIGHTMAP":"",c.aoMap?"#define USE_AOMAP":"",c.emissiveMap?"#define USE_EMISSIVEMAP":"",c.bumpMap?"#define USE_BUMPMAP":"",c.normalMap?"#define USE_NORMALMAP":"",c.normalMap&&c.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",c.normalMap&&c.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",c.clearcoatMap?"#define USE_CLEARCOATMAP":"",c.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",c.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",c.displacementMap&&c.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",c.specularMap?"#define USE_SPECULARMAP":"",c.specularIntensityMap?"#define USE_SPECULARINTENSITYMAP":"",c.specularTintMap?"#define USE_SPECULARTINTMAP":"",c.roughnessMap?"#define USE_ROUGHNESSMAP":"",c.metalnessMap?"#define USE_METALNESSMAP":"",c.alphaMap?"#define USE_ALPHAMAP":"",c.transmission?"#define USE_TRANSMISSION":"",c.transmissionMap?"#define USE_TRANSMISSIONMAP":"",c.thicknessMap?"#define USE_THICKNESSMAP":"",c.vertexTangents?"#define USE_TANGENT":"",c.vertexColors?"#define USE_COLOR":"",c.vertexAlphas?"#define USE_COLOR_ALPHA":"",c.vertexUvs?"#define USE_UV":"",c.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",c.flatShading?"#define FLAT_SHADED":"",c.skinning?"#define USE_SKINNING":"",c.useVertexTexture?"#define BONE_TEXTURE":"",c.morphTargets?"#define USE_MORPHTARGETS":"",c.morphNormals&&c.flatShading===!1?"#define USE_MORPHNORMALS":"",c.doubleSided?"#define DOUBLE_SIDED":"",c.flipSided?"#define FLIP_SIDED":"",c.shadowMapEnabled?"#define USE_SHADOWMAP":"",c.shadowMapEnabled?"#define "+z:"",c.sizeAttenuation?"#define USE_SIZEATTENUATION":"",c.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",c.logarithmicDepthBuffer&&c.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","	attribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","	attribute vec3 instanceColor;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_TANGENT","	attribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","	attribute vec4 color;","#elif defined( USE_COLOR )","	attribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","	attribute vec3 morphTarget0;","	attribute vec3 morphTarget1;","	attribute vec3 morphTarget2;","	attribute vec3 morphTarget3;","	#ifdef USE_MORPHNORMALS","		attribute vec3 morphNormal0;","		attribute vec3 morphNormal1;","		attribute vec3 morphNormal2;","		attribute vec3 morphNormal3;","	#else","		attribute vec3 morphTarget4;","		attribute vec3 morphTarget5;","		attribute vec3 morphTarget6;","		attribute vec3 morphTarget7;","	#endif","#endif","#ifdef USE_SKINNING","	attribute vec4 skinIndex;","	attribute vec4 skinWeight;","#endif",`
`].filter(Kh).join(`
`),de=[K,zp(c),"#define SHADER_NAME "+c.shaderName,re,"#define GAMMA_FACTOR "+J,c.useFog&&c.fog?"#define USE_FOG":"",c.useFog&&c.fogExp2?"#define FOG_EXP2":"",c.map?"#define USE_MAP":"",c.matcap?"#define USE_MATCAP":"",c.envMap?"#define USE_ENVMAP":"",c.envMap?"#define "+F:"",c.envMap?"#define "+W:"",c.envMap?"#define "+q:"",c.lightMap?"#define USE_LIGHTMAP":"",c.aoMap?"#define USE_AOMAP":"",c.emissiveMap?"#define USE_EMISSIVEMAP":"",c.bumpMap?"#define USE_BUMPMAP":"",c.normalMap?"#define USE_NORMALMAP":"",c.normalMap&&c.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",c.normalMap&&c.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",c.clearcoat?"#define USE_CLEARCOAT":"",c.clearcoatMap?"#define USE_CLEARCOATMAP":"",c.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",c.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",c.specularMap?"#define USE_SPECULARMAP":"",c.specularIntensityMap?"#define USE_SPECULARINTENSITYMAP":"",c.specularTintMap?"#define USE_SPECULARTINTMAP":"",c.roughnessMap?"#define USE_ROUGHNESSMAP":"",c.metalnessMap?"#define USE_METALNESSMAP":"",c.alphaMap?"#define USE_ALPHAMAP":"",c.alphaTest?"#define USE_ALPHATEST":"",c.sheenTint?"#define USE_SHEEN":"",c.transmission?"#define USE_TRANSMISSION":"",c.transmissionMap?"#define USE_TRANSMISSIONMAP":"",c.thicknessMap?"#define USE_THICKNESSMAP":"",c.vertexTangents?"#define USE_TANGENT":"",c.vertexColors||c.instancingColor?"#define USE_COLOR":"",c.vertexAlphas?"#define USE_COLOR_ALPHA":"",c.vertexUvs?"#define USE_UV":"",c.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",c.gradientMap?"#define USE_GRADIENTMAP":"",c.flatShading?"#define FLAT_SHADED":"",c.doubleSided?"#define DOUBLE_SIDED":"",c.flipSided?"#define FLIP_SIDED":"",c.shadowMapEnabled?"#define USE_SHADOWMAP":"",c.shadowMapEnabled?"#define "+z:"",c.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",c.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",c.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",c.logarithmicDepthBuffer&&c.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"",(c.extensionShaderTextureLOD||c.envMap)&&c.rendererExtensionShaderTextureLod?"#define TEXTURE_LOD_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",c.toneMapping!==0?"#define TONE_MAPPING":"",c.toneMapping!==0?es.tonemapping_pars_fragment:"",c.toneMapping!==0?tm("toneMapping",c.toneMapping):"",c.dithering?"#define DITHERING":"",c.format===1022?"#define OPAQUE":"",es.encodings_pars_fragment,c.map?fa("mapTexelToLinear",c.mapEncoding):"",c.matcap?fa("matcapTexelToLinear",c.matcapEncoding):"",c.envMap?fa("envMapTexelToLinear",c.envMapEncoding):"",c.emissiveMap?fa("emissiveMapTexelToLinear",c.emissiveMapEncoding):"",c.specularTintMap?fa("specularTintMapTexelToLinear",c.specularTintMapEncoding):"",c.lightMap?fa("lightMapTexelToLinear",c.lightMapEncoding):"",Fd("linearToOutputTexel",c.outputEncoding),c.depthPacking?"#define DEPTH_PACKING "+c.depthPacking:"",`
`].filter(Kh).join(`
`)),A=Ac(A),A=fh(A,c),A=Ec(A,c),R=Ac(R),R=fh(R,c),R=Ec(R,c),A=Rp(A),R=Rp(R),c.isWebGL2&&c.isRawShaderMaterial!==!0&&(Xe=`#version 300 es
`,Me=["#define attribute in","#define varying out","#define texture2D texture"].join(`
`)+`
`+Me,de=["#define varying in",c.glslVersion===It?"":"out highp vec4 pc_fragColor;",c.glslVersion===It?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join(`
`)+`
`+de);const nt=Xe+de+R,Je=Va(_,35633,Xe+Me+A),gt=Va(_,35632,nt);if(_.attachShader(ce,Je),_.attachShader(ce,gt),c.index0AttributeName!==void 0?_.bindAttribLocation(ce,0,c.index0AttributeName):c.morphTargets===!0&&_.bindAttribLocation(ce,0,"position"),_.linkProgram(ce),M.debug.checkShaderErrors){const ei=_.getProgramInfoLog(ce).trim(),vi=_.getShaderInfoLog(Je).trim(),Xt=_.getShaderInfoLog(gt).trim();let xi=!0,In=!0;if(_.getProgramParameter(ce,35714)===!1){xi=!1;const gn=ph(_,Je,"vertex"),Vi=ph(_,gt,"fragment");console.error("THREE.WebGLProgram: Shader Error "+_.getError()+" - VALIDATE_STATUS "+_.getProgramParameter(ce,35715)+`

Program Info Log: `+ei+`
`+gn+`
`+Vi)}else ei!==""?console.warn("THREE.WebGLProgram: Program Info Log:",ei):vi!==""&&Xt!==""||(In=!1);In&&(this.diagnostics={runnable:xi,programLog:ei,vertexShader:{log:vi,prefix:Me},fragmentShader:{log:Xt,prefix:de}})}let Tt,Zt;return _.deleteShader(Je),_.deleteShader(gt),this.getUniforms=function(){return Tt===void 0&&(Tt=new hl(_,ce)),Tt},this.getAttributes=function(){return Zt===void 0&&(Zt=function(ei,vi){const Xt={},xi=ei.getProgramParameter(vi,35721);for(let In=0;In<xi;In++){const gn=ei.getActiveAttrib(vi,In),Vi=gn.name;let vn=1;gn.type===35674&&(vn=2),gn.type===35675&&(vn=3),gn.type===35676&&(vn=4),Xt[Vi]={type:gn.type,location:ei.getAttribLocation(vi,Vi),locationSize:vn}}return Xt}(_,ce)),Zt},this.destroy=function(){g.releaseStatesOfProgram(this),_.deleteProgram(ce),this.program=void 0},this.name=c.shaderName,this.id=em++,this.cacheKey=i,this.usedTimes=1,this.program=ce,this.vertexShader=Je,this.fragmentShader=gt,this}function ma(M,i,c,g,_,w,A){const R=[],z=_.isWebGL2,F=_.logarithmicDepthBuffer,W=_.floatVertexTextures,q=_.maxVertexUniforms,J=_.vertexTextures;let K=_.precision;const re={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"},ce=["precision","isWebGL2","supportsVertexTextures","outputEncoding","instancing","instancingColor","map","mapEncoding","matcap","matcapEncoding","envMap","envMapMode","envMapEncoding","envMapCubeUV","lightMap","lightMapEncoding","aoMap","emissiveMap","emissiveMapEncoding","bumpMap","normalMap","objectSpaceNormalMap","tangentSpaceNormalMap","clearcoat","clearcoatMap","clearcoatRoughnessMap","clearcoatNormalMap","displacementMap","specularMap","specularIntensityMap","specularTintMap","specularTintMapEncoding","roughnessMap","metalnessMap","gradientMap","alphaMap","alphaTest","combine","vertexColors","vertexAlphas","vertexTangents","vertexUvs","uvsVertexOnly","fog","useFog","fogExp2","flatShading","sizeAttenuation","logarithmicDepthBuffer","skinning","maxBones","useVertexTexture","morphTargets","morphNormals","premultipliedAlpha","numDirLights","numPointLights","numSpotLights","numHemiLights","numRectAreaLights","numDirLightShadows","numPointLightShadows","numSpotLightShadows","shadowMapEnabled","shadowMapType","toneMapping","physicallyCorrectLights","doubleSided","flipSided","numClippingPlanes","numClipIntersection","depthPacking","dithering","format","sheenTint","transmission","transmissionMap","thicknessMap"];function Me(de){let Xe;return de&&de.isTexture?Xe=de.encoding:de&&de.isWebGLRenderTarget?(console.warn("THREE.WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead."),Xe=de.texture.encoding):Xe=3e3,Xe}return{getParameters:function(de,Xe,nt,Je,gt){const Tt=Je.fog,Zt=de.isMeshStandardMaterial?Je.environment:null,ei=(de.isMeshStandardMaterial?c:i).get(de.envMap||Zt),vi=re[de.type],Xt=gt.isSkinnedMesh?function($n){const tr=$n.skeleton.bones;if(W)return 1024;{const mr=q,Ar=Math.floor((mr-20)/4),hr=Math.min(Ar,tr.length);return hr<tr.length?(console.warn("THREE.WebGLRenderer: Skeleton has "+tr.length+" bones. This GPU supports "+hr+"."),0):hr}}(gt):0;let xi,In;if(de.precision!==null&&(K=_.getMaxPrecision(de.precision),K!==de.precision&&console.warn("THREE.WebGLProgram.getParameters:",de.precision,"not supported, using",K,"instead.")),vi){const $n=Ta[vi];xi=$n.vertexShader,In=$n.fragmentShader}else xi=de.vertexShader,In=de.fragmentShader;const gn=M.getRenderTarget(),Vi=de.alphaTest>0,vn=de.clearcoat>0;return{isWebGL2:z,shaderID:vi,shaderName:de.type,vertexShader:xi,fragmentShader:In,defines:de.defines,isRawShaderMaterial:de.isRawShaderMaterial===!0,glslVersion:de.glslVersion,precision:K,instancing:gt.isInstancedMesh===!0,instancingColor:gt.isInstancedMesh===!0&&gt.instanceColor!==null,supportsVertexTextures:J,outputEncoding:gn!==null?Me(gn.texture):M.outputEncoding,map:!!de.map,mapEncoding:Me(de.map),matcap:!!de.matcap,matcapEncoding:Me(de.matcap),envMap:!!ei,envMapMode:ei&&ei.mapping,envMapEncoding:Me(ei),envMapCubeUV:!!ei&&(ei.mapping===306||ei.mapping===307),lightMap:!!de.lightMap,lightMapEncoding:Me(de.lightMap),aoMap:!!de.aoMap,emissiveMap:!!de.emissiveMap,emissiveMapEncoding:Me(de.emissiveMap),bumpMap:!!de.bumpMap,normalMap:!!de.normalMap,objectSpaceNormalMap:de.normalMapType===1,tangentSpaceNormalMap:de.normalMapType===0,clearcoat:vn,clearcoatMap:vn&&!!de.clearcoatMap,clearcoatRoughnessMap:vn&&!!de.clearcoatRoughnessMap,clearcoatNormalMap:vn&&!!de.clearcoatNormalMap,displacementMap:!!de.displacementMap,roughnessMap:!!de.roughnessMap,metalnessMap:!!de.metalnessMap,specularMap:!!de.specularMap,specularIntensityMap:!!de.specularIntensityMap,specularTintMap:!!de.specularTintMap,specularTintMapEncoding:Me(de.specularTintMap),alphaMap:!!de.alphaMap,alphaTest:Vi,gradientMap:!!de.gradientMap,sheenTint:!!de.sheenTint&&(de.sheenTint.r>0||de.sheenTint.g>0||de.sheenTint.b>0),transmission:de.transmission>0,transmissionMap:!!de.transmissionMap,thicknessMap:!!de.thicknessMap,combine:de.combine,vertexTangents:!!de.normalMap&&!!gt.geometry&&!!gt.geometry.attributes.tangent,vertexColors:de.vertexColors,vertexAlphas:de.vertexColors===!0&&!!gt.geometry&&!!gt.geometry.attributes.color&&gt.geometry.attributes.color.itemSize===4,vertexUvs:!!(de.map||de.bumpMap||de.normalMap||de.specularMap||de.alphaMap||de.emissiveMap||de.roughnessMap||de.metalnessMap||de.clearcoatMap||de.clearcoatRoughnessMap||de.clearcoatNormalMap||de.displacementMap||de.transmissionMap||de.thicknessMap||de.specularIntensityMap||de.specularTintMap),uvsVertexOnly:!(de.map||de.bumpMap||de.normalMap||de.specularMap||de.alphaMap||de.emissiveMap||de.roughnessMap||de.metalnessMap||de.clearcoatNormalMap||de.transmission>0||de.transmissionMap||de.thicknessMap||de.specularIntensityMap||de.specularTintMap||!de.displacementMap),fog:!!Tt,useFog:de.fog,fogExp2:Tt&&Tt.isFogExp2,flatShading:!!de.flatShading,sizeAttenuation:de.sizeAttenuation,logarithmicDepthBuffer:F,skinning:gt.isSkinnedMesh===!0&&Xt>0,maxBones:Xt,useVertexTexture:W,morphTargets:!!gt.geometry&&!!gt.geometry.morphAttributes.position,morphNormals:!!gt.geometry&&!!gt.geometry.morphAttributes.normal,numDirLights:Xe.directional.length,numPointLights:Xe.point.length,numSpotLights:Xe.spot.length,numRectAreaLights:Xe.rectArea.length,numHemiLights:Xe.hemi.length,numDirLightShadows:Xe.directionalShadowMap.length,numPointLightShadows:Xe.pointShadowMap.length,numSpotLightShadows:Xe.spotShadowMap.length,numClippingPlanes:A.numPlanes,numClipIntersection:A.numIntersection,format:de.format,dithering:de.dithering,shadowMapEnabled:M.shadowMap.enabled&&nt.length>0,shadowMapType:M.shadowMap.type,toneMapping:de.toneMapped?M.toneMapping:0,physicallyCorrectLights:M.physicallyCorrectLights,premultipliedAlpha:de.premultipliedAlpha,doubleSided:de.side===2,flipSided:de.side===1,depthPacking:de.depthPacking!==void 0&&de.depthPacking,index0AttributeName:de.index0AttributeName,extensionDerivatives:de.extensions&&de.extensions.derivatives,extensionFragDepth:de.extensions&&de.extensions.fragDepth,extensionDrawBuffers:de.extensions&&de.extensions.drawBuffers,extensionShaderTextureLOD:de.extensions&&de.extensions.shaderTextureLOD,rendererExtensionFragDepth:z||g.has("EXT_frag_depth"),rendererExtensionDrawBuffers:z||g.has("WEBGL_draw_buffers"),rendererExtensionShaderTextureLod:z||g.has("EXT_shader_texture_lod"),customProgramCacheKey:de.customProgramCacheKey()}},getProgramCacheKey:function(de){const Xe=[];if(de.shaderID?Xe.push(de.shaderID):(Xe.push(de.fragmentShader),Xe.push(de.vertexShader)),de.defines!==void 0)for(const nt in de.defines)Xe.push(nt),Xe.push(de.defines[nt]);if(de.isRawShaderMaterial===!1){for(let nt=0;nt<ce.length;nt++)Xe.push(de[ce[nt]]);Xe.push(M.outputEncoding),Xe.push(M.gammaFactor)}return Xe.push(de.customProgramCacheKey),Xe.join()},getUniforms:function(de){const Xe=re[de.type];let nt;if(Xe){const Je=Ta[Xe];nt=Iu.clone(Je.uniforms)}else nt=de.uniforms;return nt},acquireProgram:function(de,Xe){let nt;for(let Je=0,gt=R.length;Je<gt;Je++){const Tt=R[Je];if(Tt.cacheKey===Xe){nt=Tt,++nt.usedTimes;break}}return nt===void 0&&(nt=new $u(M,Xe,de,w),R.push(nt)),nt},releaseProgram:function(de){if(--de.usedTimes==0){const Xe=R.indexOf(de);R[Xe]=R[R.length-1],R.pop(),de.destroy()}},programs:R}}function Op(){let M=new WeakMap;return{get:function(i){let c=M.get(i);return c===void 0&&(c={},M.set(i,c)),c},remove:function(i){M.delete(i)},update:function(i,c,g){M.get(i)[c]=g},dispose:function(){M=new WeakMap}}}function mh(M,i){return M.groupOrder!==i.groupOrder?M.groupOrder-i.groupOrder:M.renderOrder!==i.renderOrder?M.renderOrder-i.renderOrder:M.program!==i.program?M.program.id-i.program.id:M.material.id!==i.material.id?M.material.id-i.material.id:M.z!==i.z?M.z-i.z:M.id-i.id}function gh(M,i){return M.groupOrder!==i.groupOrder?M.groupOrder-i.groupOrder:M.renderOrder!==i.renderOrder?M.renderOrder-i.renderOrder:M.z!==i.z?i.z-M.z:M.id-i.id}function _h(M){const i=[];let c=0;const g=[],_=[],w=[],A={id:-1};function R(z,F,W,q,J,K){let re=i[c];const ce=M.get(W);return re===void 0?(re={id:z.id,object:z,geometry:F,material:W,program:ce.program||A,groupOrder:q,renderOrder:z.renderOrder,z:J,group:K},i[c]=re):(re.id=z.id,re.object=z,re.geometry=F,re.material=W,re.program=ce.program||A,re.groupOrder=q,re.renderOrder=z.renderOrder,re.z=J,re.group=K),c++,re}return{opaque:g,transmissive:_,transparent:w,init:function(){c=0,g.length=0,_.length=0,w.length=0},push:function(z,F,W,q,J,K){const re=R(z,F,W,q,J,K);W.transmission>0?_.push(re):W.transparent===!0?w.push(re):g.push(re)},unshift:function(z,F,W,q,J,K){const re=R(z,F,W,q,J,K);W.transmission>0?_.unshift(re):W.transparent===!0?w.unshift(re):g.unshift(re)},finish:function(){for(let z=c,F=i.length;z<F;z++){const W=i[z];if(W.id===null)break;W.id=null,W.object=null,W.geometry=null,W.material=null,W.program=null,W.group=null}},sort:function(z,F){g.length>1&&g.sort(z||mh),_.length>1&&_.sort(F||gh),w.length>1&&w.sort(F||gh)}}}function _g(M){let i=new WeakMap;return{get:function(c,g){let _;return i.has(c)===!1?(_=new _h(M),i.set(c,[_])):g>=i.get(c).length?(_=new _h(M),i.get(c).push(_)):_=i.get(c)[g],_},dispose:function(){i=new WeakMap}}}function yg(){const M={};return{get:function(i){if(M[i.id]!==void 0)return M[i.id];let c;switch(i.type){case"DirectionalLight":c={direction:new et,color:new un};break;case"SpotLight":c={position:new et,direction:new et,color:new un,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":c={position:new et,color:new un,distance:0,decay:0};break;case"HemisphereLight":c={direction:new et,skyColor:new un,groundColor:new un};break;case"RectAreaLight":c={color:new un,position:new et,halfWidth:new et,halfHeight:new et}}return M[i.id]=c,c}}}let Fp=0;function xg(M,i){return(i.castShadow?1:0)-(M.castShadow?1:0)}function Cc(M,i){const c=new yg,g=function(){const z={};return{get:function(F){if(z[F.id]!==void 0)return z[F.id];let W;switch(F.type){case"DirectionalLight":case"SpotLight":W={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Ri};break;case"PointLight":W={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Ri,shadowCameraNear:1,shadowCameraFar:1e3}}return z[F.id]=W,W}}}(),_={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadow:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[]};for(let z=0;z<9;z++)_.probe.push(new et);const w=new et,A=new Mn,R=new Mn;return{setup:function(z,F){let W=0,q=0,J=0;for(let Zt=0;Zt<9;Zt++)_.probe[Zt].set(0,0,0);let K=0,re=0,ce=0,Me=0,de=0,Xe=0,nt=0,Je=0;z.sort(xg);const gt=F!==!0?Math.PI:1;for(let Zt=0,ei=z.length;Zt<ei;Zt++){const vi=z[Zt],Xt=vi.color,xi=vi.intensity,In=vi.distance,gn=vi.shadow&&vi.shadow.map?vi.shadow.map.texture:null;if(vi.isAmbientLight)W+=Xt.r*xi*gt,q+=Xt.g*xi*gt,J+=Xt.b*xi*gt;else if(vi.isLightProbe)for(let Vi=0;Vi<9;Vi++)_.probe[Vi].addScaledVector(vi.sh.coefficients[Vi],xi);else if(vi.isDirectionalLight){const Vi=c.get(vi);if(Vi.color.copy(vi.color).multiplyScalar(vi.intensity*gt),vi.castShadow){const vn=vi.shadow,$n=g.get(vi);$n.shadowBias=vn.bias,$n.shadowNormalBias=vn.normalBias,$n.shadowRadius=vn.radius,$n.shadowMapSize=vn.mapSize,_.directionalShadow[K]=$n,_.directionalShadowMap[K]=gn,_.directionalShadowMatrix[K]=vi.shadow.matrix,Xe++}_.directional[K]=Vi,K++}else if(vi.isSpotLight){const Vi=c.get(vi);if(Vi.position.setFromMatrixPosition(vi.matrixWorld),Vi.color.copy(Xt).multiplyScalar(xi*gt),Vi.distance=In,Vi.coneCos=Math.cos(vi.angle),Vi.penumbraCos=Math.cos(vi.angle*(1-vi.penumbra)),Vi.decay=vi.decay,vi.castShadow){const vn=vi.shadow,$n=g.get(vi);$n.shadowBias=vn.bias,$n.shadowNormalBias=vn.normalBias,$n.shadowRadius=vn.radius,$n.shadowMapSize=vn.mapSize,_.spotShadow[ce]=$n,_.spotShadowMap[ce]=gn,_.spotShadowMatrix[ce]=vi.shadow.matrix,Je++}_.spot[ce]=Vi,ce++}else if(vi.isRectAreaLight){const Vi=c.get(vi);Vi.color.copy(Xt).multiplyScalar(xi),Vi.halfWidth.set(.5*vi.width,0,0),Vi.halfHeight.set(0,.5*vi.height,0),_.rectArea[Me]=Vi,Me++}else if(vi.isPointLight){const Vi=c.get(vi);if(Vi.color.copy(vi.color).multiplyScalar(vi.intensity*gt),Vi.distance=vi.distance,Vi.decay=vi.decay,vi.castShadow){const vn=vi.shadow,$n=g.get(vi);$n.shadowBias=vn.bias,$n.shadowNormalBias=vn.normalBias,$n.shadowRadius=vn.radius,$n.shadowMapSize=vn.mapSize,$n.shadowCameraNear=vn.camera.near,$n.shadowCameraFar=vn.camera.far,_.pointShadow[re]=$n,_.pointShadowMap[re]=gn,_.pointShadowMatrix[re]=vi.shadow.matrix,nt++}_.point[re]=Vi,re++}else if(vi.isHemisphereLight){const Vi=c.get(vi);Vi.skyColor.copy(vi.color).multiplyScalar(xi*gt),Vi.groundColor.copy(vi.groundColor).multiplyScalar(xi*gt),_.hemi[de]=Vi,de++}}Me>0&&(i.isWebGL2||M.has("OES_texture_float_linear")===!0?(_.rectAreaLTC1=On.LTC_FLOAT_1,_.rectAreaLTC2=On.LTC_FLOAT_2):M.has("OES_texture_half_float_linear")===!0?(_.rectAreaLTC1=On.LTC_HALF_1,_.rectAreaLTC2=On.LTC_HALF_2):console.error("THREE.WebGLRenderer: Unable to use RectAreaLight. Missing WebGL extensions.")),_.ambient[0]=W,_.ambient[1]=q,_.ambient[2]=J;const Tt=_.hash;Tt.directionalLength===K&&Tt.pointLength===re&&Tt.spotLength===ce&&Tt.rectAreaLength===Me&&Tt.hemiLength===de&&Tt.numDirectionalShadows===Xe&&Tt.numPointShadows===nt&&Tt.numSpotShadows===Je||(_.directional.length=K,_.spot.length=ce,_.rectArea.length=Me,_.point.length=re,_.hemi.length=de,_.directionalShadow.length=Xe,_.directionalShadowMap.length=Xe,_.pointShadow.length=nt,_.pointShadowMap.length=nt,_.spotShadow.length=Je,_.spotShadowMap.length=Je,_.directionalShadowMatrix.length=Xe,_.pointShadowMatrix.length=nt,_.spotShadowMatrix.length=Je,Tt.directionalLength=K,Tt.pointLength=re,Tt.spotLength=ce,Tt.rectAreaLength=Me,Tt.hemiLength=de,Tt.numDirectionalShadows=Xe,Tt.numPointShadows=nt,Tt.numSpotShadows=Je,_.version=Fp++)},setupView:function(z,F){let W=0,q=0,J=0,K=0,re=0;const ce=F.matrixWorldInverse;for(let Me=0,de=z.length;Me<de;Me++){const Xe=z[Me];if(Xe.isDirectionalLight){const nt=_.directional[W];nt.direction.setFromMatrixPosition(Xe.matrixWorld),w.setFromMatrixPosition(Xe.target.matrixWorld),nt.direction.sub(w),nt.direction.transformDirection(ce),W++}else if(Xe.isSpotLight){const nt=_.spot[J];nt.position.setFromMatrixPosition(Xe.matrixWorld),nt.position.applyMatrix4(ce),nt.direction.setFromMatrixPosition(Xe.matrixWorld),w.setFromMatrixPosition(Xe.target.matrixWorld),nt.direction.sub(w),nt.direction.transformDirection(ce),J++}else if(Xe.isRectAreaLight){const nt=_.rectArea[K];nt.position.setFromMatrixPosition(Xe.matrixWorld),nt.position.applyMatrix4(ce),R.identity(),A.copy(Xe.matrixWorld),A.premultiply(ce),R.extractRotation(A),nt.halfWidth.set(.5*Xe.width,0,0),nt.halfHeight.set(0,.5*Xe.height,0),nt.halfWidth.applyMatrix4(R),nt.halfHeight.applyMatrix4(R),K++}else if(Xe.isPointLight){const nt=_.point[q];nt.position.setFromMatrixPosition(Xe.matrixWorld),nt.position.applyMatrix4(ce),q++}else if(Xe.isHemisphereLight){const nt=_.hemi[re];nt.direction.setFromMatrixPosition(Xe.matrixWorld),nt.direction.transformDirection(ce),nt.direction.normalize(),re++}}},state:_}}function kp(M,i){const c=new Cc(M,i),g=[],_=[];return{init:function(){g.length=0,_.length=0},state:{lightsArray:g,shadowsArray:_,lights:c},setupLights:function(w){c.setup(g,w)},setupLightsView:function(w){c.setupView(g,w)},pushLight:function(w){g.push(w)},pushShadow:function(w){_.push(w)}}}function Bp(M,i){let c=new WeakMap;return{get:function(g,_=0){let w;return c.has(g)===!1?(w=new kp(M,i),c.set(g,[w])):_>=c.get(g).length?(w=new kp(M,i),c.get(g).push(w)):w=c.get(g)[_],w},dispose:function(){c=new WeakMap}}}class Yu extends Bi{constructor(i){super(),this.type="MeshDepthMaterial",this.depthPacking=3200,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.setValues(i)}copy(i){return super.copy(i),this.depthPacking=i.depthPacking,this.map=i.map,this.alphaMap=i.alphaMap,this.displacementMap=i.displacementMap,this.displacementScale=i.displacementScale,this.displacementBias=i.displacementBias,this.wireframe=i.wireframe,this.wireframeLinewidth=i.wireframeLinewidth,this}}Yu.prototype.isMeshDepthMaterial=!0;class Ju extends Bi{constructor(i){super(),this.type="MeshDistanceMaterial",this.referencePosition=new et,this.nearDistance=1,this.farDistance=1e3,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.fog=!1,this.setValues(i)}copy(i){return super.copy(i),this.referencePosition.copy(i.referencePosition),this.nearDistance=i.nearDistance,this.farDistance=i.farDistance,this.map=i.map,this.alphaMap=i.alphaMap,this.displacementMap=i.displacementMap,this.displacementScale=i.displacementScale,this.displacementBias=i.displacementBias,this}}Ju.prototype.isMeshDistanceMaterial=!0;function Ha(M,i,c){let g=new tc;const _=new Ri,w=new Ri,A=new Mr,R=new Yu({depthPacking:3201}),z=new Ju,F={},W=c.maxTextureSize,q={0:1,1:0,2:2},J=new tl({uniforms:{shadow_pass:{value:null},resolution:{value:new Ri},radius:{value:4},samples:{value:8}},vertexShader:`void main() {
	gl_Position = vec4( position, 1.0 );
}`,fragmentShader:`uniform sampler2D shadow_pass;
uniform vec2 resolution;
uniform float radius;
uniform float samples;
#include <packing>
void main() {
	float mean = 0.0;
	float squared_mean = 0.0;
	float uvStride = samples <= 1.0 ? 0.0 : 2.0 / ( samples - 1.0 );
	float uvStart = samples <= 1.0 ? 0.0 : - 1.0;
	for ( float i = 0.0; i < samples; i ++ ) {
		float uvOffset = uvStart + i * uvStride;
		#ifdef HORIZONTAL_PASS
			vec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( uvOffset, 0.0 ) * radius ) / resolution ) );
			mean += distribution.x;
			squared_mean += distribution.y * distribution.y + distribution.x * distribution.x;
		#else
			float depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, uvOffset ) * radius ) / resolution ) );
			mean += depth;
			squared_mean += depth * depth;
		#endif
	}
	mean = mean / samples;
	squared_mean = squared_mean / samples;
	float std_dev = sqrt( squared_mean - mean * mean );
	gl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );
}`}),K=J.clone();K.defines.HORIZONTAL_PASS=1;const re=new Er;re.setAttribute("position",new pn(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const ce=new oo(re,J),Me=this;function de(Je,gt){const Tt=i.update(ce);J.uniforms.shadow_pass.value=Je.map.texture,J.uniforms.resolution.value=Je.mapSize,J.uniforms.radius.value=Je.radius,J.uniforms.samples.value=Je.blurSamples,M.setRenderTarget(Je.mapPass),M.clear(),M.renderBufferDirect(gt,null,Tt,J,ce,null),K.uniforms.shadow_pass.value=Je.mapPass.texture,K.uniforms.resolution.value=Je.mapSize,K.uniforms.radius.value=Je.radius,K.uniforms.samples.value=Je.blurSamples,M.setRenderTarget(Je.map),M.clear(),M.renderBufferDirect(gt,null,Tt,K,ce,null)}function Xe(Je,gt,Tt,Zt,ei,vi,Xt){let xi=null;const In=Zt.isPointLight===!0?Je.customDistanceMaterial:Je.customDepthMaterial;if(xi=In!==void 0?In:Zt.isPointLight===!0?z:R,M.localClippingEnabled&&Tt.clipShadows===!0&&Tt.clippingPlanes.length!==0||Tt.displacementMap&&Tt.displacementScale!==0||Tt.alphaMap&&Tt.alphaTest>0){const gn=xi.uuid,Vi=Tt.uuid;let vn=F[gn];vn===void 0&&(vn={},F[gn]=vn);let $n=vn[Vi];$n===void 0&&($n=xi.clone(),vn[Vi]=$n),xi=$n}return xi.visible=Tt.visible,xi.wireframe=Tt.wireframe,xi.side=Xt===3?Tt.shadowSide!==null?Tt.shadowSide:Tt.side:Tt.shadowSide!==null?Tt.shadowSide:q[Tt.side],xi.alphaMap=Tt.alphaMap,xi.alphaTest=Tt.alphaTest,xi.clipShadows=Tt.clipShadows,xi.clippingPlanes=Tt.clippingPlanes,xi.clipIntersection=Tt.clipIntersection,xi.displacementMap=Tt.displacementMap,xi.displacementScale=Tt.displacementScale,xi.displacementBias=Tt.displacementBias,xi.wireframeLinewidth=Tt.wireframeLinewidth,xi.linewidth=Tt.linewidth,Zt.isPointLight===!0&&xi.isMeshDistanceMaterial===!0&&(xi.referencePosition.setFromMatrixPosition(Zt.matrixWorld),xi.nearDistance=ei,xi.farDistance=vi),xi}function nt(Je,gt,Tt,Zt,ei){if(Je.visible===!1)return;if(Je.layers.test(gt.layers)&&(Je.isMesh||Je.isLine||Je.isPoints)&&(Je.castShadow||Je.receiveShadow&&ei===3)&&(!Je.frustumCulled||g.intersectsObject(Je))){Je.modelViewMatrix.multiplyMatrices(Tt.matrixWorldInverse,Je.matrixWorld);const Xt=i.update(Je),xi=Je.material;if(Array.isArray(xi)){const In=Xt.groups;for(let gn=0,Vi=In.length;gn<Vi;gn++){const vn=In[gn],$n=xi[vn.materialIndex];if($n&&$n.visible){const tr=Xe(Je,0,$n,Zt,Tt.near,Tt.far,ei);M.renderBufferDirect(Tt,null,Xt,tr,Je,vn)}}}else if(xi.visible){const In=Xe(Je,0,xi,Zt,Tt.near,Tt.far,ei);M.renderBufferDirect(Tt,null,Xt,In,Je,null)}}const vi=Je.children;for(let Xt=0,xi=vi.length;Xt<xi;Xt++)nt(vi[Xt],gt,Tt,Zt,ei)}this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=1,this.render=function(Je,gt,Tt){if(Me.enabled===!1||Me.autoUpdate===!1&&Me.needsUpdate===!1||Je.length===0)return;const Zt=M.getRenderTarget(),ei=M.getActiveCubeFace(),vi=M.getActiveMipmapLevel(),Xt=M.state;Xt.setBlending(0),Xt.buffers.color.setClear(1,1,1,1),Xt.buffers.depth.setTest(!0),Xt.setScissorTest(!1);for(let xi=0,In=Je.length;xi<In;xi++){const gn=Je[xi],Vi=gn.shadow;if(Vi===void 0){console.warn("THREE.WebGLShadowMap:",gn,"has no shadow.");continue}if(Vi.autoUpdate===!1&&Vi.needsUpdate===!1)continue;_.copy(Vi.mapSize);const vn=Vi.getFrameExtents();if(_.multiply(vn),w.copy(Vi.mapSize),(_.x>W||_.y>W)&&(_.x>W&&(w.x=Math.floor(W/vn.x),_.x=w.x*vn.x,Vi.mapSize.x=w.x),_.y>W&&(w.y=Math.floor(W/vn.y),_.y=w.y*vn.y,Vi.mapSize.y=w.y)),Vi.map===null&&!Vi.isPointLightShadow&&this.type===3){const tr={minFilter:1006,magFilter:1006,format:1023};Vi.map=new Bs(_.x,_.y,tr),Vi.map.texture.name=gn.name+".shadowMap",Vi.mapPass=new Bs(_.x,_.y,tr),Vi.camera.updateProjectionMatrix()}if(Vi.map===null){const tr={minFilter:1003,magFilter:1003,format:1023};Vi.map=new Bs(_.x,_.y,tr),Vi.map.texture.name=gn.name+".shadowMap",Vi.camera.updateProjectionMatrix()}M.setRenderTarget(Vi.map),M.clear();const $n=Vi.getViewportCount();for(let tr=0;tr<$n;tr++){const mr=Vi.getViewport(tr);A.set(w.x*mr.x,w.y*mr.y,w.x*mr.z,w.y*mr.w),Xt.viewport(A),Vi.updateMatrices(gn,tr),g=Vi.getFrustum(),nt(gt,Tt,Vi.camera,gn,this.type)}Vi.isPointLightShadow||this.type!==3||de(Vi,Tt),Vi.needsUpdate=!1}Me.needsUpdate=!1,M.setRenderTarget(Zt,ei,vi)}}function nm(M,i,c){const g=c.isWebGL2,_=new function(){let pt=!1;const di=new Mr;let nn=null;const an=new Mr(0,0,0,0);return{setMask:function(rn){nn===rn||pt||(M.colorMask(rn,rn,rn,rn),nn=rn)},setLocked:function(rn){pt=rn},setClear:function(rn,Hn,Sr,sr,Kr){Kr===!0&&(rn*=sr,Hn*=sr,Sr*=sr),di.set(rn,Hn,Sr,sr),an.equals(di)===!1&&(M.clearColor(rn,Hn,Sr,sr),an.copy(di))},reset:function(){pt=!1,nn=null,an.set(-1,0,0,0)}}},w=new function(){let pt=!1,di=null,nn=null,an=null;return{setTest:function(rn){rn?mn(2929):wt(2929)},setMask:function(rn){di===rn||pt||(M.depthMask(rn),di=rn)},setFunc:function(rn){if(nn!==rn){if(rn)switch(rn){case 0:M.depthFunc(512);break;case 1:M.depthFunc(519);break;case 2:M.depthFunc(513);break;case 3:M.depthFunc(515);break;case 4:M.depthFunc(514);break;case 5:M.depthFunc(518);break;case 6:M.depthFunc(516);break;case 7:M.depthFunc(517);break;default:M.depthFunc(515)}else M.depthFunc(515);nn=rn}},setLocked:function(rn){pt=rn},setClear:function(rn){an!==rn&&(M.clearDepth(rn),an=rn)},reset:function(){pt=!1,di=null,nn=null,an=null}}},A=new function(){let pt=!1,di=null,nn=null,an=null,rn=null,Hn=null,Sr=null,sr=null,Kr=null;return{setTest:function(Xr){pt||(Xr?mn(2960):wt(2960))},setMask:function(Xr){di===Xr||pt||(M.stencilMask(Xr),di=Xr)},setFunc:function(Xr,Ko,Ns){nn===Xr&&an===Ko&&rn===Ns||(M.stencilFunc(Xr,Ko,Ns),nn=Xr,an=Ko,rn=Ns)},setOp:function(Xr,Ko,Ns){Hn===Xr&&Sr===Ko&&sr===Ns||(M.stencilOp(Xr,Ko,Ns),Hn=Xr,Sr=Ko,sr=Ns)},setLocked:function(Xr){pt=Xr},setClear:function(Xr){Kr!==Xr&&(M.clearStencil(Xr),Kr=Xr)},reset:function(){pt=!1,di=null,nn=null,an=null,rn=null,Hn=null,Sr=null,sr=null,Kr=null}}};let R={},z=null,F={},W=null,q=!1,J=null,K=null,re=null,ce=null,Me=null,de=null,Xe=null,nt=!1,Je=null,gt=null,Tt=null,Zt=null,ei=null;const vi=M.getParameter(35661);let Xt=!1,xi=0;const In=M.getParameter(7938);In.indexOf("WebGL")!==-1?(xi=parseFloat(/^WebGL (\d)/.exec(In)[1]),Xt=xi>=1):In.indexOf("OpenGL ES")!==-1&&(xi=parseFloat(/^OpenGL ES (\d)/.exec(In)[1]),Xt=xi>=2);let gn=null,Vi={};const vn=M.getParameter(3088),$n=M.getParameter(2978),tr=new Mr().fromArray(vn),mr=new Mr().fromArray($n);function Ar(pt,di,nn){const an=new Uint8Array(4),rn=M.createTexture();M.bindTexture(pt,rn),M.texParameteri(pt,10241,9728),M.texParameteri(pt,10240,9728);for(let Hn=0;Hn<nn;Hn++)M.texImage2D(di+Hn,0,6408,1,1,0,6408,5121,an);return rn}const hr={};function mn(pt){R[pt]!==!0&&(M.enable(pt),R[pt]=!0)}function wt(pt){R[pt]!==!1&&(M.disable(pt),R[pt]=!1)}hr[3553]=Ar(3553,3553,1),hr[34067]=Ar(34067,34069,6),_.setClear(0,0,0,1),w.setClear(1),A.setClear(0),mn(2929),w.setFunc(3),gi(!1),An(1),mn(2884),Li(0);const Dt={100:32774,101:32778,102:32779};if(g)Dt[103]=32775,Dt[104]=32776;else{const pt=i.get("EXT_blend_minmax");pt!==null&&(Dt[103]=pt.MIN_EXT,Dt[104]=pt.MAX_EXT)}const Xi={200:0,201:1,202:768,204:770,210:776,208:774,206:772,203:769,205:771,209:775,207:773};function Li(pt,di,nn,an,rn,Hn,Sr,sr){if(pt!==0){if(q===!1&&(mn(3042),q=!0),pt===5)rn=rn||di,Hn=Hn||nn,Sr=Sr||an,di===K&&rn===Me||(M.blendEquationSeparate(Dt[di],Dt[rn]),K=di,Me=rn),nn===re&&an===ce&&Hn===de&&Sr===Xe||(M.blendFuncSeparate(Xi[nn],Xi[an],Xi[Hn],Xi[Sr]),re=nn,ce=an,de=Hn,Xe=Sr),J=pt,nt=null;else if(pt!==J||sr!==nt){if(K===100&&Me===100||(M.blendEquation(32774),K=100,Me=100),sr)switch(pt){case 1:M.blendFuncSeparate(1,771,1,771);break;case 2:M.blendFunc(1,1);break;case 3:M.blendFuncSeparate(0,0,769,771);break;case 4:M.blendFuncSeparate(0,768,0,770);break;default:console.error("THREE.WebGLState: Invalid blending: ",pt)}else switch(pt){case 1:M.blendFuncSeparate(770,771,1,771);break;case 2:M.blendFunc(770,1);break;case 3:M.blendFunc(0,769);break;case 4:M.blendFunc(0,768);break;default:console.error("THREE.WebGLState: Invalid blending: ",pt)}re=null,ce=null,de=null,Xe=null,J=pt,nt=sr}}else q===!0&&(wt(3042),q=!1)}function gi(pt){Je!==pt&&(pt?M.frontFace(2304):M.frontFace(2305),Je=pt)}function An(pt){pt!==0?(mn(2884),pt!==gt&&(pt===1?M.cullFace(1029):pt===2?M.cullFace(1028):M.cullFace(1032))):wt(2884),gt=pt}function Cn(pt,di,nn){pt?(mn(32823),Zt===di&&ei===nn||(M.polygonOffset(di,nn),Zt=di,ei=nn)):wt(32823)}function Ti(pt){pt===void 0&&(pt=33984+vi-1),gn!==pt&&(M.activeTexture(pt),gn=pt)}return{buffers:{color:_,depth:w,stencil:A},enable:mn,disable:wt,bindFramebuffer:function(pt,di){return di===null&&z!==null&&(di=z),F[pt]!==di&&(M.bindFramebuffer(pt,di),F[pt]=di,g&&(pt===36009&&(F[36160]=di),pt===36160&&(F[36009]=di)),!0)},bindXRFramebuffer:function(pt){pt!==z&&(M.bindFramebuffer(36160,pt),z=pt)},useProgram:function(pt){return W!==pt&&(M.useProgram(pt),W=pt,!0)},setBlending:Li,setMaterial:function(pt,di){pt.side===2?wt(2884):mn(2884);let nn=pt.side===1;di&&(nn=!nn),gi(nn),pt.blending===1&&pt.transparent===!1?Li(0):Li(pt.blending,pt.blendEquation,pt.blendSrc,pt.blendDst,pt.blendEquationAlpha,pt.blendSrcAlpha,pt.blendDstAlpha,pt.premultipliedAlpha),w.setFunc(pt.depthFunc),w.setTest(pt.depthTest),w.setMask(pt.depthWrite),_.setMask(pt.colorWrite);const an=pt.stencilWrite;A.setTest(an),an&&(A.setMask(pt.stencilWriteMask),A.setFunc(pt.stencilFunc,pt.stencilRef,pt.stencilFuncMask),A.setOp(pt.stencilFail,pt.stencilZFail,pt.stencilZPass)),Cn(pt.polygonOffset,pt.polygonOffsetFactor,pt.polygonOffsetUnits),pt.alphaToCoverage===!0?mn(32926):wt(32926)},setFlipSided:gi,setCullFace:An,setLineWidth:function(pt){pt!==Tt&&(Xt&&M.lineWidth(pt),Tt=pt)},setPolygonOffset:Cn,setScissorTest:function(pt){pt?mn(3089):wt(3089)},activeTexture:Ti,bindTexture:function(pt,di){gn===null&&Ti();let nn=Vi[gn];nn===void 0&&(nn={type:void 0,texture:void 0},Vi[gn]=nn),nn.type===pt&&nn.texture===di||(M.bindTexture(pt,di||hr[pt]),nn.type=pt,nn.texture=di)},unbindTexture:function(){const pt=Vi[gn];pt!==void 0&&pt.type!==void 0&&(M.bindTexture(pt.type,null),pt.type=void 0,pt.texture=void 0)},compressedTexImage2D:function(){try{M.compressedTexImage2D.apply(M,arguments)}catch(pt){console.error("THREE.WebGLState:",pt)}},texImage2D:function(){try{M.texImage2D.apply(M,arguments)}catch(pt){console.error("THREE.WebGLState:",pt)}},texImage3D:function(){try{M.texImage3D.apply(M,arguments)}catch(pt){console.error("THREE.WebGLState:",pt)}},scissor:function(pt){tr.equals(pt)===!1&&(M.scissor(pt.x,pt.y,pt.z,pt.w),tr.copy(pt))},viewport:function(pt){mr.equals(pt)===!1&&(M.viewport(pt.x,pt.y,pt.z,pt.w),mr.copy(pt))},reset:function(){M.disable(3042),M.disable(2884),M.disable(2929),M.disable(32823),M.disable(3089),M.disable(2960),M.disable(32926),M.blendEquation(32774),M.blendFunc(1,0),M.blendFuncSeparate(1,0,1,0),M.colorMask(!0,!0,!0,!0),M.clearColor(0,0,0,0),M.depthMask(!0),M.depthFunc(513),M.clearDepth(1),M.stencilMask(4294967295),M.stencilFunc(519,0,4294967295),M.stencilOp(7680,7680,7680),M.clearStencil(0),M.cullFace(1029),M.frontFace(2305),M.polygonOffset(0,0),M.activeTexture(33984),M.bindFramebuffer(36160,null),g===!0&&(M.bindFramebuffer(36009,null),M.bindFramebuffer(36008,null)),M.useProgram(null),M.lineWidth(1),M.scissor(0,0,M.canvas.width,M.canvas.height),M.viewport(0,0,M.canvas.width,M.canvas.height),R={},gn=null,Vi={},z=null,F={},W=null,q=!1,J=null,K=null,re=null,ce=null,Me=null,de=null,Xe=null,nt=!1,Je=null,gt=null,Tt=null,Zt=null,ei=null,tr.set(0,0,M.canvas.width,M.canvas.height),mr.set(0,0,M.canvas.width,M.canvas.height),_.reset(),w.reset(),A.reset()}}}function rm(M,i,c,g,_,w,A){const R=_.isWebGL2,z=_.maxTextures,F=_.maxCubemapSize,W=_.maxTextureSize,q=_.maxSamples,J=new WeakMap;let K,re=!1;try{re=typeof OffscreenCanvas<"u"&&new OffscreenCanvas(1,1).getContext("2d")!==null}catch{}function ce(wt,Dt){return re?new OffscreenCanvas(wt,Dt):document.createElementNS("http://www.w3.org/1999/xhtml","canvas")}function Me(wt,Dt,Xi,Li){let gi=1;if((wt.width>Li||wt.height>Li)&&(gi=Li/Math.max(wt.width,wt.height)),gi<1||Dt===!0){if(typeof HTMLImageElement<"u"&&wt instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&wt instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&wt instanceof ImageBitmap){const An=Dt?Un:Math.floor,Cn=An(gi*wt.width),Ti=An(gi*wt.height);K===void 0&&(K=ce(Cn,Ti));const pt=Xi?ce(Cn,Ti):K;return pt.width=Cn,pt.height=Ti,pt.getContext("2d").drawImage(wt,0,0,Cn,Ti),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+wt.width+"x"+wt.height+") to ("+Cn+"x"+Ti+")."),pt}return"data"in wt&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+wt.width+"x"+wt.height+")."),wt}return wt}function de(wt){return rs(wt.width)&&rs(wt.height)}function Xe(wt,Dt){return wt.generateMipmaps&&Dt&&wt.minFilter!==1003&&wt.minFilter!==1006}function nt(wt,Dt,Xi,Li,gi=1){M.generateMipmap(wt),g.get(Dt).__maxMipLevel=Math.log2(Math.max(Xi,Li,gi))}function Je(wt,Dt,Xi){if(R===!1)return Dt;if(wt!==null){if(M[wt]!==void 0)return M[wt];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+wt+"'")}let Li=Dt;return Dt===6403&&(Xi===5126&&(Li=33326),Xi===5131&&(Li=33325),Xi===5121&&(Li=33321)),Dt===6407&&(Xi===5126&&(Li=34837),Xi===5131&&(Li=34843),Xi===5121&&(Li=32849)),Dt===6408&&(Xi===5126&&(Li=34836),Xi===5131&&(Li=34842),Xi===5121&&(Li=32856)),Li!==33325&&Li!==33326&&Li!==34842&&Li!==34836||i.get("EXT_color_buffer_float"),Li}function gt(wt){return wt===1003||wt===1004||wt===1005?9728:9729}function Tt(wt){const Dt=wt.target;Dt.removeEventListener("dispose",Tt),function(Xi){const Li=g.get(Xi);Li.__webglInit!==void 0&&(M.deleteTexture(Li.__webglTexture),g.remove(Xi))}(Dt),Dt.isVideoTexture&&J.delete(Dt),A.memory.textures--}function Zt(wt){const Dt=wt.target;Dt.removeEventListener("dispose",Zt),function(Xi){const Li=Xi.texture,gi=g.get(Xi),An=g.get(Li);if(Xi){if(An.__webglTexture!==void 0&&(M.deleteTexture(An.__webglTexture),A.memory.textures--),Xi.depthTexture&&Xi.depthTexture.dispose(),Xi.isWebGLCubeRenderTarget)for(let Cn=0;Cn<6;Cn++)M.deleteFramebuffer(gi.__webglFramebuffer[Cn]),gi.__webglDepthbuffer&&M.deleteRenderbuffer(gi.__webglDepthbuffer[Cn]);else M.deleteFramebuffer(gi.__webglFramebuffer),gi.__webglDepthbuffer&&M.deleteRenderbuffer(gi.__webglDepthbuffer),gi.__webglMultisampledFramebuffer&&M.deleteFramebuffer(gi.__webglMultisampledFramebuffer),gi.__webglColorRenderbuffer&&M.deleteRenderbuffer(gi.__webglColorRenderbuffer),gi.__webglDepthRenderbuffer&&M.deleteRenderbuffer(gi.__webglDepthRenderbuffer);if(Xi.isWebGLMultipleRenderTargets)for(let Cn=0,Ti=Li.length;Cn<Ti;Cn++){const pt=g.get(Li[Cn]);pt.__webglTexture&&(M.deleteTexture(pt.__webglTexture),A.memory.textures--),g.remove(Li[Cn])}g.remove(Li),g.remove(Xi)}}(Dt)}let ei=0;function vi(wt,Dt){const Xi=g.get(wt);if(wt.isVideoTexture&&function(Li){const gi=A.render.frame;J.get(Li)!==gi&&(J.set(Li,gi),Li.update())}(wt),wt.version>0&&Xi.__version!==wt.version){const Li=wt.image;if(Li===void 0)console.warn("THREE.WebGLRenderer: Texture marked for update but image is undefined");else{if(Li.complete!==!1)return void vn(Xi,wt,Dt);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete")}}c.activeTexture(33984+Dt),c.bindTexture(3553,Xi.__webglTexture)}function Xt(wt,Dt){const Xi=g.get(wt);wt.version>0&&Xi.__version!==wt.version?function(Li,gi,An){if(gi.image.length!==6)return;Vi(Li,gi),c.activeTexture(33984+An),c.bindTexture(34067,Li.__webglTexture),M.pixelStorei(37440,gi.flipY),M.pixelStorei(37441,gi.premultiplyAlpha),M.pixelStorei(3317,gi.unpackAlignment),M.pixelStorei(37443,0);const Cn=gi&&(gi.isCompressedTexture||gi.image[0].isCompressedTexture),Ti=gi.image[0]&&gi.image[0].isDataTexture,pt=[];for(let sr=0;sr<6;sr++)pt[sr]=Cn||Ti?Ti?gi.image[sr].image:gi.image[sr]:Me(gi.image[sr],!1,!0,F);const di=pt[0],nn=de(di)||R,an=w.convert(gi.format),rn=w.convert(gi.type),Hn=Je(gi.internalFormat,an,rn);let Sr;if(gn(34067,gi,nn),Cn){for(let sr=0;sr<6;sr++){Sr=pt[sr].mipmaps;for(let Kr=0;Kr<Sr.length;Kr++){const Xr=Sr[Kr];gi.format!==1023&&gi.format!==1022?an!==null?c.compressedTexImage2D(34069+sr,Kr,Hn,Xr.width,Xr.height,0,Xr.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):c.texImage2D(34069+sr,Kr,Hn,Xr.width,Xr.height,0,an,rn,Xr.data)}}Li.__maxMipLevel=Sr.length-1}else{Sr=gi.mipmaps;for(let sr=0;sr<6;sr++)if(Ti){c.texImage2D(34069+sr,0,Hn,pt[sr].width,pt[sr].height,0,an,rn,pt[sr].data);for(let Kr=0;Kr<Sr.length;Kr++){const Xr=Sr[Kr].image[sr].image;c.texImage2D(34069+sr,Kr+1,Hn,Xr.width,Xr.height,0,an,rn,Xr.data)}}else{c.texImage2D(34069+sr,0,Hn,an,rn,pt[sr]);for(let Kr=0;Kr<Sr.length;Kr++){const Xr=Sr[Kr];c.texImage2D(34069+sr,Kr+1,Hn,an,rn,Xr.image[sr])}}Li.__maxMipLevel=Sr.length}Xe(gi,nn)&&nt(34067,gi,di.width,di.height),Li.__version=gi.version,gi.onUpdate&&gi.onUpdate(gi)}(Xi,wt,Dt):(c.activeTexture(33984+Dt),c.bindTexture(34067,Xi.__webglTexture))}const xi={1e3:10497,1001:33071,1002:33648},In={1003:9728,1004:9984,1005:9986,1006:9729,1007:9985,1008:9987};function gn(wt,Dt,Xi){if(Xi?(M.texParameteri(wt,10242,xi[Dt.wrapS]),M.texParameteri(wt,10243,xi[Dt.wrapT]),wt!==32879&&wt!==35866||M.texParameteri(wt,32882,xi[Dt.wrapR]),M.texParameteri(wt,10240,In[Dt.magFilter]),M.texParameteri(wt,10241,In[Dt.minFilter])):(M.texParameteri(wt,10242,33071),M.texParameteri(wt,10243,33071),wt!==32879&&wt!==35866||M.texParameteri(wt,32882,33071),Dt.wrapS===1001&&Dt.wrapT===1001||console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping."),M.texParameteri(wt,10240,gt(Dt.magFilter)),M.texParameteri(wt,10241,gt(Dt.minFilter)),Dt.minFilter!==1003&&Dt.minFilter!==1006&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.")),i.has("EXT_texture_filter_anisotropic")===!0){const Li=i.get("EXT_texture_filter_anisotropic");if(Dt.type===1015&&i.has("OES_texture_float_linear")===!1||R===!1&&Dt.type===1016&&i.has("OES_texture_half_float_linear")===!1)return;(Dt.anisotropy>1||g.get(Dt).__currentAnisotropy)&&(M.texParameterf(wt,Li.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(Dt.anisotropy,_.getMaxAnisotropy())),g.get(Dt).__currentAnisotropy=Dt.anisotropy)}}function Vi(wt,Dt){wt.__webglInit===void 0&&(wt.__webglInit=!0,Dt.addEventListener("dispose",Tt),wt.__webglTexture=M.createTexture(),A.memory.textures++)}function vn(wt,Dt,Xi){let Li=3553;Dt.isDataTexture2DArray&&(Li=35866),Dt.isDataTexture3D&&(Li=32879),Vi(wt,Dt),c.activeTexture(33984+Xi),c.bindTexture(Li,wt.__webglTexture),M.pixelStorei(37440,Dt.flipY),M.pixelStorei(37441,Dt.premultiplyAlpha),M.pixelStorei(3317,Dt.unpackAlignment),M.pixelStorei(37443,0);const gi=function(rn){return!R&&(rn.wrapS!==1001||rn.wrapT!==1001||rn.minFilter!==1003&&rn.minFilter!==1006)}(Dt)&&de(Dt.image)===!1,An=Me(Dt.image,gi,!1,W),Cn=de(An)||R,Ti=w.convert(Dt.format);let pt,di=w.convert(Dt.type),nn=Je(Dt.internalFormat,Ti,di);gn(Li,Dt,Cn);const an=Dt.mipmaps;if(Dt.isDepthTexture)nn=6402,R?nn=Dt.type===1015?36012:Dt.type===1014?33190:Dt.type===1020?35056:33189:Dt.type===1015&&console.error("WebGLRenderer: Floating point depth texture requires WebGL2."),Dt.format===1026&&nn===6402&&Dt.type!==1012&&Dt.type!==1014&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),Dt.type=1012,di=w.convert(Dt.type)),Dt.format===1027&&nn===6402&&(nn=34041,Dt.type!==1020&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),Dt.type=1020,di=w.convert(Dt.type))),c.texImage2D(3553,0,nn,An.width,An.height,0,Ti,di,null);else if(Dt.isDataTexture)if(an.length>0&&Cn){for(let rn=0,Hn=an.length;rn<Hn;rn++)pt=an[rn],c.texImage2D(3553,rn,nn,pt.width,pt.height,0,Ti,di,pt.data);Dt.generateMipmaps=!1,wt.__maxMipLevel=an.length-1}else c.texImage2D(3553,0,nn,An.width,An.height,0,Ti,di,An.data),wt.__maxMipLevel=0;else if(Dt.isCompressedTexture){for(let rn=0,Hn=an.length;rn<Hn;rn++)pt=an[rn],Dt.format!==1023&&Dt.format!==1022?Ti!==null?c.compressedTexImage2D(3553,rn,nn,pt.width,pt.height,0,pt.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):c.texImage2D(3553,rn,nn,pt.width,pt.height,0,Ti,di,pt.data);wt.__maxMipLevel=an.length-1}else if(Dt.isDataTexture2DArray)c.texImage3D(35866,0,nn,An.width,An.height,An.depth,0,Ti,di,An.data),wt.__maxMipLevel=0;else if(Dt.isDataTexture3D)c.texImage3D(32879,0,nn,An.width,An.height,An.depth,0,Ti,di,An.data),wt.__maxMipLevel=0;else if(an.length>0&&Cn){for(let rn=0,Hn=an.length;rn<Hn;rn++)pt=an[rn],c.texImage2D(3553,rn,nn,Ti,di,pt);Dt.generateMipmaps=!1,wt.__maxMipLevel=an.length-1}else c.texImage2D(3553,0,nn,Ti,di,An),wt.__maxMipLevel=0;Xe(Dt,Cn)&&nt(Li,Dt,An.width,An.height),wt.__version=Dt.version,Dt.onUpdate&&Dt.onUpdate(Dt)}function $n(wt,Dt,Xi,Li,gi){const An=w.convert(Xi.format),Cn=w.convert(Xi.type),Ti=Je(Xi.internalFormat,An,Cn);gi===32879||gi===35866?c.texImage3D(gi,0,Ti,Dt.width,Dt.height,Dt.depth,0,An,Cn,null):c.texImage2D(gi,0,Ti,Dt.width,Dt.height,0,An,Cn,null),c.bindFramebuffer(36160,wt),M.framebufferTexture2D(36160,Li,gi,g.get(Xi).__webglTexture,0),c.bindFramebuffer(36160,null)}function tr(wt,Dt,Xi){if(M.bindRenderbuffer(36161,wt),Dt.depthBuffer&&!Dt.stencilBuffer){let Li=33189;if(Xi){const gi=Dt.depthTexture;gi&&gi.isDepthTexture&&(gi.type===1015?Li=36012:gi.type===1014&&(Li=33190));const An=Ar(Dt);M.renderbufferStorageMultisample(36161,An,Li,Dt.width,Dt.height)}else M.renderbufferStorage(36161,Li,Dt.width,Dt.height);M.framebufferRenderbuffer(36160,36096,36161,wt)}else if(Dt.depthBuffer&&Dt.stencilBuffer){if(Xi){const Li=Ar(Dt);M.renderbufferStorageMultisample(36161,Li,35056,Dt.width,Dt.height)}else M.renderbufferStorage(36161,34041,Dt.width,Dt.height);M.framebufferRenderbuffer(36160,33306,36161,wt)}else{const Li=Dt.isWebGLMultipleRenderTargets===!0?Dt.texture[0]:Dt.texture,gi=w.convert(Li.format),An=w.convert(Li.type),Cn=Je(Li.internalFormat,gi,An);if(Xi){const Ti=Ar(Dt);M.renderbufferStorageMultisample(36161,Ti,Cn,Dt.width,Dt.height)}else M.renderbufferStorage(36161,Cn,Dt.width,Dt.height)}M.bindRenderbuffer(36161,null)}function mr(wt){const Dt=g.get(wt),Xi=wt.isWebGLCubeRenderTarget===!0;if(wt.depthTexture){if(Xi)throw new Error("target.depthTexture not supported in Cube render targets");(function(Li,gi){if(gi&&gi.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(c.bindFramebuffer(36160,Li),!gi.depthTexture||!gi.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");g.get(gi.depthTexture).__webglTexture&&gi.depthTexture.image.width===gi.width&&gi.depthTexture.image.height===gi.height||(gi.depthTexture.image.width=gi.width,gi.depthTexture.image.height=gi.height,gi.depthTexture.needsUpdate=!0),vi(gi.depthTexture,0);const An=g.get(gi.depthTexture).__webglTexture;if(gi.depthTexture.format===1026)M.framebufferTexture2D(36160,36096,3553,An,0);else{if(gi.depthTexture.format!==1027)throw new Error("Unknown depthTexture format");M.framebufferTexture2D(36160,33306,3553,An,0)}})(Dt.__webglFramebuffer,wt)}else if(Xi){Dt.__webglDepthbuffer=[];for(let Li=0;Li<6;Li++)c.bindFramebuffer(36160,Dt.__webglFramebuffer[Li]),Dt.__webglDepthbuffer[Li]=M.createRenderbuffer(),tr(Dt.__webglDepthbuffer[Li],wt,!1)}else c.bindFramebuffer(36160,Dt.__webglFramebuffer),Dt.__webglDepthbuffer=M.createRenderbuffer(),tr(Dt.__webglDepthbuffer,wt,!1);c.bindFramebuffer(36160,null)}function Ar(wt){return R&&wt.isWebGLMultisampleRenderTarget?Math.min(q,wt.samples):0}let hr=!1,mn=!1;this.allocateTextureUnit=function(){const wt=ei;return wt>=z&&console.warn("THREE.WebGLTextures: Trying to use "+wt+" texture units while this GPU supports only "+z),ei+=1,wt},this.resetTextureUnits=function(){ei=0},this.setTexture2D=vi,this.setTexture2DArray=function(wt,Dt){const Xi=g.get(wt);wt.version>0&&Xi.__version!==wt.version?vn(Xi,wt,Dt):(c.activeTexture(33984+Dt),c.bindTexture(35866,Xi.__webglTexture))},this.setTexture3D=function(wt,Dt){const Xi=g.get(wt);wt.version>0&&Xi.__version!==wt.version?vn(Xi,wt,Dt):(c.activeTexture(33984+Dt),c.bindTexture(32879,Xi.__webglTexture))},this.setTextureCube=Xt,this.setupRenderTarget=function(wt){const Dt=wt.texture,Xi=g.get(wt),Li=g.get(Dt);wt.addEventListener("dispose",Zt),wt.isWebGLMultipleRenderTargets!==!0&&(Li.__webglTexture=M.createTexture(),Li.__version=Dt.version,A.memory.textures++);const gi=wt.isWebGLCubeRenderTarget===!0,An=wt.isWebGLMultipleRenderTargets===!0,Cn=wt.isWebGLMultisampleRenderTarget===!0,Ti=Dt.isDataTexture3D||Dt.isDataTexture2DArray,pt=de(wt)||R;if(!R||Dt.format!==1022||Dt.type!==1015&&Dt.type!==1016||(Dt.format=1023,console.warn("THREE.WebGLRenderer: Rendering to textures with RGB format is not supported. Using RGBA format instead.")),gi){Xi.__webglFramebuffer=[];for(let di=0;di<6;di++)Xi.__webglFramebuffer[di]=M.createFramebuffer()}else if(Xi.__webglFramebuffer=M.createFramebuffer(),An)if(_.drawBuffers){const di=wt.texture;for(let nn=0,an=di.length;nn<an;nn++){const rn=g.get(di[nn]);rn.__webglTexture===void 0&&(rn.__webglTexture=M.createTexture(),A.memory.textures++)}}else console.warn("THREE.WebGLRenderer: WebGLMultipleRenderTargets can only be used with WebGL2 or WEBGL_draw_buffers extension.");else if(Cn)if(R){Xi.__webglMultisampledFramebuffer=M.createFramebuffer(),Xi.__webglColorRenderbuffer=M.createRenderbuffer(),M.bindRenderbuffer(36161,Xi.__webglColorRenderbuffer);const di=w.convert(Dt.format),nn=w.convert(Dt.type),an=Je(Dt.internalFormat,di,nn),rn=Ar(wt);M.renderbufferStorageMultisample(36161,rn,an,wt.width,wt.height),c.bindFramebuffer(36160,Xi.__webglMultisampledFramebuffer),M.framebufferRenderbuffer(36160,36064,36161,Xi.__webglColorRenderbuffer),M.bindRenderbuffer(36161,null),wt.depthBuffer&&(Xi.__webglDepthRenderbuffer=M.createRenderbuffer(),tr(Xi.__webglDepthRenderbuffer,wt,!0)),c.bindFramebuffer(36160,null)}else console.warn("THREE.WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.");if(gi){c.bindTexture(34067,Li.__webglTexture),gn(34067,Dt,pt);for(let di=0;di<6;di++)$n(Xi.__webglFramebuffer[di],wt,Dt,36064,34069+di);Xe(Dt,pt)&&nt(34067,Dt,wt.width,wt.height),c.unbindTexture()}else if(An){const di=wt.texture;for(let nn=0,an=di.length;nn<an;nn++){const rn=di[nn],Hn=g.get(rn);c.bindTexture(3553,Hn.__webglTexture),gn(3553,rn,pt),$n(Xi.__webglFramebuffer,wt,rn,36064+nn,3553),Xe(rn,pt)&&nt(3553,rn,wt.width,wt.height)}c.unbindTexture()}else{let di=3553;Ti&&(R?di=Dt.isDataTexture3D?32879:35866:console.warn("THREE.DataTexture3D and THREE.DataTexture2DArray only supported with WebGL2.")),c.bindTexture(di,Li.__webglTexture),gn(di,Dt,pt),$n(Xi.__webglFramebuffer,wt,Dt,36064,di),Xe(Dt,pt)&&nt(di,Dt,wt.width,wt.height,wt.depth),c.unbindTexture()}wt.depthBuffer&&mr(wt)},this.updateRenderTargetMipmap=function(wt){const Dt=de(wt)||R,Xi=wt.isWebGLMultipleRenderTargets===!0?wt.texture:[wt.texture];for(let Li=0,gi=Xi.length;Li<gi;Li++){const An=Xi[Li];if(Xe(An,Dt)){const Cn=wt.isWebGLCubeRenderTarget?34067:3553,Ti=g.get(An).__webglTexture;c.bindTexture(Cn,Ti),nt(Cn,An,wt.width,wt.height),c.unbindTexture()}}},this.updateMultisampleRenderTarget=function(wt){if(wt.isWebGLMultisampleRenderTarget)if(R){const Dt=wt.width,Xi=wt.height;let Li=16384;wt.depthBuffer&&(Li|=256),wt.stencilBuffer&&(Li|=1024);const gi=g.get(wt);c.bindFramebuffer(36008,gi.__webglMultisampledFramebuffer),c.bindFramebuffer(36009,gi.__webglFramebuffer),M.blitFramebuffer(0,0,Dt,Xi,0,0,Dt,Xi,Li,9728),c.bindFramebuffer(36008,null),c.bindFramebuffer(36009,gi.__webglMultisampledFramebuffer)}else console.warn("THREE.WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.")},this.safeSetTexture2D=function(wt,Dt){wt&&wt.isWebGLRenderTarget&&(hr===!1&&(console.warn("THREE.WebGLTextures.safeSetTexture2D: don't use render targets as textures. Use their .texture property instead."),hr=!0),wt=wt.texture),vi(wt,Dt)},this.safeSetTextureCube=function(wt,Dt){wt&&wt.isWebGLCubeRenderTarget&&(mn===!1&&(console.warn("THREE.WebGLTextures.safeSetTextureCube: don't use cube render targets as textures. Use their .texture property instead."),mn=!0),wt=wt.texture),Xt(wt,Dt)}}function Np(M,i,c){const g=c.isWebGL2;return{convert:function(_){let w;if(_===1009)return 5121;if(_===1017)return 32819;if(_===1018)return 32820;if(_===1019)return 33635;if(_===1010)return 5120;if(_===1011)return 5122;if(_===1012)return 5123;if(_===1013)return 5124;if(_===1014)return 5125;if(_===1015)return 5126;if(_===1016)return g?5131:(w=i.get("OES_texture_half_float"),w!==null?w.HALF_FLOAT_OES:null);if(_===1021)return 6406;if(_===1022)return 6407;if(_===1023)return 6408;if(_===1024)return 6409;if(_===1025)return 6410;if(_===1026)return 6402;if(_===1027)return 34041;if(_===1028)return 6403;if(_===1029)return 36244;if(_===1030)return 33319;if(_===1031)return 33320;if(_===1032)return 36248;if(_===1033)return 36249;if(_===33776||_===33777||_===33778||_===33779){if(w=i.get("WEBGL_compressed_texture_s3tc"),w===null)return null;if(_===33776)return w.COMPRESSED_RGB_S3TC_DXT1_EXT;if(_===33777)return w.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(_===33778)return w.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(_===33779)return w.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(_===35840||_===35841||_===35842||_===35843){if(w=i.get("WEBGL_compressed_texture_pvrtc"),w===null)return null;if(_===35840)return w.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(_===35841)return w.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(_===35842)return w.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(_===35843)return w.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(_===36196)return w=i.get("WEBGL_compressed_texture_etc1"),w!==null?w.COMPRESSED_RGB_ETC1_WEBGL:null;if((_===37492||_===37496)&&(w=i.get("WEBGL_compressed_texture_etc"),w!==null)){if(_===37492)return w.COMPRESSED_RGB8_ETC2;if(_===37496)return w.COMPRESSED_RGBA8_ETC2_EAC}return _===37808||_===37809||_===37810||_===37811||_===37812||_===37813||_===37814||_===37815||_===37816||_===37817||_===37818||_===37819||_===37820||_===37821||_===37840||_===37841||_===37842||_===37843||_===37844||_===37845||_===37846||_===37847||_===37848||_===37849||_===37850||_===37851||_===37852||_===37853?(w=i.get("WEBGL_compressed_texture_astc"),w!==null?_:null):_===36492?(w=i.get("EXT_texture_compression_bptc"),w!==null?_:null):_===1020?g?34042:(w=i.get("WEBGL_depth_texture"),w!==null?w.UNSIGNED_INT_24_8_WEBGL:null):void 0}}}class lc extends go{constructor(i=[]){super(),this.cameras=i}}lc.prototype.isArrayCamera=!0;class yh extends we{constructor(){super(),this.type="Group"}}yh.prototype.isGroup=!0;const sm={type:"move"};class Ku{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return this._hand===null&&(this._hand=new yh,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return this._targetRay===null&&(this._targetRay=new yh,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new et,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new et),this._targetRay}getGripSpace(){return this._grip===null&&(this._grip=new yh,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new et,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new et),this._grip}dispatchEvent(i){return this._targetRay!==null&&this._targetRay.dispatchEvent(i),this._grip!==null&&this._grip.dispatchEvent(i),this._hand!==null&&this._hand.dispatchEvent(i),this}disconnect(i){return this.dispatchEvent({type:"disconnected",data:i}),this._targetRay!==null&&(this._targetRay.visible=!1),this._grip!==null&&(this._grip.visible=!1),this._hand!==null&&(this._hand.visible=!1),this}update(i,c,g){let _=null,w=null,A=null;const R=this._targetRay,z=this._grip,F=this._hand;if(i&&c.session.visibilityState!=="visible-blurred")if(R!==null&&(_=c.getPose(i.targetRaySpace,g),_!==null&&(R.matrix.fromArray(_.transform.matrix),R.matrix.decompose(R.position,R.rotation,R.scale),_.linearVelocity?(R.hasLinearVelocity=!0,R.linearVelocity.copy(_.linearVelocity)):R.hasLinearVelocity=!1,_.angularVelocity?(R.hasAngularVelocity=!0,R.angularVelocity.copy(_.angularVelocity)):R.hasAngularVelocity=!1,this.dispatchEvent(sm))),F&&i.hand){A=!0;for(const ce of i.hand.values()){const Me=c.getJointPose(ce,g);if(F.joints[ce.jointName]===void 0){const Xe=new yh;Xe.matrixAutoUpdate=!1,Xe.visible=!1,F.joints[ce.jointName]=Xe,F.add(Xe)}const de=F.joints[ce.jointName];Me!==null&&(de.matrix.fromArray(Me.transform.matrix),de.matrix.decompose(de.position,de.rotation,de.scale),de.jointRadius=Me.radius),de.visible=Me!==null}const W=F.joints["index-finger-tip"],q=F.joints["thumb-tip"],J=W.position.distanceTo(q.position),K=.02,re=.005;F.inputState.pinching&&J>K+re?(F.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:i.handedness,target:this})):!F.inputState.pinching&&J<=K-re&&(F.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:i.handedness,target:this}))}else z!==null&&i.gripSpace&&(w=c.getPose(i.gripSpace,g),w!==null&&(z.matrix.fromArray(w.transform.matrix),z.matrix.decompose(z.position,z.rotation,z.scale),w.linearVelocity?(z.hasLinearVelocity=!0,z.linearVelocity.copy(w.linearVelocity)):z.hasLinearVelocity=!1,w.angularVelocity?(z.hasAngularVelocity=!0,z.angularVelocity.copy(w.angularVelocity)):z.hasAngularVelocity=!1));return R!==null&&(R.visible=_!==null),z!==null&&(z.visible=w!==null),F!==null&&(F.visible=A!==null),this}}class Bd extends si{constructor(i,c){super();const g=this,_=i.state;let w=null,A=1,R=null,z="local-floor",F=null,W=null,q=null,J=null,K=null,re=!1,ce=null,Me=null,de=null,Xe=null,nt=null,Je=null;const gt=[],Tt=new Map,Zt=new go;Zt.layers.enable(1),Zt.viewport=new Mr;const ei=new go;ei.layers.enable(2),ei.viewport=new Mr;const vi=[Zt,ei],Xt=new lc;Xt.layers.enable(1),Xt.layers.enable(2);let xi=null,In=null;function gn(mn){const wt=Tt.get(mn.inputSource);wt&&wt.dispatchEvent({type:mn.type,data:mn.inputSource})}function Vi(){Tt.forEach(function(mn,wt){mn.disconnect(wt)}),Tt.clear(),xi=null,In=null,_.bindXRFramebuffer(null),i.setRenderTarget(i.getRenderTarget()),q&&c.deleteFramebuffer(q),ce&&c.deleteFramebuffer(ce),Me&&c.deleteRenderbuffer(Me),de&&c.deleteRenderbuffer(de),q=null,ce=null,Me=null,de=null,K=null,J=null,W=null,w=null,hr.stop(),g.isPresenting=!1,g.dispatchEvent({type:"sessionend"})}function vn(mn){const wt=w.inputSources;for(let Dt=0;Dt<gt.length;Dt++)Tt.set(wt[Dt],gt[Dt]);for(let Dt=0;Dt<mn.removed.length;Dt++){const Xi=mn.removed[Dt],Li=Tt.get(Xi);Li&&(Li.dispatchEvent({type:"disconnected",data:Xi}),Tt.delete(Xi))}for(let Dt=0;Dt<mn.added.length;Dt++){const Xi=mn.added[Dt],Li=Tt.get(Xi);Li&&Li.dispatchEvent({type:"connected",data:Xi})}}this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(mn){let wt=gt[mn];return wt===void 0&&(wt=new Ku,gt[mn]=wt),wt.getTargetRaySpace()},this.getControllerGrip=function(mn){let wt=gt[mn];return wt===void 0&&(wt=new Ku,gt[mn]=wt),wt.getGripSpace()},this.getHand=function(mn){let wt=gt[mn];return wt===void 0&&(wt=new Ku,gt[mn]=wt),wt.getHandSpace()},this.setFramebufferScaleFactor=function(mn){A=mn,g.isPresenting===!0&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(mn){z=mn,g.isPresenting===!0&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return R},this.getBaseLayer=function(){return J!==null?J:K},this.getBinding=function(){return W},this.getFrame=function(){return Xe},this.getSession=function(){return w},this.setSession=async function(mn){if(w=mn,w!==null){w.addEventListener("select",gn),w.addEventListener("selectstart",gn),w.addEventListener("selectend",gn),w.addEventListener("squeeze",gn),w.addEventListener("squeezestart",gn),w.addEventListener("squeezeend",gn),w.addEventListener("end",Vi),w.addEventListener("inputsourceschange",vn);const wt=c.getContextAttributes();if(wt.xrCompatible!==!0&&await c.makeXRCompatible(),w.renderState.layers===void 0){const Dt={antialias:wt.antialias,alpha:wt.alpha,depth:wt.depth,stencil:wt.stencil,framebufferScaleFactor:A};K=new XRWebGLLayer(w,c,Dt),w.updateRenderState({baseLayer:K})}else if(c instanceof WebGLRenderingContext){const Dt={antialias:!0,alpha:wt.alpha,depth:wt.depth,stencil:wt.stencil,framebufferScaleFactor:A};K=new XRWebGLLayer(w,c,Dt),w.updateRenderState({layers:[K]})}else{re=wt.antialias;let Dt=null;wt.depth&&(Je=256,wt.stencil&&(Je|=1024),nt=wt.stencil?33306:36096,Dt=wt.stencil?35056:33190);const Xi={colorFormat:wt.alpha?32856:32849,depthFormat:Dt,scaleFactor:A};W=new XRWebGLBinding(w,c),J=W.createProjectionLayer(Xi),q=c.createFramebuffer(),w.updateRenderState({layers:[J]}),re&&(ce=c.createFramebuffer(),Me=c.createRenderbuffer(),c.bindRenderbuffer(36161,Me),c.renderbufferStorageMultisample(36161,4,32856,J.textureWidth,J.textureHeight),_.bindFramebuffer(36160,ce),c.framebufferRenderbuffer(36160,36064,36161,Me),c.bindRenderbuffer(36161,null),Dt!==null&&(de=c.createRenderbuffer(),c.bindRenderbuffer(36161,de),c.renderbufferStorageMultisample(36161,4,Dt,J.textureWidth,J.textureHeight),c.framebufferRenderbuffer(36160,nt,36161,de),c.bindRenderbuffer(36161,null)),_.bindFramebuffer(36160,null))}R=await w.requestReferenceSpace(z),hr.setContext(w),hr.start(),g.isPresenting=!0,g.dispatchEvent({type:"sessionstart"})}};const $n=new et,tr=new et;function mr(mn,wt){wt===null?mn.matrixWorld.copy(mn.matrix):mn.matrixWorld.multiplyMatrices(wt.matrixWorld,mn.matrix),mn.matrixWorldInverse.copy(mn.matrixWorld).invert()}this.updateCamera=function(mn){if(w===null)return;Xt.near=ei.near=Zt.near=mn.near,Xt.far=ei.far=Zt.far=mn.far,xi===Xt.near&&In===Xt.far||(w.updateRenderState({depthNear:Xt.near,depthFar:Xt.far}),xi=Xt.near,In=Xt.far);const wt=mn.parent,Dt=Xt.cameras;mr(Xt,wt);for(let Li=0;Li<Dt.length;Li++)mr(Dt[Li],wt);Xt.matrixWorld.decompose(Xt.position,Xt.quaternion,Xt.scale),mn.position.copy(Xt.position),mn.quaternion.copy(Xt.quaternion),mn.scale.copy(Xt.scale),mn.matrix.copy(Xt.matrix),mn.matrixWorld.copy(Xt.matrixWorld);const Xi=mn.children;for(let Li=0,gi=Xi.length;Li<gi;Li++)Xi[Li].updateMatrixWorld(!0);Dt.length===2?function(Li,gi,An){$n.setFromMatrixPosition(gi.matrixWorld),tr.setFromMatrixPosition(An.matrixWorld);const Cn=$n.distanceTo(tr),Ti=gi.projectionMatrix.elements,pt=An.projectionMatrix.elements,di=Ti[14]/(Ti[10]-1),nn=Ti[14]/(Ti[10]+1),an=(Ti[9]+1)/Ti[5],rn=(Ti[9]-1)/Ti[5],Hn=(Ti[8]-1)/Ti[0],Sr=(pt[8]+1)/pt[0],sr=di*Hn,Kr=di*Sr,Xr=Cn/(-Hn+Sr),Ko=Xr*-Hn;gi.matrixWorld.decompose(Li.position,Li.quaternion,Li.scale),Li.translateX(Ko),Li.translateZ(Xr),Li.matrixWorld.compose(Li.position,Li.quaternion,Li.scale),Li.matrixWorldInverse.copy(Li.matrixWorld).invert();const Ns=di+Xr,Ho=nn+Xr,Xa=sr-Ko,hd=Kr+(Cn-Ko),pu=an*nn/Ho*Ns,ud=rn*nn/Ho*Ns;Li.projectionMatrix.makePerspective(Xa,hd,pu,ud,Ns,Ho)}(Xt,Zt,ei):Xt.projectionMatrix.copy(Zt.projectionMatrix)},this.getCamera=function(){return Xt},this.getFoveation=function(){return J!==null?J.fixedFoveation:K!==null?K.fixedFoveation:void 0},this.setFoveation=function(mn){J!==null&&(J.fixedFoveation=mn),K!==null&&K.fixedFoveation!==void 0&&(K.fixedFoveation=mn)};let Ar=null;const hr=new ic;hr.setAnimationLoop(function(mn,wt){if(F=wt.getViewerPose(R),Xe=wt,F!==null){const Xi=F.views;K!==null&&_.bindXRFramebuffer(K.framebuffer);let Li=!1;Xi.length!==Xt.cameras.length&&(Xt.cameras.length=0,Li=!0);for(let gi=0;gi<Xi.length;gi++){const An=Xi[gi];let Cn=null;if(K!==null)Cn=K.getViewport(An);else{const pt=W.getViewSubImage(J,An);_.bindXRFramebuffer(q),pt.depthStencilTexture!==void 0&&c.framebufferTexture2D(36160,nt,3553,pt.depthStencilTexture,0),c.framebufferTexture2D(36160,36064,3553,pt.colorTexture,0),Cn=pt.viewport}const Ti=vi[gi];Ti.matrix.fromArray(An.transform.matrix),Ti.projectionMatrix.fromArray(An.projectionMatrix),Ti.viewport.set(Cn.x,Cn.y,Cn.width,Cn.height),gi===0&&Xt.matrix.copy(Ti.matrix),Li===!0&&Xt.cameras.push(Ti)}re&&(_.bindXRFramebuffer(ce),Je!==null&&c.clear(Je))}const Dt=w.inputSources;for(let Xi=0;Xi<gt.length;Xi++){const Li=gt[Xi],gi=Dt[Xi];Li.update(gi,wt,R)}if(Ar&&Ar(mn,wt),re){const Xi=J.textureWidth,Li=J.textureHeight;_.bindFramebuffer(36008,ce),_.bindFramebuffer(36009,q),c.invalidateFramebuffer(36008,[nt]),c.invalidateFramebuffer(36009,[nt]),c.blitFramebuffer(0,0,Xi,Li,0,0,Xi,Li,16384,9728),c.invalidateFramebuffer(36008,[36064]),_.bindFramebuffer(36008,null),_.bindFramebuffer(36009,null),_.bindFramebuffer(36160,ce)}Xe=null}),this.setAnimationLoop=function(mn){Ar=mn},this.dispose=function(){}}}function Up(M){function i(g,_){g.opacity.value=_.opacity,_.color&&g.diffuse.value.copy(_.color),_.emissive&&g.emissive.value.copy(_.emissive).multiplyScalar(_.emissiveIntensity),_.map&&(g.map.value=_.map),_.alphaMap&&(g.alphaMap.value=_.alphaMap),_.specularMap&&(g.specularMap.value=_.specularMap),_.alphaTest>0&&(g.alphaTest.value=_.alphaTest);const w=M.get(_).envMap;if(w){g.envMap.value=w,g.flipEnvMap.value=w.isCubeTexture&&w.isRenderTargetTexture===!1?-1:1,g.reflectivity.value=_.reflectivity,g.ior.value=_.ior,g.refractionRatio.value=_.refractionRatio;const z=M.get(w).__maxMipLevel;z!==void 0&&(g.maxMipLevel.value=z)}let A,R;_.lightMap&&(g.lightMap.value=_.lightMap,g.lightMapIntensity.value=_.lightMapIntensity),_.aoMap&&(g.aoMap.value=_.aoMap,g.aoMapIntensity.value=_.aoMapIntensity),_.map?A=_.map:_.specularMap?A=_.specularMap:_.displacementMap?A=_.displacementMap:_.normalMap?A=_.normalMap:_.bumpMap?A=_.bumpMap:_.roughnessMap?A=_.roughnessMap:_.metalnessMap?A=_.metalnessMap:_.alphaMap?A=_.alphaMap:_.emissiveMap?A=_.emissiveMap:_.clearcoatMap?A=_.clearcoatMap:_.clearcoatNormalMap?A=_.clearcoatNormalMap:_.clearcoatRoughnessMap?A=_.clearcoatRoughnessMap:_.specularIntensityMap?A=_.specularIntensityMap:_.specularTintMap?A=_.specularTintMap:_.transmissionMap?A=_.transmissionMap:_.thicknessMap&&(A=_.thicknessMap),A!==void 0&&(A.isWebGLRenderTarget&&(A=A.texture),A.matrixAutoUpdate===!0&&A.updateMatrix(),g.uvTransform.value.copy(A.matrix)),_.aoMap?R=_.aoMap:_.lightMap&&(R=_.lightMap),R!==void 0&&(R.isWebGLRenderTarget&&(R=R.texture),R.matrixAutoUpdate===!0&&R.updateMatrix(),g.uv2Transform.value.copy(R.matrix))}function c(g,_){g.roughness.value=_.roughness,g.metalness.value=_.metalness,_.roughnessMap&&(g.roughnessMap.value=_.roughnessMap),_.metalnessMap&&(g.metalnessMap.value=_.metalnessMap),_.emissiveMap&&(g.emissiveMap.value=_.emissiveMap),_.bumpMap&&(g.bumpMap.value=_.bumpMap,g.bumpScale.value=_.bumpScale,_.side===1&&(g.bumpScale.value*=-1)),_.normalMap&&(g.normalMap.value=_.normalMap,g.normalScale.value.copy(_.normalScale),_.side===1&&g.normalScale.value.negate()),_.displacementMap&&(g.displacementMap.value=_.displacementMap,g.displacementScale.value=_.displacementScale,g.displacementBias.value=_.displacementBias),M.get(_).envMap&&(g.envMapIntensity.value=_.envMapIntensity)}return{refreshFogUniforms:function(g,_){g.fogColor.value.copy(_.color),_.isFog?(g.fogNear.value=_.near,g.fogFar.value=_.far):_.isFogExp2&&(g.fogDensity.value=_.density)},refreshMaterialUniforms:function(g,_,w,A,R){_.isMeshBasicMaterial?i(g,_):_.isMeshLambertMaterial?(i(g,_),function(z,F){F.emissiveMap&&(z.emissiveMap.value=F.emissiveMap)}(g,_)):_.isMeshToonMaterial?(i(g,_),function(z,F){F.gradientMap&&(z.gradientMap.value=F.gradientMap),F.emissiveMap&&(z.emissiveMap.value=F.emissiveMap),F.bumpMap&&(z.bumpMap.value=F.bumpMap,z.bumpScale.value=F.bumpScale,F.side===1&&(z.bumpScale.value*=-1)),F.normalMap&&(z.normalMap.value=F.normalMap,z.normalScale.value.copy(F.normalScale),F.side===1&&z.normalScale.value.negate()),F.displacementMap&&(z.displacementMap.value=F.displacementMap,z.displacementScale.value=F.displacementScale,z.displacementBias.value=F.displacementBias)}(g,_)):_.isMeshPhongMaterial?(i(g,_),function(z,F){z.specular.value.copy(F.specular),z.shininess.value=Math.max(F.shininess,1e-4),F.emissiveMap&&(z.emissiveMap.value=F.emissiveMap),F.bumpMap&&(z.bumpMap.value=F.bumpMap,z.bumpScale.value=F.bumpScale,F.side===1&&(z.bumpScale.value*=-1)),F.normalMap&&(z.normalMap.value=F.normalMap,z.normalScale.value.copy(F.normalScale),F.side===1&&z.normalScale.value.negate()),F.displacementMap&&(z.displacementMap.value=F.displacementMap,z.displacementScale.value=F.displacementScale,z.displacementBias.value=F.displacementBias)}(g,_)):_.isMeshStandardMaterial?(i(g,_),_.isMeshPhysicalMaterial?function(z,F,W){c(z,F),z.ior.value=F.ior,F.sheenTint&&z.sheenTint.value.copy(F.sheenTint),F.clearcoat>0&&(z.clearcoat.value=F.clearcoat,z.clearcoatRoughness.value=F.clearcoatRoughness,F.clearcoatMap&&(z.clearcoatMap.value=F.clearcoatMap),F.clearcoatRoughnessMap&&(z.clearcoatRoughnessMap.value=F.clearcoatRoughnessMap),F.clearcoatNormalMap&&(z.clearcoatNormalScale.value.copy(F.clearcoatNormalScale),z.clearcoatNormalMap.value=F.clearcoatNormalMap,F.side===1&&z.clearcoatNormalScale.value.negate())),F.transmission>0&&(z.transmission.value=F.transmission,z.transmissionSamplerMap.value=W.texture,z.transmissionSamplerSize.value.set(W.width,W.height),F.transmissionMap&&(z.transmissionMap.value=F.transmissionMap),z.thickness.value=F.thickness,F.thicknessMap&&(z.thicknessMap.value=F.thicknessMap),z.attenuationDistance.value=F.attenuationDistance,z.attenuationTint.value.copy(F.attenuationTint)),z.specularIntensity.value=F.specularIntensity,z.specularTint.value.copy(F.specularTint),F.specularIntensityMap&&(z.specularIntensityMap.value=F.specularIntensityMap),F.specularTintMap&&(z.specularTintMap.value=F.specularTintMap)}(g,_,R):c(g,_)):_.isMeshMatcapMaterial?(i(g,_),function(z,F){F.matcap&&(z.matcap.value=F.matcap),F.bumpMap&&(z.bumpMap.value=F.bumpMap,z.bumpScale.value=F.bumpScale,F.side===1&&(z.bumpScale.value*=-1)),F.normalMap&&(z.normalMap.value=F.normalMap,z.normalScale.value.copy(F.normalScale),F.side===1&&z.normalScale.value.negate()),F.displacementMap&&(z.displacementMap.value=F.displacementMap,z.displacementScale.value=F.displacementScale,z.displacementBias.value=F.displacementBias)}(g,_)):_.isMeshDepthMaterial?(i(g,_),function(z,F){F.displacementMap&&(z.displacementMap.value=F.displacementMap,z.displacementScale.value=F.displacementScale,z.displacementBias.value=F.displacementBias)}(g,_)):_.isMeshDistanceMaterial?(i(g,_),function(z,F){F.displacementMap&&(z.displacementMap.value=F.displacementMap,z.displacementScale.value=F.displacementScale,z.displacementBias.value=F.displacementBias),z.referencePosition.value.copy(F.referencePosition),z.nearDistance.value=F.nearDistance,z.farDistance.value=F.farDistance}(g,_)):_.isMeshNormalMaterial?(i(g,_),function(z,F){F.bumpMap&&(z.bumpMap.value=F.bumpMap,z.bumpScale.value=F.bumpScale,F.side===1&&(z.bumpScale.value*=-1)),F.normalMap&&(z.normalMap.value=F.normalMap,z.normalScale.value.copy(F.normalScale),F.side===1&&z.normalScale.value.negate()),F.displacementMap&&(z.displacementMap.value=F.displacementMap,z.displacementScale.value=F.displacementScale,z.displacementBias.value=F.displacementBias)}(g,_)):_.isLineBasicMaterial?(function(z,F){z.diffuse.value.copy(F.color),z.opacity.value=F.opacity}(g,_),_.isLineDashedMaterial&&function(z,F){z.dashSize.value=F.dashSize,z.totalSize.value=F.dashSize+F.gapSize,z.scale.value=F.scale}(g,_)):_.isPointsMaterial?function(z,F,W,q){z.diffuse.value.copy(F.color),z.opacity.value=F.opacity,z.size.value=F.size*W,z.scale.value=.5*q,F.map&&(z.map.value=F.map),F.alphaMap&&(z.alphaMap.value=F.alphaMap),F.alphaTest>0&&(z.alphaTest.value=F.alphaTest);let J;F.map?J=F.map:F.alphaMap&&(J=F.alphaMap),J!==void 0&&(J.matrixAutoUpdate===!0&&J.updateMatrix(),z.uvTransform.value.copy(J.matrix))}(g,_,w,A):_.isSpriteMaterial?function(z,F){z.diffuse.value.copy(F.color),z.opacity.value=F.opacity,z.rotation.value=F.rotation,F.map&&(z.map.value=F.map),F.alphaMap&&(z.alphaMap.value=F.alphaMap),F.alphaTest>0&&(z.alphaTest.value=F.alphaTest);let W;F.map?W=F.map:F.alphaMap&&(W=F.alphaMap),W!==void 0&&(W.matrixAutoUpdate===!0&&W.updateMatrix(),z.uvTransform.value.copy(W.matrix))}(g,_):_.isShadowMaterial?(g.color.value.copy(_.color),g.opacity.value=_.opacity):_.isShaderMaterial&&(_.uniformsNeedUpdate=!1)}}}function cs(M={}){const i=M.canvas!==void 0?M.canvas:function(){const bt=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return bt.style.display="block",bt}(),c=M.context!==void 0?M.context:null,g=M.alpha!==void 0&&M.alpha,_=M.depth===void 0||M.depth,w=M.stencil===void 0||M.stencil,A=M.antialias!==void 0&&M.antialias,R=M.premultipliedAlpha===void 0||M.premultipliedAlpha,z=M.preserveDrawingBuffer!==void 0&&M.preserveDrawingBuffer,F=M.powerPreference!==void 0?M.powerPreference:"default",W=M.failIfMajorPerformanceCaveat!==void 0&&M.failIfMajorPerformanceCaveat;let q=null,J=null;const K=[],re=[];this.domElement=i,this.debug={checkShaderErrors:!0},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.outputEncoding=3e3,this.physicallyCorrectLights=!1,this.toneMapping=0,this.toneMappingExposure=1;const ce=this;let Me=!1,de=0,Xe=0,nt=null,Je=-1,gt=null;const Tt=new Mr,Zt=new Mr;let ei=null,vi=i.width,Xt=i.height,xi=1,In=null,gn=null;const Vi=new Mr(0,0,vi,Xt),vn=new Mr(0,0,vi,Xt);let $n=!1;const tr=[],mr=new tc;let Ar=!1,hr=!1,mn=null;const wt=new Mn,Dt=new et,Xi={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};function Li(){return nt===null?xi:1}let gi,An,Cn,Ti,pt,di,nn,an,rn,Hn,Sr,sr,Kr,Xr,Ko,Ns,Ho,Xa,hd,pu,ud,Ul,za,En=c;function Bg(bt,Wi){for(let pi=0;pi<bt.length;pi++){const qi=bt[pi],Tn=i.getContext(qi,Wi);if(Tn!==null)return Tn}return null}try{const bt={alpha:g,depth:_,stencil:w,antialias:A,premultipliedAlpha:R,preserveDrawingBuffer:z,powerPreference:F,failIfMajorPerformanceCaveat:W};if(i.addEventListener("webglcontextlost",$a,!1),i.addEventListener("webglcontextrestored",Ng,!1),En===null){const Wi=["webgl2","webgl","experimental-webgl"];if(ce.isWebGL1Renderer===!0&&Wi.shift(),En=Bg(Wi,bt),En===null)throw Bg(Wi)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}En.getShaderPrecisionFormat===void 0&&(En.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(bt){throw console.error("THREE.WebGLRenderer: "+bt.message),bt}function Lm(){gi=new Id(En),An=new nl(En,gi,M),gi.init(An),Ul=new Np(En,gi,An),Cn=new nm(En,gi,An),tr[0]=1029,Ti=new Yr,pt=new Op,di=new rm(En,gi,Cn,pt,An,Ul,Ti),nn=new Zf(ce),an=new Ld(ce),rn=new Wf(En,An),za=new Mp(En,gi,rn,An),Hn=new qh(En,rn,Ti,za),Sr=new Pd(En,Hn,rn,Ti),hd=new $f(En),Ns=new ch(pt),sr=new ma(ce,nn,an,gi,An,za,Ns),Kr=new Up(pt),Xr=new _g(pt),Ko=new Bp(gi,An),Xa=new wp(ce,nn,Cn,Sr,R),Ho=new Ha(ce,Sr,An),pu=new qf(En,gi,Ti,An),ud=new Ap(En,gi,Ti,An),Ti.programs=sr.programs,ce.capabilities=An,ce.extensions=gi,ce.properties=pt,ce.renderLists=Xr,ce.shadowMap=Ho,ce.state=Cn,ce.info=Ti}Lm();const Fo=new Bd(ce,En);function $a(bt){bt.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),Me=!0}function Ng(){console.log("THREE.WebGLRenderer: Context Restored."),Me=!1;const bt=Ti.autoReset,Wi=Ho.enabled,pi=Ho.autoUpdate,qi=Ho.needsUpdate,Tn=Ho.type;Lm(),Ti.autoReset=bt,Ho.enabled=Wi,Ho.autoUpdate=pi,Ho.needsUpdate=qi,Ho.type=Tn}function ay(bt){const Wi=bt.target;Wi.removeEventListener("dispose",ay),function(pi){(function(qi){const Tn=pt.get(qi).programs;Tn!==void 0&&Tn.forEach(function(Hr){sr.releaseProgram(Hr)})})(pi),pt.remove(pi)}(Wi)}this.xr=Fo,this.getContext=function(){return En},this.getContextAttributes=function(){return En.getContextAttributes()},this.forceContextLoss=function(){const bt=gi.get("WEBGL_lose_context");bt&&bt.loseContext()},this.forceContextRestore=function(){const bt=gi.get("WEBGL_lose_context");bt&&bt.restoreContext()},this.getPixelRatio=function(){return xi},this.setPixelRatio=function(bt){bt!==void 0&&(xi=bt,this.setSize(vi,Xt,!1))},this.getSize=function(bt){return bt.set(vi,Xt)},this.setSize=function(bt,Wi,pi){Fo.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(vi=bt,Xt=Wi,i.width=Math.floor(bt*xi),i.height=Math.floor(Wi*xi),pi!==!1&&(i.style.width=bt+"px",i.style.height=Wi+"px"),this.setViewport(0,0,bt,Wi))},this.getDrawingBufferSize=function(bt){return bt.set(vi*xi,Xt*xi).floor()},this.setDrawingBufferSize=function(bt,Wi,pi){vi=bt,Xt=Wi,xi=pi,i.width=Math.floor(bt*pi),i.height=Math.floor(Wi*pi),this.setViewport(0,0,bt,Wi)},this.getCurrentViewport=function(bt){return bt.copy(Tt)},this.getViewport=function(bt){return bt.copy(Vi)},this.setViewport=function(bt,Wi,pi,qi){bt.isVector4?Vi.set(bt.x,bt.y,bt.z,bt.w):Vi.set(bt,Wi,pi,qi),Cn.viewport(Tt.copy(Vi).multiplyScalar(xi).floor())},this.getScissor=function(bt){return bt.copy(vn)},this.setScissor=function(bt,Wi,pi,qi){bt.isVector4?vn.set(bt.x,bt.y,bt.z,bt.w):vn.set(bt,Wi,pi,qi),Cn.scissor(Zt.copy(vn).multiplyScalar(xi).floor())},this.getScissorTest=function(){return $n},this.setScissorTest=function(bt){Cn.setScissorTest($n=bt)},this.setOpaqueSort=function(bt){In=bt},this.setTransparentSort=function(bt){gn=bt},this.getClearColor=function(bt){return bt.copy(Xa.getClearColor())},this.setClearColor=function(){Xa.setClearColor.apply(Xa,arguments)},this.getClearAlpha=function(){return Xa.getClearAlpha()},this.setClearAlpha=function(){Xa.setClearAlpha.apply(Xa,arguments)},this.clear=function(bt,Wi,pi){let qi=0;(bt===void 0||bt)&&(qi|=16384),(Wi===void 0||Wi)&&(qi|=256),(pi===void 0||pi)&&(qi|=1024),En.clear(qi)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){i.removeEventListener("webglcontextlost",$a,!1),i.removeEventListener("webglcontextrestored",Ng,!1),Xr.dispose(),Ko.dispose(),pt.dispose(),nn.dispose(),an.dispose(),Sr.dispose(),za.dispose(),Fo.dispose(),Fo.removeEventListener("sessionstart",np),Fo.removeEventListener("sessionend",ly),mn&&(mn.dispose(),mn=null),dd.stop()},this.renderBufferImmediate=function(bt,Wi){za.initAttributes();const pi=pt.get(bt);bt.hasPositions&&!pi.position&&(pi.position=En.createBuffer()),bt.hasNormals&&!pi.normal&&(pi.normal=En.createBuffer()),bt.hasUvs&&!pi.uv&&(pi.uv=En.createBuffer()),bt.hasColors&&!pi.color&&(pi.color=En.createBuffer());const qi=Wi.getAttributes();bt.hasPositions&&(En.bindBuffer(34962,pi.position),En.bufferData(34962,bt.positionArray,35048),za.enableAttribute(qi.position.location),En.vertexAttribPointer(qi.position.location,3,5126,!1,0,0)),bt.hasNormals&&(En.bindBuffer(34962,pi.normal),En.bufferData(34962,bt.normalArray,35048),za.enableAttribute(qi.normal.location),En.vertexAttribPointer(qi.normal.location,3,5126,!1,0,0)),bt.hasUvs&&(En.bindBuffer(34962,pi.uv),En.bufferData(34962,bt.uvArray,35048),za.enableAttribute(qi.uv.location),En.vertexAttribPointer(qi.uv.location,2,5126,!1,0,0)),bt.hasColors&&(En.bindBuffer(34962,pi.color),En.bufferData(34962,bt.colorArray,35048),za.enableAttribute(qi.color.location),En.vertexAttribPointer(qi.color.location,3,5126,!1,0,0)),za.disableUnusedAttributes(),En.drawArrays(4,0,bt.count),bt.count=0},this.renderBufferDirect=function(bt,Wi,pi,qi,Tn,Hr){Wi===null&&(Wi=Xi);const vr=Tn.isMesh&&Tn.matrixWorld.determinant()<0,Qr=dy(bt,Wi,qi,Tn);Cn.setMaterial(qi,vr);let ts=pi.index;const Gs=pi.attributes.position;if(ts===null){if(Gs===void 0||Gs.count===0)return}else if(ts.count===0)return;let Ir,os=1;qi.wireframe===!0&&(ts=Hn.getWireframeAttribute(pi),os=2),pi.morphAttributes.position===void 0&&pi.morphAttributes.normal===void 0||hd.update(Tn,pi,qi,Qr),za.setup(Tn,qi,Qr,pi,ts);let Jr=pu;ts!==null&&(Ir=rn.get(ts),Jr=ud,Jr.setIndex(Ir));const Xc=ts!==null?ts.count:Gs.count,ro=pi.drawRange.start*os,Vl=pi.drawRange.count*os,Gl=Hr!==null?Hr.start*os:0,mu=Hr!==null?Hr.count*os:1/0,Hl=Math.max(ro,Gl),ko=Math.min(Xc,ro+Vl,Gl+mu)-1,_l=Math.max(0,ko-Hl+1);if(_l!==0){if(Tn.isMesh)qi.wireframe===!0?(Cn.setLineWidth(qi.wireframeLinewidth*Li()),Jr.setMode(1)):Jr.setMode(4);else if(Tn.isLine){let ya=qi.linewidth;ya===void 0&&(ya=1),Cn.setLineWidth(ya*Li()),Tn.isLineSegments?Jr.setMode(1):Tn.isLineLoop?Jr.setMode(2):Jr.setMode(3)}else Tn.isPoints?Jr.setMode(0):Tn.isSprite&&Jr.setMode(4);if(Tn.isInstancedMesh)Jr.renderInstances(Hl,_l,Tn.count);else if(pi.isInstancedBufferGeometry){const ya=Math.min(pi.instanceCount,pi._maxInstanceCount);Jr.renderInstances(Hl,_l,ya)}else Jr.render(Hl,_l)}},this.compile=function(bt,Wi){J=Ko.get(bt),J.init(),re.push(J),bt.traverseVisible(function(pi){pi.isLight&&pi.layers.test(Wi.layers)&&(J.pushLight(pi),pi.castShadow&&J.pushShadow(pi))}),J.setupLights(ce.physicallyCorrectLights),bt.traverse(function(pi){const qi=pi.material;if(qi)if(Array.isArray(qi))for(let Tn=0;Tn<qi.length;Tn++)Rh(qi[Tn],bt,pi);else Rh(qi,bt,pi)}),re.pop(),J=null};let Ug=null;function np(){dd.stop()}function ly(){dd.start()}const dd=new ic;function cy(bt,Wi,pi,qi){if(bt.visible===!1)return;if(bt.layers.test(Wi.layers)){if(bt.isGroup)pi=bt.renderOrder;else if(bt.isLOD)bt.autoUpdate===!0&&bt.update(Wi);else if(bt.isLight)J.pushLight(bt),bt.castShadow&&J.pushShadow(bt);else if(bt.isSprite){if(!bt.frustumCulled||mr.intersectsSprite(bt)){qi&&Dt.setFromMatrixPosition(bt.matrixWorld).applyMatrix4(wt);const Hr=Sr.update(bt),vr=bt.material;vr.visible&&q.push(bt,Hr,vr,pi,Dt.z,null)}}else if(bt.isImmediateRenderObject)qi&&Dt.setFromMatrixPosition(bt.matrixWorld).applyMatrix4(wt),q.push(bt,null,bt.material,pi,Dt.z,null);else if((bt.isMesh||bt.isLine||bt.isPoints)&&(bt.isSkinnedMesh&&bt.skeleton.frame!==Ti.render.frame&&(bt.skeleton.update(),bt.skeleton.frame=Ti.render.frame),!bt.frustumCulled||mr.intersectsObject(bt))){qi&&Dt.setFromMatrixPosition(bt.matrixWorld).applyMatrix4(wt);const Hr=Sr.update(bt),vr=bt.material;if(Array.isArray(vr)){const Qr=Hr.groups;for(let ts=0,Gs=Qr.length;ts<Gs;ts++){const Ir=Qr[ts],os=vr[Ir.materialIndex];os&&os.visible&&q.push(bt,Hr,os,pi,Dt.z,Ir)}}else vr.visible&&q.push(bt,Hr,vr,pi,Dt.z,null)}}const Tn=bt.children;for(let Hr=0,vr=Tn.length;Hr<vr;Hr++)cy(Tn[Hr],Wi,pi,qi)}function hy(bt,Wi,pi,qi){const Tn=bt.opaque,Hr=bt.transmissive,vr=bt.transparent;J.setupLightsView(pi),Hr.length>0&&function(Qr,ts,Gs){if(mn===null){const Jr=A===!0&&An.isWebGL2===!0;mn=new(Jr?Wo:Bs)(1024,1024,{generateMipmaps:!0,type:Ul.convert(1016)!==null?1016:1009,minFilter:1008,magFilter:1003,wrapS:1001,wrapT:1001})}const Ir=ce.getRenderTarget();ce.setRenderTarget(mn),ce.clear();const os=ce.toneMapping;ce.toneMapping=0,fu(Qr,ts,Gs),ce.toneMapping=os,di.updateMultisampleRenderTarget(mn),di.updateRenderTargetMipmap(mn),ce.setRenderTarget(Ir)}(Tn,Wi,pi),qi&&Cn.viewport(Tt.copy(qi)),Tn.length>0&&fu(Tn,Wi,pi),Hr.length>0&&fu(Hr,Wi,pi),vr.length>0&&fu(vr,Wi,pi)}function fu(bt,Wi,pi){const qi=Wi.isScene===!0?Wi.overrideMaterial:null;for(let Tn=0,Hr=bt.length;Tn<Hr;Tn++){const vr=bt[Tn],Qr=vr.object,ts=vr.geometry,Gs=qi===null?vr.material:qi,Ir=vr.group;Qr.layers.test(pi.layers)&&uy(Qr,Wi,pi,ts,Gs,Ir)}}function uy(bt,Wi,pi,qi,Tn,Hr){if(bt.onBeforeRender(ce,Wi,pi,qi,Tn,Hr),bt.modelViewMatrix.multiplyMatrices(pi.matrixWorldInverse,bt.matrixWorld),bt.normalMatrix.getNormalMatrix(bt.modelViewMatrix),bt.isImmediateRenderObject){const vr=dy(pi,Wi,Tn,bt);Cn.setMaterial(Tn),za.reset(),function(Qr,ts){Qr.render(function(Gs){ce.renderBufferImmediate(Gs,ts)})}(bt,vr)}else Tn.transparent===!0&&Tn.side===2?(Tn.side=1,Tn.needsUpdate=!0,ce.renderBufferDirect(pi,Wi,qi,Tn,bt,Hr),Tn.side=0,Tn.needsUpdate=!0,ce.renderBufferDirect(pi,Wi,qi,Tn,bt,Hr),Tn.side=2):ce.renderBufferDirect(pi,Wi,qi,Tn,bt,Hr);bt.onAfterRender(ce,Wi,pi,qi,Tn,Hr)}function Rh(bt,Wi,pi){Wi.isScene!==!0&&(Wi=Xi);const qi=pt.get(bt),Tn=J.state.lights,Hr=J.state.shadowsArray,vr=Tn.state.version,Qr=sr.getParameters(bt,Tn.state,Hr,Wi,pi),ts=sr.getProgramCacheKey(Qr);let Gs=qi.programs;qi.environment=bt.isMeshStandardMaterial?Wi.environment:null,qi.fog=Wi.fog,qi.envMap=(bt.isMeshStandardMaterial?an:nn).get(bt.envMap||qi.environment),Gs===void 0&&(bt.addEventListener("dispose",ay),Gs=new Map,qi.programs=Gs);let Ir=Gs.get(ts);if(Ir!==void 0){if(qi.currentProgram===Ir&&qi.lightsStateVersion===vr)return rp(bt,Qr),Ir}else Qr.uniforms=sr.getUniforms(bt),bt.onBuild(Qr,ce),bt.onBeforeCompile(Qr,ce),Ir=sr.acquireProgram(Qr,ts),Gs.set(ts,Ir),qi.uniforms=Qr.uniforms;const os=qi.uniforms;(bt.isShaderMaterial||bt.isRawShaderMaterial)&&bt.clipping!==!0||(os.clippingPlanes=Ns.uniform),rp(bt,Qr),qi.needsLights=function(ro){return ro.isMeshLambertMaterial||ro.isMeshToonMaterial||ro.isMeshPhongMaterial||ro.isMeshStandardMaterial||ro.isShadowMaterial||ro.isShaderMaterial&&ro.lights===!0}(bt),qi.lightsStateVersion=vr,qi.needsLights&&(os.ambientLightColor.value=Tn.state.ambient,os.lightProbe.value=Tn.state.probe,os.directionalLights.value=Tn.state.directional,os.directionalLightShadows.value=Tn.state.directionalShadow,os.spotLights.value=Tn.state.spot,os.spotLightShadows.value=Tn.state.spotShadow,os.rectAreaLights.value=Tn.state.rectArea,os.ltc_1.value=Tn.state.rectAreaLTC1,os.ltc_2.value=Tn.state.rectAreaLTC2,os.pointLights.value=Tn.state.point,os.pointLightShadows.value=Tn.state.pointShadow,os.hemisphereLights.value=Tn.state.hemi,os.directionalShadowMap.value=Tn.state.directionalShadowMap,os.directionalShadowMatrix.value=Tn.state.directionalShadowMatrix,os.spotShadowMap.value=Tn.state.spotShadowMap,os.spotShadowMatrix.value=Tn.state.spotShadowMatrix,os.pointShadowMap.value=Tn.state.pointShadowMap,os.pointShadowMatrix.value=Tn.state.pointShadowMatrix);const Jr=Ir.getUniforms(),Xc=hl.seqWithValue(Jr.seq,os);return qi.currentProgram=Ir,qi.uniformsList=Xc,Ir}function rp(bt,Wi){const pi=pt.get(bt);pi.outputEncoding=Wi.outputEncoding,pi.instancing=Wi.instancing,pi.skinning=Wi.skinning,pi.morphTargets=Wi.morphTargets,pi.morphNormals=Wi.morphNormals,pi.numClippingPlanes=Wi.numClippingPlanes,pi.numIntersection=Wi.numClipIntersection,pi.vertexAlphas=Wi.vertexAlphas,pi.vertexTangents=Wi.vertexTangents}function dy(bt,Wi,pi,qi){Wi.isScene!==!0&&(Wi=Xi),di.resetTextureUnits();const Tn=Wi.fog,Hr=pi.isMeshStandardMaterial?Wi.environment:null,vr=nt===null?ce.outputEncoding:nt.texture.encoding,Qr=(pi.isMeshStandardMaterial?an:nn).get(pi.envMap||Hr),ts=pi.vertexColors===!0&&!!qi.geometry&&!!qi.geometry.attributes.color&&qi.geometry.attributes.color.itemSize===4,Gs=!!qi.geometry&&!!qi.geometry.attributes.tangent,Ir=!!qi.geometry&&!!qi.geometry.morphAttributes.position,os=!!qi.geometry&&!!qi.geometry.morphAttributes.normal,Jr=pt.get(pi),Xc=J.state.lights;if(Ar===!0&&(hr===!0||bt!==gt)){const xl=bt===gt&&pi.id===Je;Ns.setState(pi,bt,xl)}let ro=!1;pi.version===Jr.__version?Jr.needsLights&&Jr.lightsStateVersion!==Xc.state.version||Jr.outputEncoding!==vr||qi.isInstancedMesh&&Jr.instancing===!1?ro=!0:qi.isInstancedMesh||Jr.instancing!==!0?qi.isSkinnedMesh&&Jr.skinning===!1?ro=!0:qi.isSkinnedMesh||Jr.skinning!==!0?Jr.envMap!==Qr||pi.fog&&Jr.fog!==Tn?ro=!0:Jr.numClippingPlanes===void 0||Jr.numClippingPlanes===Ns.numPlanes&&Jr.numIntersection===Ns.numIntersection?(Jr.vertexAlphas!==ts||Jr.vertexTangents!==Gs||Jr.morphTargets!==Ir||Jr.morphNormals!==os)&&(ro=!0):ro=!0:ro=!0:ro=!0:(ro=!0,Jr.__version=pi.version);let Vl=Jr.currentProgram;ro===!0&&(Vl=Rh(pi,Wi,qi));let Gl=!1,mu=!1,Hl=!1;const ko=Vl.getUniforms(),_l=Jr.uniforms;if(Cn.useProgram(Vl.program)&&(Gl=!0,mu=!0,Hl=!0),pi.id!==Je&&(Je=pi.id,mu=!0),Gl||gt!==bt){if(ko.setValue(En,"projectionMatrix",bt.projectionMatrix),An.logarithmicDepthBuffer&&ko.setValue(En,"logDepthBufFC",2/(Math.log(bt.far+1)/Math.LN2)),gt!==bt&&(gt=bt,mu=!0,Hl=!0),pi.isShaderMaterial||pi.isMeshPhongMaterial||pi.isMeshToonMaterial||pi.isMeshStandardMaterial||pi.envMap){const xl=ko.map.cameraPosition;xl!==void 0&&xl.setValue(En,Dt.setFromMatrixPosition(bt.matrixWorld))}(pi.isMeshPhongMaterial||pi.isMeshToonMaterial||pi.isMeshLambertMaterial||pi.isMeshBasicMaterial||pi.isMeshStandardMaterial||pi.isShaderMaterial)&&ko.setValue(En,"isOrthographic",bt.isOrthographicCamera===!0),(pi.isMeshPhongMaterial||pi.isMeshToonMaterial||pi.isMeshLambertMaterial||pi.isMeshBasicMaterial||pi.isMeshStandardMaterial||pi.isShaderMaterial||pi.isShadowMaterial||qi.isSkinnedMesh)&&ko.setValue(En,"viewMatrix",bt.matrixWorldInverse)}if(qi.isSkinnedMesh){ko.setOptional(En,qi,"bindMatrix"),ko.setOptional(En,qi,"bindMatrixInverse");const xl=qi.skeleton;xl&&(An.floatVertexTextures?(xl.boneTexture===null&&xl.computeBoneTexture(),ko.setValue(En,"boneTexture",xl.boneTexture,di),ko.setValue(En,"boneTextureSize",xl.boneTextureSize)):ko.setOptional(En,xl,"boneMatrices"))}var ya,yl;return(mu||Jr.receiveShadow!==qi.receiveShadow)&&(Jr.receiveShadow=qi.receiveShadow,ko.setValue(En,"receiveShadow",qi.receiveShadow)),mu&&(ko.setValue(En,"toneMappingExposure",ce.toneMappingExposure),Jr.needsLights&&(yl=Hl,(ya=_l).ambientLightColor.needsUpdate=yl,ya.lightProbe.needsUpdate=yl,ya.directionalLights.needsUpdate=yl,ya.directionalLightShadows.needsUpdate=yl,ya.pointLights.needsUpdate=yl,ya.pointLightShadows.needsUpdate=yl,ya.spotLights.needsUpdate=yl,ya.spotLightShadows.needsUpdate=yl,ya.rectAreaLights.needsUpdate=yl,ya.hemisphereLights.needsUpdate=yl),Tn&&pi.fog&&Kr.refreshFogUniforms(_l,Tn),Kr.refreshMaterialUniforms(_l,pi,xi,Xt,mn),hl.upload(En,Jr.uniformsList,_l,di)),pi.isShaderMaterial&&pi.uniformsNeedUpdate===!0&&(hl.upload(En,Jr.uniformsList,_l,di),pi.uniformsNeedUpdate=!1),pi.isSpriteMaterial&&ko.setValue(En,"center",qi.center),ko.setValue(En,"modelViewMatrix",qi.modelViewMatrix),ko.setValue(En,"normalMatrix",qi.normalMatrix),ko.setValue(En,"modelMatrix",qi.matrixWorld),Vl}dd.setAnimationLoop(function(bt){Ug&&Ug(bt)}),typeof window<"u"&&dd.setContext(window),this.setAnimationLoop=function(bt){Ug=bt,Fo.setAnimationLoop(bt),bt===null?dd.stop():dd.start()},Fo.addEventListener("sessionstart",np),Fo.addEventListener("sessionend",ly),this.render=function(bt,Wi){if(Wi!==void 0&&Wi.isCamera!==!0)return void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");if(Me===!0)return;bt.autoUpdate===!0&&bt.updateMatrixWorld(),Wi.parent===null&&Wi.updateMatrixWorld(),Fo.enabled===!0&&Fo.isPresenting===!0&&(Fo.cameraAutoUpdate===!0&&Fo.updateCamera(Wi),Wi=Fo.getCamera()),bt.isScene===!0&&bt.onBeforeRender(ce,bt,Wi,nt),J=Ko.get(bt,re.length),J.init(),re.push(J),wt.multiplyMatrices(Wi.projectionMatrix,Wi.matrixWorldInverse),mr.setFromProjectionMatrix(wt),hr=this.localClippingEnabled,Ar=Ns.init(this.clippingPlanes,hr,Wi),q=Xr.get(bt,K.length),q.init(),K.push(q),cy(bt,Wi,0,ce.sortObjects),q.finish(),ce.sortObjects===!0&&q.sort(In,gn),Ar===!0&&Ns.beginShadows();const pi=J.state.shadowsArray;if(Ho.render(pi,bt,Wi),Ar===!0&&Ns.endShadows(),this.info.autoReset===!0&&this.info.reset(),Xa.render(q,bt),J.setupLights(ce.physicallyCorrectLights),Wi.isArrayCamera){const qi=Wi.cameras;for(let Tn=0,Hr=qi.length;Tn<Hr;Tn++){const vr=qi[Tn];hy(q,bt,vr,vr.viewport)}}else hy(q,bt,Wi);nt!==null&&(di.updateMultisampleRenderTarget(nt),di.updateRenderTargetMipmap(nt)),bt.isScene===!0&&bt.onAfterRender(ce,bt,Wi),Cn.buffers.depth.setTest(!0),Cn.buffers.depth.setMask(!0),Cn.buffers.color.setMask(!0),Cn.setPolygonOffset(!1),za.resetDefaultState(),Je=-1,gt=null,re.pop(),J=re.length>0?re[re.length-1]:null,K.pop(),q=K.length>0?K[K.length-1]:null},this.getActiveCubeFace=function(){return de},this.getActiveMipmapLevel=function(){return Xe},this.getRenderTarget=function(){return nt},this.setRenderTarget=function(bt,Wi=0,pi=0){nt=bt,de=Wi,Xe=pi,bt&&pt.get(bt).__webglFramebuffer===void 0&&di.setupRenderTarget(bt);let qi=null,Tn=!1,Hr=!1;if(bt){const vr=bt.texture;(vr.isDataTexture3D||vr.isDataTexture2DArray)&&(Hr=!0);const Qr=pt.get(bt).__webglFramebuffer;bt.isWebGLCubeRenderTarget?(qi=Qr[Wi],Tn=!0):qi=bt.isWebGLMultisampleRenderTarget?pt.get(bt).__webglMultisampledFramebuffer:Qr,Tt.copy(bt.viewport),Zt.copy(bt.scissor),ei=bt.scissorTest}else Tt.copy(Vi).multiplyScalar(xi).floor(),Zt.copy(vn).multiplyScalar(xi).floor(),ei=$n;if(Cn.bindFramebuffer(36160,qi)&&An.drawBuffers){let vr=!1;if(bt)if(bt.isWebGLMultipleRenderTargets){const Qr=bt.texture;if(tr.length!==Qr.length||tr[0]!==36064){for(let ts=0,Gs=Qr.length;ts<Gs;ts++)tr[ts]=36064+ts;tr.length=Qr.length,vr=!0}}else tr.length===1&&tr[0]===36064||(tr[0]=36064,tr.length=1,vr=!0);else tr.length===1&&tr[0]===1029||(tr[0]=1029,tr.length=1,vr=!0);vr&&(An.isWebGL2?En.drawBuffers(tr):gi.get("WEBGL_draw_buffers").drawBuffersWEBGL(tr))}if(Cn.viewport(Tt),Cn.scissor(Zt),Cn.setScissorTest(ei),Tn){const vr=pt.get(bt.texture);En.framebufferTexture2D(36160,36064,34069+Wi,vr.__webglTexture,pi)}else if(Hr){const vr=pt.get(bt.texture),Qr=Wi||0;En.framebufferTextureLayer(36160,36064,vr.__webglTexture,pi||0,Qr)}Je=-1},this.readRenderTargetPixels=function(bt,Wi,pi,qi,Tn,Hr,vr){if(!bt||!bt.isWebGLRenderTarget)return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let Qr=pt.get(bt).__webglFramebuffer;if(bt.isWebGLCubeRenderTarget&&vr!==void 0&&(Qr=Qr[vr]),Qr){Cn.bindFramebuffer(36160,Qr);try{const ts=bt.texture,Gs=ts.format,Ir=ts.type;if(Gs!==1023&&Ul.convert(Gs)!==En.getParameter(35739))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");const os=Ir===1016&&(gi.has("EXT_color_buffer_half_float")||An.isWebGL2&&gi.has("EXT_color_buffer_float"));if(!(Ir===1009||Ul.convert(Ir)===En.getParameter(35738)||Ir===1015&&(An.isWebGL2||gi.has("OES_texture_float")||gi.has("WEBGL_color_buffer_float"))||os))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");En.checkFramebufferStatus(36160)===36053?Wi>=0&&Wi<=bt.width-qi&&pi>=0&&pi<=bt.height-Tn&&En.readPixels(Wi,pi,qi,Tn,Ul.convert(Gs),Ul.convert(Ir),Hr):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{const ts=nt!==null?pt.get(nt).__webglFramebuffer:null;Cn.bindFramebuffer(36160,ts)}}},this.copyFramebufferToTexture=function(bt,Wi,pi=0){const qi=Math.pow(2,-pi),Tn=Math.floor(Wi.image.width*qi),Hr=Math.floor(Wi.image.height*qi);let vr=Ul.convert(Wi.format);An.isWebGL2&&(vr===6407&&(vr=32849),vr===6408&&(vr=32856)),di.setTexture2D(Wi,0),En.copyTexImage2D(3553,pi,vr,bt.x,bt.y,Tn,Hr,0),Cn.unbindTexture()},this.copyTextureToTexture=function(bt,Wi,pi,qi=0){const Tn=Wi.image.width,Hr=Wi.image.height,vr=Ul.convert(pi.format),Qr=Ul.convert(pi.type);di.setTexture2D(pi,0),En.pixelStorei(37440,pi.flipY),En.pixelStorei(37441,pi.premultiplyAlpha),En.pixelStorei(3317,pi.unpackAlignment),Wi.isDataTexture?En.texSubImage2D(3553,qi,bt.x,bt.y,Tn,Hr,vr,Qr,Wi.image.data):Wi.isCompressedTexture?En.compressedTexSubImage2D(3553,qi,bt.x,bt.y,Wi.mipmaps[0].width,Wi.mipmaps[0].height,vr,Wi.mipmaps[0].data):En.texSubImage2D(3553,qi,bt.x,bt.y,vr,Qr,Wi.image),qi===0&&pi.generateMipmaps&&En.generateMipmap(3553),Cn.unbindTexture()},this.copyTextureToTexture3D=function(bt,Wi,pi,qi,Tn=0){if(ce.isWebGL1Renderer)return void console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: can only be used with WebGL2.");const Hr=bt.max.x-bt.min.x+1,vr=bt.max.y-bt.min.y+1,Qr=bt.max.z-bt.min.z+1,ts=Ul.convert(qi.format),Gs=Ul.convert(qi.type);let Ir;if(qi.isDataTexture3D)di.setTexture3D(qi,0),Ir=32879;else{if(!qi.isDataTexture2DArray)return void console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: only supports THREE.DataTexture3D and THREE.DataTexture2DArray.");di.setTexture2DArray(qi,0),Ir=35866}En.pixelStorei(37440,qi.flipY),En.pixelStorei(37441,qi.premultiplyAlpha),En.pixelStorei(3317,qi.unpackAlignment);const os=En.getParameter(3314),Jr=En.getParameter(32878),Xc=En.getParameter(3316),ro=En.getParameter(3315),Vl=En.getParameter(32877),Gl=pi.isCompressedTexture?pi.mipmaps[0]:pi.image;En.pixelStorei(3314,Gl.width),En.pixelStorei(32878,Gl.height),En.pixelStorei(3316,bt.min.x),En.pixelStorei(3315,bt.min.y),En.pixelStorei(32877,bt.min.z),pi.isDataTexture||pi.isDataTexture3D?En.texSubImage3D(Ir,Tn,Wi.x,Wi.y,Wi.z,Hr,vr,Qr,ts,Gs,Gl.data):pi.isCompressedTexture?(console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: untested support for compressed srcTexture."),En.compressedTexSubImage3D(Ir,Tn,Wi.x,Wi.y,Wi.z,Hr,vr,Qr,ts,Gl.data)):En.texSubImage3D(Ir,Tn,Wi.x,Wi.y,Wi.z,Hr,vr,Qr,ts,Gs,Gl),En.pixelStorei(3314,os),En.pixelStorei(32878,Jr),En.pixelStorei(3316,Xc),En.pixelStorei(3315,ro),En.pixelStorei(32877,Vl),Tn===0&&qi.generateMipmaps&&En.generateMipmap(Ir),Cn.unbindTexture()},this.initTexture=function(bt){di.setTexture2D(bt,0),Cn.unbindTexture()},this.resetState=function(){de=0,Xe=0,nt=null,Cn.reset(),za.reset()},typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}class xh extends cs{}xh.prototype.isWebGL1Renderer=!0;class Oo{constructor(i,c=25e-5){this.name="",this.color=new un(i),this.density=c}clone(){return new Oo(this.color,this.density)}toJSON(){return{type:"FogExp2",color:this.color.getHex(),density:this.density}}}Oo.prototype.isFogExp2=!0;class Ca{constructor(i,c=1,g=1e3){this.name="",this.color=new un(i),this.near=c,this.far=g}clone(){return new Ca(this.color,this.near,this.far)}toJSON(){return{type:"Fog",color:this.color.getHex(),near:this.near,far:this.far}}}Ca.prototype.isFog=!0;class Lc extends we{constructor(){super(),this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0,typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(i,c){return super.copy(i,c),i.background!==null&&(this.background=i.background.clone()),i.environment!==null&&(this.environment=i.environment.clone()),i.fog!==null&&(this.fog=i.fog.clone()),i.overrideMaterial!==null&&(this.overrideMaterial=i.overrideMaterial.clone()),this.autoUpdate=i.autoUpdate,this.matrixAutoUpdate=i.matrixAutoUpdate,this}toJSON(i){const c=super.toJSON(i);return this.fog!==null&&(c.object.fog=this.fog.toJSON()),c}}Lc.prototype.isScene=!0;class Pl{constructor(i,c){this.array=i,this.stride=c,this.count=i!==void 0?i.length/c:0,this.usage=35044,this.updateRange={offset:0,count:-1},this.version=0,this.uuid=Yn()}onUploadCallback(){}set needsUpdate(i){i===!0&&this.version++}setUsage(i){return this.usage=i,this}copy(i){return this.array=new i.array.constructor(i.array),this.count=i.count,this.stride=i.stride,this.usage=i.usage,this}copyAt(i,c,g){i*=this.stride,g*=c.stride;for(let _=0,w=this.stride;_<w;_++)this.array[i+_]=c.array[g+_];return this}set(i,c=0){return this.array.set(i,c),this}clone(i){i.arrayBuffers===void 0&&(i.arrayBuffers={}),this.array.buffer._uuid===void 0&&(this.array.buffer._uuid=Yn()),i.arrayBuffers[this.array.buffer._uuid]===void 0&&(i.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const c=new this.array.constructor(i.arrayBuffers[this.array.buffer._uuid]),g=new this.constructor(c,this.stride);return g.setUsage(this.usage),g}onUpload(i){return this.onUploadCallback=i,this}toJSON(i){return i.arrayBuffers===void 0&&(i.arrayBuffers={}),this.array.buffer._uuid===void 0&&(this.array.buffer._uuid=Yn()),i.arrayBuffers[this.array.buffer._uuid]===void 0&&(i.arrayBuffers[this.array.buffer._uuid]=Array.prototype.slice.call(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}}Pl.prototype.isInterleavedBuffer=!0;const eo=new et;class ja{constructor(i,c,g,_=!1){this.name="",this.data=i,this.itemSize=c,this.offset=g,this.normalized=_===!0}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(i){this.data.needsUpdate=i}applyMatrix4(i){for(let c=0,g=this.data.count;c<g;c++)eo.x=this.getX(c),eo.y=this.getY(c),eo.z=this.getZ(c),eo.applyMatrix4(i),this.setXYZ(c,eo.x,eo.y,eo.z);return this}applyNormalMatrix(i){for(let c=0,g=this.count;c<g;c++)eo.x=this.getX(c),eo.y=this.getY(c),eo.z=this.getZ(c),eo.applyNormalMatrix(i),this.setXYZ(c,eo.x,eo.y,eo.z);return this}transformDirection(i){for(let c=0,g=this.count;c<g;c++)eo.x=this.getX(c),eo.y=this.getY(c),eo.z=this.getZ(c),eo.transformDirection(i),this.setXYZ(c,eo.x,eo.y,eo.z);return this}setX(i,c){return this.data.array[i*this.data.stride+this.offset]=c,this}setY(i,c){return this.data.array[i*this.data.stride+this.offset+1]=c,this}setZ(i,c){return this.data.array[i*this.data.stride+this.offset+2]=c,this}setW(i,c){return this.data.array[i*this.data.stride+this.offset+3]=c,this}getX(i){return this.data.array[i*this.data.stride+this.offset]}getY(i){return this.data.array[i*this.data.stride+this.offset+1]}getZ(i){return this.data.array[i*this.data.stride+this.offset+2]}getW(i){return this.data.array[i*this.data.stride+this.offset+3]}setXY(i,c,g){return i=i*this.data.stride+this.offset,this.data.array[i+0]=c,this.data.array[i+1]=g,this}setXYZ(i,c,g,_){return i=i*this.data.stride+this.offset,this.data.array[i+0]=c,this.data.array[i+1]=g,this.data.array[i+2]=_,this}setXYZW(i,c,g,_,w){return i=i*this.data.stride+this.offset,this.data.array[i+0]=c,this.data.array[i+1]=g,this.data.array[i+2]=_,this.data.array[i+3]=w,this}clone(i){if(i===void 0){console.log("THREE.InterleavedBufferAttribute.clone(): Cloning an interlaved buffer attribute will deinterleave buffer data.");const c=[];for(let g=0;g<this.count;g++){const _=g*this.data.stride+this.offset;for(let w=0;w<this.itemSize;w++)c.push(this.data.array[_+w])}return new pn(new this.array.constructor(c),this.itemSize,this.normalized)}return i.interleavedBuffers===void 0&&(i.interleavedBuffers={}),i.interleavedBuffers[this.data.uuid]===void 0&&(i.interleavedBuffers[this.data.uuid]=this.data.clone(i)),new ja(i.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)}toJSON(i){if(i===void 0){console.log("THREE.InterleavedBufferAttribute.toJSON(): Serializing an interlaved buffer attribute will deinterleave buffer data.");const c=[];for(let g=0;g<this.count;g++){const _=g*this.data.stride+this.offset;for(let w=0;w<this.itemSize;w++)c.push(this.data.array[_+w])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:c,normalized:this.normalized}}return i.interleavedBuffers===void 0&&(i.interleavedBuffers={}),i.interleavedBuffers[this.data.uuid]===void 0&&(i.interleavedBuffers[this.data.uuid]=this.data.toJSON(i)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}}ja.prototype.isInterleavedBufferAttribute=!0;class cc extends Bi{constructor(i){super(),this.type="SpriteMaterial",this.color=new un(16777215),this.map=null,this.alphaMap=null,this.rotation=0,this.sizeAttenuation=!0,this.transparent=!0,this.setValues(i)}copy(i){return super.copy(i),this.color.copy(i.color),this.map=i.map,this.alphaMap=i.alphaMap,this.rotation=i.rotation,this.sizeAttenuation=i.sizeAttenuation,this}}let Ic;cc.prototype.isSpriteMaterial=!0;const Pc=new et,Rc=new et,hc=new et,Wa=new Ri,Qh=new Ri,Nd=new Mn,eu=new et,Rl=new et,vh=new et,Qu=new Ri,Ud=new Ri,om=new Ri;class bh extends we{constructor(i){if(super(),this.type="Sprite",Ic===void 0){Ic=new Er;const c=new Float32Array([-.5,-.5,0,0,0,.5,-.5,0,1,0,.5,.5,0,1,1,-.5,.5,0,0,1]),g=new Pl(c,5);Ic.setIndex([0,1,2,0,2,3]),Ic.setAttribute("position",new ja(g,3,0,!1)),Ic.setAttribute("uv",new ja(g,2,3,!1))}this.geometry=Ic,this.material=i!==void 0?i:new cc,this.center=new Ri(.5,.5)}raycast(i,c){i.camera===null&&console.error('THREE.Sprite: "Raycaster.camera" needs to be set in order to raycast against sprites.'),Rc.setFromMatrixScale(this.matrixWorld),Nd.copy(i.camera.matrixWorld),this.modelViewMatrix.multiplyMatrices(i.camera.matrixWorldInverse,this.matrixWorld),hc.setFromMatrixPosition(this.modelViewMatrix),i.camera.isPerspectiveCamera&&this.material.sizeAttenuation===!1&&Rc.multiplyScalar(-hc.z);const g=this.material.rotation;let _,w;g!==0&&(w=Math.cos(g),_=Math.sin(g));const A=this.center;tu(eu.set(-.5,-.5,0),hc,A,Rc,_,w),tu(Rl.set(.5,-.5,0),hc,A,Rc,_,w),tu(vh.set(.5,.5,0),hc,A,Rc,_,w),Qu.set(0,0),Ud.set(1,0),om.set(1,1);let R=i.ray.intersectTriangle(eu,Rl,vh,!1,Pc);if(R===null&&(tu(Rl.set(-.5,.5,0),hc,A,Rc,_,w),Ud.set(0,1),R=i.ray.intersectTriangle(eu,vh,Rl,!1,Pc),R===null))return;const z=i.ray.origin.distanceTo(Pc);z<i.near||z>i.far||c.push({distance:z,point:Pc.clone(),uv:Zi.getUV(Pc,eu,Rl,vh,Qu,Ud,om,new Ri),face:null,object:this})}copy(i){return super.copy(i),i.center!==void 0&&this.center.copy(i.center),this.material=i.material,this}}function tu(M,i,c,g,_,w){Wa.subVectors(M,c).addScalar(.5).multiply(g),_!==void 0?(Qh.x=w*Wa.x-_*Wa.y,Qh.y=_*Wa.x+w*Wa.y):Qh.copy(Wa),M.copy(i),M.x+=Qh.x,M.y+=Qh.y,M.applyMatrix4(Nd)}bh.prototype.isSprite=!0;const Dc=new et,Vd=new et;class Vp extends we{constructor(){super(),this._currentLevel=0,this.type="LOD",Object.defineProperties(this,{levels:{enumerable:!0,value:[]},isLOD:{value:!0}}),this.autoUpdate=!0}copy(i){super.copy(i,!1);const c=i.levels;for(let g=0,_=c.length;g<_;g++){const w=c[g];this.addLevel(w.object.clone(),w.distance)}return this.autoUpdate=i.autoUpdate,this}addLevel(i,c=0){c=Math.abs(c);const g=this.levels;let _;for(_=0;_<g.length&&!(c<g[_].distance);_++);return g.splice(_,0,{distance:c,object:i}),this.add(i),this}getCurrentLevel(){return this._currentLevel}getObjectForDistance(i){const c=this.levels;if(c.length>0){let g,_;for(g=1,_=c.length;g<_&&!(i<c[g].distance);g++);return c[g-1].object}return null}raycast(i,c){if(this.levels.length>0){Dc.setFromMatrixPosition(this.matrixWorld);const g=i.ray.origin.distanceTo(Dc);this.getObjectForDistance(g).raycast(i,c)}}update(i){const c=this.levels;if(c.length>1){Dc.setFromMatrixPosition(i.matrixWorld),Vd.setFromMatrixPosition(this.matrixWorld);const g=Dc.distanceTo(Vd)/i.zoom;let _,w;for(c[0].object.visible=!0,_=1,w=c.length;_<w&&g>=c[_].distance;_++)c[_-1].object.visible=!1,c[_].object.visible=!0;for(this._currentLevel=_-1;_<w;_++)c[_].object.visible=!1}}toJSON(i){const c=super.toJSON(i);this.autoUpdate===!1&&(c.object.autoUpdate=!1),c.object.levels=[];const g=this.levels;for(let _=0,w=g.length;_<w;_++){const A=g[_];c.object.levels.push({object:A.object.uuid,distance:A.distance})}return c}}const Gp=new et,am=new Mr,wh=new Mr,ed=new et,Hp=new Mn;class Xo extends oo{constructor(i,c){super(i,c),this.type="SkinnedMesh",this.bindMode="attached",this.bindMatrix=new Mn,this.bindMatrixInverse=new Mn}copy(i){return super.copy(i),this.bindMode=i.bindMode,this.bindMatrix.copy(i.bindMatrix),this.bindMatrixInverse.copy(i.bindMatrixInverse),this.skeleton=i.skeleton,this}bind(i,c){this.skeleton=i,c===void 0&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),c=this.matrixWorld),this.bindMatrix.copy(c),this.bindMatrixInverse.copy(c).invert()}pose(){this.skeleton.pose()}normalizeSkinWeights(){const i=new Mr,c=this.geometry.attributes.skinWeight;for(let g=0,_=c.count;g<_;g++){i.x=c.getX(g),i.y=c.getY(g),i.z=c.getZ(g),i.w=c.getW(g);const w=1/i.manhattanLength();w!==1/0?i.multiplyScalar(w):i.set(1,0,0,0),c.setXYZW(g,i.x,i.y,i.z,i.w)}}updateMatrixWorld(i){super.updateMatrixWorld(i),this.bindMode==="attached"?this.bindMatrixInverse.copy(this.matrixWorld).invert():this.bindMode==="detached"?this.bindMatrixInverse.copy(this.bindMatrix).invert():console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)}boneTransform(i,c){const g=this.skeleton,_=this.geometry;am.fromBufferAttribute(_.attributes.skinIndex,i),wh.fromBufferAttribute(_.attributes.skinWeight,i),Gp.fromBufferAttribute(_.attributes.position,i).applyMatrix4(this.bindMatrix),c.set(0,0,0);for(let w=0;w<4;w++){const A=wh.getComponent(w);if(A!==0){const R=am.getComponent(w);Hp.multiplyMatrices(g.bones[R].matrixWorld,g.boneInverses[R]),c.addScaledVector(ed.copy(Gp).applyMatrix4(Hp),A)}}return c.applyMatrix4(this.bindMatrixInverse)}}Xo.prototype.isSkinnedMesh=!0;class iu extends we{constructor(){super(),this.type="Bone"}}iu.prototype.isBone=!0;class Dl extends ds{constructor(i=null,c=1,g=1,_,w,A,R,z,F=1003,W=1003,q,J){super(null,A,R,z,F,W,_,w,q,J),this.image={data:i,width:c,height:g},this.magFilter=F,this.minFilter=W,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.needsUpdate=!0}}Dl.prototype.isDataTexture=!0;const td=new Mn,jp=new Mn;class nu{constructor(i=[],c=[]){this.uuid=Yn(),this.bones=i.slice(0),this.boneInverses=c,this.boneMatrices=null,this.boneTexture=null,this.boneTextureSize=0,this.frame=-1,this.init()}init(){const i=this.bones,c=this.boneInverses;if(this.boneMatrices=new Float32Array(16*i.length),c.length===0)this.calculateInverses();else if(i.length!==c.length){console.warn("THREE.Skeleton: Number of inverse bone matrices does not match amount of bones."),this.boneInverses=[];for(let g=0,_=this.bones.length;g<_;g++)this.boneInverses.push(new Mn)}}calculateInverses(){this.boneInverses.length=0;for(let i=0,c=this.bones.length;i<c;i++){const g=new Mn;this.bones[i]&&g.copy(this.bones[i].matrixWorld).invert(),this.boneInverses.push(g)}}pose(){for(let i=0,c=this.bones.length;i<c;i++){const g=this.bones[i];g&&g.matrixWorld.copy(this.boneInverses[i]).invert()}for(let i=0,c=this.bones.length;i<c;i++){const g=this.bones[i];g&&(g.parent&&g.parent.isBone?(g.matrix.copy(g.parent.matrixWorld).invert(),g.matrix.multiply(g.matrixWorld)):g.matrix.copy(g.matrixWorld),g.matrix.decompose(g.position,g.quaternion,g.scale))}}update(){const i=this.bones,c=this.boneInverses,g=this.boneMatrices,_=this.boneTexture;for(let w=0,A=i.length;w<A;w++){const R=i[w]?i[w].matrixWorld:jp;td.multiplyMatrices(R,c[w]),td.toArray(g,16*w)}_!==null&&(_.needsUpdate=!0)}clone(){return new nu(this.bones,this.boneInverses)}computeBoneTexture(){let i=Math.sqrt(4*this.bones.length);i=ms(i),i=Math.max(i,4);const c=new Float32Array(i*i*4);c.set(this.boneMatrices);const g=new Dl(c,i,i,1023,1015);return this.boneMatrices=c,this.boneTexture=g,this.boneTextureSize=i,this}getBoneByName(i){for(let c=0,g=this.bones.length;c<g;c++){const _=this.bones[c];if(_.name===i)return _}}dispose(){this.boneTexture!==null&&(this.boneTexture.dispose(),this.boneTexture=null)}fromJSON(i,c){this.uuid=i.uuid;for(let g=0,_=i.bones.length;g<_;g++){const w=i.bones[g];let A=c[w];A===void 0&&(console.warn("THREE.Skeleton: No bone found with UUID:",w),A=new iu),this.bones.push(A),this.boneInverses.push(new Mn().fromArray(i.boneInverses[g]))}return this.init(),this}toJSON(){const i={metadata:{version:4.5,type:"Skeleton",generator:"Skeleton.toJSON"},bones:[],boneInverses:[]};i.uuid=this.uuid;const c=this.bones,g=this.boneInverses;for(let _=0,w=c.length;_<w;_++){const A=c[_];i.bones.push(A.uuid);const R=g[_];i.boneInverses.push(R.toArray())}return i}}class La extends pn{constructor(i,c,g,_=1){typeof g=="number"&&(_=g,g=!1,console.error("THREE.InstancedBufferAttribute: The constructor now expects normalized as the third argument.")),super(i,c,g),this.meshPerAttribute=_}copy(i){return super.copy(i),this.meshPerAttribute=i.meshPerAttribute,this}toJSON(){const i=super.toJSON();return i.meshPerAttribute=this.meshPerAttribute,i.isInstancedBufferAttribute=!0,i}}La.prototype.isInstancedBufferAttribute=!0;const Gd=new Mn,Hd=new Mn,zl=[],ru=new oo;class id extends oo{constructor(i,c,g){super(i,c),this.instanceMatrix=new La(new Float32Array(16*g),16),this.instanceColor=null,this.count=g,this.frustumCulled=!1}copy(i){return super.copy(i),this.instanceMatrix.copy(i.instanceMatrix),i.instanceColor!==null&&(this.instanceColor=i.instanceColor.clone()),this.count=i.count,this}getColorAt(i,c){c.fromArray(this.instanceColor.array,3*i)}getMatrixAt(i,c){c.fromArray(this.instanceMatrix.array,16*i)}raycast(i,c){const g=this.matrixWorld,_=this.count;if(ru.geometry=this.geometry,ru.material=this.material,ru.material!==void 0)for(let w=0;w<_;w++){this.getMatrixAt(w,Gd),Hd.multiplyMatrices(g,Gd),ru.matrixWorld=Hd,ru.raycast(i,zl);for(let A=0,R=zl.length;A<R;A++){const z=zl[A];z.instanceId=w,z.object=this,c.push(z)}zl.length=0}}setColorAt(i,c){this.instanceColor===null&&(this.instanceColor=new La(new Float32Array(3*this.instanceMatrix.count),3)),c.toArray(this.instanceColor.array,3*i)}setMatrixAt(i,c){c.toArray(this.instanceMatrix.array,16*i)}updateMorphTargets(){}dispose(){this.dispatchEvent({type:"dispose"})}}id.prototype.isInstancedMesh=!0;class to extends Bi{constructor(i){super(),this.type="LineBasicMaterial",this.color=new un(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.setValues(i)}copy(i){return super.copy(i),this.color.copy(i.color),this.linewidth=i.linewidth,this.linecap=i.linecap,this.linejoin=i.linejoin,this}}to.prototype.isLineBasicMaterial=!0;const Wp=new et,qp=new et,Zp=new Mn,jd=new br,su=new Bn;class ul extends we{constructor(i=new Er,c=new to){super(),this.type="Line",this.geometry=i,this.material=c,this.updateMorphTargets()}copy(i){return super.copy(i),this.material=i.material,this.geometry=i.geometry,this}computeLineDistances(){const i=this.geometry;if(i.isBufferGeometry)if(i.index===null){const c=i.attributes.position,g=[0];for(let _=1,w=c.count;_<w;_++)Wp.fromBufferAttribute(c,_-1),qp.fromBufferAttribute(c,_),g[_]=g[_-1],g[_]+=Wp.distanceTo(qp);i.setAttribute("lineDistance",new Kn(g,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else i.isGeometry&&console.error("THREE.Line.computeLineDistances() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.");return this}raycast(i,c){const g=this.geometry,_=this.matrixWorld,w=i.params.Line.threshold,A=g.drawRange;if(g.boundingSphere===null&&g.computeBoundingSphere(),su.copy(g.boundingSphere),su.applyMatrix4(_),su.radius+=w,i.ray.intersectsSphere(su)===!1)return;Zp.copy(_).invert(),jd.copy(i.ray).applyMatrix4(Zp);const R=w/((this.scale.x+this.scale.y+this.scale.z)/3),z=R*R,F=new et,W=new et,q=new et,J=new et,K=this.isLineSegments?2:1;if(g.isBufferGeometry){const re=g.index,ce=g.attributes.position;if(re!==null)for(let Me=Math.max(0,A.start),de=Math.min(re.count,A.start+A.count)-1;Me<de;Me+=K){const Xe=re.getX(Me),nt=re.getX(Me+1);if(F.fromBufferAttribute(ce,Xe),W.fromBufferAttribute(ce,nt),jd.distanceSqToSegment(F,W,J,q)>z)continue;J.applyMatrix4(this.matrixWorld);const Je=i.ray.origin.distanceTo(J);Je<i.near||Je>i.far||c.push({distance:Je,point:q.clone().applyMatrix4(this.matrixWorld),index:Me,face:null,faceIndex:null,object:this})}else for(let Me=Math.max(0,A.start),de=Math.min(ce.count,A.start+A.count)-1;Me<de;Me+=K){if(F.fromBufferAttribute(ce,Me),W.fromBufferAttribute(ce,Me+1),jd.distanceSqToSegment(F,W,J,q)>z)continue;J.applyMatrix4(this.matrixWorld);const Xe=i.ray.origin.distanceTo(J);Xe<i.near||Xe>i.far||c.push({distance:Xe,point:q.clone().applyMatrix4(this.matrixWorld),index:Me,face:null,faceIndex:null,object:this})}}else g.isGeometry&&console.error("THREE.Line.raycast() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}updateMorphTargets(){const i=this.geometry;if(i.isBufferGeometry){const c=i.morphAttributes,g=Object.keys(c);if(g.length>0){const _=c[g[0]];if(_!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let w=0,A=_.length;w<A;w++){const R=_[w].name||String(w);this.morphTargetInfluences.push(0),this.morphTargetDictionary[R]=w}}}}else{const c=i.morphTargets;c!==void 0&&c.length>0&&console.error("THREE.Line.updateMorphTargets() does not support THREE.Geometry. Use THREE.BufferGeometry instead.")}}}ul.prototype.isLine=!0;const Wd=new et,qd=new et;class $o extends ul{constructor(i,c){super(i,c),this.type="LineSegments"}computeLineDistances(){const i=this.geometry;if(i.isBufferGeometry)if(i.index===null){const c=i.attributes.position,g=[];for(let _=0,w=c.count;_<w;_+=2)Wd.fromBufferAttribute(c,_),qd.fromBufferAttribute(c,_+1),g[_]=_===0?0:g[_-1],g[_+1]=g[_]+Wd.distanceTo(qd);i.setAttribute("lineDistance",new Kn(g,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else i.isGeometry&&console.error("THREE.LineSegments.computeLineDistances() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.");return this}}$o.prototype.isLineSegments=!0;class zc extends ul{constructor(i,c){super(i,c),this.type="LineLoop"}}zc.prototype.isLineLoop=!0;class Oc extends Bi{constructor(i){super(),this.type="PointsMaterial",this.color=new un(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.setValues(i)}copy(i){return super.copy(i),this.color.copy(i.color),this.map=i.map,this.alphaMap=i.alphaMap,this.size=i.size,this.sizeAttenuation=i.sizeAttenuation,this}}Oc.prototype.isPointsMaterial=!0;const Xp=new Mn,Zd=new br,ou=new Bn,Ol=new et;class au extends we{constructor(i=new Er,c=new Oc){super(),this.type="Points",this.geometry=i,this.material=c,this.updateMorphTargets()}copy(i){return super.copy(i),this.material=i.material,this.geometry=i.geometry,this}raycast(i,c){const g=this.geometry,_=this.matrixWorld,w=i.params.Points.threshold,A=g.drawRange;if(g.boundingSphere===null&&g.computeBoundingSphere(),ou.copy(g.boundingSphere),ou.applyMatrix4(_),ou.radius+=w,i.ray.intersectsSphere(ou)===!1)return;Xp.copy(_).invert(),Zd.copy(i.ray).applyMatrix4(Xp);const R=w/((this.scale.x+this.scale.y+this.scale.z)/3),z=R*R;if(g.isBufferGeometry){const F=g.index,W=g.attributes.position;if(F!==null)for(let q=Math.max(0,A.start),J=Math.min(F.count,A.start+A.count);q<J;q++){const K=F.getX(q);Ol.fromBufferAttribute(W,K),Fc(Ol,K,z,_,i,c,this)}else for(let q=Math.max(0,A.start),J=Math.min(W.count,A.start+A.count);q<J;q++)Ol.fromBufferAttribute(W,q),Fc(Ol,q,z,_,i,c,this)}else console.error("THREE.Points.raycast() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}updateMorphTargets(){const i=this.geometry;if(i.isBufferGeometry){const c=i.morphAttributes,g=Object.keys(c);if(g.length>0){const _=c[g[0]];if(_!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let w=0,A=_.length;w<A;w++){const R=_[w].name||String(w);this.morphTargetInfluences.push(0),this.morphTargetDictionary[R]=w}}}}else{const c=i.morphTargets;c!==void 0&&c.length>0&&console.error("THREE.Points.updateMorphTargets() does not support THREE.Geometry. Use THREE.BufferGeometry instead.")}}}function Fc(M,i,c,g,_,w,A){const R=Zd.distanceSqToPoint(M);if(R<c){const z=new et;Zd.closestPointToPoint(M,z),z.applyMatrix4(g);const F=_.ray.origin.distanceTo(z);if(F<_.near||F>_.far)return;w.push({distance:F,distanceToRay:Math.sqrt(R),point:z,index:i,face:null,object:A})}}au.prototype.isPoints=!0;class $p extends ds{constructor(i,c,g,_,w,A,R,z,F){super(i,c,g,_,w,A,R,z,F),this.format=R!==void 0?R:1022,this.minFilter=A!==void 0?A:1006,this.magFilter=w!==void 0?w:1006,this.generateMipmaps=!1;const W=this;"requestVideoFrameCallback"in i&&i.requestVideoFrameCallback(function q(){W.needsUpdate=!0,i.requestVideoFrameCallback(q)})}clone(){return new this.constructor(this.image).copy(this)}update(){const i=this.image;!("requestVideoFrameCallback"in i)&&i.readyState>=i.HAVE_CURRENT_DATA&&(this.needsUpdate=!0)}}$p.prototype.isVideoTexture=!0;class nd extends ds{constructor(i,c,g,_,w,A,R,z,F,W,q,J){super(null,A,R,z,F,W,_,w,q,J),this.image={width:c,height:g},this.mipmaps=i,this.flipY=!1,this.generateMipmaps=!1}}nd.prototype.isCompressedTexture=!0;class m extends ds{constructor(i,c,g,_,w,A,R,z,F){super(i,c,g,_,w,A,R,z,F),this.needsUpdate=!0}}m.prototype.isCanvasTexture=!0;class r extends ds{constructor(i,c,g,_,w,A,R,z,F,W){if((W=W!==void 0?W:1026)!==1026&&W!==1027)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");g===void 0&&W===1026&&(g=1012),g===void 0&&W===1027&&(g=1020),super(null,_,w,A,R,z,W,g,F),this.image={width:i,height:c},this.magFilter=R!==void 0?R:1003,this.minFilter=z!==void 0?z:1003,this.flipY=!1,this.generateMipmaps=!1}}r.prototype.isDepthTexture=!0;class h extends Er{constructor(i=1,c=8,g=0,_=2*Math.PI){super(),this.type="CircleGeometry",this.parameters={radius:i,segments:c,thetaStart:g,thetaLength:_},c=Math.max(3,c);const w=[],A=[],R=[],z=[],F=new et,W=new Ri;A.push(0,0,0),R.push(0,0,1),z.push(.5,.5);for(let q=0,J=3;q<=c;q++,J+=3){const K=g+q/c*_;F.x=i*Math.cos(K),F.y=i*Math.sin(K),A.push(F.x,F.y,F.z),R.push(0,0,1),W.x=(A[J]/i+1)/2,W.y=(A[J+1]/i+1)/2,z.push(W.x,W.y)}for(let q=1;q<=c;q++)w.push(q,q+1,0);this.setIndex(w),this.setAttribute("position",new Kn(A,3)),this.setAttribute("normal",new Kn(R,3)),this.setAttribute("uv",new Kn(z,2))}static fromJSON(i){return new h(i.radius,i.segments,i.thetaStart,i.thetaLength)}}class y extends Er{constructor(i=1,c=1,g=1,_=8,w=1,A=!1,R=0,z=2*Math.PI){super(),this.type="CylinderGeometry",this.parameters={radiusTop:i,radiusBottom:c,height:g,radialSegments:_,heightSegments:w,openEnded:A,thetaStart:R,thetaLength:z};const F=this;_=Math.floor(_),w=Math.floor(w);const W=[],q=[],J=[],K=[];let re=0;const ce=[],Me=g/2;let de=0;function Xe(nt){const Je=re,gt=new Ri,Tt=new et;let Zt=0;const ei=nt===!0?i:c,vi=nt===!0?1:-1;for(let xi=1;xi<=_;xi++)q.push(0,Me*vi,0),J.push(0,vi,0),K.push(.5,.5),re++;const Xt=re;for(let xi=0;xi<=_;xi++){const In=xi/_*z+R,gn=Math.cos(In),Vi=Math.sin(In);Tt.x=ei*Vi,Tt.y=Me*vi,Tt.z=ei*gn,q.push(Tt.x,Tt.y,Tt.z),J.push(0,vi,0),gt.x=.5*gn+.5,gt.y=.5*Vi*vi+.5,K.push(gt.x,gt.y),re++}for(let xi=0;xi<_;xi++){const In=Je+xi,gn=Xt+xi;nt===!0?W.push(gn,gn+1,In):W.push(gn+1,gn,In),Zt+=3}F.addGroup(de,Zt,nt===!0?1:2),de+=Zt}(function(){const nt=new et,Je=new et;let gt=0;const Tt=(c-i)/g;for(let Zt=0;Zt<=w;Zt++){const ei=[],vi=Zt/w,Xt=vi*(c-i)+i;for(let xi=0;xi<=_;xi++){const In=xi/_,gn=In*z+R,Vi=Math.sin(gn),vn=Math.cos(gn);Je.x=Xt*Vi,Je.y=-vi*g+Me,Je.z=Xt*vn,q.push(Je.x,Je.y,Je.z),nt.set(Vi,Tt,vn).normalize(),J.push(nt.x,nt.y,nt.z),K.push(In,1-vi),ei.push(re++)}ce.push(ei)}for(let Zt=0;Zt<_;Zt++)for(let ei=0;ei<w;ei++){const vi=ce[ei][Zt],Xt=ce[ei+1][Zt],xi=ce[ei+1][Zt+1],In=ce[ei][Zt+1];W.push(vi,Xt,In),W.push(Xt,xi,In),gt+=6}F.addGroup(de,gt,0),de+=gt})(),A===!1&&(i>0&&Xe(!0),c>0&&Xe(!1)),this.setIndex(W),this.setAttribute("position",new Kn(q,3)),this.setAttribute("normal",new Kn(J,3)),this.setAttribute("uv",new Kn(K,2))}static fromJSON(i){return new y(i.radiusTop,i.radiusBottom,i.height,i.radialSegments,i.heightSegments,i.openEnded,i.thetaStart,i.thetaLength)}}class b extends y{constructor(i=1,c=1,g=8,_=1,w=!1,A=0,R=2*Math.PI){super(0,i,c,g,_,w,A,R),this.type="ConeGeometry",this.parameters={radius:i,height:c,radialSegments:g,heightSegments:_,openEnded:w,thetaStart:A,thetaLength:R}}static fromJSON(i){return new b(i.radius,i.height,i.radialSegments,i.heightSegments,i.openEnded,i.thetaStart,i.thetaLength)}}class T extends Er{constructor(i,c,g=1,_=0){super(),this.type="PolyhedronGeometry",this.parameters={vertices:i,indices:c,radius:g,detail:_};const w=[],A=[];function R(J,K,re,ce){const Me=ce+1,de=[];for(let Xe=0;Xe<=Me;Xe++){de[Xe]=[];const nt=J.clone().lerp(re,Xe/Me),Je=K.clone().lerp(re,Xe/Me),gt=Me-Xe;for(let Tt=0;Tt<=gt;Tt++)de[Xe][Tt]=Tt===0&&Xe===Me?nt:nt.clone().lerp(Je,Tt/gt)}for(let Xe=0;Xe<Me;Xe++)for(let nt=0;nt<2*(Me-Xe)-1;nt++){const Je=Math.floor(nt/2);nt%2==0?(z(de[Xe][Je+1]),z(de[Xe+1][Je]),z(de[Xe][Je])):(z(de[Xe][Je+1]),z(de[Xe+1][Je+1]),z(de[Xe+1][Je]))}}function z(J){w.push(J.x,J.y,J.z)}function F(J,K){const re=3*J;K.x=i[re+0],K.y=i[re+1],K.z=i[re+2]}function W(J,K,re,ce){ce<0&&J.x===1&&(A[K]=J.x-1),re.x===0&&re.z===0&&(A[K]=ce/2/Math.PI+.5)}function q(J){return Math.atan2(J.z,-J.x)}(function(J){const K=new et,re=new et,ce=new et;for(let Me=0;Me<c.length;Me+=3)F(c[Me+0],K),F(c[Me+1],re),F(c[Me+2],ce),R(K,re,ce,J)})(_),function(J){const K=new et;for(let re=0;re<w.length;re+=3)K.x=w[re+0],K.y=w[re+1],K.z=w[re+2],K.normalize().multiplyScalar(J),w[re+0]=K.x,w[re+1]=K.y,w[re+2]=K.z}(g),function(){const J=new et;for(let re=0;re<w.length;re+=3){J.x=w[re+0],J.y=w[re+1],J.z=w[re+2];const ce=q(J)/2/Math.PI+.5,Me=(K=J,Math.atan2(-K.y,Math.sqrt(K.x*K.x+K.z*K.z))/Math.PI+.5);A.push(ce,1-Me)}var K;(function(){const re=new et,ce=new et,Me=new et,de=new et,Xe=new Ri,nt=new Ri,Je=new Ri;for(let gt=0,Tt=0;gt<w.length;gt+=9,Tt+=6){re.set(w[gt+0],w[gt+1],w[gt+2]),ce.set(w[gt+3],w[gt+4],w[gt+5]),Me.set(w[gt+6],w[gt+7],w[gt+8]),Xe.set(A[Tt+0],A[Tt+1]),nt.set(A[Tt+2],A[Tt+3]),Je.set(A[Tt+4],A[Tt+5]),de.copy(re).add(ce).add(Me).divideScalar(3);const Zt=q(de);W(Xe,Tt+0,re,Zt),W(nt,Tt+2,ce,Zt),W(Je,Tt+4,Me,Zt)}})(),function(){for(let re=0;re<A.length;re+=6){const ce=A[re+0],Me=A[re+2],de=A[re+4],Xe=Math.max(ce,Me,de),nt=Math.min(ce,Me,de);Xe>.9&&nt<.1&&(ce<.2&&(A[re+0]+=1),Me<.2&&(A[re+2]+=1),de<.2&&(A[re+4]+=1))}}()}(),this.setAttribute("position",new Kn(w,3)),this.setAttribute("normal",new Kn(w.slice(),3)),this.setAttribute("uv",new Kn(A,2)),_===0?this.computeVertexNormals():this.normalizeNormals()}static fromJSON(i){return new T(i.vertices,i.indices,i.radius,i.details)}}class E extends T{constructor(i=1,c=0){const g=(1+Math.sqrt(5))/2,_=1/g;super([-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-_,-g,0,-_,g,0,_,-g,0,_,g,-_,-g,0,-_,g,0,_,-g,0,_,g,0,-g,0,-_,g,0,-_,-g,0,_,g,0,_],[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9],i,c),this.type="DodecahedronGeometry",this.parameters={radius:i,detail:c}}static fromJSON(i){return new E(i.radius,i.detail)}}const I=new et,k=new et,N=new et,H=new Zi;class X extends Er{constructor(i,c){if(super(),this.type="EdgesGeometry",this.parameters={thresholdAngle:c},c=c!==void 0?c:1,i.isGeometry===!0)return void console.error("THREE.EdgesGeometry no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.");const g=Math.pow(10,4),_=Math.cos(kn*c),w=i.getIndex(),A=i.getAttribute("position"),R=w?w.count:A.count,z=[0,0,0],F=["a","b","c"],W=new Array(3),q={},J=[];for(let K=0;K<R;K+=3){w?(z[0]=w.getX(K),z[1]=w.getX(K+1),z[2]=w.getX(K+2)):(z[0]=K,z[1]=K+1,z[2]=K+2);const{a:re,b:ce,c:Me}=H;if(re.fromBufferAttribute(A,z[0]),ce.fromBufferAttribute(A,z[1]),Me.fromBufferAttribute(A,z[2]),H.getNormal(N),W[0]=`${Math.round(re.x*g)},${Math.round(re.y*g)},${Math.round(re.z*g)}`,W[1]=`${Math.round(ce.x*g)},${Math.round(ce.y*g)},${Math.round(ce.z*g)}`,W[2]=`${Math.round(Me.x*g)},${Math.round(Me.y*g)},${Math.round(Me.z*g)}`,W[0]!==W[1]&&W[1]!==W[2]&&W[2]!==W[0])for(let de=0;de<3;de++){const Xe=(de+1)%3,nt=W[de],Je=W[Xe],gt=H[F[de]],Tt=H[F[Xe]],Zt=`${nt}_${Je}`,ei=`${Je}_${nt}`;ei in q&&q[ei]?(N.dot(q[ei].normal)<=_&&(J.push(gt.x,gt.y,gt.z),J.push(Tt.x,Tt.y,Tt.z)),q[ei]=null):Zt in q||(q[Zt]={index0:z[de],index1:z[Xe],normal:N.clone()})}}for(const K in q)if(q[K]){const{index0:re,index1:ce}=q[K];I.fromBufferAttribute(A,re),k.fromBufferAttribute(A,ce),J.push(I.x,I.y,I.z),J.push(k.x,k.y,k.z)}this.setAttribute("position",new Kn(J,3))}}class ee{constructor(){this.type="Curve",this.arcLengthDivisions=200}getPoint(){return console.warn("THREE.Curve: .getPoint() not implemented."),null}getPointAt(i,c){const g=this.getUtoTmapping(i);return this.getPoint(g,c)}getPoints(i=5){const c=[];for(let g=0;g<=i;g++)c.push(this.getPoint(g/i));return c}getSpacedPoints(i=5){const c=[];for(let g=0;g<=i;g++)c.push(this.getPointAt(g/i));return c}getLength(){const i=this.getLengths();return i[i.length-1]}getLengths(i=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===i+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const c=[];let g,_=this.getPoint(0),w=0;c.push(0);for(let A=1;A<=i;A++)g=this.getPoint(A/i),w+=g.distanceTo(_),c.push(w),_=g;return this.cacheArcLengths=c,c}updateArcLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(i,c){const g=this.getLengths();let _=0;const w=g.length;let A;A=c||i*g[w-1];let R,z=0,F=w-1;for(;z<=F;)if(_=Math.floor(z+(F-z)/2),R=g[_]-A,R<0)z=_+1;else{if(!(R>0)){F=_;break}F=_-1}if(_=F,g[_]===A)return _/(w-1);const W=g[_];return(_+(A-W)/(g[_+1]-W))/(w-1)}getTangent(i,c){let _=i-1e-4,w=i+1e-4;_<0&&(_=0),w>1&&(w=1);const A=this.getPoint(_),R=this.getPoint(w),z=c||(A.isVector2?new Ri:new et);return z.copy(R).sub(A).normalize(),z}getTangentAt(i,c){const g=this.getUtoTmapping(i);return this.getTangent(g,c)}computeFrenetFrames(i,c){const g=new et,_=[],w=[],A=[],R=new et,z=new Mn;for(let K=0;K<=i;K++){const re=K/i;_[K]=this.getTangentAt(re,new et),_[K].normalize()}w[0]=new et,A[0]=new et;let F=Number.MAX_VALUE;const W=Math.abs(_[0].x),q=Math.abs(_[0].y),J=Math.abs(_[0].z);W<=F&&(F=W,g.set(1,0,0)),q<=F&&(F=q,g.set(0,1,0)),J<=F&&g.set(0,0,1),R.crossVectors(_[0],g).normalize(),w[0].crossVectors(_[0],R),A[0].crossVectors(_[0],w[0]);for(let K=1;K<=i;K++){if(w[K]=w[K-1].clone(),A[K]=A[K-1].clone(),R.crossVectors(_[K-1],_[K]),R.length()>Number.EPSILON){R.normalize();const re=Math.acos(Jn(_[K-1].dot(_[K]),-1,1));w[K].applyMatrix4(z.makeRotationAxis(R,re))}A[K].crossVectors(_[K],w[K])}if(c===!0){let K=Math.acos(Jn(w[0].dot(w[i]),-1,1));K/=i,_[0].dot(R.crossVectors(w[0],w[i]))>0&&(K=-K);for(let re=1;re<=i;re++)w[re].applyMatrix4(z.makeRotationAxis(_[re],K*re)),A[re].crossVectors(_[re],w[re])}return{tangents:_,normals:w,binormals:A}}clone(){return new this.constructor().copy(this)}copy(i){return this.arcLengthDivisions=i.arcLengthDivisions,this}toJSON(){const i={metadata:{version:4.5,type:"Curve",generator:"Curve.toJSON"}};return i.arcLengthDivisions=this.arcLengthDivisions,i.type=this.type,i}fromJSON(i){return this.arcLengthDivisions=i.arcLengthDivisions,this}}class ie extends ee{constructor(i=0,c=0,g=1,_=1,w=0,A=2*Math.PI,R=!1,z=0){super(),this.type="EllipseCurve",this.aX=i,this.aY=c,this.xRadius=g,this.yRadius=_,this.aStartAngle=w,this.aEndAngle=A,this.aClockwise=R,this.aRotation=z}getPoint(i,c){const g=c||new Ri,_=2*Math.PI;let w=this.aEndAngle-this.aStartAngle;const A=Math.abs(w)<Number.EPSILON;for(;w<0;)w+=_;for(;w>_;)w-=_;w<Number.EPSILON&&(w=A?0:_),this.aClockwise!==!0||A||(w===_?w=-_:w-=_);const R=this.aStartAngle+i*w;let z=this.aX+this.xRadius*Math.cos(R),F=this.aY+this.yRadius*Math.sin(R);if(this.aRotation!==0){const W=Math.cos(this.aRotation),q=Math.sin(this.aRotation),J=z-this.aX,K=F-this.aY;z=J*W-K*q+this.aX,F=J*q+K*W+this.aY}return g.set(z,F)}copy(i){return super.copy(i),this.aX=i.aX,this.aY=i.aY,this.xRadius=i.xRadius,this.yRadius=i.yRadius,this.aStartAngle=i.aStartAngle,this.aEndAngle=i.aEndAngle,this.aClockwise=i.aClockwise,this.aRotation=i.aRotation,this}toJSON(){const i=super.toJSON();return i.aX=this.aX,i.aY=this.aY,i.xRadius=this.xRadius,i.yRadius=this.yRadius,i.aStartAngle=this.aStartAngle,i.aEndAngle=this.aEndAngle,i.aClockwise=this.aClockwise,i.aRotation=this.aRotation,i}fromJSON(i){return super.fromJSON(i),this.aX=i.aX,this.aY=i.aY,this.xRadius=i.xRadius,this.yRadius=i.yRadius,this.aStartAngle=i.aStartAngle,this.aEndAngle=i.aEndAngle,this.aClockwise=i.aClockwise,this.aRotation=i.aRotation,this}}ie.prototype.isEllipseCurve=!0;class ue extends ie{constructor(i,c,g,_,w,A){super(i,c,g,g,_,w,A),this.type="ArcCurve"}}function pe(){let M=0,i=0,c=0,g=0;function _(w,A,R,z){M=w,i=R,c=-3*w+3*A-2*R-z,g=2*w-2*A+R+z}return{initCatmullRom:function(w,A,R,z,F){_(A,R,F*(R-w),F*(z-A))},initNonuniformCatmullRom:function(w,A,R,z,F,W,q){let J=(A-w)/F-(R-w)/(F+W)+(R-A)/W,K=(R-A)/W-(z-A)/(W+q)+(z-R)/q;J*=W,K*=W,_(A,R,J,K)},calc:function(w){const A=w*w;return M+i*w+c*A+g*(A*w)}}}ue.prototype.isArcCurve=!0;const fe=new et,_e=new pe,Le=new pe,Fe=new pe;class Be extends ee{constructor(i=[],c=!1,g="centripetal",_=.5){super(),this.type="CatmullRomCurve3",this.points=i,this.closed=c,this.curveType=g,this.tension=_}getPoint(i,c=new et){const g=c,_=this.points,w=_.length,A=(w-(this.closed?0:1))*i;let R,z,F=Math.floor(A),W=A-F;this.closed?F+=F>0?0:(Math.floor(Math.abs(F)/w)+1)*w:W===0&&F===w-1&&(F=w-2,W=1),this.closed||F>0?R=_[(F-1)%w]:(fe.subVectors(_[0],_[1]).add(_[0]),R=fe);const q=_[F%w],J=_[(F+1)%w];if(this.closed||F+2<w?z=_[(F+2)%w]:(fe.subVectors(_[w-1],_[w-2]).add(_[w-1]),z=fe),this.curveType==="centripetal"||this.curveType==="chordal"){const K=this.curveType==="chordal"?.5:.25;let re=Math.pow(R.distanceToSquared(q),K),ce=Math.pow(q.distanceToSquared(J),K),Me=Math.pow(J.distanceToSquared(z),K);ce<1e-4&&(ce=1),re<1e-4&&(re=ce),Me<1e-4&&(Me=ce),_e.initNonuniformCatmullRom(R.x,q.x,J.x,z.x,re,ce,Me),Le.initNonuniformCatmullRom(R.y,q.y,J.y,z.y,re,ce,Me),Fe.initNonuniformCatmullRom(R.z,q.z,J.z,z.z,re,ce,Me)}else this.curveType==="catmullrom"&&(_e.initCatmullRom(R.x,q.x,J.x,z.x,this.tension),Le.initCatmullRom(R.y,q.y,J.y,z.y,this.tension),Fe.initCatmullRom(R.z,q.z,J.z,z.z,this.tension));return g.set(_e.calc(W),Le.calc(W),Fe.calc(W)),g}copy(i){super.copy(i),this.points=[];for(let c=0,g=i.points.length;c<g;c++){const _=i.points[c];this.points.push(_.clone())}return this.closed=i.closed,this.curveType=i.curveType,this.tension=i.tension,this}toJSON(){const i=super.toJSON();i.points=[];for(let c=0,g=this.points.length;c<g;c++){const _=this.points[c];i.points.push(_.toArray())}return i.closed=this.closed,i.curveType=this.curveType,i.tension=this.tension,i}fromJSON(i){super.fromJSON(i),this.points=[];for(let c=0,g=i.points.length;c<g;c++){const _=i.points[c];this.points.push(new et().fromArray(_))}return this.closed=i.closed,this.curveType=i.curveType,this.tension=i.tension,this}}function $e(M,i,c,g,_){const w=.5*(g-i),A=.5*(_-c),R=M*M;return(2*c-2*g+w+A)*(M*R)+(-3*c+3*g-2*w-A)*R+w*M+c}function Ze(M,i,c,g){return function(_,w){const A=1-_;return A*A*w}(M,i)+function(_,w){return 2*(1-_)*_*w}(M,c)+function(_,w){return _*_*w}(M,g)}function rt(M,i,c,g,_){return function(w,A){const R=1-w;return R*R*R*A}(M,i)+function(w,A){const R=1-w;return 3*R*R*w*A}(M,c)+function(w,A){return 3*(1-w)*w*w*A}(M,g)+function(w,A){return w*w*w*A}(M,_)}Be.prototype.isCatmullRomCurve3=!0;class xe extends ee{constructor(i=new Ri,c=new Ri,g=new Ri,_=new Ri){super(),this.type="CubicBezierCurve",this.v0=i,this.v1=c,this.v2=g,this.v3=_}getPoint(i,c=new Ri){const g=c,_=this.v0,w=this.v1,A=this.v2,R=this.v3;return g.set(rt(i,_.x,w.x,A.x,R.x),rt(i,_.y,w.y,A.y,R.y)),g}copy(i){return super.copy(i),this.v0.copy(i.v0),this.v1.copy(i.v1),this.v2.copy(i.v2),this.v3.copy(i.v3),this}toJSON(){const i=super.toJSON();return i.v0=this.v0.toArray(),i.v1=this.v1.toArray(),i.v2=this.v2.toArray(),i.v3=this.v3.toArray(),i}fromJSON(i){return super.fromJSON(i),this.v0.fromArray(i.v0),this.v1.fromArray(i.v1),this.v2.fromArray(i.v2),this.v3.fromArray(i.v3),this}}xe.prototype.isCubicBezierCurve=!0;class Ne extends ee{constructor(i=new et,c=new et,g=new et,_=new et){super(),this.type="CubicBezierCurve3",this.v0=i,this.v1=c,this.v2=g,this.v3=_}getPoint(i,c=new et){const g=c,_=this.v0,w=this.v1,A=this.v2,R=this.v3;return g.set(rt(i,_.x,w.x,A.x,R.x),rt(i,_.y,w.y,A.y,R.y),rt(i,_.z,w.z,A.z,R.z)),g}copy(i){return super.copy(i),this.v0.copy(i.v0),this.v1.copy(i.v1),this.v2.copy(i.v2),this.v3.copy(i.v3),this}toJSON(){const i=super.toJSON();return i.v0=this.v0.toArray(),i.v1=this.v1.toArray(),i.v2=this.v2.toArray(),i.v3=this.v3.toArray(),i}fromJSON(i){return super.fromJSON(i),this.v0.fromArray(i.v0),this.v1.fromArray(i.v1),this.v2.fromArray(i.v2),this.v3.fromArray(i.v3),this}}Ne.prototype.isCubicBezierCurve3=!0;class ct extends ee{constructor(i=new Ri,c=new Ri){super(),this.type="LineCurve",this.v1=i,this.v2=c}getPoint(i,c=new Ri){const g=c;return i===1?g.copy(this.v2):(g.copy(this.v2).sub(this.v1),g.multiplyScalar(i).add(this.v1)),g}getPointAt(i,c){return this.getPoint(i,c)}getTangent(i,c){const g=c||new Ri;return g.copy(this.v2).sub(this.v1).normalize(),g}copy(i){return super.copy(i),this.v1.copy(i.v1),this.v2.copy(i.v2),this}toJSON(){const i=super.toJSON();return i.v1=this.v1.toArray(),i.v2=this.v2.toArray(),i}fromJSON(i){return super.fromJSON(i),this.v1.fromArray(i.v1),this.v2.fromArray(i.v2),this}}ct.prototype.isLineCurve=!0;class Ot extends ee{constructor(i=new et,c=new et){super(),this.type="LineCurve3",this.isLineCurve3=!0,this.v1=i,this.v2=c}getPoint(i,c=new et){const g=c;return i===1?g.copy(this.v2):(g.copy(this.v2).sub(this.v1),g.multiplyScalar(i).add(this.v1)),g}getPointAt(i,c){return this.getPoint(i,c)}copy(i){return super.copy(i),this.v1.copy(i.v1),this.v2.copy(i.v2),this}toJSON(){const i=super.toJSON();return i.v1=this.v1.toArray(),i.v2=this.v2.toArray(),i}fromJSON(i){return super.fromJSON(i),this.v1.fromArray(i.v1),this.v2.fromArray(i.v2),this}}class mt extends ee{constructor(i=new Ri,c=new Ri,g=new Ri){super(),this.type="QuadraticBezierCurve",this.v0=i,this.v1=c,this.v2=g}getPoint(i,c=new Ri){const g=c,_=this.v0,w=this.v1,A=this.v2;return g.set(Ze(i,_.x,w.x,A.x),Ze(i,_.y,w.y,A.y)),g}copy(i){return super.copy(i),this.v0.copy(i.v0),this.v1.copy(i.v1),this.v2.copy(i.v2),this}toJSON(){const i=super.toJSON();return i.v0=this.v0.toArray(),i.v1=this.v1.toArray(),i.v2=this.v2.toArray(),i}fromJSON(i){return super.fromJSON(i),this.v0.fromArray(i.v0),this.v1.fromArray(i.v1),this.v2.fromArray(i.v2),this}}mt.prototype.isQuadraticBezierCurve=!0;class it extends ee{constructor(i=new et,c=new et,g=new et){super(),this.type="QuadraticBezierCurve3",this.v0=i,this.v1=c,this.v2=g}getPoint(i,c=new et){const g=c,_=this.v0,w=this.v1,A=this.v2;return g.set(Ze(i,_.x,w.x,A.x),Ze(i,_.y,w.y,A.y),Ze(i,_.z,w.z,A.z)),g}copy(i){return super.copy(i),this.v0.copy(i.v0),this.v1.copy(i.v1),this.v2.copy(i.v2),this}toJSON(){const i=super.toJSON();return i.v0=this.v0.toArray(),i.v1=this.v1.toArray(),i.v2=this.v2.toArray(),i}fromJSON(i){return super.fromJSON(i),this.v0.fromArray(i.v0),this.v1.fromArray(i.v1),this.v2.fromArray(i.v2),this}}it.prototype.isQuadraticBezierCurve3=!0;class Nt extends ee{constructor(i=[]){super(),this.type="SplineCurve",this.points=i}getPoint(i,c=new Ri){const g=c,_=this.points,w=(_.length-1)*i,A=Math.floor(w),R=w-A,z=_[A===0?A:A-1],F=_[A],W=_[A>_.length-2?_.length-1:A+1],q=_[A>_.length-3?_.length-1:A+2];return g.set($e(R,z.x,F.x,W.x,q.x),$e(R,z.y,F.y,W.y,q.y)),g}copy(i){super.copy(i),this.points=[];for(let c=0,g=i.points.length;c<g;c++){const _=i.points[c];this.points.push(_.clone())}return this}toJSON(){const i=super.toJSON();i.points=[];for(let c=0,g=this.points.length;c<g;c++){const _=this.points[c];i.points.push(_.toArray())}return i}fromJSON(i){super.fromJSON(i),this.points=[];for(let c=0,g=i.points.length;c<g;c++){const _=i.points[c];this.points.push(new Ri().fromArray(_))}return this}}Nt.prototype.isSplineCurve=!0;var mi=Object.freeze({__proto__:null,ArcCurve:ue,CatmullRomCurve3:Be,CubicBezierCurve:xe,CubicBezierCurve3:Ne,EllipseCurve:ie,LineCurve:ct,LineCurve3:Ot,QuadraticBezierCurve:mt,QuadraticBezierCurve3:it,SplineCurve:Nt});const _i=function(M,i,c=2){const g=i&&i.length,_=g?i[0]*c:M.length;let w=hi(M,0,_,c,!0);const A=[];if(!w||w.next===w.prev)return A;let R,z,F,W,q,J,K;if(g&&(w=function(re,ce,Me,de){const Xe=[];let nt,Je,gt,Tt,Zt;for(nt=0,Je=ce.length;nt<Je;nt++)gt=ce[nt]*de,Tt=nt<Je-1?ce[nt+1]*de:re.length,Zt=hi(re,gt,Tt,de,!1),Zt===Zt.next&&(Zt.steiner=!0),Xe.push(Tr(Zt));for(Xe.sort(Ji),nt=0;nt<Xe.length;nt++)Gi(Xe[nt],Me),Me=vt(Me,Me.next);return Me}(M,i,w,c)),M.length>80*c){R=F=M[0],z=W=M[1];for(let re=c;re<_;re+=c)q=M[re],J=M[re+1],q<R&&(R=q),J<z&&(z=J),q>F&&(F=q),J>W&&(W=J);K=Math.max(F-R,W-z),K=K!==0?1/K:0}return Gt(w,A,c,R,z,K),A};function hi(M,i,c,g,_){let w,A;if(_===function(R,z,F,W){let q=0;for(let J=z,K=F-W;J<F;J+=W)q+=(R[K]-R[J])*(R[J+1]+R[K+1]),K=J;return q}(M,i,c,g)>0)for(w=i;w<c;w+=g)A=dr(w,M[w],M[w+1],A);else for(w=c-g;w>=i;w-=g)A=dr(w,M[w],M[w+1],A);return A&&xs(A,A.next)&&(hs(A),A=A.next),A}function vt(M,i){if(!M)return M;i||(i=M);let c,g=M;do if(c=!1,g.steiner||!xs(g,g.next)&&er(g.prev,g,g.next)!==0)g=g.next;else{if(hs(g),g=i=g.prev,g===g.next)break;c=!0}while(c||g!==i);return i}function Gt(M,i,c,g,_,w,A){if(!M)return;!A&&w&&function(W,q,J,K){let re=W;do re.z===null&&(re.z=xn(re.x,re.y,q,J,K)),re.prevZ=re.prev,re.nextZ=re.next,re=re.next;while(re!==W);re.prevZ.nextZ=null,re.prevZ=null,function(ce){let Me,de,Xe,nt,Je,gt,Tt,Zt,ei=1;do{for(de=ce,ce=null,Je=null,gt=0;de;){for(gt++,Xe=de,Tt=0,Me=0;Me<ei&&(Tt++,Xe=Xe.nextZ,Xe);Me++);for(Zt=ei;Tt>0||Zt>0&&Xe;)Tt!==0&&(Zt===0||!Xe||de.z<=Xe.z)?(nt=de,de=de.nextZ,Tt--):(nt=Xe,Xe=Xe.nextZ,Zt--),Je?Je.nextZ=nt:ce=nt,nt.prevZ=Je,Je=nt;de=Xe}Je.nextZ=null,ei*=2}while(gt>1)}(re)}(M,g,_,w);let R,z,F=M;for(;M.prev!==M.next;)if(R=M.prev,z=M.next,w?$i(M,g,_,w):ri(M))i.push(R.i/c),i.push(M.i/c),i.push(z.i/c),hs(M),M=z.next,F=z.next;else if((M=z)===F){A?A===1?Gt(M=Yi(vt(M),i,c),i,c,g,_,w,2):A===2&&hn(M,i,c,g,_,w):Gt(vt(M),i,c,g,_,w,1);break}}function ri(M){const i=M.prev,c=M,g=M.next;if(er(i,c,g)>=0)return!1;let _=M.next.next;for(;_!==M.prev;){if(Wn(i.x,i.y,c.x,c.y,g.x,g.y,_.x,_.y)&&er(_.prev,_,_.next)>=0)return!1;_=_.next}return!0}function $i(M,i,c,g){const _=M.prev,w=M,A=M.next;if(er(_,w,A)>=0)return!1;const R=_.x<w.x?_.x<A.x?_.x:A.x:w.x<A.x?w.x:A.x,z=_.y<w.y?_.y<A.y?_.y:A.y:w.y<A.y?w.y:A.y,F=_.x>w.x?_.x>A.x?_.x:A.x:w.x>A.x?w.x:A.x,W=_.y>w.y?_.y>A.y?_.y:A.y:w.y>A.y?w.y:A.y,q=xn(R,z,i,c,g),J=xn(F,W,i,c,g);let K=M.prevZ,re=M.nextZ;for(;K&&K.z>=q&&re&&re.z<=J;){if(K!==M.prev&&K!==M.next&&Wn(_.x,_.y,w.x,w.y,A.x,A.y,K.x,K.y)&&er(K.prev,K,K.next)>=0||(K=K.prevZ,re!==M.prev&&re!==M.next&&Wn(_.x,_.y,w.x,w.y,A.x,A.y,re.x,re.y)&&er(re.prev,re,re.next)>=0))return!1;re=re.nextZ}for(;K&&K.z>=q;){if(K!==M.prev&&K!==M.next&&Wn(_.x,_.y,w.x,w.y,A.x,A.y,K.x,K.y)&&er(K.prev,K,K.next)>=0)return!1;K=K.prevZ}for(;re&&re.z<=J;){if(re!==M.prev&&re!==M.next&&Wn(_.x,_.y,w.x,w.y,A.x,A.y,re.x,re.y)&&er(re.prev,re,re.next)>=0)return!1;re=re.nextZ}return!0}function Yi(M,i,c){let g=M;do{const _=g.prev,w=g.next.next;!xs(_,w)&&zr(_,g,g.next,w)&&Zr(_,w)&&Zr(w,_)&&(i.push(_.i/c),i.push(g.i/c),i.push(w.i/c),hs(g),hs(g.next),g=M=w),g=g.next}while(g!==M);return vt(g)}function hn(M,i,c,g,_,w){let A=M;do{let R=A.next.next;for(;R!==A.prev;){if(A.i!==R.i&&cr(A,R)){let z=Or(A,R);return A=vt(A,A.next),z=vt(z,z.next),Gt(A,i,c,g,_,w),void Gt(z,i,c,g,_,w)}R=R.next}A=A.next}while(A!==M)}function Ji(M,i){return M.x-i.x}function Gi(M,i){if(i=function(c,g){let _=g;const w=c.x,A=c.y;let R,z=-1/0;do{if(A<=_.y&&A>=_.next.y&&_.next.y!==_.y){const re=_.x+(A-_.y)*(_.next.x-_.x)/(_.next.y-_.y);if(re<=w&&re>z){if(z=re,re===w){if(A===_.y)return _;if(A===_.next.y)return _.next}R=_.x<_.next.x?_:_.next}}_=_.next}while(_!==g);if(!R)return null;if(w===z)return R;const F=R,W=R.x,q=R.y;let J,K=1/0;_=R;do w>=_.x&&_.x>=W&&w!==_.x&&Wn(A<q?w:z,A,W,q,A<q?z:w,A,_.x,_.y)&&(J=Math.abs(A-_.y)/(w-_.x),Zr(_,c)&&(J<K||J===K&&(_.x>R.x||_.x===R.x&&Qt(R,_)))&&(R=_,K=J)),_=_.next;while(_!==F);return R}(M,i)){const c=Or(i,M);vt(i,i.next),vt(c,c.next)}}function Qt(M,i){return er(M.prev,M,i.prev)<0&&er(i.next,M,M.next)<0}function xn(M,i,c,g,_){return(M=1431655765&((M=858993459&((M=252645135&((M=16711935&((M=32767*(M-c)*_)|M<<8))|M<<4))|M<<2))|M<<1))|(i=1431655765&((i=858993459&((i=252645135&((i=16711935&((i=32767*(i-g)*_)|i<<8))|i<<4))|i<<2))|i<<1))<<1}function Tr(M){let i=M,c=M;do(i.x<c.x||i.x===c.x&&i.y<c.y)&&(c=i),i=i.next;while(i!==M);return c}function Wn(M,i,c,g,_,w,A,R){return(_-A)*(i-R)-(M-A)*(w-R)>=0&&(M-A)*(g-R)-(c-A)*(i-R)>=0&&(c-A)*(w-R)-(_-A)*(g-R)>=0}function cr(M,i){return M.next.i!==i.i&&M.prev.i!==i.i&&!function(c,g){let _=c;do{if(_.i!==c.i&&_.next.i!==c.i&&_.i!==g.i&&_.next.i!==g.i&&zr(_,_.next,c,g))return!0;_=_.next}while(_!==c);return!1}(M,i)&&(Zr(M,i)&&Zr(i,M)&&function(c,g){let _=c,w=!1;const A=(c.x+g.x)/2,R=(c.y+g.y)/2;do _.y>R!=_.next.y>R&&_.next.y!==_.y&&A<(_.next.x-_.x)*(R-_.y)/(_.next.y-_.y)+_.x&&(w=!w),_=_.next;while(_!==c);return w}(M,i)&&(er(M.prev,M,i.prev)||er(M,i.prev,i))||xs(M,i)&&er(M.prev,M,M.next)>0&&er(i.prev,i,i.next)>0)}function er(M,i,c){return(i.y-M.y)*(c.x-i.x)-(i.x-M.x)*(c.y-i.y)}function xs(M,i){return M.x===i.x&&M.y===i.y}function zr(M,i,c,g){const _=ls(er(M,i,c)),w=ls(er(M,i,g)),A=ls(er(c,g,M)),R=ls(er(c,g,i));return _!==w&&A!==R||!(_!==0||!ir(M,c,i))||!(w!==0||!ir(M,g,i))||!(A!==0||!ir(c,M,g))||!(R!==0||!ir(c,i,g))}function ir(M,i,c){return i.x<=Math.max(M.x,c.x)&&i.x>=Math.min(M.x,c.x)&&i.y<=Math.max(M.y,c.y)&&i.y>=Math.min(M.y,c.y)}function ls(M){return M>0?1:M<0?-1:0}function Zr(M,i){return er(M.prev,M,M.next)<0?er(M,i,M.next)>=0&&er(M,M.prev,i)>=0:er(M,i,M.prev)<0||er(M,M.next,i)<0}function Or(M,i){const c=new ks(M.i,M.x,M.y),g=new ks(i.i,i.x,i.y),_=M.next,w=i.prev;return M.next=i,i.prev=M,c.next=_,_.prev=c,g.next=c,c.prev=g,w.next=g,g.prev=w,g}function dr(M,i,c,g){const _=new ks(M,i,c);return g?(_.next=g.next,_.prev=g,g.next.prev=_,g.next=_):(_.prev=_,_.next=_),_}function hs(M){M.next.prev=M.prev,M.prev.next=M.next,M.prevZ&&(M.prevZ.nextZ=M.nextZ),M.nextZ&&(M.nextZ.prevZ=M.prevZ)}function ks(M,i,c){this.i=M,this.x=i,this.y=c,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}class Ur{static area(i){const c=i.length;let g=0;for(let _=c-1,w=0;w<c;_=w++)g+=i[_].x*i[w].y-i[w].x*i[_].y;return .5*g}static isClockWise(i){return Ur.area(i)<0}static triangulateShape(i,c){const g=[],_=[],w=[];vs(i),oi(g,i);let A=i.length;c.forEach(vs);for(let z=0;z<c.length;z++)_.push(A),A+=c[z].length,oi(g,c[z]);const R=_i(g,_);for(let z=0;z<R.length;z+=3)w.push(R.slice(z,z+3));return w}}function vs(M){const i=M.length;i>2&&M[i-1].equals(M[0])&&M.pop()}function oi(M,i){for(let c=0;c<i.length;c++)M.push(i[c].x),M.push(i[c].y)}class on extends Er{constructor(i,c){super(),this.type="ExtrudeGeometry",this.parameters={shapes:i,options:c},i=Array.isArray(i)?i:[i];const g=this,_=[],w=[];for(let R=0,z=i.length;R<z;R++)A(i[R]);function A(R){const z=[],F=c.curveSegments!==void 0?c.curveSegments:12,W=c.steps!==void 0?c.steps:1;let q=c.depth!==void 0?c.depth:100,J=c.bevelEnabled===void 0||c.bevelEnabled,K=c.bevelThickness!==void 0?c.bevelThickness:6,re=c.bevelSize!==void 0?c.bevelSize:K-2,ce=c.bevelOffset!==void 0?c.bevelOffset:0,Me=c.bevelSegments!==void 0?c.bevelSegments:3;const de=c.extrudePath,Xe=c.UVGenerator!==void 0?c.UVGenerator:Eo;c.amount!==void 0&&(console.warn("THREE.ExtrudeBufferGeometry: amount has been renamed to depth."),q=c.amount);let nt,Je,gt,Tt,Zt,ei=!1;de&&(nt=de.getSpacedPoints(W),ei=!0,J=!1,Je=de.computeFrenetFrames(W,!1),gt=new et,Tt=new et,Zt=new et),J||(Me=0,K=0,re=0,ce=0);const vi=R.extractPoints(F);let Xt=vi.shape;const xi=vi.holes;if(!Ur.isClockWise(Xt)){Xt=Xt.reverse();for(let Ti=0,pt=xi.length;Ti<pt;Ti++){const di=xi[Ti];Ur.isClockWise(di)&&(xi[Ti]=di.reverse())}}const In=Ur.triangulateShape(Xt,xi),gn=Xt;for(let Ti=0,pt=xi.length;Ti<pt;Ti++){const di=xi[Ti];Xt=Xt.concat(di)}function Vi(Ti,pt,di){return pt||console.error("THREE.ExtrudeGeometry: vec does not exist"),pt.clone().multiplyScalar(di).add(Ti)}const vn=Xt.length,$n=In.length;function tr(Ti,pt,di){let nn,an,rn;const Hn=Ti.x-pt.x,Sr=Ti.y-pt.y,sr=di.x-Ti.x,Kr=di.y-Ti.y,Xr=Hn*Hn+Sr*Sr,Ko=Hn*Kr-Sr*sr;if(Math.abs(Ko)>Number.EPSILON){const Ns=Math.sqrt(Xr),Ho=Math.sqrt(sr*sr+Kr*Kr),Xa=pt.x-Sr/Ns,hd=pt.y+Hn/Ns,pu=((di.x-Kr/Ho-Xa)*Kr-(di.y+sr/Ho-hd)*sr)/(Hn*Kr-Sr*sr);nn=Xa+Hn*pu-Ti.x,an=hd+Sr*pu-Ti.y;const ud=nn*nn+an*an;if(ud<=2)return new Ri(nn,an);rn=Math.sqrt(ud/2)}else{let Ns=!1;Hn>Number.EPSILON?sr>Number.EPSILON&&(Ns=!0):Hn<-Number.EPSILON?sr<-Number.EPSILON&&(Ns=!0):Math.sign(Sr)===Math.sign(Kr)&&(Ns=!0),Ns?(nn=-Sr,an=Hn,rn=Math.sqrt(Xr)):(nn=Hn,an=Sr,rn=Math.sqrt(Xr/2))}return new Ri(nn/rn,an/rn)}const mr=[];for(let Ti=0,pt=gn.length,di=pt-1,nn=Ti+1;Ti<pt;Ti++,di++,nn++)di===pt&&(di=0),nn===pt&&(nn=0),mr[Ti]=tr(gn[Ti],gn[di],gn[nn]);const Ar=[];let hr,mn=mr.concat();for(let Ti=0,pt=xi.length;Ti<pt;Ti++){const di=xi[Ti];hr=[];for(let nn=0,an=di.length,rn=an-1,Hn=nn+1;nn<an;nn++,rn++,Hn++)rn===an&&(rn=0),Hn===an&&(Hn=0),hr[nn]=tr(di[nn],di[rn],di[Hn]);Ar.push(hr),mn=mn.concat(hr)}for(let Ti=0;Ti<Me;Ti++){const pt=Ti/Me,di=K*Math.cos(pt*Math.PI/2),nn=re*Math.sin(pt*Math.PI/2)+ce;for(let an=0,rn=gn.length;an<rn;an++){const Hn=Vi(gn[an],mr[an],nn);Xi(Hn.x,Hn.y,-di)}for(let an=0,rn=xi.length;an<rn;an++){const Hn=xi[an];hr=Ar[an];for(let Sr=0,sr=Hn.length;Sr<sr;Sr++){const Kr=Vi(Hn[Sr],hr[Sr],nn);Xi(Kr.x,Kr.y,-di)}}}const wt=re+ce;for(let Ti=0;Ti<vn;Ti++){const pt=J?Vi(Xt[Ti],mn[Ti],wt):Xt[Ti];ei?(Tt.copy(Je.normals[0]).multiplyScalar(pt.x),gt.copy(Je.binormals[0]).multiplyScalar(pt.y),Zt.copy(nt[0]).add(Tt).add(gt),Xi(Zt.x,Zt.y,Zt.z)):Xi(pt.x,pt.y,0)}for(let Ti=1;Ti<=W;Ti++)for(let pt=0;pt<vn;pt++){const di=J?Vi(Xt[pt],mn[pt],wt):Xt[pt];ei?(Tt.copy(Je.normals[Ti]).multiplyScalar(di.x),gt.copy(Je.binormals[Ti]).multiplyScalar(di.y),Zt.copy(nt[Ti]).add(Tt).add(gt),Xi(Zt.x,Zt.y,Zt.z)):Xi(di.x,di.y,q/W*Ti)}for(let Ti=Me-1;Ti>=0;Ti--){const pt=Ti/Me,di=K*Math.cos(pt*Math.PI/2),nn=re*Math.sin(pt*Math.PI/2)+ce;for(let an=0,rn=gn.length;an<rn;an++){const Hn=Vi(gn[an],mr[an],nn);Xi(Hn.x,Hn.y,q+di)}for(let an=0,rn=xi.length;an<rn;an++){const Hn=xi[an];hr=Ar[an];for(let Sr=0,sr=Hn.length;Sr<sr;Sr++){const Kr=Vi(Hn[Sr],hr[Sr],nn);ei?Xi(Kr.x,Kr.y+nt[W-1].y,nt[W-1].x+di):Xi(Kr.x,Kr.y,q+di)}}}function Dt(Ti,pt){let di=Ti.length;for(;--di>=0;){const nn=di;let an=di-1;an<0&&(an=Ti.length-1);for(let rn=0,Hn=W+2*Me;rn<Hn;rn++){const Sr=vn*rn,sr=vn*(rn+1);gi(pt+nn+Sr,pt+an+Sr,pt+an+sr,pt+nn+sr)}}}function Xi(Ti,pt,di){z.push(Ti),z.push(pt),z.push(di)}function Li(Ti,pt,di){An(Ti),An(pt),An(di);const nn=_.length/3,an=Xe.generateTopUV(g,_,nn-3,nn-2,nn-1);Cn(an[0]),Cn(an[1]),Cn(an[2])}function gi(Ti,pt,di,nn){An(Ti),An(pt),An(nn),An(pt),An(di),An(nn);const an=_.length/3,rn=Xe.generateSideWallUV(g,_,an-6,an-3,an-2,an-1);Cn(rn[0]),Cn(rn[1]),Cn(rn[3]),Cn(rn[1]),Cn(rn[2]),Cn(rn[3])}function An(Ti){_.push(z[3*Ti+0]),_.push(z[3*Ti+1]),_.push(z[3*Ti+2])}function Cn(Ti){w.push(Ti.x),w.push(Ti.y)}(function(){const Ti=_.length/3;if(J){let pt=0,di=vn*pt;for(let nn=0;nn<$n;nn++){const an=In[nn];Li(an[2]+di,an[1]+di,an[0]+di)}pt=W+2*Me,di=vn*pt;for(let nn=0;nn<$n;nn++){const an=In[nn];Li(an[0]+di,an[1]+di,an[2]+di)}}else{for(let pt=0;pt<$n;pt++){const di=In[pt];Li(di[2],di[1],di[0])}for(let pt=0;pt<$n;pt++){const di=In[pt];Li(di[0]+vn*W,di[1]+vn*W,di[2]+vn*W)}}g.addGroup(Ti,_.length/3-Ti,0)})(),function(){const Ti=_.length/3;let pt=0;Dt(gn,pt),pt+=gn.length;for(let di=0,nn=xi.length;di<nn;di++){const an=xi[di];Dt(an,pt),pt+=an.length}g.addGroup(Ti,_.length/3-Ti,1)}()}this.setAttribute("position",new Kn(_,3)),this.setAttribute("uv",new Kn(w,2)),this.computeVertexNormals()}toJSON(){const i=super.toJSON();return function(c,g,_){if(_.shapes=[],Array.isArray(c))for(let w=0,A=c.length;w<A;w++){const R=c[w];_.shapes.push(R.uuid)}else _.shapes.push(c.uuid);return g.extrudePath!==void 0&&(_.options.extrudePath=g.extrudePath.toJSON()),_}(this.parameters.shapes,this.parameters.options,i)}static fromJSON(i,c){const g=[];for(let w=0,A=i.shapes.length;w<A;w++){const R=c[i.shapes[w]];g.push(R)}const _=i.options.extrudePath;return _!==void 0&&(i.options.extrudePath=new mi[_.type]().fromJSON(_)),new on(g,i.options)}}const Eo={generateTopUV:function(M,i,c,g,_){const w=i[3*c],A=i[3*c+1],R=i[3*g],z=i[3*g+1],F=i[3*_],W=i[3*_+1];return[new Ri(w,A),new Ri(R,z),new Ri(F,W)]},generateSideWallUV:function(M,i,c,g,_,w){const A=i[3*c],R=i[3*c+1],z=i[3*c+2],F=i[3*g],W=i[3*g+1],q=i[3*g+2],J=i[3*_],K=i[3*_+1],re=i[3*_+2],ce=i[3*w],Me=i[3*w+1],de=i[3*w+2];return Math.abs(R-W)<Math.abs(A-F)?[new Ri(A,1-z),new Ri(F,1-q),new Ri(J,1-re),new Ri(ce,1-de)]:[new Ri(R,1-z),new Ri(W,1-q),new Ri(K,1-re),new Ri(Me,1-de)]}};class Br extends T{constructor(i=1,c=0){const g=(1+Math.sqrt(5))/2;super([-1,g,0,1,g,0,-1,-g,0,1,-g,0,0,-1,g,0,1,g,0,-1,-g,0,1,-g,g,0,-1,g,0,1,-g,0,-1,-g,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],i,c),this.type="IcosahedronGeometry",this.parameters={radius:i,detail:c}}static fromJSON(i){return new Br(i.radius,i.detail)}}class Pt extends Er{constructor(i,c=12,g=0,_=2*Math.PI){super(),this.type="LatheGeometry",this.parameters={points:i,segments:c,phiStart:g,phiLength:_},c=Math.floor(c),_=Jn(_,0,2*Math.PI);const w=[],A=[],R=[],z=1/c,F=new et,W=new Ri;for(let q=0;q<=c;q++){const J=g+q*z*_,K=Math.sin(J),re=Math.cos(J);for(let ce=0;ce<=i.length-1;ce++)F.x=i[ce].x*K,F.y=i[ce].y,F.z=i[ce].x*re,A.push(F.x,F.y,F.z),W.x=q/c,W.y=ce/(i.length-1),R.push(W.x,W.y)}for(let q=0;q<c;q++)for(let J=0;J<i.length-1;J++){const K=J+q*i.length,re=K,ce=K+i.length,Me=K+i.length+1,de=K+1;w.push(re,ce,de),w.push(ce,Me,de)}if(this.setIndex(w),this.setAttribute("position",new Kn(A,3)),this.setAttribute("uv",new Kn(R,2)),this.computeVertexNormals(),_===2*Math.PI){const q=this.attributes.normal.array,J=new et,K=new et,re=new et,ce=c*i.length*3;for(let Me=0,de=0;Me<i.length;Me++,de+=3)J.x=q[de+0],J.y=q[de+1],J.z=q[de+2],K.x=q[ce+de+0],K.y=q[ce+de+1],K.z=q[ce+de+2],re.addVectors(J,K).normalize(),q[de+0]=q[ce+de+0]=re.x,q[de+1]=q[ce+de+1]=re.y,q[de+2]=q[ce+de+2]=re.z}}static fromJSON(i){return new Pt(i.points,i.segments,i.phiStart,i.phiLength)}}class ao extends T{constructor(i=1,c=0){super([1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],i,c),this.type="OctahedronGeometry",this.parameters={radius:i,detail:c}}static fromJSON(i){return new ao(i.radius,i.detail)}}class yo extends Er{constructor(i,c,g){super(),this.type="ParametricGeometry",this.parameters={func:i,slices:c,stacks:g};const _=[],w=[],A=[],R=[],z=1e-5,F=new et,W=new et,q=new et,J=new et,K=new et;i.length<3&&console.error("THREE.ParametricGeometry: Function must now modify a Vector3 as third parameter.");const re=c+1;for(let ce=0;ce<=g;ce++){const Me=ce/g;for(let de=0;de<=c;de++){const Xe=de/c;i(Xe,Me,W),w.push(W.x,W.y,W.z),Xe-z>=0?(i(Xe-z,Me,q),J.subVectors(W,q)):(i(Xe+z,Me,q),J.subVectors(q,W)),Me-z>=0?(i(Xe,Me-z,q),K.subVectors(W,q)):(i(Xe,Me+z,q),K.subVectors(q,W)),F.crossVectors(J,K).normalize(),A.push(F.x,F.y,F.z),R.push(Xe,Me)}}for(let ce=0;ce<g;ce++)for(let Me=0;Me<c;Me++){const de=ce*re+Me,Xe=ce*re+Me+1,nt=(ce+1)*re+Me+1,Je=(ce+1)*re+Me;_.push(de,Xe,Je),_.push(Xe,nt,Je)}this.setIndex(_),this.setAttribute("position",new Kn(w,3)),this.setAttribute("normal",new Kn(A,3)),this.setAttribute("uv",new Kn(R,2))}}class Ys extends Er{constructor(i=.5,c=1,g=8,_=1,w=0,A=2*Math.PI){super(),this.type="RingGeometry",this.parameters={innerRadius:i,outerRadius:c,thetaSegments:g,phiSegments:_,thetaStart:w,thetaLength:A},g=Math.max(3,g);const R=[],z=[],F=[],W=[];let q=i;const J=(c-i)/(_=Math.max(1,_)),K=new et,re=new Ri;for(let ce=0;ce<=_;ce++){for(let Me=0;Me<=g;Me++){const de=w+Me/g*A;K.x=q*Math.cos(de),K.y=q*Math.sin(de),z.push(K.x,K.y,K.z),F.push(0,0,1),re.x=(K.x/c+1)/2,re.y=(K.y/c+1)/2,W.push(re.x,re.y)}q+=J}for(let ce=0;ce<_;ce++){const Me=ce*(g+1);for(let de=0;de<g;de++){const Xe=de+Me,nt=Xe,Je=Xe+g+1,gt=Xe+g+2,Tt=Xe+1;R.push(nt,Je,Tt),R.push(Je,gt,Tt)}}this.setIndex(R),this.setAttribute("position",new Kn(z,3)),this.setAttribute("normal",new Kn(F,3)),this.setAttribute("uv",new Kn(W,2))}static fromJSON(i){return new Ys(i.innerRadius,i.outerRadius,i.thetaSegments,i.phiSegments,i.thetaStart,i.thetaLength)}}class io extends Er{constructor(i,c=12){super(),this.type="ShapeGeometry",this.parameters={shapes:i,curveSegments:c};const g=[],_=[],w=[],A=[];let R=0,z=0;if(Array.isArray(i)===!1)F(i);else for(let W=0;W<i.length;W++)F(i[W]),this.addGroup(R,z,W),R+=z,z=0;function F(W){const q=_.length/3,J=W.extractPoints(c);let K=J.shape;const re=J.holes;Ur.isClockWise(K)===!1&&(K=K.reverse());for(let Me=0,de=re.length;Me<de;Me++){const Xe=re[Me];Ur.isClockWise(Xe)===!0&&(re[Me]=Xe.reverse())}const ce=Ur.triangulateShape(K,re);for(let Me=0,de=re.length;Me<de;Me++){const Xe=re[Me];K=K.concat(Xe)}for(let Me=0,de=K.length;Me<de;Me++){const Xe=K[Me];_.push(Xe.x,Xe.y,0),w.push(0,0,1),A.push(Xe.x,Xe.y)}for(let Me=0,de=ce.length;Me<de;Me++){const Xe=ce[Me],nt=Xe[0]+q,Je=Xe[1]+q,gt=Xe[2]+q;g.push(nt,Je,gt),z+=3}}this.setIndex(g),this.setAttribute("position",new Kn(_,3)),this.setAttribute("normal",new Kn(w,3)),this.setAttribute("uv",new Kn(A,2))}toJSON(){const i=super.toJSON();return function(c,g){if(g.shapes=[],Array.isArray(c))for(let _=0,w=c.length;_<w;_++){const A=c[_];g.shapes.push(A.uuid)}else g.shapes.push(c.uuid);return g}(this.parameters.shapes,i)}static fromJSON(i,c){const g=[];for(let _=0,w=i.shapes.length;_<w;_++){const A=c[i.shapes[_]];g.push(A)}return new io(g,i.curveSegments)}}class Uo extends Er{constructor(i=1,c=32,g=16,_=0,w=2*Math.PI,A=0,R=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:i,widthSegments:c,heightSegments:g,phiStart:_,phiLength:w,thetaStart:A,thetaLength:R},c=Math.max(3,Math.floor(c)),g=Math.max(2,Math.floor(g));const z=Math.min(A+R,Math.PI);let F=0;const W=[],q=new et,J=new et,K=[],re=[],ce=[],Me=[];for(let de=0;de<=g;de++){const Xe=[],nt=de/g;let Je=0;de==0&&A==0?Je=.5/c:de==g&&z==Math.PI&&(Je=-.5/c);for(let gt=0;gt<=c;gt++){const Tt=gt/c;q.x=-i*Math.cos(_+Tt*w)*Math.sin(A+nt*R),q.y=i*Math.cos(A+nt*R),q.z=i*Math.sin(_+Tt*w)*Math.sin(A+nt*R),re.push(q.x,q.y,q.z),J.copy(q).normalize(),ce.push(J.x,J.y,J.z),Me.push(Tt+Je,1-nt),Xe.push(F++)}W.push(Xe)}for(let de=0;de<g;de++)for(let Xe=0;Xe<c;Xe++){const nt=W[de][Xe+1],Je=W[de][Xe],gt=W[de+1][Xe],Tt=W[de+1][Xe+1];(de!==0||A>0)&&K.push(nt,Je,Tt),(de!==g-1||z<Math.PI)&&K.push(Je,gt,Tt)}this.setIndex(K),this.setAttribute("position",new Kn(re,3)),this.setAttribute("normal",new Kn(ce,3)),this.setAttribute("uv",new Kn(Me,2))}static fromJSON(i){return new Uo(i.radius,i.widthSegments,i.heightSegments,i.phiStart,i.phiLength,i.thetaStart,i.thetaLength)}}class ga extends T{constructor(i=1,c=0){super([1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],[2,1,0,0,3,2,1,3,0,2,3,1],i,c),this.type="TetrahedronGeometry",this.parameters={radius:i,detail:c}}static fromJSON(i){return new ga(i.radius,i.detail)}}class Yo extends on{constructor(i,c={}){const g=c.font;if(!g||!g.isFont)return console.error("THREE.TextGeometry: font parameter is not an instance of THREE.Font."),new Er;const _=g.generateShapes(i,c.size);c.depth=c.height!==void 0?c.height:50,c.bevelThickness===void 0&&(c.bevelThickness=10),c.bevelSize===void 0&&(c.bevelSize=8),c.bevelEnabled===void 0&&(c.bevelEnabled=!1),super(_,c),this.type="TextGeometry"}}class Ia extends Er{constructor(i=1,c=.4,g=8,_=6,w=2*Math.PI){super(),this.type="TorusGeometry",this.parameters={radius:i,tube:c,radialSegments:g,tubularSegments:_,arc:w},g=Math.floor(g),_=Math.floor(_);const A=[],R=[],z=[],F=[],W=new et,q=new et,J=new et;for(let K=0;K<=g;K++)for(let re=0;re<=_;re++){const ce=re/_*w,Me=K/g*Math.PI*2;q.x=(i+c*Math.cos(Me))*Math.cos(ce),q.y=(i+c*Math.cos(Me))*Math.sin(ce),q.z=c*Math.sin(Me),R.push(q.x,q.y,q.z),W.x=i*Math.cos(ce),W.y=i*Math.sin(ce),J.subVectors(q,W).normalize(),z.push(J.x,J.y,J.z),F.push(re/_),F.push(K/g)}for(let K=1;K<=g;K++)for(let re=1;re<=_;re++){const ce=(_+1)*K+re-1,Me=(_+1)*(K-1)+re-1,de=(_+1)*(K-1)+re,Xe=(_+1)*K+re;A.push(ce,Me,Xe),A.push(Me,de,Xe)}this.setIndex(A),this.setAttribute("position",new Kn(R,3)),this.setAttribute("normal",new Kn(z,3)),this.setAttribute("uv",new Kn(F,2))}static fromJSON(i){return new Ia(i.radius,i.tube,i.radialSegments,i.tubularSegments,i.arc)}}class Pa extends Er{constructor(i=1,c=.4,g=64,_=8,w=2,A=3){super(),this.type="TorusKnotGeometry",this.parameters={radius:i,tube:c,tubularSegments:g,radialSegments:_,p:w,q:A},g=Math.floor(g),_=Math.floor(_);const R=[],z=[],F=[],W=[],q=new et,J=new et,K=new et,re=new et,ce=new et,Me=new et,de=new et;for(let nt=0;nt<=g;++nt){const Je=nt/g*w*Math.PI*2;Xe(Je,w,A,i,K),Xe(Je+.01,w,A,i,re),Me.subVectors(re,K),de.addVectors(re,K),ce.crossVectors(Me,de),de.crossVectors(ce,Me),ce.normalize(),de.normalize();for(let gt=0;gt<=_;++gt){const Tt=gt/_*Math.PI*2,Zt=-c*Math.cos(Tt),ei=c*Math.sin(Tt);q.x=K.x+(Zt*de.x+ei*ce.x),q.y=K.y+(Zt*de.y+ei*ce.y),q.z=K.z+(Zt*de.z+ei*ce.z),z.push(q.x,q.y,q.z),J.subVectors(q,K).normalize(),F.push(J.x,J.y,J.z),W.push(nt/g),W.push(gt/_)}}for(let nt=1;nt<=g;nt++)for(let Je=1;Je<=_;Je++){const gt=(_+1)*(nt-1)+(Je-1),Tt=(_+1)*nt+(Je-1),Zt=(_+1)*nt+Je,ei=(_+1)*(nt-1)+Je;R.push(gt,Tt,ei),R.push(Tt,Zt,ei)}function Xe(nt,Je,gt,Tt,Zt){const ei=Math.cos(nt),vi=Math.sin(nt),Xt=gt/Je*nt,xi=Math.cos(Xt);Zt.x=Tt*(2+xi)*.5*ei,Zt.y=Tt*(2+xi)*vi*.5,Zt.z=Tt*Math.sin(Xt)*.5}this.setIndex(R),this.setAttribute("position",new Kn(z,3)),this.setAttribute("normal",new Kn(F,3)),this.setAttribute("uv",new Kn(W,2))}static fromJSON(i){return new Pa(i.radius,i.tube,i.tubularSegments,i.radialSegments,i.p,i.q)}}class Ra extends Er{constructor(i,c=64,g=1,_=8,w=!1){super(),this.type="TubeGeometry",this.parameters={path:i,tubularSegments:c,radius:g,radialSegments:_,closed:w};const A=i.computeFrenetFrames(c,w);this.tangents=A.tangents,this.normals=A.normals,this.binormals=A.binormals;const R=new et,z=new et,F=new Ri;let W=new et;const q=[],J=[],K=[],re=[];function ce(Me){W=i.getPointAt(Me/c,W);const de=A.normals[Me],Xe=A.binormals[Me];for(let nt=0;nt<=_;nt++){const Je=nt/_*Math.PI*2,gt=Math.sin(Je),Tt=-Math.cos(Je);z.x=Tt*de.x+gt*Xe.x,z.y=Tt*de.y+gt*Xe.y,z.z=Tt*de.z+gt*Xe.z,z.normalize(),J.push(z.x,z.y,z.z),R.x=W.x+g*z.x,R.y=W.y+g*z.y,R.z=W.z+g*z.z,q.push(R.x,R.y,R.z)}}(function(){for(let Me=0;Me<c;Me++)ce(Me);ce(w===!1?c:0),function(){for(let Me=0;Me<=c;Me++)for(let de=0;de<=_;de++)F.x=Me/c,F.y=de/_,K.push(F.x,F.y)}(),function(){for(let Me=1;Me<=c;Me++)for(let de=1;de<=_;de++){const Xe=(_+1)*(Me-1)+(de-1),nt=(_+1)*Me+(de-1),Je=(_+1)*Me+de,gt=(_+1)*(Me-1)+de;re.push(Xe,nt,gt),re.push(nt,Je,gt)}}()})(),this.setIndex(re),this.setAttribute("position",new Kn(q,3)),this.setAttribute("normal",new Kn(J,3)),this.setAttribute("uv",new Kn(K,2))}toJSON(){const i=super.toJSON();return i.path=this.parameters.path.toJSON(),i}static fromJSON(i){return new Ra(new mi[i.path.type]().fromJSON(i.path),i.tubularSegments,i.radius,i.radialSegments,i.closed)}}class qa extends Er{constructor(i){if(super(),this.type="WireframeGeometry",i.isGeometry===!0)return void console.error("THREE.WireframeGeometry no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.");const c=[],g=new Set,_=new et,w=new et;if(i.index!==null){const A=i.attributes.position,R=i.index;let z=i.groups;z.length===0&&(z=[{start:0,count:R.count,materialIndex:0}]);for(let F=0,W=z.length;F<W;++F){const q=z[F],J=q.start;for(let K=J,re=J+q.count;K<re;K+=3)for(let ce=0;ce<3;ce++){const Me=R.getX(K+ce),de=R.getX(K+(ce+1)%3);_.fromBufferAttribute(A,Me),w.fromBufferAttribute(A,de),kc(_,w,g)===!0&&(c.push(_.x,_.y,_.z),c.push(w.x,w.y,w.z))}}}else{const A=i.attributes.position;for(let R=0,z=A.count/3;R<z;R++)for(let F=0;F<3;F++){const W=3*R+F,q=3*R+(F+1)%3;_.fromBufferAttribute(A,W),w.fromBufferAttribute(A,q),kc(_,w,g)===!0&&(c.push(_.x,_.y,_.z),c.push(w.x,w.y,w.z))}}this.setAttribute("position",new Kn(c,3))}}function kc(M,i,c){const g=`${M.x},${M.y},${M.z}-${i.x},${i.y},${i.z}`,_=`${i.x},${i.y},${i.z}-${M.x},${M.y},${M.z}`;return c.has(g)!==!0&&c.has(_)!==!0&&(c.add(g,_),!0)}var Mh=Object.freeze({__proto__:null,BoxGeometry:el,BoxBufferGeometry:el,CircleGeometry:h,CircleBufferGeometry:h,ConeGeometry:b,ConeBufferGeometry:b,CylinderGeometry:y,CylinderBufferGeometry:y,DodecahedronGeometry:E,DodecahedronBufferGeometry:E,EdgesGeometry:X,ExtrudeGeometry:on,ExtrudeBufferGeometry:on,IcosahedronGeometry:Br,IcosahedronBufferGeometry:Br,LatheGeometry:Pt,LatheBufferGeometry:Pt,OctahedronGeometry:ao,OctahedronBufferGeometry:ao,ParametricGeometry:yo,ParametricBufferGeometry:yo,PlaneGeometry:nc,PlaneBufferGeometry:nc,PolyhedronGeometry:T,PolyhedronBufferGeometry:T,RingGeometry:Ys,RingBufferGeometry:Ys,ShapeGeometry:io,ShapeBufferGeometry:io,SphereGeometry:Uo,SphereBufferGeometry:Uo,TetrahedronGeometry:ga,TetrahedronBufferGeometry:ga,TextGeometry:Yo,TextBufferGeometry:Yo,TorusGeometry:Ia,TorusBufferGeometry:Ia,TorusKnotGeometry:Pa,TorusKnotBufferGeometry:Pa,TubeGeometry:Ra,TubeBufferGeometry:Ra,WireframeGeometry:qa});class Th extends Bi{constructor(i){super(),this.type="ShadowMaterial",this.color=new un(0),this.transparent=!0,this.setValues(i)}copy(i){return super.copy(i),this.color.copy(i.color),this}}Th.prototype.isShadowMaterial=!0;class uc extends Bi{constructor(i){super(),this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new un(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new un(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Ri(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.setValues(i)}copy(i){return super.copy(i),this.defines={STANDARD:""},this.color.copy(i.color),this.roughness=i.roughness,this.metalness=i.metalness,this.map=i.map,this.lightMap=i.lightMap,this.lightMapIntensity=i.lightMapIntensity,this.aoMap=i.aoMap,this.aoMapIntensity=i.aoMapIntensity,this.emissive.copy(i.emissive),this.emissiveMap=i.emissiveMap,this.emissiveIntensity=i.emissiveIntensity,this.bumpMap=i.bumpMap,this.bumpScale=i.bumpScale,this.normalMap=i.normalMap,this.normalMapType=i.normalMapType,this.normalScale.copy(i.normalScale),this.displacementMap=i.displacementMap,this.displacementScale=i.displacementScale,this.displacementBias=i.displacementBias,this.roughnessMap=i.roughnessMap,this.metalnessMap=i.metalnessMap,this.alphaMap=i.alphaMap,this.envMap=i.envMap,this.envMapIntensity=i.envMapIntensity,this.refractionRatio=i.refractionRatio,this.wireframe=i.wireframe,this.wireframeLinewidth=i.wireframeLinewidth,this.wireframeLinecap=i.wireframeLinecap,this.wireframeLinejoin=i.wireframeLinejoin,this.flatShading=i.flatShading,this}}uc.prototype.isMeshStandardMaterial=!0;class Bc extends uc{constructor(i){super(),this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new Ri(1,1),this.clearcoatNormalMap=null,this.ior=1.5,Object.defineProperty(this,"reflectivity",{get:function(){return Jn(2.5*(this.ior-1)/(this.ior+1),0,1)},set:function(c){this.ior=(1+.4*c)/(1-.4*c)}}),this.sheenTint=new un(0),this.transmission=0,this.transmissionMap=null,this.thickness=.01,this.thicknessMap=null,this.attenuationDistance=0,this.attenuationTint=new un(1,1,1),this.specularIntensity=1,this.specularIntensityMap=null,this.specularTint=new un(1,1,1),this.specularTintMap=null,this._clearcoat=0,this._transmission=0,this.setValues(i)}get clearcoat(){return this._clearcoat}set clearcoat(i){this._clearcoat>0!=i>0&&this.version++,this._clearcoat=i}get transmission(){return this._transmission}set transmission(i){this._transmission>0!=i>0&&this.version++,this._transmission=i}copy(i){return super.copy(i),this.defines={STANDARD:"",PHYSICAL:""},this.clearcoat=i.clearcoat,this.clearcoatMap=i.clearcoatMap,this.clearcoatRoughness=i.clearcoatRoughness,this.clearcoatRoughnessMap=i.clearcoatRoughnessMap,this.clearcoatNormalMap=i.clearcoatNormalMap,this.clearcoatNormalScale.copy(i.clearcoatNormalScale),this.ior=i.ior,this.sheenTint.copy(i.sheenTint),this.transmission=i.transmission,this.transmissionMap=i.transmissionMap,this.thickness=i.thickness,this.thicknessMap=i.thicknessMap,this.attenuationDistance=i.attenuationDistance,this.attenuationTint.copy(i.attenuationTint),this.specularIntensity=i.specularIntensity,this.specularIntensityMap=i.specularIntensityMap,this.specularTint.copy(i.specularTint),this.specularTintMap=i.specularTintMap,this}}Bc.prototype.isMeshPhysicalMaterial=!0;class lu extends Bi{constructor(i){super(),this.type="MeshPhongMaterial",this.color=new un(16777215),this.specular=new un(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new un(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Ri(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.setValues(i)}copy(i){return super.copy(i),this.color.copy(i.color),this.specular.copy(i.specular),this.shininess=i.shininess,this.map=i.map,this.lightMap=i.lightMap,this.lightMapIntensity=i.lightMapIntensity,this.aoMap=i.aoMap,this.aoMapIntensity=i.aoMapIntensity,this.emissive.copy(i.emissive),this.emissiveMap=i.emissiveMap,this.emissiveIntensity=i.emissiveIntensity,this.bumpMap=i.bumpMap,this.bumpScale=i.bumpScale,this.normalMap=i.normalMap,this.normalMapType=i.normalMapType,this.normalScale.copy(i.normalScale),this.displacementMap=i.displacementMap,this.displacementScale=i.displacementScale,this.displacementBias=i.displacementBias,this.specularMap=i.specularMap,this.alphaMap=i.alphaMap,this.envMap=i.envMap,this.combine=i.combine,this.reflectivity=i.reflectivity,this.refractionRatio=i.refractionRatio,this.wireframe=i.wireframe,this.wireframeLinewidth=i.wireframeLinewidth,this.wireframeLinecap=i.wireframeLinecap,this.wireframeLinejoin=i.wireframeLinejoin,this.flatShading=i.flatShading,this}}lu.prototype.isMeshPhongMaterial=!0;class cu extends Bi{constructor(i){super(),this.defines={TOON:""},this.type="MeshToonMaterial",this.color=new un(16777215),this.map=null,this.gradientMap=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new un(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Ri(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.setValues(i)}copy(i){return super.copy(i),this.color.copy(i.color),this.map=i.map,this.gradientMap=i.gradientMap,this.lightMap=i.lightMap,this.lightMapIntensity=i.lightMapIntensity,this.aoMap=i.aoMap,this.aoMapIntensity=i.aoMapIntensity,this.emissive.copy(i.emissive),this.emissiveMap=i.emissiveMap,this.emissiveIntensity=i.emissiveIntensity,this.bumpMap=i.bumpMap,this.bumpScale=i.bumpScale,this.normalMap=i.normalMap,this.normalMapType=i.normalMapType,this.normalScale.copy(i.normalScale),this.displacementMap=i.displacementMap,this.displacementScale=i.displacementScale,this.displacementBias=i.displacementBias,this.alphaMap=i.alphaMap,this.wireframe=i.wireframe,this.wireframeLinewidth=i.wireframeLinewidth,this.wireframeLinecap=i.wireframeLinecap,this.wireframeLinejoin=i.wireframeLinejoin,this}}cu.prototype.isMeshToonMaterial=!0;class dc extends Bi{constructor(i){super(),this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Ri(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.flatShading=!1,this.setValues(i)}copy(i){return super.copy(i),this.bumpMap=i.bumpMap,this.bumpScale=i.bumpScale,this.normalMap=i.normalMap,this.normalMapType=i.normalMapType,this.normalScale.copy(i.normalScale),this.displacementMap=i.displacementMap,this.displacementScale=i.displacementScale,this.displacementBias=i.displacementBias,this.wireframe=i.wireframe,this.wireframeLinewidth=i.wireframeLinewidth,this.flatShading=i.flatShading,this}}dc.prototype.isMeshNormalMaterial=!0;class Ao extends Bi{constructor(i){super(),this.type="MeshLambertMaterial",this.color=new un(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new un(0),this.emissiveIntensity=1,this.emissiveMap=null,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.setValues(i)}copy(i){return super.copy(i),this.color.copy(i.color),this.map=i.map,this.lightMap=i.lightMap,this.lightMapIntensity=i.lightMapIntensity,this.aoMap=i.aoMap,this.aoMapIntensity=i.aoMapIntensity,this.emissive.copy(i.emissive),this.emissiveMap=i.emissiveMap,this.emissiveIntensity=i.emissiveIntensity,this.specularMap=i.specularMap,this.alphaMap=i.alphaMap,this.envMap=i.envMap,this.combine=i.combine,this.reflectivity=i.reflectivity,this.refractionRatio=i.refractionRatio,this.wireframe=i.wireframe,this.wireframeLinewidth=i.wireframeLinewidth,this.wireframeLinecap=i.wireframeLinecap,this.wireframeLinejoin=i.wireframeLinejoin,this}}Ao.prototype.isMeshLambertMaterial=!0;class rd extends Bi{constructor(i){super(),this.defines={MATCAP:""},this.type="MeshMatcapMaterial",this.color=new un(16777215),this.matcap=null,this.map=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Ri(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.flatShading=!1,this.setValues(i)}copy(i){return super.copy(i),this.defines={MATCAP:""},this.color.copy(i.color),this.matcap=i.matcap,this.map=i.map,this.bumpMap=i.bumpMap,this.bumpScale=i.bumpScale,this.normalMap=i.normalMap,this.normalMapType=i.normalMapType,this.normalScale.copy(i.normalScale),this.displacementMap=i.displacementMap,this.displacementScale=i.displacementScale,this.displacementBias=i.displacementBias,this.alphaMap=i.alphaMap,this.flatShading=i.flatShading,this}}rd.prototype.isMeshMatcapMaterial=!0;class Xd extends to{constructor(i){super(),this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(i)}copy(i){return super.copy(i),this.scale=i.scale,this.dashSize=i.dashSize,this.gapSize=i.gapSize,this}}Xd.prototype.isLineDashedMaterial=!0;var Os=Object.freeze({__proto__:null,ShadowMaterial:Th,SpriteMaterial:cc,RawShaderMaterial:Ll,ShaderMaterial:tl,PointsMaterial:Oc,MeshPhysicalMaterial:Bc,MeshStandardMaterial:uc,MeshPhongMaterial:lu,MeshToonMaterial:cu,MeshNormalMaterial:dc,MeshLambertMaterial:Ao,MeshDepthMaterial:Yu,MeshDistanceMaterial:Ju,MeshBasicMaterial:fs,MeshMatcapMaterial:rd,LineDashedMaterial:Xd,LineBasicMaterial:to,Material:Bi});const rr={arraySlice:function(M,i,c){return rr.isTypedArray(M)?new M.constructor(M.subarray(i,c!==void 0?c:M.length)):M.slice(i,c)},convertArray:function(M,i,c){return!M||!c&&M.constructor===i?M:typeof i.BYTES_PER_ELEMENT=="number"?new i(M):Array.prototype.slice.call(M)},isTypedArray:function(M){return ArrayBuffer.isView(M)&&!(M instanceof DataView)},getKeyframeOrder:function(M){const i=M.length,c=new Array(i);for(let g=0;g!==i;++g)c[g]=g;return c.sort(function(g,_){return M[g]-M[_]}),c},sortedArray:function(M,i,c){const g=M.length,_=new M.constructor(g);for(let w=0,A=0;A!==g;++w){const R=c[w]*i;for(let z=0;z!==i;++z)_[A++]=M[R+z]}return _},flattenJSON:function(M,i,c,g){let _=1,w=M[0];for(;w!==void 0&&w[g]===void 0;)w=M[_++];if(w===void 0)return;let A=w[g];if(A!==void 0)if(Array.isArray(A))do A=w[g],A!==void 0&&(i.push(w.time),c.push.apply(c,A)),w=M[_++];while(w!==void 0);else if(A.toArray!==void 0)do A=w[g],A!==void 0&&(i.push(w.time),A.toArray(c,c.length)),w=M[_++];while(w!==void 0);else do A=w[g],A!==void 0&&(i.push(w.time),c.push(A)),w=M[_++];while(w!==void 0)},subclip:function(M,i,c,g,_=30){const w=M.clone();w.name=i;const A=[];for(let z=0;z<w.tracks.length;++z){const F=w.tracks[z],W=F.getValueSize(),q=[],J=[];for(let K=0;K<F.times.length;++K){const re=F.times[K]*_;if(!(re<c||re>=g)){q.push(F.times[K]);for(let ce=0;ce<W;++ce)J.push(F.values[K*W+ce])}}q.length!==0&&(F.times=rr.convertArray(q,F.times.constructor),F.values=rr.convertArray(J,F.values.constructor),A.push(F))}w.tracks=A;let R=1/0;for(let z=0;z<w.tracks.length;++z)R>w.tracks[z].times[0]&&(R=w.tracks[z].times[0]);for(let z=0;z<w.tracks.length;++z)w.tracks[z].shift(-1*R);return w.resetDuration(),w},makeClipAdditive:function(M,i=0,c=M,g=30){g<=0&&(g=30);const _=c.tracks.length,w=i/g;for(let A=0;A<_;++A){const R=c.tracks[A],z=R.ValueTypeName;if(z==="bool"||z==="string")continue;const F=M.tracks.find(function(de){return de.name===R.name&&de.ValueTypeName===z});if(F===void 0)continue;let W=0;const q=R.getValueSize();R.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(W=q/3);let J=0;const K=F.getValueSize();F.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(J=K/3);const re=R.times.length-1;let ce;if(w<=R.times[0]){const de=W,Xe=q-W;ce=rr.arraySlice(R.values,de,Xe)}else if(w>=R.times[re]){const de=re*q+W,Xe=de+q-W;ce=rr.arraySlice(R.values,de,Xe)}else{const de=R.createInterpolant(),Xe=W,nt=q-W;de.evaluate(w),ce=rr.arraySlice(de.resultBuffer,Xe,nt)}z==="quaternion"&&new Rs().fromArray(ce).normalize().conjugate().toArray(ce);const Me=F.times.length;for(let de=0;de<Me;++de){const Xe=de*K+J;if(z==="quaternion")Rs.multiplyQuaternionsFlat(F.values,Xe,ce,0,F.values,Xe);else{const nt=K-2*J;for(let Je=0;Je<nt;++Je)F.values[Xe+Je]-=ce[Je]}}}return M.blendMode=2501,M}};class Nc{constructor(i,c,g,_){this.parameterPositions=i,this._cachedIndex=0,this.resultBuffer=_!==void 0?_:new c.constructor(g),this.sampleValues=c,this.valueSize=g,this.settings=null,this.DefaultSettings_={}}evaluate(i){const c=this.parameterPositions;let g=this._cachedIndex,_=c[g],w=c[g-1];e:{t:{let A;i:{n:if(!(i<_)){for(let R=g+2;;){if(_===void 0){if(i<w)break n;return g=c.length,this._cachedIndex=g,this.afterEnd_(g-1,i,w)}if(g===R)break;if(w=_,_=c[++g],i<_)break t}A=c.length;break i}if(i>=w)break e;{const R=c[1];i<R&&(g=2,w=R);for(let z=g-2;;){if(w===void 0)return this._cachedIndex=0,this.beforeStart_(0,i,_);if(g===z)break;if(_=w,w=c[--g-1],i>=w)break t}A=g,g=0}}for(;g<A;){const R=g+A>>>1;i<c[R]?A=R:g=R+1}if(_=c[g],w=c[g-1],w===void 0)return this._cachedIndex=0,this.beforeStart_(0,i,_);if(_===void 0)return g=c.length,this._cachedIndex=g,this.afterEnd_(g-1,w,i)}this._cachedIndex=g,this.intervalChanged_(g,w,_)}return this.interpolate_(g,w,i,_)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(i){const c=this.resultBuffer,g=this.sampleValues,_=this.valueSize,w=i*_;for(let A=0;A!==_;++A)c[A]=g[w+A];return c}interpolate_(){throw new Error("call to abstract method")}intervalChanged_(){}}Nc.prototype.beforeStart_=Nc.prototype.copySampleValue_,Nc.prototype.afterEnd_=Nc.prototype.copySampleValue_;class Fl extends Nc{constructor(i,c,g,_){super(i,c,g,_),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0,this.DefaultSettings_={endingStart:2400,endingEnd:2400}}intervalChanged_(i,c,g){const _=this.parameterPositions;let w=i-2,A=i+1,R=_[w],z=_[A];if(R===void 0)switch(this.getSettings_().endingStart){case 2401:w=i,R=2*c-g;break;case 2402:w=_.length-2,R=c+_[w]-_[w+1];break;default:w=i,R=g}if(z===void 0)switch(this.getSettings_().endingEnd){case 2401:A=i,z=2*g-c;break;case 2402:A=1,z=g+_[1]-_[0];break;default:A=i-1,z=c}const F=.5*(g-c),W=this.valueSize;this._weightPrev=F/(c-R),this._weightNext=F/(z-g),this._offsetPrev=w*W,this._offsetNext=A*W}interpolate_(i,c,g,_){const w=this.resultBuffer,A=this.sampleValues,R=this.valueSize,z=i*R,F=z-R,W=this._offsetPrev,q=this._offsetNext,J=this._weightPrev,K=this._weightNext,re=(g-c)/(_-c),ce=re*re,Me=ce*re,de=-J*Me+2*J*ce-J*re,Xe=(1+J)*Me+(-1.5-2*J)*ce+(-.5+J)*re+1,nt=(-1-K)*Me+(1.5+K)*ce+.5*re,Je=K*Me-K*ce;for(let gt=0;gt!==R;++gt)w[gt]=de*A[W+gt]+Xe*A[F+gt]+nt*A[z+gt]+Je*A[q+gt];return w}}class $d extends Nc{constructor(i,c,g,_){super(i,c,g,_)}interpolate_(i,c,g,_){const w=this.resultBuffer,A=this.sampleValues,R=this.valueSize,z=i*R,F=z-R,W=(g-c)/(_-c),q=1-W;for(let J=0;J!==R;++J)w[J]=A[F+J]*q+A[z+J]*W;return w}}class Sh extends Nc{constructor(i,c,g,_){super(i,c,g,_)}interpolate_(i){return this.copySampleValue_(i-1)}}class dl{constructor(i,c,g,_){if(i===void 0)throw new Error("THREE.KeyframeTrack: track name is undefined");if(c===void 0||c.length===0)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+i);this.name=i,this.times=rr.convertArray(c,this.TimeBufferType),this.values=rr.convertArray(g,this.ValueBufferType),this.setInterpolation(_||this.DefaultInterpolation)}static toJSON(i){const c=i.constructor;let g;if(c.toJSON!==this.toJSON)g=c.toJSON(i);else{g={name:i.name,times:rr.convertArray(i.times,Array),values:rr.convertArray(i.values,Array)};const _=i.getInterpolation();_!==i.DefaultInterpolation&&(g.interpolation=_)}return g.type=i.ValueTypeName,g}InterpolantFactoryMethodDiscrete(i){return new Sh(this.times,this.values,this.getValueSize(),i)}InterpolantFactoryMethodLinear(i){return new $d(this.times,this.values,this.getValueSize(),i)}InterpolantFactoryMethodSmooth(i){return new Fl(this.times,this.values,this.getValueSize(),i)}setInterpolation(i){let c;switch(i){case 2300:c=this.InterpolantFactoryMethodDiscrete;break;case 2301:c=this.InterpolantFactoryMethodLinear;break;case 2302:c=this.InterpolantFactoryMethodSmooth}if(c===void 0){const g="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(this.createInterpolant===void 0){if(i===this.DefaultInterpolation)throw new Error(g);this.setInterpolation(this.DefaultInterpolation)}return console.warn("THREE.KeyframeTrack:",g),this}return this.createInterpolant=c,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return 2300;case this.InterpolantFactoryMethodLinear:return 2301;case this.InterpolantFactoryMethodSmooth:return 2302}}getValueSize(){return this.values.length/this.times.length}shift(i){if(i!==0){const c=this.times;for(let g=0,_=c.length;g!==_;++g)c[g]+=i}return this}scale(i){if(i!==1){const c=this.times;for(let g=0,_=c.length;g!==_;++g)c[g]*=i}return this}trim(i,c){const g=this.times,_=g.length;let w=0,A=_-1;for(;w!==_&&g[w]<i;)++w;for(;A!==-1&&g[A]>c;)--A;if(++A,w!==0||A!==_){w>=A&&(A=Math.max(A,1),w=A-1);const R=this.getValueSize();this.times=rr.arraySlice(g,w,A),this.values=rr.arraySlice(this.values,w*R,A*R)}return this}validate(){let i=!0;const c=this.getValueSize();c-Math.floor(c)!=0&&(console.error("THREE.KeyframeTrack: Invalid value size in track.",this),i=!1);const g=this.times,_=this.values,w=g.length;w===0&&(console.error("THREE.KeyframeTrack: Track is empty.",this),i=!1);let A=null;for(let R=0;R!==w;R++){const z=g[R];if(typeof z=="number"&&isNaN(z)){console.error("THREE.KeyframeTrack: Time is not a valid number.",this,R,z),i=!1;break}if(A!==null&&A>z){console.error("THREE.KeyframeTrack: Out of order keys.",this,R,z,A),i=!1;break}A=z}if(_!==void 0&&rr.isTypedArray(_))for(let R=0,z=_.length;R!==z;++R){const F=_[R];if(isNaN(F)){console.error("THREE.KeyframeTrack: Value is not a valid number.",this,R,F),i=!1;break}}return i}optimize(){const i=rr.arraySlice(this.times),c=rr.arraySlice(this.values),g=this.getValueSize(),_=this.getInterpolation()===2302,w=i.length-1;let A=1;for(let R=1;R<w;++R){let z=!1;const F=i[R];if(F!==i[R+1]&&(R!==1||F!==i[0]))if(_)z=!0;else{const W=R*g,q=W-g,J=W+g;for(let K=0;K!==g;++K){const re=c[W+K];if(re!==c[q+K]||re!==c[J+K]){z=!0;break}}}if(z){if(R!==A){i[A]=i[R];const W=R*g,q=A*g;for(let J=0;J!==g;++J)c[q+J]=c[W+J]}++A}}if(w>0){i[A]=i[w];for(let R=w*g,z=A*g,F=0;F!==g;++F)c[z+F]=c[R+F];++A}return A!==i.length?(this.times=rr.arraySlice(i,0,A),this.values=rr.arraySlice(c,0,A*g)):(this.times=i,this.values=c),this}clone(){const i=rr.arraySlice(this.times,0),c=rr.arraySlice(this.values,0),g=new this.constructor(this.name,i,c);return g.createInterpolant=this.createInterpolant,g}}dl.prototype.TimeBufferType=Float32Array,dl.prototype.ValueBufferType=Float32Array,dl.prototype.DefaultInterpolation=2301;class Eh extends dl{}Eh.prototype.ValueTypeName="bool",Eh.prototype.ValueBufferType=Array,Eh.prototype.DefaultInterpolation=2300,Eh.prototype.InterpolantFactoryMethodLinear=void 0,Eh.prototype.InterpolantFactoryMethodSmooth=void 0;class Uc extends dl{}Uc.prototype.ValueTypeName="color";class kl extends dl{}kl.prototype.ValueTypeName="number";class Ah extends Nc{constructor(i,c,g,_){super(i,c,g,_)}interpolate_(i,c,g,_){const w=this.resultBuffer,A=this.sampleValues,R=this.valueSize,z=(g-c)/(_-c);let F=i*R;for(let W=F+R;F!==W;F+=4)Rs.slerpFlat(w,0,A,F-R,A,F,z);return w}}class Ch extends dl{InterpolantFactoryMethodLinear(i){return new Ah(this.times,this.values,this.getValueSize(),i)}}Ch.prototype.ValueTypeName="quaternion",Ch.prototype.DefaultInterpolation=2301,Ch.prototype.InterpolantFactoryMethodSmooth=void 0;class Vc extends dl{}Vc.prototype.ValueTypeName="string",Vc.prototype.ValueBufferType=Array,Vc.prototype.DefaultInterpolation=2300,Vc.prototype.InterpolantFactoryMethodLinear=void 0,Vc.prototype.InterpolantFactoryMethodSmooth=void 0;class sd extends dl{}sd.prototype.ValueTypeName="vector";class od{constructor(i,c=-1,g,_=2500){this.name=i,this.tracks=g,this.duration=c,this.blendMode=_,this.uuid=Yn(),this.duration<0&&this.resetDuration()}static parse(i){const c=[],g=i.tracks,_=1/(i.fps||1);for(let A=0,R=g.length;A!==R;++A)c.push(vg(g[A]).scale(_));const w=new this(i.name,i.duration,c,i.blendMode);return w.uuid=i.uuid,w}static toJSON(i){const c=[],g=i.tracks,_={name:i.name,duration:i.duration,tracks:c,uuid:i.uuid,blendMode:i.blendMode};for(let w=0,A=g.length;w!==A;++w)c.push(dl.toJSON(g[w]));return _}static CreateFromMorphTargetSequence(i,c,g,_){const w=c.length,A=[];for(let R=0;R<w;R++){let z=[],F=[];z.push((R+w-1)%w,R,(R+1)%w),F.push(0,1,0);const W=rr.getKeyframeOrder(z);z=rr.sortedArray(z,1,W),F=rr.sortedArray(F,1,W),_||z[0]!==0||(z.push(w),F.push(F[0])),A.push(new kl(".morphTargetInfluences["+c[R].name+"]",z,F).scale(1/g))}return new this(i,-1,A)}static findByName(i,c){let g=i;if(!Array.isArray(i)){const _=i;g=_.geometry&&_.geometry.animations||_.animations}for(let _=0;_<g.length;_++)if(g[_].name===c)return g[_];return null}static CreateClipsFromMorphTargetSequences(i,c,g){const _={},w=/^([\w-]*?)([\d]+)$/;for(let R=0,z=i.length;R<z;R++){const F=i[R],W=F.name.match(w);if(W&&W.length>1){const q=W[1];let J=_[q];J||(_[q]=J=[]),J.push(F)}}const A=[];for(const R in _)A.push(this.CreateFromMorphTargetSequence(R,_[R],c,g));return A}static parseAnimation(i,c){if(!i)return console.error("THREE.AnimationClip: No animation in JSONLoader data."),null;const g=function(W,q,J,K,re){if(J.length!==0){const ce=[],Me=[];rr.flattenJSON(J,ce,Me,K),ce.length!==0&&re.push(new W(q,ce,Me))}},_=[],w=i.name||"default",A=i.fps||30,R=i.blendMode;let z=i.length||-1;const F=i.hierarchy||[];for(let W=0;W<F.length;W++){const q=F[W].keys;if(q&&q.length!==0)if(q[0].morphTargets){const J={};let K;for(K=0;K<q.length;K++)if(q[K].morphTargets)for(let re=0;re<q[K].morphTargets.length;re++)J[q[K].morphTargets[re]]=-1;for(const re in J){const ce=[],Me=[];for(let de=0;de!==q[K].morphTargets.length;++de){const Xe=q[K];ce.push(Xe.time),Me.push(Xe.morphTarget===re?1:0)}_.push(new kl(".morphTargetInfluence["+re+"]",ce,Me))}z=J.length*(A||1)}else{const J=".bones["+c[W].name+"]";g(sd,J+".position",q,"pos",_),g(Ch,J+".quaternion",q,"rot",_),g(sd,J+".scale",q,"scl",_)}}return _.length===0?null:new this(w,z,_,R)}resetDuration(){let i=0;for(let c=0,g=this.tracks.length;c!==g;++c){const _=this.tracks[c];i=Math.max(i,_.times[_.times.length-1])}return this.duration=i,this}trim(){for(let i=0;i<this.tracks.length;i++)this.tracks[i].trim(0,this.duration);return this}validate(){let i=!0;for(let c=0;c<this.tracks.length;c++)i=i&&this.tracks[c].validate();return i}optimize(){for(let i=0;i<this.tracks.length;i++)this.tracks[i].optimize();return this}clone(){const i=[];for(let c=0;c<this.tracks.length;c++)i.push(this.tracks[c].clone());return new this.constructor(this.name,this.duration,i,this.blendMode)}toJSON(){return this.constructor.toJSON(this)}}function vg(M){if(M.type===void 0)throw new Error("THREE.KeyframeTrack: track type undefined, can not parse");const i=function(c){switch(c.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return kl;case"vector":case"vector2":case"vector3":case"vector4":return sd;case"color":return Uc;case"quaternion":return Ch;case"bool":case"boolean":return Eh;case"string":return Vc}throw new Error("THREE.KeyframeTrack: Unsupported typeName: "+c)}(M.type);if(M.times===void 0){const c=[],g=[];rr.flattenJSON(M.keys,c,g,"value"),M.times=c,M.values=g}return i.parse!==void 0?i.parse(M):new i(M.name,M.times,M.values,M.interpolation)}const pl={enabled:!1,files:{},add:function(M,i){this.enabled!==!1&&(this.files[M]=i)},get:function(M){if(this.enabled!==!1)return this.files[M]},remove:function(M){delete this.files[M]},clear:function(){this.files={}}};class Gc{constructor(i,c,g){const _=this;let w,A=!1,R=0,z=0;const F=[];this.onStart=void 0,this.onLoad=i,this.onProgress=c,this.onError=g,this.itemStart=function(W){z++,A===!1&&_.onStart!==void 0&&_.onStart(W,R,z),A=!0},this.itemEnd=function(W){R++,_.onProgress!==void 0&&_.onProgress(W,R,z),R===z&&(A=!1,_.onLoad!==void 0&&_.onLoad())},this.itemError=function(W){_.onError!==void 0&&_.onError(W)},this.resolveURL=function(W){return w?w(W):W},this.setURLModifier=function(W){return w=W,this},this.addHandler=function(W,q){return F.push(W,q),this},this.removeHandler=function(W){const q=F.indexOf(W);return q!==-1&&F.splice(q,2),this},this.getHandler=function(W){for(let q=0,J=F.length;q<J;q+=2){const K=F[q],re=F[q+1];if(K.global&&(K.lastIndex=0),K.test(W))return re}return null}}}const lm=new Gc;class Vo{constructor(i){this.manager=i!==void 0?i:lm,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(i,c){const g=this;return new Promise(function(_,w){g.load(i,_,c,w)})}parse(){}setCrossOrigin(i){return this.crossOrigin=i,this}setWithCredentials(i){return this.withCredentials=i,this}setPath(i){return this.path=i,this}setResourcePath(i){return this.resourcePath=i,this}setRequestHeader(i){return this.requestHeader=i,this}}const fl={};class ml extends Vo{constructor(i){super(i)}load(i,c,g,_){i===void 0&&(i=""),this.path!==void 0&&(i=this.path+i),i=this.manager.resolveURL(i);const w=this,A=pl.get(i);if(A!==void 0)return w.manager.itemStart(i),setTimeout(function(){c&&c(A),w.manager.itemEnd(i)},0),A;if(fl[i]!==void 0)return void fl[i].push({onLoad:c,onProgress:g,onError:_});const R=i.match(/^data:(.*?)(;base64)?,(.*)$/);let z;if(R){const F=R[1],W=!!R[2];let q=R[3];q=decodeURIComponent(q),W&&(q=atob(q));try{let J;const K=(this.responseType||"").toLowerCase();switch(K){case"arraybuffer":case"blob":const re=new Uint8Array(q.length);for(let Me=0;Me<q.length;Me++)re[Me]=q.charCodeAt(Me);J=K==="blob"?new Blob([re.buffer],{type:F}):re.buffer;break;case"document":J=new DOMParser().parseFromString(q,F);break;case"json":J=JSON.parse(q);break;default:J=q}setTimeout(function(){c&&c(J),w.manager.itemEnd(i)},0)}catch(J){setTimeout(function(){_&&_(J),w.manager.itemError(i),w.manager.itemEnd(i)},0)}}else{fl[i]=[],fl[i].push({onLoad:c,onProgress:g,onError:_}),z=new XMLHttpRequest,z.open("GET",i,!0),z.addEventListener("load",function(F){const W=this.response,q=fl[i];if(delete fl[i],this.status===200||this.status===0){this.status===0&&console.warn("THREE.FileLoader: HTTP Status 0 received."),pl.add(i,W);for(let J=0,K=q.length;J<K;J++){const re=q[J];re.onLoad&&re.onLoad(W)}w.manager.itemEnd(i)}else{for(let J=0,K=q.length;J<K;J++){const re=q[J];re.onError&&re.onError(F)}w.manager.itemError(i),w.manager.itemEnd(i)}},!1),z.addEventListener("progress",function(F){const W=fl[i];for(let q=0,J=W.length;q<J;q++){const K=W[q];K.onProgress&&K.onProgress(F)}},!1),z.addEventListener("error",function(F){const W=fl[i];delete fl[i];for(let q=0,J=W.length;q<J;q++){const K=W[q];K.onError&&K.onError(F)}w.manager.itemError(i),w.manager.itemEnd(i)},!1),z.addEventListener("abort",function(F){const W=fl[i];delete fl[i];for(let q=0,J=W.length;q<J;q++){const K=W[q];K.onError&&K.onError(F)}w.manager.itemError(i),w.manager.itemEnd(i)},!1),this.responseType!==void 0&&(z.responseType=this.responseType),this.withCredentials!==void 0&&(z.withCredentials=this.withCredentials),z.overrideMimeType&&z.overrideMimeType(this.mimeType!==void 0?this.mimeType:"text/plain");for(const F in this.requestHeader)z.setRequestHeader(F,this.requestHeader[F]);z.send(null)}return w.manager.itemStart(i),z}setResponseType(i){return this.responseType=i,this}setMimeType(i){return this.mimeType=i,this}}class no extends Vo{constructor(i){super(i)}load(i,c,g,_){this.path!==void 0&&(i=this.path+i),i=this.manager.resolveURL(i);const w=this,A=pl.get(i);if(A!==void 0)return w.manager.itemStart(i),setTimeout(function(){c&&c(A),w.manager.itemEnd(i)},0),A;const R=document.createElementNS("http://www.w3.org/1999/xhtml","img");function z(){R.removeEventListener("load",z,!1),R.removeEventListener("error",F,!1),pl.add(i,this),c&&c(this),w.manager.itemEnd(i)}function F(W){R.removeEventListener("load",z,!1),R.removeEventListener("error",F,!1),_&&_(W),w.manager.itemError(i),w.manager.itemEnd(i)}return R.addEventListener("load",z,!1),R.addEventListener("error",F,!1),i.substr(0,5)!=="data:"&&this.crossOrigin!==void 0&&(R.crossOrigin=this.crossOrigin),w.manager.itemStart(i),R.src=i,R}}class cm extends Vo{constructor(i){super(i)}load(i,c,g,_){const w=new il,A=new no(this.manager);A.setCrossOrigin(this.crossOrigin),A.setPath(this.path);let R=0;function z(F){A.load(i[F],function(W){w.images[F]=W,R++,R===6&&(w.needsUpdate=!0,c&&c(w))},void 0,_)}for(let F=0;F<i.length;++F)z(F);return w}}class hm extends Vo{constructor(i){super(i)}load(i,c,g,_){const w=this,A=new Dl,R=new ml(this.manager);return R.setResponseType("arraybuffer"),R.setRequestHeader(this.requestHeader),R.setPath(this.path),R.setWithCredentials(w.withCredentials),R.load(i,function(z){const F=w.parse(z);F&&(F.image!==void 0?A.image=F.image:F.data!==void 0&&(A.image.width=F.width,A.image.height=F.height,A.image.data=F.data),A.wrapS=F.wrapS!==void 0?F.wrapS:1001,A.wrapT=F.wrapT!==void 0?F.wrapT:1001,A.magFilter=F.magFilter!==void 0?F.magFilter:1006,A.minFilter=F.minFilter!==void 0?F.minFilter:1006,A.anisotropy=F.anisotropy!==void 0?F.anisotropy:1,F.encoding!==void 0&&(A.encoding=F.encoding),F.flipY!==void 0&&(A.flipY=F.flipY),F.format!==void 0&&(A.format=F.format),F.type!==void 0&&(A.type=F.type),F.mipmaps!==void 0&&(A.mipmaps=F.mipmaps,A.minFilter=1008),F.mipmapCount===1&&(A.minFilter=1006),F.generateMipmaps!==void 0&&(A.generateMipmaps=F.generateMipmaps),A.needsUpdate=!0,c&&c(A,F))},g,_),A}}class hu extends Vo{constructor(i){super(i)}load(i,c,g,_){const w=new ds,A=new no(this.manager);return A.setCrossOrigin(this.crossOrigin),A.setPath(this.path),A.load(i,function(R){w.image=R;const z=i.search(/\.jpe?g($|\?)/i)>0||i.search(/^data\:image\/jpeg/)===0;w.format=z?1022:1023,w.needsUpdate=!0,c!==void 0&&c(w)},g,_),w}}class um extends ee{constructor(){super(),this.type="CurvePath",this.curves=[],this.autoClose=!1}add(i){this.curves.push(i)}closePath(){const i=this.curves[0].getPoint(0),c=this.curves[this.curves.length-1].getPoint(1);i.equals(c)||this.curves.push(new ct(c,i))}getPoint(i){const c=i*this.getLength(),g=this.getCurveLengths();let _=0;for(;_<g.length;){if(g[_]>=c){const w=g[_]-c,A=this.curves[_],R=A.getLength(),z=R===0?0:1-w/R;return A.getPointAt(z)}_++}return null}getLength(){const i=this.getCurveLengths();return i[i.length-1]}updateArcLengths(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()}getCurveLengths(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;const i=[];let c=0;for(let g=0,_=this.curves.length;g<_;g++)c+=this.curves[g].getLength(),i.push(c);return this.cacheLengths=i,i}getSpacedPoints(i=40){const c=[];for(let g=0;g<=i;g++)c.push(this.getPoint(g/i));return this.autoClose&&c.push(c[0]),c}getPoints(i=12){const c=[];let g;for(let _=0,w=this.curves;_<w.length;_++){const A=w[_],R=A&&A.isEllipseCurve?2*i:A&&(A.isLineCurve||A.isLineCurve3)?1:A&&A.isSplineCurve?i*A.points.length:i,z=A.getPoints(R);for(let F=0;F<z.length;F++){const W=z[F];g&&g.equals(W)||(c.push(W),g=W)}}return this.autoClose&&c.length>1&&!c[c.length-1].equals(c[0])&&c.push(c[0]),c}copy(i){super.copy(i),this.curves=[];for(let c=0,g=i.curves.length;c<g;c++){const _=i.curves[c];this.curves.push(_.clone())}return this.autoClose=i.autoClose,this}toJSON(){const i=super.toJSON();i.autoClose=this.autoClose,i.curves=[];for(let c=0,g=this.curves.length;c<g;c++){const _=this.curves[c];i.curves.push(_.toJSON())}return i}fromJSON(i){super.fromJSON(i),this.autoClose=i.autoClose,this.curves=[];for(let c=0,g=i.curves.length;c<g;c++){const _=i.curves[c];this.curves.push(new mi[_.type]().fromJSON(_))}return this}}class Hc extends um{constructor(i){super(),this.type="Path",this.currentPoint=new Ri,i&&this.setFromPoints(i)}setFromPoints(i){this.moveTo(i[0].x,i[0].y);for(let c=1,g=i.length;c<g;c++)this.lineTo(i[c].x,i[c].y);return this}moveTo(i,c){return this.currentPoint.set(i,c),this}lineTo(i,c){const g=new ct(this.currentPoint.clone(),new Ri(i,c));return this.curves.push(g),this.currentPoint.set(i,c),this}quadraticCurveTo(i,c,g,_){const w=new mt(this.currentPoint.clone(),new Ri(i,c),new Ri(g,_));return this.curves.push(w),this.currentPoint.set(g,_),this}bezierCurveTo(i,c,g,_,w,A){const R=new xe(this.currentPoint.clone(),new Ri(i,c),new Ri(g,_),new Ri(w,A));return this.curves.push(R),this.currentPoint.set(w,A),this}splineThru(i){const c=[this.currentPoint.clone()].concat(i),g=new Nt(c);return this.curves.push(g),this.currentPoint.copy(i[i.length-1]),this}arc(i,c,g,_,w,A){const R=this.currentPoint.x,z=this.currentPoint.y;return this.absarc(i+R,c+z,g,_,w,A),this}absarc(i,c,g,_,w,A){return this.absellipse(i,c,g,g,_,w,A),this}ellipse(i,c,g,_,w,A,R,z){const F=this.currentPoint.x,W=this.currentPoint.y;return this.absellipse(i+F,c+W,g,_,w,A,R,z),this}absellipse(i,c,g,_,w,A,R,z){const F=new ie(i,c,g,_,w,A,R,z);if(this.curves.length>0){const q=F.getPoint(0);q.equals(this.currentPoint)||this.lineTo(q.x,q.y)}this.curves.push(F);const W=F.getPoint(1);return this.currentPoint.copy(W),this}copy(i){return super.copy(i),this.currentPoint.copy(i.currentPoint),this}toJSON(){const i=super.toJSON();return i.currentPoint=this.currentPoint.toArray(),i}fromJSON(i){return super.fromJSON(i),this.currentPoint.fromArray(i.currentPoint),this}}class jc extends Hc{constructor(i){super(i),this.uuid=Yn(),this.type="Shape",this.holes=[]}getPointsHoles(i){const c=[];for(let g=0,_=this.holes.length;g<_;g++)c[g]=this.holes[g].getPoints(i);return c}extractPoints(i){return{shape:this.getPoints(i),holes:this.getPointsHoles(i)}}copy(i){super.copy(i),this.holes=[];for(let c=0,g=i.holes.length;c<g;c++){const _=i.holes[c];this.holes.push(_.clone())}return this}toJSON(){const i=super.toJSON();i.uuid=this.uuid,i.holes=[];for(let c=0,g=this.holes.length;c<g;c++){const _=this.holes[c];i.holes.push(_.toJSON())}return i}fromJSON(i){super.fromJSON(i),this.uuid=i.uuid,this.holes=[];for(let c=0,g=i.holes.length;c<g;c++){const _=i.holes[c];this.holes.push(new Hc().fromJSON(_))}return this}}class Da extends we{constructor(i,c=1){super(),this.type="Light",this.color=new un(i),this.intensity=c}dispose(){}copy(i){return super.copy(i),this.color.copy(i.color),this.intensity=i.intensity,this}toJSON(i){const c=super.toJSON(i);return c.object.color=this.color.getHex(),c.object.intensity=this.intensity,this.groundColor!==void 0&&(c.object.groundColor=this.groundColor.getHex()),this.distance!==void 0&&(c.object.distance=this.distance),this.angle!==void 0&&(c.object.angle=this.angle),this.decay!==void 0&&(c.object.decay=this.decay),this.penumbra!==void 0&&(c.object.penumbra=this.penumbra),this.shadow!==void 0&&(c.object.shadow=this.shadow.toJSON()),c}}Da.prototype.isLight=!0;class Yp extends Da{constructor(i,c,g){super(i,g),this.type="HemisphereLight",this.position.copy(we.DefaultUp),this.updateMatrix(),this.groundColor=new un(c)}copy(i){return Da.prototype.copy.call(this,i),this.groundColor.copy(i.groundColor),this}}Yp.prototype.isHemisphereLight=!0;const Jp=new Mn,dm=new et,pm=new et;class fm{constructor(i){this.camera=i,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new Ri(512,512),this.map=null,this.mapPass=null,this.matrix=new Mn,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new tc,this._frameExtents=new Ri(1,1),this._viewportCount=1,this._viewports=[new Mr(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(i){const c=this.camera,g=this.matrix;dm.setFromMatrixPosition(i.matrixWorld),c.position.copy(dm),pm.setFromMatrixPosition(i.target.matrixWorld),c.lookAt(pm),c.updateMatrixWorld(),Jp.multiplyMatrices(c.projectionMatrix,c.matrixWorldInverse),this._frustum.setFromProjectionMatrix(Jp),g.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),g.multiply(c.projectionMatrix),g.multiply(c.matrixWorldInverse)}getViewport(i){return this._viewports[i]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(i){return this.camera=i.camera.clone(),this.bias=i.bias,this.radius=i.radius,this.mapSize.copy(i.mapSize),this}clone(){return new this.constructor().copy(this)}toJSON(){const i={};return this.bias!==0&&(i.bias=this.bias),this.normalBias!==0&&(i.normalBias=this.normalBias),this.radius!==1&&(i.radius=this.radius),this.mapSize.x===512&&this.mapSize.y===512||(i.mapSize=this.mapSize.toArray()),i.camera=this.camera.toJSON(!1).object,delete i.camera.matrix,i}}class mm extends fm{constructor(){super(new go(50,1,.5,500)),this.focus=1}updateMatrices(i){const c=this.camera,g=2*Gn*i.angle*this.focus,_=this.mapSize.width/this.mapSize.height,w=i.distance||c.far;g===c.fov&&_===c.aspect&&w===c.far||(c.fov=g,c.aspect=_,c.far=w,c.updateProjectionMatrix()),super.updateMatrices(i)}copy(i){return super.copy(i),this.focus=i.focus,this}}mm.prototype.isSpotLightShadow=!0;class gm extends Da{constructor(i,c,g=0,_=Math.PI/3,w=0,A=1){super(i,c),this.type="SpotLight",this.position.copy(we.DefaultUp),this.updateMatrix(),this.target=new we,this.distance=g,this.angle=_,this.penumbra=w,this.decay=A,this.shadow=new mm}get power(){return this.intensity*Math.PI}set power(i){this.intensity=i/Math.PI}dispose(){this.shadow.dispose()}copy(i){return super.copy(i),this.distance=i.distance,this.angle=i.angle,this.penumbra=i.penumbra,this.decay=i.decay,this.target=i.target.clone(),this.shadow=i.shadow.clone(),this}}gm.prototype.isSpotLight=!0;const bg=new Mn,Yd=new et,_m=new et;class wg extends fm{constructor(){super(new go(90,1,.5,500)),this._frameExtents=new Ri(4,2),this._viewportCount=6,this._viewports=[new Mr(2,1,1,1),new Mr(0,1,1,1),new Mr(3,1,1,1),new Mr(1,1,1,1),new Mr(3,0,1,1),new Mr(1,0,1,1)],this._cubeDirections=[new et(1,0,0),new et(-1,0,0),new et(0,0,1),new et(0,0,-1),new et(0,1,0),new et(0,-1,0)],this._cubeUps=[new et(0,1,0),new et(0,1,0),new et(0,1,0),new et(0,1,0),new et(0,0,1),new et(0,0,-1)]}updateMatrices(i,c=0){const g=this.camera,_=this.matrix,w=i.distance||g.far;w!==g.far&&(g.far=w,g.updateProjectionMatrix()),Yd.setFromMatrixPosition(i.matrixWorld),g.position.copy(Yd),_m.copy(g.position),_m.add(this._cubeDirections[c]),g.up.copy(this._cubeUps[c]),g.lookAt(_m),g.updateMatrixWorld(),_.makeTranslation(-Yd.x,-Yd.y,-Yd.z),bg.multiplyMatrices(g.projectionMatrix,g.matrixWorldInverse),this._frustum.setFromProjectionMatrix(bg)}}wg.prototype.isPointLightShadow=!0;class ym extends Da{constructor(i,c,g=0,_=1){super(i,c),this.type="PointLight",this.distance=g,this.decay=_,this.shadow=new wg}get power(){return 4*this.intensity*Math.PI}set power(i){this.intensity=i/(4*Math.PI)}dispose(){this.shadow.dispose()}copy(i){return super.copy(i),this.distance=i.distance,this.decay=i.decay,this.shadow=i.shadow.clone(),this}}ym.prototype.isPointLight=!0;class Mg extends fm{constructor(){super(new Hh(-5,5,5,-5,.5,500))}}Mg.prototype.isDirectionalLightShadow=!0;class xm extends Da{constructor(i,c){super(i,c),this.type="DirectionalLight",this.position.copy(we.DefaultUp),this.updateMatrix(),this.target=new we,this.shadow=new Mg}dispose(){this.shadow.dispose()}copy(i){return super.copy(i),this.target=i.target.clone(),this.shadow=i.shadow.clone(),this}}xm.prototype.isDirectionalLight=!0;class vm extends Da{constructor(i,c){super(i,c),this.type="AmbientLight"}}vm.prototype.isAmbientLight=!0;class Tg extends Da{constructor(i,c,g=10,_=10){super(i,c),this.type="RectAreaLight",this.width=g,this.height=_}get power(){return this.intensity*this.width*this.height*Math.PI}set power(i){this.intensity=i/(this.width*this.height*Math.PI)}copy(i){return super.copy(i),this.width=i.width,this.height=i.height,this}toJSON(i){const c=super.toJSON(i);return c.object.width=this.width,c.object.height=this.height,c}}Tg.prototype.isRectAreaLight=!0;class Sg{constructor(){this.coefficients=[];for(let i=0;i<9;i++)this.coefficients.push(new et)}set(i){for(let c=0;c<9;c++)this.coefficients[c].copy(i[c]);return this}zero(){for(let i=0;i<9;i++)this.coefficients[i].set(0,0,0);return this}getAt(i,c){const g=i.x,_=i.y,w=i.z,A=this.coefficients;return c.copy(A[0]).multiplyScalar(.282095),c.addScaledVector(A[1],.488603*_),c.addScaledVector(A[2],.488603*w),c.addScaledVector(A[3],.488603*g),c.addScaledVector(A[4],g*_*1.092548),c.addScaledVector(A[5],_*w*1.092548),c.addScaledVector(A[6],.315392*(3*w*w-1)),c.addScaledVector(A[7],g*w*1.092548),c.addScaledVector(A[8],.546274*(g*g-_*_)),c}getIrradianceAt(i,c){const g=i.x,_=i.y,w=i.z,A=this.coefficients;return c.copy(A[0]).multiplyScalar(.886227),c.addScaledVector(A[1],1.023328*_),c.addScaledVector(A[2],1.023328*w),c.addScaledVector(A[3],1.023328*g),c.addScaledVector(A[4],.858086*g*_),c.addScaledVector(A[5],.858086*_*w),c.addScaledVector(A[6],.743125*w*w-.247708),c.addScaledVector(A[7],.858086*g*w),c.addScaledVector(A[8],.429043*(g*g-_*_)),c}add(i){for(let c=0;c<9;c++)this.coefficients[c].add(i.coefficients[c]);return this}addScaledSH(i,c){for(let g=0;g<9;g++)this.coefficients[g].addScaledVector(i.coefficients[g],c);return this}scale(i){for(let c=0;c<9;c++)this.coefficients[c].multiplyScalar(i);return this}lerp(i,c){for(let g=0;g<9;g++)this.coefficients[g].lerp(i.coefficients[g],c);return this}equals(i){for(let c=0;c<9;c++)if(!this.coefficients[c].equals(i.coefficients[c]))return!1;return!0}copy(i){return this.set(i.coefficients)}clone(){return new this.constructor().copy(this)}fromArray(i,c=0){const g=this.coefficients;for(let _=0;_<9;_++)g[_].fromArray(i,c+3*_);return this}toArray(i=[],c=0){const g=this.coefficients;for(let _=0;_<9;_++)g[_].toArray(i,c+3*_);return i}static getBasisAt(i,c){const g=i.x,_=i.y,w=i.z;c[0]=.282095,c[1]=.488603*_,c[2]=.488603*w,c[3]=.488603*g,c[4]=1.092548*g*_,c[5]=1.092548*_*w,c[6]=.315392*(3*w*w-1),c[7]=1.092548*g*w,c[8]=.546274*(g*g-_*_)}}Sg.prototype.isSphericalHarmonics3=!0;class Ts extends Da{constructor(i=new Sg,c=1){super(void 0,c),this.sh=i}copy(i){return super.copy(i),this.sh.copy(i.sh),this}fromJSON(i){return this.intensity=i.intensity,this.sh.fromArray(i.sh),this}toJSON(i){const c=super.toJSON(i);return c.object.sh=this.sh.toArray(),c}}Ts.prototype.isLightProbe=!0;class Eg extends Vo{constructor(i){super(i),this.textures={}}load(i,c,g,_){const w=this,A=new ml(w.manager);A.setPath(w.path),A.setRequestHeader(w.requestHeader),A.setWithCredentials(w.withCredentials),A.load(i,function(R){try{c(w.parse(JSON.parse(R)))}catch(z){_?_(z):console.error(z),w.manager.itemError(i)}},g,_)}parse(i){const c=this.textures;function g(w){return c[w]===void 0&&console.warn("THREE.MaterialLoader: Undefined texture",w),c[w]}const _=new Os[i.type];if(i.uuid!==void 0&&(_.uuid=i.uuid),i.name!==void 0&&(_.name=i.name),i.color!==void 0&&_.color!==void 0&&_.color.setHex(i.color),i.roughness!==void 0&&(_.roughness=i.roughness),i.metalness!==void 0&&(_.metalness=i.metalness),i.sheenTint!==void 0&&(_.sheenTint=new un().setHex(i.sheenTint)),i.emissive!==void 0&&_.emissive!==void 0&&_.emissive.setHex(i.emissive),i.specular!==void 0&&_.specular!==void 0&&_.specular.setHex(i.specular),i.specularIntensity!==void 0&&(_.specularIntensity=i.specularIntensity),i.specularTint!==void 0&&_.specularTint!==void 0&&_.specularTint.setHex(i.specularTint),i.shininess!==void 0&&(_.shininess=i.shininess),i.clearcoat!==void 0&&(_.clearcoat=i.clearcoat),i.clearcoatRoughness!==void 0&&(_.clearcoatRoughness=i.clearcoatRoughness),i.transmission!==void 0&&(_.transmission=i.transmission),i.thickness!==void 0&&(_.thickness=i.thickness),i.attenuationDistance!==void 0&&(_.attenuationDistance=i.attenuationDistance),i.attenuationTint!==void 0&&_.attenuationTint!==void 0&&_.attenuationTint.setHex(i.attenuationTint),i.fog!==void 0&&(_.fog=i.fog),i.flatShading!==void 0&&(_.flatShading=i.flatShading),i.blending!==void 0&&(_.blending=i.blending),i.combine!==void 0&&(_.combine=i.combine),i.side!==void 0&&(_.side=i.side),i.shadowSide!==void 0&&(_.shadowSide=i.shadowSide),i.opacity!==void 0&&(_.opacity=i.opacity),i.format!==void 0&&(_.format=i.format),i.transparent!==void 0&&(_.transparent=i.transparent),i.alphaTest!==void 0&&(_.alphaTest=i.alphaTest),i.depthTest!==void 0&&(_.depthTest=i.depthTest),i.depthWrite!==void 0&&(_.depthWrite=i.depthWrite),i.colorWrite!==void 0&&(_.colorWrite=i.colorWrite),i.stencilWrite!==void 0&&(_.stencilWrite=i.stencilWrite),i.stencilWriteMask!==void 0&&(_.stencilWriteMask=i.stencilWriteMask),i.stencilFunc!==void 0&&(_.stencilFunc=i.stencilFunc),i.stencilRef!==void 0&&(_.stencilRef=i.stencilRef),i.stencilFuncMask!==void 0&&(_.stencilFuncMask=i.stencilFuncMask),i.stencilFail!==void 0&&(_.stencilFail=i.stencilFail),i.stencilZFail!==void 0&&(_.stencilZFail=i.stencilZFail),i.stencilZPass!==void 0&&(_.stencilZPass=i.stencilZPass),i.wireframe!==void 0&&(_.wireframe=i.wireframe),i.wireframeLinewidth!==void 0&&(_.wireframeLinewidth=i.wireframeLinewidth),i.wireframeLinecap!==void 0&&(_.wireframeLinecap=i.wireframeLinecap),i.wireframeLinejoin!==void 0&&(_.wireframeLinejoin=i.wireframeLinejoin),i.rotation!==void 0&&(_.rotation=i.rotation),i.linewidth!==1&&(_.linewidth=i.linewidth),i.dashSize!==void 0&&(_.dashSize=i.dashSize),i.gapSize!==void 0&&(_.gapSize=i.gapSize),i.scale!==void 0&&(_.scale=i.scale),i.polygonOffset!==void 0&&(_.polygonOffset=i.polygonOffset),i.polygonOffsetFactor!==void 0&&(_.polygonOffsetFactor=i.polygonOffsetFactor),i.polygonOffsetUnits!==void 0&&(_.polygonOffsetUnits=i.polygonOffsetUnits),i.dithering!==void 0&&(_.dithering=i.dithering),i.alphaToCoverage!==void 0&&(_.alphaToCoverage=i.alphaToCoverage),i.premultipliedAlpha!==void 0&&(_.premultipliedAlpha=i.premultipliedAlpha),i.visible!==void 0&&(_.visible=i.visible),i.toneMapped!==void 0&&(_.toneMapped=i.toneMapped),i.userData!==void 0&&(_.userData=i.userData),i.vertexColors!==void 0&&(typeof i.vertexColors=="number"?_.vertexColors=i.vertexColors>0:_.vertexColors=i.vertexColors),i.uniforms!==void 0)for(const w in i.uniforms){const A=i.uniforms[w];switch(_.uniforms[w]={},A.type){case"t":_.uniforms[w].value=g(A.value);break;case"c":_.uniforms[w].value=new un().setHex(A.value);break;case"v2":_.uniforms[w].value=new Ri().fromArray(A.value);break;case"v3":_.uniforms[w].value=new et().fromArray(A.value);break;case"v4":_.uniforms[w].value=new Mr().fromArray(A.value);break;case"m3":_.uniforms[w].value=new jr().fromArray(A.value);break;case"m4":_.uniforms[w].value=new Mn().fromArray(A.value);break;default:_.uniforms[w].value=A.value}}if(i.defines!==void 0&&(_.defines=i.defines),i.vertexShader!==void 0&&(_.vertexShader=i.vertexShader),i.fragmentShader!==void 0&&(_.fragmentShader=i.fragmentShader),i.extensions!==void 0)for(const w in i.extensions)_.extensions[w]=i.extensions[w];if(i.shading!==void 0&&(_.flatShading=i.shading===1),i.size!==void 0&&(_.size=i.size),i.sizeAttenuation!==void 0&&(_.sizeAttenuation=i.sizeAttenuation),i.map!==void 0&&(_.map=g(i.map)),i.matcap!==void 0&&(_.matcap=g(i.matcap)),i.alphaMap!==void 0&&(_.alphaMap=g(i.alphaMap)),i.bumpMap!==void 0&&(_.bumpMap=g(i.bumpMap)),i.bumpScale!==void 0&&(_.bumpScale=i.bumpScale),i.normalMap!==void 0&&(_.normalMap=g(i.normalMap)),i.normalMapType!==void 0&&(_.normalMapType=i.normalMapType),i.normalScale!==void 0){let w=i.normalScale;Array.isArray(w)===!1&&(w=[w,w]),_.normalScale=new Ri().fromArray(w)}return i.displacementMap!==void 0&&(_.displacementMap=g(i.displacementMap)),i.displacementScale!==void 0&&(_.displacementScale=i.displacementScale),i.displacementBias!==void 0&&(_.displacementBias=i.displacementBias),i.roughnessMap!==void 0&&(_.roughnessMap=g(i.roughnessMap)),i.metalnessMap!==void 0&&(_.metalnessMap=g(i.metalnessMap)),i.emissiveMap!==void 0&&(_.emissiveMap=g(i.emissiveMap)),i.emissiveIntensity!==void 0&&(_.emissiveIntensity=i.emissiveIntensity),i.specularMap!==void 0&&(_.specularMap=g(i.specularMap)),i.specularIntensityMap!==void 0&&(_.specularIntensityMap=g(i.specularIntensityMap)),i.specularTintMap!==void 0&&(_.specularTintMap=g(i.specularTintMap)),i.envMap!==void 0&&(_.envMap=g(i.envMap)),i.envMapIntensity!==void 0&&(_.envMapIntensity=i.envMapIntensity),i.reflectivity!==void 0&&(_.reflectivity=i.reflectivity),i.refractionRatio!==void 0&&(_.refractionRatio=i.refractionRatio),i.lightMap!==void 0&&(_.lightMap=g(i.lightMap)),i.lightMapIntensity!==void 0&&(_.lightMapIntensity=i.lightMapIntensity),i.aoMap!==void 0&&(_.aoMap=g(i.aoMap)),i.aoMapIntensity!==void 0&&(_.aoMapIntensity=i.aoMapIntensity),i.gradientMap!==void 0&&(_.gradientMap=g(i.gradientMap)),i.clearcoatMap!==void 0&&(_.clearcoatMap=g(i.clearcoatMap)),i.clearcoatRoughnessMap!==void 0&&(_.clearcoatRoughnessMap=g(i.clearcoatRoughnessMap)),i.clearcoatNormalMap!==void 0&&(_.clearcoatNormalMap=g(i.clearcoatNormalMap)),i.clearcoatNormalScale!==void 0&&(_.clearcoatNormalScale=new Ri().fromArray(i.clearcoatNormalScale)),i.transmissionMap!==void 0&&(_.transmissionMap=g(i.transmissionMap)),i.thicknessMap!==void 0&&(_.thicknessMap=g(i.thicknessMap)),_}setTextures(i){return this.textures=i,this}}class bm{static decodeText(i){if(typeof TextDecoder<"u")return new TextDecoder().decode(i);let c="";for(let g=0,_=i.length;g<_;g++)c+=String.fromCharCode(i[g]);try{return decodeURIComponent(escape(c))}catch{return c}}static extractUrlBase(i){const c=i.lastIndexOf("/");return c===-1?"./":i.substr(0,c+1)}}class Ag extends Er{constructor(){super(),this.type="InstancedBufferGeometry",this.instanceCount=1/0}copy(i){return super.copy(i),this.instanceCount=i.instanceCount,this}clone(){return new this.constructor().copy(this)}toJSON(){const i=super.toJSON(this);return i.instanceCount=this.instanceCount,i.isInstancedBufferGeometry=!0,i}}Ag.prototype.isInstancedBufferGeometry=!0;class Jd extends Vo{constructor(i){super(i)}load(i,c,g,_){const w=this,A=new ml(w.manager);A.setPath(w.path),A.setRequestHeader(w.requestHeader),A.setWithCredentials(w.withCredentials),A.load(i,function(R){try{c(w.parse(JSON.parse(R)))}catch(z){_?_(z):console.error(z),w.manager.itemError(i)}},g,_)}parse(i){const c={},g={};function _(q,J){if(c[J]!==void 0)return c[J];const K=q.interleavedBuffers[J],re=function(de,Xe){if(g[Xe]!==void 0)return g[Xe];const nt=de.arrayBuffers[Xe],Je=new Uint32Array(nt).buffer;return g[Xe]=Je,Je}(q,K.buffer),ce=qo(K.type,re),Me=new Pl(ce,K.stride);return Me.uuid=K.uuid,c[J]=Me,Me}const w=i.isInstancedBufferGeometry?new Ag:new Er,A=i.data.index;if(A!==void 0){const q=qo(A.type,A.array);w.setIndex(new pn(q,1))}const R=i.data.attributes;for(const q in R){const J=R[q];let K;if(J.isInterleavedBufferAttribute){const re=_(i.data,J.data);K=new ja(re,J.itemSize,J.offset,J.normalized)}else{const re=qo(J.type,J.array);K=new(J.isInstancedBufferAttribute?La:pn)(re,J.itemSize,J.normalized)}J.name!==void 0&&(K.name=J.name),J.usage!==void 0&&K.setUsage(J.usage),J.updateRange!==void 0&&(K.updateRange.offset=J.updateRange.offset,K.updateRange.count=J.updateRange.count),w.setAttribute(q,K)}const z=i.data.morphAttributes;if(z)for(const q in z){const J=z[q],K=[];for(let re=0,ce=J.length;re<ce;re++){const Me=J[re];let de;if(Me.isInterleavedBufferAttribute){const Xe=_(i.data,Me.data);de=new ja(Xe,Me.itemSize,Me.offset,Me.normalized)}else{const Xe=qo(Me.type,Me.array);de=new pn(Xe,Me.itemSize,Me.normalized)}Me.name!==void 0&&(de.name=Me.name),K.push(de)}w.morphAttributes[q]=K}i.data.morphTargetsRelative&&(w.morphTargetsRelative=!0);const F=i.data.groups||i.data.drawcalls||i.data.offsets;if(F!==void 0)for(let q=0,J=F.length;q!==J;++q){const K=F[q];w.addGroup(K.start,K.count,K.materialIndex)}const W=i.data.boundingSphere;if(W!==void 0){const q=new et;W.center!==void 0&&q.fromArray(W.center),w.boundingSphere=new Bn(q,W.radius)}return i.name&&(w.name=i.name),i.userData&&(w.userData=i.userData),w}}const $_={UVMapping:300,CubeReflectionMapping:301,CubeRefractionMapping:302,EquirectangularReflectionMapping:303,EquirectangularRefractionMapping:304,CubeUVReflectionMapping:306,CubeUVRefractionMapping:307},wm={RepeatWrapping:1e3,ClampToEdgeWrapping:1001,MirroredRepeatWrapping:1002},Kp={NearestFilter:1003,NearestMipmapNearestFilter:1004,NearestMipmapLinearFilter:1005,LinearFilter:1006,LinearMipmapNearestFilter:1007,LinearMipmapLinearFilter:1008};class Wc extends Vo{constructor(i){super(i),typeof createImageBitmap>"u"&&console.warn("THREE.ImageBitmapLoader: createImageBitmap() not supported."),typeof fetch>"u"&&console.warn("THREE.ImageBitmapLoader: fetch() not supported."),this.options={premultiplyAlpha:"none"}}setOptions(i){return this.options=i,this}load(i,c,g,_){i===void 0&&(i=""),this.path!==void 0&&(i=this.path+i),i=this.manager.resolveURL(i);const w=this,A=pl.get(i);if(A!==void 0)return w.manager.itemStart(i),setTimeout(function(){c&&c(A),w.manager.itemEnd(i)},0),A;const R={};R.credentials=this.crossOrigin==="anonymous"?"same-origin":"include",R.headers=this.requestHeader,fetch(i,R).then(function(z){return z.blob()}).then(function(z){return createImageBitmap(z,Object.assign(w.options,{colorSpaceConversion:"none"}))}).then(function(z){pl.add(i,z),c&&c(z),w.manager.itemEnd(i)}).catch(function(z){_&&_(z),w.manager.itemError(i),w.manager.itemEnd(i)}),w.manager.itemStart(i)}}Wc.prototype.isImageBitmapLoader=!0;class Qp{constructor(){this.type="ShapePath",this.color=new un,this.subPaths=[],this.currentPath=null}moveTo(i,c){return this.currentPath=new Hc,this.subPaths.push(this.currentPath),this.currentPath.moveTo(i,c),this}lineTo(i,c){return this.currentPath.lineTo(i,c),this}quadraticCurveTo(i,c,g,_){return this.currentPath.quadraticCurveTo(i,c,g,_),this}bezierCurveTo(i,c,g,_,w,A){return this.currentPath.bezierCurveTo(i,c,g,_,w,A),this}splineThru(i){return this.currentPath.splineThru(i),this}toShapes(i,c){function g(Xe){const nt=[];for(let Je=0,gt=Xe.length;Je<gt;Je++){const Tt=Xe[Je],Zt=new jc;Zt.curves=Tt.curves,nt.push(Zt)}return nt}function _(Xe,nt){const Je=nt.length;let gt=!1;for(let Tt=Je-1,Zt=0;Zt<Je;Tt=Zt++){let ei=nt[Tt],vi=nt[Zt],Xt=vi.x-ei.x,xi=vi.y-ei.y;if(Math.abs(xi)>Number.EPSILON){if(xi<0&&(ei=nt[Zt],Xt=-Xt,vi=nt[Tt],xi=-xi),Xe.y<ei.y||Xe.y>vi.y)continue;if(Xe.y===ei.y){if(Xe.x===ei.x)return!0}else{const In=xi*(Xe.x-ei.x)-Xt*(Xe.y-ei.y);if(In===0)return!0;if(In<0)continue;gt=!gt}}else{if(Xe.y!==ei.y)continue;if(vi.x<=Xe.x&&Xe.x<=ei.x||ei.x<=Xe.x&&Xe.x<=vi.x)return!0}}return gt}const w=Ur.isClockWise,A=this.subPaths;if(A.length===0)return[];if(c===!0)return g(A);let R,z,F;const W=[];if(A.length===1)return z=A[0],F=new jc,F.curves=z.curves,W.push(F),W;let q=!w(A[0].getPoints());q=i?!q:q;const J=[],K=[];let re,ce,Me=[],de=0;K[de]=void 0,Me[de]=[];for(let Xe=0,nt=A.length;Xe<nt;Xe++)z=A[Xe],re=z.getPoints(),R=w(re),R=i?!R:R,R?(!q&&K[de]&&de++,K[de]={s:new jc,p:re},K[de].s.curves=z.curves,q&&de++,Me[de]=[]):Me[de].push({h:z,p:re[0]});if(!K[0])return g(A);if(K.length>1){let Xe=!1;const nt=[];for(let Je=0,gt=K.length;Je<gt;Je++)J[Je]=[];for(let Je=0,gt=K.length;Je<gt;Je++){const Tt=Me[Je];for(let Zt=0;Zt<Tt.length;Zt++){const ei=Tt[Zt];let vi=!0;for(let Xt=0;Xt<K.length;Xt++)_(ei.p,K[Xt].p)&&(Je!==Xt&&nt.push({froms:Je,tos:Xt,hole:Zt}),vi?(vi=!1,J[Xt].push(ei)):Xe=!0);vi&&J[Je].push(ei)}}nt.length>0&&(Xe||(Me=J))}for(let Xe=0,nt=K.length;Xe<nt;Xe++){F=K[Xe].s,W.push(F),ce=Me[Xe];for(let Je=0,gt=ce.length;Je<gt;Je++)F.holes.push(ce[Je].h)}return W}}class Jo{constructor(i){this.type="Font",this.data=i}generateShapes(i,c=100){const g=[],_=function(w,A,R){const z=Array.from(w),F=A/R.resolution,W=(R.boundingBox.yMax-R.boundingBox.yMin+R.underlineThickness)*F,q=[];let J=0,K=0;for(let re=0;re<z.length;re++){const ce=z[re];if(ce===`
`)J=0,K-=W;else{const Me=Lh(ce,F,J,K,R);J+=Me.offsetX,q.push(Me.path)}}return q}(i,c,this.data);for(let w=0,A=_.length;w<A;w++)Array.prototype.push.apply(g,_[w].toShapes());return g}}function Lh(M,i,c,g,_){const w=_.glyphs[M]||_.glyphs["?"];if(!w)return void console.error('THREE.Font: character "'+M+'" does not exists in font family '+_.familyName+".");const A=new Qp;let R,z,F,W,q,J,K,re;if(w.o){const ce=w._cachedOutline||(w._cachedOutline=w.o.split(" "));for(let Me=0,de=ce.length;Me<de;)switch(ce[Me++]){case"m":R=ce[Me++]*i+c,z=ce[Me++]*i+g,A.moveTo(R,z);break;case"l":R=ce[Me++]*i+c,z=ce[Me++]*i+g,A.lineTo(R,z);break;case"q":F=ce[Me++]*i+c,W=ce[Me++]*i+g,q=ce[Me++]*i+c,J=ce[Me++]*i+g,A.quadraticCurveTo(q,J,F,W);break;case"b":F=ce[Me++]*i+c,W=ce[Me++]*i+g,q=ce[Me++]*i+c,J=ce[Me++]*i+g,K=ce[Me++]*i+c,re=ce[Me++]*i+g,A.bezierCurveTo(q,J,K,re,F,W)}}return{offsetX:w.ha*i,path:A}}Jo.prototype.isFont=!0;let Kd;const ef={getContext:function(){return Kd===void 0&&(Kd=new(window.AudioContext||window.webkitAudioContext)),Kd},setContext:function(M){Kd=M}};class Cg extends Vo{constructor(i){super(i)}load(i,c,g,_){const w=this,A=new ml(this.manager);A.setResponseType("arraybuffer"),A.setPath(this.path),A.setRequestHeader(this.requestHeader),A.setWithCredentials(this.withCredentials),A.load(i,function(R){try{const z=R.slice(0);ef.getContext().decodeAudioData(z,function(F){c(F)})}catch(z){_?_(z):console.error(z),w.manager.itemError(i)}},g,_)}}class Y_ extends Ts{constructor(i,c,g=1){super(void 0,g);const _=new un().set(i),w=new un().set(c),A=new et(_.r,_.g,_.b),R=new et(w.r,w.g,w.b),z=Math.sqrt(Math.PI),F=z*Math.sqrt(.75);this.sh.coefficients[0].copy(A).add(R).multiplyScalar(z),this.sh.coefficients[1].copy(A).sub(R).multiplyScalar(F)}}Y_.prototype.isHemisphereLightProbe=!0;class Qd extends Ts{constructor(i,c=1){super(void 0,c);const g=new un().set(i);this.sh.coefficients[0].set(g.r,g.g,g.b).multiplyScalar(2*Math.sqrt(Math.PI))}}Qd.prototype.isAmbientLightProbe=!0;const J_=new Mn,K_=new Mn;class Mm{constructor(i=!0){this.autoStart=i,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=Tm(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let i=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const c=Tm();i=(c-this.oldTime)/1e3,this.oldTime=c,this.elapsedTime+=i}return i}}function Tm(){return(typeof performance>"u"?Date:performance).now()}const pc=new et,ad=new Rs,Ih=new et,ra=new et;class qc extends we{constructor(i){super(),this.type="Audio",this.listener=i,this.context=i.context,this.gain=this.context.createGain(),this.gain.connect(i.getInput()),this.autoplay=!1,this.buffer=null,this.detune=0,this.loop=!1,this.loopStart=0,this.loopEnd=0,this.offset=0,this.duration=void 0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.source=null,this.sourceType="empty",this._startedAt=0,this._progress=0,this._connected=!1,this.filters=[]}getOutput(){return this.gain}setNodeSource(i){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=i,this.connect(),this}setMediaElementSource(i){return this.hasPlaybackControl=!1,this.sourceType="mediaNode",this.source=this.context.createMediaElementSource(i),this.connect(),this}setMediaStreamSource(i){return this.hasPlaybackControl=!1,this.sourceType="mediaStreamNode",this.source=this.context.createMediaStreamSource(i),this.connect(),this}setBuffer(i){return this.buffer=i,this.sourceType="buffer",this.autoplay&&this.play(),this}play(i=0){if(this.isPlaying===!0)return void console.warn("THREE.Audio: Audio is already playing.");if(this.hasPlaybackControl===!1)return void console.warn("THREE.Audio: this Audio has no playback control.");this._startedAt=this.context.currentTime+i;const c=this.context.createBufferSource();return c.buffer=this.buffer,c.loop=this.loop,c.loopStart=this.loopStart,c.loopEnd=this.loopEnd,c.onended=this.onEnded.bind(this),c.start(this._startedAt,this._progress+this.offset,this.duration),this.isPlaying=!0,this.source=c,this.setDetune(this.detune),this.setPlaybackRate(this.playbackRate),this.connect()}pause(){if(this.hasPlaybackControl!==!1)return this.isPlaying===!0&&(this._progress+=Math.max(this.context.currentTime-this._startedAt,0)*this.playbackRate,this.loop===!0&&(this._progress=this._progress%(this.duration||this.buffer.duration)),this.source.stop(),this.source.onended=null,this.isPlaying=!1),this;console.warn("THREE.Audio: this Audio has no playback control.")}stop(){if(this.hasPlaybackControl!==!1)return this._progress=0,this.source.stop(),this.source.onended=null,this.isPlaying=!1,this;console.warn("THREE.Audio: this Audio has no playback control.")}connect(){if(this.filters.length>0){this.source.connect(this.filters[0]);for(let i=1,c=this.filters.length;i<c;i++)this.filters[i-1].connect(this.filters[i]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this._connected=!0,this}disconnect(){if(this.filters.length>0){this.source.disconnect(this.filters[0]);for(let i=1,c=this.filters.length;i<c;i++)this.filters[i-1].disconnect(this.filters[i]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this._connected=!1,this}getFilters(){return this.filters}setFilters(i){return i||(i=[]),this._connected===!0?(this.disconnect(),this.filters=i.slice(),this.connect()):this.filters=i.slice(),this}setDetune(i){if(this.detune=i,this.source.detune!==void 0)return this.isPlaying===!0&&this.source.detune.setTargetAtTime(this.detune,this.context.currentTime,.01),this}getDetune(){return this.detune}getFilter(){return this.getFilters()[0]}setFilter(i){return this.setFilters(i?[i]:[])}setPlaybackRate(i){if(this.hasPlaybackControl!==!1)return this.playbackRate=i,this.isPlaying===!0&&this.source.playbackRate.setTargetAtTime(this.playbackRate,this.context.currentTime,.01),this;console.warn("THREE.Audio: this Audio has no playback control.")}getPlaybackRate(){return this.playbackRate}onEnded(){this.isPlaying=!1}getLoop(){return this.hasPlaybackControl===!1?(console.warn("THREE.Audio: this Audio has no playback control."),!1):this.loop}setLoop(i){if(this.hasPlaybackControl!==!1)return this.loop=i,this.isPlaying===!0&&(this.source.loop=this.loop),this;console.warn("THREE.Audio: this Audio has no playback control.")}setLoopStart(i){return this.loopStart=i,this}setLoopEnd(i){return this.loopEnd=i,this}getVolume(){return this.gain.gain.value}setVolume(i){return this.gain.gain.setTargetAtTime(i,this.context.currentTime,.01),this}}const gl=new et,Ph=new Rs,W0=new et,ld=new et;class Q_{constructor(i,c=2048){this.analyser=i.context.createAnalyser(),this.analyser.fftSize=c,this.data=new Uint8Array(this.analyser.frequencyBinCount),i.getOutput().connect(this.analyser)}getFrequencyData(){return this.analyser.getByteFrequencyData(this.data),this.data}getAverageFrequency(){let i=0;const c=this.getFrequencyData();for(let g=0;g<c.length;g++)i+=c[g];return i/c.length}}class ey{constructor(i,c,g){let _,w,A;switch(this.binding=i,this.valueSize=g,c){case"quaternion":_=this._slerp,w=this._slerpAdditive,A=this._setAdditiveIdentityQuaternion,this.buffer=new Float64Array(6*g),this._workIndex=5;break;case"string":case"bool":_=this._select,w=this._select,A=this._setAdditiveIdentityOther,this.buffer=new Array(5*g);break;default:_=this._lerp,w=this._lerpAdditive,A=this._setAdditiveIdentityNumeric,this.buffer=new Float64Array(5*g)}this._mixBufferRegion=_,this._mixBufferRegionAdditive=w,this._setIdentity=A,this._origIndex=3,this._addIndex=4,this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,this.useCount=0,this.referenceCount=0}accumulate(i,c){const g=this.buffer,_=this.valueSize,w=i*_+_;let A=this.cumulativeWeight;if(A===0){for(let R=0;R!==_;++R)g[w+R]=g[R];A=c}else{A+=c;const R=c/A;this._mixBufferRegion(g,w,0,R,_)}this.cumulativeWeight=A}accumulateAdditive(i){const c=this.buffer,g=this.valueSize,_=g*this._addIndex;this.cumulativeWeightAdditive===0&&this._setIdentity(),this._mixBufferRegionAdditive(c,_,0,i,g),this.cumulativeWeightAdditive+=i}apply(i){const c=this.valueSize,g=this.buffer,_=i*c+c,w=this.cumulativeWeight,A=this.cumulativeWeightAdditive,R=this.binding;if(this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,w<1){const z=c*this._origIndex;this._mixBufferRegion(g,_,z,1-w,c)}A>0&&this._mixBufferRegionAdditive(g,_,this._addIndex*c,1,c);for(let z=c,F=c+c;z!==F;++z)if(g[z]!==g[z+c]){R.setValue(g,_);break}}saveOriginalState(){const i=this.binding,c=this.buffer,g=this.valueSize,_=g*this._origIndex;i.getValue(c,_);for(let w=g,A=_;w!==A;++w)c[w]=c[_+w%g];this._setIdentity(),this.cumulativeWeight=0,this.cumulativeWeightAdditive=0}restoreOriginalState(){const i=3*this.valueSize;this.binding.setValue(this.buffer,i)}_setAdditiveIdentityNumeric(){const i=this._addIndex*this.valueSize,c=i+this.valueSize;for(let g=i;g<c;g++)this.buffer[g]=0}_setAdditiveIdentityQuaternion(){this._setAdditiveIdentityNumeric(),this.buffer[this._addIndex*this.valueSize+3]=1}_setAdditiveIdentityOther(){const i=this._origIndex*this.valueSize,c=this._addIndex*this.valueSize;for(let g=0;g<this.valueSize;g++)this.buffer[c+g]=this.buffer[i+g]}_select(i,c,g,_,w){if(_>=.5)for(let A=0;A!==w;++A)i[c+A]=i[g+A]}_slerp(i,c,g,_){Rs.slerpFlat(i,c,i,c,i,g,_)}_slerpAdditive(i,c,g,_,w){const A=this._workIndex*w;Rs.multiplyQuaternionsFlat(i,A,i,c,i,g),Rs.slerpFlat(i,c,i,c,i,A,_)}_lerp(i,c,g,_,w){const A=1-_;for(let R=0;R!==w;++R){const z=c+R;i[z]=i[z]*A+i[g+R]*_}}_lerpAdditive(i,c,g,_,w){for(let A=0;A!==w;++A){const R=c+A;i[R]=i[R]+i[g+A]*_}}}const ty="\\[\\]\\.:\\/",_a=new RegExp("[\\[\\]\\.:\\/]","g"),tf="[^\\[\\]\\.:\\/]",iy="[^"+ty.replace("\\.","")+"]",q0=/((?:WC+[\/:])*)/.source.replace("WC",tf),ep=/(WCOD+)?/.source.replace("WCOD",iy),Lg=/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",tf),Bl=/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",tf),Nl=new RegExp("^"+q0+ep+Lg+Bl+"$"),tp=["material","materials","bones"];class us{constructor(i,c,g){this.path=c,this.parsedPath=g||us.parseTrackName(c),this.node=us.findNode(i,this.parsedPath.nodeName)||i,this.rootNode=i,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}static create(i,c,g){return i&&i.isAnimationObjectGroup?new us.Composite(i,c,g):new us(i,c,g)}static sanitizeNodeName(i){return i.replace(/\s/g,"_").replace(_a,"")}static parseTrackName(i){const c=Nl.exec(i);if(!c)throw new Error("PropertyBinding: Cannot parse trackName: "+i);const g={nodeName:c[2],objectName:c[3],objectIndex:c[4],propertyName:c[5],propertyIndex:c[6]},_=g.nodeName&&g.nodeName.lastIndexOf(".");if(_!==void 0&&_!==-1){const w=g.nodeName.substring(_+1);tp.indexOf(w)!==-1&&(g.nodeName=g.nodeName.substring(0,_),g.objectName=w)}if(g.propertyName===null||g.propertyName.length===0)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+i);return g}static findNode(i,c){if(!c||c===""||c==="."||c===-1||c===i.name||c===i.uuid)return i;if(i.skeleton){const g=i.skeleton.getBoneByName(c);if(g!==void 0)return g}if(i.children){const g=function(w){for(let A=0;A<w.length;A++){const R=w[A];if(R.name===c||R.uuid===c)return R;const z=g(R.children);if(z)return z}return null},_=g(i.children);if(_)return _}return null}_getValue_unavailable(){}_setValue_unavailable(){}_getValue_direct(i,c){i[c]=this.targetObject[this.propertyName]}_getValue_array(i,c){const g=this.resolvedProperty;for(let _=0,w=g.length;_!==w;++_)i[c++]=g[_]}_getValue_arrayElement(i,c){i[c]=this.resolvedProperty[this.propertyIndex]}_getValue_toArray(i,c){this.resolvedProperty.toArray(i,c)}_setValue_direct(i,c){this.targetObject[this.propertyName]=i[c]}_setValue_direct_setNeedsUpdate(i,c){this.targetObject[this.propertyName]=i[c],this.targetObject.needsUpdate=!0}_setValue_direct_setMatrixWorldNeedsUpdate(i,c){this.targetObject[this.propertyName]=i[c],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_array(i,c){const g=this.resolvedProperty;for(let _=0,w=g.length;_!==w;++_)g[_]=i[c++]}_setValue_array_setNeedsUpdate(i,c){const g=this.resolvedProperty;for(let _=0,w=g.length;_!==w;++_)g[_]=i[c++];this.targetObject.needsUpdate=!0}_setValue_array_setMatrixWorldNeedsUpdate(i,c){const g=this.resolvedProperty;for(let _=0,w=g.length;_!==w;++_)g[_]=i[c++];this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_arrayElement(i,c){this.resolvedProperty[this.propertyIndex]=i[c]}_setValue_arrayElement_setNeedsUpdate(i,c){this.resolvedProperty[this.propertyIndex]=i[c],this.targetObject.needsUpdate=!0}_setValue_arrayElement_setMatrixWorldNeedsUpdate(i,c){this.resolvedProperty[this.propertyIndex]=i[c],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_fromArray(i,c){this.resolvedProperty.fromArray(i,c)}_setValue_fromArray_setNeedsUpdate(i,c){this.resolvedProperty.fromArray(i,c),this.targetObject.needsUpdate=!0}_setValue_fromArray_setMatrixWorldNeedsUpdate(i,c){this.resolvedProperty.fromArray(i,c),this.targetObject.matrixWorldNeedsUpdate=!0}_getValue_unbound(i,c){this.bind(),this.getValue(i,c)}_setValue_unbound(i,c){this.bind(),this.setValue(i,c)}bind(){let i=this.node;const c=this.parsedPath,g=c.objectName,_=c.propertyName;let w=c.propertyIndex;if(i||(i=us.findNode(this.rootNode,c.nodeName)||this.rootNode,this.node=i),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!i)return void console.error("THREE.PropertyBinding: Trying to update node for track: "+this.path+" but it wasn't found.");if(g){let F=c.objectIndex;switch(g){case"materials":if(!i.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!i.material.materials)return void console.error("THREE.PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);i=i.material.materials;break;case"bones":if(!i.skeleton)return void console.error("THREE.PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);i=i.skeleton.bones;for(let W=0;W<i.length;W++)if(i[W].name===F){F=W;break}break;default:if(i[g]===void 0)return void console.error("THREE.PropertyBinding: Can not bind to objectName of node undefined.",this);i=i[g]}if(F!==void 0){if(i[F]===void 0)return void console.error("THREE.PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,i);i=i[F]}}const A=i[_];if(A===void 0){const F=c.nodeName;return void console.error("THREE.PropertyBinding: Trying to update property for track: "+F+"."+_+" but it wasn't found.",i)}let R=this.Versioning.None;this.targetObject=i,i.needsUpdate!==void 0?R=this.Versioning.NeedsUpdate:i.matrixWorldNeedsUpdate!==void 0&&(R=this.Versioning.MatrixWorldNeedsUpdate);let z=this.BindingType.Direct;if(w!==void 0){if(_==="morphTargetInfluences"){if(!i.geometry)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);if(!i.geometry.isBufferGeometry)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences on THREE.Geometry. Use THREE.BufferGeometry instead.",this);if(!i.geometry.morphAttributes)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);i.morphTargetDictionary[w]!==void 0&&(w=i.morphTargetDictionary[w])}z=this.BindingType.ArrayElement,this.resolvedProperty=A,this.propertyIndex=w}else A.fromArray!==void 0&&A.toArray!==void 0?(z=this.BindingType.HasFromToArray,this.resolvedProperty=A):Array.isArray(A)?(z=this.BindingType.EntireArray,this.resolvedProperty=A):this.propertyName=_;this.getValue=this.GetterByBindingType[z],this.setValue=this.SetterByBindingTypeAndVersioning[z][R]}unbind(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}us.Composite=class{constructor(M,i,c){const g=c||us.parseTrackName(i);this._targetGroup=M,this._bindings=M.subscribe_(i,g)}getValue(M,i){this.bind();const c=this._targetGroup.nCachedObjects_,g=this._bindings[c];g!==void 0&&g.getValue(M,i)}setValue(M,i){const c=this._bindings;for(let g=this._targetGroup.nCachedObjects_,_=c.length;g!==_;++g)c[g].setValue(M,i)}bind(){const M=this._bindings;for(let i=this._targetGroup.nCachedObjects_,c=M.length;i!==c;++i)M[i].bind()}unbind(){const M=this._bindings;for(let i=this._targetGroup.nCachedObjects_,c=M.length;i!==c;++i)M[i].unbind()}},us.prototype.BindingType={Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},us.prototype.Versioning={None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},us.prototype.GetterByBindingType=[us.prototype._getValue_direct,us.prototype._getValue_array,us.prototype._getValue_arrayElement,us.prototype._getValue_toArray],us.prototype.SetterByBindingTypeAndVersioning=[[us.prototype._setValue_direct,us.prototype._setValue_direct_setNeedsUpdate,us.prototype._setValue_direct_setMatrixWorldNeedsUpdate],[us.prototype._setValue_array,us.prototype._setValue_array_setNeedsUpdate,us.prototype._setValue_array_setMatrixWorldNeedsUpdate],[us.prototype._setValue_arrayElement,us.prototype._setValue_arrayElement_setNeedsUpdate,us.prototype._setValue_arrayElement_setMatrixWorldNeedsUpdate],[us.prototype._setValue_fromArray,us.prototype._setValue_fromArray_setNeedsUpdate,us.prototype._setValue_fromArray_setMatrixWorldNeedsUpdate]];class cd{constructor(){this.uuid=Yn(),this._objects=Array.prototype.slice.call(arguments),this.nCachedObjects_=0;const i={};this._indicesByUUID=i;for(let g=0,_=arguments.length;g!==_;++g)i[arguments[g].uuid]=g;this._paths=[],this._parsedPaths=[],this._bindings=[],this._bindingsIndicesByPath={};const c=this;this.stats={objects:{get total(){return c._objects.length},get inUse(){return this.total-c.nCachedObjects_}},get bindingsPerObject(){return c._bindings.length}}}add(){const i=this._objects,c=this._indicesByUUID,g=this._paths,_=this._parsedPaths,w=this._bindings,A=w.length;let R,z=i.length,F=this.nCachedObjects_;for(let W=0,q=arguments.length;W!==q;++W){const J=arguments[W],K=J.uuid;let re=c[K];if(re===void 0){re=z++,c[K]=re,i.push(J);for(let ce=0,Me=A;ce!==Me;++ce)w[ce].push(new us(J,g[ce],_[ce]))}else if(re<F){R=i[re];const ce=--F,Me=i[ce];c[Me.uuid]=re,i[re]=Me,c[K]=ce,i[ce]=J;for(let de=0,Xe=A;de!==Xe;++de){const nt=w[de],Je=nt[ce];let gt=nt[re];nt[re]=Je,gt===void 0&&(gt=new us(J,g[de],_[de])),nt[ce]=gt}}else i[re]!==R&&console.error("THREE.AnimationObjectGroup: Different objects with the same UUID detected. Clean the caches or recreate your infrastructure when reloading scenes.")}this.nCachedObjects_=F}remove(){const i=this._objects,c=this._indicesByUUID,g=this._bindings,_=g.length;let w=this.nCachedObjects_;for(let A=0,R=arguments.length;A!==R;++A){const z=arguments[A],F=z.uuid,W=c[F];if(W!==void 0&&W>=w){const q=w++,J=i[q];c[J.uuid]=W,i[W]=J,c[F]=q,i[q]=z;for(let K=0,re=_;K!==re;++K){const ce=g[K],Me=ce[q],de=ce[W];ce[W]=Me,ce[q]=de}}}this.nCachedObjects_=w}uncache(){const i=this._objects,c=this._indicesByUUID,g=this._bindings,_=g.length;let w=this.nCachedObjects_,A=i.length;for(let R=0,z=arguments.length;R!==z;++R){const F=arguments[R].uuid,W=c[F];if(W!==void 0)if(delete c[F],W<w){const q=--w,J=i[q],K=--A,re=i[K];c[J.uuid]=W,i[W]=J,c[re.uuid]=q,i[q]=re,i.pop();for(let ce=0,Me=_;ce!==Me;++ce){const de=g[ce],Xe=de[q],nt=de[K];de[W]=Xe,de[q]=nt,de.pop()}}else{const q=--A,J=i[q];q>0&&(c[J.uuid]=W),i[W]=J,i.pop();for(let K=0,re=_;K!==re;++K){const ce=g[K];ce[W]=ce[q],ce.pop()}}}this.nCachedObjects_=w}subscribe_(i,c){const g=this._bindingsIndicesByPath;let _=g[i];const w=this._bindings;if(_!==void 0)return w[_];const A=this._paths,R=this._parsedPaths,z=this._objects,F=z.length,W=this.nCachedObjects_,q=new Array(F);_=w.length,g[i]=_,A.push(i),R.push(c),w.push(q);for(let J=W,K=z.length;J!==K;++J){const re=z[J];q[J]=new us(re,i,c)}return q}unsubscribe_(i){const c=this._bindingsIndicesByPath,g=c[i];if(g!==void 0){const _=this._paths,w=this._parsedPaths,A=this._bindings,R=A.length-1,z=A[R];c[i[R]]=g,A[g]=z,A.pop(),w[g]=w[R],w.pop(),_[g]=_[R],_.pop()}}}cd.prototype.isAnimationObjectGroup=!0;class Ig{constructor(i,c,g=null,_=c.blendMode){this._mixer=i,this._clip=c,this._localRoot=g,this.blendMode=_;const w=c.tracks,A=w.length,R=new Array(A),z={endingStart:2400,endingEnd:2400};for(let F=0;F!==A;++F){const W=w[F].createInterpolant(null);R[F]=W,W.settings=z}this._interpolantSettings=z,this._interpolants=R,this._propertyBindings=new Array(A),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=2201,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}play(){return this._mixer._activateAction(this),this}stop(){return this._mixer._deactivateAction(this),this.reset()}reset(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()}isRunning(){return this.enabled&&!this.paused&&this.timeScale!==0&&this._startTime===null&&this._mixer._isActiveAction(this)}isScheduled(){return this._mixer._isActiveAction(this)}startAt(i){return this._startTime=i,this}setLoop(i,c){return this.loop=i,this.repetitions=c,this}setEffectiveWeight(i){return this.weight=i,this._effectiveWeight=this.enabled?i:0,this.stopFading()}getEffectiveWeight(){return this._effectiveWeight}fadeIn(i){return this._scheduleFading(i,0,1)}fadeOut(i){return this._scheduleFading(i,1,0)}crossFadeFrom(i,c,g){if(i.fadeOut(c),this.fadeIn(c),g){const _=this._clip.duration,w=i._clip.duration,A=w/_,R=_/w;i.warp(1,A,c),this.warp(R,1,c)}return this}crossFadeTo(i,c,g){return i.crossFadeFrom(this,c,g)}stopFading(){const i=this._weightInterpolant;return i!==null&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(i)),this}setEffectiveTimeScale(i){return this.timeScale=i,this._effectiveTimeScale=this.paused?0:i,this.stopWarping()}getEffectiveTimeScale(){return this._effectiveTimeScale}setDuration(i){return this.timeScale=this._clip.duration/i,this.stopWarping()}syncWith(i){return this.time=i.time,this.timeScale=i.timeScale,this.stopWarping()}halt(i){return this.warp(this._effectiveTimeScale,0,i)}warp(i,c,g){const _=this._mixer,w=_.time,A=this.timeScale;let R=this._timeScaleInterpolant;R===null&&(R=_._lendControlInterpolant(),this._timeScaleInterpolant=R);const z=R.parameterPositions,F=R.sampleValues;return z[0]=w,z[1]=w+g,F[0]=i/A,F[1]=c/A,this}stopWarping(){const i=this._timeScaleInterpolant;return i!==null&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(i)),this}getMixer(){return this._mixer}getClip(){return this._clip}getRoot(){return this._localRoot||this._mixer._root}_update(i,c,g,_){if(!this.enabled)return void this._updateWeight(i);const w=this._startTime;if(w!==null){const z=(i-w)*g;if(z<0||g===0)return;this._startTime=null,c=g*z}c*=this._updateTimeScale(i);const A=this._updateTime(c),R=this._updateWeight(i);if(R>0){const z=this._interpolants,F=this._propertyBindings;switch(this.blendMode){case 2501:for(let W=0,q=z.length;W!==q;++W)z[W].evaluate(A),F[W].accumulateAdditive(R);break;case 2500:default:for(let W=0,q=z.length;W!==q;++W)z[W].evaluate(A),F[W].accumulate(_,R)}}}_updateWeight(i){let c=0;if(this.enabled){c=this.weight;const g=this._weightInterpolant;if(g!==null){const _=g.evaluate(i)[0];c*=_,i>g.parameterPositions[1]&&(this.stopFading(),_===0&&(this.enabled=!1))}}return this._effectiveWeight=c,c}_updateTimeScale(i){let c=0;if(!this.paused){c=this.timeScale;const g=this._timeScaleInterpolant;g!==null&&(c*=g.evaluate(i)[0],i>g.parameterPositions[1]&&(this.stopWarping(),c===0?this.paused=!0:this.timeScale=c))}return this._effectiveTimeScale=c,c}_updateTime(i){const c=this._clip.duration,g=this.loop;let _=this.time+i,w=this._loopCount;const A=g===2202;if(i===0)return w===-1?_:A&&(1&w)==1?c-_:_;if(g===2200){w===-1&&(this._loopCount=0,this._setEndings(!0,!0,!1));e:{if(_>=c)_=c;else{if(!(_<0)){this.time=_;break e}_=0}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this.time=_,this._mixer.dispatchEvent({type:"finished",action:this,direction:i<0?-1:1})}}else{if(w===-1&&(i>=0?(w=0,this._setEndings(!0,this.repetitions===0,A)):this._setEndings(this.repetitions===0,!0,A)),_>=c||_<0){const R=Math.floor(_/c);_-=c*R,w+=Math.abs(R);const z=this.repetitions-w;if(z<=0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,_=i>0?c:0,this.time=_,this._mixer.dispatchEvent({type:"finished",action:this,direction:i>0?1:-1});else{if(z===1){const F=i<0;this._setEndings(F,!F,A)}else this._setEndings(!1,!1,A);this._loopCount=w,this.time=_,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:R})}}else this.time=_;if(A&&(1&w)==1)return c-_}return _}_setEndings(i,c,g){const _=this._interpolantSettings;g?(_.endingStart=2401,_.endingEnd=2401):(_.endingStart=i?this.zeroSlopeAtStart?2401:2400:2402,_.endingEnd=c?this.zeroSlopeAtEnd?2401:2400:2402)}_scheduleFading(i,c,g){const _=this._mixer,w=_.time;let A=this._weightInterpolant;A===null&&(A=_._lendControlInterpolant(),this._weightInterpolant=A);const R=A.parameterPositions,z=A.sampleValues;return R[0]=w,z[0]=c,R[1]=w+i,z[1]=g,this}}class Gr extends si{constructor(i){super(),this._root=i,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}_bindAction(i,c){const g=i._localRoot||this._root,_=i._clip.tracks,w=_.length,A=i._propertyBindings,R=i._interpolants,z=g.uuid,F=this._bindingsByRootAndName;let W=F[z];W===void 0&&(W={},F[z]=W);for(let q=0;q!==w;++q){const J=_[q],K=J.name;let re=W[K];if(re!==void 0)A[q]=re;else{if(re=A[q],re!==void 0){re._cacheIndex===null&&(++re.referenceCount,this._addInactiveBinding(re,z,K));continue}const ce=c&&c._propertyBindings[q].binding.parsedPath;re=new ey(us.create(g,K,ce),J.ValueTypeName,J.getValueSize()),++re.referenceCount,this._addInactiveBinding(re,z,K),A[q]=re}R[q].resultBuffer=re.buffer}}_activateAction(i){if(!this._isActiveAction(i)){if(i._cacheIndex===null){const g=(i._localRoot||this._root).uuid,_=i._clip.uuid,w=this._actionsByClip[_];this._bindAction(i,w&&w.knownActions[0]),this._addInactiveAction(i,_,g)}const c=i._propertyBindings;for(let g=0,_=c.length;g!==_;++g){const w=c[g];w.useCount++==0&&(this._lendBinding(w),w.saveOriginalState())}this._lendAction(i)}}_deactivateAction(i){if(this._isActiveAction(i)){const c=i._propertyBindings;for(let g=0,_=c.length;g!==_;++g){const w=c[g];--w.useCount==0&&(w.restoreOriginalState(),this._takeBackBinding(w))}this._takeBackAction(i)}}_initMemoryManager(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;const i=this;this.stats={actions:{get total(){return i._actions.length},get inUse(){return i._nActiveActions}},bindings:{get total(){return i._bindings.length},get inUse(){return i._nActiveBindings}},controlInterpolants:{get total(){return i._controlInterpolants.length},get inUse(){return i._nActiveControlInterpolants}}}}_isActiveAction(i){const c=i._cacheIndex;return c!==null&&c<this._nActiveActions}_addInactiveAction(i,c,g){const _=this._actions,w=this._actionsByClip;let A=w[c];if(A===void 0)A={knownActions:[i],actionByRoot:{}},i._byClipCacheIndex=0,w[c]=A;else{const R=A.knownActions;i._byClipCacheIndex=R.length,R.push(i)}i._cacheIndex=_.length,_.push(i),A.actionByRoot[g]=i}_removeInactiveAction(i){const c=this._actions,g=c[c.length-1],_=i._cacheIndex;g._cacheIndex=_,c[_]=g,c.pop(),i._cacheIndex=null;const w=i._clip.uuid,A=this._actionsByClip,R=A[w],z=R.knownActions,F=z[z.length-1],W=i._byClipCacheIndex;F._byClipCacheIndex=W,z[W]=F,z.pop(),i._byClipCacheIndex=null,delete R.actionByRoot[(i._localRoot||this._root).uuid],z.length===0&&delete A[w],this._removeInactiveBindingsForAction(i)}_removeInactiveBindingsForAction(i){const c=i._propertyBindings;for(let g=0,_=c.length;g!==_;++g){const w=c[g];--w.referenceCount==0&&this._removeInactiveBinding(w)}}_lendAction(i){const c=this._actions,g=i._cacheIndex,_=this._nActiveActions++,w=c[_];i._cacheIndex=_,c[_]=i,w._cacheIndex=g,c[g]=w}_takeBackAction(i){const c=this._actions,g=i._cacheIndex,_=--this._nActiveActions,w=c[_];i._cacheIndex=_,c[_]=i,w._cacheIndex=g,c[g]=w}_addInactiveBinding(i,c,g){const _=this._bindingsByRootAndName,w=this._bindings;let A=_[c];A===void 0&&(A={},_[c]=A),A[g]=i,i._cacheIndex=w.length,w.push(i)}_removeInactiveBinding(i){const c=this._bindings,g=i.binding,_=g.rootNode.uuid,w=g.path,A=this._bindingsByRootAndName,R=A[_],z=c[c.length-1],F=i._cacheIndex;z._cacheIndex=F,c[F]=z,c.pop(),delete R[w],Object.keys(R).length===0&&delete A[_]}_lendBinding(i){const c=this._bindings,g=i._cacheIndex,_=this._nActiveBindings++,w=c[_];i._cacheIndex=_,c[_]=i,w._cacheIndex=g,c[g]=w}_takeBackBinding(i){const c=this._bindings,g=i._cacheIndex,_=--this._nActiveBindings,w=c[_];i._cacheIndex=_,c[_]=i,w._cacheIndex=g,c[g]=w}_lendControlInterpolant(){const i=this._controlInterpolants,c=this._nActiveControlInterpolants++;let g=i[c];return g===void 0&&(g=new $d(new Float32Array(2),new Float32Array(2),1,this._controlInterpolantsResultBuffer),g.__cacheIndex=c,i[c]=g),g}_takeBackControlInterpolant(i){const c=this._controlInterpolants,g=i.__cacheIndex,_=--this._nActiveControlInterpolants,w=c[_];i.__cacheIndex=_,c[_]=i,w.__cacheIndex=g,c[g]=w}clipAction(i,c,g){const _=c||this._root,w=_.uuid;let A=typeof i=="string"?od.findByName(_,i):i;const R=A!==null?A.uuid:i,z=this._actionsByClip[R];let F=null;if(g===void 0&&(g=A!==null?A.blendMode:2500),z!==void 0){const q=z.actionByRoot[w];if(q!==void 0&&q.blendMode===g)return q;F=z.knownActions[0],A===null&&(A=F._clip)}if(A===null)return null;const W=new Ig(this,A,c,g);return this._bindAction(W,F),this._addInactiveAction(W,R,w),W}existingAction(i,c){const g=c||this._root,_=g.uuid,w=typeof i=="string"?od.findByName(g,i):i,A=w?w.uuid:i,R=this._actionsByClip[A];return R!==void 0&&R.actionByRoot[_]||null}stopAllAction(){const i=this._actions;for(let c=this._nActiveActions-1;c>=0;--c)i[c].stop();return this}update(i){i*=this.timeScale;const c=this._actions,g=this._nActiveActions,_=this.time+=i,w=Math.sign(i),A=this._accuIndex^=1;for(let F=0;F!==g;++F)c[F]._update(_,i,w,A);const R=this._bindings,z=this._nActiveBindings;for(let F=0;F!==z;++F)R[F].apply(A);return this}setTime(i){this.time=0;for(let c=0;c<this._actions.length;c++)this._actions[c].time=0;return this.update(i)}getRoot(){return this._root}uncacheClip(i){const c=this._actions,g=i.uuid,_=this._actionsByClip,w=_[g];if(w!==void 0){const A=w.knownActions;for(let R=0,z=A.length;R!==z;++R){const F=A[R];this._deactivateAction(F);const W=F._cacheIndex,q=c[c.length-1];F._cacheIndex=null,F._byClipCacheIndex=null,q._cacheIndex=W,c[W]=q,c.pop(),this._removeInactiveBindingsForAction(F)}delete _[g]}}uncacheRoot(i){const c=i.uuid,g=this._actionsByClip;for(const w in g){const A=g[w].actionByRoot[c];A!==void 0&&(this._deactivateAction(A),this._removeInactiveAction(A))}const _=this._bindingsByRootAndName[c];if(_!==void 0)for(const w in _){const A=_[w];A.restoreOriginalState(),this._removeInactiveBinding(A)}}uncacheAction(i,c){const g=this.existingAction(i,c);g!==null&&(this._deactivateAction(g),this._removeInactiveAction(g))}}Gr.prototype._controlInterpolantsResultBuffer=new Float32Array(1);class fc{constructor(i){typeof i=="string"&&(console.warn("THREE.Uniform: Type parameter is no longer needed."),i=arguments[1]),this.value=i}clone(){return new fc(this.value.clone===void 0?this.value:this.value.clone())}}class Pg extends Pl{constructor(i,c,g=1){super(i,c),this.meshPerAttribute=g}copy(i){return super.copy(i),this.meshPerAttribute=i.meshPerAttribute,this}clone(i){const c=super.clone(i);return c.meshPerAttribute=this.meshPerAttribute,c}toJSON(i){const c=super.toJSON(i);return c.isInstancedInterleavedBuffer=!0,c.meshPerAttribute=this.meshPerAttribute,c}}Pg.prototype.isInstancedInterleavedBuffer=!0;class ny{constructor(i,c,g,_,w){this.buffer=i,this.type=c,this.itemSize=g,this.elementSize=_,this.count=w,this.version=0}set needsUpdate(i){i===!0&&this.version++}setBuffer(i){return this.buffer=i,this}setType(i,c){return this.type=i,this.elementSize=c,this}setItemSize(i){return this.itemSize=i,this}setCount(i){return this.count=i,this}}ny.prototype.isGLBufferAttribute=!0;function uu(M,i){return M.distance-i.distance}function Sm(M,i,c,g){if(M.layers.test(i.layers)&&M.raycast(i,c),g===!0){const _=M.children;for(let w=0,A=_.length;w<A;w++)Sm(_[w],i,c,!0)}}const lo=new Ri;class Zc{constructor(i=new Ri(1/0,1/0),c=new Ri(-1/0,-1/0)){this.min=i,this.max=c}set(i,c){return this.min.copy(i),this.max.copy(c),this}setFromPoints(i){this.makeEmpty();for(let c=0,g=i.length;c<g;c++)this.expandByPoint(i[c]);return this}setFromCenterAndSize(i,c){const g=lo.copy(c).multiplyScalar(.5);return this.min.copy(i).sub(g),this.max.copy(i).add(g),this}clone(){return new this.constructor().copy(this)}copy(i){return this.min.copy(i.min),this.max.copy(i.max),this}makeEmpty(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y}getCenter(i){return this.isEmpty()?i.set(0,0):i.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(i){return this.isEmpty()?i.set(0,0):i.subVectors(this.max,this.min)}expandByPoint(i){return this.min.min(i),this.max.max(i),this}expandByVector(i){return this.min.sub(i),this.max.add(i),this}expandByScalar(i){return this.min.addScalar(-i),this.max.addScalar(i),this}containsPoint(i){return!(i.x<this.min.x||i.x>this.max.x||i.y<this.min.y||i.y>this.max.y)}containsBox(i){return this.min.x<=i.min.x&&i.max.x<=this.max.x&&this.min.y<=i.min.y&&i.max.y<=this.max.y}getParameter(i,c){return c.set((i.x-this.min.x)/(this.max.x-this.min.x),(i.y-this.min.y)/(this.max.y-this.min.y))}intersectsBox(i){return!(i.max.x<this.min.x||i.min.x>this.max.x||i.max.y<this.min.y||i.min.y>this.max.y)}clampPoint(i,c){return c.copy(i).clamp(this.min,this.max)}distanceToPoint(i){return lo.copy(i).clamp(this.min,this.max).sub(i).length()}intersect(i){return this.min.max(i.min),this.max.min(i.max),this}union(i){return this.min.min(i.min),this.max.max(i.max),this}translate(i){return this.min.add(i),this.max.add(i),this}equals(i){return i.min.equals(this.min)&&i.max.equals(this.max)}}Zc.prototype.isBox2=!0;const ry=new et,Em=new et;class sy{constructor(i=new et,c=new et){this.start=i,this.end=c}set(i,c){return this.start.copy(i),this.end.copy(c),this}copy(i){return this.start.copy(i.start),this.end.copy(i.end),this}getCenter(i){return i.addVectors(this.start,this.end).multiplyScalar(.5)}delta(i){return i.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(i,c){return this.delta(c).multiplyScalar(i).add(this.start)}closestPointToPointParameter(i,c){ry.subVectors(i,this.start),Em.subVectors(this.end,this.start);const g=Em.dot(Em);let _=Em.dot(ry)/g;return c&&(_=Jn(_,0,1)),_}closestPointToPoint(i,c,g){const _=this.closestPointToPointParameter(i,c);return this.delta(g).multiplyScalar(_).add(this.start)}applyMatrix4(i){return this.start.applyMatrix4(i),this.end.applyMatrix4(i),this}equals(i){return i.start.equals(this.start)&&i.end.equals(this.end)}clone(){return new this.constructor().copy(this)}}class Am extends we{constructor(i){super(),this.material=i,this.render=function(){},this.hasPositions=!1,this.hasNormals=!1,this.hasColors=!1,this.hasUvs=!1,this.positionArray=null,this.normalArray=null,this.colorArray=null,this.uvArray=null,this.count=0}}Am.prototype.isImmediateRenderObject=!0;const mc=new et,sa=new et,Go=new Mn,oa=new Mn;class Co extends $o{constructor(i){const c=Rg(i),g=new Er,_=[],w=[],A=new un(0,0,1),R=new un(0,1,0);for(let z=0;z<c.length;z++){const F=c[z];F.parent&&F.parent.isBone&&(_.push(0,0,0),_.push(0,0,0),w.push(A.r,A.g,A.b),w.push(R.r,R.g,R.b))}g.setAttribute("position",new Kn(_,3)),g.setAttribute("color",new Kn(w,3)),super(g,new to({vertexColors:!0,depthTest:!1,depthWrite:!1,toneMapped:!1,transparent:!0})),this.type="SkeletonHelper",this.isSkeletonHelper=!0,this.root=i,this.bones=c,this.matrix=i.matrixWorld,this.matrixAutoUpdate=!1}updateMatrixWorld(i){const c=this.bones,g=this.geometry,_=g.getAttribute("position");oa.copy(this.root.matrixWorld).invert();for(let w=0,A=0;w<c.length;w++){const R=c[w];R.parent&&R.parent.isBone&&(Go.multiplyMatrices(oa,R.matrixWorld),sa.setFromMatrixPosition(Go),_.setXYZ(A,sa.x,sa.y,sa.z),Go.multiplyMatrices(oa,R.parent.matrixWorld),sa.setFromMatrixPosition(Go),_.setXYZ(A+1,sa.x,sa.y,sa.z),A+=2)}g.getAttribute("position").needsUpdate=!0,super.updateMatrixWorld(i)}}function Rg(M){const i=[];M&&M.isBone&&i.push(M);for(let c=0;c<M.children.length;c++)i.push.apply(i,Rg(M.children[c]));return i}const Js=new et,Dg=new un,du=new un;class zg extends $o{constructor(i=10,c=10,g=4473924,_=8947848){g=new un(g),_=new un(_);const w=c/2,A=i/c,R=i/2,z=[],F=[];for(let q=0,J=0,K=-R;q<=c;q++,K+=A){z.push(-R,0,K,R,0,K),z.push(K,0,-R,K,0,R);const re=q===w?g:_;re.toArray(F,J),J+=3,re.toArray(F,J),J+=3,re.toArray(F,J),J+=3,re.toArray(F,J),J+=3}const W=new Er;W.setAttribute("position",new Kn(z,3)),W.setAttribute("color",new Kn(F,3)),super(W,new to({vertexColors:!0,toneMapped:!1})),this.type="GridHelper"}}const nf=new et,Lo=new et,Cm=new et,rf=new et,co=new Ql;function Io(M,i,c,g,_,w,A){rf.set(_,w,A).unproject(g);const R=i[M];if(R!==void 0){const z=c.getAttribute("position");for(let F=0,W=R.length;F<W;F++)z.setXYZ(R[F],rf.x,rf.y,rf.z)}}const ip=new ps;class Og extends $o{constructor(i,c=16776960){const g=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),_=new Float32Array(24),w=new Er;w.setIndex(new pn(g,1)),w.setAttribute("position",new pn(_,3)),super(w,new to({color:c,toneMapped:!1})),this.object=i,this.type="BoxHelper",this.matrixAutoUpdate=!1,this.update()}update(i){if(i!==void 0&&console.warn("THREE.BoxHelper: .update() has no longer arguments."),this.object!==void 0&&ip.setFromObject(this.object),ip.isEmpty())return;const c=ip.min,g=ip.max,_=this.geometry.attributes.position,w=_.array;w[0]=g.x,w[1]=g.y,w[2]=g.z,w[3]=c.x,w[4]=g.y,w[5]=g.z,w[6]=c.x,w[7]=c.y,w[8]=g.z,w[9]=g.x,w[10]=c.y,w[11]=g.z,w[12]=g.x,w[13]=g.y,w[14]=c.z,w[15]=c.x,w[16]=g.y,w[17]=c.z,w[18]=c.x,w[19]=c.y,w[20]=c.z,w[21]=g.x,w[22]=c.y,w[23]=c.z,_.needsUpdate=!0,this.geometry.computeBoundingSphere()}setFromObject(i){return this.object=i,this.update(),this}copy(i){return $o.prototype.copy.call(this,i),this.object=i.object,this}}const oy=new et;let Za,gc;class sf extends $o{constructor(i=1){const c=[0,0,0,i,0,0,0,0,0,0,i,0,0,0,0,0,0,i],g=new Er;g.setAttribute("position",new Kn(c,3)),g.setAttribute("color",new Kn([1,0,0,1,.6,0,0,1,0,.6,1,0,0,0,1,0,.6,1],3)),super(g,new to({vertexColors:!0,toneMapped:!1})),this.type="AxesHelper"}setColors(i,c,g){const _=new un,w=this.geometry.attributes.color.array;return _.set(i),_.toArray(w,0),_.toArray(w,3),_.set(c),_.toArray(w,6),_.toArray(w,9),_.set(g),_.toArray(w,12),_.toArray(w,15),this.geometry.attributes.color.needsUpdate=!0,this}dispose(){this.geometry.dispose(),this.material.dispose()}}const of=new Float32Array(1),Fg=new Int32Array(of.buffer);ee.create=function(M,i){return console.log("THREE.Curve.create() has been deprecated"),M.prototype=Object.create(ee.prototype),M.prototype.constructor=M,M.prototype.getPoint=i,M},Hc.prototype.fromPoints=function(M){return console.warn("THREE.Path: .fromPoints() has been renamed to .setFromPoints()."),this.setFromPoints(M)},zg.prototype.setColors=function(){console.error("THREE.GridHelper: setColors() has been deprecated, pass them in the constructor instead.")},Co.prototype.update=function(){console.error("THREE.SkeletonHelper: update() no longer needs to be called.")},Vo.prototype.extractUrlBase=function(M){return console.warn("THREE.Loader: .extractUrlBase() has been deprecated. Use THREE.LoaderUtils.extractUrlBase() instead."),bm.extractUrlBase(M)},Vo.Handlers={add:function(){console.error("THREE.Loader: Handlers.add() has been removed. Use LoadingManager.addHandler() instead.")},get:function(){console.error("THREE.Loader: Handlers.get() has been removed. Use LoadingManager.getHandler() instead.")}},Zc.prototype.center=function(M){return console.warn("THREE.Box2: .center() has been renamed to .getCenter()."),this.getCenter(M)},Zc.prototype.empty=function(){return console.warn("THREE.Box2: .empty() has been renamed to .isEmpty()."),this.isEmpty()},Zc.prototype.isIntersectionBox=function(M){return console.warn("THREE.Box2: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(M)},Zc.prototype.size=function(M){return console.warn("THREE.Box2: .size() has been renamed to .getSize()."),this.getSize(M)},ps.prototype.center=function(M){return console.warn("THREE.Box3: .center() has been renamed to .getCenter()."),this.getCenter(M)},ps.prototype.empty=function(){return console.warn("THREE.Box3: .empty() has been renamed to .isEmpty()."),this.isEmpty()},ps.prototype.isIntersectionBox=function(M){return console.warn("THREE.Box3: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(M)},ps.prototype.isIntersectionSphere=function(M){return console.warn("THREE.Box3: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(M)},ps.prototype.size=function(M){return console.warn("THREE.Box3: .size() has been renamed to .getSize()."),this.getSize(M)},Bn.prototype.empty=function(){return console.warn("THREE.Sphere: .empty() has been renamed to .isEmpty()."),this.isEmpty()},tc.prototype.setFromMatrix=function(M){return console.warn("THREE.Frustum: .setFromMatrix() has been renamed to .setFromProjectionMatrix()."),this.setFromProjectionMatrix(M)},sy.prototype.center=function(M){return console.warn("THREE.Line3: .center() has been renamed to .getCenter()."),this.getCenter(M)},jr.prototype.flattenToArrayOffset=function(M,i){return console.warn("THREE.Matrix3: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(M,i)},jr.prototype.multiplyVector3=function(M){return console.warn("THREE.Matrix3: .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead."),M.applyMatrix3(this)},jr.prototype.multiplyVector3Array=function(){console.error("THREE.Matrix3: .multiplyVector3Array() has been removed.")},jr.prototype.applyToBufferAttribute=function(M){return console.warn("THREE.Matrix3: .applyToBufferAttribute() has been removed. Use attribute.applyMatrix3( matrix ) instead."),M.applyMatrix3(this)},jr.prototype.applyToVector3Array=function(){console.error("THREE.Matrix3: .applyToVector3Array() has been removed.")},jr.prototype.getInverse=function(M){return console.warn("THREE.Matrix3: .getInverse() has been removed. Use matrixInv.copy( matrix ).invert(); instead."),this.copy(M).invert()},Mn.prototype.extractPosition=function(M){return console.warn("THREE.Matrix4: .extractPosition() has been renamed to .copyPosition()."),this.copyPosition(M)},Mn.prototype.flattenToArrayOffset=function(M,i){return console.warn("THREE.Matrix4: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(M,i)},Mn.prototype.getPosition=function(){return console.warn("THREE.Matrix4: .getPosition() has been removed. Use Vector3.setFromMatrixPosition( matrix ) instead."),new et().setFromMatrixColumn(this,3)},Mn.prototype.setRotationFromQuaternion=function(M){return console.warn("THREE.Matrix4: .setRotationFromQuaternion() has been renamed to .makeRotationFromQuaternion()."),this.makeRotationFromQuaternion(M)},Mn.prototype.multiplyToArray=function(){console.warn("THREE.Matrix4: .multiplyToArray() has been removed.")},Mn.prototype.multiplyVector3=function(M){return console.warn("THREE.Matrix4: .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) instead."),M.applyMatrix4(this)},Mn.prototype.multiplyVector4=function(M){return console.warn("THREE.Matrix4: .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),M.applyMatrix4(this)},Mn.prototype.multiplyVector3Array=function(){console.error("THREE.Matrix4: .multiplyVector3Array() has been removed.")},Mn.prototype.rotateAxis=function(M){console.warn("THREE.Matrix4: .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),M.transformDirection(this)},Mn.prototype.crossVector=function(M){return console.warn("THREE.Matrix4: .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead."),M.applyMatrix4(this)},Mn.prototype.translate=function(){console.error("THREE.Matrix4: .translate() has been removed.")},Mn.prototype.rotateX=function(){console.error("THREE.Matrix4: .rotateX() has been removed.")},Mn.prototype.rotateY=function(){console.error("THREE.Matrix4: .rotateY() has been removed.")},Mn.prototype.rotateZ=function(){console.error("THREE.Matrix4: .rotateZ() has been removed.")},Mn.prototype.rotateByAxis=function(){console.error("THREE.Matrix4: .rotateByAxis() has been removed.")},Mn.prototype.applyToBufferAttribute=function(M){return console.warn("THREE.Matrix4: .applyToBufferAttribute() has been removed. Use attribute.applyMatrix4( matrix ) instead."),M.applyMatrix4(this)},Mn.prototype.applyToVector3Array=function(){console.error("THREE.Matrix4: .applyToVector3Array() has been removed.")},Mn.prototype.makeFrustum=function(M,i,c,g,_,w){return console.warn("THREE.Matrix4: .makeFrustum() has been removed. Use .makePerspective( left, right, top, bottom, near, far ) instead."),this.makePerspective(M,i,g,c,_,w)},Mn.prototype.getInverse=function(M){return console.warn("THREE.Matrix4: .getInverse() has been removed. Use matrixInv.copy( matrix ).invert(); instead."),this.copy(M).invert()},Ma.prototype.isIntersectionLine=function(M){return console.warn("THREE.Plane: .isIntersectionLine() has been renamed to .intersectsLine()."),this.intersectsLine(M)},Rs.prototype.multiplyVector3=function(M){return console.warn("THREE.Quaternion: .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead."),M.applyQuaternion(this)},Rs.prototype.inverse=function(){return console.warn("THREE.Quaternion: .inverse() has been renamed to invert()."),this.invert()},br.prototype.isIntersectionBox=function(M){return console.warn("THREE.Ray: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(M)},br.prototype.isIntersectionPlane=function(M){return console.warn("THREE.Ray: .isIntersectionPlane() has been renamed to .intersectsPlane()."),this.intersectsPlane(M)},br.prototype.isIntersectionSphere=function(M){return console.warn("THREE.Ray: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(M)},Zi.prototype.area=function(){return console.warn("THREE.Triangle: .area() has been renamed to .getArea()."),this.getArea()},Zi.prototype.barycoordFromPoint=function(M,i){return console.warn("THREE.Triangle: .barycoordFromPoint() has been renamed to .getBarycoord()."),this.getBarycoord(M,i)},Zi.prototype.midpoint=function(M){return console.warn("THREE.Triangle: .midpoint() has been renamed to .getMidpoint()."),this.getMidpoint(M)},Zi.prototypenormal=function(M){return console.warn("THREE.Triangle: .normal() has been renamed to .getNormal()."),this.getNormal(M)},Zi.prototype.plane=function(M){return console.warn("THREE.Triangle: .plane() has been renamed to .getPlane()."),this.getPlane(M)},Zi.barycoordFromPoint=function(M,i,c,g,_){return console.warn("THREE.Triangle: .barycoordFromPoint() has been renamed to .getBarycoord()."),Zi.getBarycoord(M,i,c,g,_)},Zi.normal=function(M,i,c,g){return console.warn("THREE.Triangle: .normal() has been renamed to .getNormal()."),Zi.getNormal(M,i,c,g)},jc.prototype.extractAllPoints=function(M){return console.warn("THREE.Shape: .extractAllPoints() has been removed. Use .extractPoints() instead."),this.extractPoints(M)},jc.prototype.extrude=function(M){return console.warn("THREE.Shape: .extrude() has been removed. Use ExtrudeGeometry() instead."),new on(this,M)},jc.prototype.makeGeometry=function(M){return console.warn("THREE.Shape: .makeGeometry() has been removed. Use ShapeGeometry() instead."),new io(this,M)},Ri.prototype.fromAttribute=function(M,i,c){return console.warn("THREE.Vector2: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(M,i,c)},Ri.prototype.distanceToManhattan=function(M){return console.warn("THREE.Vector2: .distanceToManhattan() has been renamed to .manhattanDistanceTo()."),this.manhattanDistanceTo(M)},Ri.prototype.lengthManhattan=function(){return console.warn("THREE.Vector2: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()},et.prototype.setEulerFromRotationMatrix=function(){console.error("THREE.Vector3: .setEulerFromRotationMatrix() has been removed. Use Euler.setFromRotationMatrix() instead.")},et.prototype.setEulerFromQuaternion=function(){console.error("THREE.Vector3: .setEulerFromQuaternion() has been removed. Use Euler.setFromQuaternion() instead.")},et.prototype.getPositionFromMatrix=function(M){return console.warn("THREE.Vector3: .getPositionFromMatrix() has been renamed to .setFromMatrixPosition()."),this.setFromMatrixPosition(M)},et.prototype.getScaleFromMatrix=function(M){return console.warn("THREE.Vector3: .getScaleFromMatrix() has been renamed to .setFromMatrixScale()."),this.setFromMatrixScale(M)},et.prototype.getColumnFromMatrix=function(M,i){return console.warn("THREE.Vector3: .getColumnFromMatrix() has been renamed to .setFromMatrixColumn()."),this.setFromMatrixColumn(i,M)},et.prototype.applyProjection=function(M){return console.warn("THREE.Vector3: .applyProjection() has been removed. Use .applyMatrix4( m ) instead."),this.applyMatrix4(M)},et.prototype.fromAttribute=function(M,i,c){return console.warn("THREE.Vector3: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(M,i,c)},et.prototype.distanceToManhattan=function(M){return console.warn("THREE.Vector3: .distanceToManhattan() has been renamed to .manhattanDistanceTo()."),this.manhattanDistanceTo(M)},et.prototype.lengthManhattan=function(){return console.warn("THREE.Vector3: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()},Mr.prototype.fromAttribute=function(M,i,c){return console.warn("THREE.Vector4: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(M,i,c)},Mr.prototype.lengthManhattan=function(){return console.warn("THREE.Vector4: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()},we.prototype.getChildByName=function(M){return console.warn("THREE.Object3D: .getChildByName() has been renamed to .getObjectByName()."),this.getObjectByName(M)},we.prototype.renderDepth=function(){console.warn("THREE.Object3D: .renderDepth has been removed. Use .renderOrder, instead.")},we.prototype.translate=function(M,i){return console.warn("THREE.Object3D: .translate() has been removed. Use .translateOnAxis( axis, distance ) instead."),this.translateOnAxis(i,M)},we.prototype.getWorldRotation=function(){console.error("THREE.Object3D: .getWorldRotation() has been removed. Use THREE.Object3D.getWorldQuaternion( target ) instead.")},we.prototype.applyMatrix=function(M){return console.warn("THREE.Object3D: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(M)},Object.defineProperties(we.prototype,{eulerOrder:{get:function(){return console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order},set:function(M){console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order=M}},useQuaternion:{get:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")},set:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")}}}),oo.prototype.setDrawMode=function(){console.error("THREE.Mesh: .setDrawMode() has been removed. The renderer now always assumes THREE.TrianglesDrawMode. Transform your geometry via BufferGeometryUtils.toTrianglesDrawMode() if necessary.")},Object.defineProperties(oo.prototype,{drawMode:{get:function(){return console.error("THREE.Mesh: .drawMode has been removed. The renderer now always assumes THREE.TrianglesDrawMode."),0},set:function(){console.error("THREE.Mesh: .drawMode has been removed. The renderer now always assumes THREE.TrianglesDrawMode. Transform your geometry via BufferGeometryUtils.toTrianglesDrawMode() if necessary.")}}}),Xo.prototype.initBones=function(){console.error("THREE.SkinnedMesh: initBones() has been removed.")},go.prototype.setLens=function(M,i){console.warn("THREE.PerspectiveCamera.setLens is deprecated. Use .setFocalLength and .filmGauge for a photographic setup."),i!==void 0&&(this.filmGauge=i),this.setFocalLength(M)},Object.defineProperties(Da.prototype,{onlyShadow:{set:function(){console.warn("THREE.Light: .onlyShadow has been removed.")}},shadowCameraFov:{set:function(M){console.warn("THREE.Light: .shadowCameraFov is now .shadow.camera.fov."),this.shadow.camera.fov=M}},shadowCameraLeft:{set:function(M){console.warn("THREE.Light: .shadowCameraLeft is now .shadow.camera.left."),this.shadow.camera.left=M}},shadowCameraRight:{set:function(M){console.warn("THREE.Light: .shadowCameraRight is now .shadow.camera.right."),this.shadow.camera.right=M}},shadowCameraTop:{set:function(M){console.warn("THREE.Light: .shadowCameraTop is now .shadow.camera.top."),this.shadow.camera.top=M}},shadowCameraBottom:{set:function(M){console.warn("THREE.Light: .shadowCameraBottom is now .shadow.camera.bottom."),this.shadow.camera.bottom=M}},shadowCameraNear:{set:function(M){console.warn("THREE.Light: .shadowCameraNear is now .shadow.camera.near."),this.shadow.camera.near=M}},shadowCameraFar:{set:function(M){console.warn("THREE.Light: .shadowCameraFar is now .shadow.camera.far."),this.shadow.camera.far=M}},shadowCameraVisible:{set:function(){console.warn("THREE.Light: .shadowCameraVisible has been removed. Use new THREE.CameraHelper( light.shadow.camera ) instead.")}},shadowBias:{set:function(M){console.warn("THREE.Light: .shadowBias is now .shadow.bias."),this.shadow.bias=M}},shadowDarkness:{set:function(){console.warn("THREE.Light: .shadowDarkness has been removed.")}},shadowMapWidth:{set:function(M){console.warn("THREE.Light: .shadowMapWidth is now .shadow.mapSize.width."),this.shadow.mapSize.width=M}},shadowMapHeight:{set:function(M){console.warn("THREE.Light: .shadowMapHeight is now .shadow.mapSize.height."),this.shadow.mapSize.height=M}}}),Object.defineProperties(pn.prototype,{length:{get:function(){return console.warn("THREE.BufferAttribute: .length has been deprecated. Use .count instead."),this.array.length}},dynamic:{get:function(){return console.warn("THREE.BufferAttribute: .dynamic has been deprecated. Use .usage instead."),this.usage===35048},set:function(){console.warn("THREE.BufferAttribute: .dynamic has been deprecated. Use .usage instead."),this.setUsage(35048)}}}),pn.prototype.setDynamic=function(M){return console.warn("THREE.BufferAttribute: .setDynamic() has been deprecated. Use .setUsage() instead."),this.setUsage(M===!0?35048:35044),this},pn.prototype.copyIndicesArray=function(){console.error("THREE.BufferAttribute: .copyIndicesArray() has been removed.")},pn.prototype.setArray=function(){console.error("THREE.BufferAttribute: .setArray has been removed. Use BufferGeometry .setAttribute to replace/resize attribute buffers")},Er.prototype.addIndex=function(M){console.warn("THREE.BufferGeometry: .addIndex() has been renamed to .setIndex()."),this.setIndex(M)},Er.prototype.addAttribute=function(M,i){return console.warn("THREE.BufferGeometry: .addAttribute() has been renamed to .setAttribute()."),i&&i.isBufferAttribute||i&&i.isInterleavedBufferAttribute?M==="index"?(console.warn("THREE.BufferGeometry.addAttribute: Use .setIndex() for index attribute."),this.setIndex(i),this):this.setAttribute(M,i):(console.warn("THREE.BufferGeometry: .addAttribute() now expects ( name, attribute )."),this.setAttribute(M,new pn(arguments[1],arguments[2])))},Er.prototype.addDrawCall=function(M,i,c){c!==void 0&&console.warn("THREE.BufferGeometry: .addDrawCall() no longer supports indexOffset."),console.warn("THREE.BufferGeometry: .addDrawCall() is now .addGroup()."),this.addGroup(M,i)},Er.prototype.clearDrawCalls=function(){console.warn("THREE.BufferGeometry: .clearDrawCalls() is now .clearGroups()."),this.clearGroups()},Er.prototype.computeOffsets=function(){console.warn("THREE.BufferGeometry: .computeOffsets() has been removed.")},Er.prototype.removeAttribute=function(M){return console.warn("THREE.BufferGeometry: .removeAttribute() has been renamed to .deleteAttribute()."),this.deleteAttribute(M)},Er.prototype.applyMatrix=function(M){return console.warn("THREE.BufferGeometry: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(M)},Object.defineProperties(Er.prototype,{drawcalls:{get:function(){return console.error("THREE.BufferGeometry: .drawcalls has been renamed to .groups."),this.groups}},offsets:{get:function(){return console.warn("THREE.BufferGeometry: .offsets has been renamed to .groups."),this.groups}}}),Pl.prototype.setDynamic=function(M){return console.warn("THREE.InterleavedBuffer: .setDynamic() has been deprecated. Use .setUsage() instead."),this.setUsage(M===!0?35048:35044),this},Pl.prototype.setArray=function(){console.error("THREE.InterleavedBuffer: .setArray has been removed. Use BufferGeometry .setAttribute to replace/resize attribute buffers")},on.prototype.getArrays=function(){console.error("THREE.ExtrudeGeometry: .getArrays() has been removed.")},on.prototype.addShapeList=function(){console.error("THREE.ExtrudeGeometry: .addShapeList() has been removed.")},on.prototype.addShape=function(){console.error("THREE.ExtrudeGeometry: .addShape() has been removed.")},Lc.prototype.dispose=function(){console.error("THREE.Scene: .dispose() has been removed.")},fc.prototype.onUpdate=function(){return console.warn("THREE.Uniform: .onUpdate() has been removed. Use object.onBeforeRender() instead."),this},Object.defineProperties(Bi.prototype,{wrapAround:{get:function(){console.warn("THREE.Material: .wrapAround has been removed.")},set:function(){console.warn("THREE.Material: .wrapAround has been removed.")}},overdraw:{get:function(){console.warn("THREE.Material: .overdraw has been removed.")},set:function(){console.warn("THREE.Material: .overdraw has been removed.")}},wrapRGB:{get:function(){return console.warn("THREE.Material: .wrapRGB has been removed."),new un}},shading:{get:function(){console.error("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead.")},set:function(M){console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=M===1}},stencilMask:{get:function(){return console.warn("THREE."+this.type+": .stencilMask has been removed. Use .stencilFuncMask instead."),this.stencilFuncMask},set:function(M){console.warn("THREE."+this.type+": .stencilMask has been removed. Use .stencilFuncMask instead."),this.stencilFuncMask=M}},vertexTangents:{get:function(){console.warn("THREE."+this.type+": .vertexTangents has been removed.")},set:function(){console.warn("THREE."+this.type+": .vertexTangents has been removed.")}}}),Object.defineProperties(tl.prototype,{derivatives:{get:function(){return console.warn("THREE.ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives},set:function(M){console.warn("THREE. ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives=M}}}),cs.prototype.clearTarget=function(M,i,c,g){console.warn("THREE.WebGLRenderer: .clearTarget() has been deprecated. Use .setRenderTarget() and .clear() instead."),this.setRenderTarget(M),this.clear(i,c,g)},cs.prototype.animate=function(M){console.warn("THREE.WebGLRenderer: .animate() is now .setAnimationLoop()."),this.setAnimationLoop(M)},cs.prototype.getCurrentRenderTarget=function(){return console.warn("THREE.WebGLRenderer: .getCurrentRenderTarget() is now .getRenderTarget()."),this.getRenderTarget()},cs.prototype.getMaxAnisotropy=function(){return console.warn("THREE.WebGLRenderer: .getMaxAnisotropy() is now .capabilities.getMaxAnisotropy()."),this.capabilities.getMaxAnisotropy()},cs.prototype.getPrecision=function(){return console.warn("THREE.WebGLRenderer: .getPrecision() is now .capabilities.precision."),this.capabilities.precision},cs.prototype.resetGLState=function(){return console.warn("THREE.WebGLRenderer: .resetGLState() is now .state.reset()."),this.state.reset()},cs.prototype.supportsFloatTextures=function(){return console.warn("THREE.WebGLRenderer: .supportsFloatTextures() is now .extensions.get( 'OES_texture_float' )."),this.extensions.get("OES_texture_float")},cs.prototype.supportsHalfFloatTextures=function(){return console.warn("THREE.WebGLRenderer: .supportsHalfFloatTextures() is now .extensions.get( 'OES_texture_half_float' )."),this.extensions.get("OES_texture_half_float")},cs.prototype.supportsStandardDerivatives=function(){return console.warn("THREE.WebGLRenderer: .supportsStandardDerivatives() is now .extensions.get( 'OES_standard_derivatives' )."),this.extensions.get("OES_standard_derivatives")},cs.prototype.supportsCompressedTextureS3TC=function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTextureS3TC() is now .extensions.get( 'WEBGL_compressed_texture_s3tc' )."),this.extensions.get("WEBGL_compressed_texture_s3tc")},cs.prototype.supportsCompressedTexturePVRTC=function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTexturePVRTC() is now .extensions.get( 'WEBGL_compressed_texture_pvrtc' )."),this.extensions.get("WEBGL_compressed_texture_pvrtc")},cs.prototype.supportsBlendMinMax=function(){return console.warn("THREE.WebGLRenderer: .supportsBlendMinMax() is now .extensions.get( 'EXT_blend_minmax' )."),this.extensions.get("EXT_blend_minmax")},cs.prototype.supportsVertexTextures=function(){return console.warn("THREE.WebGLRenderer: .supportsVertexTextures() is now .capabilities.vertexTextures."),this.capabilities.vertexTextures},cs.prototype.supportsInstancedArrays=function(){return console.warn("THREE.WebGLRenderer: .supportsInstancedArrays() is now .extensions.get( 'ANGLE_instanced_arrays' )."),this.extensions.get("ANGLE_instanced_arrays")},cs.prototype.enableScissorTest=function(M){console.warn("THREE.WebGLRenderer: .enableScissorTest() is now .setScissorTest()."),this.setScissorTest(M)},cs.prototype.initMaterial=function(){console.warn("THREE.WebGLRenderer: .initMaterial() has been removed.")},cs.prototype.addPrePlugin=function(){console.warn("THREE.WebGLRenderer: .addPrePlugin() has been removed.")},cs.prototype.addPostPlugin=function(){console.warn("THREE.WebGLRenderer: .addPostPlugin() has been removed.")},cs.prototype.updateShadowMap=function(){console.warn("THREE.WebGLRenderer: .updateShadowMap() has been removed.")},cs.prototype.setFaceCulling=function(){console.warn("THREE.WebGLRenderer: .setFaceCulling() has been removed.")},cs.prototype.allocTextureUnit=function(){console.warn("THREE.WebGLRenderer: .allocTextureUnit() has been removed.")},cs.prototype.setTexture=function(){console.warn("THREE.WebGLRenderer: .setTexture() has been removed.")},cs.prototype.setTexture2D=function(){console.warn("THREE.WebGLRenderer: .setTexture2D() has been removed.")},cs.prototype.setTextureCube=function(){console.warn("THREE.WebGLRenderer: .setTextureCube() has been removed.")},cs.prototype.getActiveMipMapLevel=function(){return console.warn("THREE.WebGLRenderer: .getActiveMipMapLevel() is now .getActiveMipmapLevel()."),this.getActiveMipmapLevel()},Object.defineProperties(cs.prototype,{shadowMapEnabled:{get:function(){return this.shadowMap.enabled},set:function(M){console.warn("THREE.WebGLRenderer: .shadowMapEnabled is now .shadowMap.enabled."),this.shadowMap.enabled=M}},shadowMapType:{get:function(){return this.shadowMap.type},set:function(M){console.warn("THREE.WebGLRenderer: .shadowMapType is now .shadowMap.type."),this.shadowMap.type=M}},shadowMapCullFace:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMapCullFace has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMapCullFace has been removed. Set Material.shadowSide instead.")}},context:{get:function(){return console.warn("THREE.WebGLRenderer: .context has been removed. Use .getContext() instead."),this.getContext()}},vr:{get:function(){return console.warn("THREE.WebGLRenderer: .vr has been renamed to .xr"),this.xr}},gammaInput:{get:function(){return console.warn("THREE.WebGLRenderer: .gammaInput has been removed. Set the encoding for textures via Texture.encoding instead."),!1},set:function(){console.warn("THREE.WebGLRenderer: .gammaInput has been removed. Set the encoding for textures via Texture.encoding instead.")}},gammaOutput:{get:function(){return console.warn("THREE.WebGLRenderer: .gammaOutput has been removed. Set WebGLRenderer.outputEncoding instead."),!1},set:function(M){console.warn("THREE.WebGLRenderer: .gammaOutput has been removed. Set WebGLRenderer.outputEncoding instead."),this.outputEncoding=M===!0?3001:3e3}},toneMappingWhitePoint:{get:function(){return console.warn("THREE.WebGLRenderer: .toneMappingWhitePoint has been removed."),1},set:function(){console.warn("THREE.WebGLRenderer: .toneMappingWhitePoint has been removed.")}}}),Object.defineProperties(Ha.prototype,{cullFace:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.cullFace has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.cullFace has been removed. Set Material.shadowSide instead.")}},renderReverseSided:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderReverseSided has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderReverseSided has been removed. Set Material.shadowSide instead.")}},renderSingleSided:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderSingleSided has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderSingleSided has been removed. Set Material.shadowSide instead.")}}}),Object.defineProperties(Bs.prototype,{wrapS:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS},set:function(M){console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS=M}},wrapT:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT},set:function(M){console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT=M}},magFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter},set:function(M){console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter=M}},minFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter},set:function(M){console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter=M}},anisotropy:{get:function(){return console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy},set:function(M){console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy=M}},offset:{get:function(){return console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset},set:function(M){console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset=M}},repeat:{get:function(){return console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat},set:function(M){console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat=M}},format:{get:function(){return console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format},set:function(M){console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format=M}},type:{get:function(){return console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type},set:function(M){console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type=M}},generateMipmaps:{get:function(){return console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps},set:function(M){console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps=M}}}),qc.prototype.load=function(M){console.warn("THREE.Audio: .load has been deprecated. Use THREE.AudioLoader instead.");const i=this;return new Cg().load(M,function(c){i.setBuffer(c)}),this},Q_.prototype.getData=function(){return console.warn("THREE.AudioAnalyser: .getData() is now .getFrequencyData()."),this.getFrequencyData()},Tc.prototype.updateCubeMap=function(M,i){return console.warn("THREE.CubeCamera: .updateCubeMap() is now .update()."),this.update(M,i)},Tc.prototype.clear=function(M,i,c,g){return console.warn("THREE.CubeCamera: .clear() is now .renderTarget.clear()."),this.renderTarget.clear(M,i,c,g)},Fs.crossOrigin=void 0,Fs.loadTexture=function(M,i,c,g){console.warn("THREE.ImageUtils.loadTexture has been deprecated. Use THREE.TextureLoader() instead.");const _=new hu;_.setCrossOrigin(this.crossOrigin);const w=_.load(M,c,void 0,g);return i&&(w.mapping=i),w},Fs.loadTextureCube=function(M,i,c,g){console.warn("THREE.ImageUtils.loadTextureCube has been deprecated. Use THREE.CubeTextureLoader() instead.");const _=new cm;_.setCrossOrigin(this.crossOrigin);const w=_.load(M,c,void 0,g);return i&&(w.mapping=i),w},Fs.loadCompressedTexture=function(){console.error("THREE.ImageUtils.loadCompressedTexture has been removed. Use THREE.DDSLoader instead.")},Fs.loadCompressedTextureCube=function(){console.error("THREE.ImageUtils.loadCompressedTextureCube has been removed. Use THREE.DDSLoader instead.")};const kg={createMultiMaterialObject:function(){console.error("THREE.SceneUtils has been moved to /examples/jsm/utils/SceneUtils.js")},detach:function(){console.error("THREE.SceneUtils has been moved to /examples/jsm/utils/SceneUtils.js")},attach:function(){console.error("THREE.SceneUtils has been moved to /examples/jsm/utils/SceneUtils.js")}};typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:C}})),typeof window<"u"&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=C),f.ACESFilmicToneMapping=4,f.AddEquation=100,f.AddOperation=2,f.AdditiveAnimationBlendMode=2501,f.AdditiveBlending=2,f.AlphaFormat=1021,f.AlwaysDepth=1,f.AlwaysStencilFunc=519,f.AmbientLight=vm,f.AmbientLightProbe=Qd,f.AnimationClip=od,f.AnimationLoader=class extends Vo{constructor(M){super(M)}load(M,i,c,g){const _=this,w=new ml(this.manager);w.setPath(this.path),w.setRequestHeader(this.requestHeader),w.setWithCredentials(this.withCredentials),w.load(M,function(A){try{i(_.parse(JSON.parse(A)))}catch(R){g?g(R):console.error(R),_.manager.itemError(M)}},c,g)}parse(M){const i=[];for(let c=0;c<M.length;c++){const g=od.parse(M[c]);i.push(g)}return i}},f.AnimationMixer=Gr,f.AnimationObjectGroup=cd,f.AnimationUtils=rr,f.ArcCurve=ue,f.ArrayCamera=lc,f.ArrowHelper=class extends we{constructor(M=new et(0,0,1),i=new et(0,0,0),c=1,g=16776960,_=.2*c,w=.2*_){super(),this.type="ArrowHelper",Za===void 0&&(Za=new Er,Za.setAttribute("position",new Kn([0,0,0,0,1,0],3)),gc=new y(0,.5,1,5,1),gc.translate(0,-.5,0)),this.position.copy(i),this.line=new ul(Za,new to({color:g,toneMapped:!1})),this.line.matrixAutoUpdate=!1,this.add(this.line),this.cone=new oo(gc,new fs({color:g,toneMapped:!1})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(M),this.setLength(c,_,w)}setDirection(M){if(M.y>.99999)this.quaternion.set(0,0,0,1);else if(M.y<-.99999)this.quaternion.set(1,0,0,0);else{oy.set(M.z,0,-M.x).normalize();const i=Math.acos(M.y);this.quaternion.setFromAxisAngle(oy,i)}}setLength(M,i=.2*M,c=.2*i){this.line.scale.set(1,Math.max(1e-4,M-i),1),this.line.updateMatrix(),this.cone.scale.set(c,i,c),this.cone.position.y=M,this.cone.updateMatrix()}setColor(M){this.line.material.color.set(M),this.cone.material.color.set(M)}copy(M){return super.copy(M,!1),this.line.copy(M.line),this.cone.copy(M.cone),this}},f.Audio=qc,f.AudioAnalyser=Q_,f.AudioContext=ef,f.AudioListener=class extends we{constructor(){super(),this.type="AudioListener",this.context=ef.getContext(),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.filter=null,this.timeDelta=0,this._clock=new Mm}getInput(){return this.gain}removeFilter(){return this.filter!==null&&(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination),this.gain.connect(this.context.destination),this.filter=null),this}getFilter(){return this.filter}setFilter(M){return this.filter!==null?(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination)):this.gain.disconnect(this.context.destination),this.filter=M,this.gain.connect(this.filter),this.filter.connect(this.context.destination),this}getMasterVolume(){return this.gain.gain.value}setMasterVolume(M){return this.gain.gain.setTargetAtTime(M,this.context.currentTime,.01),this}updateMatrixWorld(M){super.updateMatrixWorld(M);const i=this.context.listener,c=this.up;if(this.timeDelta=this._clock.getDelta(),this.matrixWorld.decompose(pc,ad,Ih),ra.set(0,0,-1).applyQuaternion(ad),i.positionX){const g=this.context.currentTime+this.timeDelta;i.positionX.linearRampToValueAtTime(pc.x,g),i.positionY.linearRampToValueAtTime(pc.y,g),i.positionZ.linearRampToValueAtTime(pc.z,g),i.forwardX.linearRampToValueAtTime(ra.x,g),i.forwardY.linearRampToValueAtTime(ra.y,g),i.forwardZ.linearRampToValueAtTime(ra.z,g),i.upX.linearRampToValueAtTime(c.x,g),i.upY.linearRampToValueAtTime(c.y,g),i.upZ.linearRampToValueAtTime(c.z,g)}else i.setPosition(pc.x,pc.y,pc.z),i.setOrientation(ra.x,ra.y,ra.z,c.x,c.y,c.z)}},f.AudioLoader=Cg,f.AxesHelper=sf,f.AxisHelper=function(M){return console.warn("THREE.AxisHelper has been renamed to THREE.AxesHelper."),new sf(M)},f.BackSide=1,f.BasicDepthPacking=3200,f.BasicShadowMap=0,f.BinaryTextureLoader=function(M){return console.warn("THREE.BinaryTextureLoader has been renamed to THREE.DataTextureLoader."),new hm(M)},f.Bone=iu,f.BooleanKeyframeTrack=Eh,f.BoundingBoxHelper=function(M,i){return console.warn("THREE.BoundingBoxHelper has been deprecated. Creating a THREE.BoxHelper instead."),new Og(M,i)},f.Box2=Zc,f.Box3=ps,f.Box3Helper=class extends $o{constructor(M,i=16776960){const c=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),g=new Er;g.setIndex(new pn(c,1)),g.setAttribute("position",new Kn([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1],3)),super(g,new to({color:i,toneMapped:!1})),this.box=M,this.type="Box3Helper",this.geometry.computeBoundingSphere()}updateMatrixWorld(M){const i=this.box;i.isEmpty()||(i.getCenter(this.position),i.getSize(this.scale),this.scale.multiplyScalar(.5),super.updateMatrixWorld(M))}},f.BoxBufferGeometry=el,f.BoxGeometry=el,f.BoxHelper=Og,f.BufferAttribute=pn,f.BufferGeometry=Er,f.BufferGeometryLoader=Jd,f.ByteType=1010,f.Cache=pl,f.Camera=Ql,f.CameraHelper=class extends $o{constructor(M){const i=new Er,c=new to({color:16777215,vertexColors:!0,toneMapped:!1}),g=[],_=[],w={},A=new un(16755200),R=new un(16711680),z=new un(43775),F=new un(16777215),W=new un(3355443);function q(K,re,ce){J(K,ce),J(re,ce)}function J(K,re){g.push(0,0,0),_.push(re.r,re.g,re.b),w[K]===void 0&&(w[K]=[]),w[K].push(g.length/3-1)}q("n1","n2",A),q("n2","n4",A),q("n4","n3",A),q("n3","n1",A),q("f1","f2",A),q("f2","f4",A),q("f4","f3",A),q("f3","f1",A),q("n1","f1",A),q("n2","f2",A),q("n3","f3",A),q("n4","f4",A),q("p","n1",R),q("p","n2",R),q("p","n3",R),q("p","n4",R),q("u1","u2",z),q("u2","u3",z),q("u3","u1",z),q("c","t",F),q("p","c",W),q("cn1","cn2",W),q("cn3","cn4",W),q("cf1","cf2",W),q("cf3","cf4",W),i.setAttribute("position",new Kn(g,3)),i.setAttribute("color",new Kn(_,3)),super(i,c),this.type="CameraHelper",this.camera=M,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.matrix=M.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=w,this.update()}update(){const M=this.geometry,i=this.pointMap;co.projectionMatrixInverse.copy(this.camera.projectionMatrixInverse),Io("c",i,M,co,0,0,-1),Io("t",i,M,co,0,0,1),Io("n1",i,M,co,-1,-1,-1),Io("n2",i,M,co,1,-1,-1),Io("n3",i,M,co,-1,1,-1),Io("n4",i,M,co,1,1,-1),Io("f1",i,M,co,-1,-1,1),Io("f2",i,M,co,1,-1,1),Io("f3",i,M,co,-1,1,1),Io("f4",i,M,co,1,1,1),Io("u1",i,M,co,.7,1.1,-1),Io("u2",i,M,co,-.7,1.1,-1),Io("u3",i,M,co,0,2,-1),Io("cf1",i,M,co,-1,0,1),Io("cf2",i,M,co,1,0,1),Io("cf3",i,M,co,0,-1,1),Io("cf4",i,M,co,0,1,1),Io("cn1",i,M,co,-1,0,-1),Io("cn2",i,M,co,1,0,-1),Io("cn3",i,M,co,0,-1,-1),Io("cn4",i,M,co,0,1,-1),M.getAttribute("position").needsUpdate=!0}dispose(){this.geometry.dispose(),this.material.dispose()}},f.CanvasRenderer=function(){console.error("THREE.CanvasRenderer has been removed")},f.CanvasTexture=m,f.CatmullRomCurve3=Be,f.CineonToneMapping=3,f.CircleBufferGeometry=h,f.CircleGeometry=h,f.ClampToEdgeWrapping=1001,f.Clock=Mm,f.Color=un,f.ColorKeyframeTrack=Uc,f.CompressedTexture=nd,f.CompressedTextureLoader=class extends Vo{constructor(M){super(M)}load(M,i,c,g){const _=this,w=[],A=new nd,R=new ml(this.manager);R.setPath(this.path),R.setResponseType("arraybuffer"),R.setRequestHeader(this.requestHeader),R.setWithCredentials(_.withCredentials);let z=0;function F(W){R.load(M[W],function(q){const J=_.parse(q,!0);w[W]={width:J.width,height:J.height,format:J.format,mipmaps:J.mipmaps},z+=1,z===6&&(J.mipmapCount===1&&(A.minFilter=1006),A.image=w,A.format=J.format,A.needsUpdate=!0,i&&i(A))},c,g)}if(Array.isArray(M))for(let W=0,q=M.length;W<q;++W)F(W);else R.load(M,function(W){const q=_.parse(W,!0);if(q.isCubemap){const J=q.mipmaps.length/q.mipmapCount;for(let K=0;K<J;K++){w[K]={mipmaps:[]};for(let re=0;re<q.mipmapCount;re++)w[K].mipmaps.push(q.mipmaps[K*q.mipmapCount+re]),w[K].format=q.format,w[K].width=q.width,w[K].height=q.height}A.image=w}else A.image.width=q.width,A.image.height=q.height,A.mipmaps=q.mipmaps;q.mipmapCount===1&&(A.minFilter=1006),A.format=q.format,A.needsUpdate=!0,i&&i(A)},c,g);return A}},f.ConeBufferGeometry=b,f.ConeGeometry=b,f.CubeCamera=Tc,f.CubeReflectionMapping=301,f.CubeRefractionMapping=302,f.CubeTexture=il,f.CubeTextureLoader=cm,f.CubeUVReflectionMapping=306,f.CubeUVRefractionMapping=307,f.CubicBezierCurve=xe,f.CubicBezierCurve3=Ne,f.CubicInterpolant=Fl,f.CullFaceBack=1,f.CullFaceFront=2,f.CullFaceFrontBack=3,f.CullFaceNone=0,f.Curve=ee,f.CurvePath=um,f.CustomBlending=5,f.CustomToneMapping=5,f.CylinderBufferGeometry=y,f.CylinderGeometry=y,f.Cylindrical=class{constructor(M=1,i=0,c=0){return this.radius=M,this.theta=i,this.y=c,this}set(M,i,c){return this.radius=M,this.theta=i,this.y=c,this}copy(M){return this.radius=M.radius,this.theta=M.theta,this.y=M.y,this}setFromVector3(M){return this.setFromCartesianCoords(M.x,M.y,M.z)}setFromCartesianCoords(M,i,c){return this.radius=Math.sqrt(M*M+c*c),this.theta=Math.atan2(M,c),this.y=i,this}clone(){return new this.constructor().copy(this)}},f.DataTexture=Dl,f.DataTexture2DArray=ku,f.DataTexture3D=Ua,f.DataTextureLoader=hm,f.DataUtils=class{static toHalfFloat(M){of[0]=M;const i=Fg[0];let c=i>>16&32768,g=i>>12&2047;const _=i>>23&255;return _<103?c:_>142?(c|=31744,c|=(_==255?0:1)&&8388607&i,c):_<113?(g|=2048,c|=(g>>114-_)+(g>>113-_&1),c):(c|=_-112<<10|g>>1,c+=1&g,c)}},f.DecrementStencilOp=7683,f.DecrementWrapStencilOp=34056,f.DefaultLoadingManager=lm,f.DepthFormat=1026,f.DepthStencilFormat=1027,f.DepthTexture=r,f.DirectionalLight=xm,f.DirectionalLightHelper=class extends we{constructor(M,i,c){super(),this.light=M,this.light.updateMatrixWorld(),this.matrix=M.matrixWorld,this.matrixAutoUpdate=!1,this.color=c,i===void 0&&(i=1);let g=new Er;g.setAttribute("position",new Kn([-i,i,0,i,i,0,i,-i,0,-i,-i,0,-i,i,0],3));const _=new to({fog:!1,toneMapped:!1});this.lightPlane=new ul(g,_),this.add(this.lightPlane),g=new Er,g.setAttribute("position",new Kn([0,0,0,0,0,1],3)),this.targetLine=new ul(g,_),this.add(this.targetLine),this.update()}dispose(){this.lightPlane.geometry.dispose(),this.lightPlane.material.dispose(),this.targetLine.geometry.dispose(),this.targetLine.material.dispose()}update(){nf.setFromMatrixPosition(this.light.matrixWorld),Lo.setFromMatrixPosition(this.light.target.matrixWorld),Cm.subVectors(Lo,nf),this.lightPlane.lookAt(Lo),this.color!==void 0?(this.lightPlane.material.color.set(this.color),this.targetLine.material.color.set(this.color)):(this.lightPlane.material.color.copy(this.light.color),this.targetLine.material.color.copy(this.light.color)),this.targetLine.lookAt(Lo),this.targetLine.scale.z=Cm.length()}},f.DiscreteInterpolant=Sh,f.DodecahedronBufferGeometry=E,f.DodecahedronGeometry=E,f.DoubleSide=2,f.DstAlphaFactor=206,f.DstColorFactor=208,f.DynamicBufferAttribute=function(M,i){return console.warn("THREE.DynamicBufferAttribute has been removed. Use new THREE.BufferAttribute().setUsage( THREE.DynamicDrawUsage ) instead."),new pn(M,i).setUsage(35048)},f.DynamicCopyUsage=35050,f.DynamicDrawUsage=35048,f.DynamicReadUsage=35049,f.EdgesGeometry=X,f.EdgesHelper=function(M,i){return console.warn("THREE.EdgesHelper has been removed. Use THREE.EdgesGeometry instead."),new $o(new X(M.geometry),new to({color:i!==void 0?i:16777215}))},f.EllipseCurve=ie,f.EqualDepth=4,f.EqualStencilFunc=514,f.EquirectangularReflectionMapping=303,f.EquirectangularRefractionMapping=304,f.Euler=ba,f.EventDispatcher=si,f.ExtrudeBufferGeometry=on,f.ExtrudeGeometry=on,f.FaceColors=1,f.FileLoader=ml,f.FlatShading=1,f.Float16BufferAttribute=Sl,f.Float32Attribute=function(M,i){return console.warn("THREE.Float32Attribute has been removed. Use new THREE.Float32BufferAttribute() instead."),new Kn(M,i)},f.Float32BufferAttribute=Kn,f.Float64Attribute=function(M,i){return console.warn("THREE.Float64Attribute has been removed. Use new THREE.Float64BufferAttribute() instead."),new Ja(M,i)},f.Float64BufferAttribute=Ja,f.FloatType=1015,f.Fog=Ca,f.FogExp2=Oo,f.Font=Jo,f.FontLoader=class extends Vo{constructor(M){super(M)}load(M,i,c,g){const _=this,w=new ml(this.manager);w.setPath(this.path),w.setRequestHeader(this.requestHeader),w.setWithCredentials(_.withCredentials),w.load(M,function(A){let R;try{R=JSON.parse(A)}catch{console.warn("THREE.FontLoader: typeface.js support is being deprecated. Use typeface.json instead."),R=JSON.parse(A.substring(65,A.length-2))}const z=_.parse(R);i&&i(z)},c,g)}parse(M){return new Jo(M)}},f.FrontSide=0,f.Frustum=tc,f.GLBufferAttribute=ny,f.GLSL1="100",f.GLSL3=It,f.GammaEncoding=3007,f.GreaterDepth=6,f.GreaterEqualDepth=5,f.GreaterEqualStencilFunc=518,f.GreaterStencilFunc=516,f.GridHelper=zg,f.Group=yh,f.HalfFloatType=1016,f.HemisphereLight=Yp,f.HemisphereLightHelper=class extends we{constructor(M,i,c){super(),this.light=M,this.light.updateMatrixWorld(),this.matrix=M.matrixWorld,this.matrixAutoUpdate=!1,this.color=c;const g=new ao(i);g.rotateY(.5*Math.PI),this.material=new fs({wireframe:!0,fog:!1,toneMapped:!1}),this.color===void 0&&(this.material.vertexColors=!0);const _=g.getAttribute("position"),w=new Float32Array(3*_.count);g.setAttribute("color",new pn(w,3)),this.add(new oo(g,this.material)),this.update()}dispose(){this.children[0].geometry.dispose(),this.children[0].material.dispose()}update(){const M=this.children[0];if(this.color!==void 0)this.material.color.set(this.color);else{const i=M.geometry.getAttribute("color");Dg.copy(this.light.color),du.copy(this.light.groundColor);for(let c=0,g=i.count;c<g;c++){const _=c<g/2?Dg:du;i.setXYZ(c,_.r,_.g,_.b)}i.needsUpdate=!0}M.lookAt(Js.setFromMatrixPosition(this.light.matrixWorld).negate())}},f.HemisphereLightProbe=Y_,f.IcosahedronBufferGeometry=Br,f.IcosahedronGeometry=Br,f.ImageBitmapLoader=Wc,f.ImageLoader=no,f.ImageUtils=Fs,f.ImmediateRenderObject=Am,f.IncrementStencilOp=7682,f.IncrementWrapStencilOp=34055,f.InstancedBufferAttribute=La,f.InstancedBufferGeometry=Ag,f.InstancedInterleavedBuffer=Pg,f.InstancedMesh=id,f.Int16Attribute=function(M,i){return console.warn("THREE.Int16Attribute has been removed. Use new THREE.Int16BufferAttribute() instead."),new ua(M,i)},f.Int16BufferAttribute=ua,f.Int32Attribute=function(M,i){return console.warn("THREE.Int32Attribute has been removed. Use new THREE.Int32BufferAttribute() instead."),new Do(M,i)},f.Int32BufferAttribute=Do,f.Int8Attribute=function(M,i){return console.warn("THREE.Int8Attribute has been removed. Use new THREE.Int8BufferAttribute() instead."),new Mo(M,i)},f.Int8BufferAttribute=Mo,f.IntType=1013,f.InterleavedBuffer=Pl,f.InterleavedBufferAttribute=ja,f.Interpolant=Nc,f.InterpolateDiscrete=2300,f.InterpolateLinear=2301,f.InterpolateSmooth=2302,f.InvertStencilOp=5386,f.JSONLoader=function(){console.error("THREE.JSONLoader has been removed.")},f.KeepStencilOp=7680,f.KeyframeTrack=dl,f.LOD=Vp,f.LatheBufferGeometry=Pt,f.LatheGeometry=Pt,f.Layers=ia,f.LensFlare=function(){console.error("THREE.LensFlare has been moved to /examples/jsm/objects/Lensflare.js")},f.LessDepth=2,f.LessEqualDepth=3,f.LessEqualStencilFunc=515,f.LessStencilFunc=513,f.Light=Da,f.LightProbe=Ts,f.Line=ul,f.Line3=sy,f.LineBasicMaterial=to,f.LineCurve=ct,f.LineCurve3=Ot,f.LineDashedMaterial=Xd,f.LineLoop=zc,f.LinePieces=1,f.LineSegments=$o,f.LineStrip=0,f.LinearEncoding=3e3,f.LinearFilter=1006,f.LinearInterpolant=$d,f.LinearMipMapLinearFilter=1008,f.LinearMipMapNearestFilter=1007,f.LinearMipmapLinearFilter=1008,f.LinearMipmapNearestFilter=1007,f.LinearToneMapping=1,f.Loader=Vo,f.LoaderUtils=bm,f.LoadingManager=Gc,f.LogLuvEncoding=3003,f.LoopOnce=2200,f.LoopPingPong=2202,f.LoopRepeat=2201,f.LuminanceAlphaFormat=1025,f.LuminanceFormat=1024,f.MOUSE={LEFT:0,MIDDLE:1,RIGHT:2,ROTATE:0,DOLLY:1,PAN:2},f.Material=Bi,f.MaterialLoader=Eg,f.Math=ho,f.MathUtils=ho,f.Matrix3=jr,f.Matrix4=Mn,f.MaxEquation=104,f.Mesh=oo,f.MeshBasicMaterial=fs,f.MeshDepthMaterial=Yu,f.MeshDistanceMaterial=Ju,f.MeshFaceMaterial=function(M){return console.warn("THREE.MeshFaceMaterial has been removed. Use an Array instead."),M},f.MeshLambertMaterial=Ao,f.MeshMatcapMaterial=rd,f.MeshNormalMaterial=dc,f.MeshPhongMaterial=lu,f.MeshPhysicalMaterial=Bc,f.MeshStandardMaterial=uc,f.MeshToonMaterial=cu,f.MinEquation=103,f.MirroredRepeatWrapping=1002,f.MixOperation=1,f.MultiMaterial=function(M=[]){return console.warn("THREE.MultiMaterial has been removed. Use an Array instead."),M.isMultiMaterial=!0,M.materials=M,M.clone=function(){return M.slice()},M},f.MultiplyBlending=4,f.MultiplyOperation=0,f.NearestFilter=1003,f.NearestMipMapLinearFilter=1005,f.NearestMipMapNearestFilter=1004,f.NearestMipmapLinearFilter=1005,f.NearestMipmapNearestFilter=1004,f.NeverDepth=0,f.NeverStencilFunc=512,f.NoBlending=0,f.NoColors=0,f.NoToneMapping=0,f.NormalAnimationBlendMode=2500,f.NormalBlending=1,f.NotEqualDepth=7,f.NotEqualStencilFunc=517,f.NumberKeyframeTrack=kl,f.Object3D=we,f.ObjectLoader=class extends Vo{constructor(M){super(M)}load(M,i,c,g){const _=this,w=this.path===""?bm.extractUrlBase(M):this.path;this.resourcePath=this.resourcePath||w;const A=new ml(this.manager);A.setPath(this.path),A.setRequestHeader(this.requestHeader),A.setWithCredentials(this.withCredentials),A.load(M,function(R){let z=null;try{z=JSON.parse(R)}catch(W){return g!==void 0&&g(W),void console.error("THREE:ObjectLoader: Can't parse "+M+".",W.message)}const F=z.metadata;F!==void 0&&F.type!==void 0&&F.type.toLowerCase()!=="geometry"?_.parse(z,i):console.error("THREE.ObjectLoader: Can't load "+M)},c,g)}async loadAsync(M,i){const c=this.path===""?bm.extractUrlBase(M):this.path;this.resourcePath=this.resourcePath||c;const g=new ml(this.manager);g.setPath(this.path),g.setRequestHeader(this.requestHeader),g.setWithCredentials(this.withCredentials);const _=await g.loadAsync(M,i),w=JSON.parse(_),A=w.metadata;if(A===void 0||A.type===void 0||A.type.toLowerCase()==="geometry")throw new Error("THREE.ObjectLoader: Can't load "+M);return await this.parseAsync(w)}parse(M,i){const c=this.parseAnimations(M.animations),g=this.parseShapes(M.shapes),_=this.parseGeometries(M.geometries,g),w=this.parseImages(M.images,function(){i!==void 0&&i(z)}),A=this.parseTextures(M.textures,w),R=this.parseMaterials(M.materials,A),z=this.parseObject(M.object,_,R,A,c),F=this.parseSkeletons(M.skeletons,z);if(this.bindSkeletons(z,F),i!==void 0){let W=!1;for(const q in w)if(w[q]instanceof HTMLImageElement){W=!0;break}W===!1&&i(z)}return z}async parseAsync(M){const i=this.parseAnimations(M.animations),c=this.parseShapes(M.shapes),g=this.parseGeometries(M.geometries,c),_=await this.parseImagesAsync(M.images),w=this.parseTextures(M.textures,_),A=this.parseMaterials(M.materials,w),R=this.parseObject(M.object,g,A,w,i),z=this.parseSkeletons(M.skeletons,R);return this.bindSkeletons(R,z),R}parseShapes(M){const i={};if(M!==void 0)for(let c=0,g=M.length;c<g;c++){const _=new jc().fromJSON(M[c]);i[_.uuid]=_}return i}parseSkeletons(M,i){const c={},g={};if(i.traverse(function(_){_.isBone&&(g[_.uuid]=_)}),M!==void 0)for(let _=0,w=M.length;_<w;_++){const A=new nu().fromJSON(M[_],g);c[A.uuid]=A}return c}parseGeometries(M,i){const c={};if(M!==void 0){const g=new Jd;for(let _=0,w=M.length;_<w;_++){let A;const R=M[_];switch(R.type){case"BufferGeometry":case"InstancedBufferGeometry":A=g.parse(R);break;case"Geometry":console.error("THREE.ObjectLoader: The legacy Geometry type is no longer supported.");break;default:R.type in Mh?A=Mh[R.type].fromJSON(R,i):console.warn(`THREE.ObjectLoader: Unsupported geometry type "${R.type}"`)}A.uuid=R.uuid,R.name!==void 0&&(A.name=R.name),A.isBufferGeometry===!0&&R.userData!==void 0&&(A.userData=R.userData),c[R.uuid]=A}}return c}parseMaterials(M,i){const c={},g={};if(M!==void 0){const _=new Eg;_.setTextures(i);for(let w=0,A=M.length;w<A;w++){const R=M[w];if(R.type==="MultiMaterial"){const z=[];for(let F=0;F<R.materials.length;F++){const W=R.materials[F];c[W.uuid]===void 0&&(c[W.uuid]=_.parse(W)),z.push(c[W.uuid])}g[R.uuid]=z}else c[R.uuid]===void 0&&(c[R.uuid]=_.parse(R)),g[R.uuid]=c[R.uuid]}}return g}parseAnimations(M){const i={};if(M!==void 0)for(let c=0;c<M.length;c++){const g=M[c],_=od.parse(g);i[_.uuid]=_}return i}parseImages(M,i){const c=this,g={};let _;function w(A){if(typeof A=="string"){const R=A;return function(z){return c.manager.itemStart(z),_.load(z,function(){c.manager.itemEnd(z)},void 0,function(){c.manager.itemError(z),c.manager.itemEnd(z)})}(/^(\/\/)|([a-z]+:(\/\/)?)/i.test(R)?R:c.resourcePath+R)}return A.data?{data:qo(A.type,A.data),width:A.width,height:A.height}:null}if(M!==void 0&&M.length>0){const A=new Gc(i);_=new no(A),_.setCrossOrigin(this.crossOrigin);for(let R=0,z=M.length;R<z;R++){const F=M[R],W=F.url;if(Array.isArray(W)){g[F.uuid]=[];for(let q=0,J=W.length;q<J;q++){const K=w(W[q]);K!==null&&(K instanceof HTMLImageElement?g[F.uuid].push(K):g[F.uuid].push(new Dl(K.data,K.width,K.height)))}}else{const q=w(F.url);q!==null&&(g[F.uuid]=q)}}}return g}async parseImagesAsync(M){const i=this,c={};let g;async function _(w){if(typeof w=="string"){const A=w,R=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(A)?A:i.resourcePath+A;return await g.loadAsync(R)}return w.data?{data:qo(w.type,w.data),width:w.width,height:w.height}:null}if(M!==void 0&&M.length>0){g=new no(this.manager),g.setCrossOrigin(this.crossOrigin);for(let w=0,A=M.length;w<A;w++){const R=M[w],z=R.url;if(Array.isArray(z)){c[R.uuid]=[];for(let F=0,W=z.length;F<W;F++){const q=z[F],J=await _(q);J!==null&&(J instanceof HTMLImageElement?c[R.uuid].push(J):c[R.uuid].push(new Dl(J.data,J.width,J.height)))}}else{const F=await _(R.url);F!==null&&(c[R.uuid]=F)}}}return c}parseTextures(M,i){function c(_,w){return typeof _=="number"?_:(console.warn("THREE.ObjectLoader.parseTexture: Constant should be in numeric form.",_),w[_])}const g={};if(M!==void 0)for(let _=0,w=M.length;_<w;_++){const A=M[_];let R;A.image===void 0&&console.warn('THREE.ObjectLoader: No "image" specified for',A.uuid),i[A.image]===void 0&&console.warn("THREE.ObjectLoader: Undefined image",A.image);const z=i[A.image];Array.isArray(z)?(R=new il(z),z.length===6&&(R.needsUpdate=!0)):(R=z&&z.data?new Dl(z.data,z.width,z.height):new ds(z),z&&(R.needsUpdate=!0)),R.uuid=A.uuid,A.name!==void 0&&(R.name=A.name),A.mapping!==void 0&&(R.mapping=c(A.mapping,$_)),A.offset!==void 0&&R.offset.fromArray(A.offset),A.repeat!==void 0&&R.repeat.fromArray(A.repeat),A.center!==void 0&&R.center.fromArray(A.center),A.rotation!==void 0&&(R.rotation=A.rotation),A.wrap!==void 0&&(R.wrapS=c(A.wrap[0],wm),R.wrapT=c(A.wrap[1],wm)),A.format!==void 0&&(R.format=A.format),A.type!==void 0&&(R.type=A.type),A.encoding!==void 0&&(R.encoding=A.encoding),A.minFilter!==void 0&&(R.minFilter=c(A.minFilter,Kp)),A.magFilter!==void 0&&(R.magFilter=c(A.magFilter,Kp)),A.anisotropy!==void 0&&(R.anisotropy=A.anisotropy),A.flipY!==void 0&&(R.flipY=A.flipY),A.premultiplyAlpha!==void 0&&(R.premultiplyAlpha=A.premultiplyAlpha),A.unpackAlignment!==void 0&&(R.unpackAlignment=A.unpackAlignment),g[A.uuid]=R}return g}parseObject(M,i,c,g,_){let w,A,R;function z(q){return i[q]===void 0&&console.warn("THREE.ObjectLoader: Undefined geometry",q),i[q]}function F(q){if(q!==void 0){if(Array.isArray(q)){const J=[];for(let K=0,re=q.length;K<re;K++){const ce=q[K];c[ce]===void 0&&console.warn("THREE.ObjectLoader: Undefined material",ce),J.push(c[ce])}return J}return c[q]===void 0&&console.warn("THREE.ObjectLoader: Undefined material",q),c[q]}}function W(q){return g[q]===void 0&&console.warn("THREE.ObjectLoader: Undefined texture",q),g[q]}switch(M.type){case"Scene":w=new Lc,M.background!==void 0&&(Number.isInteger(M.background)?w.background=new un(M.background):w.background=W(M.background)),M.environment!==void 0&&(w.environment=W(M.environment)),M.fog!==void 0&&(M.fog.type==="Fog"?w.fog=new Ca(M.fog.color,M.fog.near,M.fog.far):M.fog.type==="FogExp2"&&(w.fog=new Oo(M.fog.color,M.fog.density)));break;case"PerspectiveCamera":w=new go(M.fov,M.aspect,M.near,M.far),M.focus!==void 0&&(w.focus=M.focus),M.zoom!==void 0&&(w.zoom=M.zoom),M.filmGauge!==void 0&&(w.filmGauge=M.filmGauge),M.filmOffset!==void 0&&(w.filmOffset=M.filmOffset),M.view!==void 0&&(w.view=Object.assign({},M.view));break;case"OrthographicCamera":w=new Hh(M.left,M.right,M.top,M.bottom,M.near,M.far),M.zoom!==void 0&&(w.zoom=M.zoom),M.view!==void 0&&(w.view=Object.assign({},M.view));break;case"AmbientLight":w=new vm(M.color,M.intensity);break;case"DirectionalLight":w=new xm(M.color,M.intensity);break;case"PointLight":w=new ym(M.color,M.intensity,M.distance,M.decay);break;case"RectAreaLight":w=new Tg(M.color,M.intensity,M.width,M.height);break;case"SpotLight":w=new gm(M.color,M.intensity,M.distance,M.angle,M.penumbra,M.decay);break;case"HemisphereLight":w=new Yp(M.color,M.groundColor,M.intensity);break;case"LightProbe":w=new Ts().fromJSON(M);break;case"SkinnedMesh":A=z(M.geometry),R=F(M.material),w=new Xo(A,R),M.bindMode!==void 0&&(w.bindMode=M.bindMode),M.bindMatrix!==void 0&&w.bindMatrix.fromArray(M.bindMatrix),M.skeleton!==void 0&&(w.skeleton=M.skeleton);break;case"Mesh":A=z(M.geometry),R=F(M.material),w=new oo(A,R);break;case"InstancedMesh":A=z(M.geometry),R=F(M.material);const q=M.count,J=M.instanceMatrix,K=M.instanceColor;w=new id(A,R,q),w.instanceMatrix=new La(new Float32Array(J.array),16),K!==void 0&&(w.instanceColor=new La(new Float32Array(K.array),K.itemSize));break;case"LOD":w=new Vp;break;case"Line":w=new ul(z(M.geometry),F(M.material));break;case"LineLoop":w=new zc(z(M.geometry),F(M.material));break;case"LineSegments":w=new $o(z(M.geometry),F(M.material));break;case"PointCloud":case"Points":w=new au(z(M.geometry),F(M.material));break;case"Sprite":w=new bh(F(M.material));break;case"Group":w=new yh;break;case"Bone":w=new iu;break;default:w=new we}if(w.uuid=M.uuid,M.name!==void 0&&(w.name=M.name),M.matrix!==void 0?(w.matrix.fromArray(M.matrix),M.matrixAutoUpdate!==void 0&&(w.matrixAutoUpdate=M.matrixAutoUpdate),w.matrixAutoUpdate&&w.matrix.decompose(w.position,w.quaternion,w.scale)):(M.position!==void 0&&w.position.fromArray(M.position),M.rotation!==void 0&&w.rotation.fromArray(M.rotation),M.quaternion!==void 0&&w.quaternion.fromArray(M.quaternion),M.scale!==void 0&&w.scale.fromArray(M.scale)),M.castShadow!==void 0&&(w.castShadow=M.castShadow),M.receiveShadow!==void 0&&(w.receiveShadow=M.receiveShadow),M.shadow&&(M.shadow.bias!==void 0&&(w.shadow.bias=M.shadow.bias),M.shadow.normalBias!==void 0&&(w.shadow.normalBias=M.shadow.normalBias),M.shadow.radius!==void 0&&(w.shadow.radius=M.shadow.radius),M.shadow.mapSize!==void 0&&w.shadow.mapSize.fromArray(M.shadow.mapSize),M.shadow.camera!==void 0&&(w.shadow.camera=this.parseObject(M.shadow.camera))),M.visible!==void 0&&(w.visible=M.visible),M.frustumCulled!==void 0&&(w.frustumCulled=M.frustumCulled),M.renderOrder!==void 0&&(w.renderOrder=M.renderOrder),M.userData!==void 0&&(w.userData=M.userData),M.layers!==void 0&&(w.layers.mask=M.layers),M.children!==void 0){const q=M.children;for(let J=0;J<q.length;J++)w.add(this.parseObject(q[J],i,c,g,_))}if(M.animations!==void 0){const q=M.animations;for(let J=0;J<q.length;J++){const K=q[J];w.animations.push(_[K])}}if(M.type==="LOD"){M.autoUpdate!==void 0&&(w.autoUpdate=M.autoUpdate);const q=M.levels;for(let J=0;J<q.length;J++){const K=q[J],re=w.getObjectByProperty("uuid",K.object);re!==void 0&&w.addLevel(re,K.distance)}}return w}bindSkeletons(M,i){Object.keys(i).length!==0&&M.traverse(function(c){if(c.isSkinnedMesh===!0&&c.skeleton!==void 0){const g=i[c.skeleton];g===void 0?console.warn("THREE.ObjectLoader: No skeleton found with UUID:",c.skeleton):c.bind(g,c.bindMatrix)}})}setTexturePath(M){return console.warn("THREE.ObjectLoader: .setTexturePath() has been renamed to .setResourcePath()."),this.setResourcePath(M)}},f.ObjectSpaceNormalMap=1,f.OctahedronBufferGeometry=ao,f.OctahedronGeometry=ao,f.OneFactor=201,f.OneMinusDstAlphaFactor=207,f.OneMinusDstColorFactor=209,f.OneMinusSrcAlphaFactor=205,f.OneMinusSrcColorFactor=203,f.OrthographicCamera=Hh,f.PCFShadowMap=1,f.PCFSoftShadowMap=2,f.PMREMGenerator=Ou,f.ParametricBufferGeometry=yo,f.ParametricGeometry=yo,f.Particle=function(M){return console.warn("THREE.Particle has been renamed to THREE.Sprite."),new bh(M)},f.ParticleBasicMaterial=function(M){return console.warn("THREE.ParticleBasicMaterial has been renamed to THREE.PointsMaterial."),new Oc(M)},f.ParticleSystem=function(M,i){return console.warn("THREE.ParticleSystem has been renamed to THREE.Points."),new au(M,i)},f.ParticleSystemMaterial=function(M){return console.warn("THREE.ParticleSystemMaterial has been renamed to THREE.PointsMaterial."),new Oc(M)},f.Path=Hc,f.PerspectiveCamera=go,f.Plane=Ma,f.PlaneBufferGeometry=nc,f.PlaneGeometry=nc,f.PlaneHelper=class extends ul{constructor(M,i=1,c=16776960){const g=c,_=new Er;_.setAttribute("position",new Kn([1,-1,1,-1,1,1,-1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,0,0,1,0,0,0],3)),_.computeBoundingSphere(),super(_,new to({color:g,toneMapped:!1})),this.type="PlaneHelper",this.plane=M,this.size=i;const w=new Er;w.setAttribute("position",new Kn([1,1,1,-1,1,1,-1,-1,1,1,1,1,-1,-1,1,1,-1,1],3)),w.computeBoundingSphere(),this.add(new oo(w,new fs({color:g,opacity:.2,transparent:!0,depthWrite:!1,toneMapped:!1})))}updateMatrixWorld(M){let i=-this.plane.constant;Math.abs(i)<1e-8&&(i=1e-8),this.scale.set(.5*this.size,.5*this.size,i),this.children[0].material.side=i<0?1:0,this.lookAt(this.plane.normal),super.updateMatrixWorld(M)}},f.PointCloud=function(M,i){return console.warn("THREE.PointCloud has been renamed to THREE.Points."),new au(M,i)},f.PointCloudMaterial=function(M){return console.warn("THREE.PointCloudMaterial has been renamed to THREE.PointsMaterial."),new Oc(M)},f.PointLight=ym,f.PointLightHelper=class extends oo{constructor(M,i,c){super(new Uo(i,4,2),new fs({wireframe:!0,fog:!1,toneMapped:!1})),this.light=M,this.light.updateMatrixWorld(),this.color=c,this.type="PointLightHelper",this.matrix=this.light.matrixWorld,this.matrixAutoUpdate=!1,this.update()}dispose(){this.geometry.dispose(),this.material.dispose()}update(){this.color!==void 0?this.material.color.set(this.color):this.material.color.copy(this.light.color)}},f.Points=au,f.PointsMaterial=Oc,f.PolarGridHelper=class extends $o{constructor(M=10,i=16,c=8,g=64,_=4473924,w=8947848){_=new un(_),w=new un(w);const A=[],R=[];for(let F=0;F<=i;F++){const W=F/i*(2*Math.PI),q=Math.sin(W)*M,J=Math.cos(W)*M;A.push(0,0,0),A.push(q,0,J);const K=1&F?_:w;R.push(K.r,K.g,K.b),R.push(K.r,K.g,K.b)}for(let F=0;F<=c;F++){const W=1&F?_:w,q=M-M/c*F;for(let J=0;J<g;J++){let K=J/g*(2*Math.PI),re=Math.sin(K)*q,ce=Math.cos(K)*q;A.push(re,0,ce),R.push(W.r,W.g,W.b),K=(J+1)/g*(2*Math.PI),re=Math.sin(K)*q,ce=Math.cos(K)*q,A.push(re,0,ce),R.push(W.r,W.g,W.b)}}const z=new Er;z.setAttribute("position",new Kn(A,3)),z.setAttribute("color",new Kn(R,3)),super(z,new to({vertexColors:!0,toneMapped:!1})),this.type="PolarGridHelper"}},f.PolyhedronBufferGeometry=T,f.PolyhedronGeometry=T,f.PositionalAudio=class extends qc{constructor(M){super(M),this.panner=this.context.createPanner(),this.panner.panningModel="HRTF",this.panner.connect(this.gain)}getOutput(){return this.panner}getRefDistance(){return this.panner.refDistance}setRefDistance(M){return this.panner.refDistance=M,this}getRolloffFactor(){return this.panner.rolloffFactor}setRolloffFactor(M){return this.panner.rolloffFactor=M,this}getDistanceModel(){return this.panner.distanceModel}setDistanceModel(M){return this.panner.distanceModel=M,this}getMaxDistance(){return this.panner.maxDistance}setMaxDistance(M){return this.panner.maxDistance=M,this}setDirectionalCone(M,i,c){return this.panner.coneInnerAngle=M,this.panner.coneOuterAngle=i,this.panner.coneOuterGain=c,this}updateMatrixWorld(M){if(super.updateMatrixWorld(M),this.hasPlaybackControl===!0&&this.isPlaying===!1)return;this.matrixWorld.decompose(gl,Ph,W0),ld.set(0,0,1).applyQuaternion(Ph);const i=this.panner;if(i.positionX){const c=this.context.currentTime+this.listener.timeDelta;i.positionX.linearRampToValueAtTime(gl.x,c),i.positionY.linearRampToValueAtTime(gl.y,c),i.positionZ.linearRampToValueAtTime(gl.z,c),i.orientationX.linearRampToValueAtTime(ld.x,c),i.orientationY.linearRampToValueAtTime(ld.y,c),i.orientationZ.linearRampToValueAtTime(ld.z,c)}else i.setPosition(gl.x,gl.y,gl.z),i.setOrientation(ld.x,ld.y,ld.z)}},f.PropertyBinding=us,f.PropertyMixer=ey,f.QuadraticBezierCurve=mt,f.QuadraticBezierCurve3=it,f.Quaternion=Rs,f.QuaternionKeyframeTrack=Ch,f.QuaternionLinearInterpolant=Ah,f.REVISION=C,f.RGBADepthPacking=3201,f.RGBAFormat=1023,f.RGBAIntegerFormat=1033,f.RGBA_ASTC_10x10_Format=37819,f.RGBA_ASTC_10x5_Format=37816,f.RGBA_ASTC_10x6_Format=37817,f.RGBA_ASTC_10x8_Format=37818,f.RGBA_ASTC_12x10_Format=37820,f.RGBA_ASTC_12x12_Format=37821,f.RGBA_ASTC_4x4_Format=37808,f.RGBA_ASTC_5x4_Format=37809,f.RGBA_ASTC_5x5_Format=37810,f.RGBA_ASTC_6x5_Format=37811,f.RGBA_ASTC_6x6_Format=37812,f.RGBA_ASTC_8x5_Format=37813,f.RGBA_ASTC_8x6_Format=37814,f.RGBA_ASTC_8x8_Format=37815,f.RGBA_BPTC_Format=36492,f.RGBA_ETC2_EAC_Format=37496,f.RGBA_PVRTC_2BPPV1_Format=35843,f.RGBA_PVRTC_4BPPV1_Format=35842,f.RGBA_S3TC_DXT1_Format=33777,f.RGBA_S3TC_DXT3_Format=33778,f.RGBA_S3TC_DXT5_Format=33779,f.RGBDEncoding=3006,f.RGBEEncoding=3002,f.RGBEFormat=1023,f.RGBFormat=1022,f.RGBIntegerFormat=1032,f.RGBM16Encoding=3005,f.RGBM7Encoding=3004,f.RGB_ETC1_Format=36196,f.RGB_ETC2_Format=37492,f.RGB_PVRTC_2BPPV1_Format=35841,f.RGB_PVRTC_4BPPV1_Format=35840,f.RGB_S3TC_DXT1_Format=33776,f.RGFormat=1030,f.RGIntegerFormat=1031,f.RawShaderMaterial=Ll,f.Ray=br,f.Raycaster=class{constructor(M,i,c=0,g=1/0){this.ray=new br(M,i),this.near=c,this.far=g,this.camera=null,this.layers=new ia,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}}}set(M,i){this.ray.set(M,i)}setFromCamera(M,i){i&&i.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(i.matrixWorld),this.ray.direction.set(M.x,M.y,.5).unproject(i).sub(this.ray.origin).normalize(),this.camera=i):i&&i.isOrthographicCamera?(this.ray.origin.set(M.x,M.y,(i.near+i.far)/(i.near-i.far)).unproject(i),this.ray.direction.set(0,0,-1).transformDirection(i.matrixWorld),this.camera=i):console.error("THREE.Raycaster: Unsupported camera type: "+i.type)}intersectObject(M,i=!1,c=[]){return Sm(M,this,c,i),c.sort(uu),c}intersectObjects(M,i=!1,c=[]){for(let g=0,_=M.length;g<_;g++)Sm(M[g],this,c,i);return c.sort(uu),c}},f.RectAreaLight=Tg,f.RedFormat=1028,f.RedIntegerFormat=1029,f.ReinhardToneMapping=2,f.RepeatWrapping=1e3,f.ReplaceStencilOp=7681,f.ReverseSubtractEquation=102,f.RingBufferGeometry=Ys,f.RingGeometry=Ys,f.SRGB8_ALPHA8_ASTC_10x10_Format=37851,f.SRGB8_ALPHA8_ASTC_10x5_Format=37848,f.SRGB8_ALPHA8_ASTC_10x6_Format=37849,f.SRGB8_ALPHA8_ASTC_10x8_Format=37850,f.SRGB8_ALPHA8_ASTC_12x10_Format=37852,f.SRGB8_ALPHA8_ASTC_12x12_Format=37853,f.SRGB8_ALPHA8_ASTC_4x4_Format=37840,f.SRGB8_ALPHA8_ASTC_5x4_Format=37841,f.SRGB8_ALPHA8_ASTC_5x5_Format=37842,f.SRGB8_ALPHA8_ASTC_6x5_Format=37843,f.SRGB8_ALPHA8_ASTC_6x6_Format=37844,f.SRGB8_ALPHA8_ASTC_8x5_Format=37845,f.SRGB8_ALPHA8_ASTC_8x6_Format=37846,f.SRGB8_ALPHA8_ASTC_8x8_Format=37847,f.Scene=Lc,f.SceneUtils=kg,f.ShaderChunk=es,f.ShaderLib=Ta,f.ShaderMaterial=tl,f.ShadowMaterial=Th,f.Shape=jc,f.ShapeBufferGeometry=io,f.ShapeGeometry=io,f.ShapePath=Qp,f.ShapeUtils=Ur,f.ShortType=1011,f.Skeleton=nu,f.SkeletonHelper=Co,f.SkinnedMesh=Xo,f.SmoothShading=2,f.Sphere=Bn,f.SphereBufferGeometry=Uo,f.SphereGeometry=Uo,f.Spherical=class{constructor(M=1,i=0,c=0){return this.radius=M,this.phi=i,this.theta=c,this}set(M,i,c){return this.radius=M,this.phi=i,this.theta=c,this}copy(M){return this.radius=M.radius,this.phi=M.phi,this.theta=M.theta,this}makeSafe(){return this.phi=Math.max(1e-6,Math.min(Math.PI-1e-6,this.phi)),this}setFromVector3(M){return this.setFromCartesianCoords(M.x,M.y,M.z)}setFromCartesianCoords(M,i,c){return this.radius=Math.sqrt(M*M+i*i+c*c),this.radius===0?(this.theta=0,this.phi=0):(this.theta=Math.atan2(M,c),this.phi=Math.acos(Jn(i/this.radius,-1,1))),this}clone(){return new this.constructor().copy(this)}},f.SphericalHarmonics3=Sg,f.SplineCurve=Nt,f.SpotLight=gm,f.SpotLightHelper=class extends we{constructor(M,i){super(),this.light=M,this.light.updateMatrixWorld(),this.matrix=M.matrixWorld,this.matrixAutoUpdate=!1,this.color=i;const c=new Er,g=[0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,-1,0,1,0,0,0,0,1,1,0,0,0,0,-1,1];for(let w=0,A=1,R=32;w<R;w++,A++){const z=w/R*Math.PI*2,F=A/R*Math.PI*2;g.push(Math.cos(z),Math.sin(z),1,Math.cos(F),Math.sin(F),1)}c.setAttribute("position",new Kn(g,3));const _=new to({fog:!1,toneMapped:!1});this.cone=new $o(c,_),this.add(this.cone),this.update()}dispose(){this.cone.geometry.dispose(),this.cone.material.dispose()}update(){this.light.updateMatrixWorld();const M=this.light.distance?this.light.distance:1e3,i=M*Math.tan(this.light.angle);this.cone.scale.set(i,i,M),mc.setFromMatrixPosition(this.light.target.matrixWorld),this.cone.lookAt(mc),this.color!==void 0?this.cone.material.color.set(this.color):this.cone.material.color.copy(this.light.color)}},f.Sprite=bh,f.SpriteMaterial=cc,f.SrcAlphaFactor=204,f.SrcAlphaSaturateFactor=210,f.SrcColorFactor=202,f.StaticCopyUsage=35046,f.StaticDrawUsage=35044,f.StaticReadUsage=35045,f.StereoCamera=class{constructor(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new go,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new go,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1,this._cache={focus:null,fov:null,aspect:null,near:null,far:null,zoom:null,eyeSep:null}}update(M){const i=this._cache;if(i.focus!==M.focus||i.fov!==M.fov||i.aspect!==M.aspect*this.aspect||i.near!==M.near||i.far!==M.far||i.zoom!==M.zoom||i.eyeSep!==this.eyeSep){i.focus=M.focus,i.fov=M.fov,i.aspect=M.aspect*this.aspect,i.near=M.near,i.far=M.far,i.zoom=M.zoom,i.eyeSep=this.eyeSep;const c=M.projectionMatrix.clone(),g=i.eyeSep/2,_=g*i.near/i.focus,w=i.near*Math.tan(kn*i.fov*.5)/i.zoom;let A,R;K_.elements[12]=-g,J_.elements[12]=g,A=-w*i.aspect+_,R=w*i.aspect+_,c.elements[0]=2*i.near/(R-A),c.elements[8]=(R+A)/(R-A),this.cameraL.projectionMatrix.copy(c),A=-w*i.aspect-_,R=w*i.aspect-_,c.elements[0]=2*i.near/(R-A),c.elements[8]=(R+A)/(R-A),this.cameraR.projectionMatrix.copy(c)}this.cameraL.matrixWorld.copy(M.matrixWorld).multiply(K_),this.cameraR.matrixWorld.copy(M.matrixWorld).multiply(J_)}},f.StreamCopyUsage=35042,f.StreamDrawUsage=35040,f.StreamReadUsage=35041,f.StringKeyframeTrack=Vc,f.SubtractEquation=101,f.SubtractiveBlending=3,f.TOUCH={ROTATE:0,PAN:1,DOLLY_PAN:2,DOLLY_ROTATE:3},f.TangentSpaceNormalMap=0,f.TetrahedronBufferGeometry=ga,f.TetrahedronGeometry=ga,f.TextBufferGeometry=Yo,f.TextGeometry=Yo,f.Texture=ds,f.TextureLoader=hu,f.TorusBufferGeometry=Ia,f.TorusGeometry=Ia,f.TorusKnotBufferGeometry=Pa,f.TorusKnotGeometry=Pa,f.Triangle=Zi,f.TriangleFanDrawMode=2,f.TriangleStripDrawMode=1,f.TrianglesDrawMode=0,f.TubeBufferGeometry=Ra,f.TubeGeometry=Ra,f.UVMapping=300,f.Uint16Attribute=function(M,i){return console.warn("THREE.Uint16Attribute has been removed. Use new THREE.Uint16BufferAttribute() instead."),new Ls(M,i)},f.Uint16BufferAttribute=Ls,f.Uint32Attribute=function(M,i){return console.warn("THREE.Uint32Attribute has been removed. Use new THREE.Uint32BufferAttribute() instead."),new Xs(M,i)},f.Uint32BufferAttribute=Xs,f.Uint8Attribute=function(M,i){return console.warn("THREE.Uint8Attribute has been removed. Use new THREE.Uint8BufferAttribute() instead."),new To(M,i)},f.Uint8BufferAttribute=To,f.Uint8ClampedAttribute=function(M,i){return console.warn("THREE.Uint8ClampedAttribute has been removed. Use new THREE.Uint8ClampedBufferAttribute() instead."),new Ds(M,i)},f.Uint8ClampedBufferAttribute=Ds,f.Uniform=fc,f.UniformsLib=On,f.UniformsUtils=Iu,f.UnsignedByteType=1009,f.UnsignedInt248Type=1020,f.UnsignedIntType=1014,f.UnsignedShort4444Type=1017,f.UnsignedShort5551Type=1018,f.UnsignedShort565Type=1019,f.UnsignedShortType=1012,f.VSMShadowMap=3,f.Vector2=Ri,f.Vector3=et,f.Vector4=Mr,f.VectorKeyframeTrack=sd,f.Vertex=function(M,i,c){return console.warn("THREE.Vertex has been removed. Use THREE.Vector3 instead."),new et(M,i,c)},f.VertexColors=2,f.VideoTexture=$p,f.WebGL1Renderer=xh,f.WebGLCubeRenderTarget=lh,f.WebGLMultipleRenderTargets=js,f.WebGLMultisampleRenderTarget=Wo,f.WebGLRenderTarget=Bs,f.WebGLRenderTargetCube=function(M,i,c){return console.warn("THREE.WebGLRenderTargetCube( width, height, options ) is now WebGLCubeRenderTarget( size, options )."),new lh(M,c)},f.WebGLRenderer=cs,f.WebGLUtils=Np,f.WireframeGeometry=qa,f.WireframeHelper=function(M,i){return console.warn("THREE.WireframeHelper has been removed. Use THREE.WireframeGeometry instead."),new $o(new qa(M.geometry),new to({color:i!==void 0?i:16777215}))},f.WrapAroundEnding=2402,f.XHRLoader=function(M){return console.warn("THREE.XHRLoader has been renamed to THREE.FileLoader."),new ml(M)},f.ZeroCurvatureEnding=2400,f.ZeroFactor=200,f.ZeroSlopeEnding=2401,f.ZeroStencilOp=0,f.sRGBEncoding=3001,Object.defineProperty(f,"__esModule",{value:!0})})})(U0,U0.exports);var va=U0.exports,o1={exports:{}};(function(te,p){const C=.0005555555555555556*Math.PI,D=Math.atan(3/4),U=63710088e-1,B=40075017;te.exports={WORLD_SIZE:1024e3,PROJECTION_WORLD_SIZE:1024e3/(U*Math.PI*2),MERCATOR_A:U,DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,EARTH_RADIUS:U,EARTH_CIRCUMFERENCE:2*Math.PI*U,EARTH_CIRCUMFERENCE_EQUATOR:B,FOV_ORTHO:C,FOV:D,FOV_DEGREES:D*180/Math.PI,TILE_SIZE:512}})(o1);var V0=o1.exports,a1={exports:{}};(function(te,p){function f(){}f.prototype={Coords:function(C){if(C.constructor!==Array){console.error("Coords must be an array");return}if(C.length<2){console.error("Coords length must be at least 2");return}for(const D of C)if(D.constructor!==Number){console.error("Coords values must be numbers");return}if(Math.abs(C[1])>90){console.error("Latitude must be between -90 and 90");return}return C},Line:function(C){var D=this;if(C.constructor!==Array){console.error("Line must be an array");return}for(const U of C)if(!D.Coords(U)){console.error("Each coordinate in a line must be a valid Coords type");return}return C},Rotation:function(C){if(C.constructor===Number)C={z:C};else if(C.constructor===Object)for(const D of Object.keys(C)){if(!["x","y","z"].includes(D)){console.error("Rotation parameters must be x, y, or z");return}if(C[D].constructor!==Number){console.error("Individual rotation values must be numbers");return}}else{console.error("Rotation must be an object or a number");return}return C},Scale:function(C){if(C.constructor===Number)C={x:C,y:C,z:C};else if(C.constructor===Object)for(const D of Object.keys(C)){if(!["x","y","z"].includes(D)){console.error("Scale parameters must be x, y, or z");return}if(C[D].constructor!==Number){console.error("Individual scale values must be numbers");return}}else{console.error("Scale must be an object or a number");return}return C}},te.exports=f})(a1);var cA=a1.exports;(function(te,p){var f=va,C=V0,D=cA,U={prettyPrintMatrix:function(B){for(var s=0;s<4;s++){var Z=[B[s],B[s+4],B[s+8],B[s+12]];console.log(Z.map(function(j){return j.toFixed(4)}))}},makePerspectiveMatrix:function(B,s,Z,j){var Q=new f.Matrix4,oe=1/Math.tan(B/2),ve=1/(Z-j),Ee=[oe/s,0,0,0,0,oe,0,0,0,0,(j+Z)*ve,-1,0,0,2*j*Z*ve,0];return Q.elements=Ee,Q},makeOrthographicMatrix:function(B,s,Z,j,Q,oe){var ve=new f.Matrix4;const Ee=1/(s-B),We=1/(Z-j),Re=1/(oe-Q),He=(s+B)*Ee,Mt=(Z+j)*We,Lt=Q*Re;var Ut=[2*Ee,0,0,0,0,2*We,0,0,0,0,-1*Re,0,-He,-Mt,-Lt,1];return ve.elements=Ut,ve},radify:function(B){function s(Z){return Z=Z||0,Math.PI*2*Z/360}return typeof B=="object"?B.length>0?B.map(function(Z){return s(Z)}):[s(B.x),s(B.y),s(B.z)]:s(B)},degreeify:function(B){function s(Z){return Z=Z||0,Z*360/(Math.PI*2)}return typeof B=="object"?[s(B.x),s(B.y),s(B.z)]:s(B)},projectToWorld:function(B){var s=[-C.MERCATOR_A*C.DEG2RAD*B[0]*C.PROJECTION_WORLD_SIZE,-C.MERCATOR_A*Math.log(Math.tan(Math.PI*.25+.5*C.DEG2RAD*B[1]))*C.PROJECTION_WORLD_SIZE];if(!B[2])s.push(0);else{var Z=this.projectedUnitsPerMeter(B[1]);s.push(B[2]*Z)}var j=new f.Vector3(s[0],s[1],s[2]);return j},projectedUnitsPerMeter:function(B){return Math.abs(C.WORLD_SIZE/Math.cos(C.DEG2RAD*B)/C.EARTH_CIRCUMFERENCE)},_circumferenceAtLatitude:function(B){return C.EARTH_CIRCUMFERENCE*Math.cos(B*Math.PI/180)},mercatorZfromAltitude:function(B,s){return B/this._circumferenceAtLatitude(s)},_scaleVerticesToMeters:function(B,s){var Z=this.projectedUnitsPerMeter(B[1]);this.projectToWorld(B);for(var j=0;j<s.length;j++)s[j].multiplyScalar(Z);return s},projectToScreen:function(B){console.log("WARNING: Projecting to screen coordinates is not yet implemented")},unprojectFromScreen:function(B){console.log("WARNING: unproject is not yet implemented")},unprojectFromWorld:function(B){var s=[-B.x/(C.MERCATOR_A*C.DEG2RAD*C.PROJECTION_WORLD_SIZE),2*(Math.atan(Math.exp(B.y/(C.PROJECTION_WORLD_SIZE*-C.MERCATOR_A)))-Math.PI/4)/C.DEG2RAD],Z=this.projectedUnitsPerMeter(s[1]),j=B.z||0;return s.push(j/Z),s},toScreenPosition:function(B,s){var Z=new f.Vector3,j=.5*renderer.context.canvas.width,Q=.5*renderer.context.canvas.height;return B.updateMatrixWorld(),Z.setFromMatrixPosition(B.matrixWorld),Z.project(s),Z.x=Z.x*j+j,Z.y=-(Z.y*Q)+Q,{x:Z.x,y:Z.y}},getFeatureCenter:function(s,Z,j){let Q=[],oe=0,ve=0,Ee=0,We=[...s.geometry.coordinates[0]];return s.geometry.type==="Point"?Q=[...We[0]]:(s.geometry.type==="MultiPolygon"&&(We=We[0]),We.splice(-1,1),We.forEach(function(Re){oe+=Re[0],ve+=Re[1]}),Q=[oe/We.length,ve/We.length]),Ee=this.getObjectHeightOnFloor(s,Z,j),Q.length<3?Q.push(Ee):Q[2]=Ee,Q},getObjectHeightOnFloor:function(B,s,Z=B.properties.level||0){let j=Z*(B.properties.levelHeight||0),Q=B.properties.base_height||B.properties.min_height||0,ve=(s&&s.model?0:B.properties.height-Q)+Q;return j+ve},_flipMaterialSides:function(B){},normalizeVertices(B){let s=new f.BufferGeometry,Z=[];for(var j=0;j<B.length;j++){let ve=B[j];Z.push(ve.x,ve.y,ve.z),Z.push(ve.x,ve.y,ve.z)}s.setAttribute("position",new f.BufferAttribute(new Float32Array(Z),3)),s.computeBoundingSphere();var Q=s.boundingSphere.center,oe=B.map(function(ve){var Ee=ve.sub(Q);return Ee});return{vertices:oe,position:Q}},flattenVectors(B){var s=[];for(let Z of B)s.push(Z.x,Z.y,Z.z);return s},lnglatsToWorld:function(B){var s=B.map(function(Z){var j=U.projectToWorld(Z),Q=new f.Vector3(j.x,j.y,j.z);return Q});return s},extend:function(B,s){for(let Z in s)B[Z]=s[Z]},clone:function(B){var s={};for(let Z in B)s[Z]=B[Z];return s},clamp:function(B,s,Z){return Math.min(Z,Math.max(s,B))},types:{rotation:function(B,s){B||(B=0),typeof B=="number"&&(B={z:B});var Z=this.applyDefault([B.x,B.y,B.z],s),j=U.radify(Z);return j},scale:function(B,s){return B||(B=1),typeof B=="number"?B=[B,B,B]:this.applyDefault([B.x,B.y,B.z],s)},applyDefault:function(B,s){var Z=B.map(function(j,Q){return j=j||s[Q],j});return Z}},toDecimal:function(B,s){return Number(B.toFixed(s))},equal:function(B,s){const Z=Object.keys(B),j=Object.keys(s);if(Z.length!==j.length||Z.length==0&&j.length==0&&Z!==j)return!1;for(const Q of Z){const oe=B[Q],ve=s[Q],Ee=this.isObject(oe)&&this.isObject(ve);if(Ee&&!equal(oe,ve)||!Ee&&oe!==ve)return!1}return!0},isObject:function(B){return B!=null&&typeof B=="object"},curveToLine:(B,s)=>{let{width:Z,color:j}=s,Q=new f.BufferGeometry().setFromPoints(B.getPoints(100)),oe=new f.LineBasicMaterial({color:j,linewidth:Z});return new f.Line(Q,oe)},curvesToLines:B=>{var s=[16711680,2031360,2490623],Z=B.map((j,Q)=>{let oe={width:3,color:s[Q]||"purple"};return curveToLine(j,oe)});return Z},_validate:function(B,s){B=B||{};var Z={};U.extend(Z,B);for(let j of Object.keys(s))if(B[j]===void 0)if(s[j]===null){console.error(j+" is required");return}else Z[j]=s[j];else Z[j]=B[j];return Z},Validator:new D,exposedMethods:["projectToWorld","projectedUnitsPerMeter","extend","unprojectFromWorld"]};te.exports=U})(s1);var bl=s1.exports;const hg=h_(bl);var l1={exports:{}},c1={exports:{}},h1={exports:{}};(function(te,p){const f=va,C=bl,D=V0;function U(B,s,Z){this.map=B,this.camera=s,this.active=!0,this.camera.matrixAutoUpdate=!1,this.world=Z||new f.Group,this.world.position.x=this.world.position.y=D.WORLD_SIZE/2,this.world.matrixAutoUpdate=!1,this.state={translateCenter:new f.Matrix4().makeTranslation(D.WORLD_SIZE/2,-D.WORLD_SIZE/2,0),worldSizeRatio:D.TILE_SIZE/D.WORLD_SIZE,worldSize:D.TILE_SIZE*this.map.transform.scale};let j=this;this.map.on("move",function(){j.updateCamera()}).on("resize",function(){j.setupCamera()}),this.setupCamera()}U.prototype={setupCamera:function(){const B=this.map.transform;this.camera.aspect=B.width/B.height,this.halfFov=B._fov/2,this.cameraToCenterDistance=.5/Math.tan(this.halfFov)*B.height;const s=B._maxPitch*Math.PI/180;this.acuteAngle=Math.PI/2-s,this.updateCamera()},updateCamera:function(B){if(!this.camera){console.log("nocamera");return}const s=this.map.transform;this.camera.aspect=s.width/s.height;const Z=s.centerOffset||new f.Vector3;let j=0,Q=0;this.halfFov=s._fov/2;const oe=Math.PI/2+s._pitch,ve=Math.cos(Math.PI/2-s._pitch);this.cameraToCenterDistance=.5/Math.tan(this.halfFov)*s.height;let Ee=1;const We=this.worldSize();if(this.map.tb.mapboxVersion>=2){Ee=this.mercatorZfromAltitude(1,s.center.lat)*We;const Qe=s._fov*(.5+s.centerOffset.y/s.height),st=s.elevation?s.elevation.getMinElevationBelowMSL()*Ee:0,Ht=(s._camera.position[2]*We-st)/Math.cos(s._pitch),en=Math.sin(Qe)*Ht/Math.sin(C.clamp(Math.PI-oe-Qe,.01,Math.PI-.01));Q=ve*en+Ht;const ci=Ht*(1/s._horizonShift);j=Math.min(Q*1.01,ci)}else{const Qe=Math.sin(this.halfFov)*this.cameraToCenterDistance/Math.sin(Math.PI-oe-this.halfFov);Q=ve*Qe+this.cameraToCenterDistance,j=Q*1.01}this.cameraTranslateZ=new f.Matrix4().makeTranslation(0,0,this.cameraToCenterDistance);const Re=s.height/50,He=Math.max(Re*ve,Re),Mt=s.height,Lt=s.width;this.camera instanceof f.OrthographicCamera?this.camera.projectionMatrix=C.makeOrthographicMatrix(Lt/-2,Lt/2,Mt/2,Mt/-2,He,j):this.camera.projectionMatrix=C.makePerspectiveMatrix(s._fov,Lt/Mt,He,j),this.camera.projectionMatrix.elements[8]=-Z.x*2/s.width,this.camera.projectionMatrix.elements[9]=Z.y*2/s.height;let Ut=this.calcCameraMatrix(s._pitch,s.angle);s.elevation&&(Ut.elements[14]=s._camera.position[2]*We),this.camera.matrixWorld.copy(Ut);let Wt=s.scale*this.state.worldSizeRatio,lt=new f.Matrix4,Ct=new f.Matrix4,qt=new f.Matrix4;lt.makeScale(Wt,Wt,Wt);let Ai=s.x||s.point.x,Ni=s.y||s.point.y;Ct.makeTranslation(-Ai,Ni,0),qt.makeRotationZ(Math.PI),this.world.matrix=new f.Matrix4().premultiply(qt).premultiply(this.state.translateCenter).premultiply(lt).premultiply(Ct),this.map.fire("CameraSynced",{detail:{nearZ:He,farZ:j,pitch:s._pitch,angle:s.angle,furthestDistance:Q,cameraToCenterDistance:this.cameraToCenterDistance,t:this.map.transform,tbProjMatrix:this.camera.projectionMatrix.elements,tbWorldMatrix:this.world.matrix.elements,cameraSyn:U}})},worldSize(){let B=this.map.transform;return B.tileSize*B.scale},worldSizeFromZoom(){let B=this.map.transform;return Math.pow(2,B.zoom)*B.tileSize},mercatorZfromAltitude(B,s){return B/this.circumferenceAtLatitude(s)},mercatorZfromZoom(){return this.cameraToCenterDistance/this.worldSizeFromZoom()},circumferenceAtLatitude(B){return D.EARTH_CIRCUMFERENCE*Math.cos(B*Math.PI/180)},calcCameraMatrix(B,s,Z){const j=this.map.transform,Q=B===void 0?j._pitch:B,oe=s===void 0?j.angle:s,ve=Z===void 0?this.cameraTranslateZ:Z;return new f.Matrix4().premultiply(ve).premultiply(new f.Matrix4().makeRotationX(Q)).premultiply(new f.Matrix4().makeRotationZ(oe))},updateCameraState(){let B=this.map.transform;if(!B.height)return;const s=B._camera.forward(),Z=B.cameraToCenterDistance,j=B.point;B._cameraZoom?B._cameraZoom:B._zoom;const oe=this.mercatorZfromZoom(B)-this.mercatorZfromAltitude(B._centerAltitude,B.center.lat),ve=B.cameraToCenterDistance/oe;return[j.x/this.worldSize()-s[0]*Z/ve,j.y/this.worldSize()-s[1]*Z/ve,this.mercatorZfromAltitude(B._centerAltitude,B._center.lat)+-s[2]*Z/ve]},getWorldToCamera(B,s){let Z=this.map.transform;const j=new f.Matrix4,Q=new f.Matrix4,oe=Z._camera._orientation,ve=Z._camera.position,Ee=new f.Vector3(ve[0],ve[1],ve[2]),We=new f.Quaternion;We.set(oe[0],oe[1],oe[2],oe[3]);const Re=We.conjugate();return Ee.multiplyScalar(-B),Q.makeTranslation(Ee.x,Ee.y,Ee.z),j.makeRotationFromQuaternion(Re).premultiply(Q),j.elements[1]*=-1,j.elements[5]*=-1,j.elements[9]*=-1,j.elements[13]*=-1,j.elements[8]*=s,j.elements[9]*=s,j.elements[10]*=s,j.elements[11]*=s,j},translate(B,s,Z){let j=Z[0]||Z.x,Q=Z[1]||Z.y,oe=Z[2]||Z.z,ve,Ee,We,Re,He,Mt,Lt,Ut,Wt,lt,Ct,qt;return s===B?(B[12]=s[0]*j+s[4]*Q+s[8]*oe+s[12],B[13]=s[1]*j+s[5]*Q+s[9]*oe+s[13],B[14]=s[2]*j+s[6]*Q+s[10]*oe+s[14],B[15]=s[3]*j+s[7]*Q+s[11]*oe+s[15]):(ve=s[0],Ee=s[1],We=s[2],Re=s[3],He=s[4],Mt=s[5],Lt=s[6],Ut=s[7],Wt=s[8],lt=s[9],Ct=s[10],qt=s[11],B[0]=ve,B[1]=Ee,B[2]=We,B[3]=Re,B[4]=He,B[5]=Mt,B[6]=Lt,B[7]=Ut,B[8]=Wt,B[9]=lt,B[10]=Ct,B[11]=qt,B[12]=ve*j+He*Q+Wt*oe+s[12],B[13]=Ee*j+Mt*Q+lt*oe+s[13],B[14]=We*j+Lt*Q+Ct*oe+s[14],B[15]=Re*j+Ut*Q+qt*oe+s[15]),B}},te.exports=U})(h1);var hA=h1.exports,u1={exports:{}};(function(te,p){(function(){var f=Math.PI,C=Math.sin,D=Math.cos,U=Math.tan,B=Math.asin,s=Math.atan2,Z=Math.acos,j=f/180,Q=1e3*60*60*24,oe=2440588,ve=2451545;function Ee(_t){return _t.valueOf()/Q-.5+oe}function We(_t){return new Date((_t+.5-oe)*Q)}function Re(_t){return Ee(_t)-ve}var He=j*23.4397;function Mt(_t,ft){return s(C(_t)*D(He)-U(ft)*C(He),D(_t))}function Lt(_t,ft){return B(C(ft)*D(He)+D(ft)*C(He)*C(_t))}function Ut(_t,ft,ii){return s(C(_t),D(_t)*C(ft)-U(ii)*D(ft))}function Wt(_t,ft,ii){return B(C(ft)*C(ii)+D(ft)*D(ii)*D(_t))}function lt(_t,ft){return j*(280.16+360.9856235*_t)-ft}function Ct(_t){return _t<0&&(_t=0),2967e-7/Math.tan(_t+.00312536/(_t+.08901179))}function qt(_t){return j*(357.5291+.98560028*_t)}function Ai(_t){var ft=j*(1.9148*C(_t)+.02*C(2*_t)+3e-4*C(3*_t)),ii=j*102.9372;return _t+ft+ii+f}function Ni(_t){var ft=qt(_t),ii=Ai(ft);return{dec:Lt(ii,0),ra:Mt(ii,0)}}var Qe={};Qe.getPosition=function(_t,ft,ii){var St=j*-ii,Jt=j*ft,sn=Re(_t),Ki=Ni(sn),fi=lt(sn,St)-Ki.ra;return{azimuth:Ut(fi,Jt,Ki.dec),altitude:Wt(fi,Jt,Ki.dec)}},Qe.toJulian=function(_t){return Ee(_t)};var st=Qe.times=[[-.833,"sunrise","sunset"],[-.3,"sunriseEnd","sunsetStart"],[-6,"dawn","dusk"],[-12,"nauticalDawn","nauticalDusk"],[-18,"nightEnd","night"],[6,"goldenHourEnd","goldenHour"]];Qe.addTime=function(_t,ft,ii){st.push([_t,ft,ii])};var Ht=9e-4;function en(_t,ft){return Math.round(_t-Ht-ft/(2*f))}function ci(_t,ft,ii){return Ht+(_t+ft)/(2*f)+ii}function ae(_t,ft,ii){return ve+_t+.0053*C(ft)-.0069*C(2*ii)}function ye(_t,ft,ii){return Z((C(_t)-C(ft)*C(ii))/(D(ft)*D(ii)))}function Se(_t){return-2.076*Math.sqrt(_t)/60}function Pe(_t,ft,ii,St,Jt,sn,Ki){var fi=ye(_t,ii,St),pr=ci(fi,ft,Jt);return ae(pr,sn,Ki)}Qe.getTimes=function(_t,ft,ii,St){St=St||0;var Jt=j*-ii,sn=j*ft,Ki=Se(St),fi=Re(_t),pr=en(fi,Jt),Xn=ci(0,Jt,pr),wr=qt(Xn),dn=Ai(wr),ln=Lt(dn,0),_n=ae(Xn,wr,dn),li,Ie,ke,ht,Ue,Ye,xt={solarNoon:We(_n),nadir:We(_n-.5)};for(li=0,Ie=st.length;li<Ie;li+=1)ke=st[li],ht=(ke[0]+Ki)*j,Ue=Pe(ht,Jt,sn,ln,pr,wr,dn),Ye=_n-(Ue-_n),xt[ke[1]]=We(Ye),xt[ke[2]]=We(Ue);return xt};function je(_t){var ft=j*(218.316+13.176396*_t),ii=j*(134.963+13.064993*_t),St=j*(93.272+13.22935*_t),Jt=ft+j*6.289*C(ii),sn=j*5.128*C(St),Ki=385001-20905*D(ii);return{ra:Mt(Jt,sn),dec:Lt(Jt,sn),dist:Ki}}Qe.getMoonPosition=function(_t,ft,ii){var St=j*-ii,Jt=j*ft,sn=Re(_t),Ki=je(sn),fi=lt(sn,St)-Ki.ra,pr=Wt(fi,Jt,Ki.dec),Xn=s(C(fi),U(Jt)*D(Ki.dec)-C(Ki.dec)*D(fi));return pr=pr+Ct(pr),{azimuth:Ut(fi,Jt,Ki.dec),altitude:pr,distance:Ki.dist,parallacticAngle:Xn}},Qe.getMoonIllumination=function(_t){var ft=Re(_t||new Date),ii=Ni(ft),St=je(ft),Jt=149598e3,sn=Z(C(ii.dec)*C(St.dec)+D(ii.dec)*D(St.dec)*D(ii.ra-St.ra)),Ki=s(Jt*C(sn),St.dist-Jt*D(sn)),fi=s(D(ii.dec)*C(ii.ra-St.ra),C(ii.dec)*D(St.dec)-D(ii.dec)*C(St.dec)*D(ii.ra-St.ra));return{fraction:(1+D(Ki))/2,phase:.5+.5*Ki*(fi<0?-1:1)/Math.PI,angle:fi}};function Et(_t,ft){return new Date(_t.valueOf()+ft*Q/24)}Qe.getMoonTimes=function(_t,ft,ii,St){var Jt=new Date(_t);St?Jt.setUTCHours(0,0,0,0):Jt.setHours(0,0,0,0);for(var sn=.133*j,Ki=Qe.getMoonPosition(Jt,ft,ii).altitude-sn,fi,pr,Xn,wr,dn,ln,_n,li,Ie,ke,ht,Ue,Ye,xt=1;xt<=24&&(fi=Qe.getMoonPosition(Et(Jt,xt),ft,ii).altitude-sn,pr=Qe.getMoonPosition(Et(Jt,xt+1),ft,ii).altitude-sn,dn=(Ki+pr)/2-fi,ln=(pr-Ki)/2,_n=-ln/(2*dn),li=(dn*_n+ln)*_n+fi,Ie=ln*ln-4*dn*fi,ke=0,Ie>=0&&(Ye=Math.sqrt(Ie)/(Math.abs(dn)*2),ht=_n-Ye,Ue=_n+Ye,Math.abs(ht)<=1&&ke++,Math.abs(Ue)<=1&&ke++,ht<-1&&(ht=Ue)),ke===1?Ki<0?Xn=xt+ht:wr=xt+ht:ke===2&&(Xn=xt+(li<0?Ue:ht),wr=xt+(li<0?ht:Ue)),!(Xn&&wr));xt+=2)Ki=pr;var zt={};return Xn&&(zt.rise=Et(Jt,Xn)),wr&&(zt.set=Et(Jt,wr)),!Xn&&!wr&&(zt[li>0?"alwaysUp":"alwaysDown"]=!0),zt},te.exports=Qe})()})(u1);var uA=u1.exports,d1={exports:{}},p1={exports:{}};(function(te,p){var f=bl,C=va,D={material:"MeshBasicMaterial",color:"black",opacity:1};function U(B){var s;B?(B=f._validate(B,D),B.material&&B.material.isMaterial?s=B.material:B.material||B.color||B.opacity?s=new C[B.material]({color:B.color,transparent:B.opacity<1}):s=Z(),s.opacity=B.opacity,B.side&&(s.side=B.side)):s=Z();function Z(){return new C[D.material]({color:D.color})}return s}te.exports=U})(p1);var G0=p1.exports,f1={exports:{}};(function(te,p){const f=va,C=bl;function D(B){this.map=B,this.enrolledObjects=[],this.previousFrameTime}D.prototype={unenroll:function(B){this.enrolledObjects.splice(this.enrolledObjects.indexOf(B),1)},enroll:function(B){if(B.clock=new f.Clock,B.hasDefaultAnimation=!1,B.defaultAction,B.actions=[],B.mixer,B.animations&&B.animations.length>0){B.hasDefaultAnimation=!0;let j=B.userData.defaultAnimation?B.userData.defaultAnimation:0;B.mixer=new f.AnimationMixer(B),s(j)}function s(j){for(let Q=0;Q<B.animations.length;Q++){j>B.animations.length&&console.log("The animation index "+j+" doesn't exist for this object");let oe=B.animations[Q],ve=B.mixer.clipAction(oe);B.actions.push(ve),j===Q?(B.defaultAction=ve,ve.setEffectiveWeight(1)):ve.setEffectiveWeight(0),ve.play()}}let Z=!1;Object.defineProperty(B,"isPlaying",{get(){return Z},set(j){Z!=j&&(Z=j,B.dispatchEvent({type:"IsPlayingChanged",detail:B}))}}),this.enrolledObjects.push(B),B.animationQueue=[],B.set=function(j){if(j.duration>0){let Q={start:Date.now(),expiration:Date.now()+j.duration,endState:{}};C.extend(j,Q);let oe=j.coords,ve=j.rotation,Ee=j.scale||j.scaleX||j.scaleY||j.scaleZ;if(ve){let Re=B.rotation;j.startRotation=[Re.x,Re.y,Re.z],j.endState.rotation=C.types.rotation(j.rotation,j.startRotation),j.rotationPerMs=j.endState.rotation.map(function(He,Mt){return(He-j.startRotation[Mt])/j.duration})}if(Ee){let Re=B.scale;j.startScale=[Re.x,Re.y,Re.z],j.endState.scale=C.types.scale(j.scale,j.startScale),j.scalePerMs=j.endState.scale.map(function(He,Mt){return(He-j.startScale[Mt])/j.duration})}oe&&(j.pathCurve=new f.CatmullRomCurve3(C.lnglatsToWorld([B.coordinates,j.coords])));let We={type:"set",parameters:j};this.animationQueue.push(We),tb.map.repaint=!0}else this.stop(),j.rotation=C.radify(j.rotation),this._setObject(j);return this},B.animationMethod=null,B.stop=function(j){return B.mixer&&(B.isPlaying=!1,cancelAnimationFrame(B.animationMethod)),this.animationQueue=[],this},B.followPath=function(j,Q){let oe={type:"followPath",parameters:C._validate(j,U.followPath)};return C.extend(oe.parameters,{pathCurve:new f.CatmullRomCurve3(C.lnglatsToWorld(j.path)),start:Date.now(),expiration:Date.now()+oe.parameters.duration,cb:Q}),this.animationQueue.push(oe),tb.map.repaint=!0,this},B._setObject=function(j){B.setScale();let Q=j.position,oe=j.rotation,ve=j.scale,Ee=j.worldCoordinates,We=j.quaternion,Re=j.translate,He=j.worldTranslate;if(Q){this.coordinates=Q;let Lt=C.projectToWorld(Q);this.position.copy(Lt)}if(Re){this.coordinates=[this.coordinates[0]+Re[0],this.coordinates[1]+Re[1],this.coordinates[2]+Re[2]];let Lt=C.projectToWorld(Re);this.position.copy(Lt),j.position=this.coordinates}if(He){this.translateX(He.x),this.translateY(He.y),this.translateZ(He.z);let Lt=C.unprojectFromWorld(this.position);this.coordinates=j.position=Lt}if(oe&&(this.rotation.set(oe[0],oe[1],oe[2]),j.rotation=new f.Vector3(oe[0],oe[1],oe[2])),ve&&(this.scale.set(ve[0],ve[1],ve[2]),j.scale=this.scale),We&&(this.quaternion.setFromAxisAngle(We[0],We[1]),j.rotation=We[0].multiplyScalar(We[1])),Ee){this.position.copy(Ee);let Lt=C.unprojectFromWorld(Ee);this.coordinates=j.position=Lt}this.setBoundingBoxShadowFloor(),this.setReceiveShadowFloor(),this.updateMatrixWorld(),tb.map.repaint=!0;let Mt={type:"ObjectChanged",detail:{object:this,action:{position:j.position,rotation:j.rotation,scale:j.scale}}};this.dispatchEvent(Mt)},B.playDefault=function(j){if(B.mixer&&B.hasDefaultAnimation){let Q={start:Date.now(),expiration:Date.now()+j.duration,endState:{}};C.extend(j,Q),B.mixer.timeScale=j.speed||1;let oe={type:"playDefault",parameters:j};return this.animationQueue.push(oe),tb.map.repaint=!0,this}},B.playAnimation=function(j){B.mixer&&(j.animation&&s(j.animation),B.playDefault(j))},B.pauseAllActions=function(){B.mixer&&B.actions.forEach(function(j){j.paused=!0})},B.unPauseAllActions=function(){B.mixer&&B.actions.forEach(function(j){j.paused=!1})},B.deactivateAllActions=function(){B.mixer&&B.actions.forEach(function(j){j.stop()})},B.activateAllActions=function(){B.mixer&&B.actions.forEach(function(j){j.play()})},B.idle=function(){return B.mixer&&B.mixer.update(.01),tb.map.repaint=!0,this}},update:function(B){if(this.previousFrameTime===void 0&&(this.previousFrameTime=B),!this.enrolledObjects)return!1;for(let s=this.enrolledObjects.length-1;s>=0;s--){let Z=this.enrolledObjects[s];if(!(!Z.animationQueue||Z.animationQueue.length===0))for(let j=Z.animationQueue.length-1;j>=0;j--){let Q=Z.animationQueue[j];if(!Q)continue;let oe=Q.parameters;if(!oe.expiration){Z.animationQueue.splice(j,1),Z.animationQueue[j]&&(Z.animationQueue[j].parameters.start=B);return}if(B>=oe.expiration)oe.expiration=!1,Q.type==="playDefault"?Z.stop():(oe.endState&&Z._setObject(oe.endState),typeof oe.cb<"u"&&oe.cb());else{let Ee=(B-oe.start)/oe.duration;if(Q.type==="set"){let We={};oe.pathCurve&&(We.worldCoordinates=oe.pathCurve.getPoint(Ee)),oe.rotationPerMs&&(We.rotation=oe.startRotation.map(function(Re,He){return Re+oe.rotationPerMs[He]*Ee*oe.duration})),oe.scalePerMs&&(We.scale=oe.startScale.map(function(Re,He){return Re+oe.scalePerMs[He]*Ee*oe.duration})),Z._setObject(We)}if(Q.type==="followPath"){let Re={worldCoordinates:oe.pathCurve.getPointAt(Ee)};if(oe.trackHeading){let He=oe.pathCurve.getTangentAt(Ee).normalize(),Mt=new f.Vector3(0,0,0),Lt=new f.Vector3(0,1,0);Mt.crossVectors(Lt,He).normalize();let Ut=Math.acos(Lt.dot(He));Re.quaternion=[Mt,Ut]}Z._setObject(Re)}Q.type==="playDefault"&&(Z.activateAllActions(),Z.isPlaying=!0,Z.animationMethod=requestAnimationFrame(this.update),Z.mixer.update(Z.clock.getDelta()),tb.map.repaint=!0)}}}this.previousFrameTime=B}};const U={followPath:{path:null,duration:1e3,trackHeading:!0}};te.exports=D})(f1);var dA=f1.exports,m1={exports:{}};(function(te,p){const f=va;(function(){class C extends f.Object3D{constructor(oe){super(),this.element=oe||document.createElement("div"),this.element.style.position="absolute",this.element.style.userSelect="none",this.element.setAttribute("draggable",!1),this.alwaysVisible=!1,Object.defineProperty(this,"layer",{get(){return this.parent&&this.parent.parent?this.parent.parent.layer:null}}),this.dispose=function(){this.remove(),this.element=null},this.remove=function(){this.element instanceof Element&&this.element.parentNode!==null&&this.element.parentNode.removeChild(this.element)},this.addEventListener("removed",function(){this.remove()})}copy(oe,ve){return super.copy(oe,ve),this.element=oe.element.cloneNode(!0),this}}C.prototype.isCSS2DObject=!0;const D=new f.Vector3,U=new f.Matrix4,B=new f.Matrix4,s=new f.Vector3,Z=new f.Vector3;class j{constructor(){const oe=this;let ve,Ee,We,Re;const He={objects:new WeakMap,list:new Map};this.cacheList=He.list;const Mt=document.createElement("div");Mt.style.overflow="hidden",this.domElement=Mt,this.getSize=function(){return{width:ve,height:Ee}},this.render=function(Ct,qt){Ct.autoUpdate===!0&&Ct.updateMatrixWorld(),qt.parent===null&&qt.updateMatrixWorld(),U.copy(qt.matrixWorldInverse),B.multiplyMatrices(qt.projectionMatrix,U),Lt(Ct,Ct,qt),lt(Ct)},this.setSize=function(Ct,qt){ve=Ct,Ee=qt,We=ve/2,Re=Ee/2,Mt.style.width=Ct+"px",Mt.style.height=qt+"px"};function Lt(Ct,qt,Ai){if(Ct.isCSS2DObject)if(!Ct.visible)He.objects.delete({key:Ct.uuid}),He.list.delete(Ct.uuid),Ct.remove();else{Ct.onBeforeRender(oe,qt,Ai),D.setFromMatrixPosition(Ct.matrixWorld),D.applyMatrix4(B);const Qe=Ct.element;var Ni;/apple/i.test(navigator.vendor)?Ni="translate(-50%,-50%) translate("+Math.round(D.x*We+We)+"px,"+Math.round(-D.y*Re+Re)+"px)":Ni="translate(-50%,-50%) translate("+(D.x*We+We)+"px,"+(-D.y*Re+Re)+"px)",Qe.style.WebkitTransform=Ni,Qe.style.MozTransform=Ni,Qe.style.oTransform=Ni,Qe.style.transform=Ni,Qe.style.display=Ct.visible&&D.z>=-1&&D.z<=1?"":"none";const st={distanceToCameraSquared:Ut(Ai,Ct)};He.objects.set({key:Ct.uuid},st),He.list.set(Ct.uuid,Ct),Qe.parentNode!==Mt&&Mt.appendChild(Qe),Ct.onAfterRender(oe,qt,Ai)}for(let Qe=0,st=Ct.children.length;Qe<st;Qe++)Lt(Ct.children[Qe],qt,Ai)}function Ut(Ct,qt){return s.setFromMatrixPosition(Ct.matrixWorld),Z.setFromMatrixPosition(qt.matrixWorld),s.distanceToSquared(Z)}function Wt(Ct){const qt=[];return Ct.traverse(function(Ai){Ai.isCSS2DObject&&qt.push(Ai)}),qt}function lt(Ct){const qt=Wt(Ct).sort(function(Ni,Qe){let st=He.objects.get({key:Ni.uuid}),Ht=He.objects.get({key:Qe.uuid});if(st&&Ht){const en=st.distanceToCameraSquared,ci=Ht.distanceToCameraSquared;return en-ci}}),Ai=qt.length;for(let Ni=0,Qe=qt.length;Ni<Qe;Ni++)qt[Ni].element.style.zIndex=Ai-Ni}}}f.CSS2DObject=C,f.CSS2DRenderer=j})(),te.exports={CSS2DRenderer:f.CSS2DRenderer,CSS2DObject:f.CSS2DObject}})(m1);var Z_=m1.exports;(function(te,p){const f=bl,C=va,D=dA,U=Z_;function B(){}B.prototype={line:function(s){s=f._validate(s,this._defaults.line);var Z=f.lnglatsToWorld(s.geometry),j=f.normalizeVertices(Z),Q=f.flattenVectors(j.vertices),oe=new Float32Array(Q),ve=new C.BufferGeometry;ve.setAttribute("position",new C.BufferAttribute(oe,3));var Ee=new C.LineBasicMaterial({color:16711680,linewidth:21}),We=new C.Line(ve,Ee);return We.options=options||{},We.position.copy(j.position),We},extrusion:function(s){},unenroll:function(s,Z){var j=this;Z||j.animationManager.unenroll(s)},_addMethods:function(s,Z){var j=this;const Q="label",oe="tooltip",ve="help",Ee="shadowPlane";if(!Z){let Re=function(Qe,st,Ht,en){let ci=f.radify(en);Qe.position.sub(st),Qe.position.applyAxisAngle(Ht,ci),Qe.position.add(st),Qe.rotateOnAxis(Ht,ci),tb.map.repaint=!0},Ni=function(Qe){return Math.pow(2,Qe)};s.coordinates||(s.coordinates=[0,0,0]),Object.defineProperty(s,"model",{get(){return s.getObjectByName("model")}}),Object.defineProperty(s,"animations",{get(){const Qe=s.model;return Qe?Qe.animations:null}}),j.animationManager.enroll(s),s.setCoords=function(Qe){return s.userData.topMargin&&s.userData.feature&&(Qe[2]+=((s.userData.feature.properties.height||0)-(s.userData.feature.properties.base_height||s.userData.feature.properties.min_height||0))*(s.userData.topMargin||0)),s.coordinates=Qe,s.set({position:Qe}),s},s.setTranslate=function(Qe){return s.set({translate:Qe}),s},s.setRotation=function(Qe){typeof Qe=="number"&&(Qe={z:Qe});var st={x:f.radify(Qe.x)||s.rotation.x,y:f.radify(Qe.y)||s.rotation.y,z:f.radify(Qe.z)||s.rotation.z};s._setObject({rotation:[st.x,st.y,st.z]})},s.calculateAdjustedPosition=function(Qe,st,Ht){let en=Qe.slice(),ci=f.unprojectFromWorld(s.modelSize);return Ht?(en[0]-=st.x!=0?ci[0]/st.x:0,en[1]-=st.y!=0?ci[1]/st.y:0,en[2]-=st.z!=0?ci[2]/st.z:0):(en[0]+=st.x!=0?ci[0]/st.x:0,en[1]+=st.y!=0?ci[1]/st.y:0,en[2]+=st.z!=0?ci[2]/st.z:0),en},s.setRotationAxis=function(Qe){typeof Qe=="number"&&(Qe={z:Qe});let st=s.modelBox(),Ht=new C.Vector3(st.max.x,st.max.y,st.min.z);Qe.x!=0&&Re(s,Ht,new C.Vector3(0,0,1),Qe.x),Qe.y!=0&&Re(s,Ht,new C.Vector3(0,0,1),Qe.y),Qe.z!=0&&Re(s,Ht,new C.Vector3(0,0,1),Qe.z)},Object.defineProperty(s,"scaleGroup",{get(){return s.getObjectByName("scaleGroup")}}),Object.defineProperty(s,"boxGroup",{get(){return s.getObjectByName("boxGroup")}}),Object.defineProperty(s,"boundingBox",{get(){return s.getObjectByName("boxModel")}}),Object.defineProperty(s,"boundingBoxShadow",{get(){return s.getObjectByName("boxShadow")}}),s.drawBoundingBox=function(){let Qe=s.box3(),st=new C.Group;st.name="boxGroup",st.updateMatrixWorld(!0);let Ht=new C.Box3Helper(Qe,B.prototype._defaults.colors.yellow);Ht.name="boxModel",st.add(Ht),Ht.layers.disable(0);let en=Qe.clone();en.max.z=en.min.z;let ci=new C.Box3Helper(en,B.prototype._defaults.colors.black);ci.name="boxShadow",st.add(ci),ci.layers.disable(0),st.visible=!1,s.scaleGroup.add(st),s.setBoundingBoxShadowFloor()},s.setBoundingBoxShadowFloor=function(){if(s.boundingBoxShadow){let Qe=-s.modelHeight,st=s.rotation,Ht=s.boundingBoxShadow;Ht.box.max.z=Ht.box.min.z=Qe,Ht.rotation.y=st.y,Ht.rotation.x=-st.x}},s.setAnchor=function(Qe){const st=s.box3(),Ht=st.getCenter(new C.Vector3);switch(s.none={x:0,y:0,z:0},s.center={x:Ht.x,y:Ht.y,z:st.min.z},s.bottom={x:Ht.x,y:st.max.y,z:st.min.z},s.bottomLeft={x:st.max.x,y:st.max.y,z:st.min.z},s.bottomRight={x:st.min.x,y:st.max.y,z:st.min.z},s.top={x:Ht.x,y:st.min.y,z:st.min.z},s.topLeft={x:st.max.x,y:st.min.y,z:st.min.z},s.topRight={x:st.min.x,y:st.min.y,z:st.min.z},s.left={x:st.max.x,y:Ht.y,z:st.min.z},s.right={x:st.min.x,y:Ht.y,z:st.min.z},Qe){case"center":s.anchor=s.center;break;case"top":s.anchor=s.top;break;case"top-left":s.anchor=s.topLeft;break;case"top-right":s.anchor=s.topRight;break;case"left":s.anchor=s.left;break;case"right":s.anchor=s.right;break;case"bottom":s.anchor=s.bottom;break;case"bottom-left":default:s.anchor=s.bottomLeft;break;case"bottom-right":s.anchor=s.bottomRight;break;case"auto":case"none":s.anchor=s.none}s.model.position.set(-s.anchor.x,-s.anchor.y,-s.anchor.z)},s.setCenter=function(Qe){if(Qe&&(Qe.x!=0||Qe.y!=0||Qe.z!=0)){let st=s.getSize();s.anchor={x:s.anchor.x-st.x*Qe.x,y:s.anchor.y-st.y*Qe.y,z:s.anchor.z-st.z*Qe.z},s.model.position.set(-s.anchor.x,-s.anchor.y,-s.anchor.z)}},Object.defineProperty(s,"label",{get(){return s.getObjectByName(Q)}}),Object.defineProperty(s,"tooltip",{get(){return s.getObjectByName(oe)}}),Object.defineProperty(s,"help",{get(){return s.getObjectByName(ve)}});let He=!1;Object.defineProperty(s,"hidden",{get(){return He},set(Qe){He!=Qe&&(He=Qe,s.visibility=!He)}}),Object.defineProperty(s,"visibility",{get(){return s.visible},set(Qe){let st=Qe;if(Qe=="visible"||Qe==!0)st=!0,s.label&&(s.label.visible=st);else if(Qe=="none"||Qe==!1)st=!1,s.label&&s.label.alwaysVisible&&(s.label.visible=st),s.tooltip&&(s.tooltip.visible=st);else return;if(s.visible!=st){if(s.hidden&&st)return;s.visible=st,s.model&&s.model.traverse(function(Ht){(Ht.type=="Mesh"||Ht.type=="SkinnedMesh")&&(st&&s.raycasted?Ht.layers.enable(0):Ht.layers.disable(0)),Ht.type=="LineSegments"&&Ht.layers.disableAll()})}}}),s.addLabel=function(Qe,st,Ht,en){Qe&&s.drawLabelHTML(Qe,st,Ht,en)},s.removeLabel=function(){s.removeCSS2D(Q)},s.drawLabelHTML=function(Qe,st=!1,Ht=s.anchor,en=.5){let ci=j.drawLabelHTML(Qe,B.prototype._defaults.label.cssClass),ae=s.addCSS2D(ci,Q,Ht,en);return ae.alwaysVisible=st,ae.visible=st,ae},s.addTooltip=function(Qe,st,Ht,en=!0,ci=1){let ae=s.addHelp(Qe,oe,st,Ht,ci);ae.visible=!1,ae.custom=en},s.removeTooltip=function(){s.removeCSS2D(oe)},s.addHelp=function(Qe,st=ve,Ht=!1,en=s.anchor,ci=0){let ae=j.drawTooltip(Qe,Ht),ye=s.addCSS2D(ae,st,en,ci);return ye.visible=!0,ye},s.removeHelp=function(){s.removeCSS2D(ve)},s.addCSS2D=function(Qe,st,Ht=s.anchor,en=1){if(Qe){const ci=s.box3(),ae=ci.getSize(new C.Vector3);let ye={x:ci.max.x,y:ci.max.y,z:ci.min.z};s.removeCSS2D(st);let Se=new U.CSS2DObject(Qe);return Se.name=st,Se.position.set(-ae.x*.5-s.model.position.x-Ht.x+ye.x,-ae.y*.5-s.model.position.y-Ht.y+ye.y,ae.z*en),Se.visible=!1,s.scaleGroup.add(Se),Se}},s.removeCSS2D=function(Qe){let st=s.getObjectByName(Qe);if(st){st.dispose();let Ht=s.scaleGroup.children;Ht.splice(Ht.indexOf(st),1)}},Object.defineProperty(s,"shadowPlane",{get(){return s.getObjectByName(Ee)}});let Mt=!1;Object.defineProperty(s,"castShadow",{get(){return Mt},set(Qe){if(!(!s.model||Mt===Qe)){if(s.model.traverse(function(st){st.isMesh&&(st.castShadow=!0)}),Qe){const st=s.modelSize,Ht=[st.x,st.y,st.z,s.modelHeight],en=Math.max(...Ht)*10,ci=new C.PlaneBufferGeometry(en,en),ae=new C.ShadowMaterial;ae.opacity=.5;let ye=new C.Mesh(ci,ae);ye.name=Ee,ye.layers.enable(1),ye.layers.disable(0),ye.receiveShadow=Qe,s.add(ye)}else s.traverse(function(st){st.isMesh&&st.material instanceof C.ShadowMaterial&&s.remove(st)});Mt=Qe}}}),s.setReceiveShadowFloor=function(){if(s.castShadow){let Qe=s.shadowPlane,st=Qe.position,Ht=Qe.rotation;if(st.z=-s.modelHeight,Ht.y=s.rotation.y,Ht.x=-s.rotation.x,s.userData.units==="meters"){const en=s.modelSize,ci=[en.x,en.y,en.z,-st.z],ye=Math.max(...ci)*10/Qe.geometry.parameters.width;Qe.scale.set(ye,ye,ye)}}};let Lt=!1;Object.defineProperty(s,"receiveShadow",{get(){return Lt},set(Qe){!s.model||Lt===Qe||(s.model.traverse(function(st){st.isMesh&&(st.receiveShadow=!0)}),Lt=Qe)}});let Ut=!1;Object.defineProperty(s,"wireframe",{get(){return Ut},set(Qe){!s.model||Ut===Qe||(s.model.traverse(function(st){if(st.type=="Mesh"||st.type=="SkinnedMesh"){let Ht=[];Array.isArray(st.material)?Ht=st.material:Ht.push(st.material);let en=Ht[0];Qe?(st.userData.materials=en,st.material=en.clone(),st.material.wireframe=st.material.transparent=Qe,st.material.opacity=.3):(st.material.dispose(),st.material=st.userData.materials,st.userData.materials.dispose(),st.userData.materials=null),Qe?(st.layers.disable(0),st.layers.enable(1)):(st.layers.disable(1),st.layers.enable(0))}st.type=="LineSegments"&&st.layers.disableAll()}),Ut=Qe,s.dispatchEvent({type:"Wireframed",detail:s}))}});let Wt=null;Object.defineProperty(s,"color",{get(){return Wt},set(Qe){!s.model||Wt===Qe||(s.model.traverse(function(st){if(st.type=="Mesh"||st.type=="SkinnedMesh"){let Ht=[];Array.isArray(st.material)?Ht=st.material:Ht.push(st.material);let en=Ht[0];Qe?(st.userData.materials=en,st.material=new C.MeshStandardMaterial,st.material.color.setHex(Qe)):(st.material.dispose(),st.material=st.userData.materials,st.userData.materials.dispose(),st.userData.materials=null)}}),Wt=Qe)}});let lt=!1;Object.defineProperty(s,"selected",{get(){return lt},set(Qe){Qe?(s.userData.bbox&&!s.boundingBox&&s.drawBoundingBox(),s.boxGroup&&(s.boundingBox.material=B.prototype._defaults.materials.boxSelectedMaterial,s.boundingBox.parent.visible=!0,s.boundingBox.layers.enable(1),s.boundingBoxShadow.layers.enable(1)),s.label&&!s.label.alwaysVisible&&(s.label.visible=!0)):(s.boxGroup&&s.remove(s.boxGroup),s.label&&!s.label.alwaysVisible&&(s.label.visible=!1),s.removeHelp()),s.tooltip&&(s.tooltip.visible=Qe),lt!=Qe&&(lt=Qe,s.dispatchEvent({type:"SelectedChange",detail:s}))}});let Ct=!0;Object.defineProperty(s,"raycasted",{get(){return Ct},set(Qe){!s.model||Ct===Qe||(s.model.traverse(function(st){(st.type=="Mesh"||st.type=="SkinnedMesh")&&(Qe?(st.layers.disable(1),st.layers.enable(0)):(st.layers.disable(0),st.layers.enable(1)))}),Ct=Qe)}});let qt=!1;Object.defineProperty(s,"over",{get(){return qt},set(Qe){Qe?(s.selected||(s.userData.bbox&&!s.boundingBox&&s.drawBoundingBox(),s.userData.tooltip&&!s.tooltip&&s.addTooltip(s.uuid,!0,s.anchor,!1),s.boxGroup&&(s.boundingBox.material=B.prototype._defaults.materials.boxOverMaterial,s.boundingBox.parent.visible=!0,s.boundingBox.layers.enable(1),s.boundingBoxShadow.layers.enable(1))),s.label&&!s.label.alwaysVisible&&(s.label.visible=!0),s.dispatchEvent({type:"ObjectMouseOver",detail:s})):(s.selected||(s.boxGroup&&(s.remove(s.boxGroup),s.tooltip&&!s.tooltip.custom&&s.removeTooltip()),s.label&&!s.label.alwaysVisible&&(s.label.visible=!1)),s.dispatchEvent({type:"ObjectMouseOut",detail:s})),s.tooltip&&(s.tooltip.visible=Qe||s.selected),qt=Qe}}),s.box3=function(){s.updateMatrix(),s.updateMatrixWorld(!0,!0);let Qe;if(s.model){let st=s.clone(!0),Ht=s.model.clone();if(Qe=new C.Box3().setFromObject(Ht),s.parent){let en=new C.Matrix4,ci=new C.Matrix4;s.matrix.extractRotation(en),ci.copy(en).invert(),st.setRotationFromMatrix(ci),Qe=new C.Box3().setFromObject(Ht)}}return Qe},s.modelBox=function(){return s.box3()},s.getSize=function(){return s.box3().getSize(new C.Vector3(0,0,0))};let Ai=!1;Object.defineProperty(s,"modelSize",{get(){return Ai=s.getSize(),Ai},set(Qe){Ai!=Qe&&(Ai=Qe)}}),Object.defineProperty(s,"modelHeight",{get(){let Qe=s.coordinates[2]||0;return s.userData.units==="scene"&&(Qe*=s.unitsPerMeter/s.scale.x),Qe}}),Object.defineProperty(s,"unitsPerMeter",{get(){return Number(f.projectedUnitsPerMeter(s.coordinates[1]).toFixed(7))}}),Object.defineProperty(s,"fixedZoom",{get(){return s.userData.fixedZoom},set(Qe){s.userData.fixedZoom!==Qe&&(s.userData.fixedZoom=Qe,s.userData.units=Qe?"scene":"meters")}}),s.setFixedZoom=function(Qe){if(s.fixedZoom!=null&&s.fixedZoom!=0){Qe||(Qe=s.userData.mapScale);let st=Ni(s.fixedZoom);if(st>Qe){let Ht=st/Qe;s.scale.set(Ht,Ht,Ht)}else s.scale.set(1,1,1)}},s.setScale=function(Qe){if(s.userData.units!="scene"){let st=s.unitsPerMeter;s.scale.set(st,st,st)}else s.fixedZoom?(Qe&&(s.userData.mapScale=Qe),s.setFixedZoom(s.userData.mapScale)):s.scale.set(1,1,1)},s.setObjectScale=function(Qe){s.setScale(Qe),s.setBoundingBoxShadowFloor(),s.setReceiveShadowFloor()}}s.add=function(Re){return s.scaleGroup.add(Re),Re.position.z=s.coordinates[2]?-s.coordinates[2]:0,Re},s.remove=function(Re){Re&&(Re.traverse(He=>{if(He.geometry&&He.geometry.dispose(),He.material)if(He.material.isMaterial)We(He.material);else for(const Mt of He.material)We(Mt);He.dispose&&He.dispose()}),s.scaleGroup.remove(Re),tb.map.repaint=!0)},s.duplicate=function(Re){let He=s.clone(!0);if(He.getObjectByName("model").animations=s.animations,He.userData.feature&&(Re&&Re.feature&&(He.userData.feature=Re.feature),He.userData.feature.properties.uuid=He.uuid),j._addMethods(He),!Re||f.equal(Re.scale,s.userData.scale))return He.copyAnchor(s),He;{He.userData=Re,He.userData.isGeoGroup=!0,He.remove(He.boxGroup);const Mt=f.types.rotation(Re.rotation,[0,0,0]),Lt=f.types.scale(Re.scale,[1,1,1]);return He.model.position.set(0,0,0),He.model.rotation.set(Mt[0],Mt[1],Mt[2]),He.model.scale.set(Lt[0],Lt[1],Lt[2]),He.setAnchor(Re.anchor),He.setCenter(Re.adjustment),He}},s.copyAnchor=function(Re){s.anchor=Re.anchor,s.none={x:0,y:0,z:0},s.center=Re.center,s.bottom=Re.bottom,s.bottomLeft=Re.bottomLeft,s.bottomRight=Re.bottomRight,s.top=Re.top,s.topLeft=Re.topLeft,s.topRight=Re.topRight,s.left=Re.left,s.right=Re.right},s.dispose=function(){B.prototype.unenroll(s),s.traverse(Re=>{if(!(Re.parent&&Re.parent.name=="world")&&Re.name!=="threeboxObject"){if(Re.geometry&&Re.geometry.dispose(),Re.material)if(Re.material.isMaterial)We(Re.material);else for(const He of Re.material)We(He);Re.dispose&&Re.dispose()}}),s.children=[]};const We=Re=>{Re.dispose();for(const Lt of Object.keys(Re)){const Ut=Re[Lt];Ut&&typeof Ut=="object"&&"minFilter"in Ut&&Ut.dispose()}let He=Re;(He.map||He.alphaMap||He.aoMap||He.bumpMap||He.displacementMap||He.emissiveMap||He.envMap||He.lightMap||He.metalnessMap||He.normalMap||He.roughnessMap)&&(He.map&&He.map.dispose(),He.alphaMap&&He.alphaMap.dispose(),He.aoMap&&He.aoMap.dispose(),He.bumpMap&&He.bumpMap.dispose(),He.displacementMap&&He.displacementMap.dispose(),He.emissiveMap&&He.emissiveMap.dispose(),He.envMap&&He.envMap.dispose(),He.lightMap&&He.lightMap.dispose(),He.metalnessMap&&He.metalnessMap.dispose(),He.normalMap&&He.normalMap.dispose(),He.roughnessMap&&He.roughnessMap.dispose())};return s},_makeGroup:function(s,Z){let j=new C.Group;j.name="scaleGroup",j.add(s);var Q=new C.Group;Q.userData=Z||{},Q.userData.isGeoGroup=!0,Q.userData.feature&&(Q.userData.feature.properties.uuid=Q.uuid);var oe=j.length;if(oe)for(o of j)Q.add(o);else Q.add(j);return Q.name="threeboxObject",Q},animationManager:new D,drawTooltip:function(s,Z=!1){if(s){let j;if(Z){let Q=document.createElement("div");Q.className="mapboxgl-popup-content";let oe=document.createElement("strong");oe.innerHTML=s,Q.appendChild(oe);let ve=document.createElement("div");ve.className="mapboxgl-popup-tip";let Ee=document.createElement("div");Ee.className="marker mapboxgl-popup-anchor-bottom",Ee.appendChild(ve),Ee.appendChild(Q),j=document.createElement("div"),j.className+="label3D",j.appendChild(Ee)}else j=document.createElement("span"),j.className=this._defaults.tooltip.cssClass,j.innerHTML=s;return j}},drawLabelHTML:function(s,Z){let j=document.createElement("div");return j.className+=Z,typeof s=="string"?j.innerHTML=s:j.innerHTML=s.outerHTML,j},_defaults:{colors:{red:new C.Color(16711680),yellow:new C.Color(16776960),green:new C.Color(65280),black:new C.Color(0)},materials:{boxNormalMaterial:new C.LineBasicMaterial({color:new C.Color(16711680)}),boxOverMaterial:new C.LineBasicMaterial({color:new C.Color(16776960)}),boxSelectedMaterial:new C.LineBasicMaterial({color:new C.Color(65280)})},line:{geometry:null,color:"black",width:1,opacity:1},label:{htmlElement:null,cssClass:" label3D",alwaysVisible:!1,topMargin:-.5},tooltip:{text:"",cssClass:"toolTip text-xs",mapboxStyle:!1,topMargin:0},sphere:{position:[0,0,0],radius:1,sides:20,units:"scene",material:"MeshBasicMaterial",anchor:"bottom-left",bbox:!0,tooltip:!0,raycasted:!0},tube:{geometry:null,radius:1,sides:6,units:"scene",material:"MeshBasicMaterial",anchor:"center",bbox:!0,tooltip:!0,raycasted:!0},loadObj:{type:null,obj:null,units:"scene",scale:1,rotation:0,defaultAnimation:0,anchor:"bottom-left",bbox:!0,tooltip:!0,raycasted:!0,clone:!0},Object3D:{obj:null,units:"scene",anchor:"bottom-left",bbox:!0,tooltip:!0,raycasted:!0},extrusion:{coordinates:[[[]]],geometryOptions:{},height:100,materials:new C.MeshPhongMaterial({color:6684672,side:C.DoubleSide}),scale:1,rotation:0,units:"scene",anchor:"center",bbox:!0,tooltip:!0,raycasted:!0}},geometries:{line:["LineString"],tube:["LineString"],sphere:["Point"]}},te.exports=B})(d1);var Su=d1.exports,g1={exports:{}},_1={exports:{}};(function(te,p){const f=Su,C=bl;function D(U){U=C._validate(U,f.prototype._defaults.Object3D);let B=U.obj;const s=C.types.rotation(U.rotation,[0,0,0]),Z=C.types.scale(U.scale,[1,1,1]);B.rotation.set(s[0],s[1],s[2]),B.scale.set(Z[0],Z[1],Z[2]),B.name="model";let j=f.prototype._makeGroup(B,U);return U.obj.name="model",f.prototype._addMethods(j),j.setAnchor(U.anchor),j.setCenter(U.adjustment),j.raycasted=U.raycasted,j.visibility=!0,j}te.exports=D})(_1);var X_=_1.exports;(function(te,p){const f=bl,C=G0,D=va,U=Su,B=X_;function s(Z){Z=f._validate(Z,U.prototype._defaults.sphere);let j=new D.SphereBufferGeometry(Z.radius,Z.sides,Z.sides),Q=C(Z),oe=new D.Mesh(j,Q);return new B({obj:oe,units:Z.units,anchor:Z.anchor,adjustment:Z.adjustment,bbox:Z.bbox,tooltip:Z.tooltip,raycasted:Z.raycasted})}te.exports=s})(g1);var pA=g1.exports,y1={exports:{}};(function(te,p){const f=Su,C=bl,D=va,U=X_;function B(s){s=C._validate(s,f.prototype._defaults.extrusion);let Z=B.prototype.buildShape(s.coordinates),j=B.prototype.buildGeometry(Z,s.geometryOptions),Q=new D.Mesh(j,s.materials);return s.obj=Q,new U(s)}B.prototype={buildShape:function(s){if(s[0]instanceof(D.Vector2||D.Vector3))return new D.Shape(s);let Z=new D.Shape;for(let j=0;j<s.length;j++)j===0?Z=new D.Shape(this.buildPoints(s[0],s[0])):Z.holes.push(new D.Path(this.buildPoints(s[j],s[0])));return Z},buildPoints:function(s,Z){const j=[];let Q=C.projectToWorld([Z[0][0],Z[0][1],0]);for(let oe=0;oe<s.length;oe++){let ve=C.projectToWorld([s[oe][0],s[oe][1],0]);j.push(new D.Vector2(C.toDecimal(ve.x-Q.x,9),C.toDecimal(ve.y-Q.y,9)))}return j},buildGeometry:function(s,Z){let j=new D.ExtrudeBufferGeometry(s,Z);return j.computeBoundingBox(),j}},te.exports=B})(y1);var fA=y1.exports,x1={exports:{}};(function(te,p){const f=bl,C=Su,D=Z_;function U(B){B=f._validate(B,C.prototype._defaults.label);let s=C.prototype.drawLabelHTML(B.htmlElement,B.cssClass),Z=new D.CSS2DObject(s);Z.name="label",Z.visible=B.alwaysVisible,Z.alwaysVisible=B.alwaysVisible;var j=C.prototype._makeGroup(Z,B);return C.prototype._addMethods(j),j.visibility=B.alwaysVisible,j}te.exports=U})(x1);var mA=x1.exports,v1={exports:{}};(function(te,p){const f=bl,C=Su,D=Z_;function U(B){if(B=f._validate(B,C.prototype._defaults.tooltip),B.text){let Z=C.prototype.drawTooltip(B.text,B.mapboxStyle),j=new D.CSS2DObject(Z);j.visible=!1,j.name="tooltip";var s=C.prototype._makeGroup(j,B);return C.prototype._addMethods(s),s}}te.exports=U})(v1);var gA=v1.exports,b1={exports:{}},w1={exports:{}};(function(te,p){const f=va;(function(){const C=/^[og]\s*(.+)?/,D=/^mtllib /,U=/^usemtl /,B=/^usemap /,s=new f.Vector3,Z=new f.Vector3,j=new f.Vector3,Q=new f.Vector3,oe=new f.Vector3;function ve(){const We={objects:[],object:{},vertices:[],normals:[],colors:[],uvs:[],materials:{},materialLibraries:[],startObject:function(Re,He){if(this.object&&this.object.fromDeclaration===!1){this.object.name=Re,this.object.fromDeclaration=He!==!1;return}const Mt=this.object&&typeof this.object.currentMaterial=="function"?this.object.currentMaterial():void 0;if(this.object&&typeof this.object._finalize=="function"&&this.object._finalize(!0),this.object={name:Re||"",fromDeclaration:He!==!1,geometry:{vertices:[],normals:[],colors:[],uvs:[],hasUVIndices:!1},materials:[],smooth:!0,startMaterial:function(Lt,Ut){const Wt=this._finalize(!1);Wt&&(Wt.inherited||Wt.groupCount<=0)&&this.materials.splice(Wt.index,1);const lt={index:this.materials.length,name:Lt||"",mtllib:Array.isArray(Ut)&&Ut.length>0?Ut[Ut.length-1]:"",smooth:Wt!==void 0?Wt.smooth:this.smooth,groupStart:Wt!==void 0?Wt.groupEnd:0,groupEnd:-1,groupCount:-1,inherited:!1,clone:function(Ct){const qt={index:typeof Ct=="number"?Ct:this.index,name:this.name,mtllib:this.mtllib,smooth:this.smooth,groupStart:0,groupEnd:-1,groupCount:-1,inherited:!1};return qt.clone=this.clone.bind(qt),qt}};return this.materials.push(lt),lt},currentMaterial:function(){if(this.materials.length>0)return this.materials[this.materials.length-1]},_finalize:function(Lt){const Ut=this.currentMaterial();if(Ut&&Ut.groupEnd===-1&&(Ut.groupEnd=this.geometry.vertices.length/3,Ut.groupCount=Ut.groupEnd-Ut.groupStart,Ut.inherited=!1),Lt&&this.materials.length>1)for(let Wt=this.materials.length-1;Wt>=0;Wt--)this.materials[Wt].groupCount<=0&&this.materials.splice(Wt,1);return Lt&&this.materials.length===0&&this.materials.push({name:"",smooth:this.smooth}),Ut}},Mt&&Mt.name&&typeof Mt.clone=="function"){const Lt=Mt.clone(0);Lt.inherited=!0,this.object.materials.push(Lt)}this.objects.push(this.object)},finalize:function(){this.object&&typeof this.object._finalize=="function"&&this.object._finalize(!0)},parseVertexIndex:function(Re,He){const Mt=parseInt(Re,10);return(Mt>=0?Mt-1:Mt+He/3)*3},parseNormalIndex:function(Re,He){const Mt=parseInt(Re,10);return(Mt>=0?Mt-1:Mt+He/3)*3},parseUVIndex:function(Re,He){const Mt=parseInt(Re,10);return(Mt>=0?Mt-1:Mt+He/2)*2},addVertex:function(Re,He,Mt){const Lt=this.vertices,Ut=this.object.geometry.vertices;Ut.push(Lt[Re+0],Lt[Re+1],Lt[Re+2]),Ut.push(Lt[He+0],Lt[He+1],Lt[He+2]),Ut.push(Lt[Mt+0],Lt[Mt+1],Lt[Mt+2])},addVertexPoint:function(Re){const He=this.vertices;this.object.geometry.vertices.push(He[Re+0],He[Re+1],He[Re+2])},addVertexLine:function(Re){const He=this.vertices;this.object.geometry.vertices.push(He[Re+0],He[Re+1],He[Re+2])},addNormal:function(Re,He,Mt){const Lt=this.normals,Ut=this.object.geometry.normals;Ut.push(Lt[Re+0],Lt[Re+1],Lt[Re+2]),Ut.push(Lt[He+0],Lt[He+1],Lt[He+2]),Ut.push(Lt[Mt+0],Lt[Mt+1],Lt[Mt+2])},addFaceNormal:function(Re,He,Mt){const Lt=this.vertices,Ut=this.object.geometry.normals;s.fromArray(Lt,Re),Z.fromArray(Lt,He),j.fromArray(Lt,Mt),oe.subVectors(j,Z),Q.subVectors(s,Z),oe.cross(Q),oe.normalize(),Ut.push(oe.x,oe.y,oe.z),Ut.push(oe.x,oe.y,oe.z),Ut.push(oe.x,oe.y,oe.z)},addColor:function(Re,He,Mt){const Lt=this.colors,Ut=this.object.geometry.colors;Lt[Re]!==void 0&&Ut.push(Lt[Re+0],Lt[Re+1],Lt[Re+2]),Lt[He]!==void 0&&Ut.push(Lt[He+0],Lt[He+1],Lt[He+2]),Lt[Mt]!==void 0&&Ut.push(Lt[Mt+0],Lt[Mt+1],Lt[Mt+2])},addUV:function(Re,He,Mt){const Lt=this.uvs,Ut=this.object.geometry.uvs;Ut.push(Lt[Re+0],Lt[Re+1]),Ut.push(Lt[He+0],Lt[He+1]),Ut.push(Lt[Mt+0],Lt[Mt+1])},addDefaultUV:function(){const Re=this.object.geometry.uvs;Re.push(0,0),Re.push(0,0),Re.push(0,0)},addUVLine:function(Re){const He=this.uvs;this.object.geometry.uvs.push(He[Re+0],He[Re+1])},addFace:function(Re,He,Mt,Lt,Ut,Wt,lt,Ct,qt){const Ai=this.vertices.length;let Ni=this.parseVertexIndex(Re,Ai),Qe=this.parseVertexIndex(He,Ai),st=this.parseVertexIndex(Mt,Ai);if(this.addVertex(Ni,Qe,st),this.addColor(Ni,Qe,st),lt!==void 0&&lt!==""){const Ht=this.normals.length;Ni=this.parseNormalIndex(lt,Ht),Qe=this.parseNormalIndex(Ct,Ht),st=this.parseNormalIndex(qt,Ht),this.addNormal(Ni,Qe,st)}else this.addFaceNormal(Ni,Qe,st);if(Lt!==void 0&&Lt!==""){const Ht=this.uvs.length;Ni=this.parseUVIndex(Lt,Ht),Qe=this.parseUVIndex(Ut,Ht),st=this.parseUVIndex(Wt,Ht),this.addUV(Ni,Qe,st),this.object.geometry.hasUVIndices=!0}else this.addDefaultUV()},addPointGeometry:function(Re){this.object.geometry.type="Points";const He=this.vertices.length;for(let Mt=0,Lt=Re.length;Mt<Lt;Mt++){const Ut=this.parseVertexIndex(Re[Mt],He);this.addVertexPoint(Ut),this.addColor(Ut)}},addLineGeometry:function(Re,He){this.object.geometry.type="Line";const Mt=this.vertices.length,Lt=this.uvs.length;for(let Ut=0,Wt=Re.length;Ut<Wt;Ut++)this.addVertexLine(this.parseVertexIndex(Re[Ut],Mt));for(let Ut=0,Wt=He.length;Ut<Wt;Ut++)this.addUVLine(this.parseUVIndex(He[Ut],Lt))}};return We.startObject("",!1),We}class Ee extends f.Loader{constructor(Re){super(Re),this.materials=null}load(Re,He,Mt,Lt){const Ut=this,Wt=new f.FileLoader(this.manager);Wt.setPath(this.path),Wt.setRequestHeader(this.requestHeader),Wt.setWithCredentials(this.withCredentials),Wt.load(Re,function(lt){try{He(Ut.parse(lt))}catch(Ct){Lt?Lt(Ct):console.error(Ct),Ut.manager.itemError(Re)}},Mt,Lt)}setMaterials(Re){return this.materials=Re,this}parse(Re){const He=new ve;Re.indexOf(`\r
`)!==-1&&(Re=Re.replace(/\r\n/g,`
`)),Re.indexOf(`\\
`)!==-1&&(Re=Re.replace(/\\\n/g,""));const Mt=Re.split(`
`);let Lt="",Ut="",Wt=0,lt=[];const Ct=typeof"".trimLeft=="function";for(let Ni=0,Qe=Mt.length;Ni<Qe;Ni++)if(Lt=Mt[Ni],Lt=Ct?Lt.trimLeft():Lt.trim(),Wt=Lt.length,Wt!==0&&(Ut=Lt.charAt(0),Ut!=="#"))if(Ut==="v"){const st=Lt.split(/\s+/);switch(st[0]){case"v":He.vertices.push(parseFloat(st[1]),parseFloat(st[2]),parseFloat(st[3])),st.length>=7?He.colors.push(parseFloat(st[4]),parseFloat(st[5]),parseFloat(st[6])):He.colors.push(void 0,void 0,void 0);break;case"vn":He.normals.push(parseFloat(st[1]),parseFloat(st[2]),parseFloat(st[3]));break;case"vt":He.uvs.push(parseFloat(st[1]),parseFloat(st[2]));break}}else if(Ut==="f"){const Ht=Lt.substr(1).trim().split(/\s+/),en=[];for(let ae=0,ye=Ht.length;ae<ye;ae++){const Se=Ht[ae];if(Se.length>0){const Pe=Se.split("/");en.push(Pe)}}const ci=en[0];for(let ae=1,ye=en.length-1;ae<ye;ae++){const Se=en[ae],Pe=en[ae+1];He.addFace(ci[0],Se[0],Pe[0],ci[1],Se[1],Pe[1],ci[2],Se[2],Pe[2])}}else if(Ut==="l"){const st=Lt.substring(1).trim().split(" ");let Ht=[];const en=[];if(Lt.indexOf("/")===-1)Ht=st;else for(let ci=0,ae=st.length;ci<ae;ci++){const ye=st[ci].split("/");ye[0]!==""&&Ht.push(ye[0]),ye[1]!==""&&en.push(ye[1])}He.addLineGeometry(Ht,en)}else if(Ut==="p"){const Ht=Lt.substr(1).trim().split(" ");He.addPointGeometry(Ht)}else if((lt=C.exec(Lt))!==null){const st=(" "+lt[0].substr(1).trim()).substr(1);He.startObject(st)}else if(U.test(Lt))He.object.startMaterial(Lt.substring(7).trim(),He.materialLibraries);else if(D.test(Lt))He.materialLibraries.push(Lt.substring(7).trim());else if(B.test(Lt))console.warn('THREE.OBJLoader: Rendering identifier "usemap" not supported. Textures must be defined in MTL files.');else if(Ut==="s"){if(lt=Lt.split(" "),lt.length>1){const Ht=lt[1].trim().toLowerCase();He.object.smooth=Ht!=="0"&&Ht!=="off"}else He.object.smooth=!0;const st=He.object.currentMaterial();st&&(st.smooth=He.object.smooth)}else{if(Lt==="\0")continue;console.warn('THREE.OBJLoader: Unexpected line: "'+Lt+'"')}He.finalize();const qt=new f.Group;if(qt.materialLibraries=[].concat(He.materialLibraries),!(He.objects.length===1&&He.objects[0].geometry.vertices.length===0)===!0)for(let Ni=0,Qe=He.objects.length;Ni<Qe;Ni++){const st=He.objects[Ni],Ht=st.geometry,en=st.materials,ci=Ht.type==="Line",ae=Ht.type==="Points";let ye=!1;if(Ht.vertices.length===0)continue;const Se=new f.BufferGeometry;Se.setAttribute("position",new f.Float32BufferAttribute(Ht.vertices,3)),Ht.normals.length>0&&Se.setAttribute("normal",new f.Float32BufferAttribute(Ht.normals,3)),Ht.colors.length>0&&(ye=!0,Se.setAttribute("color",new f.Float32BufferAttribute(Ht.colors,3))),Ht.hasUVIndices===!0&&Se.setAttribute("uv",new f.Float32BufferAttribute(Ht.uvs,2));const Pe=[];for(let Et=0,_t=en.length;Et<_t;Et++){const ft=en[Et],ii=ft.name+"_"+ft.smooth+"_"+ye;let St=He.materials[ii];if(this.materials!==null){if(St=this.materials.create(ft.name),ci&&St&&!(St instanceof f.LineBasicMaterial)){const Jt=new f.LineBasicMaterial;f.Material.prototype.copy.call(Jt,St),Jt.color.copy(St.color),St=Jt}else if(ae&&St&&!(St instanceof f.PointsMaterial)){const Jt=new f.PointsMaterial({size:10,sizeAttenuation:!1});f.Material.prototype.copy.call(Jt,St),Jt.color.copy(St.color),Jt.map=St.map,St=Jt}}St===void 0&&(ci?St=new f.LineBasicMaterial:ae?St=new f.PointsMaterial({size:1,sizeAttenuation:!1}):St=new f.MeshPhongMaterial,St.name=ft.name,St.flatShading=!ft.smooth,St.vertexColors=ye,He.materials[ii]=St),Pe.push(St)}let je;if(Pe.length>1){for(let Et=0,_t=en.length;Et<_t;Et++){const ft=en[Et];Se.addGroup(ft.groupStart,ft.groupCount,Et)}ci?je=new f.LineSegments(Se,Pe):ae?je=new f.Points(Se,Pe):je=new f.Mesh(Se,Pe)}else ci?je=new f.LineSegments(Se,Pe[0]):ae?je=new f.Points(Se,Pe[0]):je=new f.Mesh(Se,Pe[0]);je.name=st.name,qt.add(je)}else if(He.vertices.length>0){const Ni=new f.PointsMaterial({size:1,sizeAttenuation:!1}),Qe=new f.BufferGeometry;Qe.setAttribute("position",new f.Float32BufferAttribute(He.vertices,3)),He.colors.length>0&&He.colors[0]!==void 0&&(Qe.setAttribute("color",new f.Float32BufferAttribute(He.colors,3)),Ni.vertexColors=!0);const st=new f.Points(Qe,Ni);qt.add(st)}return qt}}f.OBJLoader=Ee})(),te.exports=f.OBJLoader})(w1);var _A=w1.exports,M1={exports:{}};(function(te,p){const f=va;(function(){class C extends f.Loader{constructor(B){super(B)}load(B,s,Z,j){const Q=this,oe=this.path===""?f.LoaderUtils.extractUrlBase(B||""):this.path,ve=new f.FileLoader(this.manager);ve.setPath(this.path),ve.setRequestHeader(this.requestHeader),ve.setWithCredentials(this.withCredentials),ve.load(B,function(Ee){try{s(Q.parse(Ee,oe))}catch(We){j?j(We):console.error(We),Q.manager.itemError(B)}},Z,j)}setMaterialOptions(B){return this.materialOptions=B,this}parse(B,s){const Z=B.split(`
`);let j={};const Q=/\s+/,oe={};for(let Ee=0;Ee<Z.length;Ee++){let We=Z[Ee];if(We=We.trim(),We.length===0||We.charAt(0)==="#")continue;const Re=We.indexOf(" ");let He=Re>=0?We.substring(0,Re):We;He=He.toLowerCase();let Mt=Re>=0?We.substring(Re+1):"";if(Mt=Mt.trim(),He==="newmtl")j={name:Mt},oe[Mt]=j;else if(He==="ka"||He==="kd"||He==="ks"||He==="ke"){const Lt=Mt.split(Q,3);j[He]=[parseFloat(Lt[0]),parseFloat(Lt[1]),parseFloat(Lt[2])]}else j[He]=Mt}const ve=new D(this.resourcePath||s,this.materialOptions);return ve.setCrossOrigin(this.crossOrigin),ve.setManager(this.manager),ve.setMaterials(oe),ve}}class D{constructor(B="",s={}){this.baseUrl=B,this.options=s,this.materialsInfo={},this.materials={},this.materialsArray=[],this.nameLookup={},this.crossOrigin="anonymous",this.side=this.options.side!==void 0?this.options.side:f.FrontSide,this.wrap=this.options.wrap!==void 0?this.options.wrap:f.RepeatWrapping}setCrossOrigin(B){return this.crossOrigin=B,this}setManager(B){this.manager=B}setMaterials(B){this.materialsInfo=this.convert(B),this.materials={},this.materialsArray=[],this.nameLookup={}}convert(B){if(!this.options)return B;const s={};for(const Z in B){const j=B[Z],Q={};s[Z]=Q;for(const oe in j){let ve=!0,Ee=j[oe];const We=oe.toLowerCase();switch(We){case"kd":case"ka":case"ks":this.options&&this.options.normalizeRGB&&(Ee=[Ee[0]/255,Ee[1]/255,Ee[2]/255]),this.options&&this.options.ignoreZeroRGBs&&Ee[0]===0&&Ee[1]===0&&Ee[2]===0&&(ve=!1);break}ve&&(Q[We]=Ee)}}return s}preload(){for(const B in this.materialsInfo)this.create(B)}getIndex(B){return this.nameLookup[B]}getAsArray(){let B=0;for(const s in this.materialsInfo)this.materialsArray[B]=this.create(s),this.nameLookup[s]=B,B++;return this.materialsArray}create(B){return this.materials[B]===void 0&&this.createMaterial_(B),this.materials[B]}createMaterial_(B){const s=this,Z=this.materialsInfo[B],j={name:B,side:this.side};function Q(ve,Ee){return typeof Ee!="string"||Ee===""?"":/^https?:\/\//i.test(Ee)?Ee:ve+Ee}function oe(ve,Ee){if(j[ve])return;const We=s.getTextureParams(Ee,j),Re=s.loadTexture(Q(s.baseUrl,We.url));Re.repeat.copy(We.scale),Re.offset.copy(We.offset),Re.wrapS=s.wrap,Re.wrapT=s.wrap,j[ve]=Re}for(const ve in Z){const Ee=Z[ve];let We;if(Ee!=="")switch(ve.toLowerCase()){case"kd":j.color=new f.Color().fromArray(Ee);break;case"ks":j.specular=new f.Color().fromArray(Ee);break;case"ke":j.emissive=new f.Color().fromArray(Ee);break;case"map_kd":oe("map",Ee);break;case"map_ks":oe("specularMap",Ee);break;case"map_ke":oe("emissiveMap",Ee);break;case"norm":oe("normalMap",Ee);break;case"map_bump":case"bump":oe("bumpMap",Ee);break;case"map_d":oe("alphaMap",Ee),j.transparent=!0;break;case"ns":j.shininess=parseFloat(Ee);break;case"d":We=parseFloat(Ee),We<1&&(j.opacity=We,j.transparent=!0);break;case"tr":We=parseFloat(Ee),this.options&&this.options.invertTrProperty&&(We=1-We),We>0&&(j.opacity=1-We,j.transparent=!0);break}}return this.materials[B]=new f.MeshPhongMaterial(j),this.materials[B]}getTextureParams(B,s){const Z={scale:new f.Vector2(1,1),offset:new f.Vector2(0,0)},j=B.split(/\s+/);let Q;return Q=j.indexOf("-bm"),Q>=0&&(s.bumpScale=parseFloat(j[Q+1]),j.splice(Q,2)),Q=j.indexOf("-s"),Q>=0&&(Z.scale.set(parseFloat(j[Q+1]),parseFloat(j[Q+2])),j.splice(Q,4)),Q=j.indexOf("-o"),Q>=0&&(Z.offset.set(parseFloat(j[Q+1]),parseFloat(j[Q+2])),j.splice(Q,4)),Z.url=j.join(" ").trim(),Z}loadTexture(B,s,Z,j,Q){const oe=this.manager!==void 0?this.manager:f.DefaultLoadingManager;let ve=oe.getHandler(B);ve===null&&(ve=new f.TextureLoader(oe)),ve.setCrossOrigin&&ve.setCrossOrigin(this.crossOrigin);const Ee=ve.load(B,Z,j,Q);return s!==void 0&&(Ee.mapping=s),Ee}}f.MTLLoader=C})(),te.exports=f.MTLLoader})(M1);var yA=M1.exports,T1={exports:{}},H0={exports:{}};/*!
fflate - fast JavaScript compression/decompression
<https://101arrowz.github.io/fflate>
Licensed under MIT. https://github.com/101arrowz/fflate/blob/master/LICENSE
*/(function(te,p){(function(f){te.exports=f()})(function(){var f={};f.__esModule=!0;var C=function(be){var ge;try{ge("require('worker_threads')").Worker}catch{}return p.default=function(De,ut,ui,Ei,ni){setImmediate(function(){return ni(Error("async operations unsupported - update to Node 12+ (or Node 10-11 with the --experimental-worker CLI flag)"),null)});var ki=function(){};return{terminate:ki,postMessage:ki}},be}({}),D=Uint8Array,U=Uint16Array,B=Uint32Array,s=new D([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Z=new D([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),j=new D([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Q=function(be,ge){for(var De=new U(31),ut=0;ut<31;++ut)De[ut]=ge+=1<<be[ut-1];var ui=new B(De[30]);for(ut=1;ut<30;++ut)for(var Ei=De[ut];Ei<De[ut+1];++Ei)ui[Ei]=Ei-De[ut]<<5|ut;return[De,ui]},oe=Q(s,2),ve=oe[0],Ee=oe[1];ve[28]=258,Ee[258]=28;for(var We=Q(Z,0),Re=We[0],He=We[1],Mt=new U(32768),Lt=0;Lt<32768;++Lt){var Ut=(43690&Lt)>>>1|(21845&Lt)<<1;Mt[Lt]=((65280&(Ut=(61680&(Ut=(52428&Ut)>>>2|(13107&Ut)<<2))>>>4|(3855&Ut)<<4))>>>8|(255&Ut)<<8)>>>1}var Wt=function(be,ge,De){for(var ut=be.length,ui=0,Ei=new U(ge);ui<ut;++ui)++Ei[be[ui]-1];var ni,ki=new U(ge);for(ui=0;ui<ge;++ui)ki[ui]=ki[ui-1]+Ei[ui-1]<<1;if(De){ni=new U(1<<ge);var he=15-ge;for(ui=0;ui<ut;++ui)if(be[ui])for(var le=ui<<4|be[ui],we=ge-be[ui],Ve=ki[be[ui]-1]++<<we,ze=Ve|(1<<we)-1;Ve<=ze;++Ve)ni[Mt[Ve]>>>he]=le}else for(ni=new U(ut),ui=0;ui<ut;++ui)be[ui]&&(ni[ui]=Mt[ki[be[ui]-1]++]>>>15-be[ui]);return ni},lt=new D(288);for(Lt=0;Lt<144;++Lt)lt[Lt]=8;for(Lt=144;Lt<256;++Lt)lt[Lt]=9;for(Lt=256;Lt<280;++Lt)lt[Lt]=7;for(Lt=280;Lt<288;++Lt)lt[Lt]=8;var Ct=new D(32);for(Lt=0;Lt<32;++Lt)Ct[Lt]=5;var qt=Wt(lt,9,0),Ai=Wt(lt,9,1),Ni=Wt(Ct,5,0),Qe=Wt(Ct,5,1),st=function(be){for(var ge=be[0],De=1;De<be.length;++De)be[De]>ge&&(ge=be[De]);return ge},Ht=function(be,ge,De){var ut=ge/8|0;return(be[ut]|be[ut+1]<<8)>>(7&ge)&De},en=function(be,ge){var De=ge/8|0;return(be[De]|be[De+1]<<8|be[De+2]<<16)>>(7&ge)},ci=function(be){return(be/8|0)+(7&be&&1)},ae=function(be,ge,De){(ge==null||ge<0)&&(ge=0),(De==null||De>be.length)&&(De=be.length);var ut=new(be instanceof U?U:be instanceof B?B:D)(De-ge);return ut.set(be.subarray(ge,De)),ut},ye=function(be,ge,De){var ut=be.length;if(!ut||De&&!De.l&&ut<5)return ge||new D(0);var ui=!ge||De,Ei=!De||De.i;De||(De={}),ge||(ge=new D(3*ut));var ni=function(Sl){var Kn=ge.length;if(Sl>Kn){var Ja=new D(Math.max(2*Kn,Sl));Ja.set(ge),ge=Ja}},ki=De.f||0,he=De.p||0,le=De.b||0,we=De.l,Ve=De.d,ze=De.m,Bt=De.n,kt=8*ut;do{if(!we){De.f=ki=Ht(be,he,1);var Di=Ht(be,he+1,3);if(he+=3,!Di){var cn=be[(gr=ci(he)+4)-4]|be[gr-3]<<8,Sn=gr+cn;if(Sn>ut){if(Ei)throw"unexpected EOF";break}ui&&ni(le+cn),ge.set(be.subarray(gr,Sn),le),De.b=le+=cn,De.p=he=8*Sn;continue}if(Di==1)we=Ai,Ve=Qe,ze=9,Bt=5;else{if(Di!=2)throw"invalid block type";var Hi=Ht(be,he,31)+257,yi=Ht(be,he+10,15)+4,zn=Hi+Ht(be,he+5,31)+1;he+=14;for(var Zi=new D(zn),Ln=new D(19),Bi=0;Bi<yi;++Bi)Ln[j[Bi]]=Ht(be,he+3*Bi,7);he+=3*yi;var Nn=st(Ln),Kt=(1<<Nn)-1;if(!Ei&&he+zn*(Nn+7)>kt)break;var xr=Wt(Ln,Nn,1);for(Bi=0;Bi<zn;){var gr,Pn=xr[Ht(be,he,Kt)];if(he+=15&Pn,(gr=Pn>>>4)<16)Zi[Bi++]=gr;else{var _r=0,un=0;for(gr==16?(un=3+Ht(be,he,3),he+=2,_r=Zi[Bi-1]):gr==17?(un=3+Ht(be,he,7),he+=3):gr==18&&(un=11+Ht(be,he,127),he+=7);un--;)Zi[Bi++]=_r}}var fs=Zi.subarray(0,Hi),yr=Zi.subarray(Hi);ze=st(fs),Bt=st(yr),we=Wt(fs,ze,1),Ve=Wt(yr,Bt,1)}if(he>kt)throw"unexpected EOF"}ui&&ni(le+131072);for(var Ks=(1<<ze)-1,pn=(1<<Bt)-1,Mo=ze+Bt+18;Ei||he+Mo<kt;){var To=(_r=we[en(be,he)&Ks])>>>4;if((he+=15&_r)>kt)throw"unexpected EOF";if(!_r)throw"invalid length/literal";if(To<256)ge[le++]=To;else{if(To==256){we=null;break}var Ds=To-254;To>264&&(Ds=Ht(be,he,(1<<(Do=s[Bi=To-257]))-1)+ve[Bi],he+=Do);var ua=Ve[en(be,he)&pn],Ls=ua>>>4;if(!ua)throw"invalid distance";if(he+=15&ua,yr=Re[Ls],Ls>3){var Do=Z[Ls];yr+=en(be,he)&(1<<Do)-1,he+=Do}if(he>kt)throw"unexpected EOF";ui&&ni(le+131072);for(var Xs=le+Ds;le<Xs;le+=4)ge[le]=ge[le-yr],ge[le+1]=ge[le+1-yr],ge[le+2]=ge[le+2-yr],ge[le+3]=ge[le+3-yr];le=Xs}}De.l=we,De.p=he,De.b=le,we&&(ki=1,De.m=ze,De.d=Ve,De.n=Bt)}while(!ki);return le==ge.length?ge:ae(ge,0,le)},Se=function(be,ge,De){var ut=ge/8|0;be[ut]|=De<<=7&ge,be[ut+1]|=De>>>8},Pe=function(be,ge,De){var ut=ge/8|0;be[ut]|=De<<=7&ge,be[ut+1]|=De>>>8,be[ut+2]|=De>>>16},je=function(be,ge){for(var De=[],ut=0;ut<be.length;++ut)be[ut]&&De.push({s:ut,f:be[ut]});var ui=De.length,Ei=De.slice();if(!ui)return[sn,0];if(ui==1){var ni=new D(De[0].s+1);return ni[De[0].s]=1,[ni,1]}De.sort(function(Zi,Ln){return Zi.f-Ln.f}),De.push({s:-1,f:25001});var ki=De[0],he=De[1],le=0,we=1,Ve=2;for(De[0]={s:-1,f:ki.f+he.f,l:ki,r:he};we!=ui-1;)ki=De[De[le].f<De[Ve].f?le++:Ve++],he=De[le!=we&&De[le].f<De[Ve].f?le++:Ve++],De[we++]={s:-1,f:ki.f+he.f,l:ki,r:he};var ze=Ei[0].s;for(ut=1;ut<ui;++ut)Ei[ut].s>ze&&(ze=Ei[ut].s);var Bt=new U(ze+1),kt=Et(De[we-1],Bt,0);if(kt>ge){ut=0;var Di=0,cn=kt-ge,Sn=1<<cn;for(Ei.sort(function(Zi,Ln){return Bt[Ln.s]-Bt[Zi.s]||Zi.f-Ln.f});ut<ui;++ut){var Hi=Ei[ut].s;if(!(Bt[Hi]>ge))break;Di+=Sn-(1<<kt-Bt[Hi]),Bt[Hi]=ge}for(Di>>>=cn;Di>0;){var yi=Ei[ut].s;Bt[yi]<ge?Di-=1<<ge-Bt[yi]++-1:++ut}for(;ut>=0&&Di;--ut){var zn=Ei[ut].s;Bt[zn]==ge&&(--Bt[zn],++Di)}kt=ge}return[new D(Bt),kt]},Et=function(be,ge,De){return be.s==-1?Math.max(Et(be.l,ge,De+1),Et(be.r,ge,De+1)):ge[be.s]=De},_t=function(be){for(var ge=be.length;ge&&!be[--ge];);for(var De=new U(++ge),ut=0,ui=be[0],Ei=1,ni=function(he){De[ut++]=he},ki=1;ki<=ge;++ki)if(be[ki]==ui&&ki!=ge)++Ei;else{if(!ui&&Ei>2){for(;Ei>138;Ei-=138)ni(32754);Ei>2&&(ni(Ei>10?Ei-11<<5|28690:Ei-3<<5|12305),Ei=0)}else if(Ei>3){for(ni(ui),--Ei;Ei>6;Ei-=6)ni(8304);Ei>2&&(ni(Ei-3<<5|8208),Ei=0)}for(;Ei--;)ni(ui);Ei=1,ui=be[ki]}return[De.subarray(0,ut),ge]},ft=function(be,ge){for(var De=0,ut=0;ut<ge.length;++ut)De+=be[ut]*ge[ut];return De},ii=function(be,ge,De){var ut=De.length,ui=ci(ge+2);be[ui]=255&ut,be[ui+1]=ut>>>8,be[ui+2]=255^be[ui],be[ui+3]=255^be[ui+1];for(var Ei=0;Ei<ut;++Ei)be[ui+Ei+4]=De[Ei];return 8*(ui+4+ut)},St=function(be,ge,De,ut,ui,Ei,ni,ki,he,le,we){Se(ge,we++,De),++ui[256];for(var Ve=je(ui,15),ze=Ve[0],Bt=Ve[1],kt=je(Ei,15),Di=kt[0],cn=kt[1],Sn=_t(ze),Hi=Sn[0],yi=Sn[1],zn=_t(Di),Zi=zn[0],Ln=zn[1],Bi=new U(19),Nn=0;Nn<Hi.length;++Nn)Bi[31&Hi[Nn]]++;for(Nn=0;Nn<Zi.length;++Nn)Bi[31&Zi[Nn]]++;for(var Kt=je(Bi,7),xr=Kt[0],gr=Kt[1],Pn=19;Pn>4&&!xr[j[Pn-1]];--Pn);var _r,un,fs,yr,Ks=le+5<<3,pn=ft(ui,lt)+ft(Ei,Ct)+ni,Mo=ft(ui,ze)+ft(Ei,Di)+ni+14+3*Pn+ft(Bi,xr)+(2*Bi[16]+3*Bi[17]+7*Bi[18]);if(Ks<=pn&&Ks<=Mo)return ii(ge,we,be.subarray(he,he+le));if(Se(ge,we,1+(Mo<pn)),we+=2,Mo<pn){_r=Wt(ze,Bt,0),un=ze,fs=Wt(Di,cn,0),yr=Di;var To=Wt(xr,gr,0);for(Se(ge,we,yi-257),Se(ge,we+5,Ln-1),Se(ge,we+10,Pn-4),we+=14,Nn=0;Nn<Pn;++Nn)Se(ge,we+3*Nn,xr[j[Nn]]);we+=3*Pn;for(var Ds=[Hi,Zi],ua=0;ua<2;++ua){var Ls=Ds[ua];for(Nn=0;Nn<Ls.length;++Nn)Se(ge,we,To[Do=31&Ls[Nn]]),we+=xr[Do],Do>15&&(Se(ge,we,Ls[Nn]>>>5&127),we+=Ls[Nn]>>>12)}}else _r=qt,un=lt,fs=Ni,yr=Ct;for(Nn=0;Nn<ki;++Nn)if(ut[Nn]>255){var Do;Pe(ge,we,_r[257+(Do=ut[Nn]>>>18&31)]),we+=un[Do+257],Do>7&&(Se(ge,we,ut[Nn]>>>23&31),we+=s[Do]);var Xs=31&ut[Nn];Pe(ge,we,fs[Xs]),we+=yr[Xs],Xs>3&&(Pe(ge,we,ut[Nn]>>>5&8191),we+=Z[Xs])}else Pe(ge,we,_r[ut[Nn]]),we+=un[ut[Nn]];return Pe(ge,we,_r[256]),we+un[256]},Jt=new B([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),sn=new D(0),Ki=function(be,ge,De,ut,ui,Ei){var ni=be.length,ki=new D(ut+ni+5*(1+Math.ceil(ni/7e3))+ui),he=ki.subarray(ut,ki.length-ui),le=0;if(!ge||ni<8)for(var we=0;we<=ni;we+=65535){var Ve=we+65535;Ve<ni?le=ii(he,le,be.subarray(we,Ve)):(he[we]=Ei,le=ii(he,le,be.subarray(we,ni)))}else{for(var ze=Jt[ge-1],Bt=ze>>>13,kt=8191&ze,Di=(1<<De)-1,cn=new U(32768),Sn=new U(Di+1),Hi=Math.ceil(De/3),yi=2*Hi,zn=function(nh){return(be[nh]^be[nh+1]<<Hi^be[nh+2]<<yi)&Di},Zi=new B(25e3),Ln=new U(288),Bi=new U(32),Nn=0,Kt=0,xr=(we=0,0),gr=0,Pn=0;we<ni;++we){var _r=zn(we),un=32767&we,fs=Sn[_r];if(cn[un]=fs,Sn[_r]=un,gr<=we){var yr=ni-we;if((Nn>7e3||xr>24576)&&yr>423){le=St(be,he,0,Zi,Ln,Bi,Kt,xr,Pn,we-Pn,le),xr=Nn=Kt=0,Pn=we;for(var Ks=0;Ks<286;++Ks)Ln[Ks]=0;for(Ks=0;Ks<30;++Ks)Bi[Ks]=0}var pn=2,Mo=0,To=kt,Ds=un-fs&32767;if(yr>2&&_r==zn(we-Ds))for(var ua=Math.min(Bt,yr)-1,Ls=Math.min(32767,we),Do=Math.min(258,yr);Ds<=Ls&&--To&&un!=fs;){if(be[we+pn]==be[we+pn-Ds]){for(var Xs=0;Xs<Do&&be[we+Xs]==be[we+Xs-Ds];++Xs);if(Xs>pn){if(pn=Xs,Mo=Ds,Xs>ua)break;var Sl=Math.min(Ds,Xs-2),Kn=0;for(Ks=0;Ks<Sl;++Ks){var Ja=we-Ds+Ks+32768&32767,vc=Ja-cn[Ja]+32768&32767;vc>Kn&&(Kn=vc,fs=Ja)}}}Ds+=(un=fs)-(fs=cn[un])+32768&32767}if(Mo){Zi[xr++]=268435456|Ee[pn]<<18|He[Mo];var El=31&Ee[pn],qo=31&He[Mo];Kt+=s[El]+Z[qo],++Ln[257+El],++Bi[qo],gr=we+pn,++Nn}else Zi[xr++]=be[we],++Ln[be[we]]}}le=St(be,he,Ei,Zi,Ln,Bi,Kt,xr,Pn,we-Pn,le),!Ei&&7&le&&(le=ii(he,le+1,sn))}return ae(ki,0,ut+ci(le)+ui)},fi=function(){for(var be=new B(256),ge=0;ge<256;++ge){for(var De=ge,ut=9;--ut;)De=(1&De&&3988292384)^De>>>1;be[ge]=De}return be}(),pr=function(){var be=-1;return{p:function(ge){for(var De=be,ut=0;ut<ge.length;++ut)De=fi[255&De^ge[ut]]^De>>>8;be=De},d:function(){return~be}}},Xn=function(){var be=1,ge=0;return{p:function(De){for(var ut=be,ui=ge,Ei=De.length,ni=0;ni!=Ei;){for(var ki=Math.min(ni+2655,Ei);ni<ki;++ni)ui+=ut+=De[ni];ut=(65535&ut)+15*(ut>>16),ui=(65535&ui)+15*(ui>>16)}be=ut,ge=ui},d:function(){return((be%=65521)>>>8<<16|(255&(ge%=65521))<<8|ge>>>8)+2*((255&be)<<23)}}},wr=function(be,ge,De,ut,ui){return Ki(be,ge.level==null?6:ge.level,ge.mem==null?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(be.length)))):12+ge.mem,De,ut,!ui)},dn=function(be,ge){var De={};for(var ut in be)De[ut]=be[ut];for(var ut in ge)De[ut]=ge[ut];return De},ln=function(be,ge,De){for(var ut=be(),ui=""+be,Ei=ui.slice(ui.indexOf("[")+1,ui.lastIndexOf("]")).replace(/ /g,"").split(","),ni=0;ni<ut.length;++ni){var ki=ut[ni],he=Ei[ni];if(typeof ki=="function"){ge+=";"+he+"=";var le=""+ki;if(ki.prototype)if(le.indexOf("[native code]")!=-1){var we=le.indexOf(" ",8)+1;ge+=le.slice(we,le.indexOf("(",we))}else for(var Ve in ge+=le,ki.prototype)ge+=";"+he+".prototype."+Ve+"="+ki.prototype[Ve];else ge+=le}else De[he]=ki}return[ge,De]},_n=[],li=function(be){var ge=[];for(var De in be)(be[De]instanceof D||be[De]instanceof U||be[De]instanceof B)&&ge.push((be[De]=new be[De].constructor(be[De])).buffer);return ge},Ie=function(be,ge,De,ut){var ui;if(!_n[De]){for(var Ei="",ni={},ki=be.length-1,he=0;he<ki;++he)Ei=(ui=ln(be[he],Ei,ni))[0],ni=ui[1];_n[De]=ln(be[ki],Ei,ni)}var le=dn({},_n[De][1]);return C.default(_n[De][0]+";onmessage=function(e){for(var k in e.data)self[k]=e.data[k];onmessage="+ge+"}",De,le,li(le),ut)},ke=function(){return[D,U,B,s,Z,j,ve,Re,Ai,Qe,Mt,Wt,st,Ht,en,ci,ae,ye,js,It,si]},ht=function(){return[D,U,B,s,Z,j,Ee,He,qt,lt,Ni,Ct,Mt,Jt,sn,Wt,Se,Pe,je,Et,_t,ft,ii,St,ci,ae,Ki,wr,ds,It]},Ue=function(){return[ar,Un,Dn,pr,fi]},Ye=function(){return[rs,ms]},xt=function(){return[ho,Dn,Xn]},zt=function(){return[Ri]},It=function(be){return postMessage(be,[be.buffer])},si=function(be){return be&&be.size&&new D(be.size)},Qi=function(be,ge,De,ut,ui,Ei){var ni=Ie(De,ut,ui,function(ki,he){ni.terminate(),Ei(ki,he)});return ni.postMessage([be,ge],ge.consume?[be.buffer]:[]),function(){ni.terminate()}},tn=function(be){return be.ondata=function(ge,De){return postMessage([ge,De],[ge.buffer])},function(ge){return be.push(ge.data[0],ge.data[1])}},kn=function(be,ge,De,ut,ui){var Ei,ni=Ie(be,ut,ui,function(ki,he){ki?(ni.terminate(),ge.ondata.call(ge,ki)):(he[1]&&ni.terminate(),ge.ondata.call(ge,ki,he[0],he[1]))});ni.postMessage(De),ge.push=function(ki,he){if(Ei)throw"stream finished";if(!ge.ondata)throw"no stream handler";ni.postMessage([ki,Ei=he],[ki.buffer])},ge.terminate=function(){ni.terminate()}},Gn=function(be,ge){return be[ge]|be[ge+1]<<8},Yn=function(be,ge){return(be[ge]|be[ge+1]<<8|be[ge+2]<<16)+2*(be[ge+3]<<23)},Jn=function(be,ge){return Yn(be,ge)|4294967296*Yn(be,ge)},Dn=function(be,ge,De){for(;De;++ge)be[ge]=De,De>>>=8},ar=function(be,ge){var De=ge.filename;if(be[0]=31,be[1]=139,be[2]=8,be[8]=ge.level<2?4:ge.level==9?2:0,be[9]=3,ge.mtime!=0&&Dn(be,4,Math.floor(new Date(ge.mtime||Date.now())/1e3)),De){be[3]=8;for(var ut=0;ut<=De.length;++ut)be[ut+10]=De.charCodeAt(ut)}},rs=function(be){if(be[0]!=31||be[1]!=139||be[2]!=8)throw"invalid gzip data";var ge=be[3],De=10;4&ge&&(De+=be[10]|2+(be[11]<<8));for(var ut=(ge>>3&1)+(ge>>4&1);ut>0;ut-=!be[De++]);return De+(2&ge)},ms=function(be){var ge=be.length;return(be[ge-4]|be[ge-3]<<8|be[ge-2]<<16)+2*(be[ge-1]<<23)},Un=function(be){return 10+(be.filename&&be.filename.length+1||0)},ho=function(be,ge){var De=ge.level,ut=De==0?0:De<6?1:De==9?3:2;be[0]=120,be[1]=ut<<6|(ut?32-2*ut:1)},Ri=function(be){if((15&be[0])!=8||be[0]>>>4>7||(be[0]<<8|be[1])%31)throw"invalid zlib data";if(32&be[1])throw"invalid zlib data: preset dictionaries not supported"};function jr(be,ge){return ge||typeof be!="function"||(ge=be,be={}),this.ondata=ge,be}var Ms=function(){function be(ge,De){De||typeof ge!="function"||(De=ge,ge={}),this.ondata=De,this.o=ge||{}}return be.prototype.p=function(ge,De){this.ondata(wr(ge,this.o,0,0,!De),De)},be.prototype.push=function(ge,De){if(this.d)throw"stream finished";if(!this.ondata)throw"no stream handler";this.d=De,this.p(ge,De||!1)},be}();f.Deflate=Ms;var Fs=function(){return function(be,ge){kn([ht,function(){return[tn,Ms]}],this,jr.call(this,be,ge),function(De){var ut=new Ms(De.data);onmessage=tn(ut)},6)}}();function Po(be,ge,De){if(De||(De=ge,ge={}),typeof De!="function")throw"no callback";return Qi(be,ge,[ht],function(ut){return It(ds(ut.data[0],ut.data[1]))},0,De)}function ds(be,ge){return wr(be,ge||{},0,0)}f.AsyncDeflate=Fs,f.deflate=Po,f.deflateSync=ds;var ys=function(){function be(ge){this.s={},this.p=new D(0),this.ondata=ge}return be.prototype.e=function(ge){if(this.d)throw"stream finished";if(!this.ondata)throw"no stream handler";var De=this.p.length,ut=new D(De+ge.length);ut.set(this.p),ut.set(ge,De),this.p=ut},be.prototype.c=function(ge){this.d=this.s.i=ge||!1;var De=this.s.b,ut=ye(this.p,this.o,this.s);this.ondata(ae(ut,De,this.s.b),this.d),this.o=ae(ut,this.s.b-32768),this.s.b=this.o.length,this.p=ae(this.p,this.s.p/8|0),this.s.p&=7},be.prototype.push=function(ge,De){this.e(ge),this.c(De)},be}();f.Inflate=ys;var Mr=function(){return function(be){this.ondata=be,kn([ke,function(){return[tn,ys]}],this,0,function(){var ge=new ys;onmessage=tn(ge)},7)}}();function Bs(be,ge,De){if(De||(De=ge,ge={}),typeof De!="function")throw"no callback";return Qi(be,ge,[ke],function(ut){return It(js(ut.data[0],si(ut.data[1])))},1,De)}function js(be,ge){return ye(be,ge)}f.AsyncInflate=Mr,f.inflate=Bs,f.inflateSync=js;var Wo=function(){function be(ge,De){this.c=pr(),this.l=0,this.v=1,Ms.call(this,ge,De)}return be.prototype.push=function(ge,De){Ms.prototype.push.call(this,ge,De)},be.prototype.p=function(ge,De){this.c.p(ge),this.l+=ge.length;var ut=wr(ge,this.o,this.v&&Un(this.o),De&&8,!De);this.v&&(ar(ut,this.o),this.v=0),De&&(Dn(ut,ut.length-8,this.c.d()),Dn(ut,ut.length-4,this.l)),this.ondata(ut,De)},be}();f.Gzip=Wo,f.Compress=Wo;var Rs=function(){return function(be,ge){kn([ht,Ue,function(){return[tn,Ms,Wo]}],this,jr.call(this,be,ge),function(De){var ut=new Wo(De.data);onmessage=tn(ut)},8)}}();function et(be,ge,De){if(De||(De=ge,ge={}),typeof De!="function")throw"no callback";return Qi(be,ge,[ht,Ue,function(){return[Bo]}],function(ut){return It(Bo(ut.data[0],ut.data[1]))},2,De)}function Bo(be,ge){ge||(ge={});var De=pr(),ut=be.length;De.p(be);var ui=wr(be,ge,Un(ge),8),Ei=ui.length;return ar(ui,ge),Dn(ui,Ei-8,De.d()),Dn(ui,Ei-4,ut),ui}f.AsyncGzip=Rs,f.AsyncCompress=Rs,f.gzip=et,f.compress=et,f.gzipSync=Bo,f.compressSync=Bo;var As=function(){function be(ge){this.v=1,ys.call(this,ge)}return be.prototype.push=function(ge,De){if(ys.prototype.e.call(this,ge),this.v){var ut=this.p.length>3?rs(this.p):4;if(ut>=this.p.length&&!De)return;this.p=this.p.subarray(ut),this.v=0}if(De){if(this.p.length<8)throw"invalid gzip stream";this.p=this.p.subarray(0,-8)}ys.prototype.c.call(this,De)},be}();f.Gunzip=As;var ps=function(){return function(be){this.ondata=be,kn([ke,Ye,function(){return[tn,ys,As]}],this,0,function(){var ge=new As;onmessage=tn(ge)},9)}}();function No(be,ge,De){if(De||(De=ge,ge={}),typeof De!="function")throw"no callback";return Qi(be,ge,[ke,Ye,function(){return[Ro]}],function(ut){return It(Ro(ut.data[0]))},3,De)}function Ro(be,ge){return ye(be.subarray(rs(be),-8),ge||new D(ms(be)))}f.AsyncGunzip=ps,f.gunzip=No,f.gunzipSync=Ro;var ca=function(){function be(ge,De){this.c=Xn(),this.v=1,Ms.call(this,ge,De)}return be.prototype.push=function(ge,De){Ms.prototype.push.call(this,ge,De)},be.prototype.p=function(ge,De){this.c.p(ge);var ut=wr(ge,this.o,this.v&&2,De&&4,!De);this.v&&(ho(ut,this.o),this.v=0),De&&Dn(ut,ut.length-4,this.c.d()),this.ondata(ut,De)},be}();f.Zlib=ca;var ha=function(){return function(be,ge){kn([ht,xt,function(){return[tn,Ms,ca]}],this,jr.call(this,be,ge),function(De){var ut=new ca(De.data);onmessage=tn(ut)},10)}}();function ta(be,ge,De){if(De||(De=ge,ge={}),typeof De!="function")throw"no callback";return Qi(be,ge,[ht,xt,function(){return[at]}],function(ut){return It(at(ut.data[0],ut.data[1]))},4,De)}function at(be,ge){ge||(ge={});var De=Xn();De.p(be);var ut=wr(be,ge,2,4);return ho(ut,ge),Dn(ut,ut.length-4,De.d()),ut}f.AsyncZlib=ha,f.zlib=ta,f.zlibSync=at;var se=function(){function be(ge){this.v=1,ys.call(this,ge)}return be.prototype.push=function(ge,De){if(ys.prototype.e.call(this,ge),this.v){if(this.p.length<2&&!De)return;this.p=this.p.subarray(2),this.v=0}if(De){if(this.p.length<4)throw"invalid zlib stream";this.p=this.p.subarray(0,-4)}ys.prototype.c.call(this,De)},be}();f.Unzlib=se;var me=function(){return function(be){this.ondata=be,kn([ke,zt,function(){return[tn,ys,se]}],this,0,function(){var ge=new se;onmessage=tn(ge)},11)}}();function Oe(be,ge,De){if(De||(De=ge,ge={}),typeof De!="function")throw"no callback";return Qi(be,ge,[ke,zt,function(){return[Ke]}],function(ut){return It(Ke(ut.data[0],si(ut.data[1])))},5,De)}function Ke(be,ge){return ye((Ri(be),be.subarray(2,-4)),ge)}f.AsyncUnzlib=me,f.unzlib=Oe,f.unzlibSync=Ke;var tt=function(){function be(ge){this.G=As,this.I=ys,this.Z=se,this.ondata=ge}return be.prototype.push=function(ge,De){if(!this.ondata)throw"no stream handler";if(this.s)this.s.push(ge,De);else{if(this.p&&this.p.length){var ut=new D(this.p.length+ge.length);ut.set(this.p),ut.set(ge,this.p.length)}else this.p=ge;if(this.p.length>2){var ui=this,Ei=function(){ui.ondata.apply(ui,arguments)};this.s=this.p[0]==31&&this.p[1]==139&&this.p[2]==8?new this.G(Ei):(15&this.p[0])!=8||this.p[0]>>4>7||(this.p[0]<<8|this.p[1])%31?new this.I(Ei):new this.Z(Ei),this.s.push(this.p,De),this.p=null}}},be}();f.Decompress=tt;var At=function(){function be(ge){this.G=ps,this.I=Mr,this.Z=me,this.ondata=ge}return be.prototype.push=function(ge,De){tt.prototype.push.call(this,ge,De)},be}();function Ft(be,ge,De){if(De||(De=ge,ge={}),typeof De!="function")throw"no callback";return be[0]==31&&be[1]==139&&be[2]==8?No(be,ge,De):(15&be[0])!=8||be[0]>>4>7||(be[0]<<8|be[1])%31?Bs(be,ge,De):Oe(be,ge,De)}function yt(be,ge){return be[0]==31&&be[1]==139&&be[2]==8?Ro(be,ge):(15&be[0])!=8||be[0]>>4>7||(be[0]<<8|be[1])%31?js(be,ge):Ke(be,ge)}f.AsyncDecompress=At,f.decompress=Ft,f.decompressSync=yt;var jt=function(be,ge,De,ut){for(var ui in be){var Ei=be[ui],ni=ge+ui;Ei instanceof D?De[ni]=[Ei,ut]:Array.isArray(Ei)?De[ni]=[Ei[0],dn(ut,Ei[1])]:jt(Ei,ni+"/",De,ut)}},Oi=typeof TextEncoder<"u"&&new TextEncoder,Mi=typeof TextDecoder<"u"&&new TextDecoder,wn=0;try{Mi.decode(sn,{stream:!0}),wn=1}catch{}var Bn=function(be){for(var ge="",De=0;;){var ut=be[De++],ui=(ut>127)+(ut>223)+(ut>239);if(De+ui>be.length)return[ge,ae(be,De-1)];ui?ui==3?(ut=((15&ut)<<18|(63&be[De++])<<12|(63&be[De++])<<6|63&be[De++])-65536,ge+=String.fromCharCode(55296|ut>>10,56320|1023&ut)):ge+=String.fromCharCode(1&ui?(31&ut)<<6|63&be[De++]:(15&ut)<<12|(63&be[De++])<<6|63&be[De++]):ge+=String.fromCharCode(ut)}},Vn=function(){function be(ge){this.ondata=ge,wn?this.t=new TextDecoder:this.p=sn}return be.prototype.push=function(ge,De){if(!this.ondata)throw"no callback";if(De||(De=!1),this.t)return this.ondata(this.t.decode(ge,{stream:!De}),De);var ut=new D(this.p.length+ge.length);ut.set(this.p),ut.set(ge,this.p.length);var ui=Bn(ut),Ei=ui[0],ni=ui[1];if(De&&ni.length)throw"invalid utf-8 data";this.p=ni,this.ondata(Ei,De)},be}();f.DecodeUTF8=Vn;var lr=function(){function be(ge){this.ondata=ge}return be.prototype.push=function(ge,De){if(!this.ondata)throw"no callback";this.ondata(jn(ge),De||!1)},be}();function jn(be,ge){if(ge){for(var De=new D(be.length),ut=0;ut<be.length;++ut)De[ut]=be.charCodeAt(ut);return De}if(Oi)return Oi.encode(be);var ui=be.length,Ei=new D(be.length+(be.length>>1)),ni=0,ki=function(we){Ei[ni++]=we};for(ut=0;ut<ui;++ut){if(ni+5>Ei.length){var he=new D(ni+8+(ui-ut<<1));he.set(Ei),Ei=he}var le=be.charCodeAt(ut);le<128||ge?ki(le):le<2048?(ki(192|le>>>6),ki(128|63&le)):le>55295&&le<57344?(ki(240|(le=65536+(1047552&le)|1023&be.charCodeAt(++ut))>>>18),ki(128|le>>>12&63),ki(128|le>>>6&63),ki(128|63&le)):(ki(224|le>>>12),ki(128|le>>>6&63),ki(128|63&le))}return ae(Ei,0,ni)}function fr(be,ge){if(ge){for(var De="",ut=0;ut<be.length;ut+=16384)De+=String.fromCharCode.apply(null,be.subarray(ut,ut+16384));return De}if(Mi)return Mi.decode(be);var ui=Bn(be);if(ui[1].length)throw"invalid utf-8 data";return ui[0]}f.EncodeUTF8=lr,f.strToU8=jn,f.strFromU8=fr;var bn=function(be){return be==1?3:be<6?2:be==9?1:0},as=function(be,ge){return ge+30+Gn(be,ge+26)+Gn(be,ge+28)},Vr=function(be,ge,De){var ut=Gn(be,ge+28),ui=fr(be.subarray(ge+46,ge+46+ut),!(2048&Gn(be,ge+8))),Ei=ge+46+ut,ni=Yn(be,ge+20),ki=De&&ni==4294967295?br(be,Ei):[ni,Yn(be,ge+24),Yn(be,ge+42)],he=ki[0],le=ki[1],we=ki[2];return[Gn(be,ge+10),he,le,ui,Ei+Gn(be,ge+30)+Gn(be,ge+32),we]},br=function(be,ge){for(;Gn(be,ge)!=1;ge+=4+Gn(be,ge+2));return[Jn(be,ge+12),Jn(be,ge+4),Jn(be,ge+20)]},Mn=function(be){var ge=0;if(be)for(var De in be){var ut=be[De].length;if(ut>65535)throw"extra field too long";ge+=ut+4}return ge},Wr=function(be,ge,De,ut,ui,Ei,ni,ki){var he=ut.length,le=De.extra,we=ki&&ki.length,Ve=Mn(le);Dn(be,ge,ni!=null?33639248:67324752),ge+=4,ni!=null&&(be[ge++]=20,be[ge++]=De.os),be[ge]=20,ge+=2,be[ge++]=De.flag<<1|(Ei==null&&8),be[ge++]=ui&&8,be[ge++]=255&De.compression,be[ge++]=De.compression>>8;var ze=new Date(De.mtime==null?Date.now():De.mtime),Bt=ze.getFullYear()-1980;if(Bt<0||Bt>119)throw"date not in range 1980-2099";if(Dn(be,ge,2*(Bt<<24)|ze.getMonth()+1<<21|ze.getDate()<<16|ze.getHours()<<11|ze.getMinutes()<<5|ze.getSeconds()>>>1),ge+=4,Ei!=null&&(Dn(be,ge,De.crc),Dn(be,ge+4,Ei),Dn(be,ge+8,De.size)),Dn(be,ge+12,he),Dn(be,ge+14,Ve),ge+=16,ni!=null&&(Dn(be,ge,we),Dn(be,ge+6,De.attrs),Dn(be,ge+10,ni),ge+=14),be.set(ut,ge),ge+=he,Ve)for(var kt in le){var Di=le[kt],cn=Di.length;Dn(be,ge,+kt),Dn(be,ge+2,cn),be.set(Di,ge+4),ge+=4+cn}return we&&(be.set(ki,ge),ge+=we),ge},ss=function(be,ge,De,ut,ui){Dn(be,ge,101010256),Dn(be,ge+8,De),Dn(be,ge+10,De),Dn(be,ge+12,ut),Dn(be,ge+16,ui)},Cs=function(){function be(ge){this.filename=ge,this.c=pr(),this.size=0,this.compression=0}return be.prototype.process=function(ge,De){this.ondata(null,ge,De)},be.prototype.push=function(ge,De){if(!this.ondata)throw"no callback - add to ZIP archive before pushing";this.c.p(ge),this.size+=ge.length,De&&(this.crc=this.c.d()),this.process(ge,De||!1)},be}();f.ZipPassThrough=Cs;var uo=function(){function be(ge,De){var ut=this;De||(De={}),Cs.call(this,ge),this.d=new Ms(De,function(ui,Ei){ut.ondata(null,ui,Ei)}),this.compression=8,this.flag=bn(De.level)}return be.prototype.process=function(ge,De){try{this.d.push(ge,De)}catch(ut){this.ondata(ut,null,De)}},be.prototype.push=function(ge,De){Cs.prototype.push.call(this,ge,De)},be}();f.ZipDeflate=uo;var bo=function(){function be(ge,De){var ut=this;De||(De={}),Cs.call(this,ge),this.d=new Fs(De,function(ui,Ei,ni){ut.ondata(ui,Ei,ni)}),this.compression=8,this.flag=bn(De.level),this.terminate=this.d.terminate}return be.prototype.process=function(ge,De){this.d.push(ge,De)},be.prototype.push=function(ge,De){Cs.prototype.push.call(this,ge,De)},be}();f.AsyncZipDeflate=bo;var wl=function(){function be(ge){this.ondata=ge,this.u=[],this.d=1}return be.prototype.add=function(ge){var De=this;if(2&this.d)throw"stream finished";var ut=jn(ge.filename),ui=ut.length,Ei=ge.comment,ni=Ei&&jn(Ei),ki=ui!=ge.filename.length||ni&&Ei.length!=ni.length,he=ui+Mn(ge.extra)+30;if(ui>65535)throw"filename too long";var le=new D(he);Wr(le,0,ge,ut,ki);var we=[le],Ve=function(){for(var cn=0,Sn=we;cn<Sn.length;cn++)De.ondata(null,Sn[cn],!1);we=[]},ze=this.d;this.d=0;var Bt=this.u.length,kt=dn(ge,{f:ut,u:ki,o:ni,t:function(){ge.terminate&&ge.terminate()},r:function(){if(Ve(),ze){var cn=De.u[Bt+1];cn?cn.r():De.d=1}ze=1}}),Di=0;ge.ondata=function(cn,Sn,Hi){if(cn)De.ondata(cn,Sn,Hi),De.terminate();else if(Di+=Sn.length,we.push(Sn),Hi){var yi=new D(16);Dn(yi,0,134695760),Dn(yi,4,ge.crc),Dn(yi,8,Di),Dn(yi,12,ge.size),we.push(yi),kt.c=Di,kt.b=he+Di+16,kt.crc=ge.crc,kt.size=ge.size,ze&&kt.r(),ze=1}else ze&&Ve()},this.u.push(kt)},be.prototype.end=function(){var ge=this;if(2&this.d)throw 1&this.d?"stream finishing":"stream finished";this.d?this.e():this.u.push({r:function(){1&ge.d&&(ge.u.splice(-1,1),ge.e())},t:function(){}}),this.d=3},be.prototype.e=function(){for(var ge=0,De=0,ut=0,ui=0,Ei=this.u;ui<Ei.length;ui++)ut+=46+(le=Ei[ui]).f.length+Mn(le.extra)+(le.o?le.o.length:0);for(var ni=new D(ut+22),ki=0,he=this.u;ki<he.length;ki++){var le;Wr(ni,ge,le=he[ki],le.f,le.u,le.c,De,le.o),ge+=46+le.f.length+Mn(le.extra)+(le.o?le.o.length:0),De+=le.b}ss(ni,ge,this.u.length,ut,De),this.ondata(null,ni,!0),this.d=2},be.prototype.terminate=function(){for(var ge=0,De=this.u;ge<De.length;ge++)De[ge].t();this.d=2},be}();function wo(be,ge,De){if(De||(De=ge,ge={}),typeof De!="function")throw"no callback";var ut={};jt(be,"",ut,ge);var ui=Object.keys(ut),Ei=ui.length,ni=0,ki=0,he=Ei,le=Array(Ei),we=[],Ve=function(){for(var Di=0;Di<we.length;++Di)we[Di]()},ze=function(){var Di=new D(ki+22),cn=ni,Sn=ki-ni;ki=0;for(var Hi=0;Hi<he;++Hi){var yi=le[Hi];try{var zn=yi.c.length;Wr(Di,ki,yi,yi.f,yi.u,zn);var Zi=30+yi.f.length+Mn(yi.extra),Ln=ki+Zi;Di.set(yi.c,Ln),Wr(Di,ni,yi,yi.f,yi.u,zn,ki,yi.m),ni+=16+Zi+(yi.m?yi.m.length:0),ki=Ln+zn}catch(Bi){return De(Bi,null)}}ss(Di,ni,le.length,Sn,cn),De(null,Di)};Ei||ze();for(var Bt=function(Di){var cn=ui[Di],Sn=ut[cn],Hi=Sn[0],yi=Sn[1],zn=pr(),Zi=Hi.length;zn.p(Hi);var Ln=jn(cn),Bi=Ln.length,Nn=yi.comment,Kt=Nn&&jn(Nn),xr=Kt&&Kt.length,gr=Mn(yi.extra),Pn=yi.level==0?0:8,_r=function(un,fs){if(un)Ve(),De(un,null);else{var yr=fs.length;le[Di]=dn(yi,{size:Zi,crc:zn.d(),c:fs,f:Ln,m:Kt,u:Bi!=cn.length||Kt&&Nn.length!=xr,compression:Pn}),ni+=30+Bi+gr+yr,ki+=76+2*(Bi+gr)+(xr||0)+yr,--Ei||ze()}};if(Bi>65535&&_r("filename too long",null),Pn)if(Zi<16e4)try{_r(null,ds(Hi,yi))}catch(un){_r(un,null)}else we.push(Po(Hi,yi,_r));else _r(null,Hi)},kt=0;kt<he;++kt)Bt(kt);return Ve}function Ml(be,ge){ge||(ge={});var De={},ut=[];jt(be,"",De,ge);var ui=0,Ei=0;for(var ni in De){var ki=De[ni],he=ki[0],le=ki[1],we=le.level==0?0:8,Ve=(Bi=jn(ni)).length,ze=le.comment,Bt=ze&&jn(ze),kt=Bt&&Bt.length,Di=Mn(le.extra);if(Ve>65535)throw"filename too long";var cn=we?ds(he,le):he,Sn=cn.length,Hi=pr();Hi.p(he),ut.push(dn(le,{size:he.length,crc:Hi.d(),c:cn,f:Bi,m:Bt,u:Ve!=ni.length||Bt&&ze.length!=kt,o:ui,compression:we})),ui+=30+Ve+Di+Sn,Ei+=76+2*(Ve+Di)+(kt||0)+Sn}for(var yi=new D(Ei+22),zn=ui,Zi=Ei-ui,Ln=0;Ln<ut.length;++Ln){var Bi;Wr(yi,(Bi=ut[Ln]).o,Bi,Bi.f,Bi.u,Bi.c.length);var Nn=30+Bi.f.length+Mn(Bi.extra);yi.set(Bi.c,Bi.o+Nn),Wr(yi,ui,Bi,Bi.f,Bi.u,Bi.c.length,Bi.o,Bi.m),ui+=16+Nn+(Bi.m?Bi.m.length:0)}return ss(yi,ui,ut.length,Zi,zn),yi}f.Zip=wl,f.zip=wo,f.zipSync=Ml;var ur=function(){function be(){}return be.prototype.push=function(ge,De){this.ondata(null,ge,De)},be.compression=0,be}();f.UnzipPassThrough=ur;var ba=function(){function be(){var ge=this;this.i=new ys(function(De,ut){ge.ondata(null,De,ut)})}return be.prototype.push=function(ge,De){try{this.i.push(ge,De)}catch(ut){this.ondata(ut,ge,De)}},be.compression=8,be}();f.UnzipInflate=ba;var ia=function(){function be(ge,De){var ut=this;De<32e4?this.i=new ys(function(ui,Ei){ut.ondata(null,ui,Ei)}):(this.i=new Mr(function(ui,Ei,ni){ut.ondata(ui,Ei,ni)}),this.terminate=this.i.terminate)}return be.prototype.push=function(ge,De){this.i.terminate&&(ge=ae(ge,0)),this.i.push(ge,De)},be.compression=8,be}();f.AsyncUnzipInflate=ia;var Ws=function(){function be(ge){this.onfile=ge,this.k=[],this.o={0:ur},this.p=sn}return be.prototype.push=function(ge,De){var ut=this;if(!this.onfile)throw"no callback";if(this.c>0){var ui=Math.min(this.c,ge.length),Ei=ge.subarray(0,ui);if(this.c-=ui,this.d?this.d.push(Ei,!this.c):this.k[0].push(Ei),(ge=ge.subarray(ui)).length)return this.push(ge,De)}else{var ni=0,ki=0,he=void 0,le=void 0;this.p.length?ge.length?((le=new D(this.p.length+ge.length)).set(this.p),le.set(ge,this.p.length)):le=this.p:le=ge;for(var we=le.length,Ve=this.c,ze=Ve&&this.d,Bt=function(){var cn,Sn=Yn(le,ki);if(Sn==67324752){ni=1,he=ki,kt.d=null,kt.c=0;var Hi=Gn(le,ki+6),yi=Gn(le,ki+8),zn=2048&Hi,Zi=8&Hi,Ln=Gn(le,ki+26),Bi=Gn(le,ki+28);if(we>ki+30+Ln+Bi){var Nn=[];kt.k.unshift(Nn),ni=2;var Kt=Yn(le,ki+18),xr=Yn(le,ki+22),gr=fr(le.subarray(ki+30,ki+=30+Ln),!zn);Kt==4294967295?(cn=Zi?[-2]:br(le,ki),Kt=cn[0],xr=cn[1]):Zi&&(Kt=-1),ki+=Bi,kt.c=Kt;var Pn={name:gr,compression:yi,start:function(){if(!Pn.ondata)throw"no callback";if(Kt){var _r=ut.o[yi];if(!_r)throw"unknown compression type "+yi;var un=Kt<0?new _r(gr):new _r(gr,Kt,xr);un.ondata=function(Ks,pn,Mo){Pn.ondata(Ks,pn,Mo)};for(var fs=0,yr=Nn;fs<yr.length;fs++)un.push(yr[fs],!1);ut.k[0]==Nn?ut.d=un:un.push(sn,!0)}else Pn.ondata(null,sn,!0)},terminate:function(){ut.k[0]==Nn&&ut.d.terminate&&ut.d.terminate()}};Kt>=0&&(Pn.size=Kt,Pn.originalSize=xr),kt.onfile(Pn)}return"break"}if(Ve){if(Sn==134695760)return he=ki+=12+(Ve==-2&&8),ni=2,kt.c=0,"break";if(Sn==33639248)return he=ki-=4,ni=2,kt.c=0,"break"}},kt=this;ki<we-4&&Bt()!=="break";++ki);if(this.p=sn,Ve<0){var Di=le.subarray(0,ni?he-12-(Ve==-2&&8)-(Yn(le,he-16)==134695760&&4):ki);ze?ze.push(Di,!!ni):this.k[+(ni==2)].push(Di)}if(2&ni)return this.push(le.subarray(ki),De);this.p=le.subarray(ki)}if(De&&this.c)throw"invalid zip file"},be.prototype.register=function(ge){this.o[ge.compression]=ge},be}();function Tl(be,ge){if(typeof ge!="function")throw"no callback";for(var De=[],ut=function(){for(var ze=0;ze<De.length;++ze)De[ze]()},ui={},Ei=be.length-22;Yn(be,Ei)!=101010256;--Ei)if(!Ei||be.length-Ei>65558)return void ge("invalid zip file",null);var ni=Gn(be,Ei+8);ni||ge(null,{});var ki=ni,he=Yn(be,Ei+16),le=he==4294967295;if(le){if(Ei=Yn(be,Ei-12),Yn(be,Ei)!=101075792)return void ge("invalid zip file",null);ki=ni=Yn(be,Ei+32),he=Yn(be,Ei+48)}for(var we=function(ze){var Bt=Vr(be,he,le),kt=Bt[0],Di=Bt[1],cn=Bt[2],Sn=Bt[3],Hi=Bt[4],yi=as(be,Bt[5]);he=Hi;var zn=function(Ln,Bi){Ln?(ut(),ge(Ln,null)):(ui[Sn]=Bi,--ni||ge(null,ui))};if(kt)if(kt==8){var Zi=be.subarray(yi,yi+Di);if(Di<32e4)try{zn(null,js(Zi,new D(cn)))}catch(Ln){zn(Ln,null)}else De.push(Bs(Zi,{size:cn},zn))}else zn("unknown compression type "+kt,null);else zn(null,ae(be,yi,yi+Di))},Ve=0;Ve<ki;++Ve)we();return ut}function Ba(be){for(var ge={},De=be.length-22;Yn(be,De)!=101010256;--De)if(!De||be.length-De>65558)throw"invalid zip file";var ut=Gn(be,De+8);if(!ut)return{};var ui=Yn(be,De+16),Ei=ui==4294967295;if(Ei){if(De=Yn(be,De-12),Yn(be,De)!=101075792)throw"invalid zip file";ut=Yn(be,De+32),ui=Yn(be,De+48)}for(var ni=0;ni<ut;++ni){var ki=Vr(be,ui,Ei),he=ki[0],le=ki[1],we=ki[2],Ve=ki[3],ze=ki[4],Bt=as(be,ki[5]);if(ui=ze,he){if(he!=8)throw"unknown compression type "+he;ge[Ve]=js(be.subarray(Bt,Bt+le),new D(we))}else ge[Ve]=ae(be,Bt,Bt+le)}return ge}return f.Unzip=Ws,f.unzip=Tl,f.unzipSync=Ba,f})})(H0,H0.exports);var xA=H0.exports;(function(te,p){const f=va,C=xA;(function(){let D,U,B;class s extends f.Loader{constructor(ae){super(ae)}load(ae,ye,Se,Pe){const je=this,Et=je.path===""?f.LoaderUtils.extractUrlBase(ae):je.path,_t=new f.FileLoader(this.manager);_t.setPath(je.path),_t.setResponseType("arraybuffer"),_t.setRequestHeader(je.requestHeader),_t.setWithCredentials(je.withCredentials),_t.load(ae,function(ft){try{ye(je.parse(ft,Et))}catch(ii){Pe?Pe(ii):console.error(ii),je.manager.itemError(ae)}},Se,Pe)}parse(ae,ye){if(Re(ae))D=new ve().parse(ae);else{const Pe=Qe(ae);if(!He(Pe))throw new Error("THREE.FBXLoader: Unknown format.");if(Mt(Pe)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+Mt(Pe));D=new oe().parse(Pe)}const Se=new f.TextureLoader(this.manager).setPath(this.resourcePath||ye).setCrossOrigin(this.crossOrigin);return new Z(Se,this.manager).parse(D)}}class Z{constructor(ae,ye){this.textureLoader=ae,this.manager=ye}parse(){U=this.parseConnections();const ae=this.parseImages(),ye=this.parseTextures(ae),Se=this.parseMaterials(ye),Pe=this.parseDeformers(),je=new j().parse(Pe);return this.parseScene(Pe,je,Se),B}parseConnections(){const ae=new Map;return"Connections"in D&&D.Connections.connections.forEach(function(Se){const Pe=Se[0],je=Se[1],Et=Se[2];ae.has(Pe)||ae.set(Pe,{parents:[],children:[]});const _t={ID:je,relationship:Et};ae.get(Pe).parents.push(_t),ae.has(je)||ae.set(je,{parents:[],children:[]});const ft={ID:Pe,relationship:Et};ae.get(je).children.push(ft)}),ae}parseImages(){const ae={},ye={};if("Video"in D.Objects){const Se=D.Objects.Video;for(const Pe in Se){const je=Se[Pe],Et=parseInt(Pe);if(ae[Et]=je.RelativeFilename||je.Filename,"Content"in je){const _t=je.Content instanceof ArrayBuffer&&je.Content.byteLength>0,ft=typeof je.Content=="string"&&je.Content!=="";if(_t||ft){const ii=this.parseImage(Se[Pe]);ye[je.RelativeFilename||je.Filename]=ii}}}}for(const Se in ae){const Pe=ae[Se];ye[Pe]!==void 0?ae[Se]=ye[Pe]:ae[Se]=ae[Se].split("\\").pop()}return ae}parseImage(ae){const ye=ae.Content,Se=ae.RelativeFilename||ae.Filename,Pe=Se.slice(Se.lastIndexOf(".")+1).toLowerCase();let je;switch(Pe){case"bmp":je="image/bmp";break;case"jpg":case"jpeg":je="image/jpeg";break;case"png":je="image/png";break;case"tif":je="image/tiff";break;case"tga":this.manager.getHandler(".tga")===null&&console.warn("FBXLoader: TGA loader not found, skipping ",Se),je="image/tga";break;default:console.warn('FBXLoader: Image type "'+Pe+'" is not supported.');return}if(typeof ye=="string")return"data:"+je+";base64,"+ye;{const Et=new Uint8Array(ye);return window.URL.createObjectURL(new Blob([Et],{type:je}))}}parseTextures(ae){const ye=new Map;if("Texture"in D.Objects){const Se=D.Objects.Texture;for(const Pe in Se){const je=this.parseTexture(Se[Pe],ae);ye.set(parseInt(Pe),je)}}return ye}parseTexture(ae,ye){const Se=this.loadTexture(ae,ye);Se.ID=ae.id,Se.name=ae.attrName;const Pe=ae.WrapModeU,je=ae.WrapModeV,Et=Pe!==void 0?Pe.value:0,_t=je!==void 0?je.value:0;if(Se.wrapS=Et===0?f.RepeatWrapping:f.ClampToEdgeWrapping,Se.wrapT=_t===0?f.RepeatWrapping:f.ClampToEdgeWrapping,"Scaling"in ae){const ft=ae.Scaling.value;Se.repeat.x=ft[0],Se.repeat.y=ft[1]}return Se}loadTexture(ae,ye){let Se;const Pe=this.textureLoader.path,je=U.get(ae.id).children;je!==void 0&&je.length>0&&ye[je[0].ID]!==void 0&&(Se=ye[je[0].ID],(Se.indexOf("blob:")===0||Se.indexOf("data:")===0)&&this.textureLoader.setPath(void 0));let Et;const _t=ae.FileName.slice(-3).toLowerCase();if(_t==="tga"){const ft=this.manager.getHandler(".tga");ft===null?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",ae.RelativeFilename),Et=new f.Texture):(ft.setPath(this.textureLoader.path),Et=ft.load(Se))}else _t==="psd"?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",ae.RelativeFilename),Et=new f.Texture):Et=this.textureLoader.load(Se);return this.textureLoader.setPath(Pe),Et}parseMaterials(ae){const ye=new Map;if("Material"in D.Objects){const Se=D.Objects.Material;for(const Pe in Se){const je=this.parseMaterial(Se[Pe],ae);je!==null&&ye.set(parseInt(Pe),je)}}return ye}parseMaterial(ae,ye){const Se=ae.id,Pe=ae.attrName;let je=ae.ShadingModel;if(typeof je=="object"&&(je=je.value),!U.has(Se))return null;const Et=this.parseParameters(ae,ye,Se);let _t;switch(je.toLowerCase()){case"phong":_t=new f.MeshPhongMaterial;break;case"lambert":_t=new f.MeshLambertMaterial;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to THREE.MeshPhongMaterial.',je),_t=new f.MeshPhongMaterial;break}return _t.setValues(Et),_t.name=Pe,_t}parseParameters(ae,ye,Se){const Pe={};ae.BumpFactor&&(Pe.bumpScale=ae.BumpFactor.value),ae.Diffuse?Pe.color=new f.Color().fromArray(ae.Diffuse.value):ae.DiffuseColor&&(ae.DiffuseColor.type==="Color"||ae.DiffuseColor.type==="ColorRGB")&&(Pe.color=new f.Color().fromArray(ae.DiffuseColor.value)),ae.DisplacementFactor&&(Pe.displacementScale=ae.DisplacementFactor.value),ae.Emissive?Pe.emissive=new f.Color().fromArray(ae.Emissive.value):ae.EmissiveColor&&(ae.EmissiveColor.type==="Color"||ae.EmissiveColor.type==="ColorRGB")&&(Pe.emissive=new f.Color().fromArray(ae.EmissiveColor.value)),ae.EmissiveFactor&&(Pe.emissiveIntensity=parseFloat(ae.EmissiveFactor.value)),ae.Opacity&&(Pe.opacity=parseFloat(ae.Opacity.value)),Pe.opacity<1&&(Pe.transparent=!0),ae.ReflectionFactor&&(Pe.reflectivity=ae.ReflectionFactor.value),ae.Shininess&&(Pe.shininess=ae.Shininess.value),ae.Specular?Pe.specular=new f.Color().fromArray(ae.Specular.value):ae.SpecularColor&&ae.SpecularColor.type==="Color"&&(Pe.specular=new f.Color().fromArray(ae.SpecularColor.value));const je=this;return U.get(Se).children.forEach(function(Et){const _t=Et.relationship;switch(_t){case"Bump":Pe.bumpMap=je.getTexture(ye,Et.ID);break;case"Maya|TEX_ao_map":Pe.aoMap=je.getTexture(ye,Et.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":Pe.map=je.getTexture(ye,Et.ID),Pe.map!==void 0&&(Pe.map.encoding=f.sRGBEncoding);break;case"DisplacementColor":Pe.displacementMap=je.getTexture(ye,Et.ID);break;case"EmissiveColor":Pe.emissiveMap=je.getTexture(ye,Et.ID),Pe.emissiveMap!==void 0&&(Pe.emissiveMap.encoding=f.sRGBEncoding);break;case"NormalMap":case"Maya|TEX_normal_map":Pe.normalMap=je.getTexture(ye,Et.ID);break;case"ReflectionColor":Pe.envMap=je.getTexture(ye,Et.ID),Pe.envMap!==void 0&&(Pe.envMap.mapping=f.EquirectangularReflectionMapping,Pe.envMap.encoding=f.sRGBEncoding);break;case"SpecularColor":Pe.specularMap=je.getTexture(ye,Et.ID),Pe.specularMap!==void 0&&(Pe.specularMap.encoding=f.sRGBEncoding);break;case"TransparentColor":case"TransparencyFactor":Pe.alphaMap=je.getTexture(ye,Et.ID),Pe.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",_t);break}}),Pe}getTexture(ae,ye){return"LayeredTexture"in D.Objects&&ye in D.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),ye=U.get(ye).children[0].ID),ae.get(ye)}parseDeformers(){const ae={},ye={};if("Deformer"in D.Objects){const Se=D.Objects.Deformer;for(const Pe in Se){const je=Se[Pe],Et=U.get(parseInt(Pe));if(je.attrType==="Skin"){const _t=this.parseSkeleton(Et,Se);_t.ID=Pe,Et.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),_t.geometryID=Et.parents[0].ID,ae[Pe]=_t}else if(je.attrType==="BlendShape"){const _t={id:Pe};_t.rawTargets=this.parseMorphTargets(Et,Se),_t.id=Pe,Et.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),ye[Pe]=_t}}}return{skeletons:ae,morphTargets:ye}}parseSkeleton(ae,ye){const Se=[];return ae.children.forEach(function(Pe){const je=ye[Pe.ID];if(je.attrType!=="Cluster")return;const Et={ID:Pe.ID,indices:[],weights:[],transformLink:new f.Matrix4().fromArray(je.TransformLink.a)};"Indexes"in je&&(Et.indices=je.Indexes.a,Et.weights=je.Weights.a),Se.push(Et)}),{rawBones:Se,bones:[]}}parseMorphTargets(ae,ye){const Se=[];for(let Pe=0;Pe<ae.children.length;Pe++){const je=ae.children[Pe],Et=ye[je.ID],_t={name:Et.attrName,initialWeight:Et.DeformPercent,id:Et.id,fullWeights:Et.FullWeights.a};if(Et.attrType!=="BlendShapeChannel")return;_t.geoID=U.get(parseInt(je.ID)).children.filter(function(ft){return ft.relationship===void 0})[0].ID,Se.push(_t)}return Se}parseScene(ae,ye,Se){B=new f.Group;const Pe=this.parseModels(ae.skeletons,ye,Se),je=D.Objects.Model,Et=this;Pe.forEach(function(ft){const ii=je[ft.ID];Et.setLookAtProperties(ft,ii),U.get(ft.ID).parents.forEach(function(Jt){const sn=Pe.get(Jt.ID);sn!==void 0&&sn.add(ft)}),ft.parent===null&&B.add(ft)}),this.bindSkeleton(ae.skeletons,ye,Pe),this.createAmbientLight(),B.traverse(function(ft){if(ft.userData.transformData){ft.parent&&(ft.userData.transformData.parentMatrix=ft.parent.matrix,ft.userData.transformData.parentMatrixWorld=ft.parent.matrixWorld);const ii=qt(ft.userData.transformData);ft.applyMatrix4(ii),ft.updateWorldMatrix()}});const _t=new Q().parse();B.children.length===1&&B.children[0].isGroup&&(B.children[0].animations=_t,B=B.children[0]),B.animations=_t}parseModels(ae,ye,Se){const Pe=new Map,je=D.Objects.Model;for(const Et in je){const _t=parseInt(Et),ft=je[Et],ii=U.get(_t);let St=this.buildSkeleton(ii,ae,_t,ft.attrName);if(!St){switch(ft.attrType){case"Camera":St=this.createCamera(ii);break;case"Light":St=this.createLight(ii);break;case"Mesh":St=this.createMesh(ii,ye,Se);break;case"NurbsCurve":St=this.createCurve(ii,ye);break;case"LimbNode":case"Root":St=new f.Bone;break;case"Null":default:St=new f.Group;break}St.name=ft.attrName?f.PropertyBinding.sanitizeNodeName(ft.attrName):"",St.ID=_t}this.getTransformData(St,ft),Pe.set(_t,St)}return Pe}buildSkeleton(ae,ye,Se,Pe){let je=null;return ae.parents.forEach(function(Et){for(const _t in ye){const ft=ye[_t];ft.rawBones.forEach(function(ii,St){if(ii.ID===Et.ID){const Jt=je;je=new f.Bone,je.matrixWorld.copy(ii.transformLink),je.name=Pe?f.PropertyBinding.sanitizeNodeName(Pe):"",je.ID=Se,ft.bones[St]=je,Jt!==null&&je.add(Jt)}})}}),je}createCamera(ae){let ye,Se;if(ae.children.forEach(function(Pe){const je=D.Objects.NodeAttribute[Pe.ID];je!==void 0&&(Se=je)}),Se===void 0)ye=new f.Object3D;else{let Pe=0;Se.CameraProjectionType!==void 0&&Se.CameraProjectionType.value===1&&(Pe=1);let je=1;Se.NearPlane!==void 0&&(je=Se.NearPlane.value/1e3);let Et=1e3;Se.FarPlane!==void 0&&(Et=Se.FarPlane.value/1e3);let _t=window.innerWidth,ft=window.innerHeight;Se.AspectWidth!==void 0&&Se.AspectHeight!==void 0&&(_t=Se.AspectWidth.value,ft=Se.AspectHeight.value);const ii=_t/ft;let St=45;Se.FieldOfView!==void 0&&(St=Se.FieldOfView.value);const Jt=Se.FocalLength?Se.FocalLength.value:null;switch(Pe){case 0:ye=new f.PerspectiveCamera(St,ii,je,Et),Jt!==null&&ye.setFocalLength(Jt);break;case 1:ye=new f.OrthographicCamera(-_t/2,_t/2,ft/2,-ft/2,je,Et);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+Pe+"."),ye=new f.Object3D;break}}return ye}createLight(ae){let ye,Se;if(ae.children.forEach(function(Pe){const je=D.Objects.NodeAttribute[Pe.ID];je!==void 0&&(Se=je)}),Se===void 0)ye=new f.Object3D;else{let Pe;Se.LightType===void 0?Pe=0:Pe=Se.LightType.value;let je=16777215;Se.Color!==void 0&&(je=new f.Color().fromArray(Se.Color.value));let Et=Se.Intensity===void 0?1:Se.Intensity.value/100;Se.CastLightOnObject!==void 0&&Se.CastLightOnObject.value===0&&(Et=0);let _t=0;Se.FarAttenuationEnd!==void 0&&(Se.EnableFarAttenuation!==void 0&&Se.EnableFarAttenuation.value===0?_t=0:_t=Se.FarAttenuationEnd.value);const ft=1;switch(Pe){case 0:ye=new f.PointLight(je,Et,_t,ft);break;case 1:ye=new f.DirectionalLight(je,Et);break;case 2:let ii=Math.PI/3;Se.InnerAngle!==void 0&&(ii=f.MathUtils.degToRad(Se.InnerAngle.value));let St=0;Se.OuterAngle!==void 0&&(St=f.MathUtils.degToRad(Se.OuterAngle.value),St=Math.max(St,1)),ye=new f.SpotLight(je,Et,_t,ii,St,ft);break;default:console.warn("THREE.FBXLoader: Unknown light type "+Se.LightType.value+", defaulting to a THREE.PointLight."),ye=new f.PointLight(je,Et);break}Se.CastShadows!==void 0&&Se.CastShadows.value===1&&(ye.castShadow=!0)}return ye}createMesh(ae,ye,Se){let Pe,je=null,Et=null;const _t=[];return ae.children.forEach(function(ft){ye.has(ft.ID)&&(je=ye.get(ft.ID)),Se.has(ft.ID)&&_t.push(Se.get(ft.ID))}),_t.length>1?Et=_t:_t.length>0?Et=_t[0]:(Et=new f.MeshPhongMaterial({color:13421772}),_t.push(Et)),"color"in je.attributes&&_t.forEach(function(ft){ft.vertexColors=!0}),je.FBX_Deformer?(Pe=new f.SkinnedMesh(je,Et),Pe.normalizeSkinWeights()):Pe=new f.Mesh(je,Et),Pe}createCurve(ae,ye){const Se=ae.children.reduce(function(je,Et){return ye.has(Et.ID)&&(je=ye.get(Et.ID)),je},null),Pe=new f.LineBasicMaterial({color:3342591,linewidth:1});return new f.Line(Se,Pe)}getTransformData(ae,ye){const Se={};"InheritType"in ye&&(Se.inheritType=parseInt(ye.InheritType.value)),"RotationOrder"in ye?Se.eulerOrder=Ai(ye.RotationOrder.value):Se.eulerOrder="ZYX","Lcl_Translation"in ye&&(Se.translation=ye.Lcl_Translation.value),"PreRotation"in ye&&(Se.preRotation=ye.PreRotation.value),"Lcl_Rotation"in ye&&(Se.rotation=ye.Lcl_Rotation.value),"PostRotation"in ye&&(Se.postRotation=ye.PostRotation.value),"Lcl_Scaling"in ye&&(Se.scale=ye.Lcl_Scaling.value),"ScalingOffset"in ye&&(Se.scalingOffset=ye.ScalingOffset.value),"ScalingPivot"in ye&&(Se.scalingPivot=ye.ScalingPivot.value),"RotationOffset"in ye&&(Se.rotationOffset=ye.RotationOffset.value),"RotationPivot"in ye&&(Se.rotationPivot=ye.RotationPivot.value),ae.userData.transformData=Se}setLookAtProperties(ae,ye){"LookAtProperty"in ye&&U.get(ae.ID).children.forEach(function(Pe){if(Pe.relationship==="LookAtProperty"){const je=D.Objects.Model[Pe.ID];if("Lcl_Translation"in je){const Et=je.Lcl_Translation.value;ae.target!==void 0?(ae.target.position.fromArray(Et),B.add(ae.target)):ae.lookAt(new f.Vector3().fromArray(Et))}}})}bindSkeleton(ae,ye,Se){const Pe=this.parsePoseNodes();for(const je in ae){const Et=ae[je];U.get(parseInt(Et.ID)).parents.forEach(function(ft){if(ye.has(ft.ID)){const ii=ft.ID;U.get(ii).parents.forEach(function(Jt){Se.has(Jt.ID)&&Se.get(Jt.ID).bind(new f.Skeleton(Et.bones),Pe[Jt.ID])})}})}}parsePoseNodes(){const ae={};if("Pose"in D.Objects){const ye=D.Objects.Pose;for(const Se in ye)if(ye[Se].attrType==="BindPose"){const Pe=ye[Se].PoseNode;Array.isArray(Pe)?Pe.forEach(function(je){ae[je.Node]=new f.Matrix4().fromArray(je.Matrix.a)}):ae[Pe.Node]=new f.Matrix4().fromArray(Pe.Matrix.a)}}return ae}createAmbientLight(){if("GlobalSettings"in D&&"AmbientColor"in D.GlobalSettings){const ae=D.GlobalSettings.AmbientColor.value,ye=ae[0],Se=ae[1],Pe=ae[2];if(ye!==0||Se!==0||Pe!==0){const je=new f.Color(ye,Se,Pe);B.add(new f.AmbientLight(je,1))}}}}class j{parse(ae){const ye=new Map;if("Geometry"in D.Objects){const Se=D.Objects.Geometry;for(const Pe in Se){const je=U.get(parseInt(Pe)),Et=this.parseGeometry(je,Se[Pe],ae);ye.set(parseInt(Pe),Et)}}return ye}parseGeometry(ae,ye,Se){switch(ye.attrType){case"Mesh":return this.parseMeshGeometry(ae,ye,Se);case"NurbsCurve":return this.parseNurbsGeometry(ye)}}parseMeshGeometry(ae,ye,Se){const Pe=Se.skeletons,je=[],Et=ae.parents.map(function(Jt){return D.Objects.Model[Jt.ID]});if(Et.length===0)return;const _t=ae.children.reduce(function(Jt,sn){return Pe[sn.ID]!==void 0&&(Jt=Pe[sn.ID]),Jt},null);ae.children.forEach(function(Jt){Se.morphTargets[Jt.ID]!==void 0&&je.push(Se.morphTargets[Jt.ID])});const ft=Et[0],ii={};"RotationOrder"in ft&&(ii.eulerOrder=Ai(ft.RotationOrder.value)),"InheritType"in ft&&(ii.inheritType=parseInt(ft.InheritType.value)),"GeometricTranslation"in ft&&(ii.translation=ft.GeometricTranslation.value),"GeometricRotation"in ft&&(ii.rotation=ft.GeometricRotation.value),"GeometricScaling"in ft&&(ii.scale=ft.GeometricScaling.value);const St=qt(ii);return this.genGeometry(ye,_t,je,St)}genGeometry(ae,ye,Se,Pe){const je=new f.BufferGeometry;ae.attrName&&(je.name=ae.attrName);const Et=this.parseGeoNode(ae,ye),_t=this.genBuffers(Et),ft=new f.Float32BufferAttribute(_t.vertex,3);if(ft.applyMatrix4(Pe),je.setAttribute("position",ft),_t.colors.length>0&&je.setAttribute("color",new f.Float32BufferAttribute(_t.colors,3)),ye&&(je.setAttribute("skinIndex",new f.Uint16BufferAttribute(_t.weightsIndices,4)),je.setAttribute("skinWeight",new f.Float32BufferAttribute(_t.vertexWeights,4)),je.FBX_Deformer=ye),_t.normal.length>0){const ii=new f.Matrix3().getNormalMatrix(Pe),St=new f.Float32BufferAttribute(_t.normal,3);St.applyNormalMatrix(ii),je.setAttribute("normal",St)}if(_t.uvs.forEach(function(ii,St){let Jt="uv"+(St+1).toString();St===0&&(Jt="uv"),je.setAttribute(Jt,new f.Float32BufferAttribute(_t.uvs[St],2))}),Et.material&&Et.material.mappingType!=="AllSame"){let ii=_t.materialIndex[0],St=0;if(_t.materialIndex.forEach(function(Jt,sn){Jt!==ii&&(je.addGroup(St,sn-St,ii),ii=Jt,St=sn)}),je.groups.length>0){const Jt=je.groups[je.groups.length-1],sn=Jt.start+Jt.count;sn!==_t.materialIndex.length&&je.addGroup(sn,_t.materialIndex.length-sn,ii)}je.groups.length===0&&je.addGroup(0,_t.materialIndex.length,_t.materialIndex[0])}return this.addMorphTargets(je,ae,Se,Pe),je}parseGeoNode(ae,ye){const Se={};if(Se.vertexPositions=ae.Vertices!==void 0?ae.Vertices.a:[],Se.vertexIndices=ae.PolygonVertexIndex!==void 0?ae.PolygonVertexIndex.a:[],ae.LayerElementColor&&(Se.color=this.parseVertexColors(ae.LayerElementColor[0])),ae.LayerElementMaterial&&(Se.material=this.parseMaterialIndices(ae.LayerElementMaterial[0])),ae.LayerElementNormal&&(Se.normal=this.parseNormals(ae.LayerElementNormal[0])),ae.LayerElementUV){Se.uv=[];let Pe=0;for(;ae.LayerElementUV[Pe];)ae.LayerElementUV[Pe].UV&&Se.uv.push(this.parseUVs(ae.LayerElementUV[Pe])),Pe++}return Se.weightTable={},ye!==null&&(Se.skeleton=ye,ye.rawBones.forEach(function(Pe,je){Pe.indices.forEach(function(Et,_t){Se.weightTable[Et]===void 0&&(Se.weightTable[Et]=[]),Se.weightTable[Et].push({id:je,weight:Pe.weights[_t]})})})),Se}genBuffers(ae){const ye={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let Se=0,Pe=0,je=!1,Et=[],_t=[],ft=[],ii=[],St=[],Jt=[];const sn=this;return ae.vertexIndices.forEach(function(Ki,fi){let pr,Xn=!1;Ki<0&&(Ki=Ki^-1,Xn=!0);let wr=[],dn=[];if(Et.push(Ki*3,Ki*3+1,Ki*3+2),ae.color){const ln=Wt(fi,Se,Ki,ae.color);ft.push(ln[0],ln[1],ln[2])}if(ae.skeleton){if(ae.weightTable[Ki]!==void 0&&ae.weightTable[Ki].forEach(function(ln){dn.push(ln.weight),wr.push(ln.id)}),dn.length>4){je||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),je=!0);const ln=[0,0,0,0],_n=[0,0,0,0];dn.forEach(function(li,Ie){let ke=li,ht=wr[Ie];_n.forEach(function(Ue,Ye,xt){if(ke>Ue){xt[Ye]=ke,ke=Ue;const zt=ln[Ye];ln[Ye]=ht,ht=zt}})}),wr=ln,dn=_n}for(;dn.length<4;)dn.push(0),wr.push(0);for(let ln=0;ln<4;++ln)St.push(dn[ln]),Jt.push(wr[ln])}if(ae.normal){const ln=Wt(fi,Se,Ki,ae.normal);_t.push(ln[0],ln[1],ln[2])}ae.material&&ae.material.mappingType!=="AllSame"&&(pr=Wt(fi,Se,Ki,ae.material)[0]),ae.uv&&ae.uv.forEach(function(ln,_n){const li=Wt(fi,Se,Ki,ln);ii[_n]===void 0&&(ii[_n]=[]),ii[_n].push(li[0]),ii[_n].push(li[1])}),Pe++,Xn&&(sn.genFace(ye,ae,Et,pr,_t,ft,ii,St,Jt,Pe),Se++,Pe=0,Et=[],_t=[],ft=[],ii=[],St=[],Jt=[])}),ye}genFace(ae,ye,Se,Pe,je,Et,_t,ft,ii,St){for(let Jt=2;Jt<St;Jt++)ae.vertex.push(ye.vertexPositions[Se[0]]),ae.vertex.push(ye.vertexPositions[Se[1]]),ae.vertex.push(ye.vertexPositions[Se[2]]),ae.vertex.push(ye.vertexPositions[Se[(Jt-1)*3]]),ae.vertex.push(ye.vertexPositions[Se[(Jt-1)*3+1]]),ae.vertex.push(ye.vertexPositions[Se[(Jt-1)*3+2]]),ae.vertex.push(ye.vertexPositions[Se[Jt*3]]),ae.vertex.push(ye.vertexPositions[Se[Jt*3+1]]),ae.vertex.push(ye.vertexPositions[Se[Jt*3+2]]),ye.skeleton&&(ae.vertexWeights.push(ft[0]),ae.vertexWeights.push(ft[1]),ae.vertexWeights.push(ft[2]),ae.vertexWeights.push(ft[3]),ae.vertexWeights.push(ft[(Jt-1)*4]),ae.vertexWeights.push(ft[(Jt-1)*4+1]),ae.vertexWeights.push(ft[(Jt-1)*4+2]),ae.vertexWeights.push(ft[(Jt-1)*4+3]),ae.vertexWeights.push(ft[Jt*4]),ae.vertexWeights.push(ft[Jt*4+1]),ae.vertexWeights.push(ft[Jt*4+2]),ae.vertexWeights.push(ft[Jt*4+3]),ae.weightsIndices.push(ii[0]),ae.weightsIndices.push(ii[1]),ae.weightsIndices.push(ii[2]),ae.weightsIndices.push(ii[3]),ae.weightsIndices.push(ii[(Jt-1)*4]),ae.weightsIndices.push(ii[(Jt-1)*4+1]),ae.weightsIndices.push(ii[(Jt-1)*4+2]),ae.weightsIndices.push(ii[(Jt-1)*4+3]),ae.weightsIndices.push(ii[Jt*4]),ae.weightsIndices.push(ii[Jt*4+1]),ae.weightsIndices.push(ii[Jt*4+2]),ae.weightsIndices.push(ii[Jt*4+3])),ye.color&&(ae.colors.push(Et[0]),ae.colors.push(Et[1]),ae.colors.push(Et[2]),ae.colors.push(Et[(Jt-1)*3]),ae.colors.push(Et[(Jt-1)*3+1]),ae.colors.push(Et[(Jt-1)*3+2]),ae.colors.push(Et[Jt*3]),ae.colors.push(Et[Jt*3+1]),ae.colors.push(Et[Jt*3+2])),ye.material&&ye.material.mappingType!=="AllSame"&&(ae.materialIndex.push(Pe),ae.materialIndex.push(Pe),ae.materialIndex.push(Pe)),ye.normal&&(ae.normal.push(je[0]),ae.normal.push(je[1]),ae.normal.push(je[2]),ae.normal.push(je[(Jt-1)*3]),ae.normal.push(je[(Jt-1)*3+1]),ae.normal.push(je[(Jt-1)*3+2]),ae.normal.push(je[Jt*3]),ae.normal.push(je[Jt*3+1]),ae.normal.push(je[Jt*3+2])),ye.uv&&ye.uv.forEach(function(sn,Ki){ae.uvs[Ki]===void 0&&(ae.uvs[Ki]=[]),ae.uvs[Ki].push(_t[Ki][0]),ae.uvs[Ki].push(_t[Ki][1]),ae.uvs[Ki].push(_t[Ki][(Jt-1)*2]),ae.uvs[Ki].push(_t[Ki][(Jt-1)*2+1]),ae.uvs[Ki].push(_t[Ki][Jt*2]),ae.uvs[Ki].push(_t[Ki][Jt*2+1])})}addMorphTargets(ae,ye,Se,Pe){if(Se.length===0)return;ae.morphTargetsRelative=!0,ae.morphAttributes.position=[];const je=this;Se.forEach(function(Et){Et.rawTargets.forEach(function(_t){const ft=D.Objects.Geometry[_t.geoID];ft!==void 0&&je.genMorphGeometry(ae,ye,ft,Pe,_t.name)})})}genMorphGeometry(ae,ye,Se,Pe,je){const Et=ye.PolygonVertexIndex!==void 0?ye.PolygonVertexIndex.a:[],_t=Se.Vertices!==void 0?Se.Vertices.a:[],ft=Se.Indexes!==void 0?Se.Indexes.a:[],ii=ae.attributes.position.count*3,St=new Float32Array(ii);for(let fi=0;fi<ft.length;fi++){const pr=ft[fi]*3;St[pr]=_t[fi*3],St[pr+1]=_t[fi*3+1],St[pr+2]=_t[fi*3+2]}const Jt={vertexIndices:Et,vertexPositions:St},sn=this.genBuffers(Jt),Ki=new f.Float32BufferAttribute(sn.vertex,3);Ki.name=je||Se.attrName,Ki.applyMatrix4(Pe),ae.morphAttributes.position.push(Ki)}parseNormals(ae){const ye=ae.MappingInformationType,Se=ae.ReferenceInformationType,Pe=ae.Normals.a;let je=[];return Se==="IndexToDirect"&&("NormalIndex"in ae?je=ae.NormalIndex.a:"NormalsIndex"in ae&&(je=ae.NormalsIndex.a)),{dataSize:3,buffer:Pe,indices:je,mappingType:ye,referenceType:Se}}parseUVs(ae){const ye=ae.MappingInformationType,Se=ae.ReferenceInformationType,Pe=ae.UV.a;let je=[];return Se==="IndexToDirect"&&(je=ae.UVIndex.a),{dataSize:2,buffer:Pe,indices:je,mappingType:ye,referenceType:Se}}parseVertexColors(ae){const ye=ae.MappingInformationType,Se=ae.ReferenceInformationType,Pe=ae.Colors.a;let je=[];return Se==="IndexToDirect"&&(je=ae.ColorIndex.a),{dataSize:4,buffer:Pe,indices:je,mappingType:ye,referenceType:Se}}parseMaterialIndices(ae){const ye=ae.MappingInformationType,Se=ae.ReferenceInformationType;if(ye==="NoMappingInformation")return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:Se};const Pe=ae.Materials.a,je=[];for(let Et=0;Et<Pe.length;++Et)je.push(Et);return{dataSize:1,buffer:Pe,indices:je,mappingType:ye,referenceType:Se}}parseNurbsGeometry(ae){if(f.NURBSCurve===void 0)return console.error("THREE.FBXLoader: The loader relies on THREE.NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new f.BufferGeometry;const ye=parseInt(ae.Order);if(isNaN(ye))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",ae.Order,ae.id),new f.BufferGeometry;const Se=ye-1,Pe=ae.KnotVector.a,je=[],Et=ae.Points.a;for(let Jt=0,sn=Et.length;Jt<sn;Jt+=4)je.push(new f.Vector4().fromArray(Et,Jt));let _t,ft;if(ae.Form==="Closed")je.push(je[0]);else if(ae.Form==="Periodic"){_t=Se,ft=Pe.length-1-_t;for(let Jt=0;Jt<Se;++Jt)je.push(je[Jt])}const St=new f.NURBSCurve(Se,Pe,je,_t,ft).getPoints(je.length*12);return new f.BufferGeometry().setFromPoints(St)}}class Q{parse(){const ae=[],ye=this.parseClips();if(ye!==void 0)for(const Se in ye){const Pe=ye[Se],je=this.addClip(Pe);ae.push(je)}return ae}parseClips(){if(D.Objects.AnimationCurve===void 0)return;const ae=this.parseAnimationCurveNodes();this.parseAnimationCurves(ae);const ye=this.parseAnimationLayers(ae);return this.parseAnimStacks(ye)}parseAnimationCurveNodes(){const ae=D.Objects.AnimationCurveNode,ye=new Map;for(const Se in ae){const Pe=ae[Se];if(Pe.attrName.match(/S|R|T|DeformPercent/)!==null){const je={id:Pe.id,attr:Pe.attrName,curves:{}};ye.set(je.id,je)}}return ye}parseAnimationCurves(ae){const ye=D.Objects.AnimationCurve;for(const Se in ye){const Pe={id:ye[Se].id,times:ye[Se].KeyTime.a.map(Lt),values:ye[Se].KeyValueFloat.a},je=U.get(Pe.id);if(je!==void 0){const Et=je.parents[0].ID,_t=je.parents[0].relationship;_t.match(/X/)?ae.get(Et).curves.x=Pe:_t.match(/Y/)?ae.get(Et).curves.y=Pe:_t.match(/Z/)?ae.get(Et).curves.z=Pe:_t.match(/d|DeformPercent/)&&ae.has(Et)&&(ae.get(Et).curves.morph=Pe)}}}parseAnimationLayers(ae){const ye=D.Objects.AnimationLayer,Se=new Map;for(const Pe in ye){const je=[],Et=U.get(parseInt(Pe));Et!==void 0&&(Et.children.forEach(function(ft,ii){if(ae.has(ft.ID)){const St=ae.get(ft.ID);if(St.curves.x!==void 0||St.curves.y!==void 0||St.curves.z!==void 0){if(je[ii]===void 0){const Jt=U.get(ft.ID).parents.filter(function(sn){return sn.relationship!==void 0})[0].ID;if(Jt!==void 0){const sn=D.Objects.Model[Jt.toString()];if(sn===void 0){console.warn("THREE.FBXLoader: Encountered a unused curve.",ft);return}const Ki={modelName:sn.attrName?f.PropertyBinding.sanitizeNodeName(sn.attrName):"",ID:sn.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};B.traverse(function(fi){fi.ID===sn.id&&(Ki.transform=fi.matrix,fi.userData.transformData&&(Ki.eulerOrder=fi.userData.transformData.eulerOrder))}),Ki.transform||(Ki.transform=new f.Matrix4),"PreRotation"in sn&&(Ki.preRotation=sn.PreRotation.value),"PostRotation"in sn&&(Ki.postRotation=sn.PostRotation.value),je[ii]=Ki}}je[ii]&&(je[ii][St.attr]=St)}else if(St.curves.morph!==void 0){if(je[ii]===void 0){const Jt=U.get(ft.ID).parents.filter(function(wr){return wr.relationship!==void 0})[0].ID,sn=U.get(Jt).parents[0].ID,Ki=U.get(sn).parents[0].ID,fi=U.get(Ki).parents[0].ID,pr=D.Objects.Model[fi],Xn={modelName:pr.attrName?f.PropertyBinding.sanitizeNodeName(pr.attrName):"",morphName:D.Objects.Deformer[Jt].attrName};je[ii]=Xn}je[ii][St.attr]=St}}}),Se.set(parseInt(Pe),je))}return Se}parseAnimStacks(ae){const ye=D.Objects.AnimationStack,Se={};for(const Pe in ye){const je=U.get(parseInt(Pe)).children;je.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const Et=ae.get(je[0].ID);Se[Pe]={name:ye[Pe].attrName,layer:Et}}return Se}addClip(ae){let ye=[];const Se=this;return ae.layer.forEach(function(Pe){ye=ye.concat(Se.generateTracks(Pe))}),new f.AnimationClip(ae.name,-1,ye)}generateTracks(ae){const ye=[];let Se=new f.Vector3,Pe=new f.Quaternion,je=new f.Vector3;if(ae.transform&&ae.transform.decompose(Se,Pe,je),Se=Se.toArray(),Pe=new f.Euler().setFromQuaternion(Pe,ae.eulerOrder).toArray(),je=je.toArray(),ae.T!==void 0&&Object.keys(ae.T.curves).length>0){const Et=this.generateVectorTrack(ae.modelName,ae.T.curves,Se,"position");Et!==void 0&&ye.push(Et)}if(ae.R!==void 0&&Object.keys(ae.R.curves).length>0){const Et=this.generateRotationTrack(ae.modelName,ae.R.curves,Pe,ae.preRotation,ae.postRotation,ae.eulerOrder);Et!==void 0&&ye.push(Et)}if(ae.S!==void 0&&Object.keys(ae.S.curves).length>0){const Et=this.generateVectorTrack(ae.modelName,ae.S.curves,je,"scale");Et!==void 0&&ye.push(Et)}if(ae.DeformPercent!==void 0){const Et=this.generateMorphTrack(ae);Et!==void 0&&ye.push(Et)}return ye}generateVectorTrack(ae,ye,Se,Pe){const je=this.getTimesForAllAxes(ye),Et=this.getKeyframeTrackValues(je,ye,Se);return new f.VectorKeyframeTrack(ae+"."+Pe,je,Et)}generateRotationTrack(ae,ye,Se,Pe,je,Et){ye.x!==void 0&&(this.interpolateRotations(ye.x),ye.x.values=ye.x.values.map(f.MathUtils.degToRad)),ye.y!==void 0&&(this.interpolateRotations(ye.y),ye.y.values=ye.y.values.map(f.MathUtils.degToRad)),ye.z!==void 0&&(this.interpolateRotations(ye.z),ye.z.values=ye.z.values.map(f.MathUtils.degToRad));const _t=this.getTimesForAllAxes(ye),ft=this.getKeyframeTrackValues(_t,ye,Se);Pe!==void 0&&(Pe=Pe.map(f.MathUtils.degToRad),Pe.push(Et),Pe=new f.Euler().fromArray(Pe),Pe=new f.Quaternion().setFromEuler(Pe)),je!==void 0&&(je=je.map(f.MathUtils.degToRad),je.push(Et),je=new f.Euler().fromArray(je),je=new f.Quaternion().setFromEuler(je).invert());const ii=new f.Quaternion,St=new f.Euler,Jt=[];for(let sn=0;sn<ft.length;sn+=3)St.set(ft[sn],ft[sn+1],ft[sn+2],Et),ii.setFromEuler(St),Pe!==void 0&&ii.premultiply(Pe),je!==void 0&&ii.multiply(je),ii.toArray(Jt,sn/3*4);return new f.QuaternionKeyframeTrack(ae+".quaternion",_t,Jt)}generateMorphTrack(ae){const ye=ae.DeformPercent.curves.morph,Se=ye.values.map(function(je){return je/100}),Pe=B.getObjectByName(ae.modelName).morphTargetDictionary[ae.morphName];return new f.NumberKeyframeTrack(ae.modelName+".morphTargetInfluences["+Pe+"]",ye.times,Se)}getTimesForAllAxes(ae){let ye=[];if(ae.x!==void 0&&(ye=ye.concat(ae.x.times)),ae.y!==void 0&&(ye=ye.concat(ae.y.times)),ae.z!==void 0&&(ye=ye.concat(ae.z.times)),ye=ye.sort(function(Se,Pe){return Se-Pe}),ye.length>1){let Se=1,Pe=ye[0];for(let je=1;je<ye.length;je++){const Et=ye[je];Et!==Pe&&(ye[Se]=Et,Pe=Et,Se++)}ye=ye.slice(0,Se)}return ye}getKeyframeTrackValues(ae,ye,Se){const Pe=Se,je=[];let Et=-1,_t=-1,ft=-1;return ae.forEach(function(ii){if(ye.x&&(Et=ye.x.times.indexOf(ii)),ye.y&&(_t=ye.y.times.indexOf(ii)),ye.z&&(ft=ye.z.times.indexOf(ii)),Et!==-1){const St=ye.x.values[Et];je.push(St),Pe[0]=St}else je.push(Pe[0]);if(_t!==-1){const St=ye.y.values[_t];je.push(St),Pe[1]=St}else je.push(Pe[1]);if(ft!==-1){const St=ye.z.values[ft];je.push(St),Pe[2]=St}else je.push(Pe[2])}),je}interpolateRotations(ae){for(let ye=1;ye<ae.values.length;ye++){const Se=ae.values[ye-1],Pe=ae.values[ye]-Se,je=Math.abs(Pe);if(je>=180){const Et=je/180,_t=Pe/Et;let ft=Se+_t;const ii=ae.times[ye-1],Jt=(ae.times[ye]-ii)/Et;let sn=ii+Jt;const Ki=[],fi=[];for(;sn<ae.times[ye];)Ki.push(sn),sn+=Jt,fi.push(ft),ft+=_t;ae.times=en(ae.times,ye,Ki),ae.values=en(ae.values,ye,fi)}}}}class oe{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(ae){this.nodeStack.push(ae),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(ae,ye){this.currentProp=ae,this.currentPropName=ye}parse(ae){this.currentIndent=0,this.allNodes=new We,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const ye=this,Se=ae.split(/[\r\n]+/);return Se.forEach(function(Pe,je){const Et=Pe.match(/^[\s\t]*;/),_t=Pe.match(/^[\s\t]*$/);if(Et||_t)return;const ft=Pe.match("^\\t{"+ye.currentIndent+"}(\\w+):(.*){",""),ii=Pe.match("^\\t{"+ye.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),St=Pe.match("^\\t{"+(ye.currentIndent-1)+"}}");ft?ye.parseNodeBegin(Pe,ft):ii?ye.parseNodeProperty(Pe,ii,Se[++je]):St?ye.popStack():Pe.match(/^[^\s\t}]/)&&ye.parseNodePropertyContinued(Pe)}),this.allNodes}parseNodeBegin(ae,ye){const Se=ye[1].trim().replace(/^"/,"").replace(/"$/,""),Pe=ye[2].split(",").map(function(ft){return ft.trim().replace(/^"/,"").replace(/"$/,"")}),je={name:Se},Et=this.parseNodeAttr(Pe),_t=this.getCurrentNode();this.currentIndent===0?this.allNodes.add(Se,je):Se in _t?(Se==="PoseNode"?_t.PoseNode.push(je):_t[Se].id!==void 0&&(_t[Se]={},_t[Se][_t[Se].id]=_t[Se]),Et.id!==""&&(_t[Se][Et.id]=je)):typeof Et.id=="number"?(_t[Se]={},_t[Se][Et.id]=je):Se!=="Properties70"&&(Se==="PoseNode"?_t[Se]=[je]:_t[Se]=je),typeof Et.id=="number"&&(je.id=Et.id),Et.name!==""&&(je.attrName=Et.name),Et.type!==""&&(je.attrType=Et.type),this.pushStack(je)}parseNodeAttr(ae){let ye=ae[0];ae[0]!==""&&(ye=parseInt(ae[0]),isNaN(ye)&&(ye=ae[0]));let Se="",Pe="";return ae.length>1&&(Se=ae[1].replace(/^(\w+)::/,""),Pe=ae[2]),{id:ye,name:Se,type:Pe}}parseNodeProperty(ae,ye,Se){let Pe=ye[1].replace(/^"/,"").replace(/"$/,"").trim(),je=ye[2].replace(/^"/,"").replace(/"$/,"").trim();Pe==="Content"&&je===","&&(je=Se.replace(/"/g,"").replace(/,$/,"").trim());const Et=this.getCurrentNode();if(Et.name==="Properties70"){this.parseNodeSpecialProperty(ae,Pe,je);return}if(Pe==="C"){const ft=je.split(",").slice(1),ii=parseInt(ft[0]),St=parseInt(ft[1]);let Jt=je.split(",").slice(3);Jt=Jt.map(function(sn){return sn.trim().replace(/^"/,"")}),Pe="connections",je=[ii,St],st(je,Jt),Et[Pe]===void 0&&(Et[Pe]=[])}Pe==="Node"&&(Et.id=je),Pe in Et&&Array.isArray(Et[Pe])?Et[Pe].push(je):Pe!=="a"?Et[Pe]=je:Et.a=je,this.setCurrentProp(Et,Pe),Pe==="a"&&je.slice(-1)!==","&&(Et.a=Ni(je))}parseNodePropertyContinued(ae){const ye=this.getCurrentNode();ye.a+=ae,ae.slice(-1)!==","&&(ye.a=Ni(ye.a))}parseNodeSpecialProperty(ae,ye,Se){const Pe=Se.split('",').map(function(St){return St.trim().replace(/^\"/,"").replace(/\s/,"_")}),je=Pe[0],Et=Pe[1],_t=Pe[2],ft=Pe[3];let ii=Pe[4];switch(Et){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":ii=parseFloat(ii);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":ii=Ni(ii);break}this.getPrevNode()[je]={type:Et,type2:_t,flag:ft,value:ii},this.setCurrentProp(this.getPrevNode(),je)}}class ve{parse(ae){const ye=new Ee(ae);ye.skip(23);const Se=ye.getUint32();if(Se<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+Se);const Pe=new We;for(;!this.endOfContent(ye);){const je=this.parseNode(ye,Se);je!==null&&Pe.add(je.name,je)}return Pe}endOfContent(ae){return ae.size()%16===0?(ae.getOffset()+160+16&-16)>=ae.size():ae.getOffset()+160+16>=ae.size()}parseNode(ae,ye){const Se={},Pe=ye>=7500?ae.getUint64():ae.getUint32(),je=ye>=7500?ae.getUint64():ae.getUint32();ye>=7500?ae.getUint64():ae.getUint32();const Et=ae.getUint8(),_t=ae.getString(Et);if(Pe===0)return null;const ft=[];for(let sn=0;sn<je;sn++)ft.push(this.parseProperty(ae));const ii=ft.length>0?ft[0]:"",St=ft.length>1?ft[1]:"",Jt=ft.length>2?ft[2]:"";for(Se.singleProperty=je===1&&ae.getOffset()===Pe;Pe>ae.getOffset();){const sn=this.parseNode(ae,ye);sn!==null&&this.parseSubNode(_t,Se,sn)}return Se.propertyList=ft,typeof ii=="number"&&(Se.id=ii),St!==""&&(Se.attrName=St),Jt!==""&&(Se.attrType=Jt),_t!==""&&(Se.name=_t),Se}parseSubNode(ae,ye,Se){if(Se.singleProperty===!0){const Pe=Se.propertyList[0];Array.isArray(Pe)?(ye[Se.name]=Se,Se.a=Pe):ye[Se.name]=Pe}else if(ae==="Connections"&&Se.name==="C"){const Pe=[];Se.propertyList.forEach(function(je,Et){Et!==0&&Pe.push(je)}),ye.connections===void 0&&(ye.connections=[]),ye.connections.push(Pe)}else if(Se.name==="Properties70")Object.keys(Se).forEach(function(je){ye[je]=Se[je]});else if(ae==="Properties70"&&Se.name==="P"){let Pe=Se.propertyList[0],je=Se.propertyList[1];const Et=Se.propertyList[2],_t=Se.propertyList[3];let ft;Pe.indexOf("Lcl ")===0&&(Pe=Pe.replace("Lcl ","Lcl_")),je.indexOf("Lcl ")===0&&(je=je.replace("Lcl ","Lcl_")),je==="Color"||je==="ColorRGB"||je==="Vector"||je==="Vector3D"||je.indexOf("Lcl_")===0?ft=[Se.propertyList[4],Se.propertyList[5],Se.propertyList[6]]:ft=Se.propertyList[4],ye[Pe]={type:je,type2:Et,flag:_t,value:ft}}else ye[Se.name]===void 0?typeof Se.id=="number"?(ye[Se.name]={},ye[Se.name][Se.id]=Se):ye[Se.name]=Se:Se.name==="PoseNode"?(Array.isArray(ye[Se.name])||(ye[Se.name]=[ye[Se.name]]),ye[Se.name].push(Se)):ye[Se.name][Se.id]===void 0&&(ye[Se.name][Se.id]=Se)}parseProperty(ae){const ye=ae.getString(1);let Se;switch(ye){case"C":return ae.getBoolean();case"D":return ae.getFloat64();case"F":return ae.getFloat32();case"I":return ae.getInt32();case"L":return ae.getInt64();case"R":return Se=ae.getUint32(),ae.getArrayBuffer(Se);case"S":return Se=ae.getUint32(),ae.getString(Se);case"Y":return ae.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const Pe=ae.getUint32(),je=ae.getUint32(),Et=ae.getUint32();if(je===0)switch(ye){case"b":case"c":return ae.getBooleanArray(Pe);case"d":return ae.getFloat64Array(Pe);case"f":return ae.getFloat32Array(Pe);case"i":return ae.getInt32Array(Pe);case"l":return ae.getInt64Array(Pe)}typeof C>"u"&&console.error("THREE.FBXLoader: External library fflate.min.js required.");const _t=C.unzlibSync(new Uint8Array(ae.getArrayBuffer(Et))),ft=new Ee(_t.buffer);switch(ye){case"b":case"c":return ft.getBooleanArray(Pe);case"d":return ft.getFloat64Array(Pe);case"f":return ft.getFloat32Array(Pe);case"i":return ft.getInt32Array(Pe);case"l":return ft.getInt64Array(Pe)}default:throw new Error("THREE.FBXLoader: Unknown property type "+ye)}}}class Ee{constructor(ae,ye){this.dv=new DataView(ae),this.offset=0,this.littleEndian=ye!==void 0?ye:!0}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(ae){this.offset+=ae}getBoolean(){return(this.getUint8()&1)===1}getBooleanArray(ae){const ye=[];for(let Se=0;Se<ae;Se++)ye.push(this.getBoolean());return ye}getUint8(){const ae=this.dv.getUint8(this.offset);return this.offset+=1,ae}getInt16(){const ae=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,ae}getInt32(){const ae=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,ae}getInt32Array(ae){const ye=[];for(let Se=0;Se<ae;Se++)ye.push(this.getInt32());return ye}getUint32(){const ae=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,ae}getInt64(){let ae,ye;return this.littleEndian?(ae=this.getUint32(),ye=this.getUint32()):(ye=this.getUint32(),ae=this.getUint32()),ye&2147483648?(ye=~ye&4294967295,ae=~ae&4294967295,ae===4294967295&&(ye=ye+1&4294967295),ae=ae+1&4294967295,-(ye*4294967296+ae)):ye*4294967296+ae}getInt64Array(ae){const ye=[];for(let Se=0;Se<ae;Se++)ye.push(this.getInt64());return ye}getUint64(){let ae,ye;return this.littleEndian?(ae=this.getUint32(),ye=this.getUint32()):(ye=this.getUint32(),ae=this.getUint32()),ye*4294967296+ae}getFloat32(){const ae=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,ae}getFloat32Array(ae){const ye=[];for(let Se=0;Se<ae;Se++)ye.push(this.getFloat32());return ye}getFloat64(){const ae=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,ae}getFloat64Array(ae){const ye=[];for(let Se=0;Se<ae;Se++)ye.push(this.getFloat64());return ye}getArrayBuffer(ae){const ye=this.dv.buffer.slice(this.offset,this.offset+ae);return this.offset+=ae,ye}getString(ae){let ye=[];for(let Pe=0;Pe<ae;Pe++)ye[Pe]=this.getUint8();const Se=ye.indexOf(0);return Se>=0&&(ye=ye.slice(0,Se)),f.LoaderUtils.decodeText(new Uint8Array(ye))}}class We{add(ae,ye){this[ae]=ye}}function Re(ci){const ae="Kaydara FBX Binary  \0";return ci.byteLength>=ae.length&&ae===Qe(ci,0,ae.length)}function He(ci){const ae=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let ye=0;function Se(Pe){const je=ci[Pe-1];return ci=ci.slice(ye+Pe),ye++,je}for(let Pe=0;Pe<ae.length;++Pe)if(Se(1)===ae[Pe])return!1;return!0}function Mt(ci){const ae=/FBXVersion: (\d+)/,ye=ci.match(ae);if(ye)return parseInt(ye[1]);throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function Lt(ci){return ci/46186158e3}const Ut=[];function Wt(ci,ae,ye,Se){let Pe;switch(Se.mappingType){case"ByPolygonVertex":Pe=ci;break;case"ByPolygon":Pe=ae;break;case"ByVertice":Pe=ye;break;case"AllSame":Pe=Se.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+Se.mappingType)}Se.referenceType==="IndexToDirect"&&(Pe=Se.indices[Pe]);const je=Pe*Se.dataSize,Et=je+Se.dataSize;return Ht(Ut,Se.buffer,je,Et)}const lt=new f.Euler,Ct=new f.Vector3;function qt(ci){const ae=new f.Matrix4,ye=new f.Matrix4,Se=new f.Matrix4,Pe=new f.Matrix4,je=new f.Matrix4,Et=new f.Matrix4,_t=new f.Matrix4,ft=new f.Matrix4,ii=new f.Matrix4,St=new f.Matrix4,Jt=new f.Matrix4,sn=new f.Matrix4,Ki=ci.inheritType?ci.inheritType:0;if(ci.translation&&ae.setPosition(Ct.fromArray(ci.translation)),ci.preRotation){const Ye=ci.preRotation.map(f.MathUtils.degToRad);Ye.push(ci.eulerOrder),ye.makeRotationFromEuler(lt.fromArray(Ye))}if(ci.rotation){const Ye=ci.rotation.map(f.MathUtils.degToRad);Ye.push(ci.eulerOrder),Se.makeRotationFromEuler(lt.fromArray(Ye))}if(ci.postRotation){const Ye=ci.postRotation.map(f.MathUtils.degToRad);Ye.push(ci.eulerOrder),Pe.makeRotationFromEuler(lt.fromArray(Ye)),Pe.invert()}ci.scale&&je.scale(Ct.fromArray(ci.scale)),ci.scalingOffset&&_t.setPosition(Ct.fromArray(ci.scalingOffset)),ci.scalingPivot&&Et.setPosition(Ct.fromArray(ci.scalingPivot)),ci.rotationOffset&&ft.setPosition(Ct.fromArray(ci.rotationOffset)),ci.rotationPivot&&ii.setPosition(Ct.fromArray(ci.rotationPivot)),ci.parentMatrixWorld&&(Jt.copy(ci.parentMatrix),St.copy(ci.parentMatrixWorld));const fi=ye.clone().multiply(Se).multiply(Pe),pr=new f.Matrix4;pr.extractRotation(St);const Xn=new f.Matrix4;Xn.copyPosition(St);const wr=Xn.clone().invert().multiply(St),dn=pr.clone().invert().multiply(wr),ln=je,_n=new f.Matrix4;if(Ki===0)_n.copy(pr).multiply(fi).multiply(dn).multiply(ln);else if(Ki===1)_n.copy(pr).multiply(dn).multiply(fi).multiply(ln);else{const xt=new f.Matrix4().scale(new f.Vector3().setFromMatrixScale(Jt)).clone().invert(),zt=dn.clone().multiply(xt);_n.copy(pr).multiply(fi).multiply(zt).multiply(ln)}const li=ii.clone().invert(),Ie=Et.clone().invert();let ke=ae.clone().multiply(ft).multiply(ii).multiply(ye).multiply(Se).multiply(Pe).multiply(li).multiply(_t).multiply(Et).multiply(je).multiply(Ie);const ht=new f.Matrix4().copyPosition(ke),Ue=St.clone().multiply(ht);return sn.copyPosition(Ue),ke=sn.clone().multiply(_n),ke.premultiply(St.invert()),ke}function Ai(ci){ci=ci||0;const ae=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return ci===6?(console.warn("THREE.FBXLoader: unsupported THREE.Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),ae[0]):ae[ci]}function Ni(ci){return ci.split(",").map(function(ye){return parseFloat(ye)})}function Qe(ci,ae,ye){return ae===void 0&&(ae=0),ye===void 0&&(ye=ci.byteLength),f.LoaderUtils.decodeText(new Uint8Array(ci,ae,ye))}function st(ci,ae){for(let ye=0,Se=ci.length,Pe=ae.length;ye<Pe;ye++,Se++)ci[Se]=ae[ye]}function Ht(ci,ae,ye,Se){for(let Pe=ye,je=0;Pe<Se;Pe++,je++)ci[je]=ae[Pe];return ci}function en(ci,ae,ye){return ci.slice(0,ae).concat(ye).concat(ci.slice(ae))}f.FBXLoader=s})(),te.exports=f.FBXLoader})(T1);var vA=T1.exports,S1={exports:{}};(function(te,p){const f=va;(function(){class C extends f.Loader{constructor(Ie){super(Ie),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(ke){return new Z(ke)}),this.register(function(ke){return new Ee(ke)}),this.register(function(ke){return new We(ke)}),this.register(function(ke){return new j(ke)}),this.register(function(ke){return new Q(ke)}),this.register(function(ke){return new oe(ke)}),this.register(function(ke){return new ve(ke)}),this.register(function(ke){return new B(ke)}),this.register(function(ke){return new Re(ke)})}load(Ie,ke,ht,Ue){const Ye=this;let xt;this.resourcePath!==""?xt=this.resourcePath:this.path!==""?xt=this.path:xt=f.LoaderUtils.extractUrlBase(Ie),this.manager.itemStart(Ie);const zt=function(si){Ue?Ue(si):console.error(si),Ye.manager.itemError(Ie),Ye.manager.itemEnd(Ie)},It=new f.FileLoader(this.manager);It.setPath(this.path),It.setResponseType("arraybuffer"),It.setRequestHeader(this.requestHeader),It.setWithCredentials(this.withCredentials),It.load(Ie,function(si){try{Ye.parse(si,xt,function(Qi){ke(Qi),Ye.manager.itemEnd(Ie)},zt)}catch(Qi){zt(Qi)}},ht,zt)}setDRACOLoader(Ie){return this.dracoLoader=Ie,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(Ie){return this.ktx2Loader=Ie,this}setMeshoptDecoder(Ie){return this.meshoptDecoder=Ie,this}register(Ie){return this.pluginCallbacks.indexOf(Ie)===-1&&this.pluginCallbacks.push(Ie),this}unregister(Ie){return this.pluginCallbacks.indexOf(Ie)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(Ie),1),this}parse(Ie,ke,ht,Ue){let Ye;const xt={},zt={};if(typeof Ie=="string")Ye=Ie;else if(f.LoaderUtils.decodeText(new Uint8Array(Ie,0,4))===He){try{xt[U.KHR_BINARY_GLTF]=new Ut(Ie)}catch(tn){Ue&&Ue(tn);return}Ye=xt[U.KHR_BINARY_GLTF].content}else Ye=f.LoaderUtils.decodeText(new Uint8Array(Ie));const It=JSON.parse(Ye);if(It.asset===void 0||It.asset.version[0]<2){Ue&&Ue(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const si=new Xn(It,{path:ke||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});si.fileLoader.setRequestHeader(this.requestHeader);for(let Qi=0;Qi<this.pluginCallbacks.length;Qi++){const tn=this.pluginCallbacks[Qi](si);zt[tn.name]=tn,xt[tn.name]=!0}if(It.extensionsUsed)for(let Qi=0;Qi<It.extensionsUsed.length;++Qi){const tn=It.extensionsUsed[Qi],kn=It.extensionsRequired||[];switch(tn){case U.KHR_MATERIALS_UNLIT:xt[tn]=new s;break;case U.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:xt[tn]=new qt;break;case U.KHR_DRACO_MESH_COMPRESSION:xt[tn]=new Wt(It,this.dracoLoader);break;case U.KHR_TEXTURE_TRANSFORM:xt[tn]=new lt;break;case U.KHR_MESH_QUANTIZATION:xt[tn]=new Ai;break;default:kn.indexOf(tn)>=0&&zt[tn]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+tn+'".')}}si.setExtensions(xt),si.setPlugins(zt),si.parse(ht,Ue)}}function D(){let li={};return{get:function(Ie){return li[Ie]},add:function(Ie,ke){li[Ie]=ke},remove:function(Ie){delete li[Ie]},removeAll:function(){li={}}}}const U={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};class B{constructor(Ie){this.parser=Ie,this.name=U.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const Ie=this.parser,ke=this.parser.json.nodes||[];for(let ht=0,Ue=ke.length;ht<Ue;ht++){const Ye=ke[ht];Ye.extensions&&Ye.extensions[this.name]&&Ye.extensions[this.name].light!==void 0&&Ie._addNodeRef(this.cache,Ye.extensions[this.name].light)}}_loadLight(Ie){const ke=this.parser,ht="light:"+Ie;let Ue=ke.cache.get(ht);if(Ue)return Ue;const Ye=ke.json,It=((Ye.extensions&&Ye.extensions[this.name]||{}).lights||[])[Ie];let si;const Qi=new f.Color(16777215);It.color!==void 0&&Qi.fromArray(It.color);const tn=It.range!==void 0?It.range:0;switch(It.type){case"directional":si=new f.DirectionalLight(Qi),si.target.position.set(0,0,-1),si.add(si.target);break;case"point":si=new f.PointLight(Qi),si.distance=tn;break;case"spot":si=new f.SpotLight(Qi),si.distance=tn,It.spot=It.spot||{},It.spot.innerConeAngle=It.spot.innerConeAngle!==void 0?It.spot.innerConeAngle:0,It.spot.outerConeAngle=It.spot.outerConeAngle!==void 0?It.spot.outerConeAngle:Math.PI/4,si.angle=It.spot.outerConeAngle,si.penumbra=1-It.spot.innerConeAngle/It.spot.outerConeAngle,si.target.position.set(0,0,-1),si.add(si.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+It.type)}return si.position.set(0,0,0),si.decay=2,It.intensity!==void 0&&(si.intensity=It.intensity),si.name=ke.createUniqueName(It.name||"light_"+Ie),Ue=Promise.resolve(si),ke.cache.add(ht,Ue),Ue}createNodeAttachment(Ie){const ke=this,ht=this.parser,Ye=ht.json.nodes[Ie],zt=(Ye.extensions&&Ye.extensions[this.name]||{}).light;return zt===void 0?null:this._loadLight(zt).then(function(It){return ht._getNodeRef(ke.cache,zt,It)})}}class s{constructor(){this.name=U.KHR_MATERIALS_UNLIT}getMaterialType(){return f.MeshBasicMaterial}extendParams(Ie,ke,ht){const Ue=[];Ie.color=new f.Color(1,1,1),Ie.opacity=1;const Ye=ke.pbrMetallicRoughness;if(Ye){if(Array.isArray(Ye.baseColorFactor)){const xt=Ye.baseColorFactor;Ie.color.fromArray(xt),Ie.opacity=xt[3]}Ye.baseColorTexture!==void 0&&Ue.push(ht.assignTexture(Ie,"map",Ye.baseColorTexture))}return Promise.all(Ue)}}class Z{constructor(Ie){this.parser=Ie,this.name=U.KHR_MATERIALS_CLEARCOAT}getMaterialType(Ie){const ht=this.parser.json.materials[Ie];return!ht.extensions||!ht.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(Ie,ke){const ht=this.parser,Ue=ht.json.materials[Ie];if(!Ue.extensions||!Ue.extensions[this.name])return Promise.resolve();const Ye=[],xt=Ue.extensions[this.name];if(xt.clearcoatFactor!==void 0&&(ke.clearcoat=xt.clearcoatFactor),xt.clearcoatTexture!==void 0&&Ye.push(ht.assignTexture(ke,"clearcoatMap",xt.clearcoatTexture)),xt.clearcoatRoughnessFactor!==void 0&&(ke.clearcoatRoughness=xt.clearcoatRoughnessFactor),xt.clearcoatRoughnessTexture!==void 0&&Ye.push(ht.assignTexture(ke,"clearcoatRoughnessMap",xt.clearcoatRoughnessTexture)),xt.clearcoatNormalTexture!==void 0&&(Ye.push(ht.assignTexture(ke,"clearcoatNormalMap",xt.clearcoatNormalTexture)),xt.clearcoatNormalTexture.scale!==void 0)){const zt=xt.clearcoatNormalTexture.scale;ke.clearcoatNormalScale=new f.Vector2(zt,-zt)}return Promise.all(Ye)}}class j{constructor(Ie){this.parser=Ie,this.name=U.KHR_MATERIALS_TRANSMISSION}getMaterialType(Ie){const ht=this.parser.json.materials[Ie];return!ht.extensions||!ht.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(Ie,ke){const ht=this.parser,Ue=ht.json.materials[Ie];if(!Ue.extensions||!Ue.extensions[this.name])return Promise.resolve();const Ye=[],xt=Ue.extensions[this.name];return xt.transmissionFactor!==void 0&&(ke.transmission=xt.transmissionFactor),xt.transmissionTexture!==void 0&&Ye.push(ht.assignTexture(ke,"transmissionMap",xt.transmissionTexture)),Promise.all(Ye)}}class Q{constructor(Ie){this.parser=Ie,this.name=U.KHR_MATERIALS_VOLUME}getMaterialType(Ie){const ht=this.parser.json.materials[Ie];return!ht.extensions||!ht.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(Ie,ke){const ht=this.parser,Ue=ht.json.materials[Ie];if(!Ue.extensions||!Ue.extensions[this.name])return Promise.resolve();const Ye=[],xt=Ue.extensions[this.name];ke.thickness=xt.thicknessFactor!==void 0?xt.thicknessFactor:0,xt.thicknessTexture!==void 0&&Ye.push(ht.assignTexture(ke,"thicknessMap",xt.thicknessTexture)),ke.attenuationDistance=xt.attenuationDistance||0;const zt=xt.attenuationColor||[1,1,1];return ke.attenuationTint=new f.Color(zt[0],zt[1],zt[2]),Promise.all(Ye)}}class oe{constructor(Ie){this.parser=Ie,this.name=U.KHR_MATERIALS_IOR}getMaterialType(Ie){const ht=this.parser.json.materials[Ie];return!ht.extensions||!ht.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(Ie,ke){const Ue=this.parser.json.materials[Ie];if(!Ue.extensions||!Ue.extensions[this.name])return Promise.resolve();const Ye=Ue.extensions[this.name];return ke.ior=Ye.ior!==void 0?Ye.ior:1.5,Promise.resolve()}}class ve{constructor(Ie){this.parser=Ie,this.name=U.KHR_MATERIALS_SPECULAR}getMaterialType(Ie){const ht=this.parser.json.materials[Ie];return!ht.extensions||!ht.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(Ie,ke){const ht=this.parser,Ue=ht.json.materials[Ie];if(!Ue.extensions||!Ue.extensions[this.name])return Promise.resolve();const Ye=[],xt=Ue.extensions[this.name];ke.specularIntensity=xt.specularFactor!==void 0?xt.specularFactor:1,xt.specularTexture!==void 0&&Ye.push(ht.assignTexture(ke,"specularIntensityMap",xt.specularTexture));const zt=xt.specularColorFactor||[1,1,1];return ke.specularTint=new f.Color(zt[0],zt[1],zt[2]),xt.specularColorTexture!==void 0&&Ye.push(ht.assignTexture(ke,"specularTintMap",xt.specularColorTexture).then(function(It){It.encoding=f.sRGBEncoding})),Promise.all(Ye)}}class Ee{constructor(Ie){this.parser=Ie,this.name=U.KHR_TEXTURE_BASISU}loadTexture(Ie){const ke=this.parser,ht=ke.json,Ue=ht.textures[Ie];if(!Ue.extensions||!Ue.extensions[this.name])return null;const Ye=Ue.extensions[this.name],xt=ht.images[Ye.source],zt=ke.options.ktx2Loader;if(!zt){if(ht.extensionsRequired&&ht.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return ke.loadTextureImage(Ie,xt,zt)}}class We{constructor(Ie){this.parser=Ie,this.name=U.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(Ie){const ke=this.name,ht=this.parser,Ue=ht.json,Ye=Ue.textures[Ie];if(!Ye.extensions||!Ye.extensions[ke])return null;const xt=Ye.extensions[ke],zt=Ue.images[xt.source];let It=ht.textureLoader;if(zt.uri){const si=ht.options.manager.getHandler(zt.uri);si!==null&&(It=si)}return this.detectSupport().then(function(si){if(si)return ht.loadTextureImage(Ie,zt,It);if(Ue.extensionsRequired&&Ue.extensionsRequired.indexOf(ke)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return ht.loadTexture(Ie)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(Ie){const ke=new Image;ke.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",ke.onload=ke.onerror=function(){Ie(ke.height===1)}})),this.isSupported}}class Re{constructor(Ie){this.name=U.EXT_MESHOPT_COMPRESSION,this.parser=Ie}loadBufferView(Ie){const ke=this.parser.json,ht=ke.bufferViews[Ie];if(ht.extensions&&ht.extensions[this.name]){const Ue=ht.extensions[this.name],Ye=this.parser.getDependency("buffer",Ue.buffer),xt=this.parser.options.meshoptDecoder;if(!xt||!xt.supported){if(ke.extensionsRequired&&ke.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([Ye,xt.ready]).then(function(zt){const It=Ue.byteOffset||0,si=Ue.byteLength||0,Qi=Ue.count,tn=Ue.byteStride,kn=new ArrayBuffer(Qi*tn),Gn=new Uint8Array(zt[0],It,si);return xt.decodeGltfBuffer(new Uint8Array(kn),Qi,tn,Gn,Ue.mode,Ue.filter),kn})}else return null}}const He="glTF",Mt=12,Lt={JSON:1313821514,BIN:5130562};class Ut{constructor(Ie){this.name=U.KHR_BINARY_GLTF,this.content=null,this.body=null;const ke=new DataView(Ie,0,Mt);if(this.header={magic:f.LoaderUtils.decodeText(new Uint8Array(Ie.slice(0,4))),version:ke.getUint32(4,!0),length:ke.getUint32(8,!0)},this.header.magic!==He)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const ht=this.header.length-Mt,Ue=new DataView(Ie,Mt);let Ye=0;for(;Ye<ht;){const xt=Ue.getUint32(Ye,!0);Ye+=4;const zt=Ue.getUint32(Ye,!0);if(Ye+=4,zt===Lt.JSON){const It=new Uint8Array(Ie,Mt+Ye,xt);this.content=f.LoaderUtils.decodeText(It)}else if(zt===Lt.BIN){const It=Mt+Ye;this.body=Ie.slice(It,It+xt)}Ye+=xt}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Wt{constructor(Ie,ke){if(!ke)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=U.KHR_DRACO_MESH_COMPRESSION,this.json=Ie,this.dracoLoader=ke,this.dracoLoader.preload()}decodePrimitive(Ie,ke){const ht=this.json,Ue=this.dracoLoader,Ye=Ie.extensions[this.name].bufferView,xt=Ie.extensions[this.name].attributes,zt={},It={},si={};for(const Qi in xt){const tn=Se[Qi]||Qi.toLowerCase();zt[tn]=xt[Qi]}for(const Qi in Ie.attributes){const tn=Se[Qi]||Qi.toLowerCase();if(xt[Qi]!==void 0){const kn=ht.accessors[Ie.attributes[Qi]],Gn=en[kn.componentType];si[tn]=Gn,It[tn]=kn.normalized===!0}}return ke.getDependency("bufferView",Ye).then(function(Qi){return new Promise(function(tn){Ue.decodeDracoFile(Qi,function(kn){for(const Gn in kn.attributes){const Yn=kn.attributes[Gn],Jn=It[Gn];Jn!==void 0&&(Yn.normalized=Jn)}tn(kn)},zt,si)})})}}class lt{constructor(){this.name=U.KHR_TEXTURE_TRANSFORM}extendTexture(Ie,ke){return ke.texCoord!==void 0&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),ke.offset===void 0&&ke.rotation===void 0&&ke.scale===void 0||(Ie=Ie.clone(),ke.offset!==void 0&&Ie.offset.fromArray(ke.offset),ke.rotation!==void 0&&(Ie.rotation=ke.rotation),ke.scale!==void 0&&Ie.repeat.fromArray(ke.scale),Ie.needsUpdate=!0),Ie}}class Ct extends f.MeshStandardMaterial{constructor(Ie){super(),this.isGLTFSpecularGlossinessMaterial=!0;const ke=["#ifdef USE_SPECULARMAP","	uniform sampler2D specularMap;","#endif"].join(`
`),ht=["#ifdef USE_GLOSSINESSMAP","	uniform sampler2D glossinessMap;","#endif"].join(`
`),Ue=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","	vec4 texelSpecular = texture2D( specularMap, vUv );","	texelSpecular = sRGBToLinear( texelSpecular );","	// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","	specularFactor *= texelSpecular.rgb;","#endif"].join(`
`),Ye=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","	vec4 texelGlossiness = texture2D( glossinessMap, vUv );","	// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","	glossinessFactor *= texelGlossiness.a;","#endif"].join(`
`),xt=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.roughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.roughness += geometryRoughness;","material.roughness = min( material.roughness, 1.0 );","material.specularColor = specularFactor;"].join(`
`),zt={specular:{value:new f.Color().setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=zt,this.onBeforeCompile=function(It){for(const si in zt)It.uniforms[si]=zt[si];It.fragmentShader=It.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",ke).replace("#include <metalnessmap_pars_fragment>",ht).replace("#include <roughnessmap_fragment>",Ue).replace("#include <metalnessmap_fragment>",Ye).replace("#include <lights_physical_fragment>",xt)},Object.defineProperties(this,{specular:{get:function(){return zt.specular.value},set:function(It){zt.specular.value=It}},specularMap:{get:function(){return zt.specularMap.value},set:function(It){zt.specularMap.value=It,It?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return zt.glossiness.value},set:function(It){zt.glossiness.value=It}},glossinessMap:{get:function(){return zt.glossinessMap.value},set:function(It){zt.glossinessMap.value=It,It?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(Ie)}copy(Ie){return super.copy(Ie),this.specularMap=Ie.specularMap,this.specular.copy(Ie.specular),this.glossinessMap=Ie.glossinessMap,this.glossiness=Ie.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this}}class qt{constructor(){this.name=U.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,this.specularGlossinessParams=["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"]}getMaterialType(){return Ct}extendParams(Ie,ke,ht){const Ue=ke.extensions[this.name];Ie.color=new f.Color(1,1,1),Ie.opacity=1;const Ye=[];if(Array.isArray(Ue.diffuseFactor)){const xt=Ue.diffuseFactor;Ie.color.fromArray(xt),Ie.opacity=xt[3]}if(Ue.diffuseTexture!==void 0&&Ye.push(ht.assignTexture(Ie,"map",Ue.diffuseTexture)),Ie.emissive=new f.Color(0,0,0),Ie.glossiness=Ue.glossinessFactor!==void 0?Ue.glossinessFactor:1,Ie.specular=new f.Color(1,1,1),Array.isArray(Ue.specularFactor)&&Ie.specular.fromArray(Ue.specularFactor),Ue.specularGlossinessTexture!==void 0){const xt=Ue.specularGlossinessTexture;Ye.push(ht.assignTexture(Ie,"glossinessMap",xt)),Ye.push(ht.assignTexture(Ie,"specularMap",xt))}return Promise.all(Ye)}createMaterial(Ie){const ke=new Ct(Ie);return ke.fog=!0,ke.color=Ie.color,ke.map=Ie.map===void 0?null:Ie.map,ke.lightMap=null,ke.lightMapIntensity=1,ke.aoMap=Ie.aoMap===void 0?null:Ie.aoMap,ke.aoMapIntensity=1,ke.emissive=Ie.emissive,ke.emissiveIntensity=1,ke.emissiveMap=Ie.emissiveMap===void 0?null:Ie.emissiveMap,ke.bumpMap=Ie.bumpMap===void 0?null:Ie.bumpMap,ke.bumpScale=1,ke.normalMap=Ie.normalMap===void 0?null:Ie.normalMap,ke.normalMapType=f.TangentSpaceNormalMap,Ie.normalScale&&(ke.normalScale=Ie.normalScale),ke.displacementMap=null,ke.displacementScale=1,ke.displacementBias=0,ke.specularMap=Ie.specularMap===void 0?null:Ie.specularMap,ke.specular=Ie.specular,ke.glossinessMap=Ie.glossinessMap===void 0?null:Ie.glossinessMap,ke.glossiness=Ie.glossiness,ke.alphaMap=null,ke.envMap=Ie.envMap===void 0?null:Ie.envMap,ke.envMapIntensity=1,ke.refractionRatio=.98,ke}}class Ai{constructor(){this.name=U.KHR_MESH_QUANTIZATION}}class Ni extends f.Interpolant{constructor(Ie,ke,ht,Ue){super(Ie,ke,ht,Ue)}copySampleValue_(Ie){const ke=this.resultBuffer,ht=this.sampleValues,Ue=this.valueSize,Ye=Ie*Ue*3+Ue;for(let xt=0;xt!==Ue;xt++)ke[xt]=ht[Ye+xt];return ke}}Ni.prototype.beforeStart_=Ni.prototype.copySampleValue_,Ni.prototype.afterEnd_=Ni.prototype.copySampleValue_,Ni.prototype.interpolate_=function(li,Ie,ke,ht){const Ue=this.resultBuffer,Ye=this.sampleValues,xt=this.valueSize,zt=xt*2,It=xt*3,si=ht-Ie,Qi=(ke-Ie)/si,tn=Qi*Qi,kn=tn*Qi,Gn=li*It,Yn=Gn-It,Jn=-2*kn+3*tn,Dn=kn-tn,ar=1-Jn,rs=Dn-tn+Qi;for(let ms=0;ms!==xt;ms++){const Un=Ye[Yn+ms+xt],ho=Ye[Yn+ms+zt]*si,Ri=Ye[Gn+ms+xt],jr=Ye[Gn+ms]*si;Ue[ms]=ar*Un+rs*ho+Jn*Ri+Dn*jr}return Ue};const Qe=new f.Quaternion;class st extends Ni{interpolate_(Ie,ke,ht,Ue){const Ye=super.interpolate_(Ie,ke,ht,Ue);return Qe.fromArray(Ye).normalize().toArray(Ye),Ye}}const Ht={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},en={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},ci={9728:f.NearestFilter,9729:f.LinearFilter,9984:f.NearestMipmapNearestFilter,9985:f.LinearMipmapNearestFilter,9986:f.NearestMipmapLinearFilter,9987:f.LinearMipmapLinearFilter},ae={33071:f.ClampToEdgeWrapping,33648:f.MirroredRepeatWrapping,10497:f.RepeatWrapping},ye={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Se={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Pe={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},je={CUBICSPLINE:void 0,LINEAR:f.InterpolateLinear,STEP:f.InterpolateDiscrete},Et={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function _t(li,Ie){return typeof li!="string"||li===""?"":(/^https?:\/\//i.test(Ie)&&/^\//.test(li)&&(Ie=Ie.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(li)||/^data:.*,.*$/i.test(li)||/^blob:.*$/i.test(li)?li:Ie+li)}function ft(li){return li.DefaultMaterial===void 0&&(li.DefaultMaterial=new f.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:f.FrontSide})),li.DefaultMaterial}function ii(li,Ie,ke){for(const ht in ke.extensions)li[ht]===void 0&&(Ie.userData.gltfExtensions=Ie.userData.gltfExtensions||{},Ie.userData.gltfExtensions[ht]=ke.extensions[ht])}function St(li,Ie){Ie.extras!==void 0&&(typeof Ie.extras=="object"?Object.assign(li.userData,Ie.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+Ie.extras))}function Jt(li,Ie,ke){let ht=!1,Ue=!1;for(let zt=0,It=Ie.length;zt<It;zt++){const si=Ie[zt];if(si.POSITION!==void 0&&(ht=!0),si.NORMAL!==void 0&&(Ue=!0),ht&&Ue)break}if(!ht&&!Ue)return Promise.resolve(li);const Ye=[],xt=[];for(let zt=0,It=Ie.length;zt<It;zt++){const si=Ie[zt];if(ht){const Qi=si.POSITION!==void 0?ke.getDependency("accessor",si.POSITION):li.attributes.position;Ye.push(Qi)}if(Ue){const Qi=si.NORMAL!==void 0?ke.getDependency("accessor",si.NORMAL):li.attributes.normal;xt.push(Qi)}}return Promise.all([Promise.all(Ye),Promise.all(xt)]).then(function(zt){const It=zt[0],si=zt[1];return ht&&(li.morphAttributes.position=It),Ue&&(li.morphAttributes.normal=si),li.morphTargetsRelative=!0,li})}function sn(li,Ie){if(li.updateMorphTargets(),Ie.weights!==void 0)for(let ke=0,ht=Ie.weights.length;ke<ht;ke++)li.morphTargetInfluences[ke]=Ie.weights[ke];if(Ie.extras&&Array.isArray(Ie.extras.targetNames)){const ke=Ie.extras.targetNames;if(li.morphTargetInfluences.length===ke.length){li.morphTargetDictionary={};for(let ht=0,Ue=ke.length;ht<Ue;ht++)li.morphTargetDictionary[ke[ht]]=ht}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Ki(li){const Ie=li.extensions&&li.extensions[U.KHR_DRACO_MESH_COMPRESSION];let ke;return Ie?ke="draco:"+Ie.bufferView+":"+Ie.indices+":"+fi(Ie.attributes):ke=li.indices+":"+fi(li.attributes)+":"+li.mode,ke}function fi(li){let Ie="";const ke=Object.keys(li).sort();for(let ht=0,Ue=ke.length;ht<Ue;ht++)Ie+=ke[ht]+":"+li[ke[ht]]+";";return Ie}function pr(li){switch(li){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}class Xn{constructor(Ie={},ke={}){this.json=Ie,this.extensions={},this.plugins={},this.options=ke,this.cache=new D,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.textureCache={},this.nodeNamesUsed={},typeof createImageBitmap<"u"&&/Firefox/.test(navigator.userAgent)===!1?this.textureLoader=new f.ImageBitmapLoader(this.options.manager):this.textureLoader=new f.TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new f.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(Ie){this.extensions=Ie}setPlugins(Ie){this.plugins=Ie}parse(Ie,ke){const ht=this,Ue=this.json,Ye=this.extensions;this.cache.removeAll(),this._invokeAll(function(xt){return xt._markDefs&&xt._markDefs()}),Promise.all(this._invokeAll(function(xt){return xt.beforeRoot&&xt.beforeRoot()})).then(function(){return Promise.all([ht.getDependencies("scene"),ht.getDependencies("animation"),ht.getDependencies("camera")])}).then(function(xt){const zt={scene:xt[0][Ue.scene||0],scenes:xt[0],animations:xt[1],cameras:xt[2],asset:Ue.asset,parser:ht,userData:{}};ii(Ye,zt,Ue),St(zt,Ue),Promise.all(ht._invokeAll(function(It){return It.afterRoot&&It.afterRoot(zt)})).then(function(){Ie(zt)})}).catch(ke)}_markDefs(){const Ie=this.json.nodes||[],ke=this.json.skins||[],ht=this.json.meshes||[];for(let Ue=0,Ye=ke.length;Ue<Ye;Ue++){const xt=ke[Ue].joints;for(let zt=0,It=xt.length;zt<It;zt++)Ie[xt[zt]].isBone=!0}for(let Ue=0,Ye=Ie.length;Ue<Ye;Ue++){const xt=Ie[Ue];xt.mesh!==void 0&&(this._addNodeRef(this.meshCache,xt.mesh),xt.skin!==void 0&&(ht[xt.mesh].isSkinnedMesh=!0)),xt.camera!==void 0&&this._addNodeRef(this.cameraCache,xt.camera)}}_addNodeRef(Ie,ke){ke!==void 0&&(Ie.refs[ke]===void 0&&(Ie.refs[ke]=Ie.uses[ke]=0),Ie.refs[ke]++)}_getNodeRef(Ie,ke,ht){if(Ie.refs[ke]<=1)return ht;const Ue=ht.clone();return Ue.name+="_instance_"+Ie.uses[ke]++,Ue}_invokeOne(Ie){const ke=Object.values(this.plugins);ke.push(this);for(let ht=0;ht<ke.length;ht++){const Ue=Ie(ke[ht]);if(Ue)return Ue}return null}_invokeAll(Ie){const ke=Object.values(this.plugins);ke.unshift(this);const ht=[];for(let Ue=0;Ue<ke.length;Ue++){const Ye=Ie(ke[Ue]);Ye&&ht.push(Ye)}return ht}getDependency(Ie,ke){const ht=Ie+":"+ke;let Ue=this.cache.get(ht);if(!Ue){switch(Ie){case"scene":Ue=this.loadScene(ke);break;case"node":Ue=this.loadNode(ke);break;case"mesh":Ue=this._invokeOne(function(Ye){return Ye.loadMesh&&Ye.loadMesh(ke)});break;case"accessor":Ue=this.loadAccessor(ke);break;case"bufferView":Ue=this._invokeOne(function(Ye){return Ye.loadBufferView&&Ye.loadBufferView(ke)});break;case"buffer":Ue=this.loadBuffer(ke);break;case"material":Ue=this._invokeOne(function(Ye){return Ye.loadMaterial&&Ye.loadMaterial(ke)});break;case"texture":Ue=this._invokeOne(function(Ye){return Ye.loadTexture&&Ye.loadTexture(ke)});break;case"skin":Ue=this.loadSkin(ke);break;case"animation":Ue=this.loadAnimation(ke);break;case"camera":Ue=this.loadCamera(ke);break;default:throw new Error("Unknown type: "+Ie)}this.cache.add(ht,Ue)}return Ue}getDependencies(Ie){let ke=this.cache.get(Ie);if(!ke){const ht=this,Ue=this.json[Ie+(Ie==="mesh"?"es":"s")]||[];ke=Promise.all(Ue.map(function(Ye,xt){return ht.getDependency(Ie,xt)})),this.cache.add(Ie,ke)}return ke}loadBuffer(Ie){const ke=this.json.buffers[Ie],ht=this.fileLoader;if(ke.type&&ke.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+ke.type+" buffer type is not supported.");if(ke.uri===void 0&&Ie===0)return Promise.resolve(this.extensions[U.KHR_BINARY_GLTF].body);const Ue=this.options;return new Promise(function(Ye,xt){ht.load(_t(ke.uri,Ue.path),Ye,void 0,function(){xt(new Error('THREE.GLTFLoader: Failed to load buffer "'+ke.uri+'".'))})})}loadBufferView(Ie){const ke=this.json.bufferViews[Ie];return this.getDependency("buffer",ke.buffer).then(function(ht){const Ue=ke.byteLength||0,Ye=ke.byteOffset||0;return ht.slice(Ye,Ye+Ue)})}loadAccessor(Ie){const ke=this,ht=this.json,Ue=this.json.accessors[Ie];if(Ue.bufferView===void 0&&Ue.sparse===void 0)return Promise.resolve(null);const Ye=[];return Ue.bufferView!==void 0?Ye.push(this.getDependency("bufferView",Ue.bufferView)):Ye.push(null),Ue.sparse!==void 0&&(Ye.push(this.getDependency("bufferView",Ue.sparse.indices.bufferView)),Ye.push(this.getDependency("bufferView",Ue.sparse.values.bufferView))),Promise.all(Ye).then(function(xt){const zt=xt[0],It=ye[Ue.type],si=en[Ue.componentType],Qi=si.BYTES_PER_ELEMENT,tn=Qi*It,kn=Ue.byteOffset||0,Gn=Ue.bufferView!==void 0?ht.bufferViews[Ue.bufferView].byteStride:void 0,Yn=Ue.normalized===!0;let Jn,Dn;if(Gn&&Gn!==tn){const ar=Math.floor(kn/Gn),rs="InterleavedBuffer:"+Ue.bufferView+":"+Ue.componentType+":"+ar+":"+Ue.count;let ms=ke.cache.get(rs);ms||(Jn=new si(zt,ar*Gn,Ue.count*Gn/Qi),ms=new f.InterleavedBuffer(Jn,Gn/Qi),ke.cache.add(rs,ms)),Dn=new f.InterleavedBufferAttribute(ms,It,kn%Gn/Qi,Yn)}else zt===null?Jn=new si(Ue.count*It):Jn=new si(zt,kn,Ue.count*It),Dn=new f.BufferAttribute(Jn,It,Yn);if(Ue.sparse!==void 0){const ar=ye.SCALAR,rs=en[Ue.sparse.indices.componentType],ms=Ue.sparse.indices.byteOffset||0,Un=Ue.sparse.values.byteOffset||0,ho=new rs(xt[1],ms,Ue.sparse.count*ar),Ri=new si(xt[2],Un,Ue.sparse.count*It);zt!==null&&(Dn=new f.BufferAttribute(Dn.array.slice(),Dn.itemSize,Dn.normalized));for(let jr=0,Ms=ho.length;jr<Ms;jr++){const Fs=ho[jr];if(Dn.setX(Fs,Ri[jr*It]),It>=2&&Dn.setY(Fs,Ri[jr*It+1]),It>=3&&Dn.setZ(Fs,Ri[jr*It+2]),It>=4&&Dn.setW(Fs,Ri[jr*It+3]),It>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse THREE.BufferAttribute.")}}return Dn})}loadTexture(Ie){const ke=this.json,ht=this.options,Ue=ke.textures[Ie],Ye=ke.images[Ue.source];let xt=this.textureLoader;if(Ye.uri){const zt=ht.manager.getHandler(Ye.uri);zt!==null&&(xt=zt)}return this.loadTextureImage(Ie,Ye,xt)}loadTextureImage(Ie,ke,ht){const Ue=this,Ye=this.json,xt=this.options,zt=Ye.textures[Ie],It=(ke.uri||ke.bufferView)+":"+zt.sampler;if(this.textureCache[It])return this.textureCache[It];const si=self.URL||self.webkitURL;let Qi=ke.uri||"",tn=!1,kn=!0;const Gn=Qi.search(/\.jpe?g($|\?)/i)>0||Qi.search(/^data\:image\/jpeg/)===0;if((ke.mimeType==="image/jpeg"||Gn)&&(kn=!1),ke.bufferView!==void 0)Qi=Ue.getDependency("bufferView",ke.bufferView).then(function(Jn){if(ke.mimeType==="image/png"){const ar=new DataView(Jn,25,1).getUint8(0,!1);kn=ar===6||ar===4||ar===3}tn=!0;const Dn=new Blob([Jn],{type:ke.mimeType});return Qi=si.createObjectURL(Dn),Qi});else if(ke.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+Ie+" is missing URI and bufferView");const Yn=Promise.resolve(Qi).then(function(Jn){return new Promise(function(Dn,ar){let rs=Dn;ht.isImageBitmapLoader===!0&&(rs=function(ms){const Un=new f.Texture(ms);Un.needsUpdate=!0,Dn(Un)}),ht.load(_t(Jn,xt.path),rs,void 0,ar)})}).then(function(Jn){tn===!0&&si.revokeObjectURL(Qi),Jn.flipY=!1,zt.name&&(Jn.name=zt.name),kn||(Jn.format=f.RGBFormat);const ar=(Ye.samplers||{})[zt.sampler]||{};return Jn.magFilter=ci[ar.magFilter]||f.LinearFilter,Jn.minFilter=ci[ar.minFilter]||f.LinearMipmapLinearFilter,Jn.wrapS=ae[ar.wrapS]||f.RepeatWrapping,Jn.wrapT=ae[ar.wrapT]||f.RepeatWrapping,Ue.associations.set(Jn,{type:"textures",index:Ie}),Jn}).catch(function(){return console.error("THREE.GLTFLoader: Couldn't load texture",Qi),null});return this.textureCache[It]=Yn,Yn}assignTexture(Ie,ke,ht){const Ue=this;return this.getDependency("texture",ht.index).then(function(Ye){if(ht.texCoord!==void 0&&ht.texCoord!=0&&!(ke==="aoMap"&&ht.texCoord==1)&&console.warn("THREE.GLTFLoader: Custom UV set "+ht.texCoord+" for texture "+ke+" not yet supported."),Ue.extensions[U.KHR_TEXTURE_TRANSFORM]){const xt=ht.extensions!==void 0?ht.extensions[U.KHR_TEXTURE_TRANSFORM]:void 0;if(xt){const zt=Ue.associations.get(Ye);Ye=Ue.extensions[U.KHR_TEXTURE_TRANSFORM].extendTexture(Ye,xt),Ue.associations.set(Ye,zt)}}return Ie[ke]=Ye,Ye})}assignFinalMaterial(Ie){const ke=Ie.geometry;let ht=Ie.material;const Ue=ke.attributes.tangent!==void 0,Ye=ke.attributes.color!==void 0,xt=ke.attributes.normal===void 0;if(Ie.isPoints){const zt="PointsMaterial:"+ht.uuid;let It=this.cache.get(zt);It||(It=new f.PointsMaterial,f.Material.prototype.copy.call(It,ht),It.color.copy(ht.color),It.map=ht.map,It.sizeAttenuation=!1,this.cache.add(zt,It)),ht=It}else if(Ie.isLine){const zt="LineBasicMaterial:"+ht.uuid;let It=this.cache.get(zt);It||(It=new f.LineBasicMaterial,f.Material.prototype.copy.call(It,ht),It.color.copy(ht.color),this.cache.add(zt,It)),ht=It}if(Ue||Ye||xt){let zt="ClonedMaterial:"+ht.uuid+":";ht.isGLTFSpecularGlossinessMaterial&&(zt+="specular-glossiness:"),Ue&&(zt+="vertex-tangents:"),Ye&&(zt+="vertex-colors:"),xt&&(zt+="flat-shading:");let It=this.cache.get(zt);It||(It=ht.clone(),Ye&&(It.vertexColors=!0),xt&&(It.flatShading=!0),Ue&&(It.normalScale&&(It.normalScale.y*=-1),It.clearcoatNormalScale&&(It.clearcoatNormalScale.y*=-1)),this.cache.add(zt,It),this.associations.set(It,this.associations.get(ht))),ht=It}ht.aoMap&&ke.attributes.uv2===void 0&&ke.attributes.uv!==void 0&&ke.setAttribute("uv2",ke.attributes.uv),Ie.material=ht}getMaterialType(){return f.MeshStandardMaterial}loadMaterial(Ie){const ke=this,ht=this.json,Ue=this.extensions,Ye=ht.materials[Ie];let xt;const zt={},It=Ye.extensions||{},si=[];if(It[U.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){const tn=Ue[U.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];xt=tn.getMaterialType(),si.push(tn.extendParams(zt,Ye,ke))}else if(It[U.KHR_MATERIALS_UNLIT]){const tn=Ue[U.KHR_MATERIALS_UNLIT];xt=tn.getMaterialType(),si.push(tn.extendParams(zt,Ye,ke))}else{const tn=Ye.pbrMetallicRoughness||{};if(zt.color=new f.Color(1,1,1),zt.opacity=1,Array.isArray(tn.baseColorFactor)){const kn=tn.baseColorFactor;zt.color.fromArray(kn),zt.opacity=kn[3]}tn.baseColorTexture!==void 0&&si.push(ke.assignTexture(zt,"map",tn.baseColorTexture)),zt.metalness=tn.metallicFactor!==void 0?tn.metallicFactor:1,zt.roughness=tn.roughnessFactor!==void 0?tn.roughnessFactor:1,tn.metallicRoughnessTexture!==void 0&&(si.push(ke.assignTexture(zt,"metalnessMap",tn.metallicRoughnessTexture)),si.push(ke.assignTexture(zt,"roughnessMap",tn.metallicRoughnessTexture))),xt=this._invokeOne(function(kn){return kn.getMaterialType&&kn.getMaterialType(Ie)}),si.push(Promise.all(this._invokeAll(function(kn){return kn.extendMaterialParams&&kn.extendMaterialParams(Ie,zt)})))}Ye.doubleSided===!0&&(zt.side=f.DoubleSide);const Qi=Ye.alphaMode||Et.OPAQUE;return Qi===Et.BLEND?(zt.transparent=!0,zt.depthWrite=!1):(zt.format=f.RGBFormat,zt.transparent=!1,Qi===Et.MASK&&(zt.alphaTest=Ye.alphaCutoff!==void 0?Ye.alphaCutoff:.5)),Ye.normalTexture!==void 0&&xt!==f.MeshBasicMaterial&&(si.push(ke.assignTexture(zt,"normalMap",Ye.normalTexture)),zt.normalScale=new f.Vector2(1,-1),Ye.normalTexture.scale!==void 0&&zt.normalScale.set(Ye.normalTexture.scale,-Ye.normalTexture.scale)),Ye.occlusionTexture!==void 0&&xt!==f.MeshBasicMaterial&&(si.push(ke.assignTexture(zt,"aoMap",Ye.occlusionTexture)),Ye.occlusionTexture.strength!==void 0&&(zt.aoMapIntensity=Ye.occlusionTexture.strength)),Ye.emissiveFactor!==void 0&&xt!==f.MeshBasicMaterial&&(zt.emissive=new f.Color().fromArray(Ye.emissiveFactor)),Ye.emissiveTexture!==void 0&&xt!==f.MeshBasicMaterial&&si.push(ke.assignTexture(zt,"emissiveMap",Ye.emissiveTexture)),Promise.all(si).then(function(){let tn;return xt===Ct?tn=Ue[U.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(zt):tn=new xt(zt),Ye.name&&(tn.name=Ye.name),tn.map&&(tn.map.encoding=f.sRGBEncoding),tn.emissiveMap&&(tn.emissiveMap.encoding=f.sRGBEncoding),St(tn,Ye),ke.associations.set(tn,{type:"materials",index:Ie}),Ye.extensions&&ii(Ue,tn,Ye),tn})}createUniqueName(Ie){const ke=f.PropertyBinding.sanitizeNodeName(Ie||"");let ht=ke;for(let Ue=1;this.nodeNamesUsed[ht];++Ue)ht=ke+"_"+Ue;return this.nodeNamesUsed[ht]=!0,ht}loadGeometries(Ie){const ke=this,ht=this.extensions,Ue=this.primitiveCache;function Ye(zt){return ht[U.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(zt,ke).then(function(It){return ln(It,zt,ke)})}const xt=[];for(let zt=0,It=Ie.length;zt<It;zt++){const si=Ie[zt],Qi=Ki(si),tn=Ue[Qi];if(tn)xt.push(tn.promise);else{let kn;si.extensions&&si.extensions[U.KHR_DRACO_MESH_COMPRESSION]?kn=Ye(si):kn=ln(new f.BufferGeometry,si,ke),Ue[Qi]={primitive:si,promise:kn},xt.push(kn)}}return Promise.all(xt)}loadMesh(Ie){const ke=this,ht=this.json,Ue=this.extensions,Ye=ht.meshes[Ie],xt=Ye.primitives,zt=[];for(let It=0,si=xt.length;It<si;It++){const Qi=xt[It].material===void 0?ft(this.cache):this.getDependency("material",xt[It].material);zt.push(Qi)}return zt.push(ke.loadGeometries(xt)),Promise.all(zt).then(function(It){const si=It.slice(0,It.length-1),Qi=It[It.length-1],tn=[];for(let Gn=0,Yn=Qi.length;Gn<Yn;Gn++){const Jn=Qi[Gn],Dn=xt[Gn];let ar;const rs=si[Gn];if(Dn.mode===Ht.TRIANGLES||Dn.mode===Ht.TRIANGLE_STRIP||Dn.mode===Ht.TRIANGLE_FAN||Dn.mode===void 0)ar=Ye.isSkinnedMesh===!0?new f.SkinnedMesh(Jn,rs):new f.Mesh(Jn,rs),ar.isSkinnedMesh===!0&&!ar.geometry.attributes.skinWeight.normalized&&ar.normalizeSkinWeights(),Dn.mode===Ht.TRIANGLE_STRIP?ar.geometry=_n(ar.geometry,f.TriangleStripDrawMode):Dn.mode===Ht.TRIANGLE_FAN&&(ar.geometry=_n(ar.geometry,f.TriangleFanDrawMode));else if(Dn.mode===Ht.LINES)ar=new f.LineSegments(Jn,rs);else if(Dn.mode===Ht.LINE_STRIP)ar=new f.Line(Jn,rs);else if(Dn.mode===Ht.LINE_LOOP)ar=new f.LineLoop(Jn,rs);else if(Dn.mode===Ht.POINTS)ar=new f.Points(Jn,rs);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+Dn.mode);Object.keys(ar.geometry.morphAttributes).length>0&&sn(ar,Ye),ar.name=ke.createUniqueName(Ye.name||"mesh_"+Ie),St(ar,Ye),Dn.extensions&&ii(Ue,ar,Dn),ke.assignFinalMaterial(ar),tn.push(ar)}if(tn.length===1)return tn[0];const kn=new f.Group;for(let Gn=0,Yn=tn.length;Gn<Yn;Gn++)kn.add(tn[Gn]);return kn})}loadCamera(Ie){let ke;const ht=this.json.cameras[Ie],Ue=ht[ht.type];if(!Ue){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return ht.type==="perspective"?ke=new f.PerspectiveCamera(f.MathUtils.radToDeg(Ue.yfov),Ue.aspectRatio||1,Ue.znear||1,Ue.zfar||2e6):ht.type==="orthographic"&&(ke=new f.OrthographicCamera(-Ue.xmag,Ue.xmag,Ue.ymag,-Ue.ymag,Ue.znear,Ue.zfar)),ht.name&&(ke.name=this.createUniqueName(ht.name)),St(ke,ht),Promise.resolve(ke)}loadSkin(Ie){const ke=this.json.skins[Ie],ht={joints:ke.joints};return ke.inverseBindMatrices===void 0?Promise.resolve(ht):this.getDependency("accessor",ke.inverseBindMatrices).then(function(Ue){return ht.inverseBindMatrices=Ue,ht})}loadAnimation(Ie){const ht=this.json.animations[Ie],Ue=[],Ye=[],xt=[],zt=[],It=[];for(let si=0,Qi=ht.channels.length;si<Qi;si++){const tn=ht.channels[si],kn=ht.samplers[tn.sampler],Gn=tn.target,Yn=Gn.node!==void 0?Gn.node:Gn.id,Jn=ht.parameters!==void 0?ht.parameters[kn.input]:kn.input,Dn=ht.parameters!==void 0?ht.parameters[kn.output]:kn.output;Ue.push(this.getDependency("node",Yn)),Ye.push(this.getDependency("accessor",Jn)),xt.push(this.getDependency("accessor",Dn)),zt.push(kn),It.push(Gn)}return Promise.all([Promise.all(Ue),Promise.all(Ye),Promise.all(xt),Promise.all(zt),Promise.all(It)]).then(function(si){const Qi=si[0],tn=si[1],kn=si[2],Gn=si[3],Yn=si[4],Jn=[];for(let ar=0,rs=Qi.length;ar<rs;ar++){const ms=Qi[ar],Un=tn[ar],ho=kn[ar],Ri=Gn[ar],jr=Yn[ar];if(ms===void 0)continue;ms.updateMatrix(),ms.matrixAutoUpdate=!0;let Ms;switch(Pe[jr.path]){case Pe.weights:Ms=f.NumberKeyframeTrack;break;case Pe.rotation:Ms=f.QuaternionKeyframeTrack;break;case Pe.position:case Pe.scale:default:Ms=f.VectorKeyframeTrack;break}const Fs=ms.name?ms.name:ms.uuid,Po=Ri.interpolation!==void 0?je[Ri.interpolation]:f.InterpolateLinear,ds=[];Pe[jr.path]===Pe.weights?ms.traverse(function(Mr){Mr.isMesh===!0&&Mr.morphTargetInfluences&&ds.push(Mr.name?Mr.name:Mr.uuid)}):ds.push(Fs);let ys=ho.array;if(ho.normalized){const Mr=pr(ys.constructor),Bs=new Float32Array(ys.length);for(let js=0,Wo=ys.length;js<Wo;js++)Bs[js]=ys[js]*Mr;ys=Bs}for(let Mr=0,Bs=ds.length;Mr<Bs;Mr++){const js=new Ms(ds[Mr]+"."+Pe[jr.path],Un.array,ys,Po);Ri.interpolation==="CUBICSPLINE"&&(js.createInterpolant=function(Rs){const et=this instanceof f.QuaternionKeyframeTrack?st:Ni;return new et(this.times,this.values,this.getValueSize()/3,Rs)},js.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),Jn.push(js)}}const Dn=ht.name?ht.name:"animation_"+Ie;return new f.AnimationClip(Dn,void 0,Jn)})}createNodeMesh(Ie){const ke=this.json,ht=this,Ue=ke.nodes[Ie];return Ue.mesh===void 0?null:ht.getDependency("mesh",Ue.mesh).then(function(Ye){const xt=ht._getNodeRef(ht.meshCache,Ue.mesh,Ye);return Ue.weights!==void 0&&xt.traverse(function(zt){if(zt.isMesh)for(let It=0,si=Ue.weights.length;It<si;It++)zt.morphTargetInfluences[It]=Ue.weights[It]}),xt})}loadNode(Ie){const ke=this.json,ht=this.extensions,Ue=this,Ye=ke.nodes[Ie],xt=Ye.name?Ue.createUniqueName(Ye.name):"";return function(){const zt=[],It=Ue._invokeOne(function(si){return si.createNodeMesh&&si.createNodeMesh(Ie)});return It&&zt.push(It),Ye.camera!==void 0&&zt.push(Ue.getDependency("camera",Ye.camera).then(function(si){return Ue._getNodeRef(Ue.cameraCache,Ye.camera,si)})),Ue._invokeAll(function(si){return si.createNodeAttachment&&si.createNodeAttachment(Ie)}).forEach(function(si){zt.push(si)}),Promise.all(zt)}().then(function(zt){let It;if(Ye.isBone===!0?It=new f.Bone:zt.length>1?It=new f.Group:zt.length===1?It=zt[0]:It=new f.Object3D,It!==zt[0])for(let si=0,Qi=zt.length;si<Qi;si++)It.add(zt[si]);if(Ye.name&&(It.userData.name=Ye.name,It.name=xt),St(It,Ye),Ye.extensions&&ii(ht,It,Ye),Ye.matrix!==void 0){const si=new f.Matrix4;si.fromArray(Ye.matrix),It.applyMatrix4(si)}else Ye.translation!==void 0&&It.position.fromArray(Ye.translation),Ye.rotation!==void 0&&It.quaternion.fromArray(Ye.rotation),Ye.scale!==void 0&&It.scale.fromArray(Ye.scale);return Ue.associations.set(It,{type:"nodes",index:Ie}),It})}loadScene(Ie){const ke=this.json,ht=this.extensions,Ue=this.json.scenes[Ie],Ye=this,xt=new f.Group;Ue.name&&(xt.name=Ye.createUniqueName(Ue.name)),St(xt,Ue),Ue.extensions&&ii(ht,xt,Ue);const zt=Ue.nodes||[],It=[];for(let si=0,Qi=zt.length;si<Qi;si++)It.push(wr(zt[si],xt,ke,Ye));return Promise.all(It).then(function(){return xt})}}function wr(li,Ie,ke,ht){const Ue=ke.nodes[li];return ht.getDependency("node",li).then(function(Ye){if(Ue.skin===void 0)return Ye;let xt;return ht.getDependency("skin",Ue.skin).then(function(zt){xt=zt;const It=[];for(let si=0,Qi=xt.joints.length;si<Qi;si++)It.push(ht.getDependency("node",xt.joints[si]));return Promise.all(It)}).then(function(zt){return Ye.traverse(function(It){if(!It.isMesh)return;const si=[],Qi=[];for(let tn=0,kn=zt.length;tn<kn;tn++){const Gn=zt[tn];if(Gn){si.push(Gn);const Yn=new f.Matrix4;xt.inverseBindMatrices!==void 0&&Yn.fromArray(xt.inverseBindMatrices.array,tn*16),Qi.push(Yn)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',xt.joints[tn])}It.bind(new f.Skeleton(si,Qi),It.matrixWorld)}),Ye})}).then(function(Ye){Ie.add(Ye);const xt=[];if(Ue.children){const zt=Ue.children;for(let It=0,si=zt.length;It<si;It++){const Qi=zt[It];xt.push(wr(Qi,Ye,ke,ht))}}return Promise.all(xt)})}function dn(li,Ie,ke){const ht=Ie.attributes,Ue=new f.Box3;if(ht.POSITION!==void 0){const zt=ke.json.accessors[ht.POSITION],It=zt.min,si=zt.max;if(It!==void 0&&si!==void 0){if(Ue.set(new f.Vector3(It[0],It[1],It[2]),new f.Vector3(si[0],si[1],si[2])),zt.normalized){const Qi=pr(en[zt.componentType]);Ue.min.multiplyScalar(Qi),Ue.max.multiplyScalar(Qi)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const Ye=Ie.targets;if(Ye!==void 0){const zt=new f.Vector3,It=new f.Vector3;for(let si=0,Qi=Ye.length;si<Qi;si++){const tn=Ye[si];if(tn.POSITION!==void 0){const kn=ke.json.accessors[tn.POSITION],Gn=kn.min,Yn=kn.max;if(Gn!==void 0&&Yn!==void 0){if(It.setX(Math.max(Math.abs(Gn[0]),Math.abs(Yn[0]))),It.setY(Math.max(Math.abs(Gn[1]),Math.abs(Yn[1]))),It.setZ(Math.max(Math.abs(Gn[2]),Math.abs(Yn[2]))),kn.normalized){const Jn=pr(en[kn.componentType]);It.multiplyScalar(Jn)}zt.max(It)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}Ue.expandByVector(zt)}li.boundingBox=Ue;const xt=new f.Sphere;Ue.getCenter(xt.center),xt.radius=Ue.min.distanceTo(Ue.max)/2,li.boundingSphere=xt}function ln(li,Ie,ke){const ht=Ie.attributes,Ue=[];function Ye(xt,zt){return ke.getDependency("accessor",xt).then(function(It){li.setAttribute(zt,It)})}for(const xt in ht){const zt=Se[xt]||xt.toLowerCase();zt in li.attributes||Ue.push(Ye(ht[xt],zt))}if(Ie.indices!==void 0&&!li.index){const xt=ke.getDependency("accessor",Ie.indices).then(function(zt){li.setIndex(zt)});Ue.push(xt)}return St(li,Ie),dn(li,Ie,ke),Promise.all(Ue).then(function(){return Ie.targets!==void 0?Jt(li,Ie.targets,ke):li})}function _n(li,Ie){let ke=li.getIndex();if(ke===null){const xt=[],zt=li.getAttribute("position");if(zt!==void 0){for(let It=0;It<zt.count;It++)xt.push(It);li.setIndex(xt),ke=li.getIndex()}else return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),li}const ht=ke.count-2,Ue=[];if(Ie===f.TriangleFanDrawMode)for(let xt=1;xt<=ht;xt++)Ue.push(ke.getX(0)),Ue.push(ke.getX(xt)),Ue.push(ke.getX(xt+1));else for(let xt=0;xt<ht;xt++)xt%2===0?(Ue.push(ke.getX(xt)),Ue.push(ke.getX(xt+1)),Ue.push(ke.getX(xt+2))):(Ue.push(ke.getX(xt+2)),Ue.push(ke.getX(xt+1)),Ue.push(ke.getX(xt)));Ue.length/3!==ht&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const Ye=li.clone();return Ye.setIndex(Ue),Ye}f.GLTFLoader=C})(),te.exports=f.GLTFLoader})(S1);var bA=S1.exports,E1={exports:{}};(function(te,p){const f=va;(function(){class C extends f.Loader{constructor(U){super(U)}load(U,B,s,Z){const j=this,Q=j.path===""?f.LoaderUtils.extractUrlBase(U):j.path,oe=new f.FileLoader(j.manager);oe.setPath(j.path),oe.setRequestHeader(j.requestHeader),oe.setWithCredentials(j.withCredentials),oe.load(U,function(ve){try{B(j.parse(ve,Q))}catch(Ee){Z?Z(Ee):console.error(Ee),j.manager.itemError(U)}},s,Z)}parse(U,B){function s(he,le){const we=[],Ve=he.childNodes;for(let ze=0,Bt=Ve.length;ze<Bt;ze++){const kt=Ve[ze];kt.nodeName===le&&we.push(kt)}return we}function Z(he){if(he.length===0)return[];const le=he.trim().split(/\s+/),we=new Array(le.length);for(let Ve=0,ze=le.length;Ve<ze;Ve++)we[Ve]=le[Ve];return we}function j(he){if(he.length===0)return[];const le=he.trim().split(/\s+/),we=new Array(le.length);for(let Ve=0,ze=le.length;Ve<ze;Ve++)we[Ve]=parseFloat(le[Ve]);return we}function Q(he){if(he.length===0)return[];const le=he.trim().split(/\s+/),we=new Array(le.length);for(let Ve=0,ze=le.length;Ve<ze;Ve++)we[Ve]=parseInt(le[Ve]);return we}function oe(he){return he.substring(1)}function ve(){return"three_default_"+Ei++}function Ee(he){return Object.keys(he).length===0}function We(he){return{unit:Re(s(he,"unit")[0]),upAxis:He(s(he,"up_axis")[0])}}function Re(he){return he!==void 0&&he.hasAttribute("meter")===!0?parseFloat(he.getAttribute("meter")):1}function He(he){return he!==void 0?he.textContent:"Y_UP"}function Mt(he,le,we,Ve){const ze=s(he,le)[0];if(ze!==void 0){const Bt=s(ze,we);for(let kt=0;kt<Bt.length;kt++)Ve(Bt[kt])}}function Lt(he,le){for(const we in he){const Ve=he[we];Ve.build=le(he[we])}}function Ut(he,le){return he.build!==void 0||(he.build=le(he)),he.build}function Wt(he){const le={sources:{},samplers:{},channels:{}};let we=!1;for(let Ve=0,ze=he.childNodes.length;Ve<ze;Ve++){const Bt=he.childNodes[Ve];if(Bt.nodeType!==1)continue;let kt;switch(Bt.nodeName){case"source":kt=Bt.getAttribute("id"),le.sources[kt]=Mr(Bt);break;case"sampler":kt=Bt.getAttribute("id"),le.samplers[kt]=lt(Bt);break;case"channel":kt=Bt.getAttribute("target"),le.channels[kt]=Ct(Bt);break;case"animation":Wt(Bt),we=!0;break;default:console.log(Bt)}}we===!1&&(ni.animations[he.getAttribute("id")||f.MathUtils.generateUUID()]=le)}function lt(he){const le={inputs:{}};for(let we=0,Ve=he.childNodes.length;we<Ve;we++){const ze=he.childNodes[we];if(ze.nodeType===1)switch(ze.nodeName){case"input":const Bt=oe(ze.getAttribute("source")),kt=ze.getAttribute("semantic");le.inputs[kt]=Bt;break}}return le}function Ct(he){const le={};let Ve=he.getAttribute("target").split("/");const ze=Ve.shift();let Bt=Ve.shift();const kt=Bt.indexOf("(")!==-1,Di=Bt.indexOf(".")!==-1;if(Di)Ve=Bt.split("."),Bt=Ve.shift(),le.member=Ve.shift();else if(kt){const cn=Bt.split("(");Bt=cn.shift();for(let Sn=0;Sn<cn.length;Sn++)cn[Sn]=parseInt(cn[Sn].replace(/\)/,""));le.indices=cn}return le.id=ze,le.sid=Bt,le.arraySyntax=kt,le.memberSyntax=Di,le.sampler=oe(he.getAttribute("source")),le}function qt(he){const le=[],we=he.channels,Ve=he.samplers,ze=he.sources;for(const Bt in we)if(we.hasOwnProperty(Bt)){const kt=we[Bt],Di=Ve[kt.sampler],cn=Di.inputs.INPUT,Sn=Di.inputs.OUTPUT,Hi=ze[cn],yi=ze[Sn],zn=Ni(kt,Hi,yi);ci(zn,le)}return le}function Ai(he){return Ut(ni.animations[he],qt)}function Ni(he,le,we){const Ve=ni.nodes[he.id],ze=Cs(Ve.id),Bt=Ve.transforms[he.sid],kt=Ve.matrix.clone().transpose();let Di,cn,Sn,Hi,yi,zn;const Zi={};switch(Bt){case"matrix":for(Sn=0,Hi=le.array.length;Sn<Hi;Sn++)if(Di=le.array[Sn],cn=Sn*we.stride,Zi[Di]===void 0&&(Zi[Di]={}),he.arraySyntax===!0){const Nn=we.array[cn],Kt=he.indices[0]+4*he.indices[1];Zi[Di][Kt]=Nn}else for(yi=0,zn=we.stride;yi<zn;yi++)Zi[Di][yi]=we.array[cn+yi];break;case"translate":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',Bt);break;case"rotate":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',Bt);break;case"scale":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',Bt);break}const Ln=Qe(Zi,kt);return{name:ze.uuid,keyframes:Ln}}function Qe(he,le){const we=[];for(const ze in he)we.push({time:parseFloat(ze),value:he[ze]});we.sort(Ve);for(let ze=0;ze<16;ze++)ae(we,ze,le.elements[ze]);return we;function Ve(ze,Bt){return ze.time-Bt.time}}const st=new f.Vector3,Ht=new f.Vector3,en=new f.Quaternion;function ci(he,le){const we=he.keyframes,Ve=he.name,ze=[],Bt=[],kt=[],Di=[];for(let cn=0,Sn=we.length;cn<Sn;cn++){const Hi=we[cn],yi=Hi.time,zn=Hi.value;Vn.fromArray(zn).transpose(),Vn.decompose(st,en,Ht),ze.push(yi),Bt.push(st.x,st.y,st.z),kt.push(en.x,en.y,en.z,en.w),Di.push(Ht.x,Ht.y,Ht.z)}return Bt.length>0&&le.push(new f.VectorKeyframeTrack(Ve+".position",ze,Bt)),kt.length>0&&le.push(new f.QuaternionKeyframeTrack(Ve+".quaternion",ze,kt)),Di.length>0&&le.push(new f.VectorKeyframeTrack(Ve+".scale",ze,Di)),le}function ae(he,le,we){let Ve,ze=!0,Bt,kt;for(Bt=0,kt=he.length;Bt<kt;Bt++)Ve=he[Bt],Ve.value[le]===void 0?Ve.value[le]=null:ze=!1;if(ze===!0)for(Bt=0,kt=he.length;Bt<kt;Bt++)Ve=he[Bt],Ve.value[le]=we;else ye(he,le)}function ye(he,le){let we,Ve;for(let ze=0,Bt=he.length;ze<Bt;ze++){const kt=he[ze];if(kt.value[le]===null){if(we=Se(he,ze,le),Ve=Pe(he,ze,le),we===null){kt.value[le]=Ve.value[le];continue}if(Ve===null){kt.value[le]=we.value[le];continue}je(kt,we,Ve,le)}}}function Se(he,le,we){for(;le>=0;){const Ve=he[le];if(Ve.value[we]!==null)return Ve;le--}return null}function Pe(he,le,we){for(;le<he.length;){const Ve=he[le];if(Ve.value[we]!==null)return Ve;le++}return null}function je(he,le,we,Ve){if(we.time-le.time===0){he.value[Ve]=le.value[Ve];return}he.value[Ve]=(he.time-le.time)*(we.value[Ve]-le.value[Ve])/(we.time-le.time)+le.value[Ve]}function Et(he){const le={name:he.getAttribute("id")||"default",start:parseFloat(he.getAttribute("start")||0),end:parseFloat(he.getAttribute("end")||0),animations:[]};for(let we=0,Ve=he.childNodes.length;we<Ve;we++){const ze=he.childNodes[we];if(ze.nodeType===1)switch(ze.nodeName){case"instance_animation":le.animations.push(oe(ze.getAttribute("url")));break}}ni.clips[he.getAttribute("id")]=le}function _t(he){const le=[],we=he.name,Ve=he.end-he.start||-1,ze=he.animations;for(let Bt=0,kt=ze.length;Bt<kt;Bt++){const Di=Ai(ze[Bt]);for(let cn=0,Sn=Di.length;cn<Sn;cn++)le.push(Di[cn])}return new f.AnimationClip(we,Ve,le)}function ft(he){return Ut(ni.clips[he],_t)}function ii(he){const le={};for(let we=0,Ve=he.childNodes.length;we<Ve;we++){const ze=he.childNodes[we];if(ze.nodeType===1)switch(ze.nodeName){case"skin":le.id=oe(ze.getAttribute("source")),le.skin=St(ze);break;case"morph":le.id=oe(ze.getAttribute("source")),console.warn("THREE.ColladaLoader: Morph target animation not supported yet.");break}}ni.controllers[he.getAttribute("id")]=le}function St(he){const le={sources:{}};for(let we=0,Ve=he.childNodes.length;we<Ve;we++){const ze=he.childNodes[we];if(ze.nodeType===1)switch(ze.nodeName){case"bind_shape_matrix":le.bindShapeMatrix=j(ze.textContent);break;case"source":const Bt=ze.getAttribute("id");le.sources[Bt]=Mr(ze);break;case"joints":le.joints=Jt(ze);break;case"vertex_weights":le.vertexWeights=sn(ze);break}}return le}function Jt(he){const le={inputs:{}};for(let we=0,Ve=he.childNodes.length;we<Ve;we++){const ze=he.childNodes[we];if(ze.nodeType===1)switch(ze.nodeName){case"input":const Bt=ze.getAttribute("semantic"),kt=oe(ze.getAttribute("source"));le.inputs[Bt]=kt;break}}return le}function sn(he){const le={inputs:{}};for(let we=0,Ve=he.childNodes.length;we<Ve;we++){const ze=he.childNodes[we];if(ze.nodeType===1)switch(ze.nodeName){case"input":const Bt=ze.getAttribute("semantic"),kt=oe(ze.getAttribute("source")),Di=parseInt(ze.getAttribute("offset"));le.inputs[Bt]={id:kt,offset:Di};break;case"vcount":le.vcount=Q(ze.textContent);break;case"v":le.v=Q(ze.textContent);break}}return le}function Ki(he){const le={id:he.id},we=ni.geometries[le.id];return he.skin!==void 0&&(le.skin=fi(he.skin),we.sources.skinIndices=le.skin.indices,we.sources.skinWeights=le.skin.weights),le}function fi(he){const we={joints:[],indices:{array:[],stride:4},weights:{array:[],stride:4}},Ve=he.sources,ze=he.vertexWeights,Bt=ze.vcount,kt=ze.v,Di=ze.inputs.JOINT.offset,cn=ze.inputs.WEIGHT.offset,Sn=he.sources[he.joints.inputs.JOINT],Hi=he.sources[he.joints.inputs.INV_BIND_MATRIX],yi=Ve[ze.inputs.WEIGHT.id].array;let zn=0,Zi,Ln,Bi;for(Zi=0,Bi=Bt.length;Zi<Bi;Zi++){const Kt=Bt[Zi],xr=[];for(Ln=0;Ln<Kt;Ln++){const gr=kt[zn+Di],Pn=kt[zn+cn],_r=yi[Pn];xr.push({index:gr,weight:_r}),zn+=2}for(xr.sort(Nn),Ln=0;Ln<4;Ln++){const gr=xr[Ln];gr!==void 0?(we.indices.array.push(gr.index),we.weights.array.push(gr.weight)):(we.indices.array.push(0),we.weights.array.push(0))}}for(he.bindShapeMatrix?we.bindMatrix=new f.Matrix4().fromArray(he.bindShapeMatrix).transpose():we.bindMatrix=new f.Matrix4().identity(),Zi=0,Bi=Sn.array.length;Zi<Bi;Zi++){const Kt=Sn.array[Zi],xr=new f.Matrix4().fromArray(Hi.array,Zi*Hi.stride).transpose();we.joints.push({name:Kt,boneInverse:xr})}return we;function Nn(Kt,xr){return xr.weight-Kt.weight}}function pr(he){return Ut(ni.controllers[he],Ki)}function Xn(he){const le={init_from:s(he,"init_from")[0].textContent};ni.images[he.getAttribute("id")]=le}function wr(he){return he.build!==void 0?he.build:he.init_from}function dn(he){const le=ni.images[he];return le!==void 0?Ut(le,wr):(console.warn("THREE.ColladaLoader: Couldn't find image with ID:",he),null)}function ln(he){const le={};for(let we=0,Ve=he.childNodes.length;we<Ve;we++){const ze=he.childNodes[we];if(ze.nodeType===1)switch(ze.nodeName){case"profile_COMMON":le.profile=_n(ze);break}}ni.effects[he.getAttribute("id")]=le}function _n(he){const le={surfaces:{},samplers:{}};for(let we=0,Ve=he.childNodes.length;we<Ve;we++){const ze=he.childNodes[we];if(ze.nodeType===1)switch(ze.nodeName){case"newparam":li(ze,le);break;case"technique":le.technique=ht(ze);break;case"extra":le.extra=si(ze);break}}return le}function li(he,le){const we=he.getAttribute("sid");for(let Ve=0,ze=he.childNodes.length;Ve<ze;Ve++){const Bt=he.childNodes[Ve];if(Bt.nodeType===1)switch(Bt.nodeName){case"surface":le.surfaces[we]=Ie(Bt);break;case"sampler2D":le.samplers[we]=ke(Bt);break}}}function Ie(he){const le={};for(let we=0,Ve=he.childNodes.length;we<Ve;we++){const ze=he.childNodes[we];if(ze.nodeType===1)switch(ze.nodeName){case"init_from":le.init_from=ze.textContent;break}}return le}function ke(he){const le={};for(let we=0,Ve=he.childNodes.length;we<Ve;we++){const ze=he.childNodes[we];if(ze.nodeType===1)switch(ze.nodeName){case"source":le.source=ze.textContent;break}}return le}function ht(he){const le={};for(let we=0,Ve=he.childNodes.length;we<Ve;we++){const ze=he.childNodes[we];if(ze.nodeType===1)switch(ze.nodeName){case"constant":case"lambert":case"blinn":case"phong":le.type=ze.nodeName,le.parameters=Ue(ze);break}}return le}function Ue(he){const le={};for(let we=0,Ve=he.childNodes.length;we<Ve;we++){const ze=he.childNodes[we];if(ze.nodeType===1)switch(ze.nodeName){case"emission":case"diffuse":case"specular":case"bump":case"ambient":case"shininess":case"transparency":le[ze.nodeName]=Ye(ze);break;case"transparent":le[ze.nodeName]={opaque:ze.getAttribute("opaque"),data:Ye(ze)};break}}return le}function Ye(he){const le={};for(let we=0,Ve=he.childNodes.length;we<Ve;we++){const ze=he.childNodes[we];if(ze.nodeType===1)switch(ze.nodeName){case"color":le[ze.nodeName]=j(ze.textContent);break;case"float":le[ze.nodeName]=parseFloat(ze.textContent);break;case"texture":le[ze.nodeName]={id:ze.getAttribute("texture"),extra:xt(ze)};break}}return le}function xt(he){const le={technique:{}};for(let we=0,Ve=he.childNodes.length;we<Ve;we++){const ze=he.childNodes[we];if(ze.nodeType===1)switch(ze.nodeName){case"extra":zt(ze,le);break}}return le}function zt(he,le){for(let we=0,Ve=he.childNodes.length;we<Ve;we++){const ze=he.childNodes[we];if(ze.nodeType===1)switch(ze.nodeName){case"technique":It(ze,le);break}}}function It(he,le){for(let we=0,Ve=he.childNodes.length;we<Ve;we++){const ze=he.childNodes[we];if(ze.nodeType===1)switch(ze.nodeName){case"repeatU":case"repeatV":case"offsetU":case"offsetV":le.technique[ze.nodeName]=parseFloat(ze.textContent);break;case"wrapU":case"wrapV":ze.textContent.toUpperCase()==="TRUE"?le.technique[ze.nodeName]=1:ze.textContent.toUpperCase()==="FALSE"?le.technique[ze.nodeName]=0:le.technique[ze.nodeName]=parseInt(ze.textContent);break}}}function si(he){const le={};for(let we=0,Ve=he.childNodes.length;we<Ve;we++){const ze=he.childNodes[we];if(ze.nodeType===1)switch(ze.nodeName){case"technique":le.technique=Qi(ze);break}}return le}function Qi(he){const le={};for(let we=0,Ve=he.childNodes.length;we<Ve;we++){const ze=he.childNodes[we];if(ze.nodeType===1)switch(ze.nodeName){case"double_sided":le[ze.nodeName]=parseInt(ze.textContent);break}}return le}function tn(he){return he}function kn(he){return Ut(ni.effects[he],tn)}function Gn(he){const le={name:he.getAttribute("name")};for(let we=0,Ve=he.childNodes.length;we<Ve;we++){const ze=he.childNodes[we];if(ze.nodeType===1)switch(ze.nodeName){case"instance_effect":le.url=oe(ze.getAttribute("url"));break}}ni.materials[he.getAttribute("id")]=le}function Yn(he){let le,we=he.slice((he.lastIndexOf(".")-1>>>0)+2);switch(we=we.toLowerCase(),we){case"tga":le=De;break;default:le=ge}return le}function Jn(he){const le=kn(he.url),we=le.profile.technique,Ve=le.profile.extra;let ze;switch(we.type){case"phong":case"blinn":ze=new f.MeshPhongMaterial;break;case"lambert":ze=new f.MeshLambertMaterial;break;default:ze=new f.MeshBasicMaterial;break}ze.name=he.name||"";function Bt(Sn){const Hi=le.profile.samplers[Sn.id];let yi=null;if(Hi!==void 0){const zn=le.profile.surfaces[Hi.source];yi=dn(zn.init_from)}else console.warn("THREE.ColladaLoader: Undefined sampler. Access image directly (see #12530)."),yi=dn(Sn.id);if(yi!==null){const zn=Yn(yi);if(zn!==void 0){const Zi=zn.load(yi),Ln=Sn.extra;if(Ln!==void 0&&Ln.technique!==void 0&&Ee(Ln.technique)===!1){const Bi=Ln.technique;Zi.wrapS=Bi.wrapU?f.RepeatWrapping:f.ClampToEdgeWrapping,Zi.wrapT=Bi.wrapV?f.RepeatWrapping:f.ClampToEdgeWrapping,Zi.offset.set(Bi.offsetU||0,Bi.offsetV||0),Zi.repeat.set(Bi.repeatU||1,Bi.repeatV||1)}else Zi.wrapS=f.RepeatWrapping,Zi.wrapT=f.RepeatWrapping;return Zi}else return console.warn("THREE.ColladaLoader: THREE.Loader for texture %s not found.",yi),null}else return console.warn("THREE.ColladaLoader: Couldn't create texture with ID:",Sn.id),null}const kt=we.parameters;for(const Sn in kt){const Hi=kt[Sn];switch(Sn){case"diffuse":Hi.color&&ze.color.fromArray(Hi.color),Hi.texture&&(ze.map=Bt(Hi.texture));break;case"specular":Hi.color&&ze.specular&&ze.specular.fromArray(Hi.color),Hi.texture&&(ze.specularMap=Bt(Hi.texture));break;case"bump":Hi.texture&&(ze.normalMap=Bt(Hi.texture));break;case"ambient":Hi.texture&&(ze.lightMap=Bt(Hi.texture));break;case"shininess":Hi.float&&ze.shininess&&(ze.shininess=Hi.float);break;case"emission":Hi.color&&ze.emissive&&ze.emissive.fromArray(Hi.color),Hi.texture&&(ze.emissiveMap=Bt(Hi.texture));break}}let Di=kt.transparent,cn=kt.transparency;if(cn===void 0&&Di&&(cn={float:1}),Di===void 0&&cn&&(Di={opaque:"A_ONE",data:{color:[1,1,1,1]}}),Di&&cn)if(Di.data.texture)ze.transparent=!0;else{const Sn=Di.data.color;switch(Di.opaque){case"A_ONE":ze.opacity=Sn[3]*cn.float;break;case"RGB_ZERO":ze.opacity=1-Sn[0]*cn.float;break;case"A_ZERO":ze.opacity=1-Sn[3]*cn.float;break;case"RGB_ONE":ze.opacity=Sn[0]*cn.float;break;default:console.warn('THREE.ColladaLoader: Invalid opaque type "%s" of transparent tag.',Di.opaque)}ze.opacity<1&&(ze.transparent=!0)}return Ve!==void 0&&Ve.technique!==void 0&&Ve.technique.double_sided===1&&(ze.side=f.DoubleSide),ze}function Dn(he){return Ut(ni.materials[he],Jn)}function ar(he){const le={name:he.getAttribute("name")};for(let we=0,Ve=he.childNodes.length;we<Ve;we++){const ze=he.childNodes[we];if(ze.nodeType===1)switch(ze.nodeName){case"optics":le.optics=rs(ze);break}}ni.cameras[he.getAttribute("id")]=le}function rs(he){for(let le=0;le<he.childNodes.length;le++){const we=he.childNodes[le];switch(we.nodeName){case"technique_common":return ms(we)}}return{}}function ms(he){const le={};for(let we=0;we<he.childNodes.length;we++){const Ve=he.childNodes[we];switch(Ve.nodeName){case"perspective":case"orthographic":le.technique=Ve.nodeName,le.parameters=Un(Ve);break}}return le}function Un(he){const le={};for(let we=0;we<he.childNodes.length;we++){const Ve=he.childNodes[we];switch(Ve.nodeName){case"xfov":case"yfov":case"xmag":case"ymag":case"znear":case"zfar":case"aspect_ratio":le[Ve.nodeName]=parseFloat(Ve.textContent);break}}return le}function ho(he){let le;switch(he.optics.technique){case"perspective":le=new f.PerspectiveCamera(he.optics.parameters.yfov,he.optics.parameters.aspect_ratio,he.optics.parameters.znear,he.optics.parameters.zfar);break;case"orthographic":let we=he.optics.parameters.ymag,Ve=he.optics.parameters.xmag;const ze=he.optics.parameters.aspect_ratio;Ve=Ve===void 0?we*ze:Ve,we=we===void 0?Ve/ze:we,Ve*=.5,we*=.5,le=new f.OrthographicCamera(-Ve,Ve,we,-we,he.optics.parameters.znear,he.optics.parameters.zfar);break;default:le=new f.PerspectiveCamera;break}return le.name=he.name||"",le}function Ri(he){const le=ni.cameras[he];return le!==void 0?Ut(le,ho):(console.warn("THREE.ColladaLoader: Couldn't find camera with ID:",he),null)}function jr(he){let le={};for(let we=0,Ve=he.childNodes.length;we<Ve;we++){const ze=he.childNodes[we];if(ze.nodeType===1)switch(ze.nodeName){case"technique_common":le=Ms(ze);break}}ni.lights[he.getAttribute("id")]=le}function Ms(he){const le={};for(let we=0,Ve=he.childNodes.length;we<Ve;we++){const ze=he.childNodes[we];if(ze.nodeType===1)switch(ze.nodeName){case"directional":case"point":case"spot":case"ambient":le.technique=ze.nodeName,le.parameters=Fs(ze)}}return le}function Fs(he){const le={};for(let we=0,Ve=he.childNodes.length;we<Ve;we++){const ze=he.childNodes[we];if(ze.nodeType===1)switch(ze.nodeName){case"color":const Bt=j(ze.textContent);le.color=new f.Color().fromArray(Bt);break;case"falloff_angle":le.falloffAngle=parseFloat(ze.textContent);break;case"quadratic_attenuation":const kt=parseFloat(ze.textContent);le.distance=kt?Math.sqrt(1/kt):0;break}}return le}function Po(he){let le;switch(he.technique){case"directional":le=new f.DirectionalLight;break;case"point":le=new f.PointLight;break;case"spot":le=new f.SpotLight;break;case"ambient":le=new f.AmbientLight;break}return he.parameters.color&&le.color.copy(he.parameters.color),he.parameters.distance&&(le.distance=he.parameters.distance),le}function ds(he){const le=ni.lights[he];return le!==void 0?Ut(le,Po):(console.warn("THREE.ColladaLoader: Couldn't find light with ID:",he),null)}function ys(he){const le={name:he.getAttribute("name"),sources:{},vertices:{},primitives:[]},we=s(he,"mesh")[0];if(we!==void 0){for(let Ve=0;Ve<we.childNodes.length;Ve++){const ze=we.childNodes[Ve];if(ze.nodeType!==1)continue;const Bt=ze.getAttribute("id");switch(ze.nodeName){case"source":le.sources[Bt]=Mr(ze);break;case"vertices":le.vertices=Bs(ze);break;case"polygons":console.warn("THREE.ColladaLoader: Unsupported primitive type: ",ze.nodeName);break;case"lines":case"linestrips":case"polylist":case"triangles":le.primitives.push(js(ze));break;default:console.log(ze)}}ni.geometries[he.getAttribute("id")]=le}}function Mr(he){const le={array:[],stride:3};for(let we=0;we<he.childNodes.length;we++){const Ve=he.childNodes[we];if(Ve.nodeType===1)switch(Ve.nodeName){case"float_array":le.array=j(Ve.textContent);break;case"Name_array":le.array=Z(Ve.textContent);break;case"technique_common":const ze=s(Ve,"accessor")[0];ze!==void 0&&(le.stride=parseInt(ze.getAttribute("stride")));break}}return le}function Bs(he){const le={};for(let we=0;we<he.childNodes.length;we++){const Ve=he.childNodes[we];Ve.nodeType===1&&(le[Ve.getAttribute("semantic")]=oe(Ve.getAttribute("source")))}return le}function js(he){const le={type:he.nodeName,material:he.getAttribute("material"),count:parseInt(he.getAttribute("count")),inputs:{},stride:0,hasUV:!1};for(let we=0,Ve=he.childNodes.length;we<Ve;we++){const ze=he.childNodes[we];if(ze.nodeType===1)switch(ze.nodeName){case"input":const Bt=oe(ze.getAttribute("source")),kt=ze.getAttribute("semantic"),Di=parseInt(ze.getAttribute("offset")),cn=parseInt(ze.getAttribute("set")),Sn=cn>0?kt+cn:kt;le.inputs[Sn]={id:Bt,offset:Di},le.stride=Math.max(le.stride,Di+1),kt==="TEXCOORD"&&(le.hasUV=!0);break;case"vcount":le.vcount=Q(ze.textContent);break;case"p":le.p=Q(ze.textContent);break}}return le}function Wo(he){const le={};for(let we=0;we<he.length;we++){const Ve=he[we];le[Ve.type]===void 0&&(le[Ve.type]=[]),le[Ve.type].push(Ve)}return le}function Rs(he){let le=0;for(let we=0,Ve=he.length;we<Ve;we++)he[we].hasUV===!0&&le++;le>0&&le<he.length&&(he.uvsNeedsFix=!0)}function et(he){const le={},we=he.sources,Ve=he.vertices,ze=he.primitives;if(ze.length===0)return{};const Bt=Wo(ze);for(const kt in Bt){const Di=Bt[kt];Rs(Di),le[kt]=Bo(Di,we,Ve)}return le}function Bo(he,le,we){const Ve={},ze={array:[],stride:0},Bt={array:[],stride:0},kt={array:[],stride:0},Di={array:[],stride:0},cn={array:[],stride:0},Sn={array:[],stride:4},Hi={array:[],stride:4},yi=new f.BufferGeometry,zn=[];let Zi=0;for(let Ln=0;Ln<he.length;Ln++){const Bi=he[Ln],Nn=Bi.inputs;let Kt=0;switch(Bi.type){case"lines":case"linestrips":Kt=Bi.count*2;break;case"triangles":Kt=Bi.count*3;break;case"polylist":for(let xr=0;xr<Bi.count;xr++){const gr=Bi.vcount[xr];switch(gr){case 3:Kt+=3;break;case 4:Kt+=6;break;default:Kt+=(gr-2)*3;break}}break;default:console.warn("THREE.ColladaLoader: Unknow primitive type:",Bi.type)}yi.addGroup(Zi,Kt,Ln),Zi+=Kt,Bi.material&&zn.push(Bi.material);for(const xr in Nn){const gr=Nn[xr];switch(xr){case"VERTEX":for(const Pn in we){const _r=we[Pn];switch(Pn){case"POSITION":const un=ze.array.length;if(As(Bi,le[_r],gr.offset,ze.array),ze.stride=le[_r].stride,le.skinWeights&&le.skinIndices&&(As(Bi,le.skinIndices,gr.offset,Sn.array),As(Bi,le.skinWeights,gr.offset,Hi.array)),Bi.hasUV===!1&&he.uvsNeedsFix===!0){const fs=(ze.array.length-un)/ze.stride;for(let yr=0;yr<fs;yr++)kt.array.push(0,0)}break;case"NORMAL":As(Bi,le[_r],gr.offset,Bt.array),Bt.stride=le[_r].stride;break;case"COLOR":As(Bi,le[_r],gr.offset,cn.array),cn.stride=le[_r].stride;break;case"TEXCOORD":As(Bi,le[_r],gr.offset,kt.array),kt.stride=le[_r].stride;break;case"TEXCOORD1":As(Bi,le[_r],gr.offset,Di.array),kt.stride=le[_r].stride;break;default:console.warn('THREE.ColladaLoader: Semantic "%s" not handled in geometry build process.',Pn)}}break;case"NORMAL":As(Bi,le[gr.id],gr.offset,Bt.array),Bt.stride=le[gr.id].stride;break;case"COLOR":As(Bi,le[gr.id],gr.offset,cn.array),cn.stride=le[gr.id].stride;break;case"TEXCOORD":As(Bi,le[gr.id],gr.offset,kt.array),kt.stride=le[gr.id].stride;break;case"TEXCOORD1":As(Bi,le[gr.id],gr.offset,Di.array),Di.stride=le[gr.id].stride;break}}}return ze.array.length>0&&yi.setAttribute("position",new f.Float32BufferAttribute(ze.array,ze.stride)),Bt.array.length>0&&yi.setAttribute("normal",new f.Float32BufferAttribute(Bt.array,Bt.stride)),cn.array.length>0&&yi.setAttribute("color",new f.Float32BufferAttribute(cn.array,cn.stride)),kt.array.length>0&&yi.setAttribute("uv",new f.Float32BufferAttribute(kt.array,kt.stride)),Di.array.length>0&&yi.setAttribute("uv2",new f.Float32BufferAttribute(Di.array,Di.stride)),Sn.array.length>0&&yi.setAttribute("skinIndex",new f.Float32BufferAttribute(Sn.array,Sn.stride)),Hi.array.length>0&&yi.setAttribute("skinWeight",new f.Float32BufferAttribute(Hi.array,Hi.stride)),Ve.data=yi,Ve.type=he[0].type,Ve.materialKeys=zn,Ve}function As(he,le,we,Ve){const ze=he.p,Bt=he.stride,kt=he.vcount;function Di(Hi){let yi=ze[Hi+we]*Sn;const zn=yi+Sn;for(;yi<zn;yi++)Ve.push(cn[yi])}const cn=le.array,Sn=le.stride;if(he.vcount!==void 0){let Hi=0;for(let yi=0,zn=kt.length;yi<zn;yi++){const Zi=kt[yi];if(Zi===4){const Ln=Hi+Bt*0,Bi=Hi+Bt*1,Nn=Hi+Bt*2,Kt=Hi+Bt*3;Di(Ln),Di(Bi),Di(Kt),Di(Bi),Di(Nn),Di(Kt)}else if(Zi===3){const Ln=Hi+Bt*0,Bi=Hi+Bt*1,Nn=Hi+Bt*2;Di(Ln),Di(Bi),Di(Nn)}else if(Zi>4)for(let Ln=1,Bi=Zi-2;Ln<=Bi;Ln++){const Nn=Hi+Bt*0,Kt=Hi+Bt*Ln,xr=Hi+Bt*(Ln+1);Di(Nn),Di(Kt),Di(xr)}Hi+=Bt*Zi}}else for(let Hi=0,yi=ze.length;Hi<yi;Hi+=Bt)Di(Hi)}function ps(he){return Ut(ni.geometries[he],et)}function No(he){const le={name:he.getAttribute("name")||"",joints:{},links:[]};for(let we=0;we<he.childNodes.length;we++){const Ve=he.childNodes[we];if(Ve.nodeType===1)switch(Ve.nodeName){case"technique_common":ha(Ve,le);break}}ni.kinematicsModels[he.getAttribute("id")]=le}function Ro(he){return he.build!==void 0?he.build:he}function ca(he){return Ut(ni.kinematicsModels[he],Ro)}function ha(he,le){for(let we=0;we<he.childNodes.length;we++){const Ve=he.childNodes[we];if(Ve.nodeType===1)switch(Ve.nodeName){case"joint":le.joints[Ve.getAttribute("sid")]=ta(Ve);break;case"link":le.links.push(se(Ve));break}}}function ta(he){let le;for(let we=0;we<he.childNodes.length;we++){const Ve=he.childNodes[we];if(Ve.nodeType===1)switch(Ve.nodeName){case"prismatic":case"revolute":le=at(Ve);break}}return le}function at(he){const le={sid:he.getAttribute("sid"),name:he.getAttribute("name")||"",axis:new f.Vector3,limits:{min:0,max:0},type:he.nodeName,static:!1,zeroPosition:0,middlePosition:0};for(let we=0;we<he.childNodes.length;we++){const Ve=he.childNodes[we];if(Ve.nodeType===1)switch(Ve.nodeName){case"axis":const ze=j(Ve.textContent);le.axis.fromArray(ze);break;case"limits":const Bt=Ve.getElementsByTagName("max")[0],kt=Ve.getElementsByTagName("min")[0];le.limits.max=parseFloat(Bt.textContent),le.limits.min=parseFloat(kt.textContent);break}}return le.limits.min>=le.limits.max&&(le.static=!0),le.middlePosition=(le.limits.min+le.limits.max)/2,le}function se(he){const le={sid:he.getAttribute("sid"),name:he.getAttribute("name")||"",attachments:[],transforms:[]};for(let we=0;we<he.childNodes.length;we++){const Ve=he.childNodes[we];if(Ve.nodeType===1)switch(Ve.nodeName){case"attachment_full":le.attachments.push(me(Ve));break;case"matrix":case"translate":case"rotate":le.transforms.push(Oe(Ve));break}}return le}function me(he){const le={joint:he.getAttribute("joint").split("/").pop(),transforms:[],links:[]};for(let we=0;we<he.childNodes.length;we++){const Ve=he.childNodes[we];if(Ve.nodeType===1)switch(Ve.nodeName){case"link":le.links.push(se(Ve));break;case"matrix":case"translate":case"rotate":le.transforms.push(Oe(Ve));break}}return le}function Oe(he){const le={type:he.nodeName},we=j(he.textContent);switch(le.type){case"matrix":le.obj=new f.Matrix4,le.obj.fromArray(we).transpose();break;case"translate":le.obj=new f.Vector3,le.obj.fromArray(we);break;case"rotate":le.obj=new f.Vector3,le.obj.fromArray(we),le.angle=f.MathUtils.degToRad(we[3]);break}return le}function Ke(he){const le={name:he.getAttribute("name")||"",rigidBodies:{}};for(let we=0;we<he.childNodes.length;we++){const Ve=he.childNodes[we];if(Ve.nodeType===1)switch(Ve.nodeName){case"rigid_body":le.rigidBodies[Ve.getAttribute("name")]={},tt(Ve,le.rigidBodies[Ve.getAttribute("name")]);break}}ni.physicsModels[he.getAttribute("id")]=le}function tt(he,le){for(let we=0;we<he.childNodes.length;we++){const Ve=he.childNodes[we];if(Ve.nodeType===1)switch(Ve.nodeName){case"technique_common":At(Ve,le);break}}}function At(he,le){for(let we=0;we<he.childNodes.length;we++){const Ve=he.childNodes[we];if(Ve.nodeType===1)switch(Ve.nodeName){case"inertia":le.inertia=j(Ve.textContent);break;case"mass":le.mass=j(Ve.textContent)[0];break}}}function Ft(he){const le={bindJointAxis:[]};for(let we=0;we<he.childNodes.length;we++){const Ve=he.childNodes[we];if(Ve.nodeType===1)switch(Ve.nodeName){case"bind_joint_axis":le.bindJointAxis.push(yt(Ve));break}}ni.kinematicsScenes[oe(he.getAttribute("url"))]=le}function yt(he){const le={target:he.getAttribute("target").split("/").pop()};for(let we=0;we<he.childNodes.length;we++){const Ve=he.childNodes[we];if(Ve.nodeType===1)switch(Ve.nodeName){case"axis":const ze=Ve.getElementsByTagName("param")[0];le.axis=ze.textContent;const Bt=le.axis.split("inst_").pop().split("axis")[0];le.jointIndex=Bt.substr(0,Bt.length-1);break}}return le}function jt(he){return he.build!==void 0?he.build:he}function Oi(he){return Ut(ni.kinematicsScenes[he],jt)}function Mi(){const he=Object.keys(ni.kinematicsModels)[0],le=Object.keys(ni.kinematicsScenes)[0],we=Object.keys(ni.visualScenes)[0];if(he===void 0||le===void 0)return;const Ve=ca(he),ze=Oi(le),Bt=wo(we),kt=ze.bindJointAxis,Di={};for(let Hi=0,yi=kt.length;Hi<yi;Hi++){const zn=kt[Hi],Zi=Ws.querySelector('[sid="'+zn.target+'"]');if(Zi){const Ln=Zi.parentElement;cn(zn.jointIndex,Ln)}}function cn(Hi,yi){const zn=yi.getAttribute("name"),Zi=Ve.joints[Hi];Bt.traverse(function(Ln){Ln.name===zn&&(Di[Hi]={object:Ln,transforms:wn(yi),joint:Zi,position:Zi.zeroPosition})})}const Sn=new f.Matrix4;ui={joints:Ve&&Ve.joints,getJointValue:function(Hi){const yi=Di[Hi];if(yi)return yi.position;console.warn("THREE.ColladaLoader: Joint "+Hi+" doesn't exist.")},setJointValue:function(Hi,yi){const zn=Di[Hi];if(zn){const Zi=zn.joint;if(yi>Zi.limits.max||yi<Zi.limits.min)console.warn("THREE.ColladaLoader: Joint "+Hi+" value "+yi+" outside of limits (min: "+Zi.limits.min+", max: "+Zi.limits.max+").");else if(Zi.static)console.warn("THREE.ColladaLoader: Joint "+Hi+" is static.");else{const Ln=zn.object,Bi=Zi.axis,Nn=zn.transforms;Vn.identity();for(let Kt=0;Kt<Nn.length;Kt++){const xr=Nn[Kt];if(xr.sid&&xr.sid.indexOf(Hi)!==-1)switch(Zi.type){case"revolute":Vn.multiply(Sn.makeRotationAxis(Bi,f.MathUtils.degToRad(yi)));break;case"prismatic":Vn.multiply(Sn.makeTranslation(Bi.x*yi,Bi.y*yi,Bi.z*yi));break;default:console.warn("THREE.ColladaLoader: Unknown joint type: "+Zi.type);break}else switch(xr.type){case"matrix":Vn.multiply(xr.obj);break;case"translate":Vn.multiply(Sn.makeTranslation(xr.obj.x,xr.obj.y,xr.obj.z));break;case"scale":Vn.scale(xr.obj);break;case"rotate":Vn.multiply(Sn.makeRotationAxis(xr.obj,xr.angle));break}}Ln.matrix.copy(Vn),Ln.matrix.decompose(Ln.position,Ln.quaternion,Ln.scale),Di[Hi].position=yi}}else console.log("THREE.ColladaLoader: "+Hi+" does not exist.")}}}function wn(he){const le=[],we=Ws.querySelector('[id="'+he.id+'"]');for(let Ve=0;Ve<we.childNodes.length;Ve++){const ze=we.childNodes[Ve];if(ze.nodeType!==1)continue;let Bt,kt;switch(ze.nodeName){case"matrix":Bt=j(ze.textContent);const Di=new f.Matrix4().fromArray(Bt).transpose();le.push({sid:ze.getAttribute("sid"),type:ze.nodeName,obj:Di});break;case"translate":case"scale":Bt=j(ze.textContent),kt=new f.Vector3().fromArray(Bt),le.push({sid:ze.getAttribute("sid"),type:ze.nodeName,obj:kt});break;case"rotate":Bt=j(ze.textContent),kt=new f.Vector3().fromArray(Bt);const cn=f.MathUtils.degToRad(Bt[3]);le.push({sid:ze.getAttribute("sid"),type:ze.nodeName,obj:kt,angle:cn});break}}return le}function Bn(he){const le=he.getElementsByTagName("node");for(let we=0;we<le.length;we++){const Ve=le[we];Ve.hasAttribute("id")===!1&&Ve.setAttribute("id",ve())}}const Vn=new f.Matrix4,lr=new f.Vector3;function jn(he){const le={name:he.getAttribute("name")||"",type:he.getAttribute("type"),id:he.getAttribute("id"),sid:he.getAttribute("sid"),matrix:new f.Matrix4,nodes:[],instanceCameras:[],instanceControllers:[],instanceLights:[],instanceGeometries:[],instanceNodes:[],transforms:{}};for(let we=0;we<he.childNodes.length;we++){const Ve=he.childNodes[we];if(Ve.nodeType!==1)continue;let ze;switch(Ve.nodeName){case"node":le.nodes.push(Ve.getAttribute("id")),jn(Ve);break;case"instance_camera":le.instanceCameras.push(oe(Ve.getAttribute("url")));break;case"instance_controller":le.instanceControllers.push(fr(Ve));break;case"instance_light":le.instanceLights.push(oe(Ve.getAttribute("url")));break;case"instance_geometry":le.instanceGeometries.push(fr(Ve));break;case"instance_node":le.instanceNodes.push(oe(Ve.getAttribute("url")));break;case"matrix":ze=j(Ve.textContent),le.matrix.multiply(Vn.fromArray(ze).transpose()),le.transforms[Ve.getAttribute("sid")]=Ve.nodeName;break;case"translate":ze=j(Ve.textContent),lr.fromArray(ze),le.matrix.multiply(Vn.makeTranslation(lr.x,lr.y,lr.z)),le.transforms[Ve.getAttribute("sid")]=Ve.nodeName;break;case"rotate":ze=j(Ve.textContent);const Bt=f.MathUtils.degToRad(ze[3]);le.matrix.multiply(Vn.makeRotationAxis(lr.fromArray(ze),Bt)),le.transforms[Ve.getAttribute("sid")]=Ve.nodeName;break;case"scale":ze=j(Ve.textContent),le.matrix.scale(lr.fromArray(ze)),le.transforms[Ve.getAttribute("sid")]=Ve.nodeName;break;case"extra":break;default:console.log(Ve)}}return ss(le.id)?console.warn("THREE.ColladaLoader: There is already a node with ID %s. Exclude current node from further processing.",le.id):ni.nodes[le.id]=le,le}function fr(he){const le={id:oe(he.getAttribute("url")),materials:{},skeletons:[]};for(let we=0;we<he.childNodes.length;we++){const Ve=he.childNodes[we];switch(Ve.nodeName){case"bind_material":const ze=Ve.getElementsByTagName("instance_material");for(let Bt=0;Bt<ze.length;Bt++){const kt=ze[Bt],Di=kt.getAttribute("symbol"),cn=kt.getAttribute("target");le.materials[Di]=oe(cn)}break;case"skeleton":le.skeletons.push(oe(Ve.textContent));break}}return le}function bn(he,le){const we=[],Ve=[];let ze,Bt,kt;for(ze=0;ze<he.length;ze++){const Sn=he[ze];let Hi;if(ss(Sn))Hi=Cs(Sn),as(Hi,le,we);else if(wl(Sn)){const zn=ni.visualScenes[Sn].children;for(let Zi=0;Zi<zn.length;Zi++){const Ln=zn[Zi];if(Ln.type==="JOINT"){const Bi=Cs(Ln.id);as(Bi,le,we)}}}else console.error("THREE.ColladaLoader: Unable to find root bone of skeleton with ID:",Sn)}for(ze=0;ze<le.length;ze++)for(Bt=0;Bt<we.length;Bt++)if(kt=we[Bt],kt.bone.name===le[ze].name){Ve[ze]=kt,kt.processed=!0;break}for(ze=0;ze<we.length;ze++)kt=we[ze],kt.processed===!1&&(Ve.push(kt),kt.processed=!0);const Di=[],cn=[];for(ze=0;ze<Ve.length;ze++)kt=Ve[ze],Di.push(kt.bone),cn.push(kt.boneInverse);return new f.Skeleton(Di,cn)}function as(he,le,we){he.traverse(function(Ve){if(Ve.isBone===!0){let ze;for(let Bt=0;Bt<le.length;Bt++){const kt=le[Bt];if(kt.name===Ve.name){ze=kt.boneInverse;break}}ze===void 0&&(ze=new f.Matrix4),we.push({bone:Ve,boneInverse:ze,processed:!1})}})}function Vr(he){const le=[],we=he.matrix,Ve=he.nodes,ze=he.type,Bt=he.instanceCameras,kt=he.instanceControllers,Di=he.instanceLights,cn=he.instanceGeometries,Sn=he.instanceNodes;for(let yi=0,zn=Ve.length;yi<zn;yi++)le.push(Cs(Ve[yi]));for(let yi=0,zn=Bt.length;yi<zn;yi++){const Zi=Ri(Bt[yi]);Zi!==null&&le.push(Zi.clone())}for(let yi=0,zn=kt.length;yi<zn;yi++){const Zi=kt[yi],Ln=pr(Zi.id),Bi=ps(Ln.id),Nn=Wr(Bi,Zi.materials),Kt=Zi.skeletons,xr=Ln.skin.joints,gr=bn(Kt,xr);for(let Pn=0,_r=Nn.length;Pn<_r;Pn++){const un=Nn[Pn];un.isSkinnedMesh&&(un.bind(gr,Ln.skin.bindMatrix),un.normalizeSkinWeights()),le.push(un)}}for(let yi=0,zn=Di.length;yi<zn;yi++){const Zi=ds(Di[yi]);Zi!==null&&le.push(Zi.clone())}for(let yi=0,zn=cn.length;yi<zn;yi++){const Zi=cn[yi],Ln=ps(Zi.id),Bi=Wr(Ln,Zi.materials);for(let Nn=0,Kt=Bi.length;Nn<Kt;Nn++)le.push(Bi[Nn])}for(let yi=0,zn=Sn.length;yi<zn;yi++)le.push(Cs(Sn[yi]).clone());let Hi;if(Ve.length===0&&le.length===1)Hi=le[0];else{Hi=ze==="JOINT"?new f.Bone:new f.Group;for(let yi=0;yi<le.length;yi++)Hi.add(le[yi])}return Hi.name=ze==="JOINT"?he.sid:he.name,Hi.matrix.copy(we),Hi.matrix.decompose(Hi.position,Hi.quaternion,Hi.scale),Hi}const br=new f.MeshBasicMaterial({color:16711935});function Mn(he,le){const we=[];for(let Ve=0,ze=he.length;Ve<ze;Ve++){const Bt=le[he[Ve]];Bt===void 0?(console.warn("THREE.ColladaLoader: Material with key %s not found. Apply fallback material.",he[Ve]),we.push(br)):we.push(Dn(Bt))}return we}function Wr(he,le){const we=[];for(const Ve in he){const ze=he[Ve],Bt=Mn(ze.materialKeys,le);Bt.length===0&&(Ve==="lines"||Ve==="linestrips"?Bt.push(new f.LineBasicMaterial):Bt.push(new f.MeshPhongMaterial));const kt=ze.data.attributes.skinIndex!==void 0,Di=Bt.length===1?Bt[0]:Bt;let cn;switch(Ve){case"lines":cn=new f.LineSegments(ze.data,Di);break;case"linestrips":cn=new f.Line(ze.data,Di);break;case"triangles":case"polylist":kt?cn=new f.SkinnedMesh(ze.data,Di):cn=new f.Mesh(ze.data,Di);break}we.push(cn)}return we}function ss(he){return ni.nodes[he]!==void 0}function Cs(he){return Ut(ni.nodes[he],Vr)}function uo(he){const le={name:he.getAttribute("name"),children:[]};Bn(he);const we=s(he,"node");for(let Ve=0;Ve<we.length;Ve++)le.children.push(jn(we[Ve]));ni.visualScenes[he.getAttribute("id")]=le}function bo(he){const le=new f.Group;le.name=he.name;const we=he.children;for(let Ve=0;Ve<we.length;Ve++){const ze=we[Ve];le.add(Cs(ze.id))}return le}function wl(he){return ni.visualScenes[he]!==void 0}function wo(he){return Ut(ni.visualScenes[he],bo)}function Ml(he){const le=s(he,"instance_visual_scene")[0];return wo(oe(le.getAttribute("url")))}function ur(){const he=ni.clips;if(Ee(he)===!0){if(Ee(ni.animations)===!1){const le=[];for(const we in ni.animations){const Ve=Ai(we);for(let ze=0,Bt=Ve.length;ze<Bt;ze++)le.push(Ve[ze])}ut.push(new f.AnimationClip("default",-1,le))}}else for(const le in he)ut.push(ft(le))}function ba(he){let le="";const we=[he];for(;we.length;){const Ve=we.shift();Ve.nodeType===Node.TEXT_NODE?le+=Ve.textContent:(le+=`
`,we.push.apply(we,Ve.childNodes))}return le.trim()}if(U.length===0)return{scene:new f.Scene};const ia=new DOMParser().parseFromString(U,"application/xml"),Ws=s(ia,"COLLADA")[0],Tl=ia.getElementsByTagName("parsererror")[0];if(Tl!==void 0){const he=s(Tl,"div")[0];let le;return he?le=he.textContent:le=ba(Tl),console.error(`THREE.ColladaLoader: Failed to parse collada file.
`,le),null}const Ba=Ws.getAttribute("version");console.log("THREE.ColladaLoader: File version",Ba);const be=We(s(Ws,"asset")[0]),ge=new f.TextureLoader(this.manager);ge.setPath(this.resourcePath||B).setCrossOrigin(this.crossOrigin);let De;f.TGALoader&&(De=new f.TGALoader(this.manager),De.setPath(this.resourcePath||B));const ut=[];let ui={},Ei=0;const ni={animations:{},clips:{},controllers:{},images:{},effects:{},materials:{},cameras:{},lights:{},geometries:{},nodes:{},visualScenes:{},kinematicsModels:{},physicsModels:{},kinematicsScenes:{}};Mt(Ws,"library_animations","animation",Wt),Mt(Ws,"library_animation_clips","animation_clip",Et),Mt(Ws,"library_controllers","controller",ii),Mt(Ws,"library_images","image",Xn),Mt(Ws,"library_effects","effect",ln),Mt(Ws,"library_materials","material",Gn),Mt(Ws,"library_cameras","camera",ar),Mt(Ws,"library_lights","light",jr),Mt(Ws,"library_geometries","geometry",ys),Mt(Ws,"library_nodes","node",jn),Mt(Ws,"library_visual_scenes","visual_scene",uo),Mt(Ws,"library_kinematics_models","kinematics_model",No),Mt(Ws,"library_physics_models","physics_model",Ke),Mt(Ws,"scene","instance_kinematics_scene",Ft),Lt(ni.animations,qt),Lt(ni.clips,_t),Lt(ni.controllers,Ki),Lt(ni.images,wr),Lt(ni.effects,tn),Lt(ni.materials,Jn),Lt(ni.cameras,ho),Lt(ni.lights,Po),Lt(ni.geometries,et),Lt(ni.visualScenes,bo),ur(),Mi();const ki=Ml(s(Ws,"scene")[0]);return ki.animations=ut,be.upAxis==="Z_UP"&&ki.quaternion.setFromEuler(new f.Euler(-Math.PI/2,0,0)),ki.scale.multiplyScalar(be.unit),{get animations(){return console.warn("THREE.ColladaLoader: Please access animations over scene.animations now."),ut},kinematics:ui,library:ni,scene:ki}}}f.ColladaLoader=C})(),te.exports=f.ColladaLoader})(E1);var wA=E1.exports;(function(te,p){const f=bl,C=Su,D=_A,U=yA,B=vA,s=bA,Z=wA,j=new D,Q=new U,oe=new s,ve=new B,Ee=new Z;function We(Re,He,Mt){if(Re===void 0)return console.error("Invalid options provided to loadObj()");Re=f._validate(Re,C.prototype._defaults.loadObj);let Lt;switch(Re.type||(Re.type="mtl"),Re.type){case"mtl":Lt=j;break;case"gltf":case"glb":Lt=oe;break;case"fbx":Lt=ve;break;case"dae":Lt=Ee;break}Q.load(Re.mtl,Ut,()=>null,lt=>{console.warn("No material file found "+lt.stack)});function Ut(lt){lt&&Re.type=="mtl"&&(lt.preload(),Lt.setMaterials(lt)),Lt.load(Re.obj,Ct=>{let qt=[];switch(Re.type){case"mtl":Ct=Ct.children[0];break;case"gltf":case"glb":case"dae":qt=Ct.animations,Ct=Ct.scene;break;case"fbx":qt=Ct.animations;break}Ct.animations=qt;const Ai=f.types.rotation(Re.rotation,[0,0,0]),Ni=f.types.scale(Re.scale,[1,1,1]);Ct.rotation.set(Ai[0],Ai[1],Ai[2]),Ct.scale.set(Ni[0],Ni[1],Ni[2]),Re.normalize&&Wt(Ct),Ct.name="model";let Qe=C.prototype._makeGroup(Ct,Re);C.prototype._addMethods(Qe),Qe.setAnchor(Re.anchor),Qe.setCenter(Re.adjustment),Qe.raycasted=Re.raycasted,Mt(Qe),He(Qe),Qe.setFixedZoom(Re.mapScale),Qe.idle()},()=>null,Ct=>{console.error("Could not load model file: "+Re.obj+` 
 `+Ct.stack),Mt("Error loading the model")})}function Wt(lt){lt.traverse(function(Ct){if(Ct.isMesh){let qt;Ct.material.type=="MeshStandardMaterial"?(Ct.material.metalness&&(Ct.material.metalness*=.1),Ct.material.glossiness&&(Ct.material.glossiness*=.25),qt=new THREE.Color(12,12,12)):Ct.material.type=="MeshPhongMaterial"&&(Ct.material.shininess=.1,qt=new THREE.Color(20,20,20)),Ct.material.specular&&Ct.material.specular.isColor&&(Ct.material.specular=qt)}})}}te.exports=We})(b1);var MA=b1.exports,A1={exports:{}};(function(te,p){const f=va,C=bl,D=Su;function U(B){B=C._validate(B,D.prototype._defaults.line);var s=C.lnglatsToWorld(B.geometry),Z=C.normalizeVertices(s),j=C.flattenVectors(Z.vertices),Q=new f.LineGeometry;Q.setPositions(j);let oe=new f.LineMaterial({color:B.color,linewidth:B.width,dashed:!1,opacity:B.opacity});return oe.resolution.set(window.innerWidth,window.innerHeight),oe.isMaterial=!0,oe.transparent=!0,oe.depthWrite=!1,U=new f.Line2(Q,oe),U.position.copy(Z.position),U.computeLineDistances(),U}te.exports=U,function(){const B=new f.Box3,s=new f.Vector3;class Z extends f.InstancedBufferGeometry{constructor(){super(),this.type="LineSegmentsGeometry";const Q=[-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],oe=[-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],ve=[0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5];this.setIndex(ve),this.setAttribute("position",new f.Float32BufferAttribute(Q,3)),this.setAttribute("uv",new f.Float32BufferAttribute(oe,2))}applyMatrix4(Q){const oe=this.attributes.instanceStart,ve=this.attributes.instanceEnd;return oe!==void 0&&(oe.applyMatrix4(Q),ve.applyMatrix4(Q),oe.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}setPositions(Q){let oe;Q instanceof Float32Array?oe=Q:Array.isArray(Q)&&(oe=new Float32Array(Q));const ve=new f.InstancedInterleavedBuffer(oe,6,1);return this.setAttribute("instanceStart",new f.InterleavedBufferAttribute(ve,3,0)),this.setAttribute("instanceEnd",new f.InterleavedBufferAttribute(ve,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(Q){let oe;Q instanceof Float32Array?oe=Q:Array.isArray(Q)&&(oe=new Float32Array(Q));const ve=new f.InstancedInterleavedBuffer(oe,6,1);return this.setAttribute("instanceColorStart",new f.InterleavedBufferAttribute(ve,3,0)),this.setAttribute("instanceColorEnd",new f.InterleavedBufferAttribute(ve,3,3)),this}fromWireframeGeometry(Q){return this.setPositions(Q.attributes.position.array),this}fromEdgesGeometry(Q){return this.setPositions(Q.attributes.position.array),this}fromMesh(Q){return this.fromWireframeGeometry(new f.WireframeGeometry(Q.geometry)),this}fromLineSegments(Q){const oe=Q.geometry;if(oe.isGeometry){console.error("THREE.LineSegmentsGeometry no longer supports Geometry. Use THREE.BufferGeometry instead.");return}else oe.isBufferGeometry&&this.setPositions(oe.attributes.position.array);return this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new f.Box3);const Q=this.attributes.instanceStart,oe=this.attributes.instanceEnd;Q!==void 0&&oe!==void 0&&(this.boundingBox.setFromBufferAttribute(Q),B.setFromBufferAttribute(oe),this.boundingBox.union(B))}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new f.Sphere),this.boundingBox===null&&this.computeBoundingBox();const Q=this.attributes.instanceStart,oe=this.attributes.instanceEnd;if(Q!==void 0&&oe!==void 0){const ve=this.boundingSphere.center;this.boundingBox.getCenter(ve);let Ee=0;for(let We=0,Re=Q.count;We<Re;We++)s.fromBufferAttribute(Q,We),Ee=Math.max(Ee,ve.distanceToSquared(s)),s.fromBufferAttribute(oe,We),Ee=Math.max(Ee,ve.distanceToSquared(s));this.boundingSphere.radius=Math.sqrt(Ee),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}applyMatrix(Q){return console.warn("THREE.LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(Q)}}Z.prototype.isLineSegmentsGeometry=!0,f.LineSegmentsGeometry=Z}(),function(){class B extends f.LineSegmentsGeometry{constructor(){super(),this.type="LineGeometry"}setPositions(Z){for(var j=Z.length-3,Q=new Float32Array(2*j),oe=0;oe<j;oe+=3)Q[2*oe]=Z[oe],Q[2*oe+1]=Z[oe+1],Q[2*oe+2]=Z[oe+2],Q[2*oe+3]=Z[oe+3],Q[2*oe+4]=Z[oe+4],Q[2*oe+5]=Z[oe+5];return super.setPositions(Q),this}setColors(Z){for(var j=Z.length-3,Q=new Float32Array(2*j),oe=0;oe<j;oe+=3)Q[2*oe]=Z[oe],Q[2*oe+1]=Z[oe+1],Q[2*oe+2]=Z[oe+2],Q[2*oe+3]=Z[oe+3],Q[2*oe+4]=Z[oe+4],Q[2*oe+5]=Z[oe+5];return super.setColors(Q),this}fromLine(Z){var j=Z.geometry;if(j.isGeometry){console.error("THREE.LineGeometry no longer supports Geometry. Use THREE.BufferGeometry instead.");return}else j.isBufferGeometry&&this.setPositions(j.attributes.position.array);return this}}B.prototype.isLineGeometry=!0,f.LineGeometry=B}(),function(){class B extends f.LineSegmentsGeometry{constructor(Z){super(),this.type="WireframeGeometry2",this.fromWireframeGeometry(new f.WireframeGeometry(Z))}}B.prototype.isWireframeGeometry2=!0,f.WireframeGeometry2=B}(),function(){f.UniformsLib.line={worldUnits:{value:1},linewidth:{value:1},resolution:{value:new f.Vector2(1,1)},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},f.ShaderLib.line={uniforms:f.UniformsUtils.merge([f.UniformsLib.common,f.UniformsLib.fog,f.UniformsLib.line]),vertexShader:`
		#include <common>
		#include <color_pars_vertex>
		#include <fog_pars_vertex>
		#include <logdepthbuf_pars_vertex>
		#include <clipping_planes_pars_vertex>

		uniform float linewidth;
		uniform vec2 resolution;

		attribute vec3 instanceStart;
		attribute vec3 instanceEnd;

		attribute vec3 instanceColorStart;
		attribute vec3 instanceColorEnd;

		varying vec2 vUv;
		varying vec4 worldPos;
		varying vec3 worldStart;
		varying vec3 worldEnd;

		#ifdef USE_DASH

			uniform float dashScale;
			attribute float instanceDistanceStart;
			attribute float instanceDistanceEnd;
			varying float vLineDistance;

		#endif

		void trimSegment( const in vec4 start, inout vec4 end ) {

			// trim end segment so it terminates between the camera plane and the near plane

			// conservative estimate of the near plane
			float a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column
			float b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column
			float nearEstimate = - 0.5 * b / a;

			float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );

			end.xyz = mix( start.xyz, end.xyz, alpha );

		}

		void main() {

			#ifdef USE_COLOR

				vColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;

			#endif

			#ifdef USE_DASH

				vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;

			#endif

			float aspect = resolution.x / resolution.y;

			vUv = uv;

			// camera space
			vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );
			vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );

			worldStart = start.xyz;
			worldEnd = end.xyz;

			// special case for perspective projection, and segments that terminate either in, or behind, the camera plane
			// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
			// but we need to perform ndc-space calculations in the shader, so we must address this issue directly
			// perhaps there is a more elegant solution -- WestLangley

			bool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column

			if ( perspective ) {

				if ( start.z < 0.0 && end.z >= 0.0 ) {

					trimSegment( start, end );

				} else if ( end.z < 0.0 && start.z >= 0.0 ) {

					trimSegment( end, start );

				}

			}

			// clip space
			vec4 clipStart = projectionMatrix * start;
			vec4 clipEnd = projectionMatrix * end;

			// ndc space
			vec3 ndcStart = clipStart.xyz / clipStart.w;
			vec3 ndcEnd = clipEnd.xyz / clipEnd.w;

			// direction
			vec2 dir = ndcEnd.xy - ndcStart.xy;

			// account for clip-space aspect ratio
			dir.x *= aspect;
			dir = normalize( dir );

			#ifdef WORLD_UNITS

				// get the offset direction as perpendicular to the view vector
				vec3 worldDir = normalize( end.xyz - start.xyz );
				vec3 offset;
				if ( position.y < 0.5 ) {

					offset = normalize( cross( start.xyz, worldDir ) );

				} else {

					offset = normalize( cross( end.xyz, worldDir ) );

				}

				// sign flip
				if ( position.x < 0.0 ) offset *= - 1.0;

				float forwardOffset = dot( worldDir, vec3( 0.0, 0.0, 1.0 ) );

				// don't extend the line if we're rendering dashes because we
				// won't be rendering the endcaps
				#ifndef USE_DASH

					// extend the line bounds to encompass  endcaps
					start.xyz += - worldDir * linewidth * 0.5;
					end.xyz += worldDir * linewidth * 0.5;

					// shift the position of the quad so it hugs the forward edge of the line
					offset.xy -= dir * forwardOffset;
					offset.z += 0.5;

				#endif

				// endcaps
				if ( position.y > 1.0 || position.y < 0.0 ) {

					offset.xy += dir * 2.0 * forwardOffset;

				}

				// adjust for linewidth
				offset *= linewidth * 0.5;

				// set the world position
				worldPos = ( position.y < 0.5 ) ? start : end;
				worldPos.xyz += offset;

				// project the worldpos
				vec4 clip = projectionMatrix * worldPos;

				// shift the depth of the projected points so the line
				// segements overlap neatly
				vec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;
				clip.z = clipPose.z * clip.w;

			#else

				vec2 offset = vec2( dir.y, - dir.x );
				// undo aspect ratio adjustment
				dir.x /= aspect;
				offset.x /= aspect;

				// sign flip
				if ( position.x < 0.0 ) offset *= - 1.0;

				// endcaps
				if ( position.y < 0.0 ) {

					offset += - dir;

				} else if ( position.y > 1.0 ) {

					offset += dir;

				}

				// adjust for linewidth
				offset *= linewidth;

				// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...
				offset /= resolution.y;

				// select end
				vec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;

				// back to clip space
				offset *= clip.w;

				clip.xy += offset;

			#endif

			gl_Position = clip;

			vec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation

			#include <logdepthbuf_vertex>
			#include <clipping_planes_vertex>
			#include <fog_vertex>

		}
		`,fragmentShader:`
		uniform vec3 diffuse;
		uniform float opacity;
		uniform float linewidth;

		#ifdef USE_DASH

			uniform float dashSize;
			uniform float gapSize;

		#endif

		varying float vLineDistance;
		varying vec4 worldPos;
		varying vec3 worldStart;
		varying vec3 worldEnd;

		#include <common>
		#include <color_pars_fragment>
		#include <fog_pars_fragment>
		#include <logdepthbuf_pars_fragment>
		#include <clipping_planes_pars_fragment>

		varying vec2 vUv;

		vec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {

			float mua;
			float mub;

			vec3 p13 = p1 - p3;
			vec3 p43 = p4 - p3;

			vec3 p21 = p2 - p1;

			float d1343 = dot( p13, p43 );
			float d4321 = dot( p43, p21 );
			float d1321 = dot( p13, p21 );
			float d4343 = dot( p43, p43 );
			float d2121 = dot( p21, p21 );

			float denom = d2121 * d4343 - d4321 * d4321;

			float numer = d1343 * d4321 - d1321 * d4343;

			mua = numer / denom;
			mua = clamp( mua, 0.0, 1.0 );
			mub = ( d1343 + d4321 * ( mua ) ) / d4343;
			mub = clamp( mub, 0.0, 1.0 );

			return vec2( mua, mub );

		}

		void main() {

			#include <clipping_planes_fragment>

			#ifdef USE_DASH

				if ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps

				if ( mod( vLineDistance, dashSize + gapSize ) > dashSize ) discard; // todo - FIX

			#endif

			float alpha = opacity;

			#ifdef WORLD_UNITS

				// Find the closest points on the view ray and the line segment
				vec3 rayEnd = normalize( worldPos.xyz ) * 1e5;
				vec3 lineDir = worldEnd - worldStart;
				vec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );

				vec3 p1 = worldStart + lineDir * params.x;
				vec3 p2 = rayEnd * params.y;
				vec3 delta = p1 - p2;
				float len = length( delta );
				float norm = len / linewidth;

				#ifndef USE_DASH

					#ifdef ALPHA_TO_COVERAGE

						float dnorm = fwidth( norm );
						alpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );

					#else

						if ( norm > 0.5 ) {

							discard;

						}

					#endif

				#endif

			#else

				#ifdef ALPHA_TO_COVERAGE

					// artifacts appear on some hardware if a derivative is taken within a conditional
					float a = vUv.x;
					float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
					float len2 = a * a + b * b;
					float dlen = fwidth( len2 );

					if ( abs( vUv.y ) > 1.0 ) {

						alpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );

					}

				#else

					if ( abs( vUv.y ) > 1.0 ) {

						float a = vUv.x;
						float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
						float len2 = a * a + b * b;

						if ( len2 > 1.0 ) discard;

					}

				#endif

			#endif

			vec4 diffuseColor = vec4( diffuse, alpha );

			#include <logdepthbuf_fragment>
			#include <color_fragment>

			gl_FragColor = vec4( diffuseColor.rgb, alpha );

			#include <tonemapping_fragment>
			#include <encodings_fragment>
			#include <fog_fragment>
			#include <premultiplied_alpha_fragment>

		}
		`};class B extends f.ShaderMaterial{constructor(Z){super({type:"LineMaterial",uniforms:f.UniformsUtils.clone(f.ShaderLib.line.uniforms),vertexShader:f.ShaderLib.line.vertexShader,fragmentShader:f.ShaderLib.line.fragmentShader,clipping:!0}),Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(j){this.uniforms.diffuse.value=j}},worldUnits:{enumerable:!0,get:function(){return"WORLD_UNITS"in this.defines},set:function(j){j===!0?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(j){this.uniforms.linewidth.value=j}},dashed:{enumerable:!0,get:function(){return"USE_DASH"in this.defines},set(j){!!j!="USE_DASH"in this.defines&&(this.needsUpdate=!0),j===!0?this.defines.USE_DASH="":delete this.defines.USE_DASH}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(j){this.uniforms.dashScale.value=j}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(j){this.uniforms.dashSize.value=j}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(j){this.uniforms.dashOffset.value=j}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(j){this.uniforms.gapSize.value=j}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(j){this.uniforms.opacity.value=j}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(j){this.uniforms.resolution.value.copy(j)}},alphaToCoverage:{enumerable:!0,get:function(){return"ALPHA_TO_COVERAGE"in this.defines},set:function(j){!!j!="ALPHA_TO_COVERAGE"in this.defines&&(this.needsUpdate=!0),j===!0?(this.defines.ALPHA_TO_COVERAGE="",this.extensions.derivatives=!0):(delete this.defines.ALPHA_TO_COVERAGE,this.extensions.derivatives=!1)}}}),this.setValues(Z)}}B.prototype.isLineMaterial=!0,f.LineMaterial=B}(),function(){const B=new f.Vector3,s=new f.Vector3,Z=new f.Vector4,j=new f.Vector4,Q=new f.Vector4,oe=new f.Vector3,ve=new f.Matrix4,Ee=new f.Line3,We=new f.Vector3,Re=new f.Box3,He=new f.Sphere,Mt=new f.Vector4;class Lt extends f.Mesh{constructor(Wt=new f.LineSegmentsGeometry,lt=new f.LineMaterial({color:Math.random()*16777215})){super(Wt,lt),this.type="LineSegments2"}computeLineDistances(){const Wt=this.geometry,lt=Wt.attributes.instanceStart,Ct=Wt.attributes.instanceEnd,qt=new Float32Array(2*lt.count);for(let Ni=0,Qe=0,st=lt.count;Ni<st;Ni++,Qe+=2)B.fromBufferAttribute(lt,Ni),s.fromBufferAttribute(Ct,Ni),qt[Qe]=Qe===0?0:qt[Qe-1],qt[Qe+1]=qt[Qe]+B.distanceTo(s);const Ai=new f.InstancedInterleavedBuffer(qt,2,1);return Wt.setAttribute("instanceDistanceStart",new f.InterleavedBufferAttribute(Ai,1,0)),Wt.setAttribute("instanceDistanceEnd",new f.InterleavedBufferAttribute(Ai,1,1)),this}raycast(Wt,lt){Wt.camera===null&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2.');const Ct=Wt.params.Line2!==void 0&&Wt.params.Line2.threshold||0,qt=Wt.ray,Ai=Wt.camera,Ni=Ai.projectionMatrix,Qe=this.matrixWorld,st=this.geometry,Ht=this.material,en=Ht.resolution,ci=Ht.linewidth+Ct,ae=st.attributes.instanceStart,ye=st.attributes.instanceEnd,Se=-Ai.near,Pe=2*Math.max(ci/en.width,ci/en.height);st.boundingSphere===null&&st.computeBoundingSphere(),He.copy(st.boundingSphere).applyMatrix4(Qe);const je=Math.max(Ai.near,He.distanceToPoint(qt.origin));Mt.set(0,0,-je,1).applyMatrix4(Ai.projectionMatrix),Mt.multiplyScalar(1/Mt.w),Mt.applyMatrix4(Ai.projectionMatrixInverse);const Et=Math.abs(Pe/Mt.w)*.5;if(He.radius+=Et,Wt.ray.intersectsSphere(He)===!1)return;st.boundingBox===null&&st.computeBoundingBox(),Re.copy(st.boundingBox).applyMatrix4(Qe);const _t=Math.max(Ai.near,Re.distanceToPoint(qt.origin));Mt.set(0,0,-_t,1).applyMatrix4(Ai.projectionMatrix),Mt.multiplyScalar(1/Mt.w),Mt.applyMatrix4(Ai.projectionMatrixInverse);const ft=Math.abs(Pe/Mt.w)*.5;if(Re.max.x+=ft,Re.max.y+=ft,Re.max.z+=ft,Re.min.x-=ft,Re.min.y-=ft,Re.min.z-=ft,Wt.ray.intersectsBox(Re)!==!1){qt.at(1,Q),Q.w=1,Q.applyMatrix4(Ai.matrixWorldInverse),Q.applyMatrix4(Ni),Q.multiplyScalar(1/Q.w),Q.x*=en.x/2,Q.y*=en.y/2,Q.z=0,oe.copy(Q),ve.multiplyMatrices(Ai.matrixWorldInverse,Qe);for(let St=0,Jt=ae.count;St<Jt;St++){Z.fromBufferAttribute(ae,St),j.fromBufferAttribute(ye,St),Z.w=1,j.w=1,Z.applyMatrix4(ve),j.applyMatrix4(ve);var ii=Z.z>Se&&j.z>Se;if(ii)continue;if(Z.z>Se){const Xn=Z.z-j.z,wr=(Z.z-Se)/Xn;Z.lerp(j,wr)}else if(j.z>Se){const Xn=j.z-Z.z,wr=(j.z-Se)/Xn;j.lerp(Z,wr)}Z.applyMatrix4(Ni),j.applyMatrix4(Ni),Z.multiplyScalar(1/Z.w),j.multiplyScalar(1/j.w),Z.x*=en.x/2,Z.y*=en.y/2,j.x*=en.x/2,j.y*=en.y/2,Ee.start.copy(Z),Ee.start.z=0,Ee.end.copy(j),Ee.end.z=0;const sn=Ee.closestPointToPointParameter(oe,!0);Ee.at(sn,We);const Ki=f.MathUtils.lerp(Z.z,j.z,sn),fi=Ki>=-1&&Ki<=1,pr=oe.distanceTo(We)<ci*.5;if(fi&&pr){Ee.start.fromBufferAttribute(ae,St),Ee.end.fromBufferAttribute(ye,St),Ee.start.applyMatrix4(Qe),Ee.end.applyMatrix4(Qe);const Xn=new f.Vector3,wr=new f.Vector3;qt.distanceSqToSegment(Ee.start,Ee.end,wr,Xn),lt.push({point:wr,pointOnLine:Xn,distance:qt.origin.distanceTo(wr),object:this,face:null,faceIndex:St,uv:null,uv2:null})}}}}}Lt.prototype.LineSegments2=!0,f.LineSegments2=Lt}(),function(){class B extends f.LineSegments2{constructor(Z=new f.LineGeometry,j=new f.LineMaterial({color:Math.random()*16777215})){super(Z,j),this.type="Line2"}}B.prototype.isLine2=!0,f.Line2=B}(),function(){const B=new f.Vector3,s=new f.Vector3;class Z extends f.Mesh{constructor(Q=new f.LineSegmentsGeometry,oe=new f.LineMaterial({color:Math.random()*16777215})){super(Q,oe),this.type="Wireframe"}computeLineDistances(){const Q=this.geometry,oe=Q.attributes.instanceStart,ve=Q.attributes.instanceEnd,Ee=new Float32Array(2*oe.count);for(let Re=0,He=0,Mt=oe.count;Re<Mt;Re++,He+=2)B.fromBufferAttribute(oe,Re),s.fromBufferAttribute(ve,Re),Ee[He]=He===0?0:Ee[He-1],Ee[He+1]=Ee[He]+B.distanceTo(s);const We=new f.InstancedInterleavedBuffer(Ee,2,1);return Q.setAttribute("instanceDistanceStart",new f.InterleavedBufferAttribute(We,1,0)),Q.setAttribute("instanceDistanceEnd",new f.InterleavedBufferAttribute(We,1,1)),this}}Z.prototype.isWireframe=!0,f.Wireframe=Z}()})(A1);var TA=A1.exports,C1={exports:{}};(function(te,p){const f=bl,C=G0,D=Su,U=va,B=X_;function s(Z,j){Z=f._validate(Z,D.prototype._defaults.tube);let Q=[];Z.geometry.forEach(Re=>{Q.push(new U.Vector3(Re[0],Re[1],Re[2]))});const oe=new U.CatmullRomCurve3(Q);let ve=new U.TubeGeometry(oe,Q.length,Z.radius,Z.sides,!1),Ee=C(Z),We=new U.Mesh(ve,Ee);return new B({obj:We,units:Z.units,anchor:Z.anchor,adjustment:Z.adjustment,bbox:Z.bbox,tooltip:Z.tooltip,raycasted:Z.raycasted})}te.exports=s})(C1);var SA=C1.exports,L1={exports:{}};(function(te,p){const f=Z_;function C(D){this.map=D,this.renderer=new f.CSS2DRenderer,this.renderer.setSize(this.map.getCanvas().clientWidth,this.map.getCanvas().clientHeight),this.renderer.domElement.style.position="absolute",this.renderer.domElement.id="labelCanvas",this.renderer.domElement.style.top=0,this.renderer.domElement.style.zIndex="0",this.map.getCanvasContainer().appendChild(this.renderer.domElement),this.scene,this.camera,this.dispose=function(){this.map.getCanvasContainer().removeChild(this.renderer.domElement),this.renderer.domElement.remove(),this.renderer={}},this.setSize=function(U,B){this.renderer.setSize(U,B)},this.map.on("resize",(function(){this.renderer.setSize(this.map.getCanvas().clientWidth,this.map.getCanvas().clientHeight)}).bind(this)),this.state={reset:function(){}},this.render=async function(U,B){return this.scene=U,this.camera=B,new Promise(s=>{s(this.renderer.render(U,B))})},this.toggleLabels=async function(U,B){return new Promise(s=>{s(this.setVisibility(U,B,this.scene,this.camera,this.renderer))})},this.setVisibility=function(U,B,s,Z,j){var Q=this.renderer.cacheList;Q.forEach(function(oe){oe.visible!=B&&oe.layer===U&&(B&&oe.alwaysVisible||!B)&&(oe.visible=B,j.renderObject(oe,s,Z))})}}te.exports=C})(L1);var EA=L1.exports,I1={exports:{}};(function(te,p){class f{constructor(D,U){this.id=D.layerId,this.type="custom",this.renderingMode="3d",this.opacity=.5,this.buildingsLayerId=D.buildingsLayerId,this.minAltitude=D.minAltitude||.1,this.tb=U}onAdd(D,U){this.map=D;const B=`
			uniform mat4 u_matrix;
			uniform float u_height_factor;
			uniform float u_altitude;
			uniform float u_azimuth;
			attribute vec2 a_pos;
			attribute vec4 a_normal_ed;
			attribute lowp vec2 a_base;
			attribute lowp vec2 a_height;
			void main() {
				float base = max(0.0, a_base.x);
				float height = max(0.0, a_height.x);
				float t = mod(a_normal_ed.x, 2.0);
				vec4 pos = vec4(a_pos, t > 0.0 ? height : base, 1);
				float len = pos.z * u_height_factor / tan(u_altitude);
				pos.x += cos(u_azimuth) * len;
				pos.y += sin(u_azimuth) * len;
				pos.z = 0.0;
				gl_Position = u_matrix * pos;
			}
			`,s=`
			void main() {
				gl_FragColor = vec4(0.0, 0.0, 0.0, 0.7);
			}
			`,Z=U.createShader(U.VERTEX_SHADER);U.shaderSource(Z,B),U.compileShader(Z);const j=U.createShader(U.FRAGMENT_SHADER);U.shaderSource(j,s),U.compileShader(j),this.program=U.createProgram(),U.attachShader(this.program,Z),U.attachShader(this.program,j),U.linkProgram(this.program),U.validateProgram(this.program),this.uMatrix=U.getUniformLocation(this.program,"u_matrix"),this.uHeightFactor=U.getUniformLocation(this.program,"u_height_factor"),this.uAltitude=U.getUniformLocation(this.program,"u_altitude"),this.uAzimuth=U.getUniformLocation(this.program,"u_azimuth"),this.aPos=U.getAttribLocation(this.program,"a_pos"),this.aNormal=U.getAttribLocation(this.program,"a_normal_ed"),this.aBase=U.getAttribLocation(this.program,"a_base"),this.aHeight=U.getAttribLocation(this.program,"a_height")}render(D,U){D.useProgram(this.program);const B=this.map.style.sourceCaches.composite,s=B.getVisibleCoordinates().reverse(),Z=this.map.getLayer(this.buildingsLayerId),j=this.map.painter.context,{lng:Q,lat:oe}=this.map.getCenter(),ve=this.tb.getSunPosition(this.tb.lightDateTime,[Q,oe]);D.uniform1f(this.uAltitude,ve.altitude>this.minAltitude?ve.altitude:0),D.uniform1f(this.uAzimuth,ve.azimuth+3*Math.PI/2),D.enable(D.BLEND),D.blendFunc(D.SRC_ALPHA,D.ONE_MINUS_SRC_ALPHA),D.getExtension("EXT_blend_minmax"),D.disable(D.DEPTH_TEST);for(const Ee of s){const We=B.getTile(Ee),Re=We.getBucket(Z);if(!Re)continue;const[He,Mt]=Re.programConfigurations.programConfigurations[this.buildingsLayerId]._buffers;D.uniformMatrix4fv(this.uMatrix,!1,Ee.posMatrix),D.uniform1f(this.uHeightFactor,Math.pow(2,Ee.overscaledZ)/We.tileSize/8);for(const Lt of Re.segments.get()){const Ut=j.currentNumAttributes||0,Wt=2;for(let Ct=Wt;Ct<Ut;Ct++)D.disableVertexAttribArray(Ct);const lt=Lt.vertexOffset||0;D.enableVertexAttribArray(this.aPos),D.enableVertexAttribArray(this.aNormal),D.enableVertexAttribArray(this.aHeight),D.enableVertexAttribArray(this.aBase),Re.layoutVertexBuffer.bind(),D.vertexAttribPointer(this.aPos,2,D.SHORT,!1,12,12*lt),D.vertexAttribPointer(this.aNormal,4,D.SHORT,!1,12,4+12*lt),He.bind(),D.vertexAttribPointer(this.aHeight,1,D.FLOAT,!1,4,4*lt),Mt.bind(),D.vertexAttribPointer(this.aBase,1,D.FLOAT,!1,4,4*lt),Re.indexBuffer.bind(),j.currentNumAttributes=Wt,D.drawElements(D.TRIANGLES,Lt.primitiveLength*3,D.UNSIGNED_SHORT,Lt.primitiveOffset*3*2)}}}}te.exports=f})(I1);var AA=I1.exports;(function(te,p){const f=va,C=hA,D=bl,U=uA,B=V0,s=Su,Z=G0,j=pA,Q=fA,oe=mA,ve=gA,Ee=MA,We=X_,Re=TA,He=SA,Mt=EA,Lt=AA;function Ut(lt,Ct,qt){this.init(lt,Ct,qt)}Ut.prototype={repaint:function(){this.map.repaint=!0},init:function(lt,Ct,qt){this.options=D._validate(qt||{},Wt),this.map=lt,this.map.tb=this,this.objects=new s,this.mapboxVersion=parseFloat(this.map.version),this.renderer=new f.WebGLRenderer({alpha:!0,antialias:!0,preserveDrawingBuffer:qt.preserveDrawingBuffer,canvas:lt.getCanvas(),context:Ct}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(this.map.getCanvas().clientWidth,this.map.getCanvas().clientHeight),this.renderer.outputEncoding=f.sRGBEncoding,this.renderer.autoClear=!1,this.labelRenderer=new Mt(this.map),this.scene=new f.Scene,this.world=new f.Group,this.world.name="world",this.scene.add(this.world),this.objectsCache=new Map,this.zoomLayers=[],this.fov=this.options.fov,this.orthographic=this.options.orthographic||!1,this.raycaster=new f.Raycaster,this.raycaster.layers.set(0),this.mapCenter=this.map.getCenter(),this.mapCenterUnits=D.projectToWorld([this.mapCenter.lng,this.mapCenter.lat]),this.lightDateTime=new Date,this.lightLng=this.mapCenter.lng,this.lightLat=this.mapCenter.lat,this.sunPosition,this.rotationStep=5,this.gridStep=6,this.altitudeStep=.1,this.defaultCursor="default",this.lights=this.initLights,this.options.defaultLights&&this.defaultLights(),this.options.realSunlight&&this.realSunlight(this.options.realSunlightHelper),this.skyLayerName="sky-layer",this.terrainSourceName="mapbox-dem",this.terrainExaggeration=1,this.terrainLayerName="",this.enableSelectingFeatures=this.options.enableSelectingFeatures||!1,this.enableSelectingObjects=this.options.enableSelectingObjects||!1,this.enableDraggingObjects=this.options.enableDraggingObjects||!1,this.enableRotatingObjects=this.options.enableRotatingObjects||!1,this.enableTooltips=this.options.enableTooltips||!1,this.multiLayer=this.options.multiLayer||!1,this.enableHelpTooltips=this.options.enableHelpTooltips||!1,this.map.on("style.load",function(){this.tb.zoomLayers=[],this.tb.options.multiLayer&&this.addLayer({id:"threebox_layer",type:"custom",renderingMode:"3d",map:this,onAdd:function(Ni,Qe){},render:function(Ni,Qe){this.map.tb.update()}}),this.once("idle",()=>{this.tb.setObjectsScale()}),this.tb.options.sky&&(this.tb.sky=!0),this.tb.options.terrain&&(this.tb.terrain=!0),["satellite","mapbox-mapbox-satellite","satelliteLayer"].forEach(Ni=>{this.getLayer(Ni)&&(this.tb.terrainLayerName=Ni)})}),this.map.on("load",function(){this.selectedObject,this.selectedFeature,this.draggedObject;let Ai;this.overedObject,this.overedFeature;let Ni=this.getCanvasContainer();this.getCanvasContainer().style.cursor=this.tb.defaultCursor;let Qe,st=[],Ht,en,ci,ae;function ye(St){var Jt=Ni.getBoundingClientRect();return{x:St.originalEvent.clientX-Jt.left-Ni.clientLeft,y:St.originalEvent.clientY-Jt.top-Ni.clientTop}}this.unselectObject=function(){this.selectedObject.selected=!1,this.selectedObject=null},this.outObject=function(){this.overedObject.over=!1,this.overedObject=null},this.unselectFeature=function(St){typeof St.id>"u"||(this.setFeatureState({source:St.source,sourceLayer:St.sourceLayer,id:St.id},{select:!1}),this.removeTooltip(St),St=this.queryRenderedFeatures({layers:[St.layer.id],filter:["==",["id"],St.id]})[0],St&&this.fire("SelectedFeatureChange",{detail:St}),this.selectedFeature=null)},this.selectFeature=function(St){this.selectedFeature=St,this.setFeatureState({source:this.selectedFeature.source,sourceLayer:this.selectedFeature.sourceLayer,id:this.selectedFeature.id},{select:!0}),this.selectedFeature=this.queryRenderedFeatures({layers:[this.selectedFeature.layer.id],filter:["==",["id"],this.selectedFeature.id]})[0],this.addTooltip(this.selectedFeature),this.fire("SelectedFeatureChange",{detail:this.selectedFeature})},this.outFeature=function(St){this.overedFeature&&typeof this.overedFeature<"u"&&this.overedFeature.id!=St&&(lt.setFeatureState({source:this.overedFeature.source,sourceLayer:this.overedFeature.sourceLayer,id:this.overedFeature.id},{hover:!1}),this.removeTooltip(this.overedFeature),this.overedFeature=null)},this.addTooltip=function(St){if(!this.tb.enableTooltips)return;let Jt=this.tb.getFeatureCenter(St),sn=this.tb.tooltip({text:St.properties.name||St.id||St.type,mapboxStyle:!0,feature:St});sn.setCoords(Jt),this.tb.add(sn,St.layer.id),St.tooltip=sn,St.tooltip.tooltip.visible=!0},this.removeTooltip=function(St){St.tooltip&&(St.tooltip.visibility=!1,this.tb.remove(St.tooltip),St.tooltip=null)},lt.onContextMenu=function(St){alert("contextMenu")},this.onClick=function(St){let Jt,sn=[];if(lt.tb.enableSelectingObjects&&(sn=this.tb.queryRenderedFeatures(St.point)),Jt=typeof sn[0]=="object",Jt){let Ki=Ut.prototype.findParent3DObject(sn[0]);if(Ki){if(this.selectedFeature&&this.unselectFeature(this.selectedFeature),!this.selectedObject)this.selectedObject=Ki,this.selectedObject.selected=!0;else if(this.selectedObject.uuid!=Ki.uuid)this.selectedObject.selected=!1,Ki.selected=!0,this.selectedObject=Ki;else if(this.selectedObject.uuid==Ki.uuid){this.unselectObject();return}this.selectedObject.dispatchEvent({type:"Wireframed",detail:this.selectedObject}),this.selectedObject.dispatchEvent({type:"IsPlayingChanged",detail:this.selectedObject}),this.repaint=!0,St.preventDefault()}}else{let Ki=[];if(lt.tb.enableSelectingFeatures&&(Ki=this.queryRenderedFeatures(St.point)),Ki.length>0&&Ki[0].layer.type=="fill-extrusion"&&typeof Ki[0].id<"u"){if(this.selectedObject&&this.unselectObject(),!this.selectedFeature)this.selectFeature(Ki[0]);else if(this.selectedFeature.id!=Ki[0].id)this.unselectFeature(this.selectedFeature),this.selectFeature(Ki[0]);else if(this.selectedFeature.id==Ki[0].id){this.unselectFeature(this.selectedFeature);return}}}},this.onMouseMove=function(St){let Jt=ye(St);if(this.getCanvasContainer().style.cursor=this.tb.defaultCursor,St.originalEvent.altKey&&this.draggedObject){if(!lt.tb.enableRotatingObjects)return;Ai="rotate",this.getCanvasContainer().style.cursor="move",Math.min(Qe.x,Jt.x),Math.max(Qe.x,Jt.x),Math.min(Qe.y,Jt.y),Math.max(Qe.y,Jt.y);let fi={x:0,y:0,z:Math.round(ae[2]+~~((Jt.x-Qe.x)/this.tb.rotationStep)%360*this.tb.rotationStep%360)};this.draggedObject.setRotation(fi),lt.tb.enableHelpTooltips&&this.draggedObject.addHelp("rot: "+fi.z+"&#176;");return}if(St.originalEvent.shiftKey&&this.draggedObject){if(!lt.tb.enableDraggingObjects)return;Ai="translate",this.getCanvasContainer().style.cursor="move";let fi=St.lngLat,pr=[Number((fi.lng+Ht).toFixed(this.tb.gridStep)),Number((fi.lat+en).toFixed(this.tb.gridStep)),this.draggedObject.modelHeight];this.draggedObject.setCoords(pr),lt.tb.enableHelpTooltips&&this.draggedObject.addHelp("lng: "+pr[0]+"&#176;, lat: "+pr[1]+"&#176;");return}if(St.originalEvent.ctrlKey&&this.draggedObject){if(!lt.tb.enableDraggingObjects)return;Ai="altitude",this.getCanvasContainer().style.cursor="move";let fi=St.point.y*this.tb.altitudeStep,pr=[this.draggedObject.coordinates[0],this.draggedObject.coordinates[1],Number((-fi-ci).toFixed(this.tb.gridStep))];this.draggedObject.setCoords(pr),lt.tb.enableHelpTooltips&&this.draggedObject.addHelp("alt: "+pr[2]+"m");return}let sn,Ki=[];if(lt.tb.enableSelectingObjects&&(Ki=this.tb.queryRenderedFeatures(St.point)),sn=typeof Ki[0]=="object",sn){let fi=Ut.prototype.findParent3DObject(Ki[0]);fi&&(this.outFeature(this.overedFeature),this.getCanvasContainer().style.cursor="pointer",!this.selectedObject||fi.uuid!=this.selectedObject.uuid?(this.overedObject&&this.overedObject.uuid!=fi.uuid&&this.outObject(),fi.over=!0,this.overedObject=fi):this.selectedObject&&fi.uuid==this.selectedObject.uuid&&(fi.over=!0,this.overedObject=fi),this.repaint=!0,St.preventDefault())}else{this.overedObject&&this.outObject();let fi=[];lt.tb.enableSelectingFeatures&&(fi=this.queryRenderedFeatures(St.point)),fi.length>0&&(this.outFeature(fi[0]),fi[0].layer.type=="fill-extrusion"&&typeof fi[0].id<"u"&&(!this.selectedFeature||this.selectedFeature.id!=fi[0].id)&&(this.getCanvasContainer().style.cursor="pointer",this.overedFeature=fi[0],this.setFeatureState({source:this.overedFeature.source,sourceLayer:this.overedFeature.sourceLayer,id:this.overedFeature.id},{hover:!0}),this.overedFeature=lt.queryRenderedFeatures({layers:[this.overedFeature.layer.id],filter:["==",["id"],this.overedFeature.id]})[0],this.addTooltip(this.overedFeature)))}},this.onMouseDown=function(St){(St.originalEvent.shiftKey||St.originalEvent.altKey||St.originalEvent.ctrlKey)&&St.originalEvent.button===0&&this.selectedObject&&(!lt.tb.enableDraggingObjects&&!lt.tb.enableRotatingObjects||(St.preventDefault(),lt.getCanvasContainer().style.cursor="move",lt.once("mouseup",this.onMouseUp),this.draggedObject=this.selectedObject,Qe=ye(St),st=this.draggedObject.coordinates,ae=D.degreeify(this.draggedObject.rotation),Ht=st[0]-St.lngLat.lng,en=st[1]-St.lngLat.lat,ci=-this.draggedObject.modelHeight-St.point.y*this.tb.altitudeStep))},this.onMouseUp=function(St){this.getCanvasContainer().style.cursor=this.tb.defaultCursor,this.off("mouseup",this.onMouseUp),this.off("mouseout",this.onMouseUp),this.dragPan.enable(),this.draggedObject&&(this.draggedObject.dispatchEvent({type:"ObjectDragged",detail:{draggedObject:this.draggedObject,draggedAction:Ai}}),this.draggedObject.removeHelp(),this.draggedObject=null,Ai=null)},this.onMouseOut=function(St){if(this.overedFeature){let Jt=this.queryRenderedFeatures(St.point);Jt.length>0&&this.overedFeature.id!=Jt[0].id&&(this.getCanvasContainer().style.cursor=this.tb.defaultCursor,this.outFeature(Jt[0]))}},this.onZoom=function(St){this.tb.zoomLayers.forEach(Jt=>{this.tb.toggleLayer(Jt)}),this.tb.setObjectsScale()};let Se=!1,Pe=17,je=91,Et=16,_t=83;function ft(St){St.which===Pe||St.which,St.which===Et&&(Se=!0);let Jt=this.selectedObject;if(Se&&St.which===_t&&Jt){let sn=D.toDecimal;if(Jt.help)Jt.removeHelp();else{let Ki=Jt.modelSize,fi=1;Jt.userData.units!=="meters"&&(fi=D.projectedUnitsPerMeter(Jt.coordinates[1]),fi||(fi=1),fi=sn(fi,7)),lt.tb.enableHelpTooltips&&Jt.addHelp("size(m): "+sn(Ki.x/fi,3)+" W, "+sn(Ki.y/fi,3)+" L, "+sn(Ki.z/fi,3)+" H"),this.repaint=!0}return!1}}function ii(St){St.which==Pe||St.which==je,St.which===Et&&(Se=!1)}this.on("click",this.onClick),this.on("mousemove",this.onMouseMove),this.on("mouseout",this.onMouseOut),this.on("mousedown",this.onMouseDown),this.on("zoom",this.onZoom),this.on("zoomend",this.onZoom),document.addEventListener("keydown",ft.bind(this),!0),document.addEventListener("keyup",ii.bind(this))})},get sky(){return this.options.sky},set sky(lt){lt?this.createSkyLayer():this.removeLayer(this.skyLayerName),this.options.sky=lt},get terrain(){return this.options.terrain},set terrain(lt){if(this.terrainLayerName="",lt)this.createTerrainLayer();else{if(this.mapboxVersion<2){console.warn("Terrain layer are only supported by Mapbox-gl-js > v2.0");return}this.map.getTerrain()&&(this.map.setTerrain(null),this.map.removeSource(this.terrainSourceName))}this.options.terrain=lt},get fov(){return this.options.fov},set fov(lt){this.camera instanceof f.PerspectiveCamera&&this.options.fov!==lt&&(this.map.transform.fov=lt,this.camera.fov=this.map.transform.fov,this.cameraSync.setupCamera(),this.map.repaint=!0,this.options.fov=lt)},get orthographic(){return this.options.orthographic},set orthographic(lt){const Ct=this.map.getCanvas().clientHeight,qt=this.map.getCanvas().clientWidth;lt?(this.map.transform.fov=0,this.camera=new f.OrthographicCamera(qt/-2,qt/2,Ct/2,Ct/-2,.1,1e21)):(this.map.transform.fov=this.fov,this.camera=new f.PerspectiveCamera(this.map.transform.fov,qt/Ct,.1,1e21)),this.camera.layers.enable(0),this.camera.layers.enable(1),this.cameraSync=new C(this.map,this.camera,this.world),this.map.repaint=!0,this.options.orthographic=lt},createSkyLayer:function(){if(this.mapboxVersion<2){console.warn("Sky layer are only supported by Mapbox-gl-js > v2.0"),this.options.sky=!1;return}this.map.getLayer(this.skyLayerName)||(this.map.addLayer({id:this.skyLayerName,type:"sky",paint:{"sky-opacity":["interpolate",["linear"],["zoom"],0,0,5,.3,8,1],"sky-type":"atmosphere","sky-atmosphere-sun":this.getSunSky(this.lightDateTime),"sky-atmosphere-sun-intensity":10}}),this.map.once("idle",()=>{this.setSunlight(),this.repaint()}))},createTerrainLayer:function(){if(this.mapboxVersion<2){console.warn("Terrain layer are only supported by Mapbox-gl-js > v2.0"),this.options.terrain=!1;return}this.map.getTerrain()||(this.map.addSource(this.terrainSourceName,{type:"raster-dem",url:"mapbox://mapbox.mapbox-terrain-dem-v1",tileSize:512,maxzoom:14}),this.map.setTerrain({source:this.terrainSourceName,exaggeration:this.terrainExaggeration}),this.map.once("idle",()=>{this.cameraSync.updateCamera(),this.repaint()}))},sphere:function(lt){return this.setDefaultView(lt,this.options),j(lt,this.world)},line:Re,label:oe,tooltip:ve,tube:function(lt){return this.setDefaultView(lt,this.options),He(lt,this.world)},extrusion:function(lt){return this.setDefaultView(lt,this.options),Q(lt)},Object3D:function(lt){return this.setDefaultView(lt,this.options),We(lt)},loadObj:async function(Ct,qt){if(this.setDefaultView(Ct,this.options),Ct.clone===!1)return new Promise(async Ai=>{Ee(Ct,qt,async Ni=>{Ai(Ni)})});{let Ai=this.objectsCache.get(Ct.obj);Ai?Ai.promise.then(Ni=>{qt(Ni.duplicate(Ct))}).catch(Ni=>{this.objectsCache.delete(Ct.obj),console.error("Could not load model file: "+Ct.obj)}):this.objectsCache.set(Ct.obj,{promise:new Promise(async(Ni,Qe)=>{Ee(Ct,qt,async st=>{st.duplicate?Ni(st.duplicate()):Qe(st)})})})}},material:function(lt){return Z(lt)},initLights:{ambientLight:null,dirLight:null,dirLightBack:null,dirLightHelper:null,hemiLight:null,pointLight:null},utils:D,SunCalc:U,Constants:B,projectToWorld:function(lt){return this.utils.projectToWorld(lt)},unprojectFromWorld:function(lt){return this.utils.unprojectFromWorld(lt)},projectedUnitsPerMeter:function(lt){return this.utils.projectedUnitsPerMeter(lt)},getFeatureCenter:function(Ct,qt,Ai){return D.getFeatureCenter(Ct,qt,Ai)},getObjectHeightOnFloor:function(lt,Ct,qt){return D.getObjectHeightOnFloor(lt,Ct,qt)},queryRenderedFeatures:function(lt){let Ct=new f.Vector2;return Ct.x=lt.x/this.map.transform.width*2-1,Ct.y=1-lt.y/this.map.transform.height*2,this.raycaster.setFromCamera(Ct,this.camera),this.raycaster.intersectObjects(this.world.children,!0)},findParent3DObject:function(lt){var Ct;return lt.object.traverseAncestors(function(qt){qt.parent&&qt.parent.type=="Group"&&qt.userData.obj&&(Ct=qt)}),Ct},setLayoutProperty:function(lt,Ct,qt){this.map.setLayoutProperty(lt,Ct,qt),qt!=null&&Ct==="visibility"&&this.world.children.filter(Ai=>Ai.layer===lt).forEach(Ai=>{Ai.visibility=qt})},setLayerZoomRange:function(lt,Ct,qt){this.map.getLayer(lt)&&(this.map.setLayerZoomRange(lt,Ct,qt),this.zoomLayers.includes(lt)||this.zoomLayers.push(lt),this.toggleLayer(lt))},setLayerHeigthProperty:function(lt,Ct){let qt=this.map.getLayer(lt);if(qt)if(qt.type=="fill-extrusion"){let Ai=this.map.getStyle().sources[qt.source].data;Ai.features.forEach(function(Qe){Qe.properties.level=Ct}),this.map.getSource(qt.source).setData(Ai)}else qt.type=="custom"&&this.world.children.forEach(function(Ai){let Ni=Ai.userData.feature;if(Ni&&Ni.layer===lt){let Qe=this.tb.getFeatureCenter(Ni,Ai,Ct);Ai.setCoords(Qe)}})},setObjectsScale:function(){this.world.children.filter(lt=>lt.fixedZoom!=null).forEach(lt=>{lt.setObjectScale(this.map.transform.scale)})},setStyle:function(lt,Ct){this.clear().then(()=>{this.map.setStyle(lt,Ct)})},toggleLayer:function(lt,Ct=!0){let qt=this.map.getLayer(lt);if(qt){if(!Ct){this.toggle(qt.id,!1);return}let Ai=this.map.getZoom();if(qt.minzoom&&Ai<qt.minzoom){this.toggle(qt.id,!1);return}if(qt.maxzoom&&Ai>=qt.maxzoom){this.toggle(qt.id,!1);return}this.toggle(qt.id,!0)}},toggle:function(lt,Ct){this.setLayoutProperty(lt,"visibility",Ct?"visible":"none"),this.labelRenderer.toggleLabels(lt,Ct)},update:function(){this.map.repaint&&(this.map.repaint=!1);var lt=Date.now();this.objects.animationManager.update(lt),this.updateLightHelper(),this.renderer.resetState(),this.renderer.render(this.scene,this.camera),this.labelRenderer.render(this.scene,this.camera),this.options.passiveRendering===!1&&this.map.triggerRepaint()},add:function(lt,Ct,qt){if(!this.enableTooltips&&lt.tooltip&&(lt.tooltip.visibility=!1),this.world.add(lt),Ct){lt.layer=Ct,lt.source=qt;let Ai=this.map.getLayer(Ct);if(Ai){let Ni=Ai.visibility,Qe=typeof Ni>"u";lt.visibility=!!(Qe||Ni==="visible")}}},removeByName:function(lt){let Ct=this.world.getObjectByName(lt);Ct&&this.remove(Ct)},remove:function(lt){this.map.selectedObject&&lt.uuid==this.map.selectedObject.uuid&&this.map.unselectObject(),this.map.draggedObject&&lt.uuid==this.map.draggedObject.uuid&&(this.map.draggedObject=null),lt.dispose&&lt.dispose(),this.world.remove(lt),lt=null},clear:async function(lt=null,Ct=!1){return new Promise((qt,Ai)=>{let Ni=[];this.world.children.forEach(function(Qe){Ni.push(Qe)});for(let Qe=0;Qe<Ni.length;Qe++){let st=Ni[Qe];(st.layer===lt||!lt)&&this.remove(st)}Ct&&this.objectsCache.forEach(Qe=>{Qe.promise.then(st=>{st.dispose(),st=null})}),qt("clear")})},removeLayer:function(lt){this.clear(lt,!0).then(()=>{this.map.removeLayer(lt)})},getSunPosition:function(lt,Ct){return U.getPosition(lt||Date.now(),Ct[1],Ct[0])},getSunTimes:function(lt,Ct){return U.getTimes(lt,Ct[1],Ct[0],Ct[2]?Ct[2]:0)},setBuildingShadows:function(lt){if(this.map.getLayer(lt.buildingsLayerId)){let Ct=new Lt(lt,this);this.map.addLayer(Ct,lt.buildingsLayerId)}else console.warn("The layer '"+lt.buildingsLayerId+"' does not exist in the map.")},setSunlight:function(lt=new Date,Ct){if(!this.lights.dirLight||!this.options.realSunlight){console.warn("To use setSunlight it's required to set realSunlight : true in Threebox initial options.");return}var qt=new Date(lt.getTime());if(Ct?Ct.lng&&Ct.lat?this.mapCenter=Ct:this.mapCenter={lng:Ct[0],lat:Ct[1]}:this.mapCenter=this.map.getCenter(),this.lightDateTime&&this.lightDateTime.getTime()===qt.getTime()&&this.lightLng===this.mapCenter.lng&&this.lightLat===this.mapCenter.lat)return;this.lightDateTime=qt,this.lightLng=this.mapCenter.lng,this.lightLat=this.mapCenter.lat,this.sunPosition=this.getSunPosition(qt,[this.mapCenter.lng,this.mapCenter.lat]);let Ai=this.sunPosition.altitude,Ni=Math.PI+this.sunPosition.azimuth,Qe=B.WORLD_SIZE/2,st=Math.sin(Ai),Ht=Math.cos(Ai),en=Math.cos(Ni)*Ht,ci=Math.sin(Ni)*Ht;this.lights.dirLight.position.set(ci,en,st),this.lights.dirLight.position.multiplyScalar(Qe),this.lights.dirLight.intensity=Math.max(st,0),this.lights.hemiLight.intensity=Math.max(st*1,.1),this.lights.dirLight.updateMatrixWorld(),this.updateLightHelper(),this.map.loaded()&&(this.updateSunGround(this.sunPosition),this.map.setLight({anchor:"map",position:[3,180+this.sunPosition.azimuth*180/Math.PI,90-this.sunPosition.altitude*180/Math.PI],intensity:Math.cos(this.sunPosition.altitude),color:`hsl(40, ${50*Math.cos(this.sunPosition.altitude)}%, ${Math.max(20,20+96*Math.sin(this.sunPosition.altitude))}%)`},{duration:0}),this.sky&&this.updateSunSky(this.getSunSky(qt,this.sunPosition)))},getSunSky:function(lt,Ct){if(!Ct){var qt=this.map.getCenter();Ct=this.getSunPosition(lt||Date.now(),[qt.lng,qt.lat])}var Ai=180+Ct.azimuth*180/Math.PI,Ni=90-Ct.altitude*180/Math.PI;return[Ai,Ni]},updateSunSky:function(lt){this.sky&&this.map.setPaintProperty(this.skyLayerName,"sky-atmosphere-sun",lt)},updateSunGround:function(lt){this.terrainLayerName!=""&&this.map.setPaintProperty(this.terrainLayerName,"raster-opacity",Math.max(Math.min(1,lt.altitude*4),.25))},updateLightHelper:function(){this.lights.dirLightHelper&&(this.lights.dirLightHelper.position.setFromMatrixPosition(this.lights.dirLight.matrixWorld),this.lights.dirLightHelper.updateMatrix(),this.lights.dirLightHelper.update())},dispose:async function(){return console.log(this.memory()),new Promise(lt=>{lt(this.clear(null,!0).then(Ct=>(this.map.remove(),this.map={},this.scene.remove(this.world),this.world.children=[],this.world=null,this.objectsCache.clear(),this.labelRenderer.dispose(),console.log(this.memory()),this.renderer.dispose(),Ct)))})},defaultLights:function(){this.lights.ambientLight=new f.AmbientLight(new f.Color("hsl(0, 0%, 100%)"),.75),this.scene.add(this.lights.ambientLight),this.lights.dirLightBack=new f.DirectionalLight(new f.Color("hsl(0, 0%, 100%)"),.25),this.lights.dirLightBack.position.set(30,100,100),this.scene.add(this.lights.dirLightBack),this.lights.dirLight=new f.DirectionalLight(new f.Color("hsl(0, 0%, 100%)"),.25),this.lights.dirLight.position.set(-30,100,-100),this.scene.add(this.lights.dirLight)},realSunlight:function(lt=!1){this.renderer.shadowMap.enabled=!0,this.lights.dirLight=new f.DirectionalLight(16777215,1),this.scene.add(this.lights.dirLight),lt&&(this.lights.dirLightHelper=new f.DirectionalLightHelper(this.lights.dirLight,5),this.scene.add(this.lights.dirLightHelper));let Ct=1e3,qt=2,Ai=8192;this.lights.dirLight.castShadow=!0,this.lights.dirLight.shadow.radius=qt,this.lights.dirLight.shadow.mapSize.width=Ai,this.lights.dirLight.shadow.mapSize.height=Ai,this.lights.dirLight.shadow.camera.top=this.lights.dirLight.shadow.camera.right=Ct,this.lights.dirLight.shadow.camera.bottom=this.lights.dirLight.shadow.camera.left=-Ct,this.lights.dirLight.shadow.camera.near=1,this.lights.dirLight.shadow.camera.visible=!0,this.lights.dirLight.shadow.camera.far=4e8,this.lights.hemiLight=new f.HemisphereLight(new f.Color(16777215),new f.Color(16777215),.6),this.lights.hemiLight.color.setHSL(.661,.96,.12),this.lights.hemiLight.groundColor.setHSL(.11,.96,.14),this.lights.hemiLight.position.set(0,0,50),this.scene.add(this.lights.hemiLight),this.setSunlight(),this.map.once("idle",()=>{this.setSunlight(),this.repaint()})},setDefaultView:function(lt,Ct){lt.bbox=(lt.bbox||lt.bbox==null)&&Ct.enableSelectingObjects,lt.tooltip=(lt.tooltip||lt.tooltip==null)&&Ct.enableTooltips,lt.mapScale=this.map.transform.scale},memory:function(){return this.renderer.info.memory},programs:function(){return this.renderer.info.programs.length},version:"2.2.7"};var Wt={defaultLights:!1,realSunlight:!1,realSunlightHelper:!1,passiveRendering:!0,preserveDrawingBuffer:!1,enableSelectingFeatures:!1,enableSelectingObjects:!1,enableDraggingObjects:!1,enableRotatingObjects:!1,enableTooltips:!1,enableHelpTooltips:!1,multiLayer:!1,orthographic:!1,fov:B.FOV_DEGREES,sky:!1,terrain:!1};te.exports=Ut})(c1);var CA=c1.exports;(function(te,p){te.exports={Threebox:CA,THREE:va}})(l1);var LA=l1.exports;const IA=h_(LA),PA=7317959,j0=9,RA=2778247;function DA(te,p){const f=te.x||0,C=te.y||0,D=te.z||0,U=hg.projectToWorld([f,C,D]),B=hg.toDecimal(U.x-p.x,j0),s=hg.toDecimal(U.y-p.y,j0),Z=hg.toDecimal(U.z-p.z,j0);return new Pi(B,s,Z)}function zA(te){const p=new Kv;for(let f=0;f<te.length;f+=2){const C=te[f],D=te[f+1];f===0?p.moveTo(C,D):p.lineTo(C,D)}return p}function OA(te,p){const f=[],C=hg.projectToWorld([te[0][0][0],te[0][0][1],te[0][0][2]||0]),D=new Pi(C.x,C.y,C.z);te[0].forEach(ve=>{const Ee=new Pi(ve[0],ve[1],ve[2]),We=DA(Ee,D);f.push(We.x,We.y,We.z)});const U={depth:10,bevelEnabled:!1},B=zA(f),s=new N0(B,U),Z=new lA({color:p,refractionRatio:.8,side:$2}),j=new SE(s,Z),Q=new GE(s),oe=new CE(Q,new Vv({color:RA}));return{mesh:j,line:oe}}const FA={defaultLights:!0,enableSelectingFeatures:!1,enableSelectingObjects:!1,enableDraggingObjects:!0,enableRotatingObjects:!0,enableTooltips:!1};function kA(te){let p=PA;te.forEach(f=>{const C=f_(f,"geometry.coordinates",[]),D=f_(f,"properties.center",[0,0]),{mesh:U,line:B}=OA(C,p),s=window.tb.Object3D({obj:U});console.log(D,U),console.log(D),s.setTranslate(D),s.userData.obj.position.x=0-s.center.x,s.userData.obj.position.y=0-s.center.y;const Z=window.tb.Object3D({obj:B});Z.setTranslate(D),Z.userData.obj.position.x=0-Z.center.x,Z.userData.obj.position.y=0-Z.center.y,window.tb.add(Z),window.tb.add(s)})}function BA(te){return{id:"3d-model",type:"custom",renderingMode:"3d",onAdd:function(p,f){window.tb=new IA.Threebox(p,f,FA),window.tb.features_selected=[],kA(te.features)},render:function(){window.tb.update()}}}const NA="#fff",ug={compositeSource:"composite",compositeSourceLayer:"building",compositeLayer:"3d-buildings"},UA={id:ug.compositeLayer,source:ug.compositeSource,"source-layer":ug.compositeSourceLayer,type:"fill-extrusion",paint:{"fill-extrusion-color":["case",["boolean",["feature-state","hover"],!1],"transparent",NA],"fill-extrusion-height":["get","height"],"fill-extrusion-base":["get","min-height"],"fill-extrusion-opacity":.9}};class VA extends Z2{constructor(p,f,C,D,U,B,s,Z){const j=U||f_(C,"features[0].center[0]",-73.96368733310645),Q=B||f_(C,"features[0].center[1]",40.77900196036666);super(p,f,j,Q),this.elementId=p,this.token=f,this.geoJson=C,this.featureSelected=s,this.onLoad=Z,this.onClickShape=D,this.lng=j,this.lat=Q}init(){super.setMapWrapperStyle(this.elementId),super.removeMap(this.elementId),this.isValidToken?(super.init(),this.addEventListeners()):super.showUnauthorizedMessage(this.elementId)}mapRotate(p){const f=U=>U*(2-U),D=p==="left"?window.mapboxMap.getBearing()-45:window.mapboxMap.getBearing()+45;window.mapboxMap.easeTo({bearing:D,easing:f})}showBuildingsLayer(){window.mapboxMap.setLayoutProperty(ug.compositeLayer,"visibility","visible")}hiddenBuildingsLayer(){window.mapboxMap.setLayoutProperty(ug.compositeLayer,"visibility","none")}addEventListeners(){window.mapboxMap.on("style.load",()=>{window.mapboxMap.addLayer(UA),window.mapboxMap.addLayer(BA(this.geoJson))})}}window.Viewer=Xm,window.ThreeDimensionMap=VA});
